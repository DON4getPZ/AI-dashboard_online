name: Daily Marketing Data Sync v2.0

on:
  schedule:
    - cron: '30 1 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'

jobs:
  sync-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --no-cache-dir \
            gspread==5.12.0 \
            oauth2client==4.1.3 \
            pandas==2.1.4 \
            numpy==1.26.2 \
            scipy==1.11.4 \
            statsmodels==0.14.1
          pip install prophet || echo "âš ï¸  Prophet ì„¤ì¹˜ ì‹¤íŒ¨"
      
      - name: ğŸ“Š Fetch data from Google Sheets
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          WORKSHEET_NAME: ${{ secrets.WORKSHEET_NAME }}
        run: |
          if [ -z "$WORKSHEET_NAME" ]; then
            export WORKSHEET_NAME="ë°ì´í„°_í†µí•©ë¶„ë¥˜"
          fi
          python scripts/fetch_google_sheets.py
      
      - name: ğŸ”§ Process and analyze data
        run: |
          INPUT_CSV_PATH="raw_data.csv" python scripts/process_marketing_data.py
      
      - name: ğŸ“ˆ Generate statistics
        run: |
          echo "## ğŸ“Š ë°ì´í„° ì—…ë°ì´íŠ¸ ìš”ì•½" > summary.md
          echo "" >> summary.md
          echo "**ì—…ë°ì´íŠ¸ ì¼ì‹œ**: $(TZ='Asia/Seoul' date +'%Y-%m-%d %H:%M:%S KST')" >> summary.md
          echo "" >> summary.md
          
          if [ -f "data/meta/latest.json" ]; then
            echo "### ì „ì²´ ì„±ê³¼" >> summary.md
            cat data/meta/latest.json | jq -r '
              "**ê¸°ê°„**: \(.date_range.start) ~ \(.date_range.end)\n" +
              "**ì´ ê´‘ê³ ë¹„**: â‚©\(.total_metrics.cost | tonumber | floor | tostring)\n" +
              "**ì´ ì „í™˜ìˆ˜**: \(.total_metrics.conversions | tonumber | floor | tostring)ê±´\n" +
              "**ROAS**: \(.kpis.roas)%"
            ' >> summary.md || echo "í†µê³„ ìƒì„± ì‹¤íŒ¨" >> summary.md
          fi
          
          echo "" >> summary.md
          echo "### ìƒì„±ëœ íŒŒì¼" >> summary.md
          echo "- ì›”ë³„ ë°ì´í„°: \`data/raw/*.csv\`" >> summary.md
          echo "- í†µê³„ ë¶„ì„: \`data/statistics/*\`" >> summary.md
          echo "- ì˜ˆì¸¡ ë°ì´í„°: \`data/forecast/*\`" >> summary.md
      
      - name: ğŸ’¾ Commit and push changes
        run: |
          echo "ğŸ“ Git ìƒíƒœ í™•ì¸ ì¤‘..."
          
          git config user.name "Marketing Data Bot"
          git config user.email "actions@github.com"
          
          # data í´ë”ì™€ summary íŒŒì¼ ì¶”ê°€
          git add -A data/
          git add summary.md || true
          
          # ìƒíƒœ ì¶œë ¥
          echo "Git status:"
          git status --short
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --staged --quiet; then
            echo "âš ï¸  ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ê±´ë„ˆëœ€"
          else
            echo "âœ… ë³€ê²½ì‚¬í•­ ê°ì§€ë¨ - ì»¤ë°‹ ì§„í–‰"
            
            # ê°„ë‹¨í•œ ì»¤ë°‹ ë©”ì‹œì§€
            git commit -m "ğŸ“Š ë°ì´í„° ì—…ë°ì´íŠ¸: $(TZ='Asia/Seoul' date +'%Y-%m-%d %H:%M') KST"
            
            # í‘¸ì‹œ
            git push
            
            echo "âœ… ë°ì´í„° ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ!"
          fi
      
      - name: âœ… Complete
        run: |
          echo "ğŸ‰ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ!"
          echo ""
          echo "ğŸ“ ìƒì„±ëœ íŒŒì¼:"
          ls -lh data/raw/*.csv 2>/dev/null || echo "raw í´ë” ì—†ìŒ"
          ls -lh data/meta/*.json 2>/dev/null || echo "meta í´ë” ì—†ìŒ"
          ls -lh data/statistics/* 2>/dev/null || echo "statistics í´ë” ì—†ìŒ"
          ls -lh data/forecast/* 2>/dev/null || echo "forecast í´ë” ì—†ìŒ"
          echo ""
          if [ -f "summary.md" ]; then
            echo "ğŸ“Š ìš”ì•½:"
            cat summary.md
          fi
