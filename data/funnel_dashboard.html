<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AARRR 퍼널 대시보드 - GA4 분석</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-600: #757575;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--grey-700);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-item-text {
            flex: 1;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 헤더 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 카드 공통 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 14px 0 rgba(32, 40, 45, 0.08);
            transition: box-shadow 0.3s ease;
            position: relative;
            z-index: 1;
            overflow: visible;
        }

        .card:hover {
            box-shadow: 0 4px 20px 0 rgba(32, 40, 45, 0.12);
        }

        /* KPI 요약 섹션 */
        .kpi-summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-summary-card {
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--paper) 0%, var(--grey-50) 100%);
            position: relative;
            overflow: hidden;
        }

        .kpi-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .kpi-summary-card:nth-child(1)::before { background: #673ab7; }
        .kpi-summary-card:nth-child(2)::before { background: #2196f3; }
        .kpi-summary-card:nth-child(3)::before { background: #ff9800; }
        .kpi-summary-card:nth-child(4)::before { background: #4caf50; }
        .kpi-summary-card:nth-child(5)::before { background: #00c853; }

        .kpi-summary-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .kpi-summary-unit {
            font-size: 11px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        .kpi-summary-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .kpi-summary-badge.positive {
            background: var(--success-light);
            color: var(--success-main);
        }

        .kpi-summary-badge.negative {
            background: var(--error-light);
            color: var(--error-main);
        }

        /* 차트 섹션 */
        .chart-section {
            margin-bottom: 24px;
            padding: 24px;
            overflow: visible;
        }

        .chart-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--secondary-main);
            border-radius: 2px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            overflow: visible;
        }

        .chart-container-small {
            position: relative;
            height: 300px;
            overflow: visible;
        }

        /* 뷰 타입 버튼 */
        .view-type-section {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .view-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .view-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .view-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        /* 탭 컨텐츠 스타일 */
        .decision-tool-tab-content,
        .channel-analysis-tab-content,
        .customer-analysis-tab-content {
            display: none;
        }

        .decision-tool-tab-content.active,
        .channel-analysis-tab-content.active,
        .customer-analysis-tab-content.active {
            display: block;
        }

        /* 그리드 레이아웃 */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        /* 인사이트 섹션 */
        .insight-section {
            padding: 24px;
            margin-bottom: 24px;
        }

        .insight-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--warning-main);
            border-radius: 2px;
        }

        .insight-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .insight-card {
            padding: 20px;
            background: linear-gradient(135deg, var(--grey-50) 0%, var(--paper) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary-main);
        }

        .insight-card.positive {
            border-left-color: var(--success-main);
        }

        .insight-card.negative {
            border-left-color: var(--error-main);
        }

        .insight-card.neutral {
            border-left-color: var(--warning-main);
        }

        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-title svg {
            width: 18px;
            height: 18px;
        }

        .insight-text {
            font-size: 14px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        /* 데이터 테이블 */
        .table-section {
            overflow: visible;
            position: relative;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--grey-200);
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--success-main);
            border-radius: 2px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: relative;
            z-index: 50;
        }

        th, td {
            padding: 14px 16px;
            text-align: right;
            font-size: 14px;
        }

        th {
            background: var(--grey-50);
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 2px solid var(--grey-200);
            white-space: nowrap;
            overflow: visible;
            position: relative;
        }

        td {
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--paper);
            font-weight: 500;
        }

        th:first-child {
            background: var(--grey-50);
            z-index: 51;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--grey-50);
        }

        tbody tr:hover td:first-child {
            background: var(--grey-50);
        }

        /* 접기/펼치기 스타일 */
        .collapsible-section {
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 20px 24px;
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .collapsible-icon {
            font-size: 20px;
        }

        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-light);
            color: var(--primary-main);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .collapsible-toggle:hover {
            background: var(--primary-main);
            color: white;
        }

        .collapsible-toggle-icon {
            transition: transform 0.3s ease;
            transform: rotate(180deg);
        }

        .collapsible-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .collapsible-content.expanded {
            max-height: 10000px;
            opacity: 1;
            padding-top: 16px;
            overflow: visible;
        }

        /* 차트 인사이트 툴팁 */
        .chart-insight-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 0;
            display: none;
            z-index: 99999;
            max-width: 320px;
            min-width: 280px;
            pointer-events: none;
        }

        .chart-insight-tooltip.show {
            display: block;
        }

        .tooltip-insight-section {
            padding: 16px;
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #ffd54f;
        }

        .tooltip-insight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #f57c00;
            margin-bottom: 8px;
        }

        .tooltip-insight-text {
            font-size: 13px;
            color: var(--grey-800);
            line-height: 1.5;
            margin: 0;
        }

        .tooltip-recommendation-section {
            padding: 16px;
            background: white;
            border-radius: 0 0 12px 12px;
        }

        .tooltip-recommendation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--primary-main);
            margin-bottom: 8px;
        }

        .tooltip-recommendation-text {
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.5;
            margin: 0;
        }

        /* 반응형 */
        @media (max-width: 1400px) {
            .kpi-summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .insight-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            .kpi-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-container {
                height: 300px;
            }
            .insight-content {
                grid-template-columns: 1fr;
            }
        }

        /* 퍼널 비율 바 */
        .funnel-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .funnel-bar-fill {
            height: 8px;
            background: linear-gradient(90deg, var(--primary-main), var(--success-main));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .funnel-bar-label {
            font-size: 11px;
            color: var(--grey-600);
            min-width: 40px;
        }

        /* D3 Funnel Styles */
        #d3FunnelChart {
            width: 100%;
            height: 650px;
            position: relative;
            overflow: visible;
        }

        .funnel-stage {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .funnel-stage:hover {
            opacity: 1;
            filter: brightness(1.1);
        }

        .funnel-stage path {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
            transition: filter 0.3s ease;
        }

        .funnel-stage:hover path {
            filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.25));
        }

        .funnel-stage-label {
            font-size: 16px;
            font-weight: 600;
            fill: var(--grey-900);
            pointer-events: none;
        }

        .funnel-stage-value {
            font-size: 14px;
            font-weight: 500;
            fill: var(--grey-700);
            pointer-events: none;
        }

        .funnel-stage-conversion {
            font-size: 12px;
            fill: var(--grey-600);
            pointer-events: none;
        }

        .funnel-tooltip {
            position: fixed;
            background: white;
            border: 2px solid var(--primary-main);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(103, 58, 183, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            z-index: 9999;
            max-width: 380px;
            min-width: 300px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .funnel-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .funnel-tooltip::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid var(--primary-main);
        }

        .funnel-tooltip-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-main);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .funnel-tooltip-title::before {
            content: '📊';
            font-size: 20px;
        }

        .funnel-tooltip-metric {
            font-size: 14px;
            color: var(--grey-700);
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 8px;
            background: var(--grey-50);
            border-radius: 6px;
        }

        .funnel-tooltip-metric-label {
            font-weight: 600;
            color: var(--grey-700);
        }

        .funnel-tooltip-metric-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-main);
        }

        .funnel-tooltip-insight {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%);
            border-radius: 8px;
            border-left: 4px solid var(--secondary-main);
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        .funnel-tooltip-insight::before {
            content: '💡 ';
            font-size: 16px;
        }

        .funnel-tooltip-recommendation {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--warning-light) 0%, #fff9e6 100%);
            border-radius: 8px;
            border-left: 4px solid var(--warning-main);
            font-size: 13px;
            font-weight: 500;
            color: var(--grey-900);
            line-height: 1.6;
        }

        .funnel-tooltip-recommendation::before {
            content: '🎯 추천: ';
            font-weight: 700;
            color: var(--warning-main);
        }

        /* 필터 섹션 */
        .filter-section {
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .filter-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
            flex: 1;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--grey-700);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
        }

        .filter-group select:hover,
        .filter-group input:hover {
            border-color: var(--primary-main);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px rgba(103, 58, 183, 0.1);
        }

        .date-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-range input[type="date"] {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
            flex: 1;
        }

        .date-range input[type="date"]:hover {
            border-color: var(--primary-main);
        }

        .date-range input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px rgba(103, 58, 183, 0.1);
        }

        .date-range span {
            color: var(--grey-500);
            font-weight: 500;
        }

        /* 퍼널 차트 중앙 정렬 */
        #d3FunnelChart,
        #d3FunnelChartLeft,
        #d3FunnelChartRight {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #d3FunnelChart svg,
        #d3FunnelChartLeft svg,
        #d3FunnelChartRight svg {
            display: block;
            margin: 0 auto;
        }

        /* 테이블 정렬 기능 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px !important;
            transition: background 0.2s ease;
            z-index: 100;
        }

        .sortable-header:hover {
            background: var(--grey-100);
        }

        .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }

        .sortable-header:hover .sort-icon {
            opacity: 0.6;
        }

        .sort-icon.active {
            opacity: 1;
        }

        .sort-arrow {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }

        .sort-arrow.up {
            border-bottom: 5px solid var(--grey-700);
        }

        .sort-arrow.down {
            border-top: 5px solid var(--grey-700);
        }

        .sort-arrow.active {
            border-bottom-color: var(--primary-main);
            border-top-color: var(--primary-main);
        }

        /* 정렬 툴팁 */
        .sort-tooltip {
            position: fixed;
            transform: translate(-50%, -100%);
            background: var(--grey-900);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 9999;
            margin-top: -8px;
        }

        .sort-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--grey-900);
        }

        .sortable-header:hover .sort-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* 테이블 셀 색상 스케일 */
        .cell-value {
            position: relative;
            font-weight: 500;
        }

        .cell-bg {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            opacity: 0.15;
            transition: opacity 0.3s ease;
            border-radius: 4px;
        }

        tr:hover .cell-bg {
            opacity: 0.25;
        }

        /* 색상 스케일 - 각 메트릭별 */
        .scale-acquisition { background: linear-gradient(90deg, transparent, #673ab7); }
        .scale-activation { background: linear-gradient(90deg, transparent, #2196f3); }
        .scale-consideration { background: linear-gradient(90deg, transparent, #ff9800); }
        .scale-conversion { background: linear-gradient(90deg, transparent, #4caf50); }
        .scale-purchase { background: linear-gradient(90deg, transparent, #00c853); }
        .scale-revenue { background: linear-gradient(90deg, transparent, #f44336); }
        .scale-cvr { background: linear-gradient(90deg, transparent, #9c27b0); }

        /* 테이블 셀 패딩 조정 */
        td.has-bg {
            position: relative;
            padding: 14px 16px;
        }

        td.has-bg > span {
            position: relative;
            z-index: 1;
        }

        /* 더 보기/접기 기능 */
        .hidden-row {
            display: none;
        }

        .show-more-container {
            padding: 16px 24px;
            text-align: center;
        }

        .show-more-btn {
            padding: 10px 32px;
            background: var(--grey-100);
            color: var(--grey-700);
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .show-more-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
            border-color: var(--primary-main);
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="sidebar-logo-text">Analytics</div>
                        <div class="sidebar-logo-subtitle">Dashboard</div>
                    </div>
                </a>
            </div>

            <div class="simplebar-content-wrapper">
                <div class="sidebar-content">
                    <!-- 대시보드 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">대시보드</div>
                        <a href="marketing_dashboard_v3.html" class="nav-item">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">광고 성과 대시보드</span>
                        </a>
                        <a href="#" class="nav-item active">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">AARRR 퍼널 분석</span>
                        </a>
                    </div>

                    <!-- 분석 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">분석</div>
                        <a href="creative_analysis.html" class="nav-item">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">광고 소재별 분석</span>
                        </a>
                        <a href="timeseries_analysis.html" class="nav-item">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M23 8c0 1.1-.9 2-2 2-.18 0-.35-.02-.51-.07l-3.56 3.55c.05.16.07.34.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.18.02-.36.07-.52l-2.55-2.55c-.16.05-.34.07-.52.07s-.36-.02-.52-.07l-4.55 4.56c.05.16.07.33.07.51 0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2c.18 0 .35.02.51.07l4.56-4.55C8.02 9.36 8 9.18 8 9c0-1.1.9-2 2-2s2 .9 2 2c0 .18-.02.36-.07.52l2.55 2.55c.16-.05.34-.07.52-.07s.36.02.52.07l3.55-3.56C19.02 8.35 19 8.18 19 8c0-1.1.9-2 2-2s2 .9 2 2z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">시계열 데이터 분석</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <div class="container">
                <!-- 헤더 -->
                <div class="header">
                    <div>
                        <h1>고객 구매 여정 분석 대시보드</h1>
                        <div class="header-subtitle">방문자가 고객이 되기까지의 전 과정을 한눈에 분석 <span id="analysisPeriod" style="color: var(--primary-main); font-weight: 600;"></span></div>
                        <div style="margin-top: 8px; font-size: 13px; color: var(--grey-600); line-height: 1.6;">
                            💡 <strong>이 대시보드는</strong> 웹사이트 방문자가 실제 구매까지 이르는 과정을 5단계로 나누어 보여줍니다. 각 단계에서 얼마나 많은 고객을 잃는지, 어떤 채널이 효과적인지 파악할 수 있습니다.
                        </div>
                    </div>
                </div>

                <!-- 0. 성과 요약 배너 -->
                <div id="summaryCardBanner" style="display: none; margin-bottom: 24px; padding: 20px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <div id="summaryCardTitle" style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">이번 달 성과 요약</div>
                            <div id="summaryCardMessage" style="font-size: 15px; opacity: 0.95;"></div>
                        </div>
                        <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">방문자</div>
                                <div id="summaryCardVisitors" style="font-size: 20px; font-weight: 700;"></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">구매자</div>
                                <div id="summaryCardPurchasers" style="font-size: 20px; font-weight: 700;"></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">전환율</div>
                                <div id="summaryCardCVR" style="font-size: 20px; font-weight: 700;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1. 핵심 KPI 요약 -->
                <div class="kpi-summary-grid" id="kpiSummaryGrid">
                    <!-- JS로 동적 생성 -->
                </div>

                <!-- 2. 인터랙티브 퍼널 시각화 (D3.js) - KPI 바로 다음 배치 -->
                <div class="chart-section card">
                    <div class="chart-header">
                        📊 고객 구매 여정 5단계
                        <button id="funnelCompareBtn" class="view-btn" style="font-size: 14px; padding: 8px 20px; float: right;">
                            비교
                        </button>
                    </div>

                    <!-- 설명 -->
                    <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px;">
                        <strong>각 단계를 마우스로 가리키면</strong> 해당 단계의 전환율과 개선 방법을 확인할 수 있습니다.
                    </div>

                    <!-- 단일 퍼널 뷰 -->
                    <div id="singleFunnelView">
                        <div id="d3FunnelChart"></div>
                    </div>

                    <!-- 비교 퍼널 뷰 -->
                    <div id="compareFunnelView" style="display: none;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: var(--grey-800); font-size: 16px; font-weight: 600; margin: 0;">📊 단계별 비교 분석</h3>
                            <p style="font-size: 12px; color: var(--grey-500); margin: 4px 0 0 0;">왼쪽과 오른쪽 기간의 각 단계를 비교합니다</p>
                        </div>

                        <!-- 기간 선택 카드 -->
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- 왼쪽 기간 선택 -->
                            <div class="filter-section card">
                                <div class="filter-header">왼쪽 기간 선택</div>
                                <div class="filter-row" style="margin-bottom: 0;">
                                    <div class="filter-group">
                                        <div class="date-range">
                                            <input type="date" id="leftStartDate">
                                            <span>~</span>
                                            <input type="date" id="leftEndDate">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 가운데 빈 공간 -->
                            <div style="min-width: 60px;"></div>

                            <!-- 오른쪽 기간 선택 -->
                            <div class="filter-section card">
                                <div class="filter-header">오른쪽 기간 선택</div>
                                <div class="filter-row" style="margin-bottom: 0;">
                                    <div class="filter-group">
                                        <div class="date-range">
                                            <input type="date" id="rightStartDate">
                                            <span>~</span>
                                            <input type="date" id="rightEndDate">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 퍼널 차트 비교 -->
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start;">
                            <!-- 왼쪽 퍼널 -->
                            <div id="d3FunnelChartLeft"></div>

                            <!-- 가운데 비교 인사이트 -->
                            <div id="comparisonInsights" style="min-width: 320px; max-width: 400px; padding: 16px; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); border-radius: 12px; border: 2px solid #e0e7ff;">
                                <div style="text-align: center; margin-bottom: 12px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 변화 요약</div>
                                    <div style="font-size: 10px; color: var(--grey-500); margin-top: 2px;">왼쪽 → 오른쪽</div>
                                </div>
                                <div id="comparisonContent" style="font-size: 13px; color: var(--grey-700);"></div>
                            </div>

                            <!-- 오른쪽 퍼널 -->
                            <div id="d3FunnelChartRight"></div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button id="closeFunnelCompare" class="view-btn" style="font-size: 14px; padding: 8px 20px;">
                                단일 뷰로 돌아가기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. 통합 인사이트 & 전략 섹션 -->
                <div class="chart-section card" style="margin-bottom: 24px;">
                    <div class="chart-header">
                        💡 인사이트 & 채널 전략
                    </div>
                    <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px;">
                        퍼널 분석 결과를 바탕으로 <strong>지금 바로 실행할 수 있는 개선 포인트</strong>와 <strong>채널별 투자 전략</strong>을 확인하세요.
                    </div>

                    <!-- 인사이트 섹션 전용 기간 필터 버튼 -->
                    <div style="margin-bottom: 12px; padding: 10px 14px; background: linear-gradient(135deg, #f3e5f5 0%, #e8eaf6 100%); border-radius: 8px; border: 1px solid #d1c4e9;">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span style="font-size: 11px; font-weight: 600; color: #5e35b1;">📅 분석 기간:</span>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                <button class="insight-period-btn active" data-period="full" onclick="switchInsightPeriod('full')"
                                        style="padding: 4px 10px; font-size: 10px; font-weight: 600; border: 1px solid #673ab7; border-radius: 16px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">
                                    전체
                                </button>
                                <button class="insight-period-btn" data-period="180d" onclick="switchInsightPeriod('180d')"
                                        style="padding: 4px 10px; font-size: 10px; font-weight: 600; border: 1px solid #d1c4e9; border-radius: 16px; cursor: pointer; transition: all 0.2s; background: white; color: #5e35b1;">
                                    180일
                                </button>
                                <button class="insight-period-btn" data-period="90d" onclick="switchInsightPeriod('90d')"
                                        style="padding: 4px 10px; font-size: 10px; font-weight: 600; border: 1px solid #d1c4e9; border-radius: 16px; cursor: pointer; transition: all 0.2s; background: white; color: #5e35b1;">
                                    90일
                                </button>
                                <button class="insight-period-btn" data-period="30d" onclick="switchInsightPeriod('30d')"
                                        style="padding: 4px 10px; font-size: 10px; font-weight: 600; border: 1px solid #d1c4e9; border-radius: 16px; cursor: pointer; transition: all 0.2s; background: white; color: #5e35b1;">
                                    30일
                                </button>
                            </div>
                            <span id="insightPeriodDateRange" style="font-size: 10px; color: #7e57c2; margin-left: auto;"></span>
                        </div>
                    </div>

                    <!-- 통합 탭 버튼 -->
                    <div class="view-type-section" style="margin-bottom: 20px;">
                        <button class="view-btn insight-strategy-tab-btn active" data-tab="summary">📊 핵심 요약</button>
                        <button class="view-btn insight-strategy-tab-btn" data-tab="urgent">🚨 긴급 개선 <span id="urgentTotalCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                        <button class="view-btn insight-strategy-tab-btn" data-tab="bcg">📈 채널 전략</button>
                    </div>

                    <!-- 탭 1: 핵심 요약 -->
                    <div class="insight-strategy-tab-content active" id="summaryTabContent">
                        <div class="insight-content" id="insightContent">
                            <div class="insight-card neutral">
                                <div class="insight-text">데이터를 불러오는 중...</div>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 2: 긴급 개선 포인트 -->
                    <div class="insight-strategy-tab-content" id="urgentTabContent" style="display: none;">
                        <!-- 서브탭: 즉시 조치 / 개선 권장 -->
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button class="view-btn urgent-alert-tab-btn active" data-tab="high" style="font-size: 13px;">⚠️ 즉시 조치 필요 <span id="highAlertCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                            <button class="view-btn urgent-alert-tab-btn" data-tab="medium" style="font-size: 13px;">📌 개선 권장 <span id="mediumAlertCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                        </div>
                        <!-- 즉시 조치 필요 -->
                        <div id="highAlertsTab" class="urgent-alert-tab-content active">
                            <div id="highAlertsCards" style="display: grid; gap: 12px;"></div>
                            <div id="highAlertsToggleContainer" style="text-align: center; margin-top: 12px; display: none;">
                                <button id="highAlertsToggleBtn" class="view-btn" style="font-size: 13px; padding: 8px 20px;">더 보기</button>
                            </div>
                        </div>
                        <!-- 개선 권장 -->
                        <div id="mediumAlertsTab" class="urgent-alert-tab-content" style="display: none;">
                            <div id="mediumAlertsCards" style="display: grid; gap: 12px;"></div>
                            <div id="mediumAlertsToggleContainer" style="text-align: center; margin-top: 12px; display: none;">
                                <button id="mediumAlertsToggleBtn" class="view-btn" style="font-size: 13px; padding: 8px 20px;">더 보기</button>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 3: BCG Matrix 채널 전략 -->
                    <div class="insight-strategy-tab-content" id="bcgTabContent" style="display: none;">
                        <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px;">
                            트래픽과 전환율을 기준으로 각 채널을 4가지 유형으로 분류했습니다.
                        </div>
                        <div id="bcgMatrixContent" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <!-- JS로 동적 생성 -->
                        </div>
                    </div>
                </div>

                <!-- 4. 고급 분석 결과 (A/B Testing, Clustering, Churn Prediction) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">🔬</span>
                            <span>데이터 기반 의사결정 도구 (예산 투자, 성과 비교, 위험 감지)</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 기간 필터 버튼 -->
                        <div style="margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="font-size: 12px; font-weight: 600; color: #495057;">📅 분석 기간:</span>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="period-filter-btn active" data-period="full" onclick="switchPeriod('full')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">
                                        전체 기간
                                    </button>
                                    <button class="period-filter-btn" data-period="180d" onclick="switchPeriod('180d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 180일
                                    </button>
                                    <button class="period-filter-btn" data-period="90d" onclick="switchPeriod('90d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 90일
                                    </button>
                                    <button class="period-filter-btn" data-period="30d" onclick="switchPeriod('30d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 30일
                                    </button>
                                </div>
                                <span id="periodDateRange" style="font-size: 11px; color: #6c757d; margin-left: auto;"></span>
                            </div>
                        </div>

                        <!-- 탭 버튼 -->
                        <div class="view-type-section" style="margin-bottom: 24px; flex-wrap: wrap; gap: 6px; align-items: center;">
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled active" data-tab="clustering" title="선택한 기간 필터가 적용됩니다">채널 그룹별 특성</button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="budget" title="선택한 기간 필터가 적용됩니다">예산 투자 가이드</button>
                            <button class="view-btn decision-tool-tab-btn period-filter-disabled" data-tab="churn-alert" style="position: relative;" title="전체 기간 데이터만 사용됩니다 (기간 필터 미적용)">
                                이탈 위험 경고
                                <span style="position: absolute; top: -6px; right: -6px; background: #78909c; color: white; font-size: 8px; padding: 2px 4px; border-radius: 8px; font-weight: 600;">전체</span>
                            </button>
                            <button class="view-btn decision-tool-tab-btn period-filter-disabled" data-tab="improvement" style="position: relative;" title="전체 기간 데이터만 사용됩니다 (기간 필터 미적용)">
                                성과 개선 분석
                                <span style="position: absolute; top: -6px; right: -6px; background: #78909c; color: white; font-size: 8px; padding: 2px 4px; border-radius: 8px; font-weight: 600;">전체</span>
                            </button>
                            <!-- 범례 -->
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 12px; font-size: 10px; color: #6c757d;">
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 8px; height: 8px; background: #673ab7; border-radius: 2px;"></span>
                                    기간 필터 적용
                                </span>
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 8px; height: 8px; background: #78909c; border-radius: 2px;"></span>
                                    전체 기간 고정
                                </span>
                            </div>
                        </div>

                        <!-- 탭 1: 채널 클러스터링 -->
                        <div class="decision-tool-tab-content active" id="clusteringTab">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🎯 채널 그룹별 특성 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); padding: 0 20px 12px 20px;">
                                비슷한 성과를 보이는 채널들을 그룹으로 묶어 보여드립니다. 같은 그룹 내 채널들은 비슷한 전략으로 관리하면 효율적입니다.
                            </div>
                            <div id="channelClusters" style="padding: 20px;">
                                <p style="color: var(--grey-500);">데이터를 불러오는 중...</p>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 2: 예산 투자 가이드 -->
                        <div class="decision-tool-tab-content" id="budgetTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">💰 예산 투자 가이드: 채널별 투자 효율성 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); padding: 0 20px 12px 20px;">
                                각 채널의 전환율, 객단가, 실제 성과 데이터를 종합하여 <strong>100만원 투자 시 예상되는 구체적인 성과</strong>를 시뮬레이션했습니다.
                                <strong>"신뢰도"</strong>는 데이터 양에 기반한 분석의 정확도를 나타내며, 채널 타입별로 다른 투자 전략을 제시합니다.
                                <div style="margin-top: 8px; padding: 8px; background: var(--grey-50); border-radius: 6px; font-size: 12px;">
                                    <strong>📌 분석 기준:</strong> 광고 채널(1,500원/방문자), 오가닉 최적화(300원/방문자), 레퍼럴(500원/방문자) 등 업계 평균 CPA 적용
                                </div>
                            </div>
                            <div id="abTestResults" style="padding: 20px;">
                                <p style="color: var(--grey-500);">데이터를 불러오는 중...</p>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 3: 이탈 위험 경고 -->
                        <div class="decision-tool-tab-content" id="churnAlertTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>⚠️ 주의 필요: 고객 이탈 증가 감지</span>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="view-btn churn-period-btn active" data-period="7d">최근 7일</button>
                                        <button class="view-btn churn-period-btn" data-period="30d">최근 30일</button>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--grey-600); padding: 0 20px 12px 20px;">
                                이전 기간 대비 고객 이탈이 늘어난 단계를 알려드립니다. 빠르게 대응하면 매출 손실을 막을 수 있습니다.
                            </div>
                            <div id="churnPredictions" style="padding: 20px;">
                                <p style="color: var(--grey-500);">데이터를 불러오는 중...</p>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 4: 성과 개선 분석 -->
                        <div class="decision-tool-tab-content" id="improvementTab" style="display: none;">
                        <div class="chart-section card">
                            <div class="chart-header">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>✨ 좋은 소식: 어떤 부분이 좋아졌나요?</span>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="view-btn improvement-period-btn active" data-period="7d">최근 7일</button>
                                        <button class="view-btn improvement-period-btn" data-period="30d">최근 30일</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); line-height: 1.7; border-radius: 8px; margin: 16px 20px 12px 20px;">
                                <strong style="color: var(--primary-main);">📖 이 섹션은 무엇을 보여주나요?</strong><br>
                                이전 기간과 비교하여 성과가 <strong>좋아진 단계</strong>를 자동으로 찾아드립니다.<br>
                                <span style="color: var(--grey-600);">예시: 최근 7일간 "구매완료"가 이전 7일보다 15% 증가했다면 여기에 표시됩니다.</span><br><br>
                                <strong style="color: var(--primary-main);">💡 왜 중요한가요?</strong><br>
                                • 좋아진 이유를 알아야 <strong>그 성과를 계속 유지</strong>할 수 있습니다<br>
                                • 성공 요인을 찾아 <strong>다른 채널이나 상품에도 적용</strong>할 수 있습니다<br>
                                • 각 개선 사항마다 <strong>바로 실행할 수 있는 구체적인 액션</strong>을 제공합니다
                            </div>

                            <div id="improvementPredictions" style="padding: 20px;">
                                <p style="color: var(--grey-500);">데이터를 불러오는 중...</p>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- 5. 채널별 분석 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📊</span>
                            <span>유입 채널별 상세 분석 (네이버, 구글, 인스타그램 등)</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 탭 버튼 -->
                        <div class="view-type-section" style="margin-bottom: 24px;">
                            <button class="view-btn channel-analysis-tab-btn active" data-tab="table">채널별 고객 흐름</button>
                            <button class="view-btn channel-analysis-tab-btn" data-tab="kpi">지표별 비교</button>
                            <button class="view-btn channel-analysis-tab-btn" data-tab="balance">효율성과 규모</button>
                            <button class="view-btn channel-analysis-tab-btn" data-tab="top10">전환율 TOP 10</button>
                        </div>

                        <!-- 탭 1: 채널별 단계별 고객 수 테이블 -->
                        <div class="channel-analysis-tab-content active" id="tableTab">
                        <div class="table-section card" style="margin-bottom: 16px;">
                            <div class="table-header">📊 채널별 고객 흐름: 각 채널에서 얼마나 많은 고객이 구매까지 도달하나요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 표는 무엇을 보여주나요?</strong><br>
                                각 마케팅 채널(네이버, 구글, 인스타그램 등)에서 고객이 <strong>5단계 여정</strong>을 어떻게 거치는지 보여줍니다.<br>
                                <span style="color: var(--grey-600);">예시: 유입 1,000명 → 활동 800명 → 관심 400명 → 결제진행 100명 → 구매완료 50명 (CVR 5%)</span><br><br>
                                <strong style="color: var(--primary-main);">💡 표 보는 법:</strong><br>
                                • <strong>왼쪽에서 오른쪽</strong>으로 갈수록 숫자가 줄어드는 것이 정상입니다 (고객이 단계를 거치며 이탈)<br>
                                • <strong>CVR(전환율)</strong>은 방문자 100명 중 몇 명이 최종 구매했는지를 나타냅니다 (높을수록 좋음)<br>
                                • <strong>매출</strong>이 높아도 CVR이 낮으면 개선 여지가 많다는 의미입니다<br>
                                • <strong>열 제목을 클릭</strong>하면 해당 기준으로 정렬됩니다
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="channelTableInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 10px; border-left: 4px solid #4caf50;">
                                <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 8px;">
                                    🎯 데이터 분석 결과
                                </div>
                                <div id="channelTableInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div class="table-container">
                                <table id="channelTable">
                                    <thead>
                                        <tr>
                                            <th>채널</th>
                                            <th class="sortable-header" data-column="유입" data-type="number">
                                                유입
                                                <div class="sort-icon active">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down active"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 유입 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="활동" data-type="number">
                                                활동
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 활동 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="관심" data-type="number">
                                                관심
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 관심 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="결제진행" data-type="number">
                                                결제진행
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 결제진행 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="구매완료" data-type="number">
                                                구매완료
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 구매완료 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="Revenue" data-type="number">
                                                매출
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 매출 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="CVR" data-type="number">
                                                CVR
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 CVR 기준으로 정렬</div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="channelTableBody">
                                        <tr>
                                            <td colspan="8">데이터를 불러오는 중...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 데이터 해석 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- CVR이 높은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            ✅ CVR이 높은 채널 (3% 이상)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 효율적인 채널. 적은 방문자로도 많이 구매<br>
                                            <strong>전략:</strong> 광고비를 더 투자하고, 이 채널의 성공 요인을 다른 채널에 적용하세요
                                        </div>
                                    </div>

                                    <!-- 매출이 높지만 CVR이 낮은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            ⚠️ 매출은 높은데 CVR이 낮은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 방문자가 많지만 전환율이 낮아 비효율적<br>
                                            <strong>전략:</strong> 랜딩 페이지 개선, 타겟팅 정밀화로 CVR을 높이면 매출이 크게 증가합니다
                                        </div>
                                    </div>

                                    <!-- 방문자가 많지만 이탈이 높은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            🚪 유입은 많은데 활동 수가 급감하는 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 첫 화면에서 대부분 이탈. 광고와 페이지 불일치 가능성<br>
                                            <strong>전략:</strong> 광고 메시지와 랜딩 페이지의 일관성 확인, 로딩 속도 개선
                                        </div>
                                    </div>

                                    <!-- 관심까지는 가지만 결제로 안 가는 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #f3e5f5 0%, #faf5fc 100%); border-radius: 8px; border-left: 3px solid #9c27b0;">
                                        <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 6px;">
                                            💭 관심까지는 가는데 결제 안 하는 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 관심은 있지만 구매 결정을 망설임. 가격이나 신뢰 문제<br>
                                            <strong>전략:</strong> 리뷰/후기 강화, 첫 구매 할인 제공, 결제 과정 간소화
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 체크리스트 -->
                                <div style="padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fffcf5 100%); border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 10px;">
                                        ✅ 이 표를 보고 바로 실행할 수 있는 것들
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.8;">
                                        1. <strong>CVR 1위 채널</strong>을 찾아 광고 예산을 20% 더 배정하세요<br>
                                        2. <strong>유입은 많지만 CVR이 낮은 채널</strong>의 광고 소재와 랜딩 페이지를 점검하세요<br>
                                        3. <strong>단계별 이탈률이 가장 높은 구간</strong>을 찾아 집중 개선하세요 (예: 유입→활동 50% 이상 이탈)<br>
                                        4. <strong>매출 상위 3개 채널</strong>의 공통점을 찾아 성공 패턴을 문서화하세요<br>
                                        5. <strong>CVR 0.5% 이하 채널</strong>은 일시 중단하고 예산을 재배분하세요
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 2: KPI 차트 -->
                        <div class="channel-analysis-tab-content" id="kpiTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📈 각 지표별로 어떤 채널이 1등인가요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); margin-bottom: 16px; line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 차트는 무엇을 보여주나요?</strong><br>
                                원하는 지표(전환율, 방문자 수, 매출 등)별로 각 채널의 성과를 한눈에 비교할 수 있습니다.<br><br>
                                <strong style="color: var(--primary-main);">💡 사용 방법:</strong><br>
                                • 아래 버튼을 클릭하여 보고 싶은 지표를 선택하세요<br>
                                • <strong>전환율</strong>은 효율성을, <strong>매출</strong>은 실제 수익을, <strong>방문자 수</strong>는 트래픽 규모를 나타냅니다<br>
                                • <strong>차트 위에 마우스를 올리면</strong> 해당 지표에 대한 자세한 설명과 개선 전략을 볼 수 있습니다
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 보고 싶은 지표:</span>
                                <button class="view-btn channel-kpi-btn active" data-kpi="cvr" data-chart="kpi">전환율 (%)</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="acquisition" data-chart="kpi">방문자 수</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="activation" data-chart="kpi">활성 사용자</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="consideration" data-chart="kpi">관심 고객</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="conversion" data-chart="kpi">결제 시도</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="purchase" data-chart="kpi">구매 건수</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="revenue" data-chart="kpi">매출액</button>
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="kpiChartInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                    💡 지표 분석 인사이트
                                </div>
                                <div id="kpiChartInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    버튼을 클릭하여 지표를 선택하면 자동 분석 결과가 여기에 표시됩니다.
                                </div>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="channelKpiChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 각 지표를 볼 때 주의할 점
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <!-- 전환율 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            📊 전환율 (CVR)을 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>높을수록 좋음:</strong> 효율성을 나타냅니다<br>
                                            <strong>주의:</strong> 방문자가 너무 적으면 통계적으로 불안정할 수 있어요
                                        </div>
                                    </div>

                                    <!-- 방문자/매출 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            👥 방문자 수 / 💰 매출을 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>높을수록 좋음:</strong> 규모를 나타냅니다<br>
                                            <strong>주의:</strong> 방문자만 많고 전환율이 낮으면 비효율적이에요
                                        </div>
                                    </div>

                                    <!-- 활성 사용자 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            ⚡ 활성 사용자를 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 실제로 사이트를 사용한 방문자 수<br>
                                            <strong>활용:</strong> 방문자 수와 비교해 첫 이탈률을 파악하세요
                                        </div>
                                    </div>

                                    <!-- 관심/결제/구매 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #f3e5f5 0%, #faf5fc 100%); border-radius: 8px; border-left: 3px solid #9c27b0;">
                                        <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 6px;">
                                            🛒 관심/결제/구매를 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 구매 여정의 각 단계별 고객 수<br>
                                            <strong>활용:</strong> 단계별로 급감하는 구간을 찾아 개선하세요
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 3: 비교 차트 -->
                        <div class="channel-analysis-tab-content" id="balanceTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🔄 어떤 채널이 효율성과 규모를 모두 갖췄나요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); margin-bottom: 16px; line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 차트는 무엇을 보여주나요?</strong><br>
                                전환율, 방문자 수, 구매 건수, 매출을 모두 <strong>100점 만점</strong>으로 환산하여 비교합니다.<br>
                                <span style="color: var(--grey-600);">예시: CVR이 가장 높은 채널을 100점으로 했을 때, 다른 채널들은 몇 점인지 보여줍니다.</span><br><br>
                                <strong style="color: var(--primary-main);">💡 차트 보는 법:</strong><br>
                                • <strong>모든 막대가 고르게 높은 채널</strong> = 효율도 좋고 규모도 큰 최고의 채널<br>
                                • <strong>CVR만 높고 다른 막대가 낮은 채널</strong> = 효율은 좋지만 규모가 작은 채널 (투자 확대 필요)<br>
                                • <strong>방문자/매출만 높고 CVR이 낮은 채널</strong> = 규모는 크지만 비효율적인 채널 (개선 필요)<br>
                                • <strong>차트 위에 마우스를 올리면</strong> 더 자세한 해석 방법을 볼 수 있습니다
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="compareChartInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #f3e5f5 0%, #faf5fc 100%); border-radius: 10px; border-left: 4px solid #9c27b0;">
                                <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 8px;">
                                    💎 균형 분석 결과
                                </div>
                                <div id="compareChartInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div style="position: relative; height: 450px;">
                                <canvas id="channelCompareChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 채널 유형별 전략
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <!-- 완벽한 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            🌟 모든 막대가 고르게 높은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 완벽한 채널 (효율↑ + 규모↑)<br>
                                            <strong>전략:</strong> 최우선 투자 대상. 광고비를 적극 늘리세요
                                        </div>
                                    </div>

                                    <!-- 효율은 좋은데 규모가 작은 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            💎 CVR은 높은데 방문자가 적은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 숨겨진 보석 (효율↑ + 규모↓)<br>
                                            <strong>전략:</strong> 광고 예산을 늘려 방문자를 확대하세요
                                        </div>
                                    </div>

                                    <!-- 규모는 큰데 효율이 낮은 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            ⚠️ 방문자/매출은 높은데 CVR이 낮은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 개선 필요 채널 (효율↓ + 규모↑)<br>
                                            <strong>전략:</strong> 랜딩 페이지 개선으로 CVR을 높이면 매출 급증
                                        </div>
                                    </div>

                                    <!-- 모든 게 낮은 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #f44336;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f44336; margin-bottom: 6px;">
                                            ❌ 모든 막대가 낮은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 저성과 채널 (효율↓ + 규모↓)<br>
                                            <strong>전략:</strong> 일시 중단하고 예산을 상위 채널로 이동
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 팁 -->
                                <div style="margin-top: 12px; padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fffcf5 100%); border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 10px;">
                                        ✅ 이 차트로 바로 실행할 수 있는 것
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.8;">
                                        1. <strong>모든 막대가 높은 채널</strong>을 찾아 광고비를 30-50% 증액하세요<br>
                                        2. <strong>CVR만 높고 규모가 작은 채널</strong>은 타겟을 확대하여 방문자를 늘리세요<br>
                                        3. <strong>규모는 크지만 CVR이 낮은 채널</strong>은 랜딩 페이지 A/B 테스트를 시작하세요<br>
                                        4. <strong>모든 지표가 낮은 채널</strong>은 일시 중단하고 원인 분석을 먼저 하세요
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 4: TOP 10 전환율 차트 -->
                        <div class="channel-analysis-tab-content" id="top10Tab" style="display: none;">
                        <div class="chart-section card">
                            <div class="chart-header">🎯 각 단계별 전환율 TOP 10: 어떤 채널이 가장 효율적인가요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); margin-bottom: 16px; line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 차트는 무엇을 보여주나요?</strong><br>
                                각 고객 여정 단계별로 전환율이 높은 상위 10개 채널을 보여줍니다.<br>
                                <span style="color: var(--grey-600);">예시: "활동" 단계를 선택하면, 유입한 고객 중 실제로 활동까지 이어진 비율이 높은 채널 순위를 볼 수 있습니다.</span><br><br>
                                <strong style="color: var(--primary-main);">💡 전환율이란?</strong><br>
                                • <strong>활동 전환율</strong> = (활동 고객 ÷ 유입 고객) × 100<br>
                                • <strong>관심 전환율</strong> = (관심 고객 ÷ 유입 고객) × 100<br>
                                • <strong>결제진행 전환율</strong> = (결제진행 ÷ 유입 고객) × 100<br>
                                • <strong>구매완료 전환율(CVR)</strong> = (구매 고객 ÷ 유입 고객) × 100 ← 가장 중요!<br><br>
                                <strong>높을수록</strong> 효율적인 채널입니다 (적은 방문자로도 많은 전환 달성)
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 전환율 기준:</span>
                                <button class="view-btn channel-funnel-btn" data-funnel="activation">활동</button>
                                <button class="view-btn channel-funnel-btn" data-funnel="consideration">관심</button>
                                <button class="view-btn channel-funnel-btn" data-funnel="conversion">결제진행</button>
                                <button class="view-btn channel-funnel-btn active" data-funnel="purchase">구매완료</button>
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="top10ChartInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 10px; border-left: 4px solid #ff9800;">
                                <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 8px;">
                                    🏆 TOP 10 분석 결과
                                </div>
                                <div id="top10ChartInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    버튼을 클릭하여 단계를 선택하면 자동 분석 결과가 여기에 표시됩니다.
                                </div>
                            </div>

                            <div class="chart-container-small">
                                <canvas id="campaignChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 전환율 순위를 볼 때 주의할 점
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- 전환율 높지만 규모 작은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            ⚠️ 전환율은 높은데 방문자가 적다면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 효율은 우수하지만 규모가 작음<br>
                                            <strong>전략:</strong> 광고 예산을 늘려 방문자 확대 (큰 성과 기대)
                                        </div>
                                    </div>

                                    <!-- 전환율 낮지만 규모 큰 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            ⚠️ 전환율은 낮은데 매출이 높다면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 규모는 크지만 비효율적<br>
                                            <strong>전략:</strong> 랜딩 페이지 개선으로 CVR 상승 → 매출 폭발적 증가
                                        </div>
                                    </div>

                                    <!-- 초기 단계 전환율이 낮은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #f44336;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f44336; margin-bottom: 6px;">
                                            🚨 활동 전환율이 50% 이하라면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 첫 화면에서 절반 이상이 이탈<br>
                                            <strong>전략:</strong> 광고 메시지와 랜딩 페이지 일치 확인, 로딩 속도 개선
                                        </div>
                                    </div>

                                    <!-- 최종 전환율이 높은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            ✅ 구매완료 전환율이 3% 이상이라면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 매우 우수한 채널!<br>
                                            <strong>전략:</strong> 최우선 투자 대상. 광고비를 30-50% 증액하세요
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 팁 -->
                                <div style="padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fffcf5 100%); border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 10px;">
                                        ✅ 이 순위표로 바로 실행할 수 있는 것
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.8;">
                                        1. <strong>구매완료 TOP 3 채널</strong>의 공통점을 찾아 다른 채널에 적용하세요<br>
                                        2. <strong>활동 전환율이 높은 채널</strong>은 첫 화면이 효과적. 랜딩 페이지를 벤치마킹하세요<br>
                                        3. <strong>결제진행까지는 가지만 구매는 안 하는 채널</strong>은 결제 과정을 간소화하세요<br>
                                        4. <strong>전환율 1%  미만 채널</strong>은 일시 중단하고 원인 분석을 먼저 하세요<br>
                                        5. 각 단계별 탭을 클릭하며 어느 구간에서 이탈이 많은지 파악하세요
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- 6. 신규 vs 재방문 및 이탈 분석 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">👥</span>
                            <span>고객 재방문 및 이탈 분석</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 탭 버튼 -->
                        <div class="view-type-section" style="margin-bottom: 24px;">
                            <button class="view-btn customer-analysis-tab-btn active" data-tab="trend">신규 vs 재방문 추세</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="conversion">전환율 비교</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="churn">이탈률 분석</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="matrix">채널 품질 매트릭스</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="engagement">고객 참여도</button>
                        </div>

                        <!-- 탭 1: 통합 신규/재방문 고객 추세 차트 -->
                        <div class="customer-analysis-tab-content active" id="trendTab">
                        <!-- 데이터 기준 선택 -->
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding: 16px 0;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--grey-700);">📊 데이터 기준:</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="view-btn new-vs-returning-view-btn active" data-view="monthly">📆 월별</button>
                                <button class="view-btn new-vs-returning-view-btn" data-view="weekly">📆 주별</button>
                                <button class="view-btn new-vs-returning-view-btn" data-view="daily">📅 일별</button>
                            </div>
                        </div>
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📊 신규 vs 재방문 고객 추세 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 12px; padding: 0 24px;">
                                시간에 따른 신규 고객 비율과 재방문율의 변화를 추적합니다. 신규 고객 비율이 높으면 새로운 고객 유입이 활발한 것이고, 재방문율이 높으면 고객 충성도가 높다는 뜻입니다. <strong>차트 위에 마우스를 올리면</strong> 추가 인사이트를 확인할 수 있습니다.
                            </div>
                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="customerTrendChart"></canvas>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 2: 신규 vs 재방문 고객 전환율 비교 -->
                        <div class="customer-analysis-tab-content" id="conversionTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🔄 첫 방문 고객 vs 재방문 고객: 구매 전환율 차이 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px; padding: 0 24px; line-height: 1.7;">
                                <strong>이 차트는 무엇을 보여주나요?</strong><br>
                                처음 우리 사이트에 온 사람(신규)과 이미 왔던 적이 있는 사람(재방문)의 행동을 비교합니다.
                                각 단계별로 얼마나 많은 사람이 다음 단계로 넘어가는지 전환율(%)로 표시됩니다.
                                <strong>차트 위에 마우스를 올리면</strong> 더 자세한 분석과 개선 방법을 확인할 수 있습니다.
                            </div>

                            <!-- 주요 인사이트 요약 -->
                            <div id="conversionInsightSummary" style="margin: 0 24px 16px 24px; padding: 16px; background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); border-radius: 10px; border-left: 4px solid var(--primary-main);">
                                <div style="font-size: 13px; font-weight: 600; color: var(--primary-main); margin-bottom: 8px;">
                                    💡 핵심 인사이트
                                </div>
                                <div id="conversionInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="newVsReturningConversionChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 차트 해석 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 6px;">
                                            🆕 신규 고객 (주황색 막대)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            처음 방문한 고객들의 전환율입니다. 신규 고객은 우리 사이트를 처음 경험하기 때문에 일반적으로 전환율이 낮습니다.
                                            <strong>첫인상이 중요</strong>하므로 랜딩페이지와 첫 화면 최적화가 핵심입니다.
                                        </div>
                                    </div>
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ede7f6 0%, #f3f0ff 100%); border-radius: 8px; border-left: 3px solid #673ab7;">
                                        <div style="font-size: 13px; font-weight: 600; color: #673ab7; margin-bottom: 6px;">
                                            🔄 재방문 고객 (보라색 막대)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            이미 방문한 적이 있는 고객들의 전환율입니다. 재방문 고객은 우리 브랜드를 알고 있어 <strong>신뢰도가 높고 구매 가능성이 큽니다</strong>.
                                            이메일 마케팅이나 리타겟팅으로 재방문을 유도하세요.
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 가능한 팁 -->
                                <div style="margin-top: 12px; padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid var(--success-main);">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--success-main); margin-bottom: 6px;">
                                        ✅ 실행 가능한 개선 방법
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>신규 고객 전환율이 낮다면:</strong>
                                        첫 화면 로딩 속도 개선, 명확한 가치 제안 표시, 신뢰 요소 강화(리뷰, 보안 인증 등), 회원가입 없이 둘러보기 가능하게<br>
                                        <strong>재방문 고객 전환율이 낮다면:</strong>
                                        개인화된 추천 시스템 도입, 재방문 쿠폰 제공, 이메일로 신상품 알림, 로그인 시 이전 장바구니 자동 복원<br>
                                        <strong>두 그룹 모두 낮다면:</strong>
                                        전체적인 사용자 경험(UX) 점검 필요, 가격 경쟁력 확인, 결제 옵션 다양화
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 3: 이탈률 차트 -->
                        <div class="customer-analysis-tab-content" id="churnTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📉 채널별 고객 이탈 분석: 어느 단계에서 가장 많이 떠나나요?</div>

                            <!-- 설명 -->
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px; padding: 0 24px; line-height: 1.7;">
                                <strong>이탈률이란?</strong><br>
                                각 퍼널 단계에서 다음 단계로 넘어가지 못하고 떠나는 고객의 비율입니다.
                                예를 들어, "유입→활동" 이탈률 80%는 방문자 100명 중 80명이 아무 행동도 하지 않고 떠났다는 뜻입니다.
                                <strong>이탈률이 높은 단계를 찾아 집중 개선</strong>하면 전체 전환율을 크게 향상시킬 수 있습니다.
                                <strong>차트 위에 마우스를 올리면</strong> 더 자세한 분석을 확인할 수 있습니다.
                            </div>

                            <!-- 이탈률 자동 인사이트 -->
                            <div id="churnInsightSummary" style="margin: 0 24px 16px 24px; padding: 16px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 10px; border-left: 4px solid #ff5722;">
                                <div style="font-size: 13px; font-weight: 600; color: #ff5722; margin-bottom: 8px;">
                                    ⚠️ 이탈률 분석 결과
                                </div>
                                <div id="churnInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <!-- 필터 버튼 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 퍼널 단계:</span>
                                <button class="view-btn channel-churn-stage-btn" data-stage="activation">유입→활동</button>
                                <button class="view-btn channel-churn-stage-btn" data-stage="consideration">활동→관심</button>
                                <button class="view-btn channel-churn-stage-btn" data-stage="conversion">관심→결제진행</button>
                                <button class="view-btn channel-churn-stage-btn" data-stage="purchase">결제진행→구매완료</button>
                                <button class="view-btn channel-churn-stage-btn active" data-stage="avg">평균 이탈률</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">🔢 정렬:</span>
                                <button class="view-btn channel-churn-sort-btn active" data-sort="desc">📉 높은순</button>
                                <button class="view-btn channel-churn-sort-btn" data-sort="asc">📈 낮은순</button>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="channelChurnChart"></canvas>
                            </div>

                            <!-- 이탈률 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 단계별 이탈 원인과 개선 방법
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- 유입→활동 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            🚪 유입→활동 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 랜딩 페이지가 느리거나, 광고 내용과 실제 페이지가 다르거나, 첫 화면이 복잡함<br>
                                            <strong>해결:</strong> 로딩 속도 개선(3초 이내), 광고와 랜딩 페이지 메시지 일치, 명확한 헤드라인 배치
                                        </div>
                                    </div>

                                    <!-- 활동→관심 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 6px;">
                                            👀 활동→관심 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 제품/서비스 정보 부족, 신뢰 요소 부족, 가격 정보 숨김<br>
                                            <strong>해결:</strong> 상세한 제품 설명, 고객 후기/리뷰 강조, 가격 투명하게 공개, 비교표 제공
                                        </div>
                                    </div>

                                    <!-- 관심→결제진행 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%); border-radius: 8px; border-left: 3px solid #9c27b0;">
                                        <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 6px;">
                                            🛒 관심→결제진행 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 가격이 예상보다 높음, 배송비 추가 비용 발견, 회원가입 강요<br>
                                            <strong>해결:</strong> 첫 구매 할인 제공, 무료 배송 임계값 낮추기, 게스트 체크아웃 허용
                                        </div>
                                    </div>

                                    <!-- 결제진행→구매완료 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #ff5722;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff5722; margin-bottom: 6px;">
                                            💳 결제진행→구매완료 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 결제 과정 복잡, 보안 불안, 결제 수단 부족, 시스템 오류<br>
                                            <strong>해결:</strong> 간편 결제 도입(카카오페이, 네이버페이), SSL 인증 표시, 다양한 결제 옵션, 장바구니 복원 이메일
                                        </div>
                                    </div>
                                </div>

                                <!-- 이탈률 벤치마크 -->
                                <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #00c853; margin-bottom: 12px;">
                                    <div style="font-size: 13px; font-weight: 600; color: #00c853; margin-bottom: 6px;">
                                        📊 업계 평균 이탈률 벤치마크
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>유입→활동:</strong> 평균 40-60% (낮을수록 좋음)<br>
                                        <strong>활동→관심:</strong> 평균 50-70%<br>
                                        <strong>관심→결제진행:</strong> 평균 60-80%<br>
                                        <strong>결제진행→구매완료:</strong> 평균 20-40% (이 단계는 특히 낮아야 함)<br><br>
                                        <strong>💡 팁:</strong> 업계 평균보다 10%p 이상 높다면 즉시 개선이 필요합니다.
                                    </div>
                                </div>

                                <!-- 실행 체크리스트 -->
                                <div style="padding: 14px; background: var(--primary-light); border-radius: 8px; border-left: 3px solid var(--primary-main);">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--primary-main); margin-bottom: 8px;">
                                        ✅ 이탈률 개선 우선순위 체크리스트
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>1단계:</strong> 차트에서 <strong>이탈률이 가장 높은 단계</strong>를 찾기 (예: 유입→활동 80%)<br>
                                        <strong>2단계:</strong> 해당 단계에서 <strong>이탈률이 가장 높은 채널 TOP 3</strong> 확인<br>
                                        <strong>3단계:</strong> 위 가이드에서 해당 단계의 <strong>원인과 해결책</strong> 확인<br>
                                        <strong>4단계:</strong> 가장 이탈률이 높은 1-2개 채널에 대해 <strong>즉시 개선 작업 시작</strong><br>
                                        <strong>5단계:</strong> 2주 후 다시 측정하여 이탈률이 10%p 이상 감소했는지 확인<br><br>
                                        <strong>⚡ 빠른 개선 팁:</strong> 한 번에 모든 채널을 고치려 하지 마세요. 이탈률이 가장 높은 1-2개 채널에만 집중하면 전체 전환율이 극적으로 개선됩니다.
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 4: 채널별 재방문율 vs 이탈률 매트릭스 -->
                        <div class="customer-analysis-tab-content" id="matrixTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🎯 채널 품질 매트릭스: 재방문율 vs 이탈률</div>
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 12px; padding: 0 24px;">
                                채널을 재방문율(Y축)과 이탈률(X축)로 분류합니다. 평균 기준선을 중심으로 4개 분면으로 자동 구분되며, 각 채널 유형에 맞는 액션 플랜을 아래에서 확인하세요.
                            </div>
                            <div style="position: relative; height: 450px;">
                                <canvas id="channelMatrixChart"></canvas>
                            </div>

                            <!-- 채널 유형별 액션 가이드 -->
                            <div style="margin-top: 24px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 16px;">
                                    📋 채널 유형별 액션 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <!-- 스타 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 10px; border-left: 4px solid #00c853;">
                                        <div style="font-size: 14px; font-weight: 700; color: #00c853; margin-bottom: 8px;">
                                            ⭐ 스타 채널 (낮은 이탈 + 높은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 투자 확대 및 현재 전략 유지<br>
                                            <strong>✨ 기대 효과:</strong> 안정적인 매출 증대, ROI 극대화<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>마케팅 예산을 20-30% 증액</li>
                                                <li>유사한 타겟 오디언스로 확장</li>
                                                <li>성공 요인 분석 후 다른 채널에 적용</li>
                                                <li>고객 추천 프로그램 운영</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 성장 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                        <div style="font-size: 14px; font-weight: 700; color: #2196f3; margin-bottom: 8px;">
                                            📈 성장 채널 (높은 이탈 + 높은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 이탈률 개선에 집중<br>
                                            <strong>✨ 기대 효과:</strong> 전환율 상승, 신규 고객 확보<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>랜딩 페이지 개선 (로딩 속도, 디자인)</li>
                                                <li>첫 방문 고객 경험 최적화</li>
                                                <li>명확한 CTA(행동 유도) 버튼 배치</li>
                                                <li>신뢰 요소 강화 (리뷰, 보안 인증)</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 안정 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%); border-radius: 10px; border-left: 4px solid #9e9e9e;">
                                        <div style="font-size: 14px; font-weight: 700; color: #757575; margin-bottom: 8px;">
                                            🔒 안정 채널 (낮은 이탈 + 낮은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 재방문 유도 전략 구축<br>
                                            <strong>✨ 기대 효과:</strong> 고객 생애가치(LTV) 증가<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>리타겟팅 광고 캠페인 운영</li>
                                                <li>이메일/SMS 마케팅 자동화</li>
                                                <li>쿠폰/할인 프로모션 제공</li>
                                                <li>회원 등급제 및 포인트 적립 도입</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 문제 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 10px; border-left: 4px solid #ff5722;">
                                        <div style="font-size: 14px; font-weight: 700; color: #ff5722; margin-bottom: 8px;">
                                            ⚠️ 문제 채널 (높은 이탈 + 낮은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 전면 재검토 또는 중단<br>
                                            <strong>✨ 기대 효과:</strong> 비용 절감, 효율적 자원 배분<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>타겟 오디언스 재설정</li>
                                                <li>광고 크리에이티브 전면 교체</li>
                                                <li>예산 축소 또는 일시 중단</li>
                                                <li>A/B 테스트로 개선 가능성 검증</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- 추가 팁 -->
                                <div style="margin-top: 16px; padding: 12px 16px; background: var(--primary-light); border-radius: 8px; border-left: 4px solid var(--primary-main);">
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        <strong>💡 프로 팁:</strong> 모든 채널을 한 번에 변경하지 마세요. 한 번에 1-2개 채널에 집중하여 개선하고, 2-4주 후 결과를 측정한 뒤 다음 채널로 넘어가는 것이 효과적입니다.
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 5: 채널별 참여도 분석 -->
                        <div class="customer-analysis-tab-content" id="engagementTab" style="display: none;">
                        <div class="chart-section card">
                            <div class="chart-header">💎 채널별 고객 참여도: 어떤 채널이 진짜 관심 있는 고객을 데려오나요?</div>

                            <!-- 설명 -->
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px; padding: 0 24px; line-height: 1.7;">
                                <strong>참여도(Engagement Rate)란?</strong><br>
                                방문자 중 실제로 웹사이트를 적극적으로 사용한 비율입니다. 단순 클릭 실수나 즉시 이탈한 방문이 아니라,
                                <strong>페이지를 여러 개 보거나 일정 시간 이상 머문 "진짜 관심 있는" 고객의 비율</strong>입니다.
                                <strong>차트 위에 마우스를 올리면</strong> 더 자세한 분석을 확인할 수 있습니다.
                            </div>

                            <!-- 참여도 자동 인사이트 -->
                            <div id="engagementInsightSummary" style="margin: 0 24px 16px 24px; padding: 16px; background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%); border-radius: 10px; border-left: 4px solid #9c27b0;">
                                <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 8px;">
                                    💡 참여도 분석 결과
                                </div>
                                <div id="engagementInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="channelEngagementChart"></canvas>
                            </div>

                            <!-- 참여도 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 참여도 수치 해석 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- 높은 참여도 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #00c853;">
                                        <div style="font-size: 13px; font-weight: 600; color: #00c853; margin-bottom: 6px;">
                                            🌟 높음 (60% 이상)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 매우 질 좋은 트래픽. 관심도 높은 고객을 데려오고 있습니다.<br>
                                            <strong>행동:</strong> 이 채널에 예산을 더 투자하세요. 성공 요인을 분석하여 다른 채널에도 적용하세요.
                                        </div>
                                    </div>

                                    <!-- 중간 참여도 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 6px;">
                                            ⚖️ 보통 (40-60%)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 평균적인 트래픽. 개선 여지가 있습니다.<br>
                                            <strong>행동:</strong> 랜딩 페이지를 최적화하거나 타겟팅을 조정하세요. A/B 테스트로 참여도 향상을 시도하세요.
                                        </div>
                                    </div>

                                    <!-- 낮은 참여도 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #ff5722;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff5722; margin-bottom: 6px;">
                                            ⚠️ 낮음 (40% 미만)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 품질이 낮은 트래픽. 잘못된 고객층이 유입되고 있을 수 있습니다.<br>
                                            <strong>행동:</strong> 광고 타겟팅을 재검토하거나 예산을 줄이세요. 광고 메시지와 랜딩 페이지의 일치 여부를 확인하세요.
                                        </div>
                                    </div>
                                </div>

                                <!-- 추가 팁 -->
                                <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                        💡 참여도와 전환율의 관계
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>핵심:</strong> 참여도가 높으면 전환율도 높아집니다. 참여도가 낮은 채널은 방문자 수가 많아도 실제 매출은 적을 수 있습니다.
                                        따라서 단순히 클릭 수만 보지 말고, <strong>참여도와 전환율을 함께 고려</strong>하여 예산을 배분하세요.<br><br>
                                        <strong>예시:</strong> A채널은 방문자 1,000명에 참여도 30%, B채널은 방문자 500명에 참여도 70%라면,
                                        실제로 B채널이 더 많은 매출을 가져올 가능성이 큽니다.
                                    </div>
                                </div>

                                <!-- 실행 체크리스트 -->
                                <div style="margin-top: 12px; padding: 14px; background: var(--primary-light); border-radius: 8px; border-left: 3px solid var(--primary-main);">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--primary-main); margin-bottom: 8px;">
                                        ✅ 지금 바로 실행할 체크리스트
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        1. <strong>참여도 상위 3개 채널</strong>의 공통점을 찾아 다른 채널에 적용<br>
                                        2. <strong>참여도 하위 3개 채널</strong>의 광고 타겟팅 또는 랜딩 페이지 점검<br>
                                        3. 참여도가 높지만 전환율이 낮은 채널이 있다면 <strong>결제 프로세스나 가격 정책</strong> 개선<br>
                                        4. 참여도가 낮은 채널은 예산을 줄이고, 참여도가 높은 채널에 재투자
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- 전역 툴팁 (모든 차트에서 사용) -->
    <div id="kpiChartTooltip" class="chart-insight-tooltip"></div>
    <div id="compareChartTooltip" class="chart-insight-tooltip"></div>
    <div id="customerTrendTooltip" class="chart-insight-tooltip"></div>
    <div id="churnChartTooltip" class="chart-insight-tooltip"></div>

    <script>
        // 전역 변수
        let dailyData = [];
        let weeklyData = [];
        let channelData = [];
        let newVsReturningData = [];
        let channelEngagementData = [];
        let newVsReturningConversionData = [];
        let insightsData = null;
        let currentPeriod = 'full';  // 데이터 기반 의사결정 도구 기간 필터
        let insightPeriod = 'full'; // 인사이트 & 채널 전략 기간 필터 (독립)
        let currentView = 'daily';

        // 현재 선택된 기간의 데이터 반환 (데이터 기반 의사결정 도구용)
        function getPeriodData() {
            if (!insightsData || !insightsData.by_period) {
                return insightsData;  // 이전 구조 호환
            }
            return insightsData.by_period[currentPeriod] || insightsData.by_period['full'];
        }

        // 인사이트 & 채널 전략 섹션용 기간 데이터 반환
        function getInsightPeriodData() {
            if (!insightsData || !insightsData.by_period) {
                return insightsData;  // 이전 구조 호환
            }
            return insightsData.by_period[insightPeriod] || insightsData.by_period['full'];
        }

        // 이탈 분석 데이터 (전체 기간만 사용)
        function getChurnData() {
            if (!insightsData) return null;
            return insightsData.churn_analysis || {
                churn_predictions_7d: [],
                churn_predictions_30d: [],
                improvement_predictions_7d: [],
                improvement_predictions_30d: [],
                crm_actions: []
            };
        }
        let newVsReturningView = 'monthly';
        let selectedChannelKPI = 'cvr';
        let currentKpiType = 'cvr';
        let currentChurnType = 'churn_total';
        let currentChurnStage = 'avg';
        let currentChurnSort = 'desc';
        let currentChannelFunnel = 'purchase';

        // 테이블 정렬 상태
        let channelTableSort = {
            column: '유입',
            direction: 'desc'  // 'asc' 또는 'desc'
        };

        // Chart.js 인스턴스 (D3 퍼널은 재생성 방식 사용)
        let channelKpiChart = null;
        let channelChurnChart = null;
        let channelCompareChart = null;
        let campaignChart = null;
        let newVsReturningChart = null;
        let returnRateTrendChart = null;
        let customerTrendChart = null; // 통합 신규/재방문 추세 차트
        let newVsReturningConversionChart = null;
        let channelMatrixChart = null;
        let channelEngagementChart = null;

        // 숫자 포맷
        function formatNumber(num) {
            if (num === 0 || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        }

        // 소수점 포맷
        function formatDecimal(num) {
            if (num === 0 || num === null || num === undefined || !isFinite(num)) return '0';
            return num.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }

        // CSV 파싱 (RFC 4180 호환)
        function parseCSV(text, filename = 'unknown') {
            console.log(`=== parseCSV 시작: ${filename} ===`);

            // BOM (Byte Order Mark) 제거
            const originalFirstChar = text.charCodeAt(0);
            text = text.replace(/^\uFEFF/, '');

            if (originalFirstChar === 0xFEFF) {
                console.log('BOM 문자 제거됨');
            }

            const lines = text.trim().split('\n');
            console.log(`총 라인 수: ${lines.length}`);

            // RFC 4180 호환 CSV 파싱
            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // 연속된 따옴표는 이스케이프된 따옴표
                            current += '"';
                            i++; // 다음 따옴표 건너뛰기
                        } else {
                            // 따옴표 시작/종료
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 따옴표 밖의 쉼표는 구분자
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                // 마지막 필드 추가
                result.push(current);
                return result;
            }

            const headers = parseLine(lines[0]);
            console.log('원본 헤더:', headers);

            const cleanHeaders = headers.map(h => h.replace(/^\uFEFF/, '').trim());
            console.log('정리된 헤더:', cleanHeaders);

            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseLine(lines[i]);
                if (values.length === cleanHeaders.length) {
                    const row = {};
                    cleanHeaders.forEach((header, index) => {
                        row[header] = values[index].trim();
                    });
                    data.push(row);
                }
            }

            console.log(`파싱된 데이터 행 수: ${data.length}`);
            if (data.length > 0) {
                console.log('첫 번째 행 데이터:', data[0]);

                const allKeys = Object.keys(data[0]);
                console.log('첫 번째 행의 모든 키 (' + allKeys.length + '개):', allKeys);

                // 각 키를 개별적으로 출력하여 정확한 필드명 확인
                console.log('=== 필드명 상세 분석 ===');
                allKeys.forEach((key, index) => {
                    console.log(`  [${index}] "${key}" (길이: ${key.length}, 값 샘플: "${data[0][key]}")`);
                });

                // 날짜 필드 확인
                const dateFields = ['Day', 'week', 'date', 'Date', '일자'];
                const foundDateField = dateFields.find(field => data[0][field] !== undefined);
                if (foundDateField) {
                    console.log(`✓ 날짜 필드 발견: "${foundDateField}" = "${data[0][foundDateField]}"`);
                } else {
                    console.warn('❌ 날짜 필드를 찾을 수 없습니다!');
                    console.warn('찾으려고 시도한 필드명:', dateFields);
                    console.warn('실제 존재하는 필드명:', allKeys);

                    // 유사한 필드명 찾기
                    const similarFields = allKeys.filter(key =>
                        key.toLowerCase().includes('day') ||
                        key.toLowerCase().includes('week') ||
                        key.toLowerCase().includes('date') ||
                        key.includes('일자')
                    );
                    if (similarFields.length > 0) {
                        console.log('⚠️ 유사한 필드명 발견:', similarFields);
                    }
                }

                console.log('마지막 행 데이터:', data[data.length - 1]);
            } else {
                console.warn('파싱된 데이터가 없습니다!');
            }

            console.log(`=== parseCSV 완료: ${filename} ===\n`);
            return data;
        }

        // 데이터 로드
        async function loadData() {
            console.log('========================================');
            console.log('=== 데이터 로드 시작 ===');
            console.log('========================================\n');

            try {
                // 일별 데이터
                console.log('일별 데이터 로딩 중...');
                const dailyResponse = await fetch('funnel/daily_funnel.csv');
                const dailyText = await dailyResponse.text();
                dailyData = parseCSV(dailyText, 'daily_funnel.csv');
                console.log(`✓ 일별 데이터 로드 완료: ${dailyData.length}개 행\n`);

                // 주별 데이터
                console.log('주별 데이터 로딩 중...');
                const weeklyResponse = await fetch('funnel/weekly_funnel.csv');
                const weeklyText = await weeklyResponse.text();
                weeklyData = parseCSV(weeklyText, 'weekly_funnel.csv');
                console.log(`✓ 주별 데이터 로드 완료: ${weeklyData.length}개 행\n`);

                // 채널별 데이터
                const channelResponse = await fetch('funnel/channel_funnel.csv');
                const channelText = await channelResponse.text();
                channelData = parseCSV(channelText, 'channel_funnel.csv');

                // 신규 vs 재방문
                const newVsReturningResponse = await fetch('funnel/new_vs_returning.csv');
                const newVsReturningText = await newVsReturningResponse.text();
                newVsReturningData = parseCSV(newVsReturningText, 'new_vs_returning.csv');

                // 채널 참여도 데이터
                const channelEngagementResponse = await fetch('funnel/channel_engagement.csv');
                const channelEngagementText = await channelEngagementResponse.text();
                channelEngagementData = parseCSV(channelEngagementText, 'channel_engagement.csv');

                // 신규 vs 재방문 전환율 데이터
                const newVsReturningConversionResponse = await fetch('funnel/new_vs_returning_conversion.csv');
                const newVsReturningConversionText = await newVsReturningConversionResponse.text();
                newVsReturningConversionData = parseCSV(newVsReturningConversionText, 'new_vs_returning_conversion.csv');

                // 인사이트
                const insightsResponse = await fetch('funnel/insights.json');
                insightsData = await insightsResponse.json();

                console.log('========================================');
                console.log('=== 모든 데이터 로드 완료 ===');
                console.log(`일별 데이터: ${dailyData.length}개`);
                console.log(`주별 데이터: ${weeklyData.length}개`);
                console.log(`채널 참여도 데이터: ${channelEngagementData.length}개`);
                console.log(`신규 vs 재방문 전환율 데이터: ${newVsReturningConversionData.length}개`);
                console.log('========================================\n');

                updateDashboard();
            } catch (error) {
                console.error('❌ 데이터 로드 실패:', error);
            }
        }

        // 대시보드 업데이트
        function updateDashboard() {
            console.log('========================================');
            console.log('=== updateDashboard 호출 ===');
            console.log(`currentView 값: "${currentView}" (타입: ${typeof currentView})`);
            console.log(`dailyData: ${dailyData.length}개, weeklyData: ${weeklyData.length}개`);
            console.log('========================================\n');

            updateAnalysisPeriod();
            updateSummaryCardBanner();
            updateKPISummary();
            updateFunnelChart();
            updateInsights();
            updateUrgentAlerts();
            updateBCGMatrix();
            setupInsightStrategyTabs();
            updateAdvancedAnalysis();
            updateKpiChart('cvr');
            updateChurnChart();
            updateCompareChart();
            updateCampaignChart('purchase');
            updateCustomerTrendChart();
            updateNewVsReturningConversionChart();
            updateChannelMatrixChart();
            updateChannelEngagementChart();
            updateChannelTable();
            updatePeriodDateRange();
            updateInsightPeriodDateRange();
        }

        // 기간 전환 함수
        function switchPeriod(period) {
            currentPeriod = period;

            // 버튼 스타일 업데이트
            document.querySelectorAll('.period-filter-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                    btn.classList.remove('active');
                }
            });

            // 날짜 범위 표시 업데이트
            updatePeriodDateRange();

            // 기간 필터가 적용되는 탭만 다시 렌더링
            // (인사이트 & 채널 전략은 독립적인 기간 필터 사용)
            // (이탈 위험/성과 개선은 전체 기간 데이터만 사용하므로 제외)
            updateAdvancedAnalysis();
        }

        // 인사이트 & 채널 전략 섹션 전용 기간 전환 함수
        function switchInsightPeriod(period) {
            insightPeriod = period;

            // 버튼 스타일 업데이트
            document.querySelectorAll('.insight-period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#5e35b1';
                    btn.style.borderColor = '#d1c4e9';
                    btn.classList.remove('active');
                }
            });

            // 날짜 범위 표시 업데이트
            updateInsightPeriodDateRange();

            // 인사이트 & 채널 전략 섹션만 다시 렌더링
            updateInsights();
            updateUrgentAlerts();
            updateBCGMatrix();
        }

        // 인사이트 섹션 날짜 범위 표시
        function updateInsightPeriodDateRange() {
            const periodData = getInsightPeriodData();
            if (periodData && periodData.overall && periodData.overall.current_period) {
                const { start_date, end_date } = periodData.overall.current_period;
                const dateRangeEl = document.getElementById('insightPeriodDateRange');
                if (dateRangeEl) {
                    const start = new Date(start_date);
                    const end = new Date(end_date);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    dateRangeEl.textContent = `${start_date} ~ ${end_date} (${diffDays}일)`;
                }
            }
        }

        // 선택된 기간의 날짜 범위 표시
        function updatePeriodDateRange() {
            const periodData = getPeriodData();
            if (periodData && periodData.overall && periodData.overall.current_period) {
                const { start_date, end_date } = periodData.overall.current_period;
                const dateRangeEl = document.getElementById('periodDateRange');
                if (dateRangeEl) {
                    // 일수 계산
                    const start = new Date(start_date);
                    const end = new Date(end_date);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    dateRangeEl.textContent = `${start_date} ~ ${end_date} (${diffDays}일)`;
                }
            }
        }

        // 분석 기간 업데이트
        function updateAnalysisPeriod() {
            const periodData = getPeriodData();
            if (!periodData || !periodData.overall) return;

            const { start_date, end_date } = periodData.overall.current_period;
            document.getElementById('analysisPeriod').textContent = `(${start_date} ~ ${end_date})`;
        }

        // summary_card 배너 업데이트
        function updateSummaryCardBanner() {
            const periodData = getPeriodData();
            if (!periodData || !periodData.summary_card) return;

            const banner = document.getElementById('summaryCardBanner');
            const card = periodData.summary_card;

            document.getElementById('summaryCardTitle').textContent = card.title || '이번 달 성과 요약';
            document.getElementById('summaryCardMessage').textContent = card.status_message || '';
            document.getElementById('summaryCardVisitors').textContent = card.visitors_text || '-';
            document.getElementById('summaryCardPurchasers').textContent = card.purchasers_text || '-';
            document.getElementById('summaryCardCVR').textContent = card.cvr_text || '-';

            banner.style.display = 'block';
        }

        // urgent_alerts 섹션 업데이트
        let urgentAlertsData = { high: [], medium: [] };
        let urgentAlertsExpanded = { high: false, medium: false };

        function updateUrgentAlerts() {
            const periodData = getInsightPeriodData();
            const alerts = periodData?.urgent_alerts || [];

            // 심각도별로 그룹화
            urgentAlertsData.high = alerts.filter(a => a.severity === 'high');
            urgentAlertsData.medium = alerts.filter(a => a.severity === 'medium');

            // 탭 카운트 업데이트
            const totalCount = alerts.length;
            const urgentTotalEl = document.getElementById('urgentTotalCount');
            if (urgentTotalEl) {
                urgentTotalEl.textContent = totalCount > 0 ? `(${totalCount}건)` : '';
            }

            const highCountEl = document.getElementById('highAlertCount');
            const mediumCountEl = document.getElementById('mediumAlertCount');
            if (highCountEl) highCountEl.textContent = `(${urgentAlertsData.high.length}건)`;
            if (mediumCountEl) mediumCountEl.textContent = `(${urgentAlertsData.medium.length}건)`;

            // 카드 렌더링
            renderUrgentAlertCards('high');
            renderUrgentAlertCards('medium');

            // 서브탭 버튼 이벤트 등록
            document.querySelectorAll('.urgent-alert-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;

                    // 버튼 활성화 상태 변경
                    document.querySelectorAll('.urgent-alert-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    document.querySelectorAll('.urgent-alert-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(targetTab + 'AlertsTab').style.display = 'block';
                });
            });
        }

        function renderUrgentAlertCards(type) {
            const alerts = urgentAlertsData[type];
            const cardsContainer = document.getElementById(type + 'AlertsCards');
            const toggleContainer = document.getElementById(type + 'AlertsToggleContainer');
            const toggleBtn = document.getElementById(type + 'AlertsToggleBtn');
            const isExpanded = urgentAlertsExpanded[type];
            const displayCount = isExpanded ? alerts.length : 3;

            const bgColor = type === 'high' ? 'var(--error-light)' : 'var(--warning-light)';
            const borderColor = type === 'high' ? 'var(--error-main)' : 'var(--warning-main)';

            if (alerts.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--grey-500);">
                        ${type === 'high' ? '즉시 조치가 필요한 항목이 없습니다.' : '개선 권장 항목이 없습니다.'}
                    </div>
                `;
                toggleContainer.style.display = 'none';
                return;
            }

            cardsContainer.innerHTML = alerts.slice(0, displayCount).map(alert => `
                <div style="padding: 16px; background: ${bgColor}; border-radius: 8px; border-left: 4px solid ${borderColor};">
                    <div style="font-size: 15px; font-weight: 600; color: var(--grey-900); margin-bottom: 8px;">
                        ${alert.title}
                    </div>
                    <div style="font-size: 13px; color: var(--grey-700); margin-bottom: 8px;">
                        ${alert.message}
                    </div>
                    ${alert.reason ? `
                        <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 8px;">
                            <strong>원인:</strong> ${alert.reason}
                        </div>
                    ` : ''}
                    <div style="padding: 10px; background: white; border-radius: 6px; font-size: 13px; color: var(--grey-900);">
                        💡 <strong>추천 액션:</strong> ${alert.action}
                    </div>
                </div>
            `).join('');

            // 접기/펼치기 버튼 처리
            if (alerts.length > 3) {
                toggleContainer.style.display = 'block';
                const hiddenCount = alerts.length - 3;
                toggleBtn.textContent = isExpanded ? '접기' : `더 보기 (${hiddenCount}건)`;

                // 이벤트 리스너 재등록 (중복 방지를 위해 클론 후 교체)
                const newBtn = toggleBtn.cloneNode(true);
                toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);
                newBtn.addEventListener('click', function() {
                    urgentAlertsExpanded[type] = !urgentAlertsExpanded[type];
                    renderUrgentAlertCards(type);
                });
            } else {
                toggleContainer.style.display = 'none';
            }
        }

        // BCG Matrix 채널 전략 업데이트 (인사이트 섹션 전용 기간 필터 사용)
        function updateBCGMatrix() {
            const content = document.getElementById('bcgMatrixContent');
            if (!content) return;

            const periodData = getInsightPeriodData();
            if (!periodData || !periodData.channel_strategy || periodData.channel_strategy.status !== 'success') {
                content.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--grey-500);">채널 전략 데이터가 없습니다.</div>';
                return;
            }
            const strategy = periodData.channel_strategy;

            // 채널들을 BCG 유형별로 그룹화
            const quadrants = {
                cash_cow: { channels: [], color: '#4caf50', bgColor: '#e8f5e9', title: '👑 Cash Cow (효자 채널)', desc: '트래픽도 많고 전환율도 높음 - 투자 유지' },
                hidden_gem: { channels: [], color: '#2196f3', bgColor: '#e3f2fd', title: '💎 Hidden Gem (숨은 보석)', desc: '전환율은 높지만 트래픽이 적음 - 투자 확대' },
                money_pit: { channels: [], color: '#ff9800', bgColor: '#fff3e0', title: '💸 Money Pit (밑 빠진 독)', desc: '트래픽은 많지만 전환율이 낮음 - 최적화 필요' },
                dog: { channels: [], color: '#9e9e9e', bgColor: '#fafafa', title: '🤔 Dog (재검토 필요)', desc: '트래픽도 전환율도 낮음 - 전략 재고' }
            };

            // 채널 분류
            Object.entries(strategy.channels).forEach(([name, data]) => {
                const quadrant = data.bcg_matrix.quadrant;
                if (quadrants[quadrant]) {
                    quadrants[quadrant].channels.push({
                        name,
                        ...data.stats,
                        action: data.bcg_matrix.action
                    });
                }
            });

            // HTML 생성
            let html = '';
            Object.entries(quadrants).forEach(([key, q]) => {
                if (q.channels.length > 0) {
                    html += `
                        <div style="padding: 16px; background: ${q.bgColor}; border-radius: 12px; border-left: 4px solid ${q.color};">
                            <div style="font-size: 15px; font-weight: 700; color: var(--grey-900); margin-bottom: 4px;">
                                ${q.title}
                            </div>
                            <div style="font-size: 12px; color: var(--grey-600); margin-bottom: 12px;">
                                ${q.desc}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                                ${q.channels.map(ch => `
                                    <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border-radius: 6px; font-size: 13px; font-weight: 500; color: var(--grey-800);">
                                        ${ch.name}
                                        <span style="font-size: 11px; color: ${q.color};">(CVR ${ch.cvr}%)</span>
                                    </span>
                                `).join('')}
                            </div>
                            ${q.channels[0] ? `
                                <div style="font-size: 12px; color: var(--grey-700); padding: 10px; background: white; border-radius: 6px;">
                                    ${q.channels[0].action}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });

            content.innerHTML = html || '<div style="padding: 20px; text-align: center; color: var(--grey-500);">분류된 채널이 없습니다.</div>';
        }

        // 통합 인사이트 & 전략 탭 설정
        function setupInsightStrategyTabs() {
            const tabBtns = document.querySelectorAll('.insight-strategy-tab-btn');
            const tabContents = document.querySelectorAll('.insight-strategy-tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;

                    // 버튼 활성화 상태 변경
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });

                    // 해당 탭 표시
                    if (targetTab === 'summary') {
                        document.getElementById('summaryTabContent').style.display = 'block';
                    } else if (targetTab === 'urgent') {
                        document.getElementById('urgentTabContent').style.display = 'block';
                    } else if (targetTab === 'bcg') {
                        document.getElementById('bcgTabContent').style.display = 'block';
                    }
                });
            });
        }

        // KPI 요약 업데이트 (일별 데이터 사용)
        function updateKPISummary() {
            // 항상 daily 데이터 사용
            const data = dailyData;
            if (data.length === 0) return;

            // 각 퍼널 단계별 합계 계산
            const totalAcquisition = data.reduce((sum, row) => sum + (parseFloat(row['유입']) || 0), 0);
            const totalActivation = data.reduce((sum, row) => sum + (parseFloat(row['활동']) || 0), 0);
            const totalConsideration = data.reduce((sum, row) => sum + (parseFloat(row['관심']) || 0), 0);
            const totalConversion = data.reduce((sum, row) => sum + (parseFloat(row['결제진행']) || 0), 0);
            const totalPurchase = data.reduce((sum, row) => sum + (parseFloat(row['구매완료']) || 0), 0);

            const kpis = [
                { label: '총 유입', value: formatNumber(Math.round(totalAcquisition)), unit: '명', color: '#673ab7' },
                { label: '총 활성화', value: formatNumber(Math.round(totalActivation)), unit: '명', color: '#2196f3' },
                { label: '관심', value: formatNumber(Math.round(totalConsideration)), unit: '명', color: '#ff9800' },
                { label: '결제 진행', value: formatNumber(Math.round(totalConversion)), unit: '명', color: '#4caf50' },
                { label: '구매 완료', value: formatNumber(Math.round(totalPurchase)), unit: '명', color: '#00c853' }
            ];

            document.getElementById('kpiSummaryGrid').innerHTML = kpis.map(kpi => `
                <div class="kpi-summary-card card">
                    <div class="kpi-summary-label">${kpi.label} (일별 합계)</div>
                    <div class="kpi-summary-value">${kpi.value}</div>
                    <div class="kpi-summary-unit">${kpi.unit}</div>
                </div>
            `).join('');
        }

        // 인사이트 업데이트 (인사이트 섹션 전용 기간 필터 사용)
        function updateInsights() {
            const periodData = getInsightPeriodData();
            if (!periodData) return;

            const insights = [];

            // 전체 CVR
            insights.push(`
                <div class="insight-card positive">
                    <div class="insight-title">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                        전체 전환율
                    </div>
                    <div class="insight-text">
                        전체 CVR: <strong>${formatDecimal(periodData.summary?.overall_cvr || 0)}%</strong><br>
                        총 매출: <strong>${formatNumber(periodData.summary?.total_revenue || 0)}원</strong>
                    </div>
                </div>
            `);

            // 상위 채널
            if (periodData.top_channels && periodData.top_channels.length > 0) {
                const topChannel = periodData.top_channels[0];
                insights.push(`
                    <div class="insight-card positive">
                        <div class="insight-title">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                            최고 성과 채널
                        </div>
                        <div class="insight-text">
                            <strong>${topChannel.name}</strong><br>
                            구매: ${formatNumber(topChannel.purchases)}건<br>
                            매출: ${formatNumber(topChannel.revenue)}원
                        </div>
                    </div>
                `);
            }

            // 경고
            if (periodData.alerts && periodData.alerts.length > 0) {
                periodData.alerts.forEach(alert => {
                    const severityClass = alert.severity === 'high' ? 'negative' : 'neutral';
                    insights.push(`
                        <div class="insight-card ${severityClass}">
                            <div class="insight-title">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                                ${alert.type === 'low_activation' ? '활성화율 경고' : '전환율 경고'}
                            </div>
                            <div class="insight-text">${alert.message}</div>
                        </div>
                    `);
                });
            }

            document.getElementById('insightContent').innerHTML = insights.join('');
        }

        // D3.js 인터랙티브 퍼널 차트
        function updateFunnelChart() {
            console.log('=== updateFunnelChart 시작 ===');

            // 항상 daily 데이터 사용
            const data = dailyData;
            console.log(`일별 데이터: ${data.length}개 행`);

            if (data.length === 0) {
                console.warn('데이터가 없습니다.');
                // document.getElementById('singleFunnelDateRange').textContent = '데이터를 불러오는 중...';
                return;
            }

            // 날짜 범위 표시 (Date 객체 기반 정렬)
            const dateStrings = data
                .map(row => row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'])
                .filter(d => d);

            console.log(`추출된 날짜: ${dateStrings.length}개`);

            if (dateStrings.length > 0) {
                // Date 객체로 변환하여 정렬
                const sortedDates = dateStrings
                    .map(dateStr => new Date(dateStr))
                    .filter(date => !isNaN(date.getTime()))
                    .sort((a, b) => a - b)
                    .map(date => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    });

                const startDate = sortedDates[0];
                const endDate = sortedDates[sortedDates.length - 1];

                console.log(`날짜 범위: ${startDate} ~ ${endDate}`);
                // document.getElementById('singleFunnelDateRange').textContent = `${startDate} ~ ${endDate}`;
            } else {
                console.warn('날짜 필드를 찾을 수 없습니다.');
                // document.getElementById('singleFunnelDateRange').textContent = '';
            }

            // 각 퍼널 단계별 총합 계산
            const baseColor = '#535A8C'; // Deep purple color
            const funnelStages = [
                { name: '유입 (Acquisition)', key: '유입', color: baseColor, description: 'Acquisition' },
                { name: '활동 (Activation)', key: '활동', color: baseColor, description: 'Activation' },
                { name: '관심 (Consideration)', key: '관심', color: baseColor, description: 'Consideration' },
                { name: '결제진행 (Conversion)', key: '결제진행', color: baseColor, description: 'Conversion' },
                { name: '구매완료 (Purchase)', key: '구매완료', color: baseColor, description: 'Purchase' }
            ];

            const funnelData = funnelStages.map((stage, index) => {
                const total = data.reduce((sum, row) => sum + (parseFloat(row[stage.key]) || 0), 0);
                const prevTotal = index > 0 ? data.reduce((sum, row) => sum + (parseFloat(row[funnelStages[index - 1].key]) || 0), 0) : total;
                const conversionRate = prevTotal > 0 ? (total / prevTotal * 100) : 100;
                const dropOffRate = prevTotal > 0 ? ((prevTotal - total) / prevTotal * 100) : 0;

                return {
                    ...stage,
                    total: Math.round(total),
                    conversionRate: conversionRate.toFixed(1),
                    dropOffRate: dropOffRate.toFixed(1),
                    index: index
                };
            });

            // SVG 초기화
            const container = document.getElementById('d3FunnelChart');
            container.innerHTML = '';

            const margin = { top: 20, right: 40, bottom: 20, left: 40 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 550 - margin.top - margin.bottom;

            const svg = d3.select('#d3FunnelChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // 툴팁 생성 (body에 직접 추가하여 overflow 문제 해결)
            let tooltip = d3.select('body').select('.funnel-tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body')
                    .append('div')
                    .attr('class', 'funnel-tooltip');
            }

            // 최대값 기준으로 스케일 계산
            const maxValue = d3.max(funnelData, d => d.total);
            const stageHeight = height / funnelData.length;
            const spacing = 10;

            // 각 단계 그리기
            funnelData.forEach((stage, i) => {
                // 각 단계마다 점진적으로 어두워지는 색상 계산
                const stageColor = d3.color(stage.color).darker(i * 0.25);

                const yPos = i * stageHeight;
                const topWidth = (stage.total / maxValue) * width;
                const bottomWidth = i < funnelData.length - 1
                    ? (funnelData[i + 1].total / maxValue) * width
                    : topWidth * 0.8;

                const xOffset = (width - topWidth) / 2;
                const xOffsetBottom = (width - bottomWidth) / 2;

                // 단계 사이 화살표 추가 (첫 단계 제외)
                if (i > 0) {
                    const prevBottomWidth = funnelData[i - 1].total > 0
                        ? (funnelData[i - 1].total / maxValue) * width
                        : topWidth;
                    const prevXOffsetBottom = (width - prevBottomWidth) / 2;

                    // 화살표 그룹
                    const arrowGroup = svg.append('g')
                        .attr('opacity', 0.4);

                    // 화살표 라인
                    arrowGroup.append('line')
                        .attr('x1', width / 2)
                        .attr('y1', yPos - spacing / 2 - 15)
                        .attr('x2', width / 2)
                        .attr('y2', yPos - spacing / 2)
                        .attr('stroke', stageColor)
                        .attr('stroke-width', 3)
                        .attr('stroke-dasharray', '5,5');

                    // 화살표 헤드
                    arrowGroup.append('polygon')
                        .attr('points', `
                            ${width / 2},${yPos - spacing / 2}
                            ${width / 2 - 6},${yPos - spacing / 2 - 8}
                            ${width / 2 + 6},${yPos - spacing / 2 - 8}
                        `)
                        .attr('fill', stageColor);
                }

                // 퍼널 단계 (트라페즈이드)
                const group = svg.append('g')
                    .attr('class', 'funnel-stage')
                    .style('cursor', 'pointer');

                // 그라데이션 정의 (하위 depth로 갈수록 어두운 색상)
                const gradientId = `gradient-${i}`;
                const gradient = svg.append('defs')
                    .append('linearGradient')
                    .attr('id', gradientId)
                    .attr('x1', '0%')
                    .attr('y1', '0%')
                    .attr('x2', '0%')
                    .attr('y2', '100%');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 1);

                gradient.append('stop')
                    .attr('offset', '50%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 0.9);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 0.75);

                // 트라페즈이드 경로
                const path = `
                    M ${xOffset} ${yPos}
                    L ${xOffset + topWidth} ${yPos}
                    L ${xOffsetBottom + bottomWidth} ${yPos + stageHeight - spacing}
                    L ${xOffsetBottom} ${yPos + stageHeight - spacing}
                    Z
                `;

                group.append('path')
                    .attr('d', path)
                    .attr('fill', `url(#${gradientId})`)
                    .attr('stroke', stageColor)
                    .attr('stroke-width', 2)
                    .attr('opacity', 0.85);

                // 텍스트 배경 (가독성 향상)
                const textBg = group.append('rect')
                    .attr('x', width / 2 - 120)
                    .attr('y', yPos + stageHeight / 2 - 35)
                    .attr('width', 240)
                    .attr('height', i > 0 ? 65 : 45)
                    .attr('fill', 'rgba(255, 255, 255, 0.95)')
                    .attr('rx', 8)
                    .attr('stroke', stageColor)
                    .attr('stroke-width', 2)
                    .attr('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))');

                // 레이블
                group.append('text')
                    .attr('class', 'funnel-stage-label')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 - 15)
                    .attr('text-anchor', 'middle')
                    .style('fill', stageColor)
                    .text(stage.name);

                // 값 표시
                group.append('text')
                    .attr('class', 'funnel-stage-value')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 + 5)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'var(--grey-900)')
                    .style('font-weight', '700')
                    .text(stage.total.toLocaleString() + ' users');

                // 전환율 및 이탈률 표시 (첫 단계 제외)
                if (i > 0) {
                    const conversionText = group.append('text')
                        .attr('class', 'funnel-stage-conversion')
                        .attr('x', width / 2)
                        .attr('y', yPos + stageHeight / 2 + 22)
                        .attr('text-anchor', 'middle');

                    // 전환율 (기본 색상)
                    conversionText.append('tspan')
                        .style('fill', stageColor)
                        .style('font-weight', '600')
                        .text(`전환율: ${stage.conversionRate}%`);

                    // 구분자
                    conversionText.append('tspan')
                        .style('fill', 'var(--grey-600)')
                        .text(' | ');

                    // 이탈률 (빨간색)
                    conversionText.append('tspan')
                        .style('fill', '#EF4444')
                        .style('font-weight', '600')
                        .text(`이탈: ${stage.dropOffRate}%`);
                }

                // 인사이트 및 추천사항 데이터
                const insights = getStageInsights(stage, i);

                // 마우스 이벤트
                group.on('mouseover', function(event) {
                    d3.select(this)
                        .style('opacity', 1)
                        .style('filter', 'brightness(1.1)');

                    tooltip.html(`
                        <div class="funnel-tooltip-title">${stage.name}</div>
                        <div class="funnel-tooltip-metric">
                            <span class="funnel-tooltip-metric-label">총 사용자</span>
                            <span class="funnel-tooltip-metric-value">${stage.total.toLocaleString()}명</span>
                        </div>
                        ${i > 0 ? `
                        <div class="funnel-tooltip-metric">
                            <span class="funnel-tooltip-metric-label">전환율</span>
                            <span class="funnel-tooltip-metric-value" style="color: ${stageColor}; font-weight: 600;">${stage.conversionRate}%</span>
                        </div>
                        <div class="funnel-tooltip-metric">
                            <span class="funnel-tooltip-metric-label">이탈률</span>
                            <span class="funnel-tooltip-metric-value" style="color: #EF4444; font-weight: 600;">${stage.dropOffRate}%</span>
                        </div>
                        ` : ''}
                        <div class="funnel-tooltip-insight">${insights.insight}</div>
                        <div class="funnel-tooltip-recommendation">${insights.recommendation}</div>
                    `)
                    .classed('visible', true);

                    // 툴팁 위치 조정 (rect 박스 옆에 표시)
                    requestAnimationFrame(() => {
                        const tooltipNode = tooltip.node();
                        const tooltipRect = tooltipNode.getBoundingClientRect();
                        const padding = 15;

                        // rect 박스의 위치 계산
                        const rectX = width / 2 - 120; // rect의 x 좌표
                        const rectY = yPos + stageHeight / 2 - 35; // rect의 y 좌표
                        const rectWidth = 240;

                        // 컨테이너의 화면상 위치
                        const containerRect = container.getBoundingClientRect();

                        // rect 오른쪽 옆에 배치 시도
                        let left = containerRect.left + margin.left + rectX + rectWidth + padding;
                        let top = containerRect.top + margin.top + rectY;

                        // 오른쪽 경계를 넘으면 왼쪽에 배치
                        if (left + tooltipRect.width + padding > window.innerWidth) {
                            left = containerRect.left + margin.left + rectX - tooltipRect.width - padding;
                        }

                        // 왼쪽 경계도 넘으면 화면 안쪽으로 조정
                        if (left < padding) {
                            left = padding;
                        }

                        // 하단 경계를 넘으면 위로 조정
                        if (top + tooltipRect.height + padding > window.innerHeight) {
                            top = window.innerHeight - tooltipRect.height - padding;
                        }

                        // 상단 경계를 넘으면 아래로 조정
                        if (top < padding) {
                            top = padding;
                        }

                        tooltip
                            .style('left', left + 'px')
                            .style('top', top + 'px');
                    });
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .style('opacity', 0.85)
                        .style('filter', 'none');
                    tooltip.classed('visible', false);
                });
            });

            console.log('=== updateFunnelChart 완료 ===\n');
        }

        // 단계별 인사이트 및 추천사항 생성
        function getStageInsights(stage, index) {
            const insights = {
                0: {
                    insight: '사용자 유입의 시작 단계입니다. 모든 마케팅 채널의 트래픽이 집계됩니다.',
                    recommendation: '유료 광고, SEO, 소셜 미디어 등 다양한 채널의 유입 품질을 개선하세요.'
                },
                1: {
                    insight: '첫 방문자가 활성화되는 단계입니다. 이탈률이 높다면 랜딩페이지에 문제가 있을 수 있습니다.',
                    recommendation: parseFloat(stage.dropOffRate) > 50
                        ? '이탈률이 매우 높습니다. 랜딩페이지 속도, 디자인, CTA를 즉시 개선하세요.'
                        : '랜딩페이지 A/B 테스트를 통해 전환율을 지속적으로 개선하세요.'
                },
                2: {
                    insight: '사용자가 제품/서비스에 관심을 보이는 단계입니다.',
                    recommendation: parseFloat(stage.dropOffRate) > 40
                        ? '제품 페이지의 정보 품질과 이미지를 개선하고, 리뷰를 강화하세요.'
                        : '추천 시스템과 개인화를 통해 관심을 구매로 전환하세요.'
                },
                3: {
                    insight: '결제를 시작한 단계입니다. 여기서의 이탈은 큰 기회 손실입니다.',
                    recommendation: parseFloat(stage.dropOffRate) > 30
                        ? '결제 프로세스를 단순화하고, 배송비/결제 수단을 명확히 표시하세요.'
                        : '원클릭 결제, 게스트 체크아웃 등으로 마찰을 최소화하세요.'
                },
                4: {
                    insight: '최종 구매 완료 단계입니다. 이 사용자들을 재구매 고객으로 전환하는 것이 중요합니다.',
                    recommendation: '이메일 마케팅, 리타겟팅 광고, 로열티 프로그램으로 재구매를 유도하세요.'
                }
            };

            return insights[index] || { insight: '', recommendation: '' };
        }

        // 고급 분석 결과 업데이트 (데이터 기반 의사결정 도구용)
        function updateAdvancedAnalysis() {
            const periodData = getPeriodData();
            if (!periodData) return;

            // 1. 예산 투자 가이드 (투자 대비 기대 성과 분석)
            const abTestContainer = document.getElementById('abTestResults');

            // 채널 데이터가 있는 경우
            if (channelData && channelData.length > 0) {
                // 각 채널의 투자 효율성 계산
                const channelInvestmentScores = channelData.map(channel => {
                    const acquisition = parseFloat(channel['유입']) || 0;
                    const purchase = parseFloat(channel['구매완료']) || 0;
                    const revenue = parseFloat(channel['Revenue']) || 0;
                    const cvr = parseFloat(channel['CVR']) || 0;

                    // 신뢰도: 데이터 샘플 수 기반 (유입 수가 많을수록 높음)
                    let confidence = '낮음';
                    let confidenceScore = 0;
                    if (acquisition >= 100000) {
                        confidence = '매우 높음';
                        confidenceScore = 4;
                    } else if (acquisition >= 10000) {
                        confidence = '높음';
                        confidenceScore = 3;
                    } else if (acquisition >= 1000) {
                        confidence = '보통';
                        confidenceScore = 2;
                    } else if (acquisition >= 100) {
                        confidence = '낮음';
                        confidenceScore = 1;
                    }

                    // 평균 객단가 (ARPU)
                    const arpu = purchase > 0 ? revenue / purchase : 0;

                    // 채널 타입 분류 (광고 vs 오가닉)
                    const channelName = channel['channel'].toLowerCase();
                    let channelType = 'organic';
                    let estimatedCPA = 0; // 방문자 1명당 유입 비용

                    if (channelName.includes('광고') || channelName.includes('ad') || channelName.includes('paid')) {
                        channelType = 'paid';
                        estimatedCPA = 1500; // 유료 광고 평균 CPA (원/방문자)
                    } else if (channelName.includes('direct') || channelName === 'direct') {
                        channelType = 'direct';
                        estimatedCPA = 0; // Direct는 자연 유입, 투자 불가
                    } else if (channelName.includes('organic') || channelName.includes('쇼핑') || channelName.includes('블로그')) {
                        channelType = 'organic_optimizable';
                        estimatedCPA = 300; // 오가닉 최적화 비용 (SEO, 콘텐츠 등)
                    } else {
                        channelType = 'referral';
                        estimatedCPA = 500; // 레퍼럴/기타 채널
                    }

                    // 투자 효율성 점수 = CVR × ARPU × 신뢰도 가중치
                    const investmentScore = cvr * arpu * (1 + confidenceScore * 0.1);

                    // 100만원 투자 시 예상 성과 계산
                    let estimatedVisitors = 0;
                    let expectedPurchases = 0;
                    let expectedRevenue = 0;
                    let roi = -100;
                    let isInvestable = true;

                    if (channelType === 'direct') {
                        // Direct는 자연 유입이므로 광고 투자 불가
                        isInvestable = false;
                    } else if (estimatedCPA > 0) {
                        estimatedVisitors = 1000000 / estimatedCPA; // 100만원으로 확보 가능한 방문자 수
                        expectedPurchases = estimatedVisitors * (cvr / 100); // 예상 구매 건수
                        expectedRevenue = expectedPurchases * arpu; // 예상 매출액
                        roi = expectedRevenue > 0 ? ((expectedRevenue - 1000000) / 1000000 * 100) : -100;
                    }

                    return {
                        channel: channel['channel'],
                        cvr: cvr,
                        revenue: revenue,
                        purchase: purchase,
                        acquisition: acquisition,
                        arpu: arpu,
                        confidence: confidence,
                        confidenceScore: confidenceScore,
                        investmentScore: investmentScore,
                        channelType: channelType,
                        estimatedCPA: estimatedCPA,
                        isInvestable: isInvestable,
                        estimatedVisitors: estimatedVisitors,
                        expectedPurchases: expectedPurchases,
                        expectedRevenue: expectedRevenue,
                        roi: roi
                    };
                }).filter(item => item.acquisition > 0 && item.cvr > 0)
                  .sort((a, b) => b.roi - a.roi)
                  .slice(0, 8);

                if (channelInvestmentScores.length > 0) {
                    abTestContainer.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <p style="font-size: 14px; color: var(--grey-700); margin-bottom: 8px;">
                                <strong>${channelInvestmentScores.length}개</strong> 채널의 투자 효율성 분석 완료
                            </p>
                            <p style="font-size: 12px; color: var(--grey-600);">
                                💡 전환율, 평균 객단가, 데이터 신뢰도를 종합하여 투자 시 기대 성과가 높은 순으로 정렬했습니다.
                            </p>
                        </div>
                        <div id="investmentItemsContainer" style="display: grid; gap: 12px;">
                            ${channelInvestmentScores.map((channel, index) => {
                                const rankEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}위`;
                                const confidenceColor = channel.confidenceScore >= 3 ? 'var(--success-main)' :
                                                       channel.confidenceScore === 2 ? 'var(--warning-main)' : 'var(--grey-400)';
                                const bgColor = channel.confidenceScore >= 3 ? 'linear-gradient(135deg, var(--success-light) 0%, #f0fff4 100%)' :
                                               channel.confidenceScore === 2 ? 'linear-gradient(135deg, var(--warning-light) 0%, #fff9e6 100%)' : 'var(--grey-50)';
                                const borderColor = channel.confidenceScore >= 3 ? 'var(--success-main)' :
                                                   channel.confidenceScore === 2 ? 'var(--warning-main)' : 'var(--grey-300)';
                                const hiddenClass = index >= 3 ? ' hidden-row' : '';

                                return `
                                <div class="investment-item${hiddenClass}" style="padding: 16px; background: ${bgColor}; border-radius: 8px; border-left: 4px solid ${borderColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 16px; font-weight: 700; color: var(--grey-900); margin-bottom: 8px;">
                                                ${rankEmoji} ${channel.channel}
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                                                <div style="padding: 8px; background: white; border-radius: 6px;">
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 2px;">전환율</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--primary-main);">
                                                        ${formatDecimal(channel.cvr)}%
                                                    </div>
                                                </div>
                                                <div style="padding: 8px; background: white; border-radius: 6px;">
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 2px;">평균 객단가</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--success-main);">
                                                        ${formatNumber(Math.round(channel.arpu))}원
                                                    </div>
                                                </div>
                                                <div style="padding: 8px; background: white; border-radius: 6px;">
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 2px;">데이터 신뢰도</div>
                                                    <div style="font-size: 13px; font-weight: 700; color: ${confidenceColor};">
                                                        ${channel.confidence}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    ${channel.confidenceScore >= 2 ? (
                                        channel.isInvestable ? `
                                        <div style="padding: 14px; background: white; border-radius: 8px; border-left: 3px solid var(--primary-main); margin-bottom: 8px;">
                                            <div style="font-size: 13px; color: var(--grey-900); font-weight: 700; margin-bottom: 10px;">
                                                💰 100만원 투자 시 예상 성과
                                                <span style="font-size: 11px; font-weight: 500; color: var(--grey-600); margin-left: 8px;">
                                                    (예상 CPA: ${formatNumber(channel.estimatedCPA)}원/방문자)
                                                </span>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                                                <div>
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 유입</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--secondary-main);">
                                                        약 ${formatNumber(Math.round(channel.estimatedVisitors))}명
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 구매</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--primary-main);">
                                                        약 ${formatNumber(Math.round(channel.expectedPurchases))}건
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 매출</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--success-main);">
                                                        약 ${formatNumber(Math.round(channel.expectedRevenue))}원
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="padding: 10px; background: ${channel.roi > 100 ? '#e8f5e9' : channel.roi > 0 ? '#fff3e0' : '#ffebee'}; border-radius: 6px;">
                                                <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 ROI (투자수익률)</div>
                                                <div style="font-size: 22px; font-weight: 700; color: ${channel.roi > 0 ? 'var(--success-main)' : 'var(--error-main)'};">
                                                    ${channel.roi > 0 ? '+' : ''}${formatDecimal(channel.roi)}%
                                                    <span style="font-size: 12px; font-weight: 500; margin-left: 8px;">
                                                        (순이익: ${channel.roi > 0 ? '+' : ''}${formatNumber(Math.round(channel.expectedRevenue - 1000000))}원)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div style="padding: 14px; background: linear-gradient(135deg, #e8eaf6 0%, #f3f4f9 100%); border-radius: 6px;">
                                            <div style="font-size: 12px; color: var(--grey-800); line-height: 1.7;">
                                                💡 <strong>투자 전략:</strong><br>
                                                ${channel.channelType === 'paid' ?
                                                    (channel.roi > 200 ?
                                                        `이 광고 채널은 <strong style="color: var(--success-main);">매우 높은 수익률(+${formatDecimal(channel.roi)}%)</strong>을 보입니다. 100만원 투자 시 약 <strong>${formatNumber(Math.round(channel.expectedRevenue))}원</strong>의 매출이 예상되며, <strong>추가 예산 투입</strong>을 적극 권장합니다.` :
                                                    channel.roi > 100 ?
                                                        `이 광고 채널은 <strong style="color: var(--success-main);">양호한 수익률(+${formatDecimal(channel.roi)}%)</strong>을 보입니다. 100만원 투자로 약 ${formatNumber(Math.round(channel.estimatedVisitors))}명 유입, ${formatNumber(Math.round(channel.expectedPurchases))}건 구매가 예상됩니다. <strong>예산 증액 고려</strong>를 추천합니다.` :
                                                    channel.roi > 0 ?
                                                        `이 광고 채널은 수익성이 있으나(+${formatDecimal(channel.roi)}%), 다른 채널 대비 효율이 낮습니다. 광고 소재와 타겟팅을 개선하면 더 나은 성과를 기대할 수 있습니다.` :
                                                        `현재 이 광고 채널은 손실(${formatDecimal(channel.roi)}%)이 예상됩니다. <strong>캠페인 최적화 또는 예산 재분배</strong>가 필요합니다.`) :
                                                channel.channelType === 'organic_optimizable' ?
                                                    (channel.roi > 200 ?
                                                        `SEO/콘텐츠 최적화에 <strong>100만원 투자 시 약 ${formatNumber(Math.round(channel.estimatedVisitors))}명의 추가 유입</strong>과 <strong>${formatNumber(Math.round(channel.expectedRevenue))}원의 매출</strong>이 예상됩니다. 전환율이 ${formatDecimal(channel.cvr)}%로 높아 <strong style="color: var(--success-main);">매우 효율적인 투자처</strong>입니다.` :
                                                    channel.roi > 0 ?
                                                        `이 채널은 오가닉 트래픽 최적화를 통해 수익을 창출할 수 있습니다. SEO, 블로그 콘텐츠, 쇼핑몰 최적화 등에 투자하면 지속 가능한 성장이 가능합니다.` :
                                                        `현재 전환율(${formatDecimal(channel.cvr)}%)과 객단가(${formatNumber(Math.round(channel.arpu))}원)를 고려할 때, 투자 전 콘텐츠 품질과 사용자 경험 개선이 우선입니다.`) :
                                                    `이 채널은 전환율 ${formatDecimal(channel.cvr)}%, 객단가 ${formatNumber(Math.round(channel.arpu))}원으로 투자 효율성이 확인되었습니다. 파트너십 강화나 제휴 확대를 고려해보세요.`
                                                }
                                            </div>
                                        </div>
                                        ` : `
                                        <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid var(--warning-main);">
                                            <div style="font-size: 13px; color: var(--grey-900); font-weight: 700; margin-bottom: 8px;">
                                                ℹ️ Direct 자연 유입 채널
                                            </div>
                                            <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                                이 채널은 <strong>자연 유입(Direct Traffic)</strong>으로, 직접적인 광고 투자 대상이 아닙니다.<br><br>
                                                <strong>현재 성과:</strong><br>
                                                • 전환율: ${formatDecimal(channel.cvr)}%<br>
                                                • 평균 객단가: ${formatNumber(Math.round(channel.arpu))}원<br>
                                                • 총 매출: ${formatNumber(channel.revenue)}원<br><br>
                                                💡 <strong>개선 방안:</strong> 브랜드 인지도 향상, 이메일 마케팅, 리마케팅 등을 통해 Direct 유입을 늘릴 수 있습니다. 현재 높은 전환율(${formatDecimal(channel.cvr)}%)을 유지하면서 유입량을 증가시키는 것이 핵심입니다.
                                            </div>
                                        </div>
                                        `
                                    ) : `
                                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 3px solid var(--grey-300);">
                                            <div style="font-size: 12px; color: var(--grey-700);">
                                                ⚠️ 데이터가 충분하지 않아 정확한 투자 성과 예측이 어렵습니다. 더 많은 데이터를 수집한 후 재평가하세요. (현재 유입: ${formatNumber(channel.acquisition)}명)
                                            </div>
                                        </div>
                                    `}
                                </div>
                            `;
                            }).join('')}
                        </div>
                        ${channelInvestmentScores.length > 3 ? `
                        <div class="show-more-container" id="investmentShowMoreContainer" style="margin-top: 12px;">
                            <button class="show-more-btn" id="investmentShowMoreBtn">더 보기 (<span id="investmentHiddenCount">${channelInvestmentScores.length - 3}</span>개)</button>
                        </div>
                        <div class="show-more-container" id="investmentCollapseContainer" style="display: none; margin-top: 12px;">
                            <button class="show-more-btn" id="investmentCollapseBtn">접기</button>
                        </div>
                        ` : ''}
                    `;

                    // 더보기/접기 버튼 이벤트 리스너 등록
                    if (channelInvestmentScores.length > 3) {
                        const showMoreBtn = document.getElementById('investmentShowMoreBtn');
                        const collapseBtn = document.getElementById('investmentCollapseBtn');

                        if (showMoreBtn) {
                            showMoreBtn.addEventListener('click', function() {
                                const hiddenItems = document.querySelectorAll('.investment-item.hidden-row');
                                const showMoreContainer = document.getElementById('investmentShowMoreContainer');
                                const collapseContainer = document.getElementById('investmentCollapseContainer');

                                hiddenItems.forEach(item => {
                                    item.classList.remove('hidden-row');
                                });

                                showMoreContainer.style.display = 'none';
                                collapseContainer.style.display = 'block';
                            });
                        }

                        if (collapseBtn) {
                            collapseBtn.addEventListener('click', function() {
                                const allItems = document.querySelectorAll('.investment-item');
                                const showMoreContainer = document.getElementById('investmentShowMoreContainer');
                                const collapseContainer = document.getElementById('investmentCollapseContainer');

                                allItems.forEach((item, index) => {
                                    if (index >= 3) {
                                        item.classList.add('hidden-row');
                                    }
                                });

                                showMoreContainer.style.display = 'block';
                                collapseContainer.style.display = 'none';
                            });
                        }
                    }
                } else {
                    abTestContainer.innerHTML = '<p style="color: var(--grey-500);">분석 가능한 채널 데이터가 없습니다.</p>';
                }
            } else {
                abTestContainer.innerHTML = '<p style="color: var(--grey-500);">채널 데이터를 불러오는 중...</p>';
            }

            // 2. 채널 클러스터링 (기간 필터 적용)
            const clusterContainer = document.getElementById('channelClusters');
            if (periodData.channel_clusters && periodData.channel_clusters.clusters) {
                const clusters = periodData.channel_clusters.clusters;
                const descriptions = periodData.channel_clusters.description;

                clusterContainer.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 14px; color: var(--grey-700); margin-bottom: 12px;">
                            K-Means 클러스터링으로 <strong>${periodData.channel_clusters.n_clusters}개</strong> 그룹으로 분류
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        ${Object.entries(clusters).map(([clusterName, channels], index) => {
                            const colors = ['var(--success-main)', 'var(--warning-main)', 'var(--error-main)'];
                            const bgColors = ['var(--success-light)', 'var(--warning-light)', 'var(--error-light)'];
                            return `
                                <div style="padding: 16px; background: ${bgColors[index % 3]}; border-radius: 8px; border-left: 4px solid ${colors[index % 3]};">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 8px;">
                                        ${descriptions[clusterName] || clusterName}
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-700);">
                                        ${channels.map(ch => `<span style="display: inline-block; padding: 4px 8px; background: white; border-radius: 4px; margin: 2px;">${ch}</span>`).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                clusterContainer.innerHTML = '<p style="color: var(--grey-500);">클러스터링 결과가 없습니다.</p>';
            }

            // 2.5 A/B 테스트 통계 결과 (유의미한 채널 비교만 표시)
            if (periodData.ab_test_results && periodData.ab_test_results.length > 0) {
                const significantTests = periodData.ab_test_results.filter(t => t.significant === true);
                if (significantTests.length > 0) {
                    const abStatsHTML = `
                        <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid var(--success-main);">
                            <div style="font-size: 14px; font-weight: 600; color: var(--success-main); margin-bottom: 12px;">
                                📊 통계적으로 유의미한 채널 비교 (${significantTests.length}건)
                            </div>
                            <div style="font-size: 12px; color: var(--grey-600); margin-bottom: 12px;">
                                p-value < 0.05로 통계적으로 유의미한 전환율 차이가 확인된 채널 조합입니다.
                            </div>
                            <div style="display: grid; gap: 8px;">
                                ${significantTests.map(test => `
                                    <div style="padding: 12px; background: white; border-radius: 6px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: var(--grey-800);">${test.group_a}</span>
                                            <span style="font-size: 12px; color: ${test.cvr_a < test.cvr_b ? 'var(--error-main)' : 'var(--success-main)'};">(${test.cvr_a}%)</span>
                                        </div>
                                        <span style="color: var(--grey-400);">vs</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: var(--grey-800);">${test.group_b}</span>
                                            <span style="font-size: 12px; color: ${test.cvr_b < test.cvr_a ? 'var(--error-main)' : 'var(--success-main)'};">(${test.cvr_b}%)</span>
                                        </div>
                                        <span style="font-size: 11px; color: var(--grey-500); margin-left: auto;">p=${test.p_value.toFixed(4)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 12px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 12px; color: var(--grey-700);">
                                💡 <strong>활용 방법:</strong> 전환율이 높은 채널의 전략을 전환율이 낮은 채널에 적용해보세요.
                            </div>
                        </div>
                    `;
                    clusterContainer.insertAdjacentHTML('afterend', abStatsHTML);
                }
            }

            // 3. 이탈 위험 경고 (기본 7일)
            updateChurnPredictions('7d');

            // 4. 성과 개선 분석 (기본 7일)
            updateImprovementPredictions('7d');
        }

        // 단계별 맞춤 이탈 대응 추천 생성
        function getChurnRecommendation(stage, changePercent, riskLevel) {
            const absChange = Math.abs(parseFloat(changePercent));
            const urgency = riskLevel === 'high' ? '즉시' : '빠르게';

            // 단계별 맞춤 추천
            const stageRecommendations = {
                '유입': [
                    `광고 캠페인의 타겟팅을 ${urgency} 재검토하세요. 잘못된 고객층에게 광고가 노출되고 있을 수 있습니다.`,
                    `광고 소재(이미지, 문구)를 점검하세요. 클릭은 많지만 이탈이 늘었다면 광고 내용과 실제 페이지가 다를 수 있습니다.`,
                    `경쟁사의 프로모션이나 시장 변화를 확인하세요. 외부 요인이 유입에 영향을 줄 수 있습니다.`
                ],
                '활동': [
                    `랜딩페이지 로딩 속도를 ${urgency} 개선하세요. 느린 페이지는 방문자를 즉시 떠나게 만듭니다.`,
                    `첫 화면의 메시지가 명확한지 확인하세요. 방문자가 5초 안에 "여기서 뭘 할 수 있는지" 이해해야 합니다.`,
                    `모바일 화면에서도 제대로 보이는지 테스트하세요. 많은 사용자가 모바일로 접속합니다.`
                ],
                '관심': [
                    `제품/서비스 설명을 더 구체적으로 작성하세요. 고객이 관심을 잃는 이유는 정보 부족일 수 있습니다.`,
                    `고객 후기와 리뷰를 더 눈에 띄게 배치하세요. 신뢰가 부족하면 관심이 떨어집니다.`,
                    `가격이나 혜택 정보를 더 일찍 보여주세요. 숨겨진 비용은 고객을 이탈시킵니다.`
                ],
                '결제진행': [
                    `결제 단계를 단순화하세요. 불필요한 정보 입력을 제거하고 필수 항목만 남기세요.`,
                    `배송비와 총 금액을 결제 전에 미리 보여주세요. 마지막에 예상보다 비싸면 이탈합니다.`,
                    `다양한 결제 수단을 제공하세요. 선호하는 결제 방법이 없으면 포기할 수 있습니다.`
                ],
                '구매완료': [
                    `결제 오류나 시스템 문제를 ${urgency} 점검하세요. 기술적 문제로 구매가 실패할 수 있습니다.`,
                    `마지막 단계의 보안 인증이 너무 복잡하지 않은지 확인하세요. 간편 결제 도입을 고려하세요.`,
                    `재고 부족 알림을 확인하세요. 품절로 인해 구매를 완료하지 못했을 수 있습니다.`
                ]
            };

            // 해당 단계의 추천 목록
            const recommendations = stageRecommendations[stage] || [
                `${stage} 단계의 고객 경험을 전반적으로 재검토하세요.`,
                `데이터를 분석하여 이탈의 근본 원인을 파악하세요.`,
                `A/B 테스트를 통해 다양한 개선안을 실험해보세요.`
            ];

            // 이탈률에 따라 추천 선택 (높을수록 더 긴급한 추천)
            const index = absChange > 15 ? 0 : absChange > 10 ? 1 : 2;
            return recommendations[index];
        }

        // 이탈 위험 경고 업데이트 (period: '7d' or '30d')
        // 이탈 분석은 항상 전체 기간 데이터만 사용
        function updateChurnPredictions(period) {
            const churnData = getChurnData();
            if (!churnData) return;

            const dataKey = period === '7d' ? 'churn_predictions_7d' : 'churn_predictions_30d';
            const predictions = churnData[dataKey] || [];
            const periodText = period === '7d' ? '최근 7일 vs 이전 7일' : '최근 30일 vs 이전 30일';

            const churnContainer = document.getElementById('churnPredictions');
            if (predictions.length > 0) {
                churnContainer.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 14px; color: var(--error-main); font-weight: 600; margin-bottom: 12px;">
                            ⚠️ ${predictions.length}개 퍼널 단계에서 이탈 위험 감지
                        </p>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        ${predictions.map(pred => {
                            const customRecommendation = getChurnRecommendation(pred.stage, pred.change_pct, pred.risk_level);
                            return `
                            <div style="padding: 16px; background: ${pred.risk_level === 'high' ? 'var(--error-light)' : 'var(--warning-light)'}; border-radius: 8px; border-left: 4px solid ${pred.risk_level === 'high' ? 'var(--error-main)' : 'var(--warning-main)'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 16px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                            ${pred.stage} 단계
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700);">
                                            ${periodText}: <strong style="color: var(--error-main);">${pred.change_pct}%</strong> 감소
                                        </div>
                                    </div>
                                    <span style="font-size: 12px; padding: 4px 12px; background: ${pred.risk_level === 'high' ? 'var(--error-main)' : 'var(--warning-main)'}; color: white; border-radius: 12px; font-weight: 600;">
                                        ${pred.risk_level === 'high' ? '높음' : '중간'}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px; color: var(--grey-700); margin-bottom: 12px;">
                                    <span>최근 평균: <strong>${formatNumber(pred.recent_avg)}</strong>명</span>
                                    <span>이전 평균: <strong>${formatNumber(pred.previous_avg)}</strong>명</span>
                                </div>
                                <div style="font-size: 13px; color: var(--grey-900); padding: 12px; background: white; border-radius: 6px; line-height: 1.6;">
                                    💡 <strong>우선 조치:</strong> ${customRecommendation}
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } else {
                churnContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--success-main);">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">이탈 위험 없음</p>
                        <p style="font-size: 14px; color: var(--grey-600);">모든 퍼널 단계가 안정적입니다.</p>
                    </div>
                `;
            }

            // CRM 액션 가이드 표시 (전체 기간 데이터 사용)
            if (churnData.crm_actions && churnData.crm_actions.length > 0) {
                const crmHTML = `
                    <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 4px solid var(--secondary-main);">
                        <div style="font-size: 14px; font-weight: 600; color: var(--secondary-main); margin-bottom: 12px;">
                            📋 CRM 액션 가이드
                        </div>
                        <div style="font-size: 12px; color: var(--grey-600); margin-bottom: 12px;">
                            이탈 위험을 방지하기 위한 구체적인 CRM 액션입니다.
                        </div>
                        <div style="display: grid; gap: 10px;">
                            ${churnData.crm_actions.map(action => `
                                <div style="padding: 12px; background: white; border-radius: 6px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-900); margin-bottom: 6px;">
                                        📍 ${action.stage}
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); margin-bottom: 4px;">
                                        ${action.trend}
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-600); margin-bottom: 8px;">
                                        <em>${action.diagnosis}</em>
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-900); padding: 8px; background: #f5f5f5; border-radius: 4px;">
                                        💊 <strong>처방:</strong> ${action.prescription}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                churnContainer.insertAdjacentHTML('beforeend', crmHTML);
            }
        }

        // 단계별 맞춤 개선 유지 추천 생성
        function getImprovementRecommendation(stage, changePercent, improvementLevel) {
            const absChange = Math.abs(parseFloat(changePercent));

            // 단계별 맞춤 추천 - 구체적이고 즉시 실행 가능한 액션
            const stageRecommendations = {
                '유입': [
                    // 높은 증가율 (15% 이상)
                    `<strong>지금 바로:</strong> 1) 성과가 좋은 광고 캠페인의 예산을 20-30% 증액하세요 2) 광고 소재(이미지, 문구)를 스크린샷으로 저장하여 성공 템플릿을 만드세요 3) 같은 방식을 다른 채널에도 테스트하세요`,
                    // 중간 증가율 (10-15%)
                    `<strong>성공 요인 분석:</strong> 1) 최근 7일간 어떤 광고/채널에서 유입이 늘었는지 Google Analytics에서 확인하세요 2) 프로모션이나 할인 이벤트를 진행했다면 날짜와 효과를 엑셀에 기록하세요 3) 계절성 요인(명절, 휴가철 등)이 있는지 체크하세요`,
                    // 낮은 증가율 (10% 미만)
                    `<strong>현상 유지 + 추가 성장:</strong> 1) 현재 광고비 배분을 그대로 유지하세요 2) 신규 키워드나 타겟 오디언스를 1-2개 추가로 테스트하세요 (전체 예산의 10% 이내) 3) 주간 단위로 성과를 모니터링하세요`
                ],
                '활동': [
                    // 높은 증가율
                    `<strong>즉시 실행:</strong> 1) 최근 변경한 랜딩 페이지 디자인이나 문구가 있다면 절대 되돌리지 마세요 2) 페이지 로딩 속도를 PageSpeed Insights로 측정하여 3초 이내 유지하세요 3) 모바일 화면에서 첫 화면이 잘 보이는지 직접 확인하세요`,
                    // 중간 증가율
                    `<strong>효과 검증:</strong> 1) Google Analytics에서 '참여 세션' 지표를 확인하세요 (행동 > 사이트 콘텐츠) 2) 사용자가 가장 많이 클릭하는 버튼이나 링크를 Hotjar 같은 도구로 확인하세요 3) 스크롤 깊이를 측정하여 콘텐츠가 잘 읽히는지 체크하세요`,
                    // 낮은 증가율
                    `<strong>개선 유지:</strong> 1) 첫 화면에 표시되는 핵심 메시지를 변경하지 마세요 2) CTA 버튼(가입하기, 더 알아보기 등)의 색상과 위치를 고정하세요 3) 주 1회 이탈률을 체크하여 갑작스러운 변화가 없는지 확인하세요`
                ],
                '관심': [
                    // 높은 증가율
                    `<strong>지금 당장:</strong> 1) 상품 상세 페이지에 추가한 이미지나 설명이 있다면 다른 상품에도 동일하게 적용하세요 2) 고객 후기를 최소 10개 이상 노출하세요 (없으면 구매 고객에게 리뷰 작성 요청 이메일 발송) 3) FAQ 섹션을 추가하여 자주 묻는 질문 5가지를 답변하세요`,
                    // 중간 증가율
                    `<strong>관심 강화:</strong> 1) 제품 사진을 다양한 각도에서 최소 5장 이상 제공하세요 2) 사용 전/후 비교 이미지나 영상을 추가하세요 3) "이 상품을 본 고객이 함께 본 상품" 추천 섹션을 만드세요`,
                    // 낮은 증가율
                    `<strong>트렌드 유지:</strong> 1) 상품명과 설명의 키워드를 변경하지 마세요 2) 가격 정책을 안정적으로 유지하세요 (잦은 가격 변동은 신뢰 저하) 3) 재고 부족 메시지가 뜨는 상품이 있는지 확인하고 보충하세요`
                ],
                '결제진행': [
                    // 높은 증가율
                    `<strong>핵심 유지 + 확장:</strong> 1) 최근 추가한 간편결제(카카오페이, 네이버페이 등)를 더 눈에 띄게 강조하세요 2) 결제 페이지를 절대 변경하지 마세요 3) 배송비 무료 기준이나 할인 정책을 그대로 유지하세요`,
                    // 중간 증가율
                    `<strong>신뢰 강화:</strong> 1) SSL 인증서(자물쇠 아이콘)가 브라우저에 제대로 표시되는지 확인하세요 2) 결제 페이지에 "안전한 결제" 문구와 보안 마크를 추가하세요 3) 개인정보 처리방침 링크가 명확히 보이게 하세요`,
                    // 낮은 증가율
                    `<strong>안정성 유지:</strong> 1) 결제 프로세스의 단계 수를 유지하세요 (현재 3-4단계 권장) 2) 필수 입력 항목을 줄이지도 늘리지도 마세요 3) 모바일에서 결제가 잘 되는지 직접 테스트하세요`
                ],
                '구매완료': [
                    // 높은 증가율
                    `<strong>매출 극대화:</strong> 1) 구매 확인 페이지에서 관련 상품 3개를 추천하세요 ("이 상품도 함께 구매하세요") 2) 구매 고객에게 "첫 리뷰 작성 시 500원 할인" 같은 인센티브를 제공하세요 3) 구매 후 3일 뒤 만족도 조사 이메일을 자동 발송하세요`,
                    // 중간 증가율
                    `<strong>재구매 유도:</strong> 1) 구매 완료 후 10일 뒤 "재구매 시 10% 할인 쿠폰" 이메일을 자동 발송하세요 2) 카카오톡 채널 추가 시 추가 혜택을 제공하세요 3) 배송 알림 문자에 다음 구매를 유도하는 링크를 넣으세요`,
                    // 낮은 증가율
                    `<strong>고객 관계 유지:</strong> 1) 구매 감사 이메일을 발송하세요 (개인화된 메시지 권장) 2) 배송 조회 링크를 명확히 제공하세요 3) 고객 센터 연락처를 구매 확인 페이지에 눈에 띄게 표시하세요`
                ]
            };

            // 해당 단계의 추천 목록
            const recommendations = stageRecommendations[stage] || [
                `${stage} 단계의 성과가 좋아지고 있습니다. 현재 전략을 유지하면서 추가 개선 기회를 찾아보세요.`,
                `최근 변경 사항을 문서화하고, 성공 요인을 다른 채널이나 상품에도 적용하세요.`,
                `A/B 테스트를 통해 추가 최적화 여지를 확인하고, 데이터 기반으로 의사결정하세요.`
            ];

            // 개선율에 따라 추천 선택 (높을수록 더 적극적인 추천)
            const index = absChange > 15 ? 0 : absChange > 10 ? 1 : 2;
            return recommendations[index];
        }

        // 성과 개선 분석 업데이트 (period: '7d' or '30d')
        // 이탈/개선 분석은 항상 전체 기간 데이터만 사용
        function updateImprovementPredictions(period) {
            const churnData = getChurnData();
            if (!churnData) return;

            const dataKey = period === '7d' ? 'improvement_predictions_7d' : 'improvement_predictions_30d';
            const predictions = churnData[dataKey] || [];
            const periodText = period === '7d' ? '최근 7일 vs 이전 7일' : '최근 30일 vs 이전 30일';

            const improvementContainer = document.getElementById('improvementPredictions');
            if (predictions.length > 0) {
                improvementContainer.innerHTML = `
                    <div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid var(--success-main);">
                        <p style="font-size: 15px; color: var(--success-main); font-weight: 600; margin-bottom: 6px;">
                            🎉 축하합니다! ${predictions.length}개 단계에서 성과가 좋아졌습니다
                        </p>
                        <p style="font-size: 13px; color: var(--grey-700);">
                            각 개선 사항마다 구체적인 실행 방법을 확인하여 이 성과를 계속 유지하세요.
                        </p>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        ${predictions.map(pred => {
                            const customRecommendation = getImprovementRecommendation(pred.stage, pred.change_pct, pred.improvement_level);
                            const improvementPercent = Math.abs(parseFloat(pred.change_pct));
                            const improvementLabel = improvementPercent > 15 ? '탁월한 개선!' : improvementPercent > 10 ? '좋은 개선!' : '긍정적 변화';

                            return `
                            <div style="padding: 16px; background: ${pred.improvement_level === 'high' ? 'var(--success-light)' : '#e8f5e9'}; border-radius: 8px; border-left: 4px solid ${pred.improvement_level === 'high' ? 'var(--success-main)' : '#66bb6a'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 16px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                            📈 ${pred.stage} 단계 고객 수 증가
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700);">
                                            ${periodText} 비교: <strong style="color: var(--success-main);">+${pred.change_pct}%</strong> 증가 (${formatNumber(pred.previous_avg)}명 → ${formatNumber(pred.recent_avg)}명)
                                        </div>
                                    </div>
                                    <span style="font-size: 11px; padding: 6px 12px; background: ${pred.improvement_level === 'high' ? 'var(--success-main)' : '#66bb6a'}; color: white; border-radius: 12px; font-weight: 600; white-space: nowrap;">
                                        ${improvementLabel}
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: var(--grey-900); padding: 14px; background: white; border-radius: 6px; line-height: 1.8; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div style="font-weight: 600; color: var(--success-main); margin-bottom: 8px;">
                                        ✅ 이 성과를 유지하려면 지금 바로 실행하세요:
                                    </div>
                                    <div style="color: var(--grey-800);">
                                        ${customRecommendation}
                                    </div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } else {
                improvementContainer.innerHTML = `
                    <div style="padding: 30px 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--grey-800);">현재 기간에는 개선된 단계가 없습니다</p>
                        <p style="font-size: 14px; color: var(--grey-600); margin-bottom: 20px; line-height: 1.6;">
                            이전 기간과 비교하여 유의미한 성과 향상이 감지되지 않았습니다.<br>
                            이는 성과가 나쁘다는 뜻이 아니라, <strong>비슷한 수준을 유지</strong>하고 있다는 의미입니다.
                        </p>
                        <div style="background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%); padding: 16px; border-radius: 8px; text-align: left; max-width: 500px; margin: 0 auto;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-800); margin-bottom: 8px;">
                                💡 이럴 때 확인할 점:
                            </div>
                            <div style="font-size: 13px; color: var(--grey-700); line-height: 1.7;">
                                1. <strong>"경고: 이탈 위험 증가"</strong> 섹션을 확인하여 악화된 부분이 있는지 체크하세요<br>
                                2. 위 버튼에서 <strong>"최근 30일"</strong>로 기간을 변경하여 장기 트렌드를 확인하세요<br>
                                3. 성과를 더 높이려면 새로운 마케팅 전략이나 A/B 테스트를 시도하세요
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 이탈률 계산 함수
        function calculateChurnRates(row) {
            const acquisition = parseFloat(row['유입']) || 0;
            const activation = parseFloat(row['활동']) || 0;
            const consideration = parseFloat(row['관심']) || 0;
            const conversion = parseFloat(row['결제진행']) || 0;
            const purchase = parseFloat(row['구매완료']) || 0;

            // 전체 이탈률 = (유입 - 구매완료) / 유입 × 100
            const totalChurn = acquisition > 0 ? ((acquisition - purchase) / acquisition * 100) : 0;

            // 단계별 이탈률
            const activationChurn = acquisition > 0 ? ((acquisition - activation) / acquisition * 100) : 0;
            const considerationChurn = activation > 0 ? ((activation - consideration) / activation * 100) : 0;
            const conversionChurn = consideration > 0 ? ((consideration - conversion) / consideration * 100) : 0;
            const purchaseChurn = conversion > 0 ? ((conversion - purchase) / conversion * 100) : 0;

            // 단계별 최대 이탈률
            const maxChurn = Math.max(activationChurn, considerationChurn, conversionChurn, purchaseChurn);

            // 평균 이탈률
            const avgChurn = (activationChurn + considerationChurn + conversionChurn + purchaseChurn) / 4;

            return {
                total: totalChurn,
                max: maxChurn,
                avg: avgChurn,
                activation: activationChurn,
                consideration: considerationChurn,
                conversion: conversionChurn,
                purchase: purchaseChurn
            };
        }

        // KPI 차트 자동 분석 함수
        function analyzeKpiChartData(data, kpiType) {
            if (data.length === 0) return;

            const kpiNames = {
                cvr: '전환율',
                acquisition: '방문자 수',
                activation: '활성 사용자',
                consideration: '관심 고객',
                conversion: '결제 시도',
                purchase: '구매 건수',
                revenue: '매출'
            };

            const kpiKeys = {
                cvr: 'CVR',
                acquisition: '유입',
                activation: '활동',
                consideration: '관심',
                conversion: '결제진행',
                purchase: '구매완료',
                revenue: 'Revenue'
            };

            const currentKpiName = kpiNames[kpiType];
            const currentKpiKey = kpiKeys[kpiType];

            // 데이터 추출 및 정렬
            const sortedData = [...data].map(row => ({
                channel: row['channel'],
                value: kpiType === 'cvr' ? parseFloat(row[currentKpiKey]) || 0 : parseFloat(row[currentKpiKey]) || 0
            })).sort((a, b) => b.value - a.value);

            const top1 = sortedData[0];
            const top2 = sortedData[1];
            const top3 = sortedData[2];
            const bottom = sortedData[sortedData.length - 1];

            // 평균 계산
            const avgValue = sortedData.reduce((sum, item) => sum + item.value, 0) / sortedData.length;

            // 표준편차 계산 (데이터 편차 파악)
            const variance = sortedData.reduce((sum, item) => sum + Math.pow(item.value - avgValue, 2), 0) / sortedData.length;
            const stdDev = Math.sqrt(variance);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 1. 1등 채널 정보
            insightHTML += `<strong style="color: #2196f3;">🥇 1위 채널:</strong> `;
            insightHTML += `<strong>${top1.channel}</strong>이 ${currentKpiName}에서 1등입니다 `;
            if (kpiType === 'cvr') {
                insightHTML += `(${top1.value.toFixed(2)}%). `;
                if (top1.value > 3) {
                    insightHTML += `매우 우수한 전환율이므로 광고 예산을 더 투자하세요! `;
                } else if (top1.value > 1.5) {
                    insightHTML += `양호한 전환율입니다. `;
                } else {
                    insightHTML += `전환율이 낮은 편입니다. 전반적인 개선이 필요합니다. `;
                }
            } else if (kpiType === 'revenue') {
                insightHTML += `(₩${formatNumber(top1.value)}). `;
                insightHTML += `이 채널의 성공 요인을 분석하여 다른 채널에 적용하세요. `;
            } else {
                insightHTML += `(${formatNumber(top1.value)}명). `;
            }

            // 2. 1등과 2등의 격차
            const gap = top1.value - top2.value;
            const gapPercent = (gap / top1.value * 100);
            if (gapPercent > 30) {
                insightHTML += `<br><br><strong style="color: #ff9800;">⚠️ 주의:</strong> `;
                insightHTML += `1위와 2위의 격차가 ${gapPercent.toFixed(0)}%로 매우 큽니다. `;
                insightHTML += `<strong>${top1.channel}</strong>에 과도하게 의존하고 있으므로, 다른 채널도 육성하여 리스크를 분산하세요. `;
            } else {
                insightHTML += `2위는 <strong>${top2.channel}</strong>이며, 1위와의 격차는 ${gapPercent.toFixed(0)}%입니다. `;
            }

            // 3. 상위 vs 하위 비교
            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 전체 분석:</strong> `;
            const topBottomRatio = top1.value / (bottom.value || 1);
            if (topBottomRatio > 10) {
                insightHTML += `최고와 최저의 차이가 ${topBottomRatio.toFixed(1)}배로 매우 큽니다. `;
                insightHTML += `<strong>${bottom.channel}</strong> 같은 저성과 채널은 일시 중단을 검토하고, `;
                insightHTML += `예산을 상위 채널로 재배분하세요. `;
            } else if (topBottomRatio > 3) {
                insightHTML += `채널 간 성과 차이가 ${topBottomRatio.toFixed(1)}배로 존재합니다. `;
                insightHTML += `저성과 채널의 원인을 분석하고 개선하세요. `;
            } else {
                insightHTML += `채널 간 성과가 비교적 고르게 분포되어 있습니다. `;
            }

            // 4. 지표별 맞춤 추천
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 ${currentKpiName} 개선 전략:</strong> `;
            switch(kpiType) {
                case 'cvr':
                    if (avgValue < 1.5) {
                        insightHTML += `전체 평균 CVR이 ${avgValue.toFixed(2)}%로 낮습니다. 랜딩 페이지 개선과 타겟팅 정밀화가 시급합니다. `;
                    } else if (avgValue > 3) {
                        insightHTML += `전체 평균 CVR이 ${avgValue.toFixed(2)}%로 우수합니다! 현재 전략을 유지하세요. `;
                    } else {
                        insightHTML += `전체 평균 CVR은 ${avgValue.toFixed(2)}%입니다. A/B 테스트로 추가 개선을 시도하세요. `;
                    }
                    break;
                case 'revenue':
                    insightHTML += `<strong>${top1.channel}</strong>이 전체 매출의 핵심입니다. `;
                    insightHTML += `이 채널의 광고 소재, 타겟팅, 랜딩 페이지를 분석하여 다른 채널에 적용하세요. `;
                    break;
                case 'acquisition':
                    insightHTML += `방문자가 많다고 좋은 것은 아닙니다. `;
                    insightHTML += `CVR과 함께 비교하여 효율적인 채널에 집중 투자하세요. `;
                    break;
                default:
                    insightHTML += `상위 3개 채널(<strong>${top1.channel}, ${top2.channel}, ${top3.channel}</strong>)에 집중하여 최적화하세요. `;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('kpiChartInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // KPI 차트 업데이트 (CVR, 유입, 활동, 관심, 결제진행, 구매완료, 매출)
        function updateKpiChart(kpiType = 'cvr') {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('channelKpiChart');
            if (!ctx) return;

            if (channelKpiChart) {
                channelKpiChart.destroy();
            }

            // 현재 KPI 타입 저장
            currentKpiType = kpiType;

            // KPI별 설정
            const kpiConfig = {
                cvr: {
                    label: 'CVR (%)',
                    key: 'CVR',
                    color: '#673ab7',
                    format: (val) => formatDecimal(val) + '%',
                    getValue: (row) => parseFloat(row['CVR']) || 0
                },
                acquisition: {
                    label: '유입 (명)',
                    key: '유입',
                    color: '#2196f3',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['유입']) || 0
                },
                activation: {
                    label: '활동 (명)',
                    key: '활동',
                    color: '#00bcd4',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['활동']) || 0
                },
                consideration: {
                    label: '관심 (명)',
                    key: '관심',
                    color: '#ff9800',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['관심']) || 0
                },
                conversion: {
                    label: '결제진행 (명)',
                    key: '결제진행',
                    color: '#4caf50',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['결제진행']) || 0
                },
                purchase: {
                    label: '구매완료 (명)',
                    key: '구매완료',
                    color: '#00c853',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['구매완료']) || 0
                },
                revenue: {
                    label: '매출 (원)',
                    key: 'Revenue',
                    color: '#f44336',
                    format: (val) => formatNumber(val) + '원',
                    getValue: (row) => parseFloat(row['Revenue']) || 0
                }
            };

            const config = kpiConfig[kpiType];
            if (!config) return;

            // 선택된 KPI 기준으로 정렬 (DESC)
            const sortedData = [...channelData].sort((a, b) => {
                const aVal = config.getValue(a);
                const bVal = config.getValue(b);
                return bVal - aVal;
            }).slice(0, 10);

            const labels = sortedData.map(row => row['channel']);
            const values = sortedData.map(row => config.getValue(row));

            channelKpiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: config.label,
                        data: values,
                        backgroundColor: config.color.replace(')', ', 0.8)').replace('rgb', 'rgba'),
                        borderColor: config.color,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return config.label + ': ' + config.format(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: config.label
                            }
                        }
                    }
                }
            });

            // KPI 데이터 분석 및 인사이트 생성
            analyzeKpiChartData(channelData, kpiType);

            // 툴팁 이벤트 설정
            setupKpiChartTooltip();
        }

        // KPI 차트 툴팁 설정
        function setupKpiChartTooltip() {
            const canvas = document.getElementById('channelKpiChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            // Remove existing listeners by cloning container
            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateKpiInsight(currentKpiType);
                    showChartInsightTooltip('kpiChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('kpiChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('kpiChartTooltip');
                });
            }
        }

        // 이탈률 자동 분석 함수
        function analyzeChurnRates(allData, currentStage) {
            if (allData.length === 0) return;

            // 각 단계별 평균 이탈률 계산
            let totalActivation = 0, totalConsideration = 0, totalConversion = 0, totalPurchase = 0;

            allData.forEach(row => {
                const churnRates = calculateChurnRates(row);
                totalActivation += churnRates.activation;
                totalConsideration += churnRates.consideration;
                totalConversion += churnRates.conversion;
                totalPurchase += churnRates.purchase;
            });

            const avgActivation = totalActivation / allData.length;
            const avgConsideration = totalConsideration / allData.length;
            const avgConversion = totalConversion / allData.length;
            const avgPurchase = totalPurchase / allData.length;

            // 산업 평균 벤치마크 (일반적인 범위의 중간값)
            const benchmarks = {
                activation: { min: 40, max: 60, avg: 50, label: '유입→활동' },
                consideration: { min: 50, max: 70, avg: 60, label: '활동→관심' },
                conversion: { min: 60, max: 80, avg: 70, label: '관심→결제진행' },
                purchase: { min: 20, max: 30, avg: 25, label: '결제진행→구매완료' }
            };

            // 가장 높은 이탈률을 보이는 단계 찾기
            const stageAverages = [
                { stage: 'activation', avg: avgActivation, label: '유입→활동' },
                { stage: 'consideration', avg: avgConsideration, label: '활동→관심' },
                { stage: 'conversion', avg: avgConversion, label: '관심→결제진행' },
                { stage: 'purchase', avg: avgPurchase, label: '결제진행→구매완료' }
            ];

            const highestChurnStage = stageAverages.reduce((max, item) =>
                item.avg > max.avg ? item : max, stageAverages[0]
            );

            // 해당 단계에서 이탈률이 가장 높은 채널들 찾기
            const channelsWithHighChurn = allData.map(row => {
                const churnRates = calculateChurnRates(row);
                return {
                    channel: row['channel'],
                    churnRate: churnRates[highestChurnStage.stage]
                };
            }).sort((a, b) => b.churnRate - a.churnRate).slice(0, 3);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 전체 상황 요약
            insightHTML += `가장 많은 고객이 이탈하는 구간은 <strong style="color: #ff5722;">${highestChurnStage.label}</strong> 단계로, `;
            insightHTML += `평균 <strong style="color: #ff5722;">${highestChurnStage.avg.toFixed(1)}%</strong>의 고객이 이 단계에서 떠납니다. `;

            // 산업 평균과 비교
            const benchmark = benchmarks[highestChurnStage.stage];
            if (highestChurnStage.avg > benchmark.max) {
                insightHTML += `<strong style="color: var(--error-main);">⚠️ 산업 평균(${benchmark.min}-${benchmark.max}%)보다 높아 즉시 개선이 필요합니다!</strong> `;
            } else if (highestChurnStage.avg < benchmark.min) {
                insightHTML += `<strong style="color: var(--success-main);">✅ 산업 평균(${benchmark.min}-${benchmark.max}%)보다 낮아 양호합니다!</strong> `;
            } else {
                insightHTML += `산업 평균(${benchmark.min}-${benchmark.max}%) 범위 내입니다. `;
            }

            // 문제 채널 강조
            insightHTML += `<br><br><strong style="color: var(--primary-main);">🎯 집중 개선 대상 채널:</strong><br>`;
            channelsWithHighChurn.forEach((item, index) => {
                insightHTML += `${index + 1}. <strong>${item.channel}</strong>: ${item.churnRate.toFixed(1)}% 이탈`;
                if (index < channelsWithHighChurn.length - 1) insightHTML += '<br>';
            });

            // 단계별 구체적인 추천사항
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 ${highestChurnStage.label} 이탈률 개선 방법:</strong><br>`;

            switch(highestChurnStage.stage) {
                case 'activation':
                    if (highestChurnStage.avg > 60) {
                        insightHTML += `• <strong>랜딩 페이지 로딩 속도</strong>를 3초 이내로 최적화하세요 (현재 이탈률이 매우 높음)<br>`;
                        insightHTML += `• 광고 문구와 랜딩 페이지의 <strong>메시지가 일치</strong>하는지 즉시 확인하세요<br>`;
                        insightHTML += `• 모바일 사용자 경험을 우선적으로 개선하세요`;
                    } else {
                        insightHTML += `• 첫 화면에 너무 많은 정보가 있는지 확인하고 <strong>핵심 메시지만 강조</strong>하세요<br>`;
                        insightHTML += `• 랜딩 페이지 디자인이 신뢰감을 주는지 점검하세요<br>`;
                        insightHTML += `• CTA(행동 유도) 버튼이 눈에 잘 띄는지 확인하세요`;
                    }
                    break;
                case 'consideration':
                    if (highestChurnStage.avg > 70) {
                        insightHTML += `• <strong>상세 페이지에 정보가 부족</strong>합니다. 제품 설명, 사양, 사용법을 보강하세요<br>`;
                        insightHTML += `• <strong>고객 리뷰와 평점</strong>을 눈에 띄게 배치하세요 (신뢰도 향상)<br>`;
                        insightHTML += `• 경쟁사 대비 차별화 포인트를 명확히 전달하세요`;
                    } else {
                        insightHTML += `• 제품 이미지의 품질을 높이고 다양한 각도로 제공하세요<br>`;
                        insightHTML += `• FAQ나 챗봇을 추가하여 즉시 궁금증을 해결하세요<br>`;
                        insightHTML += `• 사용 사례나 후기 영상을 추가하세요`;
                    }
                    break;
                case 'conversion':
                    if (highestChurnStage.avg > 75) {
                        insightHTML += `• <strong>가격이 너무 높거나</strong> 할인/프로모션이 부족합니다. 첫 구매 할인을 제공하세요<br>`;
                        insightHTML += `• <strong>회원가입 없이</strong> 게스트로 결제할 수 있게 하세요 (이탈률 크게 감소)<br>`;
                        insightHTML += `• 배송비가 높거나 배송 기간이 길면 명확히 안내하세요`;
                    } else {
                        insightHTML += `• "장바구니 담기" 버튼을 더 눈에 띄게 만드세요<br>`;
                        insightHTML += `• 재고 부족 시 알림 받기 기능을 제공하세요<br>`;
                        insightHTML += `• 위시리스트 기능으로 나중에 구매를 유도하세요`;
                    }
                    break;
                case 'purchase':
                    if (highestChurnStage.avg > 30) {
                        insightHTML += `• <strong>결제 과정이 너무 복잡</strong>합니다. 단계를 3단계 이하로 줄이세요<br>`;
                        insightHTML += `• <strong>카카오페이, 네이버페이</strong> 등 간편결제 옵션을 추가하세요 (이탈률 급감)<br>`;
                        insightHTML += `• 보안 인증서 표시로 결제 안전성을 강조하세요`;
                    } else {
                        insightHTML += `• 결제 단계마다 진행 상황 표시줄을 보여주세요<br>`;
                        insightHTML += `• 예상치 못한 추가 비용(배송비, 수수료)이 없는지 확인하세요<br>`;
                        insightHTML += `• 결제 실패 시 명확한 오류 메시지와 해결 방법을 제공하세요`;
                    }
                    break;
            }

            // 전체적인 이탈률 패턴 분석
            const allChurns = [avgActivation, avgConsideration, avgConversion, avgPurchase];
            const overallAvg = allChurns.reduce((sum, val) => sum + val, 0) / 4;

            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 전체 퍼널 상태:</strong> `;
            if (overallAvg > 60) {
                insightHTML += `전반적으로 이탈률이 높습니다. <strong>전체 고객 여정을 재검토</strong>하고, 각 단계마다 A/B 테스트를 진행하세요.`;
            } else if (overallAvg < 40) {
                insightHTML += `전반적으로 우수한 상태입니다! 현재 전략을 유지하면서 세부적인 최적화에 집중하세요.`;
            } else {
                insightHTML += `평균적인 수준입니다. 위의 개선 방법을 우선순위에 따라 하나씩 적용해보세요.`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('churnInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 이탈률 차트 업데이트 (퍼널 단계별 이탈률)
        function updateChurnChart(stage = null, sort = null) {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('channelChurnChart');
            if (!ctx) return;

            if (channelChurnChart) {
                channelChurnChart.destroy();
            }

            // 파라미터가 제공되면 전역 변수 업데이트
            if (stage !== null) currentChurnStage = stage;
            if (sort !== null) currentChurnSort = sort;

            // 퍼널 단계별 설정
            const stageConfig = {
                activation: {
                    label: '유입→활동 이탈률 (%)',
                    color: '#673ab7',
                    getValue: (row) => calculateChurnRates(row).activation,
                    tooltip: '(유입 - 활동) / 유입 × 100'
                },
                consideration: {
                    label: '활동→관심 이탈률 (%)',
                    color: '#2196f3',
                    getValue: (row) => calculateChurnRates(row).consideration,
                    tooltip: '(활동 - 관심) / 활동 × 100'
                },
                conversion: {
                    label: '관심→결제진행 이탈률 (%)',
                    color: '#ff9800',
                    getValue: (row) => calculateChurnRates(row).conversion,
                    tooltip: '(관심 - 결제진행) / 관심 × 100'
                },
                purchase: {
                    label: '결제진행→구매완료 이탈률 (%)',
                    color: '#4caf50',
                    getValue: (row) => calculateChurnRates(row).purchase,
                    tooltip: '(결제진행 - 구매완료) / 결제진행 × 100'
                },
                avg: {
                    label: '평균 이탈률 (%)',
                    color: '#e91e63',
                    getValue: (row) => calculateChurnRates(row).avg,
                    tooltip: '모든 단계 이탈률의 평균'
                }
            };

            const config = stageConfig[currentChurnStage];
            if (!config) return;

            // 데이터 정렬
            const sortedData = [...channelData].sort((a, b) => {
                const aVal = config.getValue(a);
                const bVal = config.getValue(b);
                return currentChurnSort === 'desc' ? (bVal - aVal) : (aVal - bVal);
            }).slice(0, 10);

            const labels = sortedData.map(row => row['channel']);
            const values = sortedData.map(row => config.getValue(row));

            channelChurnChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: config.label,
                        data: values,
                        backgroundColor: config.color.replace(')', ', 0.8)').replace('rgb', 'rgba'),
                        borderColor: config.color,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return config.label + ': ' + formatDecimal(context.parsed.x) + '%';
                                },
                                afterLabel: function(context) {
                                    return '계산식: ' + config.tooltip;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: config.label
                            }
                        }
                    }
                }
            });

            // 이탈률 자동 분석 실행
            analyzeChurnRates(channelData, currentChurnStage);

            // 툴팁 이벤트 설정
            setupChurnChartTooltip();
        }

        // 이탈률 차트 툴팁 설정
        function setupChurnChartTooltip() {
            const canvas = document.getElementById('channelChurnChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateChurnInsight();
                    showChartInsightTooltip('churnChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('churnChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('churnChartTooltip');
                });
            }
        }

        // 비교 차트 자동 분석 함수
        function analyzeCompareChartData(data) {
            if (data.length === 0) return;

            // 데이터 파싱 (상위 8개만, 차트와 동일)
            const sortedData = [...data].sort((a, b) =>
                (parseFloat(b['CVR']) || 0) - (parseFloat(a['CVR']) || 0)
            ).slice(0, 8).map(row => ({
                channel: row['channel'],
                cvr: parseFloat(row['CVR']) || 0,
                acquisition: parseFloat(row['유입']) || 0,
                purchase: parseFloat(row['구매완료']) || 0,
                revenue: parseFloat(row['Revenue']) || 0
            }));

            // 정규화 (100점 만점으로 환산)
            const maxCVR = Math.max(...sortedData.map(ch => ch.cvr));
            const maxAcquisition = Math.max(...sortedData.map(ch => ch.acquisition));
            const maxPurchase = Math.max(...sortedData.map(ch => ch.purchase));
            const maxRevenue = Math.max(...sortedData.map(ch => ch.revenue));

            const normalizedData = sortedData.map(ch => {
                const normCVR = maxCVR > 0 ? (ch.cvr / maxCVR * 100) : 0;
                const normAcquisition = maxAcquisition > 0 ? (ch.acquisition / maxAcquisition * 100) : 0;
                const normPurchase = maxPurchase > 0 ? (ch.purchase / maxPurchase * 100) : 0;
                const normRevenue = maxRevenue > 0 ? (ch.revenue / maxRevenue * 100) : 0;

                // 균형도 계산 (표준편차 기반)
                const values = [normCVR, normAcquisition, normPurchase, normRevenue];
                const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / values.length;
                const balance = 100 - Math.sqrt(variance); // 높을수록 균형잡힘

                return {
                    ...ch,
                    normCVR,
                    normAcquisition,
                    normPurchase,
                    normRevenue,
                    avg,
                    balance
                };
            });

            // 채널 유형 분류
            const perfectChannels = normalizedData.filter(ch => ch.avg >= 60 && ch.balance >= 50); // 모든 지표 고르게 높음
            const efficientSmallChannels = normalizedData.filter(ch => ch.normCVR >= 70 && ch.normAcquisition < 50); // CVR 높지만 규모 작음
            const inefficientLargeChannels = normalizedData.filter(ch => ch.normAcquisition >= 70 && ch.normCVR < 50); // 규모 크지만 효율 낮음
            const lowPerformers = normalizedData.filter(ch => ch.avg < 40); // 모든 지표 낮음

            // 최고 균형 채널
            const mostBalanced = normalizedData.reduce((max, ch) => ch.balance > max.balance ? ch : max, normalizedData[0]);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 1. 최고 균형 채널
            if (perfectChannels.length > 0) {
                insightHTML += `<strong style="color: #4caf50;">🌟 완벽한 채널:</strong> `;
                insightHTML += `<strong>${perfectChannels[0].channel}</strong>이 효율과 규모를 모두 갖춘 최고의 채널입니다. `;
                insightHTML += `모든 지표(CVR, 방문자, 구매, 매출)가 균형있게 높습니다. 최우선 투자 대상입니다! `;
            } else {
                insightHTML += `<strong style="color: #9c27b0;">💎 가장 균형잡힌 채널:</strong> `;
                insightHTML += `<strong>${mostBalanced.channel}</strong>이 상대적으로 가장 균형잡혀 있습니다 (균형도: ${mostBalanced.balance.toFixed(0)}점). `;
            }

            // 2. 숨겨진 보석 (효율은 좋은데 규모가 작음)
            if (efficientSmallChannels.length > 0) {
                insightHTML += `<br><br><strong style="color: #2196f3;">💎 숨겨진 보석:</strong> `;
                const gems = efficientSmallChannels.slice(0, 2).map(ch => ch.channel).join(', ');
                insightHTML += `<strong>${gems}</strong>은 전환율이 우수하지만 방문자가 적습니다. `;
                insightHTML += `<strong>광고 예산을 늘려 규모를 키우면 큰 효과</strong>를 볼 수 있습니다! `;
            }

            // 3. 개선 필요 채널 (규모는 큰데 효율 낮음)
            if (inefficientLargeChannels.length > 0) {
                insightHTML += `<br><br><strong style="color: #ff9800;">⚠️ 개선 기회:</strong> `;
                insightHTML += `<strong>${inefficientLargeChannels[0].channel}</strong>은 방문자는 많지만 (${formatNumber(inefficientLargeChannels[0].acquisition)}명) `;
                insightHTML += `전환율이 ${inefficientLargeChannels[0].cvr.toFixed(2)}%로 낮습니다. `;
                insightHTML += `<strong>랜딩 페이지와 타겟팅을 개선하면 매출이 크게 증가</strong>할 수 있습니다! `;
            }

            // 4. 저성과 채널
            if (lowPerformers.length > 0) {
                insightHTML += `<br><br><strong style="color: #f44336;">❌ 저성과 채널:</strong> `;
                const lowChannels = lowPerformers.map(ch => ch.channel).join(', ');
                insightHTML += `<strong>${lowChannels}</strong>은 모든 지표가 낮습니다. `;
                insightHTML += `일시 중단을 검토하고 예산을 상위 채널로 재배분하세요. `;
            }

            // 5. 전체적인 포트폴리오 평가
            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 채널 포트폴리오:</strong> `;
            insightHTML += `상위 8개 채널 중 `;
            if (perfectChannels.length > 0) {
                insightHTML += `<strong>${perfectChannels.length}개가 완벽</strong>, `;
            }
            if (efficientSmallChannels.length > 0) {
                insightHTML += `<strong>${efficientSmallChannels.length}개가 확장 가능</strong>, `;
            }
            if (inefficientLargeChannels.length > 0) {
                insightHTML += `<strong>${inefficientLargeChannels.length}개가 개선 필요</strong>, `;
            }
            if (lowPerformers.length > 0) {
                insightHTML += `<strong>${lowPerformers.length}개가 저성과</strong> `;
            }
            insightHTML += `상태입니다.`;

            // 6. 실행 가능한 추천
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 우선순위 액션:</strong> `;
            if (perfectChannels.length > 0) {
                insightHTML += `1) <strong>${perfectChannels[0].channel}</strong> 예산 30-50% 증액, `;
            }
            if (efficientSmallChannels.length > 0) {
                insightHTML += `2) <strong>${efficientSmallChannels[0].channel}</strong> 타겟 확대로 방문자 늘리기, `;
            }
            if (inefficientLargeChannels.length > 0) {
                insightHTML += `3) <strong>${inefficientLargeChannels[0].channel}</strong> 랜딩 페이지 A/B 테스트 시작`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('compareChartInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 비교 차트 업데이트 (채널별 종합 성과)
        function updateCompareChart() {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('channelCompareChart');
            if (!ctx) return;

            if (channelCompareChart) {
                channelCompareChart.destroy();
            }

            // 그룹화된 차트 표시
            updateGroupedChart(ctx);

            // 비교 차트 데이터 분석 및 인사이트 생성
            analyzeCompareChartData(channelData);

            // 툴팁 이벤트 설정
            setupCompareChartTooltip();
        }

        // 비교 차트 툴팁 설정
        function setupCompareChartTooltip() {
            const canvas = document.getElementById('channelCompareChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateCompareInsight();
                    showChartInsightTooltip('compareChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('compareChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('compareChartTooltip');
                });
            }
        }


        // 그룹화된 막대 차트
        function updateGroupedChart(ctx) {
            // CVR 기준으로 정렬
            const sortedData = [...channelData].sort((a, b) =>
                (parseFloat(b['CVR']) || 0) - (parseFloat(a['CVR']) || 0)
            ).slice(0, 8);

            const labels = sortedData.map(row => row['channel']);

            // 정규화를 위한 최대값 계산
            const maxAcquisition = Math.max(...sortedData.map(row => parseFloat(row['유입']) || 0));
            const maxPurchase = Math.max(...sortedData.map(row => parseFloat(row['구매완료']) || 0));
            const maxRevenue = Math.max(...sortedData.map(row => parseFloat(row['Revenue']) || 0));

            // 원본 데이터 저장
            const originalData = sortedData.map(row => ({
                cvr: parseFloat(row['CVR']) || 0,
                acquisition: parseFloat(row['유입']) || 0,
                purchase: parseFloat(row['구매완료']) || 0,
                revenue: parseFloat(row['Revenue']) || 0
            }));

            // 호버 상태 추적
            let hoveredIndex = null;

            channelCompareChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'CVR (%)',
                            data: sortedData.map(row => parseFloat(row['CVR']) || 0),
                            backgroundColor: 'rgba(103, 58, 183, 0.8)',
                            borderColor: '#673ab7',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.cvr)
                        },
                        {
                            label: '유입 (정규화)',
                            data: sortedData.map(row => ((parseFloat(row['유입']) || 0) / maxAcquisition * 100)),
                            backgroundColor: 'rgba(33, 150, 243, 0.8)',
                            borderColor: '#2196f3',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.acquisition)
                        },
                        {
                            label: '구매완료 (정규화)',
                            data: sortedData.map(row => ((parseFloat(row['구매완료']) || 0) / maxPurchase * 100)),
                            backgroundColor: 'rgba(0, 200, 83, 0.8)',
                            borderColor: '#00c853',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.purchase)
                        },
                        {
                            label: '매출 (정규화)',
                            data: sortedData.map(row => ((parseFloat(row['Revenue']) || 0) / maxRevenue * 100)),
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: '#f44336',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.revenue)
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'y',
                        intersect: false
                    },
                    onHover: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            hoveredIndex = activeElements[0].index;
                        } else {
                            hoveredIndex = null;
                        }
                        this.update('none');
                    },
                    layout: {
                        padding: {
                            right: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const dataIndex = context.dataIndex;
                                    const originalValue = context.dataset.originalData[dataIndex];
                                    let label = context.dataset.label || '';

                                    if (label.includes('CVR')) {
                                        return label + ': ' + formatDecimal(originalValue) + '%';
                                    } else if (label.includes('유입')) {
                                        return '유입: ' + formatNumber(originalValue) + '명';
                                    } else if (label.includes('구매완료')) {
                                        return '구매완료: ' + formatNumber(originalValue) + '명';
                                    } else if (label.includes('매출')) {
                                        return '매출: ' + formatNumber(originalValue) + '원';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                // 호버된 채널(index)인 경우에만 표시
                                return context.dataIndex === hoveredIndex;
                            },
                            anchor: function(context) {
                                const dataIndex = context.dataIndex;
                                // 해당 채널의 모든 데이터셋 값 가져오기
                                const values = context.chart.data.datasets.map(ds => ds.data[dataIndex]);
                                const maxValue = Math.max(...values);
                                const currentValue = context.dataset.data[dataIndex];

                                // 최댓값인 경우에만 'end', 아니면 표시하지 않음
                                return currentValue === maxValue ? 'end' : 'center';
                            },
                            align: 'end',
                            offset: 4,
                            clamp: true,
                            formatter: function(value, context) {
                                const dataIndex = context.dataIndex;
                                const datasetIndex = context.datasetIndex;

                                // 해당 채널의 모든 데이터셋 값 가져오기
                                const values = context.chart.data.datasets.map(ds => ds.data[dataIndex]);
                                const maxValue = Math.max(...values);
                                const currentValue = context.dataset.data[dataIndex];

                                // 최댓값인 데이터셋만 레이블 표시
                                if (currentValue !== maxValue) {
                                    return null;
                                }

                                const originalValue = context.dataset.originalData[dataIndex];
                                const label = context.dataset.label || '';

                                if (label.includes('CVR')) {
                                    return formatDecimal(originalValue) + '%';
                                } else if (label.includes('유입')) {
                                    return formatNumber(originalValue) + '명';
                                } else if (label.includes('구매완료')) {
                                    return formatNumber(originalValue) + '명';
                                } else if (label.includes('매출')) {
                                    return formatNumber(originalValue) + '원';
                                }
                                return '';
                            },
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            color: function(context) {
                                return context.dataset.borderColor;
                            },
                            backgroundColor: function(context) {
                                return 'rgba(255, 255, 255, 0.9)';
                            },
                            borderColor: function(context) {
                                return context.dataset.borderColor;
                            },
                            borderWidth: 1,
                            borderRadius: 4,
                            padding: 4
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '정규화된 값 (0-100)'
                            }
                        }
                    }
                }
            });
        }

        // 캠페인 차트 업데이트
        function updateCampaignChart(funnelType = 'purchase') {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('campaignChart');
            if (!ctx) return;

            // 현재 퍼널 타입 저장
            currentChannelFunnel = funnelType;

            // 퍼널별 키 매핑
            const funnelKeyMap = {
                'activation': '활동',
                'consideration': '관심',
                'conversion': '결제진행',
                'purchase': '구매완료'
            };

            const funnelKey = funnelKeyMap[funnelType];

            // 각 채널의 전환율 계산 (유입 대비 해당 단계)
            const channelConversionData = channelData.map(row => {
                const acquisition = parseFloat(row['유입']) || 0;
                const funnelValue = parseFloat(row[funnelKey]) || 0;
                const conversionRate = acquisition > 0 ? (funnelValue / acquisition * 100) : 0;

                return {
                    channel: row['channel'],
                    conversionRate: conversionRate
                };
            });

            // 전환율 기준 상위 10개 정렬
            const sortedData = channelConversionData
                .sort((a, b) => b.conversionRate - a.conversionRate)
                .slice(0, 10);

            const labels = sortedData.map(row => {
                const name = row.channel;
                return name.length > 20 ? name.substring(0, 20) + '...' : name;
            });
            const conversionData = sortedData.map(row => row.conversionRate);

            if (campaignChart) {
                campaignChart.destroy();
            }

            // 퍼널별 색상 설정
            const colorMap = {
                'activation': { bg: 'rgba(33, 150, 243, 0.8)', border: '#2196f3' },
                'consideration': { bg: 'rgba(255, 152, 0, 0.8)', border: '#ff9800' },
                'conversion': { bg: 'rgba(76, 175, 80, 0.8)', border: '#4caf50' },
                'purchase': { bg: 'rgba(0, 200, 83, 0.8)', border: '#00c853' }
            };

            const colors = colorMap[funnelType];

            // 퍼널별 레이블
            const labelMap = {
                'activation': '활동 전환율 (%)',
                'consideration': '관심 전환율 (%)',
                'conversion': '결제진행 전환율 (%)',
                'purchase': '구매완료 전환율 (%)'
            };

            campaignChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: labelMap[funnelType],
                        data: conversionData,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return labelMap[funnelType] + ': ' + formatDecimal(context.parsed.x) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '전환율 (%)'
                            }
                        }
                    }
                }
            });
        }

        // [DEPRECATED] 신규 vs 재방문 차트 업데이트
        // 이 함수는 더 이상 사용되지 않습니다. updateCustomerTrendChart()로 통합되었습니다.
        /*
        function updateNewVsReturningChart() {
            if (newVsReturningData.length === 0) return;

            const ctx = document.getElementById('newVsReturningChart');
            if (!ctx) return;

            // 유입 퍼널만 필터링
            const acquisitionData = newVsReturningData.filter(row => row['funnel'] === '유입');

            let labels, newUserPct;

            if (newVsReturningView === 'daily') {
                // 일별 데이터
                labels = acquisitionData.map(row => row['Day']);
                newUserPct = acquisitionData.map(row => parseFloat(row['New user %']) || 0);
            } else if (newVsReturningView === 'weekly') {
                // 주별 데이터 - 주별로 그룹화하여 평균 계산
                const weeklyMap = new Map();

                acquisitionData.forEach(row => {
                    const date = new Date(row['Day']);
                    // 주의 시작일 (일요일) 계산
                    const dayOfWeek = date.getDay();
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - dayOfWeek);
                    const weekKey = weekStart.toISOString().split('T')[0];

                    if (!weeklyMap.has(weekKey)) {
                        weeklyMap.set(weekKey, {
                            totalUsers: 0,
                            newUsers: 0,
                            count: 0
                        });
                    }

                    const weekData = weeklyMap.get(weekKey);
                    weekData.totalUsers += parseFloat(row['Total users']) || 0;
                    weekData.newUsers += parseFloat(row['New users']) || 0;
                    weekData.count += 1;
                });

                // 주별 신규 사용자 비율 계산
                const weeklyData = Array.from(weeklyMap.entries())
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([week, data]) => ({
                        week,
                        newUserPct: data.totalUsers > 0 ? (data.newUsers / data.totalUsers * 100) : 0
                    }));

                labels = weeklyData.map(d => d.week);
                newUserPct = weeklyData.map(d => d.newUserPct);
            } else {
                // 월별 데이터 - 월별로 그룹화하여 평균 계산
                const monthlyMap = new Map();

                acquisitionData.forEach(row => {
                    const date = new Date(row['Day']);
                    // 월의 시작일 계산 (YYYY-MM 형식)
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyMap.has(monthKey)) {
                        monthlyMap.set(monthKey, {
                            totalUsers: 0,
                            newUsers: 0,
                            count: 0
                        });
                    }

                    const monthData = monthlyMap.get(monthKey);
                    monthData.totalUsers += parseFloat(row['Total users']) || 0;
                    monthData.newUsers += parseFloat(row['New users']) || 0;
                    monthData.count += 1;
                });

                // 월별 신규 사용자 비율 계산
                const monthlyData = Array.from(monthlyMap.entries())
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([month, data]) => ({
                        month,
                        newUserPct: data.totalUsers > 0 ? (data.newUsers / data.totalUsers * 100) : 0
                    }));

                labels = monthlyData.map(d => d.month);
                newUserPct = monthlyData.map(d => d.newUserPct);
            }

            if (newVsReturningChart) {
                newVsReturningChart.destroy();
            }

            newVsReturningChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: '신규 사용자 비율 (%)',
                        data: newUserPct,
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '신규 사용자 비율 (%)'
                            }
                        }
                    }
                }
            });
        }
        */

        // 채널 테이블 업데이트
        // 채널 테이블 데이터 자동 분석 함수
        function analyzeChannelTableData(data) {
            if (data.length === 0) return;

            // 데이터 파싱 및 계산
            const channelStats = data.map(row => {
                const acquisition = parseFloat(row['유입']) || 0;
                const activation = parseFloat(row['활동']) || 0;
                const consideration = parseFloat(row['관심']) || 0;
                const conversion = parseFloat(row['결제진행']) || 0;
                const purchase = parseFloat(row['구매완료']) || 0;
                const revenue = parseFloat(row['Revenue']) || 0;
                const cvr = parseFloat(row['CVR']) || 0;

                // 단계별 이탈률 계산
                const activationChurn = acquisition > 0 ? ((acquisition - activation) / acquisition * 100) : 0;
                const considerationChurn = activation > 0 ? ((activation - consideration) / activation * 100) : 0;
                const conversionChurn = consideration > 0 ? ((consideration - conversion) / consideration * 100) : 0;
                const purchaseChurn = conversion > 0 ? ((conversion - purchase) / conversion * 100) : 0;

                return {
                    channel: row['channel'],
                    acquisition,
                    activation,
                    consideration,
                    conversion,
                    purchase,
                    revenue,
                    cvr,
                    activationChurn,
                    considerationChurn,
                    conversionChurn,
                    purchaseChurn
                };
            });

            // CVR 상위 3개 채널
            const topCVRChannels = [...channelStats]
                .sort((a, b) => b.cvr - a.cvr)
                .slice(0, 3);

            // 매출 상위 채널
            const topRevenueChannels = [...channelStats]
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 3);

            // CVR 평균
            const avgCVR = channelStats.reduce((sum, ch) => sum + ch.cvr, 0) / channelStats.length;

            // 매출 높지만 CVR 낮은 채널 찾기 (매출 상위 50%, CVR 평균 이하)
            const revenueMedian = channelStats.sort((a, b) => b.revenue - a.revenue)[Math.floor(channelStats.length / 2)].revenue;
            const highRevenueLowCVR = channelStats.filter(ch => ch.revenue >= revenueMedian && ch.cvr < avgCVR);

            // 유입→활동 이탈률이 높은 채널 (50% 이상)
            const highEarlyChurn = channelStats.filter(ch => ch.activationChurn >= 50);

            // 전체 평균 이탈률
            const avgActivationChurn = channelStats.reduce((sum, ch) => sum + ch.activationChurn, 0) / channelStats.length;
            const avgConsiderationChurn = channelStats.reduce((sum, ch) => sum + ch.considerationChurn, 0) / channelStats.length;
            const avgConversionChurn = channelStats.reduce((sum, ch) => sum + ch.conversionChurn, 0) / channelStats.length;
            const avgPurchaseChurn = channelStats.reduce((sum, ch) => sum + ch.purchaseChurn, 0) / channelStats.length;

            // 가장 이탈률이 높은 단계 찾기
            const churnStages = [
                { stage: '유입→활동', avg: avgActivationChurn },
                { stage: '활동→관심', avg: avgConsiderationChurn },
                { stage: '관심→결제진행', avg: avgConversionChurn },
                { stage: '결제진행→구매완료', avg: avgPurchaseChurn }
            ];
            const highestChurnStage = churnStages.reduce((max, item) => item.avg > max.avg ? item : max, churnStages[0]);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 1. 최고 성과 채널
            insightHTML += `<strong style="color: #4caf50;">🏆 최고 성과 채널:</strong> `;
            insightHTML += `<strong>${topCVRChannels[0].channel}</strong> (CVR ${topCVRChannels[0].cvr.toFixed(2)}%)이 가장 효율적입니다. `;
            if (topCVRChannels[0].cvr > 3) {
                insightHTML += `매우 우수한 전환율입니다! 이 채널의 광고 예산을 늘리세요. `;
            } else if (topCVRChannels[0].cvr > 1.5) {
                insightHTML += `양호한 전환율입니다. 추가 투자를 고려하세요. `;
            }

            // 2. 매출 vs CVR 불균형
            if (highRevenueLowCVR.length > 0) {
                insightHTML += `<br><br><strong style="color: #ff9800;">⚠️ 개선 기회:</strong> `;
                insightHTML += `<strong>${highRevenueLowCVR[0].channel}</strong>은 매출은 높지만 (₩${formatNumber(highRevenueLowCVR[0].revenue)}) `;
                insightHTML += `CVR이 ${highRevenueLowCVR[0].cvr.toFixed(2)}%로 평균(${avgCVR.toFixed(2)}%)보다 낮습니다. `;
                insightHTML += `<strong>랜딩 페이지를 개선하면 매출을 크게 늘릴 수 있습니다!</strong> `;
            }

            // 3. 초기 이탈 문제
            if (highEarlyChurn.length > 0) {
                insightHTML += `<br><br><strong style="color: #f44336;">🚨 긴급 조치 필요:</strong> `;
                const worstChannel = highEarlyChurn.sort((a, b) => b.activationChurn - a.activationChurn)[0];
                insightHTML += `<strong>${worstChannel.channel}</strong>은 첫 단계(유입→활동)에서 ${worstChannel.activationChurn.toFixed(1)}%가 이탈합니다. `;
                insightHTML += `광고 메시지와 랜딩 페이지의 일치 여부, 로딩 속도를 즉시 점검하세요. `;
            } else {
                // 가장 이탈률 높은 단계 안내
                insightHTML += `<br><br><strong style="color: #2196f3;">📊 전체 분석:</strong> `;
                insightHTML += `전체 채널에서 <strong>${highestChurnStage.stage}</strong> 단계의 평균 이탈률이 ${highestChurnStage.avg.toFixed(1)}%로 가장 높습니다. `;
                insightHTML += `이 구간에 집중적으로 개선 노력을 기울이세요. `;
            }

            // 4. 실행 가능한 추천
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 오늘 바로 실행:</strong> `;
            if (topCVRChannels[0].cvr > avgCVR * 1.5) {
                insightHTML += `1) <strong>${topCVRChannels[0].channel}</strong> 광고비를 20-30% 증액하고, `;
            }
            if (highRevenueLowCVR.length > 0) {
                insightHTML += `2) <strong>${highRevenueLowCVR[0].channel}</strong>의 랜딩 페이지 A/B 테스트를 시작하고, `;
            }
            insightHTML += `3) CVR ${(avgCVR * 0.5).toFixed(2)}% 이하 채널은 일시 중단을 검토하세요.`;

            // 인사이트 표시
            const insightElement = document.getElementById('channelTableInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        function updateChannelTable() {
            if (channelData.length === 0) return;

            const tbody = document.getElementById('channelTableBody');
            if (!tbody) return;

            // 현재 정렬 기준으로 데이터 정렬
            const sortedData = [...channelData].sort((a, b) => {
                const aVal = parseFloat(a[channelTableSort.column]) || 0;
                const bVal = parseFloat(b[channelTableSort.column]) || 0;

                if (channelTableSort.direction === 'desc') {
                    return bVal - aVal;
                } else {
                    return aVal - bVal;
                }
            });

            // 각 열의 최대값 계산 (색상 스케일용)
            const maxValues = {
                '유입': Math.max(...channelData.map(r => parseFloat(r['유입']) || 0)),
                '활동': Math.max(...channelData.map(r => parseFloat(r['활동']) || 0)),
                '관심': Math.max(...channelData.map(r => parseFloat(r['관심']) || 0)),
                '결제진행': Math.max(...channelData.map(r => parseFloat(r['결제진행']) || 0)),
                '구매완료': Math.max(...channelData.map(r => parseFloat(r['구매완료']) || 0)),
                'Revenue': Math.max(...channelData.map(r => parseFloat(r['Revenue']) || 0)),
                'CVR': Math.max(...channelData.map(r => parseFloat(r['CVR']) || 0))
            };

            // 색상 스케일 계산 함수
            function getScaleWidth(value, maxValue) {
                if (maxValue === 0) return 0;
                return (value / maxValue) * 100;
            }

            tbody.innerHTML = sortedData.map(row => {
                const acqVal = parseFloat(row['유입']) || 0;
                const actVal = parseFloat(row['활동']) || 0;
                const conVal = parseFloat(row['관심']) || 0;
                const convVal = parseFloat(row['결제진행']) || 0;
                const purVal = parseFloat(row['구매완료']) || 0;
                const revVal = parseFloat(row['Revenue']) || 0;
                const cvrVal = parseFloat(row['CVR']) || 0;

                return `
                <tr>
                    <td>${row['channel']}</td>
                    <td class="has-bg">
                        <div class="cell-bg scale-acquisition" style="width: ${getScaleWidth(acqVal, maxValues['유입'])}%"></div>
                        <span>${formatNumber(acqVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-activation" style="width: ${getScaleWidth(actVal, maxValues['활동'])}%"></div>
                        <span>${formatNumber(actVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-consideration" style="width: ${getScaleWidth(conVal, maxValues['관심'])}%"></div>
                        <span>${formatNumber(conVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-conversion" style="width: ${getScaleWidth(convVal, maxValues['결제진행'])}%"></div>
                        <span>${formatNumber(convVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-purchase" style="width: ${getScaleWidth(purVal, maxValues['구매완료'])}%"></div>
                        <span>${formatNumber(purVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-revenue" style="width: ${getScaleWidth(revVal, maxValues['Revenue'])}%"></div>
                        <span>${formatNumber(revVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-cvr" style="width: ${getScaleWidth(cvrVal, maxValues['CVR'])}%"></div>
                        <span>${formatDecimal(cvrVal)}%</span>
                    </td>
                </tr>
                `;
            }).join('');

            // 데이터 분석 및 인사이트 생성
            analyzeChannelTableData(channelData);

            // 정렬 아이콘 업데이트
            updateSortIcons();
        }

        // 정렬 아이콘 상태 업데이트
        function updateSortIcons() {
            const headers = document.querySelectorAll('#channelTable .sortable-header');
            headers.forEach(th => {
                const column = th.getAttribute('data-column');
                const sortIcon = th.querySelector('.sort-icon');
                const upArrow = th.querySelector('.sort-arrow.up');
                const downArrow = th.querySelector('.sort-arrow.down');

                if (!sortIcon || !upArrow || !downArrow) return;

                if (column === channelTableSort.column) {
                    sortIcon.classList.add('active');
                    if (channelTableSort.direction === 'asc') {
                        upArrow.classList.add('active');
                        downArrow.classList.remove('active');
                    } else {
                        upArrow.classList.remove('active');
                        downArrow.classList.add('active');
                    }
                } else {
                    sortIcon.classList.remove('active');
                    upArrow.classList.remove('active');
                    downArrow.classList.remove('active');
                }
            });
        }

        // 테이블 정렬 이벤트 초기화
        function setupTableSorting() {
            const headers = document.querySelectorAll('#channelTable .sortable-header');

            headers.forEach(th => {
                // 기존 이벤트 리스너 제거 (중복 방지)
                const newTh = th.cloneNode(true);
                th.parentNode.replaceChild(newTh, th);
            });

            // 새로운 이벤트 리스너 추가
            document.querySelectorAll('#channelTable .sortable-header').forEach(th => {
                // 클릭 이벤트 (정렬)
                th.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const column = this.getAttribute('data-column');

                    // 같은 열을 클릭하면 방향 토글, 다른 열이면 desc로 시작
                    if (channelTableSort.column === column) {
                        channelTableSort.direction = channelTableSort.direction === 'desc' ? 'asc' : 'desc';
                    } else {
                        channelTableSort.column = column;
                        channelTableSort.direction = 'desc';
                    }

                    updateChannelTable();
                });

                // 마우스 호버 이벤트 (툴팁 위치 계산)
                const tooltip = th.querySelector('.sort-tooltip');
                if (tooltip) {
                    th.addEventListener('mouseenter', function() {
                        const rect = this.getBoundingClientRect();
                        tooltip.style.left = rect.left + (rect.width / 2) + 'px';
                        tooltip.style.top = (rect.top - 8) + 'px';
                    });
                }
            });
        }

        // 차트 인사이트 툴팁 표시 함수
        function showChartInsightTooltip(tooltipId, insight, recommendation, event) {
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;

            tooltip.innerHTML = `
                <div class="tooltip-insight-section">
                    <div class="tooltip-insight-header">
                        💡 인사이트
                    </div>
                    <p class="tooltip-insight-text">${insight}</p>
                </div>
                <div class="tooltip-recommendation-section">
                    <div class="tooltip-recommendation-header">
                        🎯 추천 사항
                    </div>
                    <p class="tooltip-recommendation-text">${recommendation}</p>
                </div>
            `;

            // position: fixed 사용 - 화면 기준 절대 좌표
            tooltip.style.left = (event.clientX + 15) + 'px';
            tooltip.style.top = (event.clientY + 15) + 'px';
            tooltip.classList.add('show');
        }

        function hideChartInsightTooltip(tooltipId) {
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;
            tooltip.classList.remove('show');
        }

        // KPI 차트 인사이트 생성
        function generateKpiInsight(kpiType, data) {
            const insights = {
                cvr: {
                    insight: '전환율(CVR)이 높은 채널은 방문자를 실제 고객으로 만드는 능력이 뛰어난 채널입니다. 예를 들어 100명이 방문해서 5명이 구매하면 5%입니다.',
                    recommendation: '전환율이 높은 채널에 광고비를 더 투자하세요. 반대로 전환율이 낮은 채널은 웹사이트 첫 화면을 고객 입장에서 개선해보세요. (예: 구매 버튼을 더 눈에 띄게 만들기)'
                },
                acquisition: {
                    insight: '방문자가 많은 채널은 많은 사람들이 우리 웹사이트를 찾아오는 경로입니다. 하지만 많다고 무조건 좋은 것은 아닙니다.',
                    recommendation: '방문자가 많은 채널의 전환율도 함께 확인하세요. 방문자는 많은데 구매는 적다면, 엉뚱한 사람들이 들어오고 있다는 뜻일 수 있습니다. 그럴 땐 광고 타겟을 더 정확하게 설정하세요.'
                },
                activation: {
                    insight: '활성 사용자가 많은 채널은 단순 방문이 아니라 실제로 우리 사이트를 이용하는 사람들을 많이 보내고 있습니다.',
                    recommendation: '활성 사용자가 많은 채널이 어떤 특징이 있는지 살펴보세요. 예를 들어 특정 연령대나 관심사를 가진 사람들이라면, 다른 채널에서도 그런 사람들을 타겟팅하세요.'
                },
                consideration: {
                    insight: '관심 고객이 많은 채널은 구매 의향이 높은 좋은 품질의 방문자를 보내고 있습니다.',
                    recommendation: '관심은 보였지만 구매하지 않은 사람들에게 재방문 광고를 하면 효과적입니다. 또한 제품 사진과 설명을 더 자세하게 개선하세요.'
                },
                conversion: {
                    insight: '결제를 시도한 사람이 많다는 것은 거의 구매 직전까지 갔다는 의미입니다. 이들을 놓치는 것은 큰 손실입니다.',
                    recommendation: '결제 과정을 최대한 간단하게 만드세요. (예: 회원가입 없이 구매 가능, 배송비 조기 안내) 장바구니에 물건을 담고 떠난 사람에게 "아직 장바구니에 물건이 남아있어요" 같은 알림을 보내세요.'
                },
                purchase: {
                    insight: '실제 구매 건수가 많은 채널이 진짜 돈을 벌어다 주는 채널입니다. 이 채널들이 가장 중요합니다.',
                    recommendation: '구매가 많은 채널에 광고비를 우선적으로 투자하세요. 또한 이 채널을 통해 구매한 고객들이 재구매를 얼마나 하는지도 추적하면 더 좋습니다.'
                },
                revenue: {
                    insight: '매출이 높은 채널은 투자 대비 수익이 가장 좋은 채널입니다. 여기서 번 돈으로 다른 채널 실험도 할 수 있습니다.',
                    recommendation: '이 채널이 왜 성공했는지 분석하세요. (어떤 상품? 어떤 광고 문구? 어떤 고객층?) 그리고 비슷한 방식으로 새로운 채널을 시도해보세요.'
                }
            };

            return insights[kpiType] || { insight: '데이터 분석 중입니다.', recommendation: '지속적으로 성과를 모니터링하세요.' };
        }

        // 이탈률 차트 인사이트 생성
        function generateChurnInsight() {
            return {
                insight: '채널 이탈률을 개선하면 전환율이 높아지고 매출이 증가합니다.',
                recommendation: '이탈률이 높은 채널일수록 개선 여지가 크다는 뜻입니다. 그 단계를 집중적으로 개선하면 효과가 큽니다.'
            };
        }

        // 비교 차트 인사이트 생성
        function generateCompareInsight() {
            return {
                insight: '각 채널의 전환율(CVR), 고객 유입, 구매 건수, 매출을 100점 만점으로 환산하여 비교합니다. 모든 지표가 골고루 높은 채널이 가장 균형있는 성과를 내고 있습니다.',
                recommendation: '한 가지 지표만 좋은 채널은 개선 여지가 있습니다. 예를 들어, 유입은 많은데 전환율이 낮다면 고객 타게팅을 개선해야 합니다. 전환율은 높은데 매출이 낮다면 고가 상품 판매를 늘려야 합니다.'
            };
        }

        // 차트에 호버 이벤트 추가
        function addChartHoverTooltip(canvasId, tooltipId, insightGenerator) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            canvas.addEventListener('mousemove', function(event) {
                const insight = insightGenerator();
                showChartInsightTooltip(tooltipId, insight.insight, insight.recommendation, event);
            });

            canvas.addEventListener('mouseleave', function() {
                hideChartInsightTooltip(tooltipId);
            });
        }

        // 퍼널 뷰 타입 전환 - 제거됨 (항상 daily 데이터 사용)

        // 신규 vs 재방문 차트 뷰 타입 전환 (독립적)
        document.querySelectorAll('.new-vs-returning-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.dataset.view;
                console.log(`[신규 vs 재방문] 뷰 전환: ${newVsReturningView} → ${view}`);

                // 같은 그룹 내 버튼만 active 제거
                document.querySelectorAll('.new-vs-returning-view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                newVsReturningView = view;

                // 신규 vs 재방문 관련 차트들 업데이트 (다른 섹션에 영향 없음)
                updateCustomerTrendChart();
            });
        });

        // 이탈 위험 기간 전환 (7일/30일) - 독립적
        document.querySelectorAll('.churn-period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const period = this.dataset.period;
                console.log(`[이탈 위험] 기간 전환: ${period}`);

                document.querySelectorAll('.churn-period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateChurnPredictions(period);
            });
        });

        // 성과 개선 기간 전환 (7일/30일) - 독립적
        document.querySelectorAll('.improvement-period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const period = this.dataset.period;
                console.log(`[성과 개선] 기간 전환: ${period}`);

                document.querySelectorAll('.improvement-period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateImprovementPredictions(period);
            });
        });

        // KPI 차트 버튼 전환 - 독립적
        document.querySelectorAll('.channel-kpi-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const kpiType = this.dataset.kpi;
                console.log(`[KPI 차트] 타입 전환: ${kpiType}`);

                document.querySelectorAll('.channel-kpi-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateKpiChart(kpiType);
            });
        });

        // 이탈률 차트 퍼널 단계 버튼 전환
        document.querySelectorAll('.channel-churn-stage-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const stage = this.dataset.stage;
                console.log(`[이탈률 차트] 퍼널 단계 전환: ${stage}`);

                document.querySelectorAll('.channel-churn-stage-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateChurnChart(stage, null);
            });
        });

        // 이탈률 차트 정렬 순서 버튼 전환
        document.querySelectorAll('.channel-churn-sort-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const sort = this.dataset.sort;
                console.log(`[이탈률 차트] 정렬 순서 전환: ${sort}`);

                document.querySelectorAll('.channel-churn-sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateChurnChart(null, sort);
            });
        });

        // 채널 퍼널 차트 버튼 전환 - 독립적
        document.querySelectorAll('.channel-funnel-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const funnelType = this.dataset.funnel;
                console.log(`[채널 퍼널] 타입 전환: ${funnelType}`);

                document.querySelectorAll('.channel-funnel-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateCampaignChart(funnelType);
            });
        });

        // 퍼널 비교 기능
        let isCompareMode = false;
        let leftFunnelData = null;
        let rightFunnelData = null;

        // 날짜 범위 가져오기
        function getDateRange(data) {
            console.log('=== getDateRange 시작 ===');

            if (data.length === 0) {
                console.warn('데이터가 비어있습니다.');
                return { start: '', end: '' };
            }

            console.log(`전체 데이터 행 수: ${data.length}`);

            // 날짜 필드 추출
            const dateStrings = data
                .map(row => row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'])
                .filter(d => d);

            console.log(`추출된 날짜 문자열: ${dateStrings.length}개`);

            if (dateStrings.length === 0) {
                console.warn('날짜 필드를 찾을 수 없습니다.');
                return { start: '', end: '' };
            }

            // Date 객체로 변환 후 정렬
            const sortedDates = dateStrings
                .map(dateStr => new Date(dateStr))
                .filter(date => !isNaN(date.getTime()))
                .sort((a, b) => a - b)
                .map(date => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                });

            console.log(`정렬된 날짜: ${sortedDates.length}개`);
            console.log(`시작 날짜: ${sortedDates[0]}`);
            console.log(`종료 날짜: ${sortedDates[sortedDates.length - 1]}`);
            console.log('=== getDateRange 완료 ===\n');

            return {
                start: sortedDates[0],
                end: sortedDates[sortedDates.length - 1]
            };
        }

        // 날짜 범위로 데이터 필터링 (Date 객체 기반 비교)
        function filterDataByDateRange(data, startDate, endDate) {
            if (!startDate || !endDate) {
                console.warn('filterDataByDateRange: 시작일 또는 종료일이 없습니다', { startDate, endDate });
                return [];
            }

            // 날짜 문자열을 Date 객체로 변환
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.error('filterDataByDateRange: 유효하지 않은 날짜 형식', { startDate, endDate });
                return [];
            }

            const filtered = data.filter(row => {
                const dateStr = row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'];
                if (!dateStr) return false;

                // 날짜 문자열을 Date 객체로 변환
                const rowDate = new Date(dateStr);

                if (isNaN(rowDate.getTime())) {
                    console.warn('filterDataByDateRange: 유효하지 않은 행 날짜', dateStr);
                    return false;
                }

                // Date 객체 기반 비교
                return rowDate >= start && rowDate <= end;
            });

            console.log(`filterDataByDateRange: ${startDate} ~ ${endDate} 필터링 결과: ${filtered.length}개 (전체: ${data.length}개)`);

            return filtered;
        }

        // 퍼널 데이터 계산
        function calculateFunnelData(data) {
            if (data.length === 0) return [];

            const baseColor = '#535A8C';
            const funnelStages = [
                { name: '유입', key: '유입', color: baseColor },
                { name: '활동', key: '활동', color: baseColor },
                { name: '관심', key: '관심', color: baseColor },
                { name: '결제진행', key: '결제진행', color: baseColor },
                { name: '구매완료', key: '구매완료', color: baseColor }
            ];

            return funnelStages.map((stage, index) => {
                const total = data.reduce((sum, row) => sum + (parseFloat(row[stage.key]) || 0), 0);
                const prevTotal = index > 0 ? data.reduce((sum, row) => sum + (parseFloat(row[funnelStages[index - 1].key]) || 0), 0) : total;
                const conversionRate = prevTotal > 0 ? (total / prevTotal * 100) : 100;
                const dropOffRate = prevTotal > 0 ? ((prevTotal - total) / prevTotal * 100) : 0;

                return {
                    ...stage,
                    total: Math.round(total),
                    conversionRate: conversionRate.toFixed(1),
                    dropOffRate: dropOffRate.toFixed(1),
                    index: index
                };
            });
        }

        // 작은 퍼널 렌더링 (비교용)
        function renderSmallFunnel(containerId, funnelData) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // 기존 SVG 완전 제거 (잔상 방지)
            container.innerHTML = '';

            // 데이터 유효성 검증
            if (!funnelData || funnelData.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">선택한 기간의 데이터가 없습니다</div>';
                return;
            }

            // 데이터가 너무 적은지 확인
            const totalUsers = funnelData[0]?.total || 0;
            if (totalUsers === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">선택한 기간에 유입 데이터가 없습니다</div>';
                return;
            }

            const margin = { top: 10, right: 20, bottom: 10, left: 20 };
            const width = 400;
            const height = 450 - margin.top - margin.bottom;

            const svg = d3.select(`#${containerId}`)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const maxValue = d3.max(funnelData, d => d.total);
            if (!maxValue || maxValue === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">데이터 값이 유효하지 않습니다</div>';
                return;
            }

            const stageHeight = height / funnelData.length;
            const spacing = 8;

            funnelData.forEach((stage, i) => {
                const stageColor = d3.color(stage.color).darker(i * 0.25);
                const yPos = i * stageHeight;
                const topWidth = (stage.total / maxValue) * width;
                const bottomWidth = i < funnelData.length - 1
                    ? (funnelData[i + 1].total / maxValue) * width
                    : topWidth * 0.8;

                const xOffset = (width - topWidth) / 2;
                const xOffsetBottom = (width - bottomWidth) / 2;

                const group = svg.append('g')
                    .attr('class', 'funnel-stage-small');

                // 그라데이션
                const gradientId = `gradient-small-${containerId}-${i}`;
                const gradient = svg.append('defs')
                    .append('linearGradient')
                    .attr('id', gradientId)
                    .attr('x1', '0%')
                    .attr('y1', '0%')
                    .attr('x2', '0%')
                    .attr('y2', '100%');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 1);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 0.75);

                // 트라페즈이드
                const path = `
                    M ${xOffset} ${yPos}
                    L ${xOffset + topWidth} ${yPos}
                    L ${xOffsetBottom + bottomWidth} ${yPos + stageHeight - spacing}
                    L ${xOffsetBottom} ${yPos + stageHeight - spacing}
                    Z
                `;

                group.append('path')
                    .attr('d', path)
                    .attr('fill', `url(#${gradientId})`)
                    .attr('stroke', stageColor)
                    .attr('stroke-width', 1.5)
                    .attr('opacity', 0.85);

                // 텍스트
                group.append('text')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 - 5)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'white')
                    .style('font-size', '11px')
                    .style('font-weight', '600')
                    .text(stage.name);

                group.append('text')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 + 10)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'white')
                    .style('font-size', '10px')
                    .style('font-weight', '600')
                    .text(stage.total.toLocaleString() + ' users');

                // 전환율/이탈률
                if (i > 0) {
                    const metricsGroup = group.append('text')
                        .attr('x', width / 2)
                        .attr('y', yPos + stageHeight / 2 + 24)
                        .attr('text-anchor', 'middle')
                        .style('font-size', '9px');

                    metricsGroup.append('tspan')
                        .style('fill', '#4ade80')
                        .style('font-weight', '600')
                        .text(`전환 ${stage.conversionRate}%`);

                    metricsGroup.append('tspan')
                        .style('fill', 'white')
                        .text(' | ');

                    metricsGroup.append('tspan')
                        .style('fill', '#f87171')
                        .style('font-weight', '600')
                        .text(`이탈 ${stage.dropOffRate}%`);
                }
            });
        }

        // 비교 인사이트 계산 및 표시 (5단계 모두 비교)
        function updateComparisonInsights() {
            console.log('=== updateComparisonInsights 시작 ===');

            if (!leftFunnelData || !rightFunnelData) {
                console.warn('퍼널 데이터가 없습니다.');
                return;
            }

            if (leftFunnelData.length === 0 || rightFunnelData.length === 0) {
                console.warn('퍼널 데이터가 비어있습니다.');
                return;
            }

            // 단계별 아이콘 매핑
            const stageIcons = {
                '유입': '👥',
                '활동': '🔥',
                '관심': '❤️',
                '결제진행': '🛒',
                '구매완료': '✅'
            };

            const insights = [];

            // 5단계 모두 비교
            console.log('5단계 비교 시작...');
            for (let i = 0; i < leftFunnelData.length; i++) {
                const leftValue = leftFunnelData[i].total;
                const rightValue = rightFunnelData[i].total;
                const changePercent = ((rightValue - leftValue) / leftValue * 100).toFixed(1);
                const changeNum = parseFloat(changePercent);
                const changeColor = changeNum > 0 ? '#10b981' : (changeNum < 0 ? '#ef4444' : '#6b7280');
                const changeIcon = changeNum > 0 ? '▲' : (changeNum < 0 ? '▼' : '━');

                // 단계명에서 영문 제거 (예: '유입 (Acquisition)' -> '유입')
                const stageName = leftFunnelData[i].name.split(' (')[0];
                const stageIcon = stageIcons[stageName] || '📊';

                console.log(`  [${i}] ${stageName}: ${leftValue} → ${rightValue} (${changePercent}%)`);

                insights.push(`
                    <div style="padding: 10px; background: white; border-radius: 6px; border-left: 3px solid ${changeColor};">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-800);">
                                ${stageIcon} ${stageName}
                            </div>
                            <div style="font-size: 12px; font-weight: 700; color: ${changeColor};">
                                ${changeIcon} ${changeNum > 0 ? '+' : ''}${changePercent}%
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--grey-500); line-height: 1.4;">
                            ${leftValue.toLocaleString()} → ${rightValue.toLocaleString()}
                        </div>
                    </div>
                `);
            }

            console.log(`인사이트 ${insights.length}개 생성 완료`);

            // 그리드 레이아웃으로 표시 (2열, 모바일에선 1열)
            document.getElementById('comparisonContent').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                    ${insights.join('')}
                </div>
            `;

            console.log('=== updateComparisonInsights 완료 ===\n');
        }

        // 비교 모드 전환
        document.getElementById('funnelCompareBtn').addEventListener('click', function() {
            console.log('=== 비교 모드 시작 ===');

            // 항상 daily 데이터 사용
            const data = dailyData;
            console.log(`일별 데이터: ${data.length}개`);

            if (data.length === 0) {
                alert('데이터를 불러오는 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            isCompareMode = true;
            document.getElementById('singleFunnelView').style.display = 'none';
            document.getElementById('compareFunnelView').style.display = 'block';

            // 모든 날짜 추출 및 정렬 (Date 객체 기반)
            const allDateStrings = data
                .map(row => row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'])
                .filter(d => d);

            if (allDateStrings.length === 0) {
                alert('날짜 정보를 찾을 수 없습니다.');
                isCompareMode = false;
                document.getElementById('singleFunnelView').style.display = 'block';
                document.getElementById('compareFunnelView').style.display = 'none';
                return;
            }

            // 날짜 문자열을 Date 객체로 변환하여 정렬
            const sortedDates = allDateStrings
                .map(dateStr => new Date(dateStr))
                .filter(date => !isNaN(date.getTime()))
                .sort((a, b) => a - b)
                .map(date => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                });

            console.log('정렬된 날짜:', sortedDates.length, '개');
            console.log('첫 번째 날짜:', sortedDates[0]);
            console.log('마지막 날짜:', sortedDates[sortedDates.length - 1]);

            const midPoint = Math.floor(sortedDates.length / 2);

            // 기본값: 전반부 vs 후반부
            const leftStart = sortedDates[0];
            const leftEnd = sortedDates[midPoint - 1] || sortedDates[0];
            const rightStart = sortedDates[midPoint] || sortedDates[0];
            const rightEnd = sortedDates[sortedDates.length - 1];

            console.log('설정할 날짜 범위:');
            console.log('왼쪽:', leftStart, '~', leftEnd);
            console.log('오른쪽:', rightStart, '~', rightEnd);

            document.getElementById('leftStartDate').value = leftStart;
            document.getElementById('leftEndDate').value = leftEnd;
            document.getElementById('rightStartDate').value = rightStart;
            document.getElementById('rightEndDate').value = rightEnd;

            console.log('비교 퍼널 업데이트 호출...');
            updateCompareFunnels();
        });

        // 단일 뷰로 돌아가기
        document.getElementById('closeFunnelCompare').addEventListener('click', function() {
            isCompareMode = false;
            document.getElementById('singleFunnelView').style.display = 'block';
            document.getElementById('compareFunnelView').style.display = 'none';

            // 단일 뷰 차트 다시 렌더링
            updateFunnelChart();
        });

        // 날짜 변경 시 업데이트 (디바운싱 적용)
        let updateTimeout = null;
        ['leftStartDate', 'leftEndDate', 'rightStartDate', 'rightEndDate'].forEach(id => {
            const element = document.getElementById(id);

            // change 이벤트 (날짜 선택 완료 시)
            element.addEventListener('change', function() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateCompareFunnels();
                }, 300); // 300ms 디바운스
            });

            // input 이벤트 (실시간 입력 중)
            element.addEventListener('input', function() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateCompareFunnels();
                }, 500); // 500ms 디바운스
            });
        });

        // 비교 퍼널 업데이트
        function updateCompareFunnels() {
            console.log('=== updateCompareFunnels 시작 ===');

            // 항상 daily 데이터 사용
            const data = dailyData;
            console.log(`일별 데이터: ${data.length}개`);

            // 데이터가 없으면 화면 초기화
            if (data.length === 0) {
                console.warn('데이터가 없습니다.');
                document.getElementById('d3FunnelChartLeft').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">데이터를 불러오는 중...</div>';
                document.getElementById('d3FunnelChartRight').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">데이터를 불러오는 중...</div>';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }

            const leftStart = document.getElementById('leftStartDate').value;
            const leftEnd = document.getElementById('leftEndDate').value;
            const rightStart = document.getElementById('rightStartDate').value;
            const rightEnd = document.getElementById('rightEndDate').value;

            console.log('선택된 날짜:', {
                '왼쪽 시작': leftStart,
                '왼쪽 종료': leftEnd,
                '오른쪽 시작': rightStart,
                '오른쪽 종료': rightEnd
            });

            // 날짜가 설정되지 않았으면 화면 초기화
            if (!leftStart || !leftEnd || !rightStart || !rightEnd) {
                console.warn('날짜 값이 설정되지 않았습니다.');
                document.getElementById('d3FunnelChartLeft').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">날짜를 선택해주세요</div>';
                document.getElementById('d3FunnelChartRight').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">날짜를 선택해주세요</div>';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }

            // 날짜 유효성 검사 (양쪽 모두 초기화)
            if (leftStart > leftEnd) {
                console.error('왼쪽 날짜 오류: 시작일이 종료일보다 늦습니다');
                document.getElementById('d3FunnelChartLeft').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--error-main); font-size: 13px;">시작일이 종료일보다 늦습니다</div>';
                document.getElementById('d3FunnelChartRight').innerHTML = '';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }
            if (rightStart > rightEnd) {
                console.error('오른쪽 날짜 오류: 시작일이 종료일보다 늦습니다');
                document.getElementById('d3FunnelChartLeft').innerHTML = '';
                document.getElementById('d3FunnelChartRight').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--error-main); font-size: 13px;">시작일이 종료일보다 늦습니다</div>';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }

            console.log('날짜 필터링 시작...');
            const leftData = filterDataByDateRange(data, leftStart, leftEnd);
            const rightData = filterDataByDateRange(data, rightStart, rightEnd);

            console.log('퍼널 데이터 계산 시작...');
            leftFunnelData = calculateFunnelData(leftData);
            rightFunnelData = calculateFunnelData(rightData);

            console.log('왼쪽 퍼널 데이터:', leftFunnelData.length > 0 ? leftFunnelData[0] : '없음');
            console.log('오른쪽 퍼널 데이터:', rightFunnelData.length > 0 ? rightFunnelData[0] : '없음');

            // 항상 렌더링 시도 (renderSmallFunnel 내부에서 데이터 검증)
            console.log('렌더링 시작...');
            renderSmallFunnel('d3FunnelChartLeft', leftFunnelData);
            renderSmallFunnel('d3FunnelChartRight', rightFunnelData);

            // 양쪽 데이터가 모두 유효할 때만 비교 인사이트 표시
            if (leftFunnelData.length > 0 && rightFunnelData.length > 0 &&
                leftFunnelData[0]?.total > 0 && rightFunnelData[0]?.total > 0) {
                console.log('비교 인사이트 표시');
                updateComparisonInsights();
            } else {
                console.warn('비교할 데이터가 충분하지 않음');
                document.getElementById('comparisonContent').innerHTML = '<div style="text-align: center; color: var(--grey-500); padding: 20px;">비교할 데이터가 충분하지 않습니다</div>';
            }

            console.log('=== updateCompareFunnels 완료 ===\n');
        }

        // 접기/펼치기 기능
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const icon = this.querySelector('.collapsible-toggle-icon');
                const toggleText = this.querySelector('.collapsible-toggle span:first-child');

                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.classList.add('collapsed');
                    toggleText.textContent = '펼치기';
                } else {
                    content.classList.add('expanded');
                    icon.classList.remove('collapsed');
                    toggleText.textContent = '접기';
                }
            });
        });

        // iframe에서 로드되었는지 확인하고 사이드바 숨기기
        function checkIframeAndHideSidebar() {
            if (window.self !== window.top) {
                // iframe 내부에서 실행 중
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');

                if (sidebar) {
                    sidebar.style.display = 'none';
                }

                if (mainContent) {
                    mainContent.style.marginLeft = '0';
                }
            }
        }

        // 페이지 로드시 실행
        // 버튼 상태 확인 함수 (디버깅용)
        function checkButtonStates() {
            console.log('========================================');
            console.log('=== 버튼 상태 확인 ===');
            console.log('========================================');

            const buttonGroups = [
                { name: '신규 vs 재방문 버튼', selector: '.new-vs-returning-view-btn' },
                { name: '이탈 위험 버튼', selector: '.churn-period-btn' },
                { name: '성과 개선 버튼', selector: '.improvement-period-btn' },
                { name: 'KPI 차트 버튼', selector: '.channel-kpi-btn' },
                { name: '이탈률 퍼널 단계 버튼', selector: '.channel-churn-stage-btn' },
                { name: '이탈률 정렬 버튼', selector: '.channel-churn-sort-btn' },
                { name: '채널 퍼널 버튼', selector: '.channel-funnel-btn' }
            ];

            buttonGroups.forEach(group => {
                const buttons = document.querySelectorAll(group.selector);
                const activeButtons = Array.from(buttons).filter(b => b.classList.contains('active'));

                console.log(`\n[${group.name}]`);
                console.log(`  총 버튼 수: ${buttons.length}`);
                console.log(`  활성화된 버튼: ${activeButtons.length}`);

                if (activeButtons.length > 0) {
                    activeButtons.forEach(btn => {
                        const view = btn.dataset.view || btn.dataset.kpi || btn.dataset.funnel || btn.dataset.period;
                        console.log(`  - "${btn.textContent.trim()}" (${view})`);
                    });
                }
            });

            console.log('\n========================================\n');
        }

        // ========================================
        // 새로운 차트 렌더링 함수들
        // ========================================

        // [DEPRECATED] 1. 재방문율 추세 차트
        // 이 함수는 더 이상 사용되지 않습니다. updateCustomerTrendChart()로 통합되었습니다.
        /*
        function updateReturnRateTrendChart() {
            if (newVsReturningData.length === 0) return;

            const canvas = document.getElementById('returnRateTrendChart');
            if (!canvas) return;

            // 유입 단계만 필터링
            const acquisitionData = newVsReturningData.filter(row => row['funnel'] === '유입');

            // 날짜별로 정렬
            const sortedData = acquisitionData.sort((a, b) => {
                const dateA = new Date(a['Day']);
                const dateB = new Date(b['Day']);
                return dateA - dateB;
            });

            // 현재 선택된 뷰에 따라 데이터 집계
            let aggregatedData = [];

            if (newVsReturningView === 'monthly') {
                // 월별 집계
                const monthlyMap = {};
                sortedData.forEach(row => {
                    const date = new Date(row['Day']);
                    const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyMap[month]) {
                        monthlyMap[month] = {
                            totalUsers: 0,
                            newUsers: 0,
                            returningUsers: 0
                        };
                    }

                    monthlyMap[month].totalUsers += parseFloat(row['Total users']) || 0;
                    monthlyMap[month].newUsers += parseFloat(row['New users']) || 0;
                    monthlyMap[month].returningUsers += parseFloat(row['Returning users']) || 0;
                });

                aggregatedData = Object.entries(monthlyMap).map(([month, data]) => ({
                    label: month,
                    returnRate: ((data.returningUsers / data.totalUsers) * 100).toFixed(2)
                }));
            } else if (newVsReturningView === 'weekly') {
                // 주별 집계 (간단하게 7일씩 묶음)
                for (let i = 0; i < sortedData.length; i += 7) {
                    const weekData = sortedData.slice(i, i + 7);
                    const totalUsers = weekData.reduce((sum, row) => sum + (parseFloat(row['Total users']) || 0), 0);
                    const returningUsers = weekData.reduce((sum, row) => sum + (parseFloat(row['Returning users']) || 0), 0);
                    const firstDate = new Date(weekData[0]['Day']);
                    const weekLabel = `${firstDate.getFullYear()}-${String(firstDate.getMonth() + 1).padStart(2, '0')}-${String(firstDate.getDate()).padStart(2, '0')}`;

                    aggregatedData.push({
                        label: weekLabel,
                        returnRate: ((returningUsers / totalUsers) * 100).toFixed(2)
                    });
                }
            } else {
                // 일별 (기본)
                aggregatedData = sortedData.map(row => ({
                    label: row['Day'],
                    returnRate: (100 - parseFloat(row['New user %'])).toFixed(2)
                }));
            }

            if (returnRateTrendChart) {
                returnRateTrendChart.destroy();
            }

            returnRateTrendChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: aggregatedData.map(d => d.label),
                    datasets: [{
                        label: '재방문율 (%)',
                        data: aggregatedData.map(d => d.returnRate),
                        borderColor: '#673ab7',
                        backgroundColor: 'rgba(103, 58, 183, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `재방문율: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        */

        // 통합 신규/재방문 추세 차트
        function updateCustomerTrendChart() {
            if (newVsReturningData.length === 0) return;

            const canvas = document.getElementById('customerTrendChart');
            if (!canvas) return;

            // 유입 단계만 필터링
            const acquisitionData = newVsReturningData.filter(row => row['funnel'] === '유입');

            // 날짜별로 정렬
            const sortedData = acquisitionData.sort((a, b) => {
                const dateA = new Date(a['Day']);
                const dateB = new Date(b['Day']);
                return dateA - dateB;
            });

            // 현재 선택된 뷰에 따라 데이터 집계
            let aggregatedData = [];

            if (newVsReturningView === 'monthly') {
                // 월별 집계
                const monthlyMap = {};
                sortedData.forEach(row => {
                    const date = new Date(row['Day']);
                    const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyMap[month]) {
                        monthlyMap[month] = {
                            totalUsers: 0,
                            newUsers: 0,
                            returningUsers: 0
                        };
                    }

                    monthlyMap[month].totalUsers += parseFloat(row['Total users']) || 0;
                    monthlyMap[month].newUsers += parseFloat(row['New users']) || 0;
                    monthlyMap[month].returningUsers += parseFloat(row['Returning users']) || 0;
                });

                aggregatedData = Object.entries(monthlyMap).map(([month, data]) => ({
                    label: month,
                    newUserPct: ((data.newUsers / data.totalUsers) * 100).toFixed(2),
                    returnRate: ((data.returningUsers / data.totalUsers) * 100).toFixed(2)
                }));
            } else if (newVsReturningView === 'weekly') {
                // 주별 집계
                const weeklyMap = new Map();

                sortedData.forEach(row => {
                    const date = new Date(row['Day']);
                    const dayOfWeek = date.getDay();
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - dayOfWeek);
                    const weekKey = weekStart.toISOString().split('T')[0];

                    if (!weeklyMap.has(weekKey)) {
                        weeklyMap.set(weekKey, {
                            totalUsers: 0,
                            newUsers: 0,
                            returningUsers: 0
                        });
                    }

                    const weekData = weeklyMap.get(weekKey);
                    weekData.totalUsers += parseFloat(row['Total users']) || 0;
                    weekData.newUsers += parseFloat(row['New users']) || 0;
                    weekData.returningUsers += parseFloat(row['Returning users']) || 0;
                });

                aggregatedData = Array.from(weeklyMap.entries())
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([week, data]) => ({
                        label: week,
                        newUserPct: data.totalUsers > 0 ? ((data.newUsers / data.totalUsers) * 100).toFixed(2) : 0,
                        returnRate: data.totalUsers > 0 ? ((data.returningUsers / data.totalUsers) * 100).toFixed(2) : 0
                    }));
            } else {
                // 일별 (기본)
                aggregatedData = sortedData.map(row => ({
                    label: row['Day'],
                    newUserPct: parseFloat(row['New user %']).toFixed(2),
                    returnRate: (100 - parseFloat(row['New user %'])).toFixed(2)
                }));
            }

            if (customerTrendChart) {
                customerTrendChart.destroy();
            }

            customerTrendChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: aggregatedData.map(d => d.label),
                    datasets: [
                        {
                            label: '신규 고객 비율 (%)',
                            data: aggregatedData.map(d => d.newUserPct),
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: '재방문율 (%)',
                            data: aggregatedData.map(d => d.returnRate),
                            borderColor: '#673ab7',
                            backgroundColor: 'rgba(103, 58, 183, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: '비율 (%)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // 툴팁 설정
            setupCustomerTrendTooltip();
        }

        // 통합 고객 추세 차트 인사이트 생성
        function generateCustomerTrendInsight() {
            return {
                insight: '신규 고객 비율과 재방문율의 균형을 확인하세요. 신규 비율이 높으면 성장 중이며, 재방문율이 높으면 충성도가 높습니다.',
                recommendation: '이상적으로는 꾸준한 신규 유입(30-40%)과 높은 재방문율(60-70%)을 유지하는 것이 좋습니다. 두 지표가 함께 성장하는 것이 건강한 비즈니스의 신호입니다.'
            };
        }

        // 통합 고객 추세 차트 툴팁 설정
        function setupCustomerTrendTooltip() {
            const canvas = document.getElementById('customerTrendChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateCustomerTrendInsight();
                    showChartInsightTooltip('customerTrendTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('customerTrendTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('customerTrendTooltip');
                });
            }
        }

        // 2. 신규 vs 재방문 고객 전환율 비교 차트
        function updateNewVsReturningConversionChart() {
            if (newVsReturningConversionData.length === 0) return;

            const canvas = document.getElementById('newVsReturningConversionChart');
            if (!canvas) return;

            const labels = newVsReturningConversionData.map(row => row['funnel_stage']);
            const newUserCVR = newVsReturningConversionData.map(row => parseFloat(row['New user CVR']) || 0);
            const returningUserCVR = newVsReturningConversionData.map(row => parseFloat(row['Returning user CVR']) || 0);

            // 인사이트 분석 및 표시
            analyzeConversionGap(labels, newUserCVR, returningUserCVR);

            if (newVsReturningConversionChart) {
                newVsReturningConversionChart.destroy();
            }

            newVsReturningConversionChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '신규 고객 전환율 (%)',
                            data: newUserCVR,
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                            borderColor: '#ff9800',
                            borderWidth: 2,
                            borderRadius: 6,
                            barThickness: 'flex',
                            maxBarThickness: 60
                        },
                        {
                            label: '재방문 고객 전환율 (%)',
                            data: returningUserCVR,
                            backgroundColor: 'rgba(103, 58, 183, 0.7)',
                            borderColor: '#673ab7',
                            borderWidth: 2,
                            borderRadius: 6,
                            barThickness: 'flex',
                            maxBarThickness: 60
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 13,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label + ' 단계';
                                },
                                label: function(context) {
                                    const value = context.parsed.y.toFixed(2);
                                    return `${context.dataset.label}: ${value}%`;
                                },
                                afterBody: function(context) {
                                    if (context.length === 2) {
                                        const newValue = context[0].parsed.y;
                                        const returningValue = context[1].parsed.y;
                                        const gap = Math.abs(returningValue - newValue);
                                        const higherGroup = returningValue > newValue ? '재방문 고객' : '신규 고객';
                                        return [
                                            '',
                                            `📊 전환율 차이: ${gap.toFixed(2)}%p`,
                                            `${higherGroup}이 더 높음`
                                        ];
                                    }
                                    return '';
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            formatter: function(value, context) {
                                return value.toFixed(1) + '%';
                            },
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            color: function(context) {
                                return context.datasetIndex === 0 ? '#f57c00' : '#673ab7';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 12
                                }
                            },
                            title: {
                                display: true,
                                text: '전환율 (%)',
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // 인사이트 툴팁 설정
            setupConversionChartTooltip();
        }

        // 전환율 차이 분석 함수
        function analyzeConversionGap(labels, newUserCVR, returningUserCVR) {
            if (labels.length === 0 || newUserCVR.length === 0 || returningUserCVR.length === 0) {
                return;
            }

            // 각 단계별 차이 계산
            const gaps = labels.map((label, i) => ({
                stage: label,
                newCVR: newUserCVR[i],
                returningCVR: returningUserCVR[i],
                gap: returningUserCVR[i] - newUserCVR[i],
                gapPercent: ((returningUserCVR[i] - newUserCVR[i]) / newUserCVR[i] * 100)
            }));

            // 가장 차이가 큰 단계 찾기
            const maxGap = gaps.reduce((max, item) => item.gap > max.gap ? item : max, gaps[0]);
            const minGap = gaps.reduce((min, item) => item.gap < min.gap ? item : min, gaps[0]);

            // 평균 신규/재방문 전환율
            const avgNew = newUserCVR.reduce((sum, val) => sum + val, 0) / newUserCVR.length;
            const avgReturning = returningUserCVR.reduce((sum, val) => sum + val, 0) / returningUserCVR.length;
            const avgGap = avgReturning - avgNew;

            // 인사이트 텍스트 생성
            let insightHTML = '';

            if (avgReturning > avgNew) {
                const ratio = (avgReturning / avgNew).toFixed(1);
                insightHTML += `재방문 고객의 평균 전환율은 <strong style="color: #673ab7;">${avgReturning.toFixed(1)}%</strong>로, `;
                insightHTML += `신규 고객(<strong style="color: #ff9800;">${avgNew.toFixed(1)}%</strong>)보다 <strong style="color: var(--success-main);">${ratio}배 높습니다</strong>. `;
            } else {
                insightHTML += `신규 고객과 재방문 고객의 전환율이 비슷합니다. `;
            }

            if (maxGap.gap > 5) {
                insightHTML += `<br><strong>특히 "${maxGap.stage}" 단계</strong>에서 재방문 고객이 ${maxGap.gap.toFixed(1)}%p 더 높습니다. `;

                // 단계별 맞춤 추천
                if (maxGap.stage.includes('유입') || maxGap.stage.includes('활동')) {
                    insightHTML += `신규 고객이 이 단계에서 이탈하지 않도록 <strong>첫 화면을 간결하게</strong> 만들고 <strong>로딩 속도를 개선</strong>하세요.`;
                } else if (maxGap.stage.includes('관심')) {
                    insightHTML += `신규 고객에게 <strong>제품 리뷰와 고객 후기</strong>를 강조하여 신뢰를 구축하세요.`;
                } else if (maxGap.stage.includes('결제') || maxGap.stage.includes('구매')) {
                    insightHTML += `신규 고객도 쉽게 구매할 수 있도록 <strong>게스트 체크아웃</strong>과 <strong>간편 결제</strong>를 도입하세요.`;
                }
            } else {
                insightHTML += `모든 단계에서 비슷한 패턴을 보입니다. 신규 고객과 재방문 고객 모두에게 효과적인 전략을 유지하세요.`;
            }

            // 핵심 추천사항
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 핵심 전략:</strong> `;
            if (avgGap > 10) {
                insightHTML += `재방문율을 높이는 것이 가장 효과적입니다. 이메일 마케팅, 리타겟팅 광고, 쿠폰 제공으로 재방문을 유도하세요.`;
            } else if (avgNew < 3) {
                insightHTML += `신규 고객 전환율이 낮습니다. 랜딩페이지 개선과 첫 구매 할인 혜택 제공을 고려하세요.`;
            } else {
                insightHTML += `균형잡힌 성과를 보이고 있습니다. 지속적인 A/B 테스트로 두 그룹 모두의 전환율을 개선하세요.`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('conversionInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 전환율 비교 차트 인사이트 생성
        function generateConversionInsight() {
            return {
                insight: '신규 고객과 재방문 고객의 전환율 차이는 고객 경험의 질을 보여주는 중요한 지표입니다. 재방문 고객이 높다면 브랜드 충성도가 좋다는 뜻이고, 신규 고객이 낮다면 첫인상 개선이 필요합니다.',
                recommendation: '차이가 큰 단계를 집중 개선하세요. 예를 들어, 재방문 고객만 구매율이 높다면 신규 고객을 위한 "첫 구매 10% 할인" 같은 인센티브를 제공하거나, 재방문 고객에게는 VIP 혜택을 제공하여 충성도를 더 높이세요.'
            };
        }

        // 전환율 비교 차트 툴팁 설정
        function setupConversionChartTooltip() {
            const canvas = document.getElementById('newVsReturningConversionChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateConversionInsight();
                    showChartInsightTooltip('customerTrendTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('customerTrendTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('customerTrendTooltip');
                });
            }
        }

        // 3. 채널 품질 매트릭스 차트 (Scatter)
        function updateChannelMatrixChart() {
            if (channelEngagementData.length === 0) return;

            const canvas = document.getElementById('channelMatrixChart');
            if (!canvas) return;

            // 데이터 준비
            const data = channelEngagementData.map(row => ({
                x: parseFloat(row['Bounce rate']) || 0,
                y: parseFloat(row['Return rate']) || 0,
                channel: row['channel']
            }));

            // 평균값 계산 (기준선용)
            const avgBounceRate = data.reduce((sum, d) => sum + d.x, 0) / data.length;
            const avgReturnRate = data.reduce((sum, d) => sum + d.y, 0) / data.length;

            // 사분면별로 데이터 분리
            const starChannels = [];
            const growthChannels = [];
            const stableChannels = [];
            const problemChannels = [];

            data.forEach(d => {
                if (d.x < avgBounceRate && d.y > avgReturnRate) {
                    starChannels.push(d);
                } else if (d.x >= avgBounceRate && d.y > avgReturnRate) {
                    growthChannels.push(d);
                } else if (d.x < avgBounceRate && d.y <= avgReturnRate) {
                    stableChannels.push(d);
                } else {
                    problemChannels.push(d);
                }
            });

            if (channelMatrixChart) {
                channelMatrixChart.destroy();
            }

            channelMatrixChart = new Chart(canvas, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '⭐ 스타 채널',
                            data: starChannels,
                            backgroundColor: '#00c853',
                            borderColor: '#00a344',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        },
                        {
                            label: '📈 성장 채널',
                            data: growthChannels,
                            backgroundColor: '#2196f3',
                            borderColor: '#1976d2',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        },
                        {
                            label: '🔒 안정 채널',
                            data: stableChannels,
                            backgroundColor: '#9e9e9e',
                            borderColor: '#757575',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        },
                        {
                            label: '⚠️ 문제 채널',
                            data: problemChannels,
                            backgroundColor: '#ff5722',
                            borderColor: '#e64a19',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    return item.raw.channel;
                                },
                                label: function(context) {
                                    return [
                                        `이탈률: ${context.raw.x.toFixed(2)}%`,
                                        `재방문율: ${context.raw.y.toFixed(2)}%`,
                                        `분류: ${context.dataset.label}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                // 평균 기준선
                                vline: {
                                    type: 'line',
                                    xMin: avgBounceRate,
                                    xMax: avgBounceRate,
                                    borderColor: 'rgba(0, 0, 0, 0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: '평균 이탈률',
                                        enabled: true,
                                        position: 'start'
                                    }
                                },
                                hline: {
                                    type: 'line',
                                    yMin: avgReturnRate,
                                    yMax: avgReturnRate,
                                    borderColor: 'rgba(0, 0, 0, 0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: '평균 재방문율',
                                        enabled: true,
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '이탈률 (%) →',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '← 재방문율 (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 참여도 분석 함수
        function analyzeEngagementRates(allData, top10Data, top10Rates) {
            if (allData.length === 0) return;

            // 전체 평균 참여도
            const avgEngagement = allData.reduce((sum, row) => sum + (parseFloat(row['Engagement rate']) || 0), 0) / allData.length;

            // 최고/최저 참여도 채널
            const highest = allData[0];
            const lowest = allData[allData.length - 1];

            // 참여도 범위 분류
            const highEngagement = allData.filter(row => parseFloat(row['Engagement rate']) >= 60);
            const mediumEngagement = allData.filter(row => {
                const rate = parseFloat(row['Engagement rate']);
                return rate >= 40 && rate < 60;
            });
            const lowEngagement = allData.filter(row => parseFloat(row['Engagement rate']) < 40);

            // TOP 10의 평균 참여도
            const top10Avg = top10Rates.reduce((sum, rate) => sum + rate, 0) / top10Rates.length;

            // 인사이트 텍스트 생성
            let insightHTML = '';

            // 전체 상황 요약
            insightHTML += `전체 채널의 평균 참여도는 <strong style="color: #9c27b0;">${avgEngagement.toFixed(1)}%</strong>입니다. `;

            if (avgEngagement >= 60) {
                insightHTML += `<strong style="color: var(--success-main);">매우 우수한</strong> 수준입니다! `;
            } else if (avgEngagement >= 40) {
                insightHTML += `평균적인 수준이며 개선 여지가 있습니다. `;
            } else {
                insightHTML += `<strong style="color: var(--error-main);">주의가 필요한</strong> 수준입니다. `;
            }

            // 최고/최저 채널 정보
            insightHTML += `<br>가장 높은 참여도는 <strong>${highest['channel']}</strong> (${parseFloat(highest['Engagement rate']).toFixed(1)}%)이고, `;
            insightHTML += `가장 낮은 참여도는 <strong>${lowest['channel']}</strong> (${parseFloat(lowest['Engagement rate']).toFixed(1)}%)입니다. `;

            // 범위별 분포
            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 채널 분포:</strong> `;
            if (highEngagement.length > 0) {
                insightHTML += `<strong style="color: var(--success-main);">${highEngagement.length}개 채널</strong>이 우수(60% 이상), `;
            }
            if (mediumEngagement.length > 0) {
                insightHTML += `<strong style="color: #ff9800;">${mediumEngagement.length}개 채널</strong>이 보통(40-60%), `;
            }
            if (lowEngagement.length > 0) {
                insightHTML += `<strong style="color: var(--error-main);">${lowEngagement.length}개 채널</strong>이 저조(40% 미만)입니다. `;
            }

            // 핵심 추천사항
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 핵심 전략:</strong> `;

            if (highEngagement.length >= allData.length * 0.3) {
                // 30% 이상이 고참여도
                insightHTML += `우수한 채널이 많습니다! 이들 채널의 공통점을 분석하여 다른 채널에도 적용하세요. `;
                insightHTML += `특히 <strong>${highest['channel']}</strong>의 성공 요인을 자세히 연구하세요.`;
            } else if (lowEngagement.length >= allData.length * 0.3) {
                // 30% 이상이 저참여도
                insightHTML += `참여도가 낮은 채널이 많습니다. <strong>즉시 광고 타겟팅과 랜딩 페이지를 재검토</strong>하세요. `;
                insightHTML += `저참여도 채널의 예산을 고참여도 채널로 재배분하는 것을 고려하세요.`;
            } else {
                // 중간 수준 많음
                insightHTML += `대부분 채널이 개선 가능한 상태입니다. `;
                insightHTML += `<strong>A/B 테스트를 통해 랜딩 페이지를 최적화</strong>하고, 타겟 오디언스를 세분화하여 참여도를 높이세요.`;
            }

            // 구체적 예시
            if (top10Avg - avgEngagement > 10) {
                insightHTML += `<br><br><strong>⚠️ 주의:</strong> 상위 10개 채널의 평균 참여도(${top10Avg.toFixed(1)}%)가 전체 평균보다 ${(top10Avg - avgEngagement).toFixed(1)}%p 높습니다. `;
                insightHTML += `나머지 채널들의 품질이 낮으므로, 저성과 채널을 정리하거나 개선하는 것이 시급합니다.`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('engagementInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 4. 채널별 참여도 분석 차트
        function updateChannelEngagementChart() {
            if (channelEngagementData.length === 0) return;

            const canvas = document.getElementById('channelEngagementChart');
            if (!canvas) return;

            // 참여율 기준으로 정렬
            const sortedData = [...channelEngagementData].sort((a, b) => {
                return parseFloat(b['Engagement rate']) - parseFloat(a['Engagement rate']);
            });

            // 상위 10개 채널만 표시
            const top10 = sortedData.slice(0, 10);

            const labels = top10.map(row => row['channel']);
            const engagementRates = top10.map(row => parseFloat(row['Engagement rate']) || 0);

            // 참여도 인사이트 분석 및 표시
            analyzeEngagementRates(sortedData, top10, engagementRates);

            // 색상 그라데이션 (높을수록 진한 색)
            const colors = engagementRates.map(rate => {
                const intensity = Math.min(rate / 100, 1);
                return `rgba(103, 58, 183, ${0.3 + intensity * 0.5})`;
            });

            if (channelEngagementChart) {
                channelEngagementChart.destroy();
            }

            channelEngagementChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '참여율 (%)',
                        data: engagementRates,
                        backgroundColor: colors,
                        borderColor: '#673ab7',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `참여율: ${context.parsed.x.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // 참여도 차트 인사이트 툴팁 설정
            setupEngagementChartTooltip();
        }

        // 참여도 차트 인사이트 생성
        function generateEngagementInsight() {
            return {
                insight: '참여도는 채널의 품질을 평가하는 가장 중요한 지표입니다. 높은 참여도는 타겟팅이 정확하고 랜딩 페이지가 매력적이라는 뜻이며, 전환율 향상으로 이어집니다.',
                recommendation: '참여도 상위 채널에 예산을 집중하세요. 참여도 60% 이상은 우수, 40-60%는 보통, 40% 미만은 개선 필요입니다. 참여도가 낮은 채널은 광고 타겟팅과 랜딩 페이지를 즉시 재검토하거나 예산을 줄이는 것을 고려하세요.'
            };
        }

        // 참여도 차트 툴팁 설정
        function setupEngagementChartTooltip() {
            const canvas = document.getElementById('channelEngagementChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateEngagementInsight();
                    showChartInsightTooltip('churnChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('churnChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('churnChartTooltip');
                });
            }
        }

        // ========================================
        // 탭 전환 기능
        // ========================================

        function initTabSwitching() {
            // 1. 데이터 기반 의사결정 도구 탭
            document.querySelectorAll('.decision-tool-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.decision-tool-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.decision-tool-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    let selectedTab = null;
                    if (targetTab === 'clustering') selectedTab = document.getElementById('clusteringTab');
                    else if (targetTab === 'budget') selectedTab = document.getElementById('budgetTab');
                    else if (targetTab === 'churn-alert') selectedTab = document.getElementById('churnAlertTab');
                    else if (targetTab === 'improvement') selectedTab = document.getElementById('improvementTab');

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });

            // 2. 채널별 분석 탭
            document.querySelectorAll('.channel-analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.channel-analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.channel-analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    let selectedTab = null;
                    if (targetTab === 'table') selectedTab = document.getElementById('tableTab');
                    else if (targetTab === 'kpi') selectedTab = document.getElementById('kpiTab');
                    else if (targetTab === 'balance') selectedTab = document.getElementById('balanceTab');
                    else if (targetTab === 'top10') selectedTab = document.getElementById('top10Tab');

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });

            // 3. 고객 재방문 및 이탈 분석 탭
            document.querySelectorAll('.customer-analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.customer-analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.customer-analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    let selectedTab = null;
                    if (targetTab === 'trend') selectedTab = document.getElementById('trendTab');
                    else if (targetTab === 'conversion') selectedTab = document.getElementById('conversionTab');
                    else if (targetTab === 'churn') selectedTab = document.getElementById('churnTab');
                    else if (targetTab === 'matrix') selectedTab = document.getElementById('matrixTab');
                    else if (targetTab === 'engagement') selectedTab = document.getElementById('engagementTab');

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });
        }

        // ========================================
        // 이벤트 리스너 및 초기화
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            checkIframeAndHideSidebar();

            // 테이블 정렬 기능 초기화
            setupTableSorting();

            // 탭 전환 기능 초기화
            initTabSwitching();

            // 페이지 로드 후 2초 뒤 버튼 상태 확인
            setTimeout(() => {
                checkButtonStates();
            }, 2000);
        });

        // 초기 데이터 로드
        loadData();

        // iframe 체크 (DOMContentLoaded 이전에도 실행)
        checkIframeAndHideSidebar();
    </script>
</body>
</html>
