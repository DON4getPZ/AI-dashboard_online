<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시계열 데이터 분석 - 마케팅 대시보드</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--grey-700);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-item-text {
            flex: 1;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 헤더 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 카드 공통 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 14px 0 rgba(32, 40, 45, 0.08);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px 0 rgba(32, 40, 45, 0.12);
        }

        /* 인사이트 섹션 */
        .insight-section {
            padding: 24px;
            margin-bottom: 24px;
        }

        .insight-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--warning-main);
            border-radius: 2px;
        }

        .insight-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .insight-content.recommendation-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .insight-card {
            padding: 16px 20px;
            background: var(--grey-50);
            border-radius: 10px;
            border-left: 4px solid var(--primary-main);
            transition: all 0.2s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .insight-card.positive,
        .insight-card.low {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-left-color: var(--success-main);
        }

        .insight-card.negative,
        .insight-card.high {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border-left-color: var(--error-main);
        }

        .insight-card.neutral,
        .insight-card.medium {
            background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%);
            border-left-color: var(--warning-main);
        }

        .insight-card.opportunity {
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            border-left-color: var(--secondary-main);
        }

        /* 인사이트 카드 내부 스타일 (type_dashboard 스타일) */
        .insight-type {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            color: var(--grey-500);
        }

        .insight-message {
            font-size: 14px;
            color: var(--grey-900);
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .insight-value {
            font-size: 12px;
            color: var(--grey-600);
            line-height: 1.6;
        }

        /* 탭 컨텐츠 스타일 */
        .insights-tab-content {
            background: var(--paper);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--grey-200);
        }

        /* Overall 성과 카드 그리드 레이아웃 */
        .insight-content.overall-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
        }

        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-title svg {
            width: 18px;
            height: 18px;
        }

        .insight-text {
            font-size: 14px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        /* KPI 요약 섹션 */
        #kpiSummaryGrid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-summary-card {
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--paper) 0%, var(--grey-50) 100%);
            position: relative;
            overflow: hidden;
        }

        .kpi-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .kpi-summary-card:nth-child(1)::before { background: #673ab7; }
        .kpi-summary-card:nth-child(2)::before { background: #2196f3; }
        .kpi-summary-card:nth-child(3)::before { background: #ff9800; }
        .kpi-summary-card:nth-child(4)::before { background: #4caf50; }
        .kpi-summary-card:nth-child(5)::before { background: #00c853; }
        .kpi-summary-card:nth-child(6)::before { background: #9c27b0; }
        .kpi-summary-card:nth-child(7)::before { background: #03a9f4; }
        .kpi-summary-card:nth-child(8)::before { background: #8bc34a; }
        .kpi-summary-card:nth-child(9)::before { background: #ff5722; }

        /* KPI 행 구분 스타일 */
        .kpi-row-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .kpi-row-container {
            margin-bottom: 16px;
        }

        .kpi-row-container:last-child {
            margin-bottom: 0;
        }

        .kpi-summary-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .kpi-summary-unit {
            font-size: 11px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        .kpi-forecast-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .kpi-forecast-badge.up {
            background: var(--success-light);
            color: var(--success-main);
        }

        .kpi-forecast-badge.down {
            background: var(--error-light);
            color: var(--error-main);
        }

        /* KPI 토글 스타일 */
        .kpi-section {
            margin-bottom: 24px;
        }

        .kpi-view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .kpi-view-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .kpi-view-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .kpi-view-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .kpi-grid-primary {
            margin-bottom: 0;
        }

        .kpi-grid.kpi-grid-secondary {
            display: none;
            margin-top: 16px;
        }

        .kpi-section.show-all .kpi-grid.kpi-grid-secondary {
            display: grid;
        }

        .kpi-summary-card.secondary {
            background: var(--grey-50);
        }

        /* KPI 그리드 - 업그레이드 디자인 */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--paper);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .kpi-card.highlight {
            border-left: 4px solid var(--primary-main);
        }

        .kpi-card.secondary {
            background: var(--grey-50);
        }

        .kpi-card.secondary .kpi-icon {
            background: var(--grey-200);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-title {
            font-size: 13px;
            color: var(--grey-600);
            font-weight: 600;
        }

        .kpi-icon {
            width: 36px;
            height: 36px;
            background: var(--grey-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-main);
            font-size: 16px;
        }

        .kpi-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 8px;
        }

        .kpi-value.highlight-value {
            color: var(--primary-main);
        }

        .kpi-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .kpi-trend.up { color: var(--success-main); }
        .kpi-trend.down { color: var(--error-main); }
        .kpi-trend.neutral { color: var(--grey-500); }

        .kpi-card .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .kpi-card .trend-badge.up {
            background: var(--success-light);
            color: var(--success-main);
        }

        .kpi-card .trend-badge.down {
            background: var(--error-light);
            color: var(--error-main);
        }

        /* 차트 섹션 */
        .chart-section {
            margin-bottom: 24px;
            padding: 24px;
        }

        .chart-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--secondary-main);
            border-radius: 2px;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chart-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--grey-700);
            padding: 6px 12px;
            border-radius: 20px;
            transition: all 0.2s ease;
            background: var(--grey-100);
        }

        .chart-checkbox:hover {
            background: var(--grey-200);
        }

        .chart-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-main);
            cursor: pointer;
        }

        .chart-checkbox.cost { border-left: 3px solid #673ab7; }
        .chart-checkbox.impressions { border-left: 3px solid #2196f3; }
        .chart-checkbox.clicks { border-left: 3px solid #ff9800; }
        .chart-checkbox.conversions { border-left: 3px solid #4caf50; }
        .chart-checkbox.value { border-left: 3px solid #00c853; }

        .chart-container {
            position: relative;
            height: 400px;
        }

        /* 뷰 타입 버튼 */
        .view-type-section {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        /* 데이터 라벨 토글 버튼 스타일 */
        .data-label-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .data-label-toggle:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .data-label-toggle.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .data-label-toggle .toggle-checkbox {
            font-size: 14px;
        }

        .view-btn,
        .period-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .view-btn:hover,
        .period-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .view-btn.active,
        .period-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        /* 기간 필터 적용 탭 스타일 */
        .view-btn.period-filter-enabled {
            position: relative;
        }

        .view-btn.period-filter-enabled::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: #673ab7;
            border-radius: 50%;
            opacity: 0.7;
        }

        .view-btn.period-filter-enabled.active::before {
            background: white;
            opacity: 1;
        }

        /* 시각화 이미지 섹션 */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .visualization-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 1200px) {
            .visualization-grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .visualization-grid,
            .visualization-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .visualization-card {
            padding: 20px;
            position: relative;
        }

        .visualization-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visualization-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--success-main);
            border-radius: 2px;
        }

        /* Image tooltip wrapper */
        .img-tooltip-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .visualization-img {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--grey-200);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: block;
        }

        .img-tooltip-wrapper:hover .visualization-img {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Tooltip styles */
        .img-tooltip-wrapper[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(33, 33, 33, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            white-space: normal;
            max-width: 320px;
            width: max-content;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .img-tooltip-wrapper[data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-12px);
        }

        .img-tooltip-wrapper[data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-2px);
            border: 6px solid transparent;
            border-top-color: rgba(33, 33, 33, 0.95);
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 1001;
        }

        .img-tooltip-wrapper[data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-6px);
        }

        /* 데이터 테이블 */
        .table-section {
            overflow: hidden;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--grey-200);
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--success-main);
            border-radius: 2px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: right;
            font-size: 14px;
        }

        th {
            background: var(--grey-50);
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 2px solid var(--grey-200);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        td {
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--paper);
            font-weight: 500;
        }

        th:first-child {
            background: var(--grey-50);
            z-index: 2;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--grey-50);
        }

        tbody tr:hover td:first-child {
            background: var(--grey-50);
        }

        .forecast-row {
            background: var(--primary-light) !important;
        }

        .forecast-row td {
            color: var(--primary-dark);
        }

        .forecast-row td:first-child {
            background: var(--primary-light) !important;
        }

        .mixed-row {
            background: var(--warning-light) !important;
        }

        .mixed-row td {
            color: var(--grey-900);
        }

        .mixed-row td:first-child {
            background: var(--warning-light) !important;
        }

        /* 접기/펼치기 스타일 */
        .collapsible-section {
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 20px 24px;
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--grey-200);
            transition: box-shadow 0.2s ease;
        }

        .collapsible-header:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .collapsible-icon {
            font-size: 24px;
        }

        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-light);
            color: var(--primary-main);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .collapsible-toggle:hover {
            background: #673ab7;
            color: white;
        }

        .collapsible-toggle.active {
            background: #673ab7;
            color: white;
        }

        .collapsible-toggle-icon {
            transition: transform 0.2s ease;
            transform: rotate(180deg);
        }

        .collapsible-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0 24px;
            transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 5000px;
            opacity: 1;
            padding: 24px;
        }

        /* 컴팩트한 그리드 */
        .compact-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 968px) {
            .compact-grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* 세그먼트 분석 스타일 */
        .segment-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 0 24px;
        }

        .segment-tab {
            padding: 10px 24px;
            border: none;
            background: var(--grey-100);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .segment-tab:hover {
            background: var(--grey-200);
        }

        .segment-tab.active {
            background: var(--primary-main);
            color: white;
        }

        .segment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            padding: 0 24px 24px;
        }

        .segment-card {
            padding: 20px;
            background: linear-gradient(135deg, var(--grey-50) 0%, var(--paper) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary-main);
            transition: all 0.2s ease;
        }

        .segment-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .segment-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
        }

        .segment-metrics {
            display: grid;
            gap: 12px;
        }

        .segment-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--grey-200);
        }

        .segment-metric-row:last-child {
            border-bottom: none;
        }

        .segment-metric-label {
            font-size: 13px;
            color: var(--grey-600);
        }

        .segment-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .segment-metric-value.positive {
            color: var(--success-main);
        }

        .segment-metric-value.negative {
            color: var(--error-main);
        }

        /* 추천 카드 스타일 - 컴팩트 디자인 */
        .recommendation-card {
            padding: 16px;
            background: linear-gradient(135deg, var(--success-light) 0%, var(--paper) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--success-main);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .recommendation-card:hover {
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
        }

        .recommendation-card.expanded {
            padding: 20px;
        }

        .recommendation-priority {
            display: inline-block;
            padding: 4px 10px;
            background: var(--success-main);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .recommendation-action {
            font-size: 15px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 6px;
        }

        .recommendation-target {
            font-size: 12px;
            color: var(--grey-600);
            margin-bottom: 10px;
        }

        .recommendation-reasons {
            list-style: none;
            margin: 0;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        }

        .recommendation-card.expanded .recommendation-reasons {
            max-height: 300px;
            opacity: 1;
            margin: 12px 0;
        }

        .recommendation-reasons li {
            font-size: 13px;
            color: var(--grey-700);
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .recommendation-reasons li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success-main);
            font-weight: 600;
        }

        .recommendation-impact {
            font-size: 12px;
            font-weight: 600;
            color: #7b1fa2;
            margin-top: 8px;
        }

        .recommendation-card.expanded .recommendation-impact {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--grey-200);
        }

        .recommendation-expand-hint {
            font-size: 10px;
            color: var(--grey-500);
            text-align: right;
            margin-top: 6px;
            opacity: 0.7;
        }

        .recommendation-card.expanded .recommendation-expand-hint {
            display: none;
        }

        /* 반응형 */
        @media (max-width: 1400px) {
            .kpi-summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .visualization-grid {
                grid-template-columns: 1fr;
            }
            .insight-content:not(.overall-grid) {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            .kpi-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-container {
                height: 300px;
            }
            .insight-content:not(.overall-grid) {
                grid-template-columns: 1fr;
            }
        }

        /* 예산 시뮬레이션 슬라이더 */
        .simulation-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: linear-gradient(to right, #c62828 0%, #c62828 37.5%, #e0e0e0 37.5%, #e0e0e0 62.5%, #2e7d32 62.5%, #2e7d32 100%);
            border-radius: 3px;
            outline: none;
        }

        .simulation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .simulation-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .simulation-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* 초기화 버튼 */
        .reset-btn {
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .reset-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .reset-btn:active {
            transform: scale(0.97);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        /* 예산 시뮬레이션 슬라이더 스타일 */
        .sim-slider-group {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.25s ease;
        }
        .sim-slider-group:hover {
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        .sim-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .sim-segment-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sim-segment-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sim-segment-badge.high { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .sim-segment-badge.medium { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .sim-segment-badge.low { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .sim-segment-name { font-weight: 600; font-size: 13px; color: var(--grey-800); }
        .sim-segment-metrics {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .sim-roas-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .sim-roas-badge.high { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .sim-roas-badge.medium { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .sim-roas-badge.low { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .sim-current-budget { font-size: 12px; color: var(--grey-600); font-weight: 500; }
        .sim-slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .sim-slider-label {
            font-size: 11px;
            color: var(--grey-500);
            min-width: 32px;
        }
        .sim-slider-track {
            flex: 1;
            position: relative;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: visible;
        }
        .sim-slider-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #d6beff, #be9ff2 25%, #ab87ea 50%, #8c63d3 75%, #673ab7);
            border-radius: 4px;
            transition: width 0.15s ease;
        }
        .sim-slider {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 100%;
            height: 24px;
            background: transparent;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            z-index: 2;
        }
        .sim-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            transition: transform 0.15s ease;
        }
        .sim-slider::-webkit-slider-thumb:hover { transform: scale(1.15); }
        .sim-slider::-webkit-slider-thumb:active { cursor: grabbing; transform: scale(1.1); }
        .sim-slider-thumb-value {
            position: absolute;
            top: -26px;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
            transition: left 0.15s ease;
        }
        .sim-slider-thumb-value::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #1e293b;
        }
        .sim-slider-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }
        .sim-result-label { font-size: 12px; color: var(--grey-500); }
        .sim-result-value { font-size: 13px; font-weight: 600; }
        .sim-result-value.positive { color: #10b981; }
        .sim-result-value.negative { color: #ef4444; }
        .sim-result-value small { font-size: 11px; opacity: 0.8; }

        /* 시뮬레이션 결과 카드 */
        .sim-result-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .sim-result-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            gap: 12px;
            transition: all 0.25s ease;
        }
        .sim-result-card:hover {
            border-color: rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .sim-result-card.highlight {
            border-color: rgba(16, 185, 129, 0.25);
            background: linear-gradient(135deg, white, rgba(16, 185, 129, 0.03));
        }
        .sim-result-card.featured {
            border-color: rgba(59, 130, 246, 0.25);
            background: linear-gradient(135deg, white, rgba(59, 130, 246, 0.03));
        }
        .sim-card-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sim-card-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .sim-card-label {
            font-size: 11px;
            color: var(--grey-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .sim-card-values {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .sim-card-before {
            font-size: 12px;
            color: var(--grey-400);
            text-decoration: line-through;
        }
        .sim-card-arrow {
            font-size: 11px;
            color: var(--grey-400);
        }
        .sim-card-after {
            font-size: 15px;
            font-weight: 700;
            color: var(--grey-800);
        }
        .sim-card-change {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
        }
        .sim-card-value-large {
            font-size: 20px;
            font-weight: 800;
            color: #3b82f6;
            line-height: 1;
            margin-top: 4px;
        }
        .sim-card-subtitle {
            font-size: 10px;
            color: var(--grey-500);
        }

        /* 시뮬레이션 결과 테이블 */
        .sim-table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        .sim-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .sim-detail-table th {
            padding: 14px 16px;
            background: #f8fafc;
            color: var(--grey-500);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.08);
        }
        .sim-detail-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            color: var(--grey-600);
            vertical-align: middle;
        }
        .sim-detail-table tr:last-child td {
            border-bottom: none;
        }
        .sim-detail-table tbody tr:not(.sim-total-row):hover td {
            background: rgba(139, 92, 246, 0.04);
        }
        /* 세그먼트 셀 */
        .sim-segment-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--grey-800);
        }
        .sim-segment-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .sim-segment-dot.high { background: #10b981; }
        .sim-segment-dot.medium { background: #f59e0b; }
        .sim-segment-dot.low { background: #ef4444; }
        /* 하이라이트 셀 */
        .sim-highlight-cell {
            font-weight: 600;
        }
        .sim-highlight-cell.positive { color: #10b981; }
        .sim-highlight-cell.negative { color: #ef4444; }
        .sim-highlight-cell.neutral { color: var(--grey-600); }
        /* 추천 뱃지 */
        .sim-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .sim-badge.recommend {
            background: rgba(16, 185, 129, 0.12);
            color: #059669;
        }
        .sim-badge.maintain {
            background: rgba(59, 130, 246, 0.12);
            color: #2563eb;
        }
        .sim-badge.review {
            background: rgba(245, 158, 11, 0.12);
            color: #d97706;
        }
        .sim-badge.warning {
            background: rgba(239, 68, 68, 0.12);
            color: #dc2626;
        }
        /* 총합 행 */
        .sim-total-row {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        }
        .sim-total-row td {
            border-top: 2px solid var(--grey-300) !important;
            border-bottom: none !important;
            padding: 16px !important;
        }
        .sim-total-row:hover td {
            background: transparent !important;
        }
        .sim-total-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 13px;
            color: var(--grey-800);
        }
        .sim-total-icon {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #8b5cf6, #673ab7);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .sim-total-value {
            font-weight: 700;
            font-size: 13px;
            color: var(--grey-800);
        }
        /* 변경된 행 하이라이트 */
        .sim-changed-row {
            background: rgba(255, 251, 235, 0.8);
        }
        .sim-changed-row td:first-child {
            position: relative;
        }
        .sim-changed-row td:first-child::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #f59e0b, #fbbf24);
        }
        /* 통합 인사이트 박스 */
        .sim-insight-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.04), rgba(103, 58, 183, 0.04));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .sim-insight-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        .sim-insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .sim-insight-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(103, 58, 183, 0.15));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b5cf6;
            flex-shrink: 0;
        }
        .sim-insight-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-800);
        }
        .sim-insight-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }
        .sim-insight-status.positive {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .sim-insight-status.warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        .sim-insight-status.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        .sim-insight-status.neutral {
            background: rgba(100, 116, 139, 0.1);
            color: #64748b;
        }
        .sim-insight-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .sim-insight-main {
            background: white;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        .sim-insight-main-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sim-insight-main-text {
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.7;
        }
        .sim-insight-main-text strong {
            color: var(--grey-800);
        }
        .sim-insight-notes {
            background: rgba(245, 158, 11, 0.05);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(245, 158, 11, 0.12);
        }
        .sim-insight-notes-title {
            font-size: 11px;
            font-weight: 600;
            color: #b45309;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sim-insight-notes-list {
            font-size: 12px;
            color: var(--grey-600);
            line-height: 1.8;
        }
        .sim-insight-notes-list li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 4px;
        }
        .sim-insight-notes-list li::before {
            content: '•';
            color: #f59e0b;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .sim-insight-content {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 1200px) {
            .sim-result-cards { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sim-result-cards { grid-template-columns: 1fr; }
        }

        /* Matrix 카드 툴팁 (마우스 커서 따라가는 스타일) */
        .matrix-tooltip-global {
            position: fixed;
            background: white;
            border: 2px solid #673ab7;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(103, 58, 183, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            z-index: 9999;
            max-width: 320px;
            min-width: 260px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .matrix-tooltip-global.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .matrix-tooltip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .matrix-tooltip-icon {
            font-size: 24px;
        }

        .matrix-tooltip-title {
            font-size: 14px;
            font-weight: 700;
            color: #673ab7;
        }

        .matrix-tooltip-subtitle {
            font-size: 11px;
            color: #9e9e9e;
            margin-top: 2px;
        }

        .matrix-tooltip-content {
            padding: 12px;
            background: linear-gradient(135deg, #ede7f6 0%, #f3e5f5 100%);
            border-radius: 8px;
            border-left: 4px solid #673ab7;
            font-size: 12px;
            font-weight: 500;
            color: #333;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Matrix 카드 전역 툴팁 -->
    <div id="matrixCardTooltip" class="matrix-tooltip-global"></div>

    <div class="app-wrapper">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="sidebar-logo-text">Analytics</div>
                        <div class="sidebar-logo-subtitle">Dashboard</div>
                    </div>
                </a>
            </div>

            <div class="simplebar-content-wrapper">
                <div class="sidebar-content">
                    <!-- 대시보드 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">대시보드</div>
                        <a href="marketing_dashboard_v3.html" class="nav-item">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">광고 성과 대시보드</span>
                        </a>
                    </div>

                    <!-- 분석 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">분석</div>
                        <a href="creative_analysis.html" class="nav-item">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">광고 소재별 분석</span>
                        </a>
                        <a href="#" class="nav-item active">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M23 8c0 1.1-.9 2-2 2-.18 0-.35-.02-.51-.07l-3.56 3.55c.05.16.07.34.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.18.02-.36.07-.52l-2.55-2.55c-.16.05-.34.07-.52.07s-.36-.02-.52-.07l-4.55 4.56c.05.16.07.33.07.51 0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2c.18 0 .35.02.51.07l4.56-4.55C8.02 9.36 8 9.18 8 9c0-1.1.9-2 2-2s2 .9 2 2c0 .18-.02.36-.07.52l2.55 2.55c.16-.05.34-.07.52-.07s.36.02.52.07l3.55-3.56C19.02 8.35 19 8.18 19 8c0-1.1.9-2 2-2s2 .9 2 2z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">시계열 데이터 분석</span>
                        </a>
                        <a href="#" class="nav-item">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">유형구분별 비교</span>
                        </a>
                    </div>

                    <!-- 설정 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">설정</div>
                        <a href="#" class="nav-item">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">데이터 설정</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 메인 컨텐츠 -->
        <main class="main-content">
            <div class="container">
                <!-- 헤더 -->
                <div class="header">
                    <div>
                        <h1>시계열 데이터 분석</h1>
                        <div class="header-subtitle">AI 기반 예측 모델을 통한 광고 성과 예측 및 인사이트 <strong>(향후 30일 예측)</strong></div>
                    </div>
                </div>

                <!-- 0. AI 상태 요약 카드 (summary_card) -->
                <div id="summaryCardContainer" class="card" style="margin-bottom: 24px; display: none;">
                    <div style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div id="summaryCardStatus" style="font-size: 24px; font-weight: 700;"></div>
                            <div>
                                <div id="summaryCardMessage" style="font-size: 14px; color: var(--grey-700);"></div>
                                <div id="summaryCardPeriod" style="font-size: 12px; color: var(--grey-500); margin-top: 4px;"></div>
                            </div>
                        </div>
                        <div id="summaryCardMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <!-- JS로 동적 생성 -->
                        </div>
                    </div>
                </div>

                <!-- 1. 핵심 KPI 요약 (제일 위, 펼쳐진 상태) -->
                <!-- 주요/세부 성과 토글 -->
                <div class="kpi-view-toggle">
                    <button class="kpi-view-btn active" data-kpi-view="primary">주요 성과</button>
                    <button class="kpi-view-btn" data-kpi-view="all">세부 성과</button>
                </div>
                <div class="kpi-section" id="kpiSectionContainer">
                    <div id="kpiSummaryGrid">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>

                <!-- 2. 통합 인사이트 대시보드 (접기/펼치기) -->
                <div class="collapsible-section" style="margin-bottom: 24px;">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">🔬</span>
                            <span>통합 인사이트 대시보드</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- AI 인사이트 요약 (스토리 기반 인트로) -->
                        <div id="aiSummaryContainer" style="display: none; margin-bottom: 20px;">
                            <!-- 스토리 배너 -->
                            <div style="margin-bottom: 16px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white;">
                                <div style="display: flex; align-items: flex-start; gap: 16px;">
                                    <div style="font-size: 40px; line-height: 1;">🤖</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 6px;">AI가 분석한 오늘의 마케팅 인사이트</div>
                                        <div style="font-size: 13px; opacity: 0.9; line-height: 1.6;">
                                            Prophet 예측 모델 기반으로 <strong>성과 트렌드와 액션 아이템</strong>을 요약했습니다.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- AI 요약 기간 필터 -->
                            <div style="margin-bottom: 16px; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <span style="font-size: 12px; font-weight: 600; color: #495057;">📅 분석 기간:</span>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <button class="ai-period-btn active" data-ai-period="full" onclick="switchAiSummaryPeriod('full')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">전체</button>
                                        <button class="ai-period-btn" data-ai-period="180d" onclick="switchAiSummaryPeriod('180d')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">180일</button>
                                        <button class="ai-period-btn" data-ai-period="90d" onclick="switchAiSummaryPeriod('90d')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">90일</button>
                                        <button class="ai-period-btn" data-ai-period="30d" onclick="switchAiSummaryPeriod('30d')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">30일</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 하위 탭 버튼 (데이터 기반 의사결정 도구 스타일) -->
                            <div class="view-type-section" style="margin-bottom: 20px; flex-wrap: wrap; gap: 8px;">
                                <button class="view-btn insights-tab-btn active" data-insights-tab="summary" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    📊 핵심 요약
                                </button>
                                <button class="view-btn insights-tab-btn" data-insights-tab="alerts" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    ⚠️ 경고 및 추천 <span id="alertsBadge" style="display: none; padding: 2px 8px; background: #ef5350; color: white; border-radius: 10px; font-size: 11px; margin-left: 4px;"></span>
                                </button>
                                <button class="view-btn insights-tab-btn" data-insights-tab="opportunities" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    🎯 기회 요소 <span id="opportunitiesBadge" style="display: none; padding: 2px 8px; background: #4caf50; color: white; border-radius: 10px; font-size: 11px; margin-left: 4px;"></span>
                                </button>
                                <button class="view-btn insights-tab-btn" data-insights-tab="matrix" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    📈 Forecast Matrix <span id="matrixBadge" style="display: none; padding: 2px 8px; background: #673ab7; color: white; border-radius: 10px; font-size: 11px; margin-left: 4px;"></span>
                                </button>
                            </div>

                            <!-- 탭 0: 핵심 요약 -->
                            <div id="summaryTab" class="insights-tab-content" style="display: block; background: none; border: none; box-shadow: none; border-radius: 0; overflow: visible;">
                                <div id="aiSummaryContent" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding-top: 4px;">
                                    <!-- JS로 동적 생성 -->
                                </div>
                            </div>

                            <!-- 탭 1: 경고 및 추천 -->
                            <div id="alertsTab" class="insights-tab-content" style="display: none;">
                            <!-- 2열 그리드 컨텐츠 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; min-height: 300px;">
                                <!-- 주요 경고 -->
                                <div style="padding: 24px; border-right: 1px solid var(--grey-200); background: #fafafa;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #ef5350;">
                                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #ef5350 0%, #f44336 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <span style="font-size: 14px; filter: brightness(10);">🚨</span>
                                        </div>
                                        <div>
                                            <span style="font-size: 14px; font-weight: 700; color: var(--grey-900);">주요 경고</span>
                                            <span id="alertsCountBadge" style="font-size: 11px; color: var(--grey-500); font-weight: 500; margin-left: 8px;"></span>
                                        </div>
                                    </div>
                                    <div class="insight-content" id="insightContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <!-- JS로 동적 생성 -->
                                    </div>
                                </div>

                                <!-- 투자 추천 -->
                                <div style="padding: 24px; background: #fafafa;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #4caf50;">
                                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <span style="font-size: 14px; filter: brightness(10);">💡</span>
                                        </div>
                                        <div>
                                            <span style="font-size: 14px; font-weight: 700; color: var(--grey-900);">투자 추천</span>
                                            <span id="recommendationsCountBadge" style="font-size: 11px; color: var(--grey-500); font-weight: 500; margin-left: 8px;"></span>
                                        </div>
                                    </div>
                                    <div class="insight-content recommendation-list" id="recommendationContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral">
                                            <div class="insight-type">로딩</div>
                                            <div class="insight-message">데이터를 불러오는 중...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>

                            <!-- 탭 2: 기회 요소 (opportunities) -->
                            <div id="opportunitiesTab" class="insights-tab-content" style="display: none;">
                            <!-- 컨텐츠 영역 -->
                            <div style="padding: 24px; background: #fafafa; min-height: 250px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #2196f3;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 14px; filter: brightness(10);">💎</span>
                                    </div>
                                    <div>
                                        <span style="font-size: 14px; font-weight: 700; color: var(--grey-900);">성장 기회 발견</span>
                                    </div>
                                </div>
                                <div id="opportunitiesContent" class="insight-content" style="display: flex; flex-direction: column; gap: 12px;">
                                    <div class="insight-card opportunity">
                                        <div class="insight-type">분석 중</div>
                                        <div class="insight-message">현재 발견된 기회 요소가 없습니다.</div>
                                        <div class="insight-value">데이터가 축적되면 성장 기회가 표시됩니다.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 3: Forecast Matrix 4분면 분석 -->
                        <div id="matrixTab" class="insights-tab-content" style="display: none;">
                            <!-- 하위탭 버튼 -->
                            <div style="display: flex; gap: 0; background: #f5f5f5; border-bottom: 1px solid var(--grey-200);">
                                <button class="matrix-sub-tab active" data-matrix-tab="brand" style="flex: 1; padding: 12px 16px; border: none; background: #673ab7; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>🏷️</span> 브랜드 <span id="matrixBrandCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                                <button class="matrix-sub-tab" data-matrix-tab="channel" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>📢</span> 채널 <span id="matrixChannelCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                                <button class="matrix-sub-tab" data-matrix-tab="product" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>📦</span> 상품 <span id="matrixProductCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                                <button class="matrix-sub-tab" data-matrix-tab="promotion" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>🎁</span> 프로모션 <span id="matrixPromotionCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                            </div>
                            <!-- 하위탭 컨텐츠 영역 -->
                            <div style="padding: 20px 24px; background: #fafafa; min-height: 350px;">
                                <!-- 브랜드 탭 -->
                                <div id="matrixBrandTab" class="matrix-sub-content" style="display: block;">
                                    <div id="matrixBrandContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                                <!-- 채널 탭 -->
                                <div id="matrixChannelTab" class="matrix-sub-content" style="display: none;">
                                    <div id="matrixChannelContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                                <!-- 상품 탭 -->
                                <div id="matrixProductTab" class="matrix-sub-content" style="display: none;">
                                    <div id="matrixProductContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                                <!-- 프로모션 탭 -->
                                <div id="matrixPromotionTab" class="matrix-sub-content" style="display: none;">
                                    <div id="matrixPromotionContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                </div>

                <!-- 최근 변화 인사이트 (접기/펼치기) -->
                <div class="collapsible-section" style="margin-bottom: 24px;">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📈</span>
                            <span>최근 변화 인사이트</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 기간 비교 선택 -->
                        <div id="trendPeriodIndicator" style="margin-bottom: 16px; padding: 14px 18px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 10px; border: 1px solid #bbdefb;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="font-size: 16px;">📊</span>
                                <span style="font-size: 13px; font-weight: 600; color: #1565c0;">비교 기간:</span>
                                <div style="display: flex; gap: 6px;">
                                    <button class="trend-period-btn" data-trend-period="30d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">30일</button>
                                    <button class="trend-period-btn" data-trend-period="14d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">14일</button>
                                    <button class="trend-period-btn active" data-trend-period="7d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">7일</button>
                                </div>
                                <span id="trendPeriodText" style="font-size: 12px; color: #37474f; margin-left: auto;"></span>
                            </div>
                        </div>
                        <div class="compact-grid-2" style="margin-bottom: 0;">
                            <!-- 성과 개선 분석 -->
                            <div style="padding: 24px;">
                                <div class="insight-header">
                                    <span>✨ 좋은 소식: 어떤 부분이 좋아졌나요?</span>
                                </div>
                                <div class="insight-content" id="improvementTrendContent" style="display: block; max-height: 400px; overflow-y: auto;">
                                    <div class="insight-card neutral">
                                        <div class="insight-text">데이터를 불러오는 중...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 성과 하락 경고 -->
                            <div style="padding: 24px;">
                                <div class="insight-header">
                                    <span>⚠️ 주의 필요: 성과 하락 감지</span>
                                </div>
                                <div class="insight-content" id="declineTrendContent" style="display: block; max-height: 400px; overflow-y: auto;">
                                    <div class="insight-card neutral">
                                        <div class="insight-text">데이터를 불러오는 중...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 시뮬레이션 트렌드 대시보드 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📊</span>
                            <span>예산 시뮬레이션 및 주요 항목 추이</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 분석 타입 탭 -->
                        <div class="view-type-section" style="margin-bottom: 24px;">
                            <button class="view-btn analysis-tab-btn active" data-tab="budget-simulation">예산 시뮬레이션</button>
                            <button class="view-btn analysis-tab-btn" data-tab="segment-trend">주요 항목 트렌드</button>
                        </div>

                        <!-- 탭 1: 예산 시뮬레이션 -->
                        <div id="budgetSimulationMainTab" class="analysis-tab-content">
                            <div class="card" style="padding: 24px;">
                                <!-- 섹션 설명 -->
                                <div style="font-size: 13px; color: var(--grey-700); padding: 16px; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); line-height: 1.7; border-radius: 8px; margin-bottom: 24px;">
                                    <strong style="color: #f57c00;">💰 예산 시나리오 시뮬레이션이란?</strong><br>
                                    주요 항목별 예산 변경 시 예상되는 <strong>매출 변화</strong>를 시뮬레이션합니다.<br>
                                    <span style="color: var(--grey-600);">ROAS 기반 선형 모델 + 로그 체감 수익 함수를 적용하여 현실적인 예측을 제공합니다.</span>
                                </div>

                                <!-- 세그먼트 타입 선택 -->
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
                                        <!-- 세그먼트 유형 선택 -->
                                        <div>
                                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📊 주요 항목 유형 선택</div>
                                            <div class="view-type-section" style="margin-bottom: 0;">
                                                <button class="view-btn simulation-segment-btn active" data-sim-segment="all">전체</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="channel">채널별</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="product">제품별</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="brand">브랜드별</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="promotion">프로모션별</button>
                                            </div>
                                        </div>
                                        <!-- 항목 선택 드롭다운 -->
                                        <div>
                                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">🎯 항목 선택 <span id="simSelectedItemCount" style="font-size: 11px; color: #2e7d32; font-weight: 600;"></span></div>
                                            <div style="position: relative;">
                                                <button type="button" id="simItemDropdownBtn" style="min-width: 220px; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                                    <span id="simItemDropdownLabel" style="font-weight: 500;">항목을 선택하세요</span>
                                                    <span style="display: flex; align-items: center; gap: 6px;">
                                                        <span id="simItemSelectedCount" style="font-size: 11px; color: var(--grey-500);"></span>
                                                        <span style="font-size: 10px;">▼</span>
                                                    </span>
                                                </button>
                                                <div id="simItemDropdownList" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; min-width: 220px; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                    <div style="padding: 8px;">
                                                        <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                            <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                                <input type="checkbox" id="simItemSelectAll" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                                전체 선택
                                                            </label>
                                                        </div>
                                                        <div id="simItemCheckboxes"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 세그먼트별 예산 조정 슬라이더 -->
                                <div style="margin-bottom: 24px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📈 주요 항목별 예산 조정</div>
                                        <button id="resetSimulationBtn" class="reset-btn">초기화</button>
                                    </div>
                                    <div id="simulationSlidersContainer" style="display: flex; flex-direction: column; gap: 16px;">
                                        <!-- JavaScript에서 동적 생성 -->
                                    </div>
                                </div>

                                <!-- 시뮬레이션 결과 -->
                                <div style="background: var(--grey-50); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                    <div style="font-size: 14px; font-weight: 700; color: var(--grey-900); margin-bottom: 16px;">📊 시뮬레이션 결과</div>

                                    <!-- 결과 요약 카드 -->
                                    <div class="sim-result-cards">
                                        <div class="sim-result-card">
                                            <div class="sim-card-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">총 비용</div>
                                                <div class="sim-card-values">
                                                    <span id="simCurrentCost" class="sim-card-before">-</span>
                                                    <span class="sim-card-arrow">→</span>
                                                    <span id="simNewCost" class="sim-card-after" style="color: #8b5cf6;">-</span>
                                                </div>
                                                <div id="simCostChange" class="sim-card-change">-</div>
                                            </div>
                                        </div>
                                        <div class="sim-result-card highlight">
                                            <div class="sim-card-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">예상 매출</div>
                                                <div class="sim-card-values">
                                                    <span id="simCurrentRevenue" class="sim-card-before">-</span>
                                                    <span class="sim-card-arrow">→</span>
                                                    <span id="simNewRevenue" class="sim-card-after" style="color: #10b981;">-</span>
                                                </div>
                                                <div id="simRevenueChange" class="sim-card-change">-</div>
                                            </div>
                                        </div>
                                        <div class="sim-result-card">
                                            <div class="sim-card-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">평균 ROAS</div>
                                                <div class="sim-card-values">
                                                    <span id="simCurrentRoas" class="sim-card-before">-</span>
                                                    <span class="sim-card-arrow">→</span>
                                                    <span id="simNewRoas" class="sim-card-after" style="color: #f59e0b;">-</span>
                                                </div>
                                                <div id="simRoasChange" class="sim-card-change">-</div>
                                            </div>
                                        </div>
                                        <div class="sim-result-card featured">
                                            <div class="sim-card-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">투자 효율</div>
                                                <div id="simInvestmentEfficiency" class="sim-card-value-large">-</div>
                                                <div class="sim-card-subtitle">추가투자 대비 추가매출</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 세그먼트별 상세 결과 테이블 -->
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                        <div style="width: 28px; height: 28px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(103, 58, 183, 0.1)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                                <path d="M9 14l2 2 4-4"/>
                                            </svg>
                                        </div>
                                        <span style="font-size: 14px; font-weight: 600; color: var(--grey-800);">주요 항목별 상세 결과</span>
                                        <span style="font-size: 12px; color: var(--grey-400); margin-left: auto;">효율 기준: 고(150%+) / 중(50-150%) / 저(50%-)</span>
                                    </div>
                                    <div class="sim-table-container">
                                        <table id="simulationResultTable" class="sim-detail-table">
                                            <thead>
                                                <tr>
                                                    <th style="text-align: left;">주요 항목</th>
                                                    <th style="text-align: right;">현재 비용</th>
                                                    <th style="text-align: right;">변경 비용</th>
                                                    <th style="text-align: right;">현재 매출</th>
                                                    <th style="text-align: right;">예상 매출</th>
                                                    <th style="text-align: right;">현재 ROAS</th>
                                                    <th style="text-align: right;">예상 ROAS</th>
                                                    <th style="text-align: center;">추천</th>
                                                </tr>
                                            </thead>
                                            <tbody id="simulationResultBody">
                                                <!-- JavaScript에서 동적 생성 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- 통합 인사이트 박스 -->
                                <div class="sim-insight-box" id="simulationInsightBox">
                                    <div class="sim-insight-header">
                                        <div class="sim-insight-icon">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                            </svg>
                                        </div>
                                        <span class="sim-insight-title">시뮬레이션 분석</span>
                                        <div id="simulationInsightStatus" class="sim-insight-status neutral">
                                            <span>대기 중</span>
                                        </div>
                                    </div>
                                    <div class="sim-insight-content">
                                        <div class="sim-insight-main">
                                            <div class="sim-insight-main-title">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                                </svg>
                                                분석 결과
                                            </div>
                                            <div id="simulationInsight" class="sim-insight-main-text">
                                                주요 항목별 예산을 조정하면 예상 결과가 표시됩니다.
                                            </div>
                                        </div>
                                        <div class="sim-insight-notes">
                                            <div class="sim-insight-notes-title">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                </svg>
                                                시뮬레이션 주의사항
                                            </div>
                                            <ul class="sim-insight-notes-list" style="list-style: none; padding: 0; margin: 0;">
                                                <li>예산 증가 시 <strong>체감 수익 효과</strong>가 적용됩니다</li>
                                                <li>실제 결과는 시장 상황, 경쟁에 따라 달라질 수 있습니다</li>
                                                <li>본 시뮬레이션은 의사결정 <strong>참고용</strong>입니다</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 2: 세그먼트 트렌드 -->
                        <div id="segmentTrendTab" class="analysis-tab-content" style="display: none;">
                            <!-- 세그먼트 타입 하위탭 및 집계 단위 (탭 바로 아래) -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div class="view-type-section" style="margin-bottom: 0;">
                                    <button class="view-btn segment-trend-type-btn active" data-segment="overall">전체</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="channel">채널별</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="product">제품별</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="brand">브랜드별</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="promotion">프로모션별</button>
                                </div>
                                <div class="view-type-section" style="margin-bottom: 0;">
                                    <button class="view-btn segment-trend-view-btn active" data-view="monthly">월별</button>
                                    <button class="view-btn segment-trend-view-btn" data-view="weekly">주별</button>
                                    <button class="view-btn segment-trend-view-btn" data-view="daily">일별</button>
                                </div>
                            </div>

                            <!-- 전체 성과 예측 콘텐츠 (하위탭: 전체) -->
                            <div id="segmentTrendOverallContent" class="segment-trend-content">
                                <div class="chart-section card">
                                    <div class="chart-section-header">
                                        <div class="chart-header">성과 예측 추이</div>
                                    </div>
                                    <!-- 차트 컨트롤 영역 (기존 위치) -->
                                    <div class="chart-controls">
                                        <div class="chart-toggle-group" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button type="button" class="data-label-toggle active" data-chart-toggle="chartCostTrend">
                                                <span class="toggle-checkbox">✓</span>
                                                <span>비용</span>
                                            </button>
                                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPMTrend">
                                                <span class="toggle-checkbox">☐</span>
                                                <span>CPM</span>
                                            </button>
                                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPCTrend">
                                                <span class="toggle-checkbox">☐</span>
                                                <span>CPC</span>
                                            </button>
                                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPATrend">
                                                <span class="toggle-checkbox">☐</span>
                                                <span>CPA</span>
                                            </button>
                                            <button type="button" class="data-label-toggle active" data-chart-toggle="chartROASTrend">
                                                <span class="toggle-checkbox">✓</span>
                                                <span>ROAS</span>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- 숨겨진 체크박스 (기존 기능 유지용) -->
                                    <div style="display: none;">
                                        <input type="checkbox" id="chartCostTrend" checked>
                                        <input type="checkbox" id="chartCPMTrend">
                                        <input type="checkbox" id="chartCPCTrend">
                                        <input type="checkbox" id="chartCPATrend">
                                        <input type="checkbox" id="chartROASTrend" checked>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="forecastChartTrend"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- 세그먼트별 콘텐츠 (하위탭: 채널별/제품별/브랜드별/프로모션별) -->
                            <div id="segmentTrendSegmentContent" class="segment-trend-content" style="display: none;">
                                <div class="chart-section card">
                                <!-- 상단 헤더 -->
                                <div style="margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div class="chart-header" style="margin-bottom: 4px;">시간에 따른 주요 항목 성과 추이</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                        시간에 따른 각 주요 항목의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                    </p>
                                </div>

                                <!-- 지표 선택, 기간 선택, 항목 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="segmentTrendMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                        </select>
                                    </div>

                                    <!-- 항목 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📊 항목 선택 <span style="font-size: 12px; color: #2e7d32; font-weight: 600;">🎯 <span id="selectedSegmentCount">0</span>개 선택됨</span></div>
                                        <div style="position: relative;">
                                            <button type="button" id="segmentTrendDropdownBtn" style="min-width: 200px; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span id="segmentTrendDropdownLabel" style="font-weight: 500;">항목을 선택하세요</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span id="segmentTrendSelectedCount" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div id="segmentTrendDropdownList" style="display: none; position: absolute; top: 100%; left: 0; min-width: 250px; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" id="segmentTrendSelectAll" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택 (최대 5개)
                                                        </label>
                                                    </div>
                                                    <div id="segmentTrendCheckboxes" class="segment-trend-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="segmentTrendStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="segmentTrendEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 트렌드 차트 -->
                                <div class="chart-container">
                                    <canvas id="segmentTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 주요 항목은 예산을 확대하고, 하락 추세를 보이는 주요 항목은 원인을 분석하여 개선하세요.
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 4. 통합 시각화 대시보드 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📊</span>
                            <span>데이터 분석 알고리즘</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 시각화 타입 탭 -->
                        <!-- 통계 분석 시각화 -->
                        <div id="statisticsVizTab" class="viz-tab-content" style="display: block;">
                            <!-- 섹션 설명 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px; background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); line-height: 1.7; border-radius: 8px; margin-bottom: 24px;">
                                <strong style="color: var(--primary-main);">📖 통계 분석이란?</strong><br>
                                AI 알고리즘을 활용하여 <strong>데이터의 숨겨진 패턴과 미래 트렌드</strong>를 발견합니다.<br>
                                <span style="color: var(--grey-600);">시계열 예측, 계절성 분석, 지표 간 상관관계를 통해 데이터 기반 의사결정을 지원합니다.</span><br><br>
                                <strong style="color: var(--primary-main);">💡 어떻게 활용하나요?</strong><br>
                                • <strong>예측 & 트렌드</strong>: 미래 성과를 예측하고 계절적 패턴을 파악하여 선제적 대응<br>
                                • <strong>관계 & 품질</strong>: 지표 간 연관성을 이해하고 데이터 품질을 검증하여 정확한 분석
                            </div>

                            <!-- 통계 분석 서브 탭 -->
                            <div class="view-type-section" style="margin-bottom: 24px;">
                                <button class="view-btn statistics-subtab-btn active" data-statistics-tab="forecast-trend">📈 예측 & 트렌드</button>
                                <button class="view-btn statistics-subtab-btn" data-statistics-tab="correlation-quality">🔍 관계 & 품질</button>
                            </div>

                            <!-- 서브 탭 1: 예측 & 트렌드 -->
                            <div id="forecastTrendTab" class="statistics-subtab-content" style="display: block;">
                                <!-- 시계열 예측 분석 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div class="visualization-title" style="margin-bottom: 16px;">📈 시계열 예측 분석</div>
                                    <div class="img-tooltip-wrapper" data-tooltip="실제 데이터와 Prophet 모델을 사용한 미래 예측을 표시합니다. 신뢰구간과 함께 향후 추세를 확인할 수 있습니다." style="margin-bottom: 20px;">
                                        <img src="visualizations/timeseries_forecast.png" alt="시계열 예측" class="visualization-img">
                                    </div>

                                    <!-- 예측 분석 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 예측 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card positive" style="border-left-color: var(--secondary-main);">
                                            <div class="insight-title" style="font-size: 13px;">🎯 예측 정확도</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                Prophet 알고리즘을 통해 <strong>95% 신뢰구간</strong>으로 향후 30일 성과를 예측합니다.
                                                과거 패턴 기반의 신뢰할 수 있는 예측입니다.
                                            </div>
                                        </div>
                                        <div class="insight-card neutral">
                                            <div class="insight-title" style="font-size: 13px;">📊 추세 분석</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                장기 트렌드를 파악하여 <strong>성장 또는 하락 구간</strong>을 식별합니다.
                                                시즌별 성과 변동을 미리 대비하세요.
                                            </div>
                                        </div>
                                        <div class="insight-card positive">
                                            <div class="insight-title" style="font-size: 13px;">⚡ 실무 활용</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                예측 데이터로 <strong>사전 예산 조정</strong>, <strong>재고 계획</strong>,
                                                <strong>프로모션 타이밍</strong>을 최적화할 수 있습니다.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 예측 해석 가이드 -->
                                    <div style="background: var(--grey-50); padding: 16px; border-radius: 8px; border-left: 4px solid var(--secondary-main);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--grey-900);">📚 예측 차트 읽는 법</div>
                                        <div style="display: grid; gap: 8px; font-size: 12px; color: var(--grey-700);">
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--secondary-main); font-weight: 600;">●</span>
                                                <span><strong>파란색 실선</strong>: 실제 관측된 데이터 (과거 실적)</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--primary-main); font-weight: 600;">●</span>
                                                <span><strong>보라색 실선</strong>: AI 모델의 예측값 (미래 예상 성과)</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--grey-500); font-weight: 600;">▓</span>
                                                <span><strong>음영 영역</strong>: 95% 신뢰구간 (실제 값이 이 범위에 있을 확률 95%)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 계절성 분해 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div class="visualization-title" style="margin-bottom: 16px;">🔄 계절성 분해 분석</div>
                                    <div class="img-tooltip-wrapper" data-tooltip="시계열 데이터를 추세(Trend), 계절성(Seasonal), 잔차(Residual) 성분으로 분해하여 패턴을 분석합니다." style="margin-bottom: 20px;">
                                        <img src="visualizations/seasonal_decomposition.png" alt="계절성 분해" class="visualization-img">
                                    </div>

                                    <!-- 계절성 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 계절성 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card positive">
                                            <div class="insight-title" style="font-size: 13px;">📈 Trend (추세)</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                장기적인 <strong>상승/하락 방향</strong>을 보여줍니다.
                                                전체적인 비즈니스 성장세를 파악할 수 있습니다.
                                            </div>
                                        </div>
                                        <div class="insight-card neutral">
                                            <div class="insight-title" style="font-size: 13px;">🔄 Seasonal (계절성)</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                <strong>주기적으로 반복되는 패턴</strong>을 식별합니다.
                                                월별, 요일별 성과 변동을 예측할 수 있습니다.
                                            </div>
                                        </div>
                                        <div class="insight-card positive" style="border-left-color: var(--warning-main);">
                                            <div class="insight-title" style="font-size: 13px;">📊 Residual (잔차)</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                추세와 계절성으로 설명되지 않는 <strong>불규칙한 변동</strong>입니다.
                                                이상 이벤트나 외부 요인을 파악하세요.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 실무 활용 팁 -->
                                    <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); padding: 16px; border-radius: 8px;">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--primary-main);">🎯 실무 활용 팁</div>
                                        <div style="display: grid; gap: 8px; font-size: 12px; color: var(--grey-700);">
                                            <div><strong>✓ 계절성 패턴 활용</strong>: 성수기/비수기를 미리 파악하여 예산과 재고를 사전 조정</div>
                                            <div><strong>✓ 추세 기반 전략</strong>: 상승 추세 시 공격적 투자, 하락 추세 시 효율성 개선에 집중</div>
                                            <div><strong>✓ 잔차 분석</strong>: 큰 변동이 발생한 시점을 찾아 특별한 이벤트나 캠페인 효과 분석</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 서브 탭 2: 관계 & 품질 -->
                            <div id="correlationQualityTab" class="statistics-subtab-content" style="display: none;">
                                <!-- 상관관계 히트맵 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div class="visualization-title" style="margin-bottom: 16px;">🔗 상관관계 히트맵</div>
                                    <div class="img-tooltip-wrapper" data-tooltip="주요 마케팅 지표(비용, 전환수, 매출 등) 간의 상관관계를 색상으로 표현합니다. 진한 색일수록 강한 상관관계를 의미합니다." style="margin-bottom: 20px; max-width: 70%; margin-left: auto; margin-right: auto;">
                                        <img src="visualizations/correlation_heatmap.png" alt="상관관계" class="visualization-img">
                                    </div>

                                    <!-- 상관관계 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 상관관계 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card positive">
                                            <div class="insight-title" style="font-size: 13px;">🔴 강한 양의 상관</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                진한 빨간색(+0.7 이상)은 <strong>함께 증가하는 관계</strong>입니다.
                                                예: 비용↑ → 전환수↑
                                            </div>
                                        </div>
                                        <div class="insight-card neutral">
                                            <div class="insight-title" style="font-size: 13px;">🔵 강한 음의 상관</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                진한 파란색(-0.7 이하)은 <strong>반대로 움직이는 관계</strong>입니다.
                                                예: CPA↑ → ROAS↓
                                            </div>
                                        </div>
                                        <div class="insight-card positive" style="border-left-color: var(--warning-main);">
                                            <div class="insight-title" style="font-size: 13px;">⚪ 약한 상관</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                연한 색(-0.3 ~ +0.3)은 <strong>독립적인 관계</strong>입니다.
                                                서로 영향을 주지 않는 지표입니다.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 상관관계 활용 가이드 -->
                                    <div style="background: var(--grey-50); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success-main);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--grey-900);">📚 상관관계 활용 전략</div>
                                        <div style="display: grid; gap: 8px; font-size: 12px; color: var(--grey-700);">
                                            <div><strong>1. 레버리지 지표 발견</strong>: 전환수/매출과 강한 양의 상관관계를 가진 지표에 집중 투자</div>
                                            <div><strong>2. 비효율 요인 제거</strong>: 비용과 강한 양의 상관이지만 매출과 약한 상관인 채널은 재검토</div>
                                            <div><strong>3. 다변량 최적화</strong>: 여러 지표 간 관계를 고려한 종합적인 마케팅 전략 수립</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 이미지 좌우 배치: 이상치 & 데이터 분포 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                                        <!-- 왼쪽: 이상치 분석 -->
                                        <div>
                                            <div class="visualization-title" style="margin-bottom: 16px; text-align: center;">⚠️ 이상치 분석</div>
                                            <div class="img-tooltip-wrapper" data-tooltip="데이터 분포와 이상치(Outliers)를 박스플롯으로 시각화합니다. 상자 밖의 점들이 이상치를 나타냅니다.">
                                                <img src="visualizations/boxplot_outliers.png" alt="이상치 분석" class="visualization-img">
                                            </div>
                                        </div>

                                        <!-- 오른쪽: 데이터 분포 -->
                                        <div>
                                            <div class="visualization-title" style="margin-bottom: 16px; text-align: center;">📊 데이터 분포 분석</div>
                                            <div class="img-tooltip-wrapper" data-tooltip="주요 지표의 히스토그램과 확률 분포를 표시합니다. 데이터의 정규성과 편향을 확인할 수 있습니다.">
                                                <img src="visualizations/distribution_analysis.png" alt="분포 분석" class="visualization-img">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 데이터 품질 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 데이터 품질 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card negative">
                                            <div class="insight-title" style="font-size: 13px;">⚠️ 이상치 탐지</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                박스플롯에서 <strong>상자 밖의 점</strong>은 이상치입니다.
                                                데이터 오류인지, 특별한 이벤트인지 확인하세요.
                                                <div style="margin-top: 8px; padding: 8px; background: var(--error-light); border-radius: 4px;">
                                                    <strong>체크포인트</strong>: 이상치가 5% 이상이면 데이터 품질 재검토 필요
                                                </div>
                                            </div>
                                        </div>
                                        <div class="insight-card positive" style="border-left-color: var(--secondary-main);">
                                            <div class="insight-title" style="font-size: 13px;">📊 분포 패턴</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                히스토그램이 <strong>종 모양</strong>이면 정규분포입니다.
                                                편향되거나 여러 봉우리가 있다면 주요 항목 분리를 고려하세요.
                                                <div style="margin-top: 8px; padding: 8px; background: var(--secondary-light); border-radius: 4px;">
                                                    <strong>TIP</strong>: 정규분포일수록 예측 모델의 정확도가 높아집니다
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 데이터 품질 체크리스트 -->
                                    <div style="background: linear-gradient(135deg, #fff4f0 0%, #ffebe8 100%); padding: 16px; border-radius: 8px; border-left: 4px solid var(--error-main);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--error-main);">🔍 데이터 품질 체크리스트</div>
                                        <div style="display: grid; gap: 6px; font-size: 12px; color: var(--grey-700);">
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>이상치 비율이 5% 미만인가?</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>데이터 분포가 예상 범위 내에 있는가?</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>이상치 발생 시점에 특별 이벤트가 있었는가?</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>결측치나 0값이 비정상적으로 많지 않은가?</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 전역 변수
        let forecastData = [];
        let currentView = 'monthly';
        let forecastChart = null;
        let forecastChartTrend = null;  // 세그먼트 트렌드 내 전체 성과 예측 차트
        let insightsData = null;
        let currentPeriod = 'full';  // 분석 기간 (full, 180d, 90d)
        let aiSummaryPeriod = 'full';  // AI 요약 분석 기간 (독립)
        let alertsExpanded = false;  // 경고 펼침 상태
        let recommendationsExpanded = false;  // 추천 펼침 상태
        const INITIAL_ALERTS_COUNT = 6;  // 초기 표시 개수 (2x3)
        const INITIAL_RECOMMENDATIONS_COUNT = 4;  // 초기 추천 표시 개수

        // ============================================================================
        // 기간 필터링 헬퍼 함수
        // ============================================================================

        /**
         * 현재 선택된 기간의 인사이트 데이터 반환
         * @returns {Object} 기간별 인사이트 데이터
         */
        function getPeriodData() {
            if (!insightsData) return null;

            // by_period 구조인 경우
            if (insightsData.by_period) {
                return insightsData.by_period[currentPeriod] || insightsData.by_period['full'];
            }

            // 단일 구조인 경우 (이전 버전 호환)
            return insightsData;
        }

        /**
         * 기간 전환 함수
         * @param {string} period - 기간 (full, 180d, 90d)
         */
        function switchPeriod(period) {
            currentPeriod = period;
            alertsExpanded = false;  // 기간 전환 시 경고 펼침 상태 초기화
            recommendationsExpanded = false;  // 기간 전환 시 추천 펼침 상태 초기화

            // 버튼 활성화 상태 변경 (pill 스타일)
            document.querySelectorAll('.period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.add('active');
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                }
            });

            // 인사이트 데이터가 있으면 업데이트 (AI 요약 제외)
            if (insightsData) {
                updateAllInsights();
                updatePeriodIndicator();
            }

            console.log(`기간 전환: ${period}`);
        }

        /**
         * AI 요약 기간별 데이터 반환
         * @returns {Object} AI 요약용 기간별 인사이트 데이터
         */
        function getAiSummaryPeriodData() {
            if (!insightsData) return null;

            if (insightsData.by_period) {
                return insightsData.by_period[aiSummaryPeriod] || insightsData.by_period['full'];
            }

            return insightsData;
        }

        /**
         * AI 요약 기간 전환 함수 (통합: AI 요약 + 경고/추천/기회/Matrix 탭)
         * @param {string} period - 기간 (full, 180d, 90d, 30d)
         */
        function switchAiSummaryPeriod(period) {
            aiSummaryPeriod = period;
            currentPeriod = period;  // 분석 기간도 함께 동기화
            alertsExpanded = false;  // 펼침 상태 초기화
            recommendationsExpanded = false;

            // 버튼 활성화 상태 변경 (pill 스타일)
            document.querySelectorAll('.ai-period-btn').forEach(btn => {
                if (btn.dataset.aiPeriod === period) {
                    btn.classList.add('active');
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                }
            });

            // AI 요약 + 모든 인사이트 탭 업데이트
            updateAiSummary();
            if (insightsData) {
                updateAllInsights();
            }

            console.log(`AI 요약 기간 전환 (통합): ${period}`);
        }

        /**
         * 실제 데이터 기간 표시 업데이트
         */
        function updatePeriodIndicator() {
            const indicator = document.getElementById('actualPeriodIndicator');
            if (!indicator) return;

            const periodData = getPeriodData();
            if (!periodData || !periodData.overall) {
                indicator.textContent = '';
                return;
            }

            // current_period가 있으면 사용, 없으면 forecast_period 사용
            const current = periodData.overall.current_period;
            const forecast = periodData.overall.forecast_period;

            let startDate = '';
            let endDate = '';
            let label = '실제 분석';

            if (current && current.start_date && current.end_date) {
                startDate = current.start_date;
                endDate = current.end_date;
                label = '실제 분석';
            } else if (forecast && forecast.start_date && forecast.end_date) {
                startDate = forecast.start_date;
                endDate = forecast.end_date;
                label = '예측 기간';
            }

            if (startDate && endDate) {
                indicator.innerHTML = `<span style="margin-right: 4px;">📅</span> ${label}: ${startDate} ~ ${endDate}`;
            } else {
                indicator.textContent = '';
            }
        }

        /**
         * 모든 인사이트 섹션 업데이트 (AI 요약 제외 - 독립 기간 설정)
         */
        function updateAllInsights() {
            updateSummaryCard();
            // updateAiSummary는 독립적인 기간 설정을 사용하므로 여기서 호출하지 않음
            updateOpportunities();
            updateInsightsBadges();
            updateInsightsFromData();  // 경고 알림 업데이트
            updateRecommendations();
            updatePerformanceTrends();
        }

        // 세그먼트 관련 전역 변수
        let segmentData = {
            channel: [],
            product: [],
            brand: [],
            promotion: []
        };
        let segmentTrendChart = null;
        let currentTrendSegmentType = 'overall';  // 전체 성과 예측이 기본
        let segmentTrendViewType = 'monthly';  // 세그먼트 트렌드 뷰 타입 (monthly, weekly, daily)
        let segmentTrendMetric = 'roas';  // 세그먼트 트렌드 지표 (roas, cost, revenue, conversions)
        let segmentTrendStartDate = '';   // 세그먼트 트렌드 시작일
        let segmentTrendEndDate = '';     // 세그먼트 트렌드 종료일
        let dailyDataForKPI = [];  // KPI 요약용 일별 원본 데이터 (뷰 타입과 독립)

        // 숫자 포맷
        function formatNumber(num) {
            if (num === 0 || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        }

        // 소수점 포맷 (2자리)
        function formatDecimal(num) {
            if (num === 0 || num === null || num === undefined || !isFinite(num)) return '0';
            return num.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }

        // 퍼센트 포맷
        function formatPercent(num) {
            if (num === 0 || num === null || num === undefined || !isFinite(num)) return '0';
            return num.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
        }

        // CSV 파싱 (RFC 4180 호환)
        function parseCSV(text) {
            const lines = text.trim().split('\n');

            // RFC 4180 호환 CSV 파싱
            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // 연속된 따옴표는 이스케이프된 따옴표
                            current += '"';
                            i++; // 다음 따옴표 건너뛰기
                        } else {
                            // 따옴표 시작/종료
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 따옴표 밖의 쉼표는 구분자
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                // 마지막 필드 추가
                result.push(current);
                return result;
            }

            const headers = parseLine(lines[0]).map(h => h.trim());

            return lines.slice(1).map(line => {
                const values = parseLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
        }

        // 데이터 로드
        async function loadData() {
            try {
                // 항상 일별 데이터를 로드하고 뷰에 따라 집계
                const response = await fetch('forecast/predictions_daily.csv');
                const text = await response.text();
                const dailyData = parseCSV(text);

                // KPI 요약용 일별 원본 데이터 저장 (최초 로드 시에만)
                if (dailyDataForKPI.length === 0) {
                    dailyDataForKPI = dailyData;
                }

                // 뷰 타입에 따라 데이터 집계 (차트용)
                if (currentView === 'daily') {
                    forecastData = dailyData;
                } else {
                    forecastData = aggregateData(dailyData, currentView);
                }

                updateDashboard();

                // 세그먼트 트렌드 전체 성과 예측 차트도 업데이트
                if (currentTrendSegmentType === 'overall') {
                    updateOverallForecastChart();
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
            }
        }

        // 인사이트 데이터 로드
        async function loadInsightsAndSegments() {
            try {
                // insights.json 로드
                const insightsResponse = await fetch('forecast/insights.json');
                if (!insightsResponse.ok) {
                    throw new Error(`insights.json 로드 실패: ${insightsResponse.status}`);
                }
                insightsData = await insightsResponse.json();

                // 인사이트 업데이트
                updateSummaryCard();
                updateAiSummary();
                updateInsightsFromData();
                updateRecommendations();
                updateOpportunities();
                updateInsightsBadges();
                updatePerformanceTrends();
                updatePeriodIndicator();
            } catch (error) {
                console.error('인사이트 데이터 로드 실패:', error);

                // 에러 메시지 표시
                const recommendationContainer = document.getElementById('recommendationContent');
                if (recommendationContainer) {
                    recommendationContainer.innerHTML = `
                        <div class="insight-card neutral">
                            <div class="insight-text">데이터 로드 실패: ${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // 세그먼트 CSV 데이터 로드
        async function loadSegmentData() {
            try {
                const segmentTypes = ['channel', 'product', 'brand', 'promotion'];

                for (const type of segmentTypes) {
                    const response = await fetch(`forecast/segment_${type}.csv`);
                    if (!response.ok) {
                        console.warn(`segment_${type}.csv 로드 실패`);
                        continue;
                    }
                    const text = await response.text();
                    segmentData[type] = parseCSV(text);
                }

                // 세그먼트 분석 초기화
                initSegmentAnalysis();
            } catch (error) {
                console.error('세그먼트 데이터 로드 실패:', error);
            }
        }

        // 세그먼트 분석 초기화
        function initSegmentAnalysis() {
            updateSegmentTrendCheckboxes();
            initSegmentTrendDateRange();  // 기간 초기값 설정

            // 예산 시뮬레이션 초기화 (기본 탭)
            if (typeof initSimulation === 'function') {
                initSimulation();
            }
        }

        // 세그먼트 트렌드 기간 초기값 설정
        function initSegmentTrendDateRange() {
            const data = segmentData['channel'];  // 기본적으로 channel 데이터 사용
            if (!data || data.length === 0) return;

            // 날짜 추출 및 정렬
            const dates = data.map(row => row['일 구분']).filter(Boolean).sort();
            if (dates.length === 0) return;

            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];

            // 날짜 입력 필드에 초기값 설정
            const startInput = document.getElementById('segmentTrendStartDate');
            const endInput = document.getElementById('segmentTrendEndDate');

            if (startInput) {
                startInput.value = minDate;
                startInput.min = minDate;
                startInput.max = maxDate;
                segmentTrendStartDate = minDate;
            }

            if (endInput) {
                endInput.value = maxDate;
                endInput.min = minDate;
                endInput.max = maxDate;
                segmentTrendEndDate = maxDate;
            }
        }

        // 세그먼트 트렌드 드롭다운 라벨 업데이트
        function updateSegmentTrendDropdownLabel() {
            const checkedBoxes = document.querySelectorAll('.segment-trend-checkbox:checked');
            const labelEl = document.getElementById('segmentTrendDropdownLabel');
            const countEl = document.getElementById('segmentTrendSelectedCount');
            const countEl2 = document.getElementById('selectedSegmentCount');

            if (labelEl) {
                if (checkedBoxes.length === 0) {
                    labelEl.textContent = '항목을 선택하세요';
                } else if (checkedBoxes.length === 1) {
                    labelEl.textContent = checkedBoxes[0].dataset.segment;
                } else {
                    labelEl.textContent = `${checkedBoxes[0].dataset.segment} 외 ${checkedBoxes.length - 1}개`;
                }
            }

            if (countEl) {
                countEl.textContent = checkedBoxes.length > 0 ? `${checkedBoxes.length}개` : '';
            }

            if (countEl2) {
                countEl2.textContent = checkedBoxes.length;
            }
        }

        // 세그먼트 트렌드 체크박스 업데이트
        function updateSegmentTrendCheckboxes() {
            const container = document.getElementById('segmentTrendCheckboxes');
            if (!container) return;

            const data = segmentData[currentTrendSegmentType];
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div style="padding: 12px; text-align: center; color: var(--grey-600); font-size: 12px;">
                        해당 주요 항목 데이터가 없습니다.
                    </div>
                `;
                updateSegmentTrendDropdownLabel();
                return;
            }

            // 세그먼트 이름 추출
            const segmentNames = [...new Set(data.map(row =>
                row[currentTrendSegmentType] || row.channel || row.product || row.brand || row.promotion
            ))].filter(Boolean);

            // 드롭다운 체크박스 아이템 생성
            const html = segmentNames.map((name, index) => `
                <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                    <input type="checkbox" class="segment-trend-checkbox" data-segment="${name}" ${index < 3 ? 'checked' : ''} style="margin-right: 10px; width: 14px; height: 14px; cursor: pointer;">
                    <span>${name}</span>
                </label>
            `).join('');

            container.innerHTML = html;

            // 전체 선택 체크박스 상태 업데이트
            updateSelectAllState();

            // 체크박스 이벤트 추가
            document.querySelectorAll('.segment-trend-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // 최대 5개만 선택 가능
                    const checkedCount = document.querySelectorAll('.segment-trend-checkbox:checked').length;
                    if (checkedCount > 5) {
                        this.checked = false;
                        alert('최대 5개 항목까지만 선택할 수 있습니다.');
                        return;
                    }
                    updateSelectAllState();
                    updateSegmentTrendDropdownLabel();
                    updateSegmentTrendChart();
                });
            });

            // 드롭다운 라벨 업데이트
            updateSegmentTrendDropdownLabel();

            // 초기 차트 그리기
            updateSegmentTrendChart();
        }

        // 전체 선택 체크박스 상태 업데이트
        function updateSelectAllState() {
            const selectAllCheckbox = document.getElementById('segmentTrendSelectAll');
            const allCheckboxes = document.querySelectorAll('.segment-trend-checkbox');
            const checkedCount = document.querySelectorAll('.segment-trend-checkbox:checked').length;

            if (selectAllCheckbox) {
                // 5개 또는 전체가 선택되어 있으면 체크
                selectAllCheckbox.checked = (checkedCount === allCheckboxes.length) || (checkedCount === 5);
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < Math.min(5, allCheckboxes.length);
            }
        }

        // 세그먼트 트렌드 차트 업데이트
        function updateSegmentTrendChart() {
            const data = segmentData[currentTrendSegmentType];
            if (!data || data.length === 0) return;

            // 선택된 세그먼트 가져오기
            const selectedSegments = Array.from(document.querySelectorAll('.segment-trend-checkbox:checked'))
                .map(cb => cb.dataset.segment);

            // 선택된 개수 업데이트
            const countEl = document.getElementById('selectedSegmentCount');
            if (countEl) {
                countEl.textContent = selectedSegments.length;
            }

            if (selectedSegments.length === 0) {
                // 차트 초기화
                if (segmentTrendChart) {
                    segmentTrendChart.destroy();
                    segmentTrendChart = null;
                }
                return;
            }

            // 날짜 키 생성 함수 (뷰 타입에 따라)
            const getDateKey = (dateStr) => {
                const date = new Date(dateStr);
                if (segmentTrendViewType === 'weekly') {
                    // 주 시작일 (월요일) 계산
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(date);
                    monday.setDate(diff);
                    return monday.toISOString().split('T')[0];
                } else if (segmentTrendViewType === 'monthly') {
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                return dateStr;  // daily
            };

            // 날짜별로 데이터 그룹화 (뷰 타입 적용 + 기간 필터)
            const dateGroups = {};
            data.forEach(row => {
                const rowDate = row['일 구분'];

                // 기간 필터 적용
                if (segmentTrendStartDate && rowDate < segmentTrendStartDate) return;
                if (segmentTrendEndDate && rowDate > segmentTrendEndDate) return;

                const dateKey = getDateKey(rowDate);
                const segmentName = row[currentTrendSegmentType] || row.channel || row.product || row.brand || row.promotion;

                if (!selectedSegments.includes(segmentName)) return;

                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = {};
                }
                if (!dateGroups[dateKey][segmentName]) {
                    dateGroups[dateKey][segmentName] = {
                        cost: 0,
                        conversions: 0,
                        revenue: 0,
                        hasActual: false,
                        hasForecast: false
                    };
                }

                dateGroups[dateKey][segmentName].cost += parseFloat(row['비용_예측']) || 0;
                dateGroups[dateKey][segmentName].conversions += parseFloat(row['전환수_예측']) || 0;
                dateGroups[dateKey][segmentName].revenue += parseFloat(row['전환값_예측']) || 0;

                // 타입 추적
                if (row.type === 'actual') dateGroups[dateKey][segmentName].hasActual = true;
                if (row.type === 'forecast') dateGroups[dateKey][segmentName].hasForecast = true;
            });

            // 날짜 정렬
            const dates = Object.keys(dateGroups).sort();

            // 지표별 값 계산 함수
            const getMetricValue = (seg) => {
                if (!seg) return 0;
                switch (segmentTrendMetric) {
                    case 'roas':
                        return seg.cost > 0 ? (seg.revenue / seg.cost * 100) : 0;
                    case 'cost':
                        return seg.cost;
                    case 'revenue':
                        return seg.revenue;
                    case 'conversions':
                        return seg.conversions;
                    default:
                        return seg.cost > 0 ? (seg.revenue / seg.cost * 100) : 0;
                }
            };

            // 지표별 Y축 라벨
            const metricLabels = {
                roas: 'ROAS (%)',
                cost: '비용 (원)',
                revenue: '전환값 (원)',
                conversions: '전환수'
            };

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#ff9800', '#4caf50', '#00c853', '#9c27b0', '#03a9f4', '#8bc34a', '#ff5722'];
            const datasets = selectedSegments.map((segmentName, index) => {
                const values = dates.map(date => {
                    const seg = dateGroups[date][segmentName];
                    return getMetricValue(seg);
                });

                // 실제/예측 구분 (주별/월별 집계 시 혼합 처리)
                const actualValues = values.map((val, idx) => {
                    const seg = dateGroups[dates[idx]][segmentName];
                    // 실제 데이터만 있거나, 혼합(실제+예측)인 경우 실제값으로 표시
                    const isActual = seg && seg.hasActual && !seg.hasForecast;
                    const isMixed = seg && seg.hasActual && seg.hasForecast;
                    return (isActual || isMixed) ? val : null;
                });
                const forecastValues = values.map((val, idx) => {
                    const seg = dateGroups[dates[idx]][segmentName];
                    // 예측 데이터만 있는 경우 예측값으로 표시
                    const isForecast = seg && seg.hasForecast && !seg.hasActual;
                    return isForecast ? val : null;
                });

                // 연결을 위해 마지막 실제값을 예측 시작점에 추가
                const lastActualIdx = actualValues.findLastIndex(v => v !== null);
                if (lastActualIdx >= 0 && lastActualIdx < forecastValues.length - 1) {
                    forecastValues[lastActualIdx] = actualValues[lastActualIdx];
                }

                const color = colors[index % colors.length];

                return [
                    {
                        label: segmentName,
                        data: actualValues,
                        borderColor: color,
                        backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: false,
                        tension: 0.4,
                        spanGaps: false
                    },
                    {
                        label: segmentName + ' (예측)',
                        data: forecastValues,
                        borderColor: color,
                        backgroundColor: color.replace(')', ', 0.05)').replace('rgb', 'rgba'),
                        borderWidth: 2,
                        borderDash: [6, 4],
                        pointRadius: 4,
                        pointStyle: 'triangle',
                        fill: false,
                        tension: 0.4,
                        spanGaps: false
                    }
                ];
            }).flat();

            // 차트 그리기
            const ctx = document.getElementById('segmentTrendChart');
            if (!ctx) return;

            if (segmentTrendChart) {
                segmentTrendChart.destroy();
            }

            segmentTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                filter: function(item) {
                                    // 예측 데이터셋은 범례에서 숨김
                                    return !item.text.includes('(예측)');
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    label = label.replace(' (예측)', '');
                                    if (label) {
                                        label += ': ';
                                    }

                                    // 지표별 포맷팅
                                    if (segmentTrendMetric === 'roas') {
                                        label += formatDecimal(context.parsed.y) + '%';
                                    } else if (segmentTrendMetric === 'conversions') {
                                        label += formatNumber(context.parsed.y) + '건';
                                    } else {
                                        label += formatNumber(context.parsed.y) + '원';
                                    }

                                    // 예측값 여부 표시
                                    if (context.dataset.borderDash) {
                                        label += ' (예측)';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: metricLabels[segmentTrendMetric] || 'ROAS (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (segmentTrendMetric === 'roas') {
                                        return value + '%';
                                    } else if (segmentTrendMetric === 'conversions') {
                                        return formatNumber(value);
                                    } else {
                                        return formatNumber(value);
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 데이터 집계 (주별/월별)
        function aggregateData(data, viewType) {
            const groups = {};

            data.forEach(row => {
                let key;
                const date = new Date(row['일 구분']);

                if (viewType === 'weekly') {
                    // 주 시작일 (월요일) 계산
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(date);
                    monday.setDate(diff);
                    key = monday.toISOString().split('T')[0];
                } else if (viewType === 'monthly') {
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }

                if (!groups[key]) {
                    groups[key] = {
                        비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0,
                        hasActual: false, hasForecast: false
                    };
                }

                groups[key].비용 += parseFloat(row['비용_예측']) || 0;
                groups[key].노출 += parseFloat(row['노출_예측']) || 0;
                groups[key].클릭 += parseFloat(row['클릭_예측']) || 0;
                groups[key].전환수 += parseFloat(row['전환수_예측']) || 0;
                groups[key].전환값 += parseFloat(row['전환값_예측']) || 0;

                if (row.type === 'actual') groups[key].hasActual = true;
                if (row.type === 'forecast') groups[key].hasForecast = true;
            });

            // 정렬 및 변환
            return Object.entries(groups)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([period, values]) => ({
                    '일 구분': period,
                    '비용_예측': values.비용,
                    '노출_예측': values.노출,
                    '클릭_예측': values.클릭,
                    '전환수_예측': values.전환수,
                    '전환값_예측': values.전환값,
                    // 예측 데이터가 포함되어 있으면 forecast로 표시
                    type: values.hasForecast && !values.hasActual ? 'forecast' :
                          values.hasForecast && values.hasActual ? 'mixed' : 'actual'
                }));
        }

        // 대시보드 업데이트
        function updateDashboard() {
            updateKPISummary();
            updateChart();
        }

        // KPI 요약 업데이트 (일별 원본 데이터 사용 - 뷰 타입과 독립)
        function updateKPISummary() {
            // 일별 원본 데이터 사용 (뷰 타입 변경에 영향받지 않음)
            const dataSource = dailyDataForKPI.length > 0 ? dailyDataForKPI : forecastData;
            const actualData = dataSource.filter(d => d.type === 'actual');
            const forecastDataOnly = dataSource.filter(d => d.type === 'forecast');

            // 실제 데이터 합계
            const actualTotals = actualData.reduce((acc, row) => {
                acc.비용 += parseFloat(row['비용_예측']) || 0;
                acc.노출 += parseFloat(row['노출_예측']) || 0;
                acc.클릭 += parseFloat(row['클릭_예측']) || 0;
                acc.전환수 += parseFloat(row['전환수_예측']) || 0;
                acc.전환값 += parseFloat(row['전환값_예측']) || 0;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            // 예측 데이터 합계
            const forecastTotals = forecastDataOnly.reduce((acc, row) => {
                acc.비용 += parseFloat(row['비용_예측']) || 0;
                acc.노출 += parseFloat(row['노출_예측']) || 0;
                acc.클릭 += parseFloat(row['클릭_예측']) || 0;
                acc.전환수 += parseFloat(row['전환수_예측']) || 0;
                acc.전환값 += parseFloat(row['전환값_예측']) || 0;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            // 파생 지표 계산 (예측)
            const forecastCPM = forecastTotals.노출 > 0 ? (forecastTotals.비용 / forecastTotals.노출 * 1000) : 0;
            const forecastCPC = forecastTotals.클릭 > 0 ? (forecastTotals.비용 / forecastTotals.클릭) : 0;
            const forecastCPA = forecastTotals.전환수 > 0 ? (forecastTotals.비용 / forecastTotals.전환수) : 0;
            const forecastROAS = forecastTotals.비용 > 0 ? (forecastTotals.전환값 / forecastTotals.비용 * 100) : 0;

            // 파생 지표 계산 (실제)
            const actualCPM = actualTotals.노출 > 0 ? (actualTotals.비용 / actualTotals.노출 * 1000) : 0;
            const actualCPC = actualTotals.클릭 > 0 ? (actualTotals.비용 / actualTotals.클릭) : 0;
            const actualCPA = actualTotals.전환수 > 0 ? (actualTotals.비용 / actualTotals.전환수) : 0;
            const actualROAS = actualTotals.비용 > 0 ? (actualTotals.전환값 / actualTotals.비용 * 100) : 0;

            // 변화율 계산
            const calcChange = (forecast, actual) => {
                if (actual === 0) return 0;
                return ((forecast - actual) / actual * 100).toFixed(1);
            };

            // 상위 행: 주요 성과 (5개) - 비용 및 효율 지표
            const topKpis = [
                { label: '예측 비용', value: formatNumber(forecastTotals.비용), unit: '원', change: calcChange(forecastTotals.비용, actualTotals.비용), icon: '💰', highlight: false },
                { label: '예측 ROAS', value: formatPercent(forecastROAS), unit: '%', change: calcChange(forecastROAS, actualROAS), icon: '📈', highlight: true },
                { label: '예측 CPA', value: formatNumber(forecastCPA), unit: '원', change: calcChange(forecastCPA, actualCPA), icon: '🎯', highlight: false },
                { label: '예측 CPC', value: formatDecimal(forecastCPC), unit: '원', change: calcChange(forecastCPC, actualCPC), icon: '🖱️', highlight: false },
                { label: '예측 CPM', value: formatDecimal(forecastCPM), unit: '원', change: calcChange(forecastCPM, actualCPM), icon: '👁️', highlight: false }
            ];

            // 하위 행: 세부 성과 (4개) - 기본 성과 지표
            const bottomKpis = [
                { label: '예측 노출', value: formatNumber(forecastTotals.노출), unit: '회', change: calcChange(forecastTotals.노출, actualTotals.노출), icon: '👀' },
                { label: '예측 클릭', value: formatNumber(forecastTotals.클릭), unit: '회', change: calcChange(forecastTotals.클릭, actualTotals.클릭), icon: '👆' },
                { label: '예측 전환수', value: formatNumber(forecastTotals.전환수), unit: '건', change: calcChange(forecastTotals.전환수, actualTotals.전환수), icon: '✅' },
                { label: '예측 전환값', value: formatNumber(forecastTotals.전환값), unit: '원', change: calcChange(forecastTotals.전환값, actualTotals.전환값), icon: '💵' }
            ];

            // KPI 카드 HTML 생성 함수 (primary) - marketing_dashboard_v3.html 스타일
            const createKpiCard = (kpi) => `
                <div class="kpi-card${kpi.highlight ? ' highlight' : ''}">
                    <div class="kpi-header">
                        <span class="kpi-title">${kpi.label}</span>
                        <div class="kpi-icon">${kpi.icon}</div>
                    </div>
                    <div class="kpi-value${kpi.highlight ? ' highlight-value' : ''}">${kpi.value}</div>
                    <div class="kpi-trend ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                        <span class="trend-badge ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                            ${parseFloat(kpi.change) >= 0 ? '▲' : '▼'} ${Math.abs(kpi.change)}%
                        </span>
                        <span style="color: var(--grey-500); font-size: 12px;">vs 실제</span>
                    </div>
                </div>
            `;

            // KPI 카드 HTML 생성 함수 (secondary) - marketing_dashboard_v3.html 스타일
            const createSecondaryKpiCard = (kpi) => `
                <div class="kpi-card secondary">
                    <div class="kpi-header">
                        <span class="kpi-title">${kpi.label}</span>
                        <div class="kpi-icon">${kpi.icon}</div>
                    </div>
                    <div class="kpi-value">${kpi.value}</div>
                    <div class="kpi-trend ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                        <span class="trend-badge ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                            ${parseFloat(kpi.change) >= 0 ? '▲' : '▼'} ${Math.abs(kpi.change)}%
                        </span>
                        <span style="color: var(--grey-500); font-size: 12px;">vs 실제</span>
                    </div>
                </div>
            `;

            // 주요 성과 / 세부 성과 토글 레이아웃 HTML 생성
            document.getElementById('kpiSummaryGrid').innerHTML = `
                <section class="kpi-grid kpi-grid-primary" style="margin-bottom: 0;">
                    ${topKpis.map(createKpiCard).join('')}
                </section>
                <section class="kpi-grid kpi-grid-secondary" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 0;">
                    ${bottomKpis.map(createSecondaryKpiCard).join('')}
                </section>
            `;
        }

        // Summary Card 업데이트 (summary_card)
        function updateSummaryCard() {
            const container = document.getElementById('summaryCardContainer');
            const periodData = getPeriodData();
            if (!container || !periodData || !periodData.summary_card) {
                return;
            }

            const card = periodData.summary_card;
            container.style.display = 'block';

            // 상태 색상 설정
            const colorMap = {
                'blue': { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                'green': { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' },
                'yellow': { bg: '#fff8e1', border: '#ffc107', text: '#f57f17' },
                'red': { bg: '#ffebee', border: '#f44336', text: '#c62828' }
            };
            const colors = colorMap[card.status_color] || colorMap['blue'];
            container.style.background = colors.bg;
            container.style.borderLeft = `4px solid ${colors.border}`;

            document.getElementById('summaryCardStatus').textContent = card.status_title || '';
            document.getElementById('summaryCardStatus').style.color = colors.text;
            document.getElementById('summaryCardMessage').textContent = card.status_message || '';
            document.getElementById('summaryCardPeriod').textContent = card.period || '';

            // 메트릭스 표시
            if (card.metrics) {
                const m = card.metrics;
                const metricsHtml = `
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">현재 매출</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--grey-900);">${m.current_revenue || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">예측 매출</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--primary-main);">${m.forecast_revenue || '-'}</div>
                        <div style="font-size: 11px; color: ${m.revenue_change_pct >= 0 ? '#2e7d32' : '#c62828'};">${m.revenue_change_pct >= 0 ? '▲' : '▼'} ${Math.abs(m.revenue_change_pct || 0).toFixed(1)}%</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">현재 ROAS</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--grey-900);">${(m.current_roas || 0).toFixed(0)}%</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">예측 ROAS</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--primary-main);">${(m.forecast_roas || 0).toFixed(0)}%</div>
                        <div style="font-size: 11px; color: ${m.roas_change_val >= 0 ? '#2e7d32' : '#c62828'};">${m.roas_change_val >= 0 ? '▲' : '▼'} ${Math.abs(m.roas_change_val || 0).toFixed(1)}%p</div>
                    </div>
                `;
                document.getElementById('summaryCardMetrics').innerHTML = metricsHtml;
            }
        }

        // AI 요약 메시지 업데이트 (summary) - 독립적인 기간 설정 사용
        function updateAiSummary() {
            const container = document.getElementById('aiSummaryContainer');
            const contentContainer = document.getElementById('aiSummaryContent');
            const periodData = getAiSummaryPeriodData();  // 독립적인 AI 요약 기간 데이터 사용
            if (!container || !contentContainer || !periodData || !periodData.summary) {
                if (container) container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            // 요약 텍스트를 줄 단위로 파싱하여 카드로 표시
            const summary = periodData.summary;
            const lines = summary.split('\n').filter(line => line.trim());

            // 카테고리별 아이콘/색상 정의
            const categories = {
                performance: { icon: '📊', bg: '#e3f2fd', border: '#1976d2', color: '#1565c0', label: '성과 현황', keywords: ['전체 성과', 'ROAS', '전환수', '전환값'] },
                trend_up: { icon: '📈', bg: '#e8f5e9', border: '#43a047', color: '#2e7d32', label: '상승 트렌드', keywords: ['개선 예상', '증가', '상승'] },
                trend_down: { icon: '📉', bg: '#ffebee', border: '#e53935', color: '#c62828', label: '하락 트렌드', keywords: ['하락 예상', '감소', '하락'] },
                warning: { icon: '⚠️', bg: '#fff3e0', border: '#fb8c00', color: '#e65100', label: '주의 필요', keywords: ['위험', '경고', '심각'] },
                conversion: { icon: '🛒', bg: '#fce4ec', border: '#ec407a', color: '#c2185b', label: '전환 분석', keywords: ['전환 하락', '전환율'] },
                recommend: { icon: '💡', bg: '#f3e5f5', border: '#ab47bc', color: '#7b1fa2', label: '추천 액션', keywords: ['권장', '추천', '증액'] },
                review: { icon: '🔍', bg: '#e8eaf6', border: '#5c6bc0', color: '#3949ab', label: '검토 대상', keywords: ['검토', '분석 필요'] },
                info: { icon: '💬', bg: '#f5f5f5', border: '#9e9e9e', color: '#616161', label: '정보', keywords: [] }
            };

            // 카테고리 판별 (이모지 우선)
            const getCategory = (line) => {
                const trimmed = line.trim();

                // 1. 줄 시작 이모지로 먼저 판별 (다양한 이모지 변형 처리)
                // 성과 현황
                if (/^📊/.test(trimmed)) return categories.performance;
                // 상승 트렌드
                if (/^📈/.test(trimmed)) return categories.trend_up;
                // 하락 트렌드
                if (/^📉/.test(trimmed)) return categories.trend_down;
                // 경고/주의 (⚠️, 🚨, ⚠ 등)
                if (/^[⚠️🚨‼️❗❕⛔🔴]/.test(trimmed) || trimmed.startsWith('⚠')) return categories.warning;
                // 전환 분석
                if (/^🛒/.test(trimmed)) return categories.conversion;
                // 추천 액션
                if (/^💡/.test(trimmed)) return categories.recommend;
                // 검토 대상
                if (/^🔍/.test(trimmed)) return categories.review;

                // 2. 키워드 기반 판별 (이모지 없는 경우)
                // 주의/경고 관련
                if (/주의|경고|위험|심각|소진/.test(trimmed)) return categories.warning;
                // 트렌드 관련
                if (/트렌드|Trend/.test(trimmed)) {
                    if (/\+|개선|증가|상승/.test(trimmed)) return categories.trend_up;
                    if (/-|하락|감소|하향/.test(trimmed)) return categories.trend_down;
                }
                // 추천 관련
                if (/권장|추천|증액/.test(trimmed)) return categories.recommend;
                // 검토 관련
                if (/검토|분석 필요/.test(trimmed)) return categories.review;

                return categories.info;
            };

            // 이모지 및 중복 접두사 제거 함수
            const removeEmoji = (text) => {
                // 1. 이모지 제거
                let cleaned = text.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]/gu, '').trim();
                // 2. 중복 접두사 제거 (카테고리 라벨과 중복되는 텍스트)
                cleaned = cleaned.replace(/^(주의|경고|권장|추천|정보|알림|참고)\s*[:：]\s*/i, '');
                return cleaned;
            };

            // 증감 강조 함수
            const highlightChanges = (text) => {
                // +숫자% 또는 +숫자%p 패턴 (상승) - 초록색
                text = text.replace(/(\+[\d.]+%p?)/g, '<span style="color: #2e7d32; font-weight: 600;">$1</span>');
                // -숫자% 또는 -숫자%p 패턴 (하락) - 빨간색
                text = text.replace(/([-−][\d.]+%p?)/g, '<span style="color: #c62828; font-weight: 600;">$1</span>');
                // "N% 증가/상승" 패턴
                text = text.replace(/([\d.]+%)\s*(증가|상승|개선)/g, '<span style="color: #2e7d32; font-weight: 600;">$1 $2</span>');
                // "N% 감소/하락" 패턴
                text = text.replace(/([\d.]+%)\s*(감소|하락|하향)/g, '<span style="color: #c62828; font-weight: 600;">$1 $2</span>');
                return text;
            };

            // 핵심 3개 카드만 추출 (중복 제거)
            // 우선순위: 1. 성과 현황 (📊) 2. 주요 경고/트렌드 (🚨/📉) 3. 추천 액션 (💡)
            const coreCards = [];
            const seenTypes = new Set();

            // 연속된 줄들을 그룹화 (들여쓰기로 시작하면 이전 항목에 추가)
            const groupedLines = [];
            lines.forEach(line => {
                if (line.startsWith('   ') && groupedLines.length > 0) {
                    groupedLines[groupedLines.length - 1].subLines.push(line.trim());
                } else if (line.trim()) {
                    groupedLines.push({ main: line.trim(), subLines: [] });
                }
            });

            // 핵심 카드 선별 (각 타입별 1개씩, 키워드 기반 보강)
            for (const group of groupedLines) {
                const cat = getCategory(group.main);
                const text = group.main;

                // 성과 현황 (1개) - 📊 또는 '전체 성과' 키워드
                if ((cat.label === '성과 현황' || /전체 성과|ROAS.*전환수/.test(text)) && !seenTypes.has('performance')) {
                    seenTypes.add('performance');
                    coreCards.push({ ...group, cat, priority: 1 });
                }
                // 주요 경고/트렌드 (1개) - 🚨📉 또는 '하락/주의' 키워드
                else if ((cat.label === '주의 필요' || cat.label === '하락 트렌드' || /하락 예상|하락할 것으로/.test(text)) && !seenTypes.has('warning')) {
                    seenTypes.add('warning');
                    coreCards.push({ ...group, cat, priority: 2 });
                }
                // 추천 액션 (1개) - 💡 또는 '권장/추천' 키워드
                else if ((cat.label === '추천 액션' || /^💡|권장:|추천:/.test(text)) && !seenTypes.has('recommend')) {
                    seenTypes.add('recommend');
                    coreCards.push({ ...group, cat: categories.recommend, priority: 3 });
                }

                if (coreCards.length >= 3) break;
            }

            // 3개 미만이면 검토 대상 추가
            if (coreCards.length < 3) {
                for (const group of groupedLines) {
                    const cat = getCategory(group.main);
                    if ((cat.label === '검토 대상' || /검토 대상|🔍/.test(group.main)) && !seenTypes.has('review')) {
                        seenTypes.add('review');
                        coreCards.push({ ...group, cat: categories.review, priority: 4 });
                    }
                    if (coreCards.length >= 3) break;
                }
            }

            // 여전히 3개 미만이면 나머지 항목에서 보충
            if (coreCards.length < 3) {
                for (const group of groupedLines) {
                    const cat = getCategory(group.main);
                    const alreadyAdded = coreCards.some(c => c.main === group.main);
                    if (!alreadyAdded) {
                        coreCards.push({ ...group, cat, priority: 5 });
                    }
                    if (coreCards.length >= 3) break;
                }
            }

            // 우선순위 정렬
            coreCards.sort((a, b) => a.priority - b.priority);

            // 추천 데이터 가져오기
            const recommendations = periodData.segments?.recommendations || [];

            let html = '';  // wrapper 제거 - #aiSummaryContent가 이미 그리드 컨테이너

            coreCards.forEach((group, cardIndex) => {
                const cat = group.cat;
                const cleanText = highlightChanges(removeEmoji(group.main));
                // 추천 액션 카드가 아닌 경우에만 recommendations에서 매칭
                const matchedRec = cat.label !== '추천 액션' && recommendations.length > 0
                    ? recommendations[cardIndex % recommendations.length]
                    : null;
                const hasAction = matchedRec || group.subLines.length > 0;

                html += `
                    <div style="
                        background: ${cat.bg};
                        border: 2px solid ${cat.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                        display: flex;
                        flex-direction: column;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <div style="width: 32px; height: 32px; background: ${cat.border}20; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 16px;">${cat.icon}</span>
                            </div>
                            <span style="font-size: 11px; font-weight: 700; color: ${cat.color}; text-transform: uppercase; letter-spacing: 0.5px;">${cat.label}</span>
                        </div>
                        <!-- 메시지 -->
                        <div style="font-size: 13px; font-weight: 500; color: var(--grey-900); line-height: 1.6; flex: 1; margin-bottom: ${hasAction ? '10px' : '0'};">${cleanText}</div>
                        <!-- 서브라인 (들여쓰기 항목) -->
                        ${group.subLines.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.7); border-radius: 6px; padding: 10px; border-left: 3px solid ${cat.border}; margin-bottom: ${matchedRec ? '10px' : '0'};">
                                <div style="font-size: 10px; font-weight: 600; color: ${cat.color}; margin-bottom: 4px;">📌 상세 정보</div>
                                ${group.subLines.map(sub => `<div style="font-size: 11px; color: #333; line-height: 1.5;">→ ${highlightChanges(sub)}</div>`).join('')}
                            </div>
                        ` : ''}
                        <!-- 추천 액션 (경고 및 추천 스타일) -->
                        ${matchedRec ? `
                            <div style="background: rgba(255,255,255,0.7); border-radius: 6px; padding: 10px; border-left: 3px solid #ab47bc;">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <div style="font-size: 10px; font-weight: 600; color: #7b1fa2;">💡 추천 액션</div>
                                    ${matchedRec.action_type ? `<span style="font-size: 9px; padding: 2px 6px; background: ${matchedRec.action_type === 'scale_up' ? '#e8f5e9' : matchedRec.action_type === 'defend' ? '#fff3e0' : matchedRec.action_type === 'optimize' ? '#e3f2fd' : '#ffebee'}; color: ${matchedRec.action_type === 'scale_up' ? '#2e7d32' : matchedRec.action_type === 'defend' ? '#e65100' : matchedRec.action_type === 'optimize' ? '#1565c0' : '#c62828'}; border-radius: 4px; font-weight: 600;">${matchedRec.action_type === 'scale_up' ? '증액' : matchedRec.action_type === 'defend' ? '방어' : matchedRec.action_type === 'optimize' ? '최적화' : '감액'}</span>` : ''}
                                </div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${matchedRec.action}</div>
                                ${matchedRec.context_advice ? `<div style="font-size: 10px; color: #5e35b1; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #d1c4e9; line-height: 1.4;">💬 ${matchedRec.context_advice}</div>` : ''}
                                ${matchedRec.expected_impact ? `<div style="font-size: 10px; color: #2e7d32; margin-top: 4px;">📈 ${matchedRec.expected_impact}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            // wrapper 닫는 태그 제거 - #aiSummaryContent가 이미 그리드 컨테이너
            contentContainer.innerHTML = html;
        }

        // 기회 요소 업데이트 (opportunities)
        function updateOpportunities() {
            const container = document.getElementById('opportunitiesContent');
            const badge = document.getElementById('opportunitiesBadge');
            const periodData = getPeriodData();
            if (!container || !periodData) {
                return;
            }

            const opportunities = periodData.opportunities || [];

            if (opportunities.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">현재 발견된 기회 요소가 없습니다.</div>
                    </div>
                `;
                if (badge) badge.style.display = 'none';
                return;
            }

            if (badge) {
                badge.textContent = opportunities.length;
                badge.style.display = 'inline';
            }

            // 기회 유형별 스타일
            const oppStyles = {
                'scale_up': { icon: '🚀', bg: '#e8f5e9', border: '#4caf50', titleColor: '#2e7d32', label: '예산 증액' },
                'hidden_gem': { icon: '💎', bg: '#e3f2fd', border: '#2196f3', titleColor: '#1565c0', label: '숨은 보석' },
                'growth_momentum': { icon: '📈', bg: '#fff3e0', border: '#ff9800', titleColor: '#e65100', label: '성장 모멘텀' },
                'default': { icon: '🎯', bg: '#e8f5e9', border: '#4caf50', titleColor: '#2e7d32', label: '기회' }
            };

            const html = opportunities.map((opp, idx) => {
                const style = oppStyles[opp.type] || oppStyles['default'];
                const hasAction = opp.action && opp.action.trim();
                const hasFinancial = opp.financial_impact && opp.financial_impact.trim();

                return `
                    <div style="
                        background: ${style.bg};
                        border: 2px solid ${style.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">${style.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${opp.title || '기회 요소 ' + (idx + 1)}</div>
                                ${opp.segment_value ? `<div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${opp.segment_type || ''} > ${opp.segment_value}</div>` : ''}
                            </div>
                            <span style="background: ${style.border}; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">${style.label}</span>
                        </div>
                        <!-- 메트릭스 배지 -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            ${opp.roas ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #a5d6a7;">ROAS ${opp.roas.toFixed(0)}%</span>` : ''}
                            ${opp.priority ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb;">우선순위 ${opp.priority}</span>` : ''}
                            ${opp.potential_uplift ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9;">+${(opp.potential_uplift/10000).toFixed(1)}만원</span>` : ''}
                        </div>
                        <!-- 메시지 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.5; margin-bottom: 10px;">
                            ${opp.message || ''}
                        </div>
                        <!-- 추천 액션 -->
                        ${hasAction ? `
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border}; margin-bottom: ${hasFinancial ? '8px' : '0'};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${opp.action}</div>
                        </div>
                        ` : ''}
                        <!-- 재무 영향 -->
                        ${hasFinancial ? `
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #673ab7;">
                            <div style="font-size: 10px; font-weight: 600; color: #5e35b1; margin-bottom: 4px;">💰 기대 효과</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${opp.financial_impact}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // 탭 배지 업데이트 (details)
        function updateInsightsBadges() {
            const periodData = getPeriodData();
            if (!periodData) return;

            // 경고 수 계산
            let totalAlerts = 0;
            if (periodData.details) {
                totalAlerts = (periodData.details.total_segment_alerts || 0) + (periodData.details.total_overall_alerts || 0);
            } else if (periodData.segments && periodData.segments.alerts) {
                totalAlerts = periodData.segments.alerts.length;
            }

            // 추천 수 계산
            let totalRecs = 0;
            if (periodData.details) {
                totalRecs = periodData.details.total_recommendations || 0;
            } else if (periodData.segments && periodData.segments.recommendations) {
                totalRecs = periodData.segments.recommendations.length;
            }

            // "경고 및 추천" 탭 배지 (경고 + 추천 합계)
            const alertsBadge = document.getElementById('alertsBadge');
            const alertsCountBadge = document.getElementById('alertsCountBadge');
            const totalAlertsAndRecs = totalAlerts + totalRecs;

            if (alertsBadge) {
                if (totalAlertsAndRecs > 0) {
                    alertsBadge.textContent = totalAlertsAndRecs;
                    alertsBadge.style.display = 'inline';
                    // 긴급 경고가 있으면 빨간색, 추천만 있으면 주황색
                    if (periodData.details && periodData.details.high_severity_alerts > 0) {
                        alertsBadge.style.background = '#ef5350';
                    } else if (totalAlerts > 0) {
                        alertsBadge.style.background = '#ff9800';
                    } else {
                        alertsBadge.style.background = '#7c4dff';  // 추천만 있을 때 보라색
                    }
                } else {
                    alertsBadge.style.display = 'none';
                }
            }

            if (alertsCountBadge) {
                alertsCountBadge.textContent = totalAlerts > 0 ? `(${totalAlerts}건)` : '';
            }

            // 추천 배지
            const recommendationsCountBadge = document.getElementById('recommendationsCountBadge');
            if (recommendationsCountBadge) {
                recommendationsCountBadge.textContent = totalRecs > 0 ? `(${totalRecs}건)` : '';
            }

            // Matrix 배지 업데이트
            const matrixBadge = document.getElementById('matrixBadge');
            if (matrixBadge && periodData.matrix_insights) {
                const matrixInsights = periodData.matrix_insights;
                let totalMatrix = 0;
                let hasCritical = false;
                ['brand', 'product', 'channel', 'promotion'].forEach(segment => {
                    const insights = matrixInsights[segment] || [];
                    totalMatrix += insights.length;
                    insights.forEach(i => {
                        if (i.severity === 'critical' || i.severity === 'high') hasCritical = true;
                    });
                });
                if (totalMatrix > 0) {
                    matrixBadge.textContent = totalMatrix;
                    matrixBadge.style.display = 'inline';
                    matrixBadge.style.background = hasCritical ? '#ef5350' : '#673ab7';
                } else {
                    matrixBadge.style.display = 'none';
                }
            }
        }

        // insights.json 데이터로 인사이트 업데이트
        function updateInsightsFromData() {
            const insightContainer = document.getElementById('insightContent');
            if (!insightContainer) {
                console.log('insightContent element not found - skipping updateInsightsFromData');
                return;
            }

            const periodData = getPeriodData();
            if (!periodData) {
                insightContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">데이터를 불러올 수 없습니다.</div>
                    </div>
                `;
                return;
            }

            // segment alerts + overall alerts 합치기
            const segmentAlerts = periodData.segments?.alerts || [];
            const overallAlerts = periodData.overall?.alerts || [];
            const allAlerts = [...segmentAlerts, ...overallAlerts];

            if (allAlerts.length === 0) {
                insightContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-title">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            모든 지표 정상
                        </div>
                        <div class="insight-text">현재 모든 주요 항목에서 특별한 경고 사항이 없습니다.</div>
                    </div>
                `;
                return;
            }

            const getAlertIcon = (type) => {
                const icons = {
                    'conversion_decline': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"/></svg>',
                    'roas_decline': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>',
                    'revenue_decline': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
                    'budget_alert': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>',
                    'default': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>'
                };
                return icons[type] || icons['default'];
            };

            const getAlertTitle = (alert) => {
                // overall alert는 title이 직접 있음
                if (alert.title) return alert.title;

                const titles = {
                    'conversion_decline': '전환수 감소 경고',
                    'roas_decline': 'ROAS 하락 경고',
                    'revenue_decline': '매출 감소 경고',
                    'budget_alert': '예산 경고'
                };
                return titles[alert.type] || '성과 변동 감지';
            };

            const getAlertText = (alert) => {
                // overall alert는 message가 직접 있음
                if (alert.message) return alert.message;

                const segmentTypeKr = {
                    'channel': '채널',
                    'product': '제품',
                    'brand': '브랜드'
                };
                return `${segmentTypeKr[alert.segment_type] || alert.segment_type} "${alert.segment_value}"의 ${alert.metric}이(가) ${Math.abs(alert.change_pct).toFixed(1)}% ${alert.change_pct < 0 ? '하락' : '상승'}할 것으로 예측됩니다.`;
            };

            const renderAlertCard = (alert) => {
                const severityColors = {
                    'high': { bg: '#ffebee', border: '#ef5350', titleColor: '#c62828' },
                    'medium': { bg: '#fff3e0', border: '#ff9800', titleColor: '#e65100' },
                    'low': { bg: '#e3f2fd', border: '#2196f3', titleColor: '#1565c0' }
                };
                const style = severityColors[alert.severity] || severityColors['medium'];
                const hasAction = alert.action && alert.action.trim();

                return `
                    <div style="
                        background: ${style.bg};
                        border: 2px solid ${style.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 16px;">${alert.severity === 'high' ? '🚨' : '⚠️'}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${getAlertTitle(alert)}</div>
                                ${alert.segment_value ? `<div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${alert.segment_type || ''} > ${alert.segment_value}</div>` : ''}
                            </div>
                            ${alert.severity === 'high' ? '<span style="background: #c62828; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600;">긴급</span>' : ''}
                        </div>
                        <!-- 메트릭스 배지 -->
                        ${alert.actual_roas !== undefined ? `
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #333; border: 1px solid ${style.border};">현재 ROAS ${alert.actual_roas?.toFixed(0) || 0}%</span>
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #c62828; border: 1px solid #ef9a9a;">예측 ROAS ${alert.forecast_roas?.toFixed(0) || 0}%</span>
                            ${alert.change_pct ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #c62828; border: 1px solid #ef9a9a;">변화 ${alert.change_pct > 0 ? '+' : ''}${alert.change_pct.toFixed(1)}%</span>` : ''}
                        </div>
                        ` : ''}
                        <!-- 메시지 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.5; margin-bottom: ${hasAction ? '10px' : '0'};">
                            ${getAlertText(alert)}
                        </div>
                        <!-- 추천 액션 -->
                        ${hasAction ? `
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${alert.action}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            };

            // 표시할 알림 결정
            const displayAlerts = alertsExpanded ? allAlerts : allAlerts.slice(0, INITIAL_ALERTS_COUNT);
            const hasMore = allAlerts.length > INITIAL_ALERTS_COUNT;
            const hiddenCount = allAlerts.length - INITIAL_ALERTS_COUNT;

            let html = displayAlerts.map(renderAlertCard).join('');

            // 더보기/접기 버튼 추가 (collapsible-toggle 스타일)
            if (hasMore) {
                html += `
                    <div style="text-align: center; margin-top: 16px;">
                        <button onclick="toggleAlerts()" class="collapsible-toggle" style="margin: 0 auto;">
                            <span>${alertsExpanded ? '접기' : `더보기 (+${hiddenCount}건)`}</span>
                            <span class="collapsible-toggle-icon ${alertsExpanded ? '' : 'collapsed'}">▼</span>
                        </button>
                    </div>
                `;
            }

            insightContainer.innerHTML = html;
        }

        // 경고 펼치기/접기 토글
        function toggleAlerts() {
            alertsExpanded = !alertsExpanded;
            updateInsightsFromData();
        }

        // 투자 추천 업데이트
        function updateRecommendations() {
            const recommendationContainer = document.getElementById('recommendationContent');

            if (!recommendationContainer) {
                console.error('recommendationContent element not found');
                return;
            }

            const periodData = getPeriodData();
            if (!periodData || !periodData.segments || !periodData.segments.recommendations) {
                console.log('Insights data not available yet');
                recommendationContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">데이터를 불러오는 중...</div>
                    </div>
                `;
                return;
            }

            const allRecommendations = periodData.segments.recommendations;

            if (allRecommendations.length === 0) {
                recommendationContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">현재 특별한 투자 추천 사항이 없습니다.</div>
                    </div>
                `;
                return;
            }

            const getTargetTypeKr = (type) => {
                const types = {
                    'channel': '채널',
                    'product': '제품',
                    'brand': '브랜드',
                    'promotion': '프로모션'
                };
                return types[type] || type;
            };

            const renderRecommendationCard = (rec) => {
                const priorityColors = {
                    1: { bg: '#e8f5e9', border: '#4caf50', titleColor: '#2e7d32', icon: '🥇' },
                    2: { bg: '#e3f2fd', border: '#2196f3', titleColor: '#1565c0', icon: '🥈' },
                    3: { bg: '#fff3e0', border: '#ff9800', titleColor: '#e65100', icon: '🥉' }
                };
                const style = priorityColors[rec.priority] || priorityColors[3];
                const metrics = rec.metrics || {};

                return `
                    <div style="
                        background: ${style.bg};
                        border: 2px solid ${style.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">${style.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${rec.action}</div>
                                <div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${getTargetTypeKr(rec.target.type)} > ${rec.target.value}</div>
                            </div>
                            <span style="background: ${style.border}; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">우선순위 ${rec.priority}</span>
                        </div>
                        <!-- 메트릭스 배지 -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            ${metrics.roas ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #a5d6a7;">ROAS ${metrics.roas.toFixed(0)}%</span>` : ''}
                            ${metrics.cvr ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9;">CVR ${metrics.cvr.toFixed(2)}%</span>` : ''}
                            ${metrics.cpa ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb;">CPA ${(metrics.cpa/1000).toFixed(1)}천원</span>` : ''}
                        </div>
                        <!-- 이유 목록 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.6; margin-bottom: 10px;">
                            ${rec.reasons.map(reason => `<div style="display: flex; align-items: flex-start; gap: 6px;"><span style="color: ${style.border};">✓</span><span>${reason}</span></div>`).join('')}
                        </div>
                        <!-- 예상 효과 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">📈 예상 효과</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${rec.expected_impact}</div>
                        </div>
                    </div>
                `;
            };

            // 표시할 추천 결정
            const displayRecommendations = recommendationsExpanded
                ? allRecommendations
                : allRecommendations.slice(0, INITIAL_RECOMMENDATIONS_COUNT);
            const hasMore = allRecommendations.length > INITIAL_RECOMMENDATIONS_COUNT;
            const hiddenCount = allRecommendations.length - INITIAL_RECOMMENDATIONS_COUNT;

            let html = displayRecommendations.map(renderRecommendationCard).join('');

            // 더보기/접기 버튼 추가 (collapsible-toggle 스타일)
            if (hasMore) {
                html += `
                    <div style="text-align: center; margin-top: 16px; grid-column: 1 / -1;">
                        <button onclick="toggleRecommendations()" class="collapsible-toggle" style="margin: 0 auto;">
                            <span>${recommendationsExpanded ? '접기' : `더보기 (+${hiddenCount}건)`}</span>
                            <span class="collapsible-toggle-icon ${recommendationsExpanded ? '' : 'collapsed'}">▼</span>
                        </button>
                    </div>
                `;
            }

            recommendationContainer.innerHTML = html;
        }

        // 추천 펼치기/접기 토글
        function toggleRecommendations() {
            recommendationsExpanded = !recommendationsExpanded;
            updateRecommendations();
        }

        // 추천 카드 토글 함수
        function toggleRecommendationCard(card) {
            card.classList.toggle('expanded');
        }

        // ============================================================
        // Forecast Matrix 4분면 인사이트 렌더링 (v2.8)
        // ============================================================
        function renderMatrixInsights() {
            const periodData = getPeriodData();
            if (!periodData || !periodData.matrix_insights) {
                const noDataHtml = `
                    <div class="insight-card neutral">
                        <div class="insight-message" style="text-align: center; padding: 16px;">
                            <span style="font-size: 24px; display: block; margin-bottom: 8px;">📊</span>
                            <span style="color: var(--grey-600);">Matrix 인사이트가 없습니다.</span>
                        </div>
                    </div>
                `;
                ['Brand', 'Product', 'Channel', 'Promotion'].forEach(seg => {
                    const container = document.getElementById('matrix' + seg + 'Content');
                    const countBadge = document.getElementById('matrix' + seg + 'Count');
                    if (container) container.innerHTML = noDataHtml;
                    if (countBadge) countBadge.textContent = '';
                });
                return;
            }

            const matrixInsights = periodData.matrix_insights;

            // 4분면별 스타일 설정 (툴팁 설명 포함)
            const matrixStyles = {
                'super_star': {
                    icon: '🚀',
                    bg: '#e8f5e9',
                    border: '#4caf50',
                    titleColor: '#2e7d32',
                    label: 'Super Star',
                    tooltip: '고효율 + 고성장: 현재 ROAS가 높고 성장세도 좋습니다. 예산을 적극 증액하세요!'
                },
                'fading_hero': {
                    icon: '🛡️',
                    bg: '#fff3e0',
                    border: '#ff9800',
                    titleColor: '#e65100',
                    label: 'Fading Hero',
                    tooltip: '고효율 + 역성장: 효율은 좋지만 성장세가 둔화되고 있습니다. 현재 수익을 방어하세요.'
                },
                'rising_potential': {
                    icon: '🌱',
                    bg: '#e3f2fd',
                    border: '#2196f3',
                    titleColor: '#1565c0',
                    label: 'Rising Potential',
                    tooltip: '저효율 + 고성장: 효율은 낮지만 성장 잠재력이 있습니다. 최적화로 효율을 끌어올리세요.'
                },
                'problem_child': {
                    icon: '🗑️',
                    bg: '#ffebee',
                    border: '#ef5350',
                    titleColor: '#c62828',
                    label: 'Problem Child',
                    tooltip: '저효율 + 역성장: 효율도 낮고 성장세도 없습니다. 예산을 축소하거나 전략을 재검토하세요.'
                }
            };

            // severity별 추가 스타일
            const severityStyles = {
                'critical': { borderWidth: '3px', boxShadow: '0 0 8px rgba(239, 83, 80, 0.4)' },
                'high': { borderWidth: '2px', boxShadow: '0 0 4px rgba(239, 83, 80, 0.2)' },
                'warning': { borderWidth: '2px', boxShadow: 'none' },
                'opportunity': { borderWidth: '2px', boxShadow: '0 0 4px rgba(76, 175, 80, 0.2)' }
            };

            const renderMatrixCard = (insight) => {
                const style = matrixStyles[insight.sub_type] || matrixStyles['problem_child'];
                const sevStyle = severityStyles[insight.severity] || severityStyles['warning'];
                const metrics = insight.metrics || {};

                // ROAS 및 성장률 포맷팅 (필드명: current_roas, forecast_growth_pct, revenue_share_pct)
                const roas = metrics.current_roas || metrics.roas;
                const roasText = roas ? `ROAS ${roas.toLocaleString()}%` : '';
                const growthPct = metrics.forecast_growth_pct ?? metrics.forecast_growth_rate;
                const growthText = growthPct !== undefined && growthPct !== null
                    ? `예측 ${growthPct >= 0 ? '+' : ''}${growthPct.toFixed(1)}%`
                    : '';
                const revenueShare = metrics.revenue_share_pct ?? metrics.revenue_impact_share;
                const shareText = revenueShare !== undefined && revenueShare !== null
                    ? `매출비중 ${revenueShare.toFixed(1)}%`
                    : '';

                return `
                    <div class="matrix-card"
                        data-tooltip-icon="${style.icon}"
                        data-tooltip-label="${style.label}"
                        data-tooltip-desc="${style.tooltip}"
                        style="
                            background: ${style.bg};
                            border: ${sevStyle.borderWidth} solid ${style.border};
                            border-radius: 10px;
                            padding: 14px;
                            box-shadow: ${sevStyle.boxShadow};
                            transition: transform 0.2s, box-shadow 0.2s;
                            cursor: pointer;
                        ">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 18px;">${style.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${insight.segment_value}</div>
                                <div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${style.label}</div>
                            </div>
                            ${insight.severity === 'critical' ? '<span style="background: #c62828; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600;">CORE RISK</span>' : ''}
                        </div>
                        <!-- 메트릭스 -->
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                            ${roasText ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #333; border: 1px solid ${style.border};">${roasText}</span>` : ''}
                            ${growthText ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: ${growthPct >= 0 ? '#2e7d32' : '#c62828'}; border: 1px solid ${growthPct >= 0 ? '#a5d6a7' : '#ef9a9a'};">${growthText}</span>` : ''}
                            ${shareText ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb;">${shareText}</span>` : ''}
                        </div>
                        <!-- 메시지 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.5; margin-bottom: 10px;">
                            ${insight.message}
                        </div>
                        <!-- 액션 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${insight.action}</div>
                        </div>
                    </div>
                `;
            };

            // 각 세그먼트별 렌더링
            const segmentMap = {
                'brand': 'Brand',
                'product': 'Product',
                'channel': 'Channel',
                'promotion': 'Promotion'
            };

            Object.entries(segmentMap).forEach(([key, displayName]) => {
                const insights = matrixInsights[key] || [];
                const container = document.getElementById('matrix' + displayName + 'Content');
                const countBadge = document.getElementById('matrix' + displayName + 'Count');

                if (countBadge) {
                    countBadge.textContent = insights.length > 0 ? `(${insights.length}건)` : '';
                }

                if (!container) return;

                if (insights.length === 0) {
                    container.innerHTML = `
                        <div class="insight-card neutral" style="background: #f5f5f5; border: 1px dashed #ccc; text-align: center; padding: 20px;">
                            <div style="font-size: 24px; margin-bottom: 8px;">✨</div>
                            <div style="font-size: 12px; color: #666;">해당 세그먼트의 Matrix 인사이트가 없습니다.</div>
                        </div>
                    `;
                    return;
                }

                // severity 우선순위로 정렬 (critical > high > warning > opportunity)
                const severityOrder = { 'critical': 0, 'high': 1, 'warning': 2, 'opportunity': 3 };
                const sortedInsights = [...insights].sort((a, b) =>
                    (severityOrder[a.severity] || 4) - (severityOrder[b.severity] || 4)
                );

                container.innerHTML = sortedInsights.map(renderMatrixCard).join('');
            });

            // 툴팁 이벤트 설정
            setupMatrixCardTooltip();
        }

        // Matrix 카드 툴팁 이벤트 핸들러 (마우스 커서 따라가기)
        function setupMatrixCardTooltip() {
            const tooltip = document.getElementById('matrixCardTooltip');
            if (!tooltip) return;

            // 각 세그먼트 컨테이너에 이벤트 위임
            ['matrixBrandContent', 'matrixChannelContent', 'matrixProductContent', 'matrixPromotionContent'].forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;

                // 기존 이벤트 리스너 제거를 위해 클론
                const newContainer = container.cloneNode(true);
                container.parentNode.replaceChild(newContainer, container);

                // mouseenter 이벤트
                newContainer.addEventListener('mouseenter', function(event) {
                    const card = event.target.closest('.matrix-card');
                    if (!card) return;

                    const icon = card.dataset.tooltipIcon || '📊';
                    const label = card.dataset.tooltipLabel || 'Matrix';
                    const desc = card.dataset.tooltipDesc || '';

                    // 카드 스타일 변경
                    card.style.transform = 'translateY(-3px)';
                    card.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';

                    // 툴팁 내용 설정
                    tooltip.innerHTML = `
                        <div class="matrix-tooltip-header">
                            <span class="matrix-tooltip-icon">${icon}</span>
                            <div>
                                <div class="matrix-tooltip-title">${label}</div>
                                <div class="matrix-tooltip-subtitle">4분면 분류</div>
                            </div>
                        </div>
                        <div class="matrix-tooltip-content">${desc}</div>
                    `;

                    tooltip.classList.add('visible');
                }, true);

                // mousemove 이벤트 (커서 따라가기)
                newContainer.addEventListener('mousemove', function(event) {
                    const card = event.target.closest('.matrix-card');
                    if (!card || !tooltip.classList.contains('visible')) return;

                    const padding = 15;
                    let left = event.clientX + padding;
                    let top = event.clientY + padding;

                    // 툴팁 크기 가져오기
                    const tooltipRect = tooltip.getBoundingClientRect();

                    // 오른쪽 경계를 넘으면 왼쪽에 배치
                    if (left + tooltipRect.width + padding > window.innerWidth) {
                        left = event.clientX - tooltipRect.width - padding;
                    }

                    // 하단 경계를 넘으면 위로 조정
                    if (top + tooltipRect.height + padding > window.innerHeight) {
                        top = event.clientY - tooltipRect.height - padding;
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }, true);

                // mouseleave 이벤트
                newContainer.addEventListener('mouseleave', function(event) {
                    const card = event.target.closest('.matrix-card');
                    if (!card) return;

                    // 카드 스타일 복원
                    card.style.transform = '';
                    card.style.boxShadow = '';

                    tooltip.classList.remove('visible');
                }, true);
            });
        }

        // 성과 트렌드 분석 업데이트 (7일/30일) - 항상 'full' 기간 데이터 사용
        function updatePerformanceTrends(improvementPeriod = '7d', declinePeriod = '7d') {
            // 성과 트렌드는 항상 전체 기간(full) 데이터 사용
            const fullPeriodData = insightsData?.by_period?.full || insightsData;

            // performance_trends 데이터가 없는 경우 빈 상태 표시
            if (!fullPeriodData || !fullPeriodData.performance_trends) {
                console.log('Performance trends data not available');
                const improvementContainer = document.getElementById('improvementTrendContent');
                const declineContainer = document.getElementById('declineTrendContent');

                const noDataHtml = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; color: var(--grey-500);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2v-2zm0-12h2v10h-2V5z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--grey-700);">데이터 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">성과 트렌드 데이터가 아직 생성되지 않았습니다.</p>
                        </div>
                    </div>
                `;

                if (improvementContainer) improvementContainer.innerHTML = noDataHtml;
                if (declineContainer) declineContainer.innerHTML = noDataHtml;
                return;
            }

            const trends = fullPeriodData.performance_trends;

            // 기간 표시 업데이트
            updateTrendPeriodIndicator(improvementPeriod);

            // 개선 항목 업데이트
            updateImprovementTrends(improvementPeriod, trends);

            // 하락 항목 업데이트
            updateDeclineTrends(declinePeriod, trends);
        }

        // 일반적인 추천 텍스트를 구체적인 액션으로 변환
        function transformRecommendationText(recommendation, metric) {
            // 일반적인 패턴들을 구체적인 액션으로 변환
            const transformations = {
                '비용': {
                    pattern: /마케팅 전략 점검이 필요합니다/,
                    replacement: '광고 예산 재분배를 고려해보세요. 성과가 낮은 채널의 예산을 줄이고, 효율이 좋은 채널로 예산을 이동시키는 것을 추천드립니다.'
                },
                '전환수': {
                    pattern: /마케팅 전략 점검이 필요합니다/,
                    replacement: '광고 소재나 타겟 주요 항목 조정이 필요합니다. 전환율이 낮은 캠페인의 타겟팅 설정을 검토하고, 잠재고객을 다시 정의해보시는 것을 추천드립니다.'
                },
                '전환값': {
                    pattern: /마케팅 전략 점검이 필요합니다/,
                    replacement: '고객 단가를 높이는 전략이 필요합니다. 프리미엄 제품 노출을 늘리거나, 교차 판매/업셀 전략을 강화해보시는 것을 추천드립니다.'
                },
                'ROAS': {
                    pattern: /광고 효율성 점검이 필요합니다/,
                    replacement: '광고 효율을 개선하기 위해 입찰 전략을 재검토하고, ROI가 낮은 키워드나 소재를 일시 중지하거나 최적화하는 것을 추천드립니다.'
                }
            };

            // 메트릭에 맞는 변환 규칙 찾기
            for (const [key, transform] of Object.entries(transformations)) {
                if (metric.includes(key) && transform.pattern.test(recommendation)) {
                    return recommendation.replace(transform.pattern, transform.replacement);
                }
            }

            return recommendation;
        }

        // 성과 트렌드 기간 표시 업데이트
        function updateTrendPeriodIndicator(period) {
            const indicator = document.getElementById('trendPeriodText');
            if (!indicator) return;

            // 실제 데이터의 마지막 날짜 기준으로 계산
            let lastDate = new Date();

            // dailyData에서 actual 데이터의 마지막 날짜 찾기
            if (window.dailyData && window.dailyData.length > 0) {
                const actualData = window.dailyData.filter(d => d.type === 'actual');
                if (actualData.length > 0) {
                    const lastDateStr = actualData[actualData.length - 1]['일 구분'] || actualData[actualData.length - 1].date;
                    if (lastDateStr) {
                        lastDate = new Date(lastDateStr);
                    }
                }
            }

            const formatDate = (date) => {
                const m = date.getMonth() + 1;
                const d = date.getDate();
                return `${m}/${d}`;
            };

            let recentStart, recentEnd, previousStart, previousEnd;

            if (period === '7d') {
                // 최근 7일: lastDate - 6일 ~ lastDate
                recentEnd = new Date(lastDate);
                recentStart = new Date(lastDate);
                recentStart.setDate(recentStart.getDate() - 6);

                // 이전 7일: lastDate - 13일 ~ lastDate - 7일
                previousEnd = new Date(lastDate);
                previousEnd.setDate(previousEnd.getDate() - 7);
                previousStart = new Date(lastDate);
                previousStart.setDate(previousStart.getDate() - 13);

                indicator.innerHTML = `
                    <strong style="color: #1565c0;">최근 7일</strong> (${formatDate(recentStart)}~${formatDate(recentEnd)}) vs
                    <strong style="color: #7b1fa2;">이전 7일</strong> (${formatDate(previousStart)}~${formatDate(previousEnd)})
                `;
            } else if (period === '14d') {
                // 최근 14일: lastDate - 13일 ~ lastDate
                recentEnd = new Date(lastDate);
                recentStart = new Date(lastDate);
                recentStart.setDate(recentStart.getDate() - 13);

                // 이전 14일: lastDate - 27일 ~ lastDate - 14일
                previousEnd = new Date(lastDate);
                previousEnd.setDate(previousEnd.getDate() - 14);
                previousStart = new Date(lastDate);
                previousStart.setDate(previousStart.getDate() - 27);

                indicator.innerHTML = `
                    <strong style="color: #1565c0;">최근 14일</strong> (${formatDate(recentStart)}~${formatDate(recentEnd)}) vs
                    <strong style="color: #7b1fa2;">이전 14일</strong> (${formatDate(previousStart)}~${formatDate(previousEnd)})
                `;
            } else {
                // 최근 30일: lastDate - 29일 ~ lastDate
                recentEnd = new Date(lastDate);
                recentStart = new Date(lastDate);
                recentStart.setDate(recentStart.getDate() - 29);

                // 이전 30일: lastDate - 59일 ~ lastDate - 30일
                previousEnd = new Date(lastDate);
                previousEnd.setDate(previousEnd.getDate() - 30);
                previousStart = new Date(lastDate);
                previousStart.setDate(previousStart.getDate() - 59);

                indicator.innerHTML = `
                    <strong style="color: #1565c0;">최근 30일</strong> (${formatDate(recentStart)}~${formatDate(recentEnd)}) vs
                    <strong style="color: #7b1fa2;">이전 30일</strong> (${formatDate(previousStart)}~${formatDate(previousEnd)})
                `;
            }
        }

        // 개선 트렌드 업데이트
        function updateImprovementTrends(period, trends) {
            const container = document.getElementById('improvementTrendContent');
            if (!container) return;

            const dataKeyMap = { '7d': 'improvements_7d', '14d': 'improvements_14d', '30d': 'improvements_30d' };
            const periodTextMap = { '7d': '최근 7일 vs 이전 7일', '14d': '최근 14일 vs 이전 14일', '30d': '최근 30일 vs 이전 30일' };
            const dataKey = dataKeyMap[period] || 'improvements_7d';
            const improvements = trends[dataKey] || [];
            const periodText = periodTextMap[period] || '최근 7일 vs 이전 7일';

            if (improvements.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; color: var(--grey-500);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2v-2zm0-12h2v10h-2V5z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--grey-700);">개선 사항 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">현재 기간에 유의미한 성과 개선이 감지되지 않았습니다.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${improvements.map(item => `
                        <div class="insight-card positive" style="border-left: 4px solid var(--success-main);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div class="insight-title" style="font-size: 15px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                        ${item.metric}
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-700);">
                                        ${periodText}: <strong style="color: var(--success-main);">+${item.change_pct}%</strong> 증가
                                    </div>
                                </div>
                                <span style="font-size: 12px; padding: 4px 12px; background: var(--success-main); color: white; border-radius: 12px; font-weight: 600;">
                                    ${item.improvement_level === 'high' ? '높음' : '중간'}
                                </span>
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px; color: var(--grey-700); margin-bottom: 12px;">
                                <span>최근 평균: <strong>${formatNumber(item.recent_avg)}</strong></span>
                                <span>이전 평균: <strong>${formatNumber(item.previous_avg)}</strong></span>
                            </div>
                            <div style="font-size: 13px; color: var(--grey-900); padding: 12px; background: var(--success-light); border-radius: 6px;">
                                💡 ${transformRecommendationText(item.recommendation, item.metric)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 하락 트렌드 업데이트
        function updateDeclineTrends(period, trends) {
            const container = document.getElementById('declineTrendContent');
            if (!container) return;

            const dataKeyMap = { '7d': 'declines_7d', '14d': 'declines_14d', '30d': 'declines_30d' };
            const periodTextMap = { '7d': '최근 7일 vs 이전 7일', '14d': '최근 14일 vs 이전 14일', '30d': '최근 30일 vs 이전 30일' };
            const dataKey = dataKeyMap[period] || 'declines_7d';
            const declines = trends[dataKey] || [];
            const periodText = periodTextMap[period] || '최근 7일 vs 이전 7일';

            if (declines.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; color: var(--success-main);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--success-main);">하락 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">모든 지표가 안정적이거나 개선되고 있습니다.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${declines.map(item => `
                        <div class="insight-card negative" style="border-left: 4px solid var(--error-main);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div class="insight-title" style="font-size: 15px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                        ${item.metric}
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-700);">
                                        ${periodText}: <strong style="color: var(--error-main);">${item.change_pct}%</strong> 감소
                                    </div>
                                </div>
                                <span style="font-size: 12px; padding: 4px 12px; background: ${item.risk_level === 'high' ? 'var(--error-main)' : 'var(--warning-main)'}; color: white; border-radius: 12px; font-weight: 600;">
                                    ${item.risk_level === 'high' ? '높음' : '중간'}
                                </span>
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px; color: var(--grey-700); margin-bottom: 12px;">
                                <span>최근 평균: <strong>${formatNumber(item.recent_avg)}</strong></span>
                                <span>이전 평균: <strong>${formatNumber(item.previous_avg)}</strong></span>
                            </div>
                            <div style="font-size: 13px; color: var(--grey-900); padding: 12px; background: var(--error-light); border-radius: 6px;">
                                ⚠️ ${transformRecommendationText(item.recommendation, item.metric)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 차트 업데이트
        function updateChart() {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            if (forecastChart) {
                forecastChart.destroy();
            }

            const labels = forecastData.map(d => d['일 구분']);

            const showCost = document.getElementById('chartCost').checked;
            const showImpressions = document.getElementById('chartImpressions').checked;
            const showClicks = document.getElementById('chartClicks').checked;
            const showConversions = document.getElementById('chartConversions').checked;
            const showValue = document.getElementById('chartValue').checked;

            // 실제/예측 구분 인덱스 찾기
            const lastActualIndex = forecastData.findIndex(d => d.type === 'forecast' || d.type === 'mixed') - 1;

            // 데이터셋을 실제값과 예측값으로 분리하는 함수
            function createSplitDatasets(label, data, color, yAxisID) {
                const actualData = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'actual' || type === 'mixed') ? val : null;
                });
                const forecastDataArr = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'forecast' || type === 'mixed') ? val : null;
                });

                // 연결을 위해 마지막 실제값을 예측 데이터의 시작점에 추가
                if (lastActualIndex >= 0 && lastActualIndex < data.length - 1) {
                    forecastDataArr[lastActualIndex] = data[lastActualIndex];
                }

                const datasets = [];

                // 실제값 데이터셋 (실선)
                datasets.push({
                    label: label,
                    data: actualData,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    pointRadius: 3,
                    pointStyle: 'circle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                // 예측값 데이터셋 (점선)
                datasets.push({
                    label: label + ' (예측)',
                    data: forecastDataArr,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.05)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    borderDash: [6, 4],
                    pointRadius: 4,
                    pointStyle: 'triangle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                return datasets;
            }

            const datasets = [];

            // Y축 결정 로직: 비용/전환값은 금액(왼쪽), 노출/클릭/전환수는 수량(오른쪽)
            // 단, 금액 지표가 없으면 수량 지표가 왼쪽 축 사용
            const hasAmountMetric = showCost || showValue;

            if (showCost) {
                const data = forecastData.map(d => parseFloat(d['비용_예측']) || 0);
                datasets.push(...createSplitDatasets('비용', data, '#673ab7', 'y'));
            }

            if (showImpressions) {
                const data = forecastData.map(d => parseFloat(d['노출_예측']) || 0);
                datasets.push(...createSplitDatasets('노출', data, '#2196f3', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showClicks) {
                const data = forecastData.map(d => parseFloat(d['클릭_예측']) || 0);
                datasets.push(...createSplitDatasets('클릭', data, '#ff9800', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showConversions) {
                const data = forecastData.map(d => parseFloat(d['전환수_예측']) || 0);
                datasets.push(...createSplitDatasets('전환수', data, '#4caf50', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showValue) {
                const data = forecastData.map(d => parseFloat(d['전환값_예측']) || 0);
                datasets.push(...createSplitDatasets('전환값', data, '#00c853', 'y'));
            }

            // 오른쪽 축 표시 여부
            const showRightAxis = hasAmountMetric && (showImpressions || showClicks || showConversions);

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                filter: function(item) {
                                    // 예측 데이터셋은 범례에서 숨김
                                    return !item.text.includes('(예측)');
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    // (예측) 접미사 제거
                                    label = label.replace(' (예측)', '');
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatNumber(context.parsed.y);

                                    // 예측값 여부 표시
                                    const dataIndex = context.dataIndex;
                                    const type = forecastData[dataIndex].type;
                                    if (type === 'forecast' || (type === 'mixed' && context.dataset.borderDash)) {
                                        label += ' (예측)';
                                    }
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: lastActualIndex >= 0 ? {
                                line1: {
                                    type: 'line',
                                    xMin: lastActualIndex + 0.5,
                                    xMax: lastActualIndex + 0.5,
                                    borderColor: 'rgba(103, 58, 183, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '예측 시작',
                                        position: 'start'
                                    }
                                }
                            } : {}
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: hasAmountMetric ? '금액 (원)' : '수량'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: showRightAxis,
                            position: 'right',
                            title: {
                                display: true,
                                text: '수량'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 세그먼트 트렌드 내 전체 성과 예측 차트 업데이트
        function updateOverallForecastChart() {
            const canvas = document.getElementById('forecastChartTrend');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            if (forecastChartTrend) {
                forecastChartTrend.destroy();
            }

            if (!forecastData || forecastData.length === 0) return;

            const labels = forecastData.map(d => d['일 구분']);

            const showCost = document.getElementById('chartCostTrend')?.checked;
            const showCPM = document.getElementById('chartCPMTrend')?.checked;
            const showCPC = document.getElementById('chartCPCTrend')?.checked;
            const showCPA = document.getElementById('chartCPATrend')?.checked;
            const showROAS = document.getElementById('chartROASTrend')?.checked;

            // 실제/예측 구분 인덱스 찾기
            const lastActualIndex = forecastData.findIndex(d => d.type === 'forecast' || d.type === 'mixed') - 1;

            // 데이터셋을 실제값과 예측값으로 분리하는 함수
            function createSplitDatasets(label, data, color, yAxisID) {
                const actualData = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'actual' || type === 'mixed') ? val : null;
                });
                const forecastDataArr = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'forecast' || type === 'mixed') ? val : null;
                });

                if (lastActualIndex >= 0 && lastActualIndex < data.length - 1) {
                    forecastDataArr[lastActualIndex] = data[lastActualIndex];
                }

                const datasets = [];

                datasets.push({
                    label: label,
                    data: actualData,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    pointRadius: 3,
                    pointStyle: 'circle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                datasets.push({
                    label: label + ' (예측)',
                    data: forecastDataArr,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.05)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    borderDash: [6, 4],
                    pointRadius: 4,
                    pointStyle: 'triangle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                return datasets;
            }

            const datasets = [];
            // 비용은 금액(원), 나머지는 효율 지표
            const hasAmountMetric = showCost;
            const hasEfficiencyMetric = showCPM || showCPC || showCPA || showROAS;

            if (showCost) {
                const data = forecastData.map(d => parseFloat(d['비용_예측']) || 0);
                datasets.push(...createSplitDatasets('비용', data, '#673ab7', 'y'));
            }

            if (showCPM) {
                // CPM = 비용 / 노출 * 1000
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const impressions = parseFloat(d['노출_예측']) || 0;
                    return impressions > 0 ? (cost / impressions * 1000) : 0;
                });
                datasets.push(...createSplitDatasets('CPM', data, '#ffab00', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showCPC) {
                // CPC = 비용 / 클릭
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const clicks = parseFloat(d['클릭_예측']) || 0;
                    return clicks > 0 ? (cost / clicks) : 0;
                });
                datasets.push(...createSplitDatasets('CPC', data, '#2196f3', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showCPA) {
                // CPA = 비용 / 전환수
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const conversions = parseFloat(d['전환수_예측']) || 0;
                    return conversions > 0 ? (cost / conversions) : 0;
                });
                datasets.push(...createSplitDatasets('CPA', data, '#ff9800', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showROAS) {
                // ROAS = 전환값 / 비용 * 100 (%)
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const value = parseFloat(d['전환값_예측']) || 0;
                    return cost > 0 ? (value / cost * 100) : 0;
                });
                datasets.push(...createSplitDatasets('ROAS', data, '#00c853', hasAmountMetric ? 'y1' : 'y'));
            }

            const showRightAxis = hasAmountMetric && hasEfficiencyMetric;

            forecastChartTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                filter: function(item) {
                                    return !item.text.includes('(예측)');
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    const baseLabel = label.replace(' (예측)', '');
                                    let formattedValue = '';

                                    // KPI별 포맷 적용
                                    if (baseLabel === 'ROAS') {
                                        formattedValue = context.parsed.y.toFixed(1) + '%';
                                    } else if (baseLabel === '비용' || baseLabel === 'CPA') {
                                        formattedValue = formatNumber(context.parsed.y) + '원';
                                    } else if (baseLabel === 'CPM' || baseLabel === 'CPC') {
                                        formattedValue = formatNumber(Math.round(context.parsed.y)) + '원';
                                    } else {
                                        formattedValue = formatNumber(context.parsed.y);
                                    }

                                    let result = baseLabel + ': ' + formattedValue;

                                    const dataIndex = context.dataIndex;
                                    const type = forecastData[dataIndex]?.type;
                                    if (type === 'forecast') {
                                        result += ' (예측)';
                                    }
                                    return result;
                                }
                            }
                        },
                        annotation: {
                            annotations: lastActualIndex >= 0 ? {
                                line1: {
                                    type: 'line',
                                    xMin: lastActualIndex + 0.5,
                                    xMax: lastActualIndex + 0.5,
                                    borderColor: 'rgba(103, 58, 183, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '예측 시작',
                                        position: 'start'
                                    }
                                }
                            } : {}
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: hasAmountMetric ? '비용 (원)' : '효율 지표'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: showRightAxis,
                            position: 'right',
                            title: {
                                display: true,
                                text: '효율 지표'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadInsightsAndSegments();
            loadSegmentData();

            // 뷰 타입 버튼 이벤트 (일별/주별/월별)
            document.querySelectorAll('.view-type-section .view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 부모의 view-btn만 토글
                    const parent = this.closest('.view-type-section');
                    parent.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    if (this.dataset.view) {
                        currentView = this.dataset.view;
                        loadData();
                    }
                });
            });

            // KPI 주요/세부 성과 토글 버튼
            document.querySelectorAll('.kpi-view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // 버튼 활성화 토글
                    document.querySelectorAll('.kpi-view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // kpi-section에 show-all 토글
                    const kpiSection = document.getElementById('kpiSectionContainer');
                    if (kpiSection) {
                        if (btn.dataset.kpiView === 'all') {
                            kpiSection.classList.add('show-all');
                        } else {
                            kpiSection.classList.remove('show-all');
                        }
                    }
                });
            });

            // 차트 체크박스 이벤트
            document.querySelectorAll('.chart-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', updateChart);
            });

            // 세그먼트 트렌드 전체 성과 예측 차트 체크박스 이벤트
            ['chartCostTrend', 'chartImpressionsTrend', 'chartClicksTrend', 'chartConversionsTrend', 'chartValueTrend'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', updateOverallForecastChart);
                }
            });

            // 세그먼트 트렌드 전체 성과 예측 차트 토글 버튼 이벤트
            document.querySelectorAll('.chart-toggle-group .data-label-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const checkboxId = this.dataset.chartToggle;
                    const checkbox = document.getElementById(checkboxId);
                    const toggleCheckbox = this.querySelector('.toggle-checkbox');

                    if (checkbox) {
                        // 체크박스 토글
                        checkbox.checked = !checkbox.checked;

                        // 버튼 스타일 및 아이콘 업데이트
                        if (checkbox.checked) {
                            this.classList.add('active');
                            toggleCheckbox.textContent = '✓';
                        } else {
                            this.classList.remove('active');
                            toggleCheckbox.textContent = '☐';
                        }

                        // 차트 업데이트
                        updateOverallForecastChart();
                    }
                });
            });

            // 성과 트렌드 기간 전환 (7일/14일/30일)
            document.querySelectorAll('.trend-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.dataset.trendPeriod;

                    // 버튼 스타일 업데이트
                    document.querySelectorAll('.trend-period-btn').forEach(b => {
                        if (b.dataset.trendPeriod === period) {
                            b.classList.add('active');
                            b.style.background = '#673ab7';
                            b.style.color = 'white';
                            b.style.borderColor = '#673ab7';
                        } else {
                            b.classList.remove('active');
                            b.style.background = 'white';
                            b.style.color = '#495057';
                            b.style.borderColor = '#dee2e6';
                        }
                    });

                    // 기간 표시 업데이트
                    updateTrendPeriodIndicator(period);

                    // 개선/하락 트렌드 모두 업데이트
                    const periodData = getPeriodData();
                    if (periodData && periodData.performance_trends) {
                        updateImprovementTrends(period, periodData.performance_trends);
                        updateDeclineTrends(period, periodData.performance_trends);
                    }
                });
            });

            // 인사이트 탭 전환 이벤트 (통합 인사이트 대시보드)
            document.querySelectorAll('.insights-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.insights-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.insightsTab;
                    document.querySelectorAll('.insights-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 탭 표시
                    if (targetTab === 'summary') {
                        document.getElementById('summaryTab').style.display = 'block';
                    } else if (targetTab === 'alerts') {
                        document.getElementById('alertsTab').style.display = 'block';
                    } else if (targetTab === 'opportunities') {
                        document.getElementById('opportunitiesTab').style.display = 'block';
                    } else if (targetTab === 'matrix') {
                        document.getElementById('matrixTab').style.display = 'block';
                        // Matrix 탭 렌더링
                        if (typeof renderMatrixInsights === 'function') {
                            renderMatrixInsights();
                        }
                    }
                });
            });

            // Matrix 하위탭 전환 이벤트
            document.querySelectorAll('.matrix-sub-tab').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.matrix-sub-tab').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = '#666';
                    });
                    this.classList.add('active');
                    this.style.background = '#673ab7';
                    this.style.color = 'white';

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.matrixTab;
                    document.querySelectorAll('.matrix-sub-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 탭 표시
                    const tabMap = {
                        'brand': 'matrixBrandTab',
                        'channel': 'matrixChannelTab',
                        'product': 'matrixProductTab',
                        'promotion': 'matrixPromotionTab'
                    };
                    const targetElement = document.getElementById(tabMap[targetTab]);
                    if (targetElement) {
                        targetElement.style.display = 'block';
                    }
                });
            });

            // 분석 탭 전환 이벤트 (성과 분석 대시보드)
            document.querySelectorAll('.analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 탭 표시
                    if (targetTab === 'forecast') {
                        document.getElementById('forecastTab').style.display = 'block';
                    } else if (targetTab === 'budget-simulation') {
                        document.getElementById('budgetSimulationMainTab').style.display = 'block';
                        // 시뮬레이션 초기화 (탭 전환 시)
                        if (typeof initSimulation === 'function') {
                            initSimulation();
                        }
                    } else if (targetTab === 'segment-trend') {
                        document.getElementById('segmentTrendTab').style.display = 'block';
                    }
                });
            });

            // 통계 분석 서브 탭 전환 이벤트
            document.querySelectorAll('.statistics-subtab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.statistics-subtab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.statisticsTab;
                    document.querySelectorAll('.statistics-subtab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 서브 탭 표시
                    if (targetTab === 'forecast-trend') {
                        document.getElementById('forecastTrendTab').style.display = 'block';
                    } else if (targetTab === 'correlation-quality') {
                        document.getElementById('correlationQualityTab').style.display = 'block';
                    }
                });
            });

            // 세그먼트 트렌드 타입 버튼 이벤트
            document.querySelectorAll('.segment-trend-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.segment-trend-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTrendSegmentType = this.dataset.segment;

                    // 전체 vs 세그먼트별 콘텐츠 전환
                    const overallContent = document.getElementById('segmentTrendOverallContent');
                    const segmentContent = document.getElementById('segmentTrendSegmentContent');

                    if (currentTrendSegmentType === 'overall') {
                        overallContent.style.display = 'block';
                        segmentContent.style.display = 'none';
                        updateOverallForecastChart();
                    } else {
                        overallContent.style.display = 'none';
                        segmentContent.style.display = 'block';
                        updateSegmentTrendCheckboxes();
                    }
                });
            });

            // 세그먼트 트렌드 드롭다운 토글 이벤트
            const segmentTrendDropdownBtn = document.getElementById('segmentTrendDropdownBtn');
            const segmentTrendDropdownList = document.getElementById('segmentTrendDropdownList');

            if (segmentTrendDropdownBtn && segmentTrendDropdownList) {
                segmentTrendDropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = segmentTrendDropdownList.style.display === 'block';
                    segmentTrendDropdownList.style.display = isOpen ? 'none' : 'block';
                });

                // 드롭다운 외부 클릭 시 닫기
                document.addEventListener('click', function(e) {
                    if (!segmentTrendDropdownBtn.contains(e.target) && !segmentTrendDropdownList.contains(e.target)) {
                        segmentTrendDropdownList.style.display = 'none';
                    }
                });
            }

            // 세그먼트 트렌드 전체 선택 이벤트
            const segmentTrendSelectAll = document.getElementById('segmentTrendSelectAll');
            if (segmentTrendSelectAll) {
                segmentTrendSelectAll.addEventListener('change', function() {
                    const allCheckboxes = document.querySelectorAll('.segment-trend-checkbox');
                    const maxSelect = Math.min(5, allCheckboxes.length);

                    if (this.checked) {
                        // 최대 5개까지만 선택
                        allCheckboxes.forEach((cb, index) => {
                            cb.checked = index < maxSelect;
                        });
                    } else {
                        // 전체 해제
                        allCheckboxes.forEach(cb => {
                            cb.checked = false;
                        });
                    }

                    updateSegmentTrendDropdownLabel();
                    updateSegmentTrendChart();
                });
            }

            // 세그먼트 트렌드 뷰 타입 버튼 이벤트 (일별/주별/월별)
            document.querySelectorAll('.segment-trend-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.segment-trend-view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    segmentTrendViewType = this.dataset.view;

                    // 전체 성과 예측 데이터도 갱신 (currentView 변경 및 데이터 로드)
                    currentView = this.dataset.view;
                    loadData();

                    // 현재 선택된 하위탭에 따라 차트 업데이트
                    if (currentTrendSegmentType === 'overall') {
                        // forecastData가 loadData에서 비동기로 갱신되므로 약간의 지연 후 업데이트
                        setTimeout(() => updateOverallForecastChart(), 100);
                    } else {
                        updateSegmentTrendChart();
                    }
                });
            });

            // 세그먼트 트렌드 지표 선택 이벤트
            const segmentTrendMetricDropdown = document.getElementById('segmentTrendMetricDropdown');
            if (segmentTrendMetricDropdown) {
                segmentTrendMetricDropdown.addEventListener('change', function() {
                    segmentTrendMetric = this.value;
                    updateSegmentTrendChart();
                });
            }

            // 세그먼트 트렌드 기간 선택 이벤트
            const segmentTrendStartDateInput = document.getElementById('segmentTrendStartDate');
            const segmentTrendEndDateInput = document.getElementById('segmentTrendEndDate');

            if (segmentTrendStartDateInput) {
                segmentTrendStartDateInput.addEventListener('change', function() {
                    segmentTrendStartDate = this.value;
                    updateSegmentTrendChart();
                });
            }

            if (segmentTrendEndDateInput) {
                segmentTrendEndDateInput.addEventListener('change', function() {
                    segmentTrendEndDate = this.value;
                    updateSegmentTrendChart();
                });
            }

            // 세그먼트 트렌드 기간 초기값 설정
            initSegmentTrendDateRange();

            // 접기/펼치기 이벤트 초기화
            initCollapsibles();
        });

        // 접기/펼치기 기능
        function initCollapsibles() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', function() {
                    const section = this.parentElement;
                    const content = section.querySelector('.collapsible-content');
                    const toggleBtn = section.querySelector('.collapsible-toggle');
                    const toggleIcon = section.querySelector('.collapsible-toggle-icon');
                    const toggleText = toggleBtn.querySelector('span');

                    if (content.classList.contains('expanded')) {
                        // 접기
                        content.classList.remove('expanded');
                        toggleIcon.classList.add('collapsed');
                        toggleText.textContent = '펼치기';
                    } else {
                        // 펼치기
                        content.classList.add('expanded');
                        toggleIcon.classList.remove('collapsed');
                        toggleText.textContent = '접기';

                        // 성과 분석 대시보드 섹션이 펼쳐질 때 차트 업데이트
                        if (content.querySelector('#segmentTrendTab')) {
                            setTimeout(() => {
                                if (currentTrendSegmentType === 'overall') {
                                    updateOverallForecastChart();
                                } else {
                                    updateSegmentTrendChart();
                                }
                            }, 50);
                        }
                    }
                });
            });
        }

        // =====================================================
        // 예산 시나리오 시뮬레이션 모듈
        // =====================================================

        // 시뮬레이션 상태 변수
        let currentSimSegmentType = 'all';
        let simulationData = {};
        let budgetAdjustments = {};
        const DIMINISHING_FACTOR = 0.15; // 체감 수익 계수

        // 통화 포맷
        function formatSimCurrency(value) {
            if (value >= 100000000) {
                return (value / 100000000).toFixed(1) + '억';
            } else if (value >= 10000000) {
                return (value / 10000).toFixed(0) + '만';
            } else if (value >= 10000) {
                return (value / 10000).toFixed(1) + '만';
            }
            return value.toLocaleString() + '원';
        }

        // 시뮬레이션 초기화
        function initSimulation() {
            loadSimulationData();
            renderSimulationSliders();
            updateSimulationResults();
            bindSimulationEvents();
        }

        // 호환성을 위한 별칭
        const initBudgetSimulation = initSimulation;

        // 세그먼트 데이터 로드
        function loadSimulationData() {
            simulationData = {};

            // '전체' 선택 시 모든 데이터를 하나로 통합
            if (currentSimSegmentType === 'all') {
                simulationData['전체'] = {
                    cost: 0,
                    revenue: 0,
                    conversions: 0,
                    clicks: 0
                };

                // 채널 데이터 기준으로 전체 집계 (중복 방지)
                const data = segmentData['channel'];
                if (data && data.length > 0) {
                    data.forEach(row => {
                        if (row.type !== 'actual') return;
                        simulationData['전체'].cost += parseFloat(row['비용_예측']) || 0;
                        simulationData['전체'].revenue += parseFloat(row['전환값_예측']) || 0;
                        simulationData['전체'].conversions += parseFloat(row['전환수_예측']) || 0;
                        simulationData['전체'].clicks += parseFloat(row['클릭_예측']) || 0;
                    });
                }
            } else {
                const data = segmentData[currentSimSegmentType];
                if (!data || data.length === 0) return;

                // 실제 데이터만 집계
                data.forEach(row => {
                    if (row.type !== 'actual') return;

                    const segmentName = row[currentSimSegmentType] || row.channel || row.product || row.brand || row.promotion;
                    if (!segmentName) return;

                    if (!simulationData[segmentName]) {
                        simulationData[segmentName] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            clicks: 0
                        };
                    }

                    simulationData[segmentName].cost += parseFloat(row['비용_예측']) || 0;
                    simulationData[segmentName].revenue += parseFloat(row['전환값_예측']) || 0;
                    simulationData[segmentName].conversions += parseFloat(row['전환수_예측']) || 0;
                    simulationData[segmentName].clicks += parseFloat(row['클릭_예측']) || 0;
                });
            }

            // ROAS 계산 및 초기 조정값 설정
            Object.keys(simulationData).forEach(segment => {
                const seg = simulationData[segment];
                seg.roas = seg.cost > 0 ? (seg.revenue / seg.cost * 100) : 0;
                seg.cvr = seg.clicks > 0 ? (seg.conversions / seg.clicks * 100) : 0;
                budgetAdjustments[segment] = 0; // 초기값 0%
            });

            // 체크박스 렌더링
            renderSimItemCheckboxes();
        }

        // 시뮬레이션 항목 선택 체크박스 렌더링
        function renderSimItemCheckboxes() {
            const container = document.getElementById('simItemCheckboxes');
            if (!container) return;

            const segments = Object.keys(simulationData).sort((a, b) => {
                return simulationData[b].cost - simulationData[a].cost;
            });

            if (segments.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: var(--grey-500); font-size: 12px;">항목이 없습니다.</div>';
                return;
            }

            container.innerHTML = segments.map((segment, index) => {
                const seg = simulationData[segment];
                return `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="sim-item-checkbox" data-segment="${segment}" ${index < segments.length ? 'checked' : ''} style="margin-right: 10px; width: 14px; height: 14px; cursor: pointer;">
                        <span>${segment}</span>
                        <span style="margin-left: auto; font-size: 10px; color: var(--grey-500);">${formatSimCurrency(seg.cost)}</span>
                    </label>
                `;
            }).join('');

            // 체크박스 이벤트 바인딩
            container.querySelectorAll('.sim-item-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    updateSimItemDropdownLabel();
                    updateSimItemSelectAllState();
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            });

            updateSimItemDropdownLabel();
            updateSimItemSelectAllState();
        }

        // 시뮬레이션 항목 드롭다운 라벨 업데이트
        function updateSimItemDropdownLabel() {
            const checkedBoxes = document.querySelectorAll('.sim-item-checkbox:checked');
            const labelEl = document.getElementById('simItemDropdownLabel');
            const countEl = document.getElementById('simItemSelectedCount');
            const countEl2 = document.getElementById('simSelectedItemCount');

            if (labelEl) {
                if (checkedBoxes.length === 0) {
                    labelEl.textContent = '항목을 선택하세요';
                } else if (checkedBoxes.length === 1) {
                    labelEl.textContent = checkedBoxes[0].dataset.segment;
                } else {
                    labelEl.textContent = `${checkedBoxes[0].dataset.segment} 외 ${checkedBoxes.length - 1}개`;
                }
            }

            if (countEl) {
                countEl.textContent = checkedBoxes.length > 0 ? `${checkedBoxes.length}개` : '';
            }

            if (countEl2) {
                countEl2.textContent = checkedBoxes.length > 0 ? `(${checkedBoxes.length}개 선택됨)` : '';
            }
        }

        // 시뮬레이션 항목 전체선택 상태 업데이트
        function updateSimItemSelectAllState() {
            const allCheckboxes = document.querySelectorAll('.sim-item-checkbox');
            const checkedBoxes = document.querySelectorAll('.sim-item-checkbox:checked');
            const selectAllCb = document.getElementById('simItemSelectAll');

            if (selectAllCb) {
                selectAllCb.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedBoxes.length;
                selectAllCb.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
            }
        }

        // 선택된 시뮬레이션 항목 가져오기
        function getSelectedSimItems() {
            const checkedBoxes = document.querySelectorAll('.sim-item-checkbox:checked');
            return Array.from(checkedBoxes).map(cb => cb.dataset.segment);
        }

        // 슬라이더 렌더링
        function renderSimulationSliders() {
            const container = document.getElementById('simulationSlidersContainer');
            if (!container) return;

            // 선택된 항목만 필터링
            const selectedItems = getSelectedSimItems();
            const segments = Object.keys(simulationData)
                .filter(seg => selectedItems.length === 0 || selectedItems.includes(seg))
                .sort((a, b) => simulationData[b].cost - simulationData[a].cost);

            if (segments.length === 0) {
                container.innerHTML = '<div style="color: var(--grey-600); text-align: center; padding: 20px;">표시할 항목을 선택하세요.</div>';
                return;
            }

            container.innerHTML = segments.map(segment => {
                const seg = simulationData[segment];
                const currentAdjust = budgetAdjustments[segment] || 0;
                const roasLevel = seg.roas >= 150 ? 'high' : seg.roas >= 50 ? 'medium' : 'low';
                const fillPercent = ((currentAdjust - (-30)) / (50 - (-30))) * 100;
                const newBudget = seg.cost * (1 + currentAdjust / 100);

                return `
                    <div class="sim-slider-group" data-segment="${segment}">
                        <div class="sim-slider-header">
                            <div class="sim-segment-info">
                                <div class="sim-segment-badge ${roasLevel}">${roasLevel === 'high' ? '고효율' : roasLevel === 'medium' ? '중효율' : '저효율'}</div>
                                <span class="sim-segment-name">${segment}</span>
                            </div>
                            <div class="sim-segment-metrics">
                                <span class="sim-roas-badge ${roasLevel}">ROAS ${seg.roas.toFixed(0)}%</span>
                                <span class="sim-current-budget">${formatSimCurrency(seg.cost)}</span>
                            </div>
                        </div>
                        <div class="sim-slider-container">
                            <span class="sim-slider-label">-30%</span>
                            <div class="sim-slider-track">
                                <input type="range" min="-30" max="50" value="${currentAdjust}" step="5"
                                       class="sim-slider simulation-slider" data-segment="${segment}">
                                <div class="sim-slider-fill" style="width: ${fillPercent}%;"></div>
                                <div class="sim-slider-thumb-value" style="left: ${fillPercent}%;">${currentAdjust > 0 ? '+' : ''}${currentAdjust}%</div>
                            </div>
                            <span class="sim-slider-label">+50%</span>
                        </div>
                        <div class="sim-slider-result">
                            <span class="sim-result-label">변경 예산</span>
                            <span class="sim-result-value ${currentAdjust >= 0 ? 'positive' : 'negative'}">
                                ${formatSimCurrency(newBudget)} <small>(${currentAdjust > 0 ? '+' : ''}${currentAdjust}%)</small>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            // 슬라이더 이벤트 바인딩
            container.querySelectorAll('.simulation-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const segment = this.dataset.segment;
                    const value = parseInt(this.value);
                    const min = parseInt(this.min);
                    const max = parseInt(this.max);
                    const percentage = ((value - min) / (max - min)) * 100;
                    budgetAdjustments[segment] = value;

                    const group = this.closest('.sim-slider-group');
                    const track = this.parentElement;

                    // 슬라이더 필 업데이트
                    const fill = track.querySelector('.sim-slider-fill');
                    if (fill) fill.style.width = percentage + '%';

                    // 썸 값 업데이트
                    const thumbValue = track.querySelector('.sim-slider-thumb-value');
                    if (thumbValue) {
                        thumbValue.textContent = (value > 0 ? '+' : '') + value + '%';
                        thumbValue.style.left = percentage + '%';
                    }

                    // 결과 값 업데이트
                    const resultValue = group.querySelector('.sim-result-value');
                    if (resultValue) {
                        const seg = simulationData[segment];
                        const newBudget = seg.cost * (1 + value / 100);
                        resultValue.innerHTML = `${formatSimCurrency(newBudget)} <small>(${value > 0 ? '+' : ''}${value}%)</small>`;
                        resultValue.className = 'sim-result-value ' + (value >= 0 ? 'positive' : 'negative');
                    }

                    updateSimulationResults();
                });
            });
        }

        // 로그 체감 함수 적용 ROAS 계산
        function calculateAdjustedRoas(currentRoas, budgetChangeRatio) {
            if (budgetChangeRatio > 0) {
                // 예산 증가: ROAS 하락 (체감 수익)
                return currentRoas * (1 - DIMINISHING_FACTOR * Math.log(1 + budgetChangeRatio));
            } else if (budgetChangeRatio < 0) {
                // 예산 감소: ROAS 상승 (효율적 타겟 집중)
                return currentRoas * (1 + DIMINISHING_FACTOR * Math.log(1 + Math.abs(budgetChangeRatio)) * 0.5);
            }
            return currentRoas;
        }

        // 시뮬레이션 결과 업데이트
        function updateSimulationResults() {
            let totalCurrentCost = 0;
            let totalCurrentRevenue = 0;
            let totalNewCost = 0;
            let totalNewRevenue = 0;
            const segmentResults = [];

            // 선택된 항목만 필터링
            const selectedItems = getSelectedSimItems();
            const segmentsToProcess = Object.keys(simulationData)
                .filter(seg => selectedItems.length === 0 || selectedItems.includes(seg));

            segmentsToProcess.forEach(segment => {
                const seg = simulationData[segment];
                const adjustment = (budgetAdjustments[segment] || 0) / 100;

                const newCost = seg.cost * (1 + adjustment);
                const adjustedRoas = calculateAdjustedRoas(seg.roas, adjustment);
                const newRevenue = newCost * (adjustedRoas / 100);

                totalCurrentCost += seg.cost;
                totalCurrentRevenue += seg.revenue;
                totalNewCost += newCost;
                totalNewRevenue += newRevenue;

                // 추천 등급 결정
                let recommendation = '';
                let recColor = '';
                if (adjustedRoas >= 150) {
                    recommendation = '증액 추천';
                    recColor = '#2e7d32';
                } else if (adjustedRoas >= 100) {
                    recommendation = '유지';
                    recColor = '#1565c0';
                } else if (adjustedRoas >= 50) {
                    recommendation = '효율 점검';
                    recColor = '#f57c00';
                } else {
                    recommendation = '감액 검토';
                    recColor = '#c62828';
                }

                segmentResults.push({
                    segment,
                    currentCost: seg.cost,
                    newCost,
                    currentRoas: seg.roas,
                    adjustedRoas,
                    currentRevenue: seg.revenue,
                    newRevenue,
                    recommendation,
                    recColor,
                    adjustment: budgetAdjustments[segment] || 0
                });
            });

            // 요약 카드 업데이트
            const currentRoas = totalCurrentCost > 0 ? (totalCurrentRevenue / totalCurrentCost * 100) : 0;
            const newRoas = totalNewCost > 0 ? (totalNewRevenue / totalNewCost * 100) : 0;
            const costChange = totalCurrentCost > 0 ? ((totalNewCost - totalCurrentCost) / totalCurrentCost * 100) : 0;
            const revenueChange = totalCurrentRevenue > 0 ? ((totalNewRevenue - totalCurrentRevenue) / totalCurrentRevenue * 100) : 0;
            const roasChange = newRoas - currentRoas;

            document.getElementById('simCurrentCost').textContent = formatSimCurrency(totalCurrentCost);
            document.getElementById('simNewCost').textContent = formatSimCurrency(totalNewCost);
            document.getElementById('simCostChange').textContent = (costChange >= 0 ? '+' : '') + costChange.toFixed(1) + '%';
            document.getElementById('simCostChange').style.color = costChange > 0 ? '#c62828' : costChange < 0 ? '#2e7d32' : 'var(--grey-600)';

            document.getElementById('simCurrentRevenue').textContent = formatSimCurrency(totalCurrentRevenue);
            document.getElementById('simNewRevenue').textContent = formatSimCurrency(totalNewRevenue);
            document.getElementById('simRevenueChange').textContent = (revenueChange >= 0 ? '+' : '') + revenueChange.toFixed(1) + '%';
            document.getElementById('simRevenueChange').style.color = revenueChange > 0 ? '#2e7d32' : revenueChange < 0 ? '#c62828' : 'var(--grey-600)';

            document.getElementById('simCurrentRoas').textContent = currentRoas.toFixed(0) + '%';
            document.getElementById('simNewRoas').textContent = newRoas.toFixed(0) + '%';
            document.getElementById('simRoasChange').textContent = (roasChange >= 0 ? '+' : '') + roasChange.toFixed(1) + '%p';
            document.getElementById('simRoasChange').style.color = roasChange > 0 ? '#2e7d32' : roasChange < 0 ? '#c62828' : 'var(--grey-600)';

            // 투자 효율 계산
            const additionalCost = totalNewCost - totalCurrentCost;
            const additionalRevenue = totalNewRevenue - totalCurrentRevenue;
            let efficiencyText = '-';
            if (additionalCost > 0 && additionalRevenue > 0) {
                const efficiency = (additionalRevenue / additionalCost * 100).toFixed(0);
                efficiencyText = efficiency + '%';
            } else if (additionalCost < 0 && additionalRevenue < 0) {
                efficiencyText = '비용 절감';
            } else if (additionalCost === 0) {
                efficiencyText = '변동 없음';
            }
            document.getElementById('simInvestmentEfficiency').textContent = efficiencyText;

            // 테이블 업데이트
            const tbody = document.getElementById('simulationResultBody');
            if (segmentResults.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 30px; text-align: center; color: var(--grey-500);">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                <span>표시할 항목을 선택하세요.</span>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                // 뱃지 클래스 매핑 함수
                const getBadgeClass = (rec) => {
                    if (rec === '증액 추천') return 'recommend';
                    if (rec === '유지') return 'maintain';
                    if (rec === '효율 점검') return 'review';
                    return 'warning';
                };

                // ROAS 레벨에 따른 dot 클래스
                const getDotClass = (roas) => {
                    if (roas >= 150) return 'high';
                    if (roas >= 50) return 'medium';
                    return 'low';
                };

                // 개별 행
                const rowsHtml = segmentResults.map(r => {
                    const dotClass = getDotClass(r.currentRoas);
                    const badgeClass = getBadgeClass(r.recommendation);
                    const rowClass = r.adjustment !== 0 ? 'sim-changed-row' : '';
                    const costChangeClass = r.adjustment > 0 ? 'positive' : r.adjustment < 0 ? 'negative' : 'neutral';
                    const roasClass = r.adjustedRoas >= 100 ? 'positive' : 'negative';

                    return `
                    <tr class="${rowClass}">
                        <td>
                            <div class="sim-segment-cell">
                                <span class="sim-segment-dot ${dotClass}"></span>
                                <span>${r.segment}</span>
                            </div>
                        </td>
                        <td style="text-align: right;">${formatSimCurrency(r.currentCost)}</td>
                        <td style="text-align: right;">
                            <span class="sim-highlight-cell ${costChangeClass}">
                                ${formatSimCurrency(r.newCost)}
                            </span>
                            <span style="font-size: 10px; color: var(--grey-400); margin-left: 4px;">(${r.adjustment > 0 ? '+' : ''}${r.adjustment}%)</span>
                        </td>
                        <td style="text-align: right;">${formatSimCurrency(r.currentRevenue)}</td>
                        <td style="text-align: right; font-weight: 600;">${formatSimCurrency(r.newRevenue)}</td>
                        <td style="text-align: right;">${r.currentRoas.toFixed(0)}%</td>
                        <td style="text-align: right;">
                            <span class="sim-highlight-cell ${roasClass}">${r.adjustedRoas.toFixed(0)}%</span>
                        </td>
                        <td style="text-align: center;">
                            <span class="sim-badge ${badgeClass}">${r.recommendation}</span>
                        </td>
                    </tr>
                `}).join('');

                // 총합 행
                const costChangeClass = costChange > 0 ? 'positive' : costChange < 0 ? 'negative' : 'neutral';
                const roasChangeClass = newRoas >= currentRoas ? 'positive' : 'negative';
                const totalHtml = `
                    <tr class="sim-total-row">
                        <td>
                            <div class="sim-total-cell">
                                <div class="sim-total-icon">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <path d="M4 6h16M4 12h16M4 18h16"/>
                                    </svg>
                                </div>
                                <span>총합</span>
                            </div>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value">${formatSimCurrency(totalCurrentCost)}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value sim-highlight-cell ${costChangeClass}">
                                ${formatSimCurrency(totalNewCost)}
                            </span>
                            <span style="font-size: 10px; color: var(--grey-500); margin-left: 4px;">(${costChange > 0 ? '+' : ''}${costChange.toFixed(1)}%)</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value">${formatSimCurrency(totalCurrentRevenue)}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value" style="color: #10b981;">${formatSimCurrency(totalNewRevenue)}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value">${currentRoas.toFixed(0)}%</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value sim-highlight-cell ${roasChangeClass}">${newRoas.toFixed(0)}%</span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-size: 11px; color: var(--grey-400);">—</span>
                        </td>
                    </tr>
                `;

                tbody.innerHTML = rowsHtml + totalHtml;
            }

            // 인사이트 업데이트
            updateSimulationInsight(segmentResults, costChange, revenueChange, roasChange);
        }

        // 시뮬레이션 인사이트 생성
        function updateSimulationInsight(results, costChange, revenueChange, roasChange) {
            const insightEl = document.getElementById('simulationInsight');
            const statusEl = document.getElementById('simulationInsightStatus');
            if (!insightEl) return;

            const changedSegments = results.filter(r => r.adjustment !== 0);

            // 상태 업데이트 헬퍼
            const updateStatus = (statusClass, statusText) => {
                if (statusEl) {
                    statusEl.className = `sim-insight-status ${statusClass}`;
                    statusEl.innerHTML = `<span>${statusText}</span>`;
                }
            };

            if (changedSegments.length === 0) {
                insightEl.innerHTML = '주요 항목별 예산을 조정하면 예상 결과가 표시됩니다.';
                updateStatus('neutral', '대기 중');
                return;
            }

            const increased = changedSegments.filter(r => r.adjustment > 0);
            const decreased = changedSegments.filter(r => r.adjustment < 0);

            let insight = '';
            let statusClass = 'neutral';
            let statusText = '분석 중';

            if (revenueChange > 0 && roasChange >= -5) {
                statusClass = 'positive';
                statusText = '긍정적';
                insight = `<strong style="color: #059669;">긍정적 시나리오</strong><br>`;
                insight += `예산 ${costChange > 0 ? '증액' : '조정'}으로 매출이 <strong>${revenueChange.toFixed(1)}%</strong> 증가할 것으로 예상됩니다.`;
                if (roasChange < 0) {
                    insight += ` 다만 ROAS가 ${Math.abs(roasChange).toFixed(1)}%p 하락하므로 효율성 모니터링이 필요합니다.`;
                }
            } else if (revenueChange > 0 && roasChange < -5) {
                statusClass = 'warning';
                statusText = '주의 필요';
                insight = `<strong style="color: #d97706;">주의가 필요한 시나리오</strong><br>`;
                insight += `매출은 ${revenueChange.toFixed(1)}% 증가하지만, ROAS가 <strong>${Math.abs(roasChange).toFixed(1)}%p</strong> 크게 하락합니다. `;
                insight += `체감 수익 효과로 인한 효율 저하를 고려하세요.`;
            } else if (revenueChange < 0) {
                statusClass = 'negative';
                statusText = '재검토';
                insight = `<strong style="color: #dc2626;">재검토가 필요한 시나리오</strong><br>`;
                insight += `현재 설정으로는 매출이 ${Math.abs(revenueChange).toFixed(1)}% 감소할 것으로 예상됩니다. `;
                insight += `예산 배분을 다시 검토해보세요.`;
            } else {
                statusClass = 'neutral';
                statusText = '변동 없음';
                insight = `<strong style="color: #64748b;">변동 없음</strong><br>`;
                insight += `현재 설정에서는 매출 변화가 없습니다.`;
            }

            // 추가 정보
            if (increased.length > 0) {
                const topIncreased = increased.sort((a, b) => b.adjustment - a.adjustment)[0];
                insight += `<br><br><span style="color: var(--grey-500);">▸</span> <strong>${topIncreased.segment}</strong>에 가장 많은 증액(+${topIncreased.adjustment}%)이 설정됨`;
            }
            if (decreased.length > 0) {
                const topDecreased = decreased.sort((a, b) => a.adjustment - b.adjustment)[0];
                insight += `<br><span style="color: var(--grey-500);">▸</span> <strong>${topDecreased.segment}</strong>에 가장 많은 감액(${topDecreased.adjustment}%)이 설정됨`;
            }

            insightEl.innerHTML = insight;
            updateStatus(statusClass, statusText);
        }

        // 시뮬레이션 이벤트 바인딩
        function bindSimulationEvents() {
            // 세그먼트 타입 버튼
            document.querySelectorAll('.simulation-segment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.simulation-segment-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentSimSegmentType = this.dataset.simSegment;
                    budgetAdjustments = {}; // 조정값 초기화
                    loadSimulationData();
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            });

            // 초기화 버튼
            const resetBtn = document.getElementById('resetSimulationBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    Object.keys(budgetAdjustments).forEach(key => {
                        budgetAdjustments[key] = 0;
                    });
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            }

            // 시뮬레이션 항목 드롭다운 이벤트
            const simItemDropdownBtn = document.getElementById('simItemDropdownBtn');
            const simItemDropdownList = document.getElementById('simItemDropdownList');

            if (simItemDropdownBtn && simItemDropdownList) {
                simItemDropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = simItemDropdownList.style.display === 'block';
                    simItemDropdownList.style.display = isOpen ? 'none' : 'block';
                });

                // 드롭다운 외부 클릭 시 닫기
                document.addEventListener('click', function(e) {
                    if (!simItemDropdownBtn.contains(e.target) && !simItemDropdownList.contains(e.target)) {
                        simItemDropdownList.style.display = 'none';
                    }
                });
            }

            // 시뮬레이션 항목 전체 선택 이벤트
            const simItemSelectAll = document.getElementById('simItemSelectAll');
            if (simItemSelectAll) {
                simItemSelectAll.addEventListener('change', function() {
                    const allCheckboxes = document.querySelectorAll('.sim-item-checkbox');

                    if (this.checked) {
                        allCheckboxes.forEach(cb => {
                            cb.checked = true;
                        });
                    } else {
                        allCheckboxes.forEach(cb => {
                            cb.checked = false;
                        });
                    }

                    updateSimItemDropdownLabel();
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            }
        }
    </script>
</body>
</html>
