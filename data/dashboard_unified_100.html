<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마케팅 대시보드 - 통합</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Embed Mode Detection -->
    <script>
        (function() {
            if (new URLSearchParams(window.location.search).get('embed') === 'true') {
                document.documentElement.classList.add('embed-mode');
            }
        })();
    </script>
    <style>
        /* Embed Mode Styles */
        html.embed-mode .sidebar { display: none !important; }
        html.embed-mode .main-content { margin-left: 0 !important; }
        html.embed-mode .mobile-menu-btn { display: none !important; }
        html.embed-mode .sidebar-overlay { display: none !important; }

        /* 페이지 전환 스타일 */
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }

        /* ========== 통합 CSS ========== */
        /* ========== marketing_dashboard_v3.html CSS ========== */

        /* Embed Mode Styles - 사이드바 숨김 */
        html.embed-mode .sidebar { display: none !important; }
        html.embed-mode .main-content { margin-left: 0 !important; }
        html.embed-mode .mobile-menu-btn { display: none !important; }
        html.embed-mode .sidebar-overlay { display: none !important; }
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Simplebar 스타일 래퍼 */
        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--grey-500);
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        /* 네비게이션 그룹 */
        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-bottom: 4px;
        }

        /* 네비게이션 아이템 */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--grey-700);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-item-text {
            flex: 1;
        }

        .nav-item-badge {
            background: var(--primary-main);
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 헤더 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 카드 공통 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 14px 0 rgba(32, 40, 45, 0.08);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px 0 rgba(32, 40, 45, 0.12);
        }

        /* 필터 섹션 */
        .filter-section {
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .filter-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        /* 통합 필터 컨테이너 */
        .filter-inline-container {
            display: flex;
            align-items: flex-start;
            gap: 48px;
            flex-wrap: wrap;
        }

        /* 기간 선택 영역 */
        .filter-date-section {
            display: flex;
            flex-direction: column;
            gap: 37px;
        }

        .filter-date-section .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .filter-date-section .filter-label::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        /* 필터 설정 영역 */
        .filter-setting-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .filter-setting-section .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .filter-setting-section .filter-label::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .filter-setting-section .filter-items {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex: 1;
        }

        .filter-setting-section .filter-group {
            flex: 1;
            min-width: 0;
        }

        /* 접기/펼치기 섹션 */
        .collapsible-section {
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 16px 20px;
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s ease;
        }

        .collapsible-header:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .collapsible-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .collapsible-guide {
            font-size: 12px;
            font-weight: 400;
            color: var(--grey-500);
            margin-left: 8px;
        }

        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-light);
            color: var(--primary-main);
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .collapsible-toggle:hover {
            background: var(--primary-main);
            color: white;
        }

        .filter-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .filter-section-header .filter-header {
            margin-bottom: 0;
        }

        .reset-btn {
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .reset-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .reset-btn:active {
            transform: scale(0.97);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .collapsible-toggle-icon {
            transition: transform 0.2s ease;
            transform: rotate(180deg);
        }

        .collapsible-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
            opacity: 1;
            padding-top: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
            flex: 1;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--grey-700);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
        }

        .filter-group select:hover,
        .filter-group input:hover {
            border-color: var(--primary-main);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* 기간 선택 */
        .date-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-range input[type="date"] {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
        }

        .date-range input[type="date"]:hover {
            border-color: var(--primary-main);
        }

        .date-range input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .date-range span {
            color: var(--grey-500);
            font-weight: 500;
        }

        /* KPI 그리드 - 업그레이드 디자인 */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--paper);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .kpi-card.highlight {
            border-left: 4px solid var(--primary-main);
        }

        .kpi-section {
            margin-bottom: 24px;
        }

        .kpi-grid-primary {
            margin-bottom: 24px;
        }

        .kpi-grid-secondary {
            display: none;
            margin-top: 16px;
        }

        .kpi-section.show-all .kpi-grid-secondary {
            display: grid;
        }

        .kpi-card.secondary {
            background: var(--grey-50);
        }

        .kpi-card.secondary .kpi-icon {
            background: var(--grey-200);
        }

        /* 통합 KPI 섹션 */
        .kpi-unified-section {
            margin-bottom: 24px;
        }

        .kpi-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .kpi-tab-section {
            display: flex;
            gap: 8px;
        }

        .kpi-tab {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .kpi-tab:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .kpi-tab.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .kpi-tab-content {
            display: none;
        }

        .kpi-tab-content.active {
            display: block;
        }

        .kpi-view-toggle {
            display: flex;
            gap: 8px;
        }

        .kpi-view-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .kpi-view-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .kpi-view-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-title {
            font-size: 13px;
            color: var(--grey-600);
            font-weight: 600;
        }

        .kpi-icon {
            width: 36px;
            height: 36px;
            background: var(--grey-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-main);
            font-size: 16px;
        }

        .kpi-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 8px;
        }

        .kpi-value.highlight-value {
            color: var(--primary-main);
        }

        .kpi-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .kpi-trend.up { color: var(--success); }
        .kpi-trend.down { color: var(--error); }
        .kpi-trend.neutral { color: var(--grey-500); }

        .kpi-trend svg {
            width: 14px;
            height: 14px;
        }

        .kpi-trend .trend-value {
            font-weight: 600;
        }

        .kpi-trend .trend-pp {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            background: var(--grey-100);
            color: var(--grey-600);
        }

        .kpi-trend .trend-pp.positive {
            color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .kpi-trend .trend-pp.negative {
            color: var(--error);
            background: rgba(244, 67, 54, 0.1);
        }

        .kpi-card .trend-detail {
            font-size: 11px;
            color: var(--grey-500);
            margin-top: 6px;
        }

        .kpi-card .trend-detail .prev-label {
            margin-right: 4px;
        }

        .kpi-card .trend-detail .prev-value {
            font-weight: 600;
            color: var(--grey-700);
        }

        .kpi-card .trend-wrapper {
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .kpi-card .trend-row {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .kpi-card .trend {
            display: inline-flex;
            align-items: center;
            gap: 1px;
            font-size: 9px;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 8px;
        }

        .kpi-card .trend-pp {
            display: inline-flex;
            align-items: center;
            gap: 1px;
            font-size: 9px;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 8px;
            background: var(--grey-100);
            color: var(--grey-700);
        }

        .kpi-card .trend-pp.positive {
            color: var(--success-main);
            background: var(--success-light);
        }

        .kpi-card .trend-pp.negative {
            color: var(--error-main);
            background: var(--error-light);
        }

        .kpi-card .trend.up {
            color: var(--success-main);
            background: var(--success-light);
        }

        .kpi-card .trend.down {
            color: var(--error-main);
            background: var(--error-light);
        }

        .kpi-card .trend svg {
            width: 8px;
            height: 8px;
        }

        .kpi-card .trend-detail {
            font-size: 9px;
            color: var(--grey-500);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .kpi-card .trend-detail .prev-value {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-700);
        }

        .kpi-card .trend-detail .prev-label {
            font-size: 8px;
            font-weight: 500;
            color: var(--grey-500);
        }

        /* 차트 컨트롤 */
        .chart-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }


        /* 차트 섹션 */
        .chart-section {
            margin-bottom: 24px;
            padding: 24px;
        }

        .chart-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--secondary-main);
            border-radius: 2px;
        }

        .chart-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-section-header .chart-header {
            margin-bottom: 0;
        }

        .data-label-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .data-label-toggle:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .data-label-toggle.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .data-label-toggle .toggle-checkbox {
            font-size: 14px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* 데이터 테이블 */
        .table-section {
            overflow: hidden;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--grey-200);
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--success-main);
            border-radius: 2px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: right;
            font-size: 14px;
        }

        th {
            background: var(--grey-50);
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 2px solid var(--grey-200);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        td {
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--paper);
            font-weight: 500;
        }

        th:first-child {
            background: var(--grey-50);
            z-index: 2;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--grey-50);
        }

        tbody tr:hover td:first-child {
            background: var(--grey-50);
        }

        .positive {
            color: var(--success-main);
            font-weight: 600;
        }

        .negative {
            color: var(--error-main);
            font-weight: 600;
        }

        /* 로딩 */
        .loading {
            text-align: center;
            padding: 60px 40px;
            color: var(--grey-500);
        }

        /* 합계 행 */
        .total-row {
            font-weight: 600;
            background: var(--primary-light) !important;
        }

        .total-row td {
            border-top: 2px solid var(--primary-main);
            color: var(--primary-dark);
        }

        .total-row td:first-child {
            background: var(--primary-light) !important;
        }

        /* 더 보기 버튼 */
        .show-more-container {
            padding: 16px 24px;
            text-align: center;
            border-top: 1px solid var(--grey-200);
        }

        .show-more-btn {
            padding: 10px 32px;
            background: var(--grey-100);
            color: var(--grey-700);
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .show-more-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
            border-color: var(--primary-main);
        }

        .hidden-row {
            display: none;
        }

        /* 스크롤바 스타일 */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--grey-100);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--grey-500);
        }

        /* 반응형 */
        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }

            .filter-row {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .kpi-card {
                min-width: 120px;
                padding: 6px 10px;
            }

            .kpi-card .value {
                font-size: 16px;
            }

            .chart-container {
                height: 250px;
            }

            .chart-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        @media (max-width: 480px) {
            .kpi-card {
                min-width: 100px;
            }

            .kpi-card .value {
                font-size: 15px;
            }

            .kpi-card .trend-detail {
                display: none;
            }
        }
    
/* ========== creative_analysis.html CSS ========== */

        /* Embed Mode Styles - 사이드바 숨김 */
        html.embed-mode .sidebar { display: none !important; }
        html.embed-mode .main-content { margin-left: 0 !important; }
        html.embed-mode .mobile-menu-btn { display: none !important; }
        html.embed-mode .sidebar-overlay { display: none !important; }
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Simplebar 스타일 래퍼 */
        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        /* 네비게이션 그룹 */
        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-bottom: 4px;
        }

        /* 네비게이션 아이템 */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--grey-700);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-item-text {
            flex: 1;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 헤더 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 카드 공통 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 14px 0 rgba(32, 40, 45, 0.08);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px 0 rgba(32, 40, 45, 0.12);
        }

        /* 필터 섹션 */
        .filter-section {
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .filter-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .filter-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .filter-section-header .filter-header {
            margin-bottom: 0;
        }

        .reset-btn {
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .reset-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .reset-btn:active {
            transform: scale(0.97);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
            flex: 1;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--grey-700);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
        }

        .filter-group select:hover,
        .filter-group input:hover {
            border-color: var(--primary-main);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* 날짜 범위 선택 */
        .date-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-range input[type="date"] {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
        }

        .date-range input[type="date"]:hover {
            border-color: var(--primary-main);
        }

        .date-range input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .date-range span {
            color: var(--grey-500);
            font-weight: 500;
        }

        /* 소재 그리드 */
        .creative-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* 소재 카드 */
        .creative-card {
            border-radius: 16px;
            overflow: hidden;
        }

        .creative-image-wrapper {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 비율 */
            background: var(--grey-100);
            overflow: hidden;
        }

        .creative-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .creative-card:hover .creative-image {
            transform: scale(1.05);
        }

        .creative-image-link {
            display: block;
            text-decoration: none;
            position: relative;
        }

        .creative-image-link:hover::after {
            content: '원본 보기';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            pointer-events: none;
        }

        .creative-image-link .creative-image-wrapper {
            cursor: pointer;
        }

        .creative-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--grey-500);
            text-align: center;
        }

        .creative-placeholder svg {
            width: 48px;
            height: 48px;
            fill: var(--grey-300);
            margin-bottom: 8px;
        }

        .creative-info {
            padding: 20px;
        }

        .creative-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .creative-name.clickable {
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .creative-name.clickable:hover {
            color: var(--primary-main);
            text-decoration: underline;
        }

        .creative-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .creative-metric {
            display: flex;
            flex-direction: column;
        }

        .metric-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .metric-value.positive {
            color: var(--success-main);
        }

        .metric-value.negative {
            color: var(--error-main);
        }

        /* 요약 카드 */
        .summary-section {
            margin-bottom: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
        }

        .summary-card {
            padding: 20px;
            border-radius: 12px;
        }

        .summary-card h3 {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .summary-card .unit {
            font-size: 11px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 로딩 */
        .loading {
            text-align: center;
            padding: 60px 40px;
            color: var(--grey-500);
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--grey-500);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            fill: var(--grey-300);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-700);
            margin-bottom: 8px;
        }

        /* 반응형 */
        @media (max-width: 1400px) {
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .creative-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 모달 스타일 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--paper);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--grey-500);
            padding: 4px;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--grey-900);
        }

        .modal-body {
            padding: 24px;
        }

        /* 모달 KPI 그리드 */
        .modal-kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .modal-kpi-card {
            background: var(--grey-50);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .modal-kpi-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .modal-kpi-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--grey-900);
        }

        /* 모달 차트 */
        .modal-chart-section {
            margin-top: 24px;
        }

        .modal-chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
        }

        .modal-data-label-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .modal-data-label-toggle:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .modal-data-label-toggle.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .modal-data-label-toggle .toggle-checkbox {
            font-size: 14px;
        }

        .modal-chart {
            width: 100%;
            height: 300px;
            background: var(--grey-50);
            border-radius: 12px;
            padding: 16px;
        }

        @media (max-width: 768px) {
            .modal-kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 모달 뷰 타입 버튼 */
        .modal-view-type-section {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .modal-view-btn {
            padding: 8px 20px;
            border: 1px solid var(--grey-300);
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .modal-view-btn:hover {
            border-color: var(--primary-main);
            color: var(--primary-main);
        }

        .modal-view-btn.active {
            background: var(--primary-main);
            color: white;
            border-color: var(--primary-main);
        }

        /* 모달 차트 체크박스 */
        .modal-chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .modal-chart-toggle-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .modal-chart-toggle-group .data-label-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .modal-chart-toggle-group .data-label-toggle:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .modal-chart-toggle-group .data-label-toggle.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .modal-chart-toggle-group .data-label-toggle .toggle-checkbox {
            font-size: 14px;
        }

        /* 모달 테이블 */
        .modal-table-section {
            margin-top: 24px;
        }

        .modal-table-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
        }

        .modal-table-container {
            background: var(--grey-50);
            border-radius: 12px;
            overflow: hidden;
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .modal-table th {
            background: var(--grey-100);
            padding: 12px 16px;
            text-align: right;
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 1px solid var(--grey-200);
        }

        .modal-table th:first-child {
            text-align: left;
        }

        .modal-table td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid var(--grey-200);
            color: var(--grey-900);
        }

        .modal-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .modal-table tr:last-child td {
            border-bottom: none;
        }

        .modal-table tr:hover {
            background: rgba(103, 58, 183, 0.05);
        }

        /* 정렬 가능한 헤더 */
        .modal-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .modal-table th.sortable:hover {
            background: var(--grey-200);
        }

        .modal-table th.sortable .sort-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            color: var(--grey-400);
            transition: color 0.2s ease;
        }

        .modal-table th.sortable.active .sort-icon {
            color: var(--primary-main);
        }

        /* 모달 더보기/접기 버튼 */
        .modal-show-more-container {
            padding: 12px 16px;
            text-align: center;
            border-top: 1px solid var(--grey-200);
        }

        .modal-show-more-btn {
            padding: 8px 24px;
            background: var(--grey-100);
            color: var(--grey-700);
            border: 1px solid var(--grey-300);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .modal-show-more-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
            border-color: var(--primary-main);
        }

        /* 모달 KPI 2행 레이아웃 */
        .modal-kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .modal-kpi-row:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .modal-kpi-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* KPI 필터 토글 버튼 */
        .kpi-filter-toggle {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            background: var(--grey-100);
            color: var(--grey-500);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kpi-filter-toggle:hover {
            border-color: var(--primary-main);
        }

        .kpi-filter-toggle.active {
            background: var(--primary-main);
            color: white;
            border-color: var(--primary-main);
        }

        .kpi-filter-toggle .toggle-status {
            display: inline-block;
        }

        /* KPI 프리셋 선택 */
        .kpi-preset-section {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
        }

        .kpi-preset-select {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 280px;
        }

        .kpi-preset-select:hover {
            border-color: var(--primary-main);
        }

        .kpi-preset-select:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .kpi-preset-select optgroup {
            font-weight: 600;
            color: var(--grey-700);
        }

        .kpi-preset-select option {
            padding: 8px;
            font-weight: 400;
        }

        .kpi-preset-description {
            font-size: 12px;
            color: var(--primary-main);
            background: var(--primary-light);
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-preset-description::before {
            content: '✓';
            font-weight: bold;
        }

        /* 빠른 필터 칩 버튼 섹션 */
        .quick-filter-section {
            margin-top: 16px;
        }

        .quick-filter-section .card {
            padding: 16px 20px;
        }

        .quick-filter-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-800);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-filter-title::before {
            content: '⚡';
        }

        .chip-group {
            margin-bottom: 12px;
        }

        .chip-group:last-child {
            margin-bottom: 0;
        }

        .chip-group-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .chip-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preset-chip {
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--grey-700);
            background: var(--grey-100);
            border: 1px solid var(--grey-300);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .preset-chip:hover {
            background: var(--primary-light);
            border-color: var(--primary-main);
            color: var(--primary-main);
        }

        .preset-chip.active {
            background: var(--primary-main);
            border-color: var(--primary-main);
            color: white;
        }

        .preset-chip .chip-icon {
            margin-right: 6px;
        }

        /* 조합 조건 라디오 버튼 */
        .compound-radio-group {
            display: flex;
            gap: 8px;
            align-items: center;
            height: 38px;
        }

        .compound-radio-group .radio-label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 13px;
            color: var(--grey-700);
        }

        .compound-radio-group .radio-label input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .compound-radio-group .radio-label span {
            white-space: nowrap;
        }

        /* 보조 필터 행 */
        .secondary-filter-row {
            padding-top: 12px;
            border-top: 1px dashed var(--grey-300);
        }

        .secondary-filter-row::before {
            content: '조건 2';
            display: block;
            font-size: 12px;
            color: var(--primary-main);
            font-weight: 600;
            margin-bottom: 8px;
            width: 100%;
        }

        /* 3차 필터 행 */
        .tertiary-filter-row {
            padding-top: 12px;
            border-top: 1px dashed var(--grey-300);
        }

        .tertiary-filter-row::before {
            content: '조건 3';
            display: block;
            font-size: 12px;
            color: var(--primary-main);
            font-weight: 600;
            margin-bottom: 8px;
            width: 100%;
        }

        /* 정렬 라디오 버튼 */
        .sort-radio-group {
            display: flex;
            gap: 12px;
            align-items: center;
            height: 38px;
        }

        .sort-radio-group .radio-label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 13px;
            color: var(--grey-700);
        }

        .sort-radio-group .radio-label input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .sort-radio-group .radio-label span {
            white-space: nowrap;
        }

        /* KPI 필터 + 정렬 통합 레이아웃 */
        .unified-filter-container {
            display: flex;
            gap: 32px;
            align-items: flex-start;
        }

        .unified-filter-left {
            flex: 0 1 auto;
        }

        .unified-filter-right {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
        }

        .unified-filter-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unified-filter-title::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .unified-filter-content {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
        }

        @media (max-width: 1200px) {
            .unified-filter-container {
                flex-direction: column;
                gap: 20px;
            }

            .unified-filter-left {
                padding-right: 0;
            }

            .unified-filter-right {
                padding-left: 0;
            }
        }

        /* 접기/펼치기 섹션 */
        .collapsible-section {
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 16px 20px;
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s ease;
        }

        .collapsible-header:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .collapsible-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .collapsible-guide {
            font-size: 12px;
            font-weight: 400;
            color: var(--grey-500);
            margin-left: 8px;
        }

        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-light);
            color: var(--primary-main);
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .collapsible-toggle:hover {
            background: var(--primary-main);
            color: white;
        }

        .collapsible-toggle-icon {
            transition: transform 0.2s ease;
            transform: rotate(180deg);
        }

        .collapsible-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
            opacity: 1;
            padding-top: 16px;
        }

        /* 통합 필터 컨테이너 */
        .filter-inline-container {
            display: flex;
            align-items: flex-start;
            gap: 48px;
            flex-wrap: wrap;
        }

        /* 기간 선택 영역 */
        .filter-date-section {
            display: flex;
            flex-direction: column;
            gap: 37px;
        }

        .filter-date-section .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .filter-date-section .filter-label::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        /* 필터 설정 영역 */
        .filter-setting-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .filter-setting-section .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .filter-setting-section .filter-label::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .filter-setting-section .filter-items {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex: 1;
        }

        .filter-setting-section .filter-group {
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 768px) {
            .filter-inline-container {
                flex-direction: column;
                gap: 24px;
            }

            .filter-date-section {
                width: 100%;
            }

            .filter-setting-section {
                width: 100%;
            }

            .filter-setting-section .filter-items {
                flex-direction: column;
            }

            .filter-setting-section .filter-group {
                width: 100%;
            }
        }

        /* 칩 호버 툴팁 */
        .chip-hover-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            z-index: 10001;
            min-width: 280px;
            max-width: 320px;
            display: none;
            overflow: hidden;
            pointer-events: none;
            border: 2px solid var(--primary-main);
        }

        .chip-hover-tooltip.show {
            display: block;
        }

        /* 타입별 테두리 색상 */
        .chip-hover-tooltip.high-efficiency {
            border-color: #4caf50;
        }

        .chip-hover-tooltip.potential {
            border-color: #2196f3;
        }

        .chip-hover-tooltip.needs-attention {
            border-color: #ff9800;
        }

        .chip-hover-tooltip.low-efficiency {
            border-color: #f44336;
        }

        .chip-tooltip-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--grey-200);
        }

        .chip-tooltip-header.high-efficiency {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
        }

        .chip-tooltip-header.potential {
            background: linear-gradient(135deg, #e3f2fd 0%, #e8f4fd 100%);
        }

        .chip-tooltip-header.needs-attention {
            background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%);
        }

        .chip-tooltip-header.low-efficiency {
            background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%);
        }

        .chip-tooltip-header-icon {
            font-size: 20px;
        }

        .chip-tooltip-header-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .chip-tooltip-criteria {
            padding: 12px 16px;
            background: var(--grey-50);
            border-bottom: 1px solid var(--grey-200);
        }

        .chip-tooltip-criteria-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--primary-main);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chip-tooltip-criteria-text {
            font-size: 12px;
            color: var(--grey-800);
            line-height: 1.6;
        }

        .chip-tooltip-action {
            padding: 12px 16px;
            background: white;
        }

        .chip-tooltip-action-label {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chip-tooltip-action-label.positive {
            color: #00c853;
        }

        .chip-tooltip-action-label.info {
            color: #2196f3;
        }

        .chip-tooltip-action-label.warning {
            color: #ff9800;
        }

        .chip-tooltip-action-label.negative {
            color: #ff1744;
        }

        .chip-tooltip-action-text {
            font-size: 12px;
            color: var(--grey-700);
            line-height: 1.6;
        }
    
/* ========== timeseries_analysis.html CSS ========== */

        /* Embed Mode Styles - 사이드바 숨김 */
        html.embed-mode .sidebar { display: none !important; }
        html.embed-mode .main-content { margin-left: 0 !important; }
        html.embed-mode .mobile-menu-btn { display: none !important; }
        html.embed-mode .sidebar-overlay { display: none !important; }
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--grey-700);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-item-text {
            flex: 1;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 헤더 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 카드 공통 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 14px 0 rgba(32, 40, 45, 0.08);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px 0 rgba(32, 40, 45, 0.12);
        }

        /* 인사이트 섹션 */
        .insight-section {
            padding: 24px;
            margin-bottom: 24px;
        }

        .insight-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--warning-main);
            border-radius: 2px;
        }

        .insight-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .insight-content.recommendation-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .insight-card {
            padding: 16px 20px;
            background: var(--grey-50);
            border-radius: 10px;
            border-left: 4px solid var(--primary-main);
            transition: all 0.2s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .insight-card.positive,
        .insight-card.low {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-left-color: var(--success-main);
        }

        .insight-card.negative,
        .insight-card.high {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border-left-color: var(--error-main);
        }

        .insight-card.neutral,
        .insight-card.medium {
            background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%);
            border-left-color: var(--warning-main);
        }

        .insight-card.opportunity {
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            border-left-color: var(--secondary-main);
        }

        /* 인사이트 카드 내부 스타일 (type_dashboard 스타일) */
        .insight-type {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            color: var(--grey-500);
        }

        .insight-message {
            font-size: 14px;
            color: var(--grey-900);
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .insight-value {
            font-size: 12px;
            color: var(--grey-600);
            line-height: 1.6;
        }

        /* 탭 컨텐츠 스타일 */
        .insights-tab-content {
            background: var(--paper);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--grey-200);
        }

        /* Overall 성과 카드 그리드 레이아웃 */
        .insight-content.overall-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
        }

        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-title svg {
            width: 18px;
            height: 18px;
        }

        .insight-text {
            font-size: 14px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        /* KPI 요약 섹션 */
        #kpiSummaryGrid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-summary-card {
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--paper) 0%, var(--grey-50) 100%);
            position: relative;
            overflow: hidden;
        }

        .kpi-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .kpi-summary-card:nth-child(1)::before { background: #673ab7; }
        .kpi-summary-card:nth-child(2)::before { background: #2196f3; }
        .kpi-summary-card:nth-child(3)::before { background: #ff9800; }
        .kpi-summary-card:nth-child(4)::before { background: #4caf50; }
        .kpi-summary-card:nth-child(5)::before { background: #00c853; }
        .kpi-summary-card:nth-child(6)::before { background: #9c27b0; }
        .kpi-summary-card:nth-child(7)::before { background: #03a9f4; }
        .kpi-summary-card:nth-child(8)::before { background: #8bc34a; }
        .kpi-summary-card:nth-child(9)::before { background: #ff5722; }

        /* KPI 행 구분 스타일 */
        .kpi-row-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .kpi-row-container {
            margin-bottom: 16px;
        }

        .kpi-row-container:last-child {
            margin-bottom: 0;
        }

        .kpi-summary-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .kpi-summary-unit {
            font-size: 11px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        .kpi-forecast-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .kpi-forecast-badge.up {
            background: var(--success-light);
            color: var(--success-main);
        }

        .kpi-forecast-badge.down {
            background: var(--error-light);
            color: var(--error-main);
        }

        /* KPI 토글 스타일 */
        .kpi-section {
            margin-bottom: 24px;
        }

        .kpi-view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .kpi-view-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .kpi-view-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .kpi-view-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .kpi-grid-primary {
            margin-bottom: 0;
        }

        .kpi-grid.kpi-grid-secondary {
            display: none;
            margin-top: 16px;
        }

        .kpi-section.show-all .kpi-grid.kpi-grid-secondary {
            display: grid;
        }

        .kpi-summary-card.secondary {
            background: var(--grey-50);
        }

        /* KPI 그리드 - 업그레이드 디자인 */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--paper);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .kpi-card.highlight {
            border-left: 4px solid var(--primary-main);
        }

        .kpi-card.secondary {
            background: var(--grey-50);
        }

        .kpi-card.secondary .kpi-icon {
            background: var(--grey-200);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-title {
            font-size: 13px;
            color: var(--grey-600);
            font-weight: 600;
        }

        .kpi-icon {
            width: 36px;
            height: 36px;
            background: var(--grey-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-main);
            font-size: 16px;
        }

        .kpi-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 8px;
        }

        .kpi-value.highlight-value {
            color: var(--primary-main);
        }

        .kpi-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .kpi-trend.up { color: var(--success-main); }
        .kpi-trend.down { color: var(--error-main); }
        .kpi-trend.neutral { color: var(--grey-500); }

        .kpi-card .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .kpi-card .trend-badge.up {
            background: var(--success-light);
            color: var(--success-main);
        }

        .kpi-card .trend-badge.down {
            background: var(--error-light);
            color: var(--error-main);
        }

        /* 차트 섹션 */
        .chart-section {
            margin-bottom: 24px;
            padding: 24px;
        }

        .chart-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--secondary-main);
            border-radius: 2px;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chart-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--grey-700);
            padding: 6px 12px;
            border-radius: 20px;
            transition: all 0.2s ease;
            background: var(--grey-100);
        }

        .chart-checkbox:hover {
            background: var(--grey-200);
        }

        .chart-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-main);
            cursor: pointer;
        }

        .chart-checkbox.cost { border-left: 3px solid #673ab7; }
        .chart-checkbox.impressions { border-left: 3px solid #2196f3; }
        .chart-checkbox.clicks { border-left: 3px solid #ff9800; }
        .chart-checkbox.conversions { border-left: 3px solid #4caf50; }
        .chart-checkbox.value { border-left: 3px solid #00c853; }

        .chart-container {
            position: relative;
            height: 400px;
        }

        /* 뷰 타입 버튼 */
        .view-type-section {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        /* 데이터 라벨 토글 버튼 스타일 */
        .data-label-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .data-label-toggle:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .data-label-toggle.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .data-label-toggle .toggle-checkbox {
            font-size: 14px;
        }

        .view-btn,
        .period-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .view-btn:hover,
        .period-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .view-btn.active,
        .period-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        /* 기간 필터 적용 탭 스타일 */
        .view-btn.period-filter-enabled {
            position: relative;
        }

        .view-btn.period-filter-enabled::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: #673ab7;
            border-radius: 50%;
            opacity: 0.7;
        }

        .view-btn.period-filter-enabled.active::before {
            background: white;
            opacity: 1;
        }

        /* 시각화 이미지 섹션 */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .visualization-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 1200px) {
            .visualization-grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .visualization-grid,
            .visualization-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .visualization-card {
            padding: 20px;
            position: relative;
        }

        .visualization-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visualization-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--success-main);
            border-radius: 2px;
        }

        /* Image tooltip wrapper */
        .img-tooltip-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .visualization-img {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--grey-200);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: block;
        }

        .img-tooltip-wrapper:hover .visualization-img {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Tooltip styles */
        .img-tooltip-wrapper[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(33, 33, 33, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            white-space: normal;
            max-width: 320px;
            width: max-content;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .img-tooltip-wrapper[data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-12px);
        }

        .img-tooltip-wrapper[data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-2px);
            border: 6px solid transparent;
            border-top-color: rgba(33, 33, 33, 0.95);
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 1001;
        }

        .img-tooltip-wrapper[data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-6px);
        }

        /* 데이터 테이블 */
        .table-section {
            overflow: hidden;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--grey-200);
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--success-main);
            border-radius: 2px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: right;
            font-size: 14px;
        }

        th {
            background: var(--grey-50);
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 2px solid var(--grey-200);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        td {
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--paper);
            font-weight: 500;
        }

        th:first-child {
            background: var(--grey-50);
            z-index: 2;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--grey-50);
        }

        tbody tr:hover td:first-child {
            background: var(--grey-50);
        }

        .forecast-row {
            background: var(--primary-light) !important;
        }

        .forecast-row td {
            color: var(--primary-dark);
        }

        .forecast-row td:first-child {
            background: var(--primary-light) !important;
        }

        .mixed-row {
            background: var(--warning-light) !important;
        }

        .mixed-row td {
            color: var(--grey-900);
        }

        .mixed-row td:first-child {
            background: var(--warning-light) !important;
        }

        /* 접기/펼치기 스타일 */
        .collapsible-section {
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 20px 24px;
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--grey-200);
            transition: box-shadow 0.2s ease;
        }

        .collapsible-header:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .collapsible-icon {
            font-size: 24px;
        }

        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-light);
            color: var(--primary-main);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .collapsible-toggle:hover {
            background: #673ab7;
            color: white;
        }

        .collapsible-toggle.active {
            background: #673ab7;
            color: white;
        }

        .collapsible-toggle-icon {
            transition: transform 0.2s ease;
            transform: rotate(180deg);
        }

        .collapsible-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0 24px;
            transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 5000px;
            opacity: 1;
            padding: 24px;
        }

        /* 컴팩트한 그리드 */
        .compact-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 968px) {
            .compact-grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* 세그먼트 분석 스타일 */
        .segment-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 0 24px;
        }

        .segment-tab {
            padding: 10px 24px;
            border: none;
            background: var(--grey-100);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .segment-tab:hover {
            background: var(--grey-200);
        }

        .segment-tab.active {
            background: var(--primary-main);
            color: white;
        }

        .segment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            padding: 0 24px 24px;
        }

        .segment-card {
            padding: 20px;
            background: linear-gradient(135deg, var(--grey-50) 0%, var(--paper) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--primary-main);
            transition: all 0.2s ease;
        }

        .segment-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .segment-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
        }

        .segment-metrics {
            display: grid;
            gap: 12px;
        }

        .segment-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--grey-200);
        }

        .segment-metric-row:last-child {
            border-bottom: none;
        }

        .segment-metric-label {
            font-size: 13px;
            color: var(--grey-600);
        }

        .segment-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .segment-metric-value.positive {
            color: var(--success-main);
        }

        .segment-metric-value.negative {
            color: var(--error-main);
        }

        /* 추천 카드 스타일 - 컴팩트 디자인 */
        .recommendation-card {
            padding: 16px;
            background: linear-gradient(135deg, var(--success-light) 0%, var(--paper) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--success-main);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .recommendation-card:hover {
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
            transform: translateY(-2px);
        }

        .recommendation-card.expanded {
            padding: 20px;
        }

        .recommendation-priority {
            display: inline-block;
            padding: 4px 10px;
            background: var(--success-main);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .recommendation-action {
            font-size: 15px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 6px;
        }

        .recommendation-target {
            font-size: 12px;
            color: var(--grey-600);
            margin-bottom: 10px;
        }

        .recommendation-reasons {
            list-style: none;
            margin: 0;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        }

        .recommendation-card.expanded .recommendation-reasons {
            max-height: 300px;
            opacity: 1;
            margin: 12px 0;
        }

        .recommendation-reasons li {
            font-size: 13px;
            color: var(--grey-700);
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .recommendation-reasons li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success-main);
            font-weight: 600;
        }

        .recommendation-impact {
            font-size: 12px;
            font-weight: 600;
            color: #7b1fa2;
            margin-top: 8px;
        }

        .recommendation-card.expanded .recommendation-impact {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--grey-200);
        }

        .recommendation-expand-hint {
            font-size: 10px;
            color: var(--grey-500);
            text-align: right;
            margin-top: 6px;
            opacity: 0.7;
        }

        .recommendation-card.expanded .recommendation-expand-hint {
            display: none;
        }

        /* 반응형 */
        @media (max-width: 1400px) {
            .kpi-summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .visualization-grid {
                grid-template-columns: 1fr;
            }
            .insight-content:not(.overall-grid) {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            .kpi-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-container {
                height: 300px;
            }
            .insight-content:not(.overall-grid) {
                grid-template-columns: 1fr;
            }
        }

        /* 예산 시뮬레이션 슬라이더 */
        .simulation-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: linear-gradient(to right, #c62828 0%, #c62828 37.5%, #e0e0e0 37.5%, #e0e0e0 62.5%, #2e7d32 62.5%, #2e7d32 100%);
            border-radius: 3px;
            outline: none;
        }

        .simulation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .simulation-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .simulation-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid var(--primary-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* 초기화 버튼 */
        .reset-btn {
            padding: 8px 16px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .reset-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .reset-btn:active {
            transform: scale(0.97);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        /* 예산 시뮬레이션 슬라이더 스타일 */
        .sim-slider-group {
            background: #f8fafc;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.25s ease;
        }
        .sim-slider-group:hover {
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        .sim-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .sim-segment-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sim-segment-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sim-segment-badge.high { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .sim-segment-badge.medium { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .sim-segment-badge.low { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .sim-segment-name { font-weight: 600; font-size: 13px; color: var(--grey-800); }
        .sim-segment-metrics {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .sim-roas-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .sim-roas-badge.high { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .sim-roas-badge.medium { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .sim-roas-badge.low { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .sim-current-budget { font-size: 12px; color: var(--grey-600); font-weight: 500; }
        .sim-slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .sim-slider-label {
            font-size: 11px;
            color: var(--grey-500);
            min-width: 32px;
        }
        .sim-slider-track {
            flex: 1;
            position: relative;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: visible;
        }
        .sim-slider-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #d6beff, #be9ff2 25%, #ab87ea 50%, #8c63d3 75%, #673ab7);
            border-radius: 4px;
            transition: width 0.15s ease;
        }
        .sim-slider {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 100%;
            height: 24px;
            background: transparent;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            z-index: 2;
        }
        .sim-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
            transition: transform 0.15s ease;
        }
        .sim-slider::-webkit-slider-thumb:hover { transform: scale(1.15); }
        .sim-slider::-webkit-slider-thumb:active { cursor: grabbing; transform: scale(1.1); }
        .sim-slider-thumb-value {
            position: absolute;
            top: -26px;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
            transition: left 0.15s ease;
        }
        .sim-slider-thumb-value::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #1e293b;
        }
        .sim-slider-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }
        .sim-result-label { font-size: 12px; color: var(--grey-500); }
        .sim-result-value { font-size: 13px; font-weight: 600; }
        .sim-result-value.positive { color: #10b981; }
        .sim-result-value.negative { color: #ef4444; }
        .sim-result-value small { font-size: 11px; opacity: 0.8; }

        /* 시뮬레이션 결과 카드 */
        .sim-result-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .sim-result-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            gap: 12px;
            transition: all 0.25s ease;
        }
        .sim-result-card:hover {
            border-color: rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .sim-result-card.highlight {
            border-color: rgba(16, 185, 129, 0.25);
            background: linear-gradient(135deg, white, rgba(16, 185, 129, 0.03));
        }
        .sim-result-card.featured {
            border-color: rgba(59, 130, 246, 0.25);
            background: linear-gradient(135deg, white, rgba(59, 130, 246, 0.03));
        }
        .sim-card-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sim-card-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .sim-card-label {
            font-size: 11px;
            color: var(--grey-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .sim-card-values {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .sim-card-before {
            font-size: 12px;
            color: var(--grey-400);
            text-decoration: line-through;
        }
        .sim-card-arrow {
            font-size: 11px;
            color: var(--grey-400);
        }
        .sim-card-after {
            font-size: 15px;
            font-weight: 700;
            color: var(--grey-800);
        }
        .sim-card-change {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
        }
        .sim-card-value-large {
            font-size: 20px;
            font-weight: 800;
            color: #3b82f6;
            line-height: 1;
            margin-top: 4px;
        }
        .sim-card-subtitle {
            font-size: 10px;
            color: var(--grey-500);
        }

        /* 시뮬레이션 결과 테이블 */
        .sim-table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        .sim-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .sim-detail-table th {
            padding: 14px 16px;
            background: #f8fafc;
            color: var(--grey-500);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.08);
        }
        .sim-detail-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            color: var(--grey-600);
            vertical-align: middle;
        }
        .sim-detail-table tr:last-child td {
            border-bottom: none;
        }
        .sim-detail-table tbody tr:not(.sim-total-row):hover td {
            background: rgba(139, 92, 246, 0.04);
        }
        /* 세그먼트 셀 */
        .sim-segment-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--grey-800);
        }
        .sim-segment-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .sim-segment-dot.high { background: #10b981; }
        .sim-segment-dot.medium { background: #f59e0b; }
        .sim-segment-dot.low { background: #ef4444; }
        /* 하이라이트 셀 */
        .sim-highlight-cell {
            font-weight: 600;
        }
        .sim-highlight-cell.positive { color: #10b981; }
        .sim-highlight-cell.negative { color: #ef4444; }
        .sim-highlight-cell.neutral { color: var(--grey-600); }
        /* 추천 뱃지 */
        .sim-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .sim-badge.recommend {
            background: rgba(16, 185, 129, 0.12);
            color: #059669;
        }
        .sim-badge.maintain {
            background: rgba(59, 130, 246, 0.12);
            color: #2563eb;
        }
        .sim-badge.review {
            background: rgba(245, 158, 11, 0.12);
            color: #d97706;
        }
        .sim-badge.warning {
            background: rgba(239, 68, 68, 0.12);
            color: #dc2626;
        }
        /* 총합 행 */
        .sim-total-row {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        }
        .sim-total-row td {
            border-top: 2px solid var(--grey-300) !important;
            border-bottom: none !important;
            padding: 16px !important;
        }
        .sim-total-row:hover td {
            background: transparent !important;
        }
        .sim-total-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 13px;
            color: var(--grey-800);
        }
        .sim-total-icon {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #8b5cf6, #673ab7);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .sim-total-value {
            font-weight: 700;
            font-size: 13px;
            color: var(--grey-800);
        }
        /* 변경된 행 하이라이트 */
        .sim-changed-row {
            background: rgba(255, 251, 235, 0.8);
        }
        .sim-changed-row td:first-child {
            position: relative;
        }
        .sim-changed-row td:first-child::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #f59e0b, #fbbf24);
        }
        /* 통합 인사이트 박스 */
        .sim-insight-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.04), rgba(103, 58, 183, 0.04));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .sim-insight-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        .sim-insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .sim-insight-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(103, 58, 183, 0.15));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b5cf6;
            flex-shrink: 0;
        }
        .sim-insight-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-800);
        }
        .sim-insight-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }
        .sim-insight-status.positive {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .sim-insight-status.warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        .sim-insight-status.negative {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        .sim-insight-status.neutral {
            background: rgba(100, 116, 139, 0.1);
            color: #64748b;
        }
        .sim-insight-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .sim-insight-main {
            background: white;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        .sim-insight-main-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sim-insight-main-text {
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.7;
        }
        .sim-insight-main-text strong {
            color: var(--grey-800);
        }
        .sim-insight-notes {
            background: rgba(245, 158, 11, 0.05);
            border-radius: 10px;
            padding: 16px;
            border: 1px solid rgba(245, 158, 11, 0.12);
        }
        .sim-insight-notes-title {
            font-size: 11px;
            font-weight: 600;
            color: #b45309;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sim-insight-notes-list {
            font-size: 12px;
            color: var(--grey-600);
            line-height: 1.8;
        }
        .sim-insight-notes-list li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 4px;
        }
        .sim-insight-notes-list li::before {
            content: '•';
            color: #f59e0b;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .sim-insight-content {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 1200px) {
            .sim-result-cards { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sim-result-cards { grid-template-columns: 1fr; }
        }

        /* Matrix 카드 툴팁 (마우스 커서 따라가는 스타일) */
        .matrix-tooltip-global {
            position: fixed;
            background: white;
            border: 2px solid #673ab7;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(103, 58, 183, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            z-index: 9999;
            max-width: 320px;
            min-width: 260px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .matrix-tooltip-global.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .matrix-tooltip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .matrix-tooltip-icon {
            font-size: 24px;
        }

        .matrix-tooltip-title {
            font-size: 14px;
            font-weight: 700;
            color: #673ab7;
        }

        .matrix-tooltip-subtitle {
            font-size: 11px;
            color: #9e9e9e;
            margin-top: 2px;
        }

        .matrix-tooltip-content {
            padding: 12px;
            background: linear-gradient(135deg, #ede7f6 0%, #f3e5f5 100%);
            border-radius: 8px;
            border-left: 4px solid #673ab7;
            font-size: 12px;
            font-weight: 500;
            color: #333;
            line-height: 1.6;
        }
    
/* ========== type_dashboard.html CSS ========== */

        /* Embed Mode Styles - 사이드바 숨김 */
        html.embed-mode .sidebar { display: none !important; }
        html.embed-mode .main-content { margin-left: 0 !important; }
        html.embed-mode .mobile-menu-btn { display: none !important; }
        html.embed-mode .sidebar-overlay { display: none !important; }
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-600: #757575;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--grey-900);
            line-height: 1;
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 8px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            color: var(--grey-700);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background-color: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background-color: var(--primary-light);
            color: var(--primary-main);
            font-weight: 500;
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .nav-item-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .nav-item-text {
            font-size: 14px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        /* 접기/펼치기 섹션 스타일 */
        .collapsible-section {
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: var(--paper);
            border-radius: 12px;
            cursor: pointer;
            user-select: none;
            transition: box-shadow 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--grey-200);
        }

        .collapsible-header:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .collapsible-icon {
            font-size: 24px;
        }

        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-light);
            color: var(--primary-main);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .collapsible-toggle:hover {
            background: var(--primary-main);
            color: white;
        }

        .collapsible-toggle-icon {
            transition: transform 0.2s ease;
            transform: rotate(180deg);
        }

        .collapsible-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0 24px;
            transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 5000px;
            opacity: 1;
            padding: 24px;
        }

        /* 인라인 접기/펼치기 토글 (통일된 스타일) */
        .inline-toggle {
            padding: 10px 16px;
            background: var(--primary-light);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--grey-200);
            transition: all 0.2s ease;
            margin-top: 12px;
        }

        .inline-toggle:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: var(--primary-main);
        }

        .inline-toggle:hover .inline-toggle-label,
        .inline-toggle:hover .inline-toggle-action {
            color: white;
        }

        .inline-toggle-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-main);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .inline-toggle-badge {
            padding: 2px 8px;
            background: white;
            color: var(--primary-main);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .inline-toggle-action {
            font-size: 12px;
            color: var(--primary-main);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        /* 경고 스타일 토글 (빨강) */
        .inline-toggle.warning-style {
            background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%);
            border-color: #ffcdd2;
        }

        .inline-toggle.warning-style .inline-toggle-label {
            color: #d32f2f;
        }

        .inline-toggle.warning-style .inline-toggle-badge {
            background: #ffcdd2;
            color: #c62828;
        }

        .inline-toggle.warning-style .inline-toggle-action {
            color: #d32f2f;
        }

        .inline-toggle.warning-style:hover {
            background: #ef5350;
        }

        /* 주의 스타일 토글 (주황) */
        .inline-toggle.caution-style {
            background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%);
            border-color: #ffe0b2;
        }

        .inline-toggle.caution-style .inline-toggle-label {
            color: #e65100;
        }

        .inline-toggle.caution-style .inline-toggle-badge {
            background: #ffe0b2;
            color: #e65100;
        }

        .inline-toggle.caution-style .inline-toggle-action {
            color: #e65100;
        }

        .inline-toggle.caution-style:hover {
            background: #ff9800;
        }

        .inline-toggle-content {
            display: none;
            padding: 12px 0;
            margin-top: 8px;
        }

        .inline-toggle-content.expanded {
            display: block;
        }

        /* 더 보기/접기 버튼 (간소화) */
        .show-more-btn {
            padding: 8px 20px;
            background: var(--grey-100);
            color: var(--grey-700);
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .show-more-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
            border-color: var(--primary-main);
        }

        .show-more-btn.warning-style {
            background: #fff5f5;
            color: #d32f2f;
            border-color: #ffcdd2;
        }

        .show-more-btn.warning-style:hover {
            background: #ffebee;
            border-color: #ef5350;
        }

        .show-more-btn.caution-style {
            background: #fff8f0;
            color: #e65100;
            border-color: #ffe0b2;
        }

        .show-more-btn.caution-style:hover {
            background: #fff3e0;
            border-color: #ff9800;
        }

        /* 뷰 타입 선택 섹션 */
        .view-type-section {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 10px 20px;
            background: var(--grey-100);
            color: var(--grey-700);
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: var(--grey-200);
            border-color: var(--grey-400);
        }

        .view-btn.active {
            background: var(--primary-main);
            color: white;
            border-color: var(--primary-main);
        }

        /* 기간 필터 적용/미적용 탭 스타일 */
        .decision-tool-tab-btn.period-filter-disabled {
            background: #f5f5f5;
            border-color: #bdbdbd;
            border-style: dashed;
        }

        .decision-tool-tab-btn.period-filter-disabled:hover {
            background: #eeeeee;
            border-color: #9e9e9e;
        }

        .decision-tool-tab-btn.period-filter-disabled.active {
            background: #673ab7;
            color: white;
            border-color: #673ab7;
            border-style: solid;
        }

        /* 탭 컨텐츠 스타일 */
        .trend-analysis-tab-content {
            display: none;
        }

        .trend-analysis-tab-content.active {
            display: block;
        }

        /* 메인 컨텐츠 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            max-width: 1600px;
            margin-right: auto;
        }

        .dashboard-header {
            margin-bottom: 32px;
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            font-size: 14px;
            color: var(--grey-600);
        }

        /* 카드 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--grey-200);
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* KPI 그리드 - 업그레이드 디자인 */
        .kpi-wrapper {
            margin-bottom: 0;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .kpi-section {
            margin-bottom: 24px;
        }

        .kpi-grid.kpi-grid-primary {
            margin-bottom: 0;
        }

        .kpi-grid.kpi-grid-secondary {
            display: none;
            margin-top: 16px;
        }

        .kpi-section.show-all .kpi-grid.kpi-grid-secondary {
            display: grid;
        }

        .kpi-card {
            background: var(--paper);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .kpi-card.highlight {
            border-left: 4px solid var(--primary-main);
        }

        .kpi-card.secondary {
            background: var(--grey-50);
        }

        .kpi-card.secondary .kpi-icon {
            background: var(--grey-200);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-title {
            font-size: 13px;
            color: var(--grey-600);
            font-weight: 600;
        }

        .kpi-icon {
            width: 36px;
            height: 36px;
            background: var(--grey-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-main);
            font-size: 16px;
        }

        .kpi-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 8px;
        }

        .kpi-value.highlight-value {
            color: var(--primary-main);
        }

        .kpi-trend {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .kpi-trend.neutral {
            color: var(--grey-500);
        }

        /* KPI 주요/세부 성과 토글 */
        .kpi-view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .kpi-view-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .kpi-view-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .kpi-view-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        /* 의사결정 도구 탭 */
        .decision-tool-tab-content {
            display: none;
        }
        .decision-tool-tab-content.active {
            display: block;
        }

        /* 인사이트 카드 */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .insight-card {
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .insight-card.high {
            background: var(--error-light);
            border-left-color: var(--error-main);
        }

        .insight-card.medium {
            background: var(--warning-light);
            border-left-color: var(--warning-main);
        }

        .insight-card.low {
            background: var(--success-light);
            border-left-color: var(--success-main);
        }

        .insight-card.opportunity {
            background: var(--secondary-light);
            border-left-color: var(--secondary-main);
        }

        .insight-type {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--grey-600);
        }

        .insight-message {
            font-size: 14px;
            color: var(--grey-900);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .insight-value {
            font-size: 12px;
            color: var(--grey-600);
        }

        /* 차트 컨테이너 */
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .chart-container.small {
            height: 300px;
        }

        /* 테이블 스타일 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--grey-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--grey-200);
            background: var(--grey-50);
        }

        .data-table td {
            padding: 12px;
            font-size: 14px;
            color: var(--grey-900);
            border-bottom: 1px solid var(--grey-200);
        }

        .data-table tr:hover {
            background: var(--grey-50);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge.high {
            background: var(--error-light);
            color: var(--error-main);
        }

        .badge.medium {
            background: var(--warning-light);
            color: var(--warning-main);
        }

        .badge.low {
            background: var(--success-light);
            color: var(--success-main);
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .tooltip-content {
            font-size: 12px;
            line-height: 1.6;
        }

        .tooltip-value {
            font-weight: 600;
            color: var(--success-light);
        }

        /* 카드 호버 툴팁 (funnel_dashboard 스타일 참고) */
        .card-hover-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            z-index: 10001;
            max-width: 320px;
            min-width: 240px;
            display: none;
            pointer-events: none;
            border: 2px solid var(--primary-main);
            overflow: hidden;
        }

        .card-hover-tooltip.show {
            display: block;
        }

        .card-tooltip-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--primary-light) 0%, #e8f5e9 100%);
            border-bottom: 1px solid var(--grey-200);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-tooltip-header-icon {
            font-size: 18px;
        }

        .card-tooltip-header-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary-main);
        }

        .card-tooltip-insight {
            padding: 12px 16px;
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
            border-bottom: 1px solid #ffd54f;
        }

        .card-tooltip-insight-label {
            font-size: 10px;
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-tooltip-insight-text {
            font-size: 12px;
            color: var(--grey-800);
            line-height: 1.6;
        }

        .card-tooltip-recommendation {
            padding: 12px 16px;
            background: white;
        }

        .card-tooltip-recommendation-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--primary-main);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-tooltip-recommendation-text {
            font-size: 12px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        /* 호버 가능한 카드 스타일 */
        .hoverable-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hoverable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 그리드 레이아웃 */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        /* 반응형 */
        @media (max-width: 1400px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1400px) {
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .kpi-value {
                font-size: 24px;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 로딩 상태 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--grey-500);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--grey-200);
            border-top-color: var(--primary-main);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 탭 스타일 */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--grey-200);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--grey-600);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary-main);
        }

        .tab.active {
            color: var(--primary-main);
            border-bottom-color: var(--primary-main);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 테이블 정렬 기능 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px !important;
            transition: background 0.2s ease;
        }

        .sortable-header:hover {
            background: var(--grey-100);
        }

        .sort-icon {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }

        .sortable-header:hover .sort-icon {
            opacity: 0.6;
        }

        .sort-icon.active {
            opacity: 1;
        }

        .sort-arrow {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
        }

        .sort-arrow.up {
            border-bottom: 4px solid var(--grey-600);
        }

        .sort-arrow.down {
            border-top: 4px solid var(--grey-600);
        }

        .sort-arrow.active {
            border-bottom-color: var(--primary-main);
            border-top-color: var(--primary-main);
        }
    
/* ========== funnel_dashboard.html CSS ========== */

        /* Embed Mode Styles - 사이드바 숨김 */
        html.embed-mode .sidebar { display: none !important; }
        html.embed-mode .main-content { margin-left: 0 !important; }
        html.embed-mode .mobile-menu-btn { display: none !important; }
        html.embed-mode .sidebar-overlay { display: none !important; }
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-600: #757575;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--grey-700);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-item-text {
            flex: 1;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* 헤더 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--grey-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 카드 공통 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 14px 0 rgba(32, 40, 45, 0.08);
            transition: box-shadow 0.3s ease;
            position: relative;
            z-index: 1;
            overflow: visible;
        }

        .card:hover {
            box-shadow: 0 4px 20px 0 rgba(32, 40, 45, 0.12);
        }

        /* KPI 요약 섹션 - 업그레이드 디자인 */
        .kpi-summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-summary-card {
            background: var(--paper);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .kpi-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .kpi-summary-card:nth-child(1)::before { background: #d6beff; }
        .kpi-summary-card:nth-child(2)::before { background: #be9ff2; }
        .kpi-summary-card:nth-child(3)::before { background: #ab87ea; }
        .kpi-summary-card:nth-child(4)::before { background: #8c63d3; }
        .kpi-summary-card:nth-child(5)::before { background: #673ab7; }

        .kpi-summary-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--grey-600);
            margin-bottom: 12px;
        }

        .kpi-summary-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--grey-900);
            margin-bottom: 8px;
        }

        .kpi-summary-unit {
            font-size: 13px;
            color: var(--grey-500);
        }

        .kpi-summary-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .kpi-summary-badge.positive {
            background: var(--success-light);
            color: var(--success-main);
        }

        .kpi-summary-badge.negative {
            background: var(--error-light);
            color: var(--error-main);
        }

        /* 차트 섹션 */
        .chart-section {
            margin-bottom: 24px;
            padding: 24px;
            overflow: visible;
        }

        .chart-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--secondary-main);
            border-radius: 2px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            overflow: visible;
        }

        .chart-container-small {
            position: relative;
            height: 300px;
            overflow: visible;
        }

        /* 뷰 타입 버튼 */
        .view-type-section {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .view-btn {
            padding: 10px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .view-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .view-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        /* 탭 컨텐츠 스타일 */
        .decision-tool-tab-content,
        .channel-analysis-tab-content,
        .customer-analysis-tab-content {
            display: none;
        }

        .decision-tool-tab-content.active,
        .channel-analysis-tab-content.active,
        .customer-analysis-tab-content.active {
            display: block;
        }

        /* 그리드 레이아웃 */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        /* 인사이트 섹션 */
        .insight-section {
            padding: 24px;
            margin-bottom: 24px;
        }

        .insight-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--warning-main);
            border-radius: 2px;
        }

        .insight-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .insight-card {
            padding: 18px 20px;
            background: var(--grey-50);
            border-radius: 12px;
            border-left: 4px solid var(--primary-main);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .insight-card.positive {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-left-color: var(--success-main);
        }

        .insight-card.negative {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border-left-color: var(--error-main);
        }

        .insight-card.neutral {
            background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%);
            border-left-color: var(--warning-main);
        }

        .insight-card.opportunity {
            background: linear-gradient(135deg, #e3f2fd 0%, #e1f5fe 100%);
            border-left-color: var(--secondary-main);
        }

        /* 인사이트 카드 헤더 */
        .insight-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .insight-icon-box {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .insight-card.positive .insight-icon-box {
            background: rgba(0, 200, 83, 0.15);
        }

        .insight-card.negative .insight-icon-box {
            background: rgba(255, 23, 68, 0.15);
        }

        .insight-card.neutral .insight-icon-box {
            background: rgba(255, 171, 0, 0.15);
        }

        .insight-card.opportunity .insight-icon-box {
            background: rgba(33, 150, 243, 0.15);
        }

        .insight-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-card.positive .insight-label { color: #2e7d32; }
        .insight-card.negative .insight-label { color: #c62828; }
        .insight-card.neutral .insight-label { color: #e65100; }
        .insight-card.opportunity .insight-label { color: #1565c0; }

        .insight-urgency {
            margin-left: auto;
            font-size: 10px;
            padding: 3px 8px;
            color: white;
            border-radius: 10px;
            font-weight: 600;
        }

        /* 인사이트 카드 본문 */
        .insight-message {
            font-size: 14px;
            font-weight: 500;
            color: var(--grey-900);
            line-height: 1.6;
            margin-bottom: 12px;
            flex: 1;
        }

        /* 인사이트 카드 상세정보 */
        .insight-detail-box {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .insight-detail-title {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .insight-detail-item {
            font-size: 12px;
            color: #333;
            line-height: 1.6;
            padding-left: 12px;
            position: relative;
        }

        .insight-detail-item::before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--grey-500);
        }

        /* 인사이트 카드 액션 */
        .insight-action-box {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid #ab47bc;
        }

        .insight-action-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .insight-action-title {
            font-size: 11px;
            font-weight: 600;
            color: #7b1fa2;
        }

        .insight-action-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .insight-action-badge.scale_up,
        .insight-action-badge.opportunity {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .insight-action-badge.primary {
            background: #fff3e0;
            color: #e65100;
        }

        .insight-action-badge.maintain {
            background: #e3f2fd;
            color: #1565c0;
        }

        .insight-action-text {
            font-size: 12px;
            color: #333;
            line-height: 1.5;
        }

        .insight-action-secondary {
            font-size: 11px;
            color: #5e35b1;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #d1c4e9;
            line-height: 1.4;
        }

        .insight-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-title svg {
            width: 18px;
            height: 18px;
        }

        .insight-text {
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        /* 데이터 테이블 */
        .table-section {
            overflow: visible;
            position: relative;
        }

        .table-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--grey-200);
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--success-main);
            border-radius: 2px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: relative;
            z-index: 50;
        }

        th, td {
            padding: 14px 16px;
            text-align: right;
            font-size: 14px;
        }

        th {
            background: var(--grey-50);
            font-weight: 600;
            color: var(--grey-700);
            border-bottom: 2px solid var(--grey-200);
            white-space: nowrap;
            overflow: visible;
            position: relative;
        }

        td {
            border-bottom: 1px solid var(--grey-100);
            color: var(--grey-900);
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--paper);
            font-weight: 500;
        }

        th:first-child {
            background: var(--grey-50);
            z-index: 51;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--grey-50);
        }

        tbody tr:hover td:first-child {
            background: var(--grey-50);
        }

        /* 접기/펼치기 스타일 */
        .collapsible-section {
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 20px 24px;
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .collapsible-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-900);
        }

        .collapsible-icon {
            font-size: 20px;
        }

        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-light);
            color: var(--primary-main);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .collapsible-toggle:hover {
            background: var(--primary-main);
            color: white;
        }

        .collapsible-toggle-icon {
            transition: transform 0.3s ease;
            transform: rotate(180deg);
        }

        .collapsible-toggle-icon.collapsed {
            transform: rotate(0deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .collapsible-content.expanded {
            max-height: 10000px;
            opacity: 1;
            padding-top: 16px;
            overflow: visible;
        }

        /* 차트 인사이트 툴팁 */
        .chart-insight-tooltip {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 0;
            display: none;
            z-index: 99999;
            max-width: 320px;
            min-width: 280px;
            pointer-events: none;
        }

        .chart-insight-tooltip.show {
            display: block;
        }

        .tooltip-insight-section {
            padding: 16px;
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #ffd54f;
        }

        .tooltip-insight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #f57c00;
            margin-bottom: 8px;
        }

        .tooltip-insight-text {
            font-size: 13px;
            color: var(--grey-800);
            line-height: 1.5;
            margin: 0;
        }

        .tooltip-recommendation-section {
            padding: 16px;
            background: white;
            border-radius: 0 0 12px 12px;
        }

        .tooltip-recommendation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--primary-main);
            margin-bottom: 8px;
        }

        .tooltip-recommendation-text {
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.5;
            margin: 0;
        }

        /* 반응형 */
        @media (max-width: 1400px) {
            .kpi-summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .insight-content {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }
            .kpi-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-container {
                height: 300px;
            }
            .insight-content {
                grid-template-columns: 1fr;
            }
        }

        /* 퍼널 비율 바 */
        .funnel-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .funnel-bar-fill {
            height: 8px;
            background: linear-gradient(90deg, var(--primary-main), var(--success-main));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .funnel-bar-label {
            font-size: 11px;
            color: var(--grey-600);
            min-width: 40px;
        }

        /* D3 Funnel Styles */
        #d3FunnelChart {
            width: 100%;
            height: 650px;
            position: relative;
            overflow: visible;
        }

        .funnel-stage {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .funnel-stage:hover {
            opacity: 1;
            filter: brightness(1.1);
        }

        .funnel-stage path {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
            transition: filter 0.3s ease;
        }

        .funnel-stage:hover path {
            filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.25));
        }

        .funnel-stage-label {
            font-size: 16px;
            font-weight: 600;
            fill: var(--grey-900);
            pointer-events: none;
        }

        .funnel-stage-value {
            font-size: 14px;
            font-weight: 500;
            fill: var(--grey-700);
            pointer-events: none;
        }

        .funnel-stage-conversion {
            font-size: 12px;
            fill: var(--grey-600);
            pointer-events: none;
        }

        .funnel-tooltip {
            position: fixed;
            background: white;
            border: 2px solid var(--primary-main);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(103, 58, 183, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            z-index: 9999;
            max-width: 380px;
            min-width: 300px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .funnel-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .funnel-tooltip::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -10px;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid var(--primary-main);
        }

        .funnel-tooltip-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-main);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .funnel-tooltip-title::before {
            content: '📊';
            font-size: 20px;
        }

        .funnel-tooltip-metric {
            font-size: 14px;
            color: var(--grey-700);
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            padding: 8px;
            background: var(--grey-50);
            border-radius: 6px;
        }

        .funnel-tooltip-metric-label {
            font-weight: 600;
            color: var(--grey-700);
        }

        .funnel-tooltip-metric-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-main);
        }

        .funnel-tooltip-insight {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%);
            border-radius: 8px;
            border-left: 4px solid var(--secondary-main);
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        .funnel-tooltip-insight::before {
            content: '💡 ';
            font-size: 16px;
        }

        .funnel-tooltip-recommendation {
            margin-top: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--warning-light) 0%, #fff9e6 100%);
            border-radius: 8px;
            border-left: 4px solid var(--warning-main);
            font-size: 13px;
            font-weight: 500;
            color: var(--grey-900);
            line-height: 1.6;
        }

        .funnel-tooltip-recommendation::before {
            content: '🎯 추천: ';
            font-weight: 700;
            color: var(--warning-main);
        }

        /* 필터 섹션 */
        .filter-section {
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .filter-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
            flex: 1;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--grey-700);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
        }

        .filter-group select:hover,
        .filter-group input:hover {
            border-color: var(--primary-main);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px rgba(103, 58, 183, 0.1);
        }

        .date-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-range input[type="date"] {
            padding: 10px 14px;
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
            flex: 1;
        }

        .date-range input[type="date"]:hover {
            border-color: var(--primary-main);
        }

        .date-range input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px rgba(103, 58, 183, 0.1);
        }

        .date-range span {
            color: var(--grey-500);
            font-weight: 500;
        }

        /* 퍼널 차트 중앙 정렬 */
        #d3FunnelChart,
        #d3FunnelChartLeft,
        #d3FunnelChartRight {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #d3FunnelChart svg,
        #d3FunnelChartLeft svg,
        #d3FunnelChartRight svg {
            display: block;
            margin: 0 auto;
        }

        /* 테이블 정렬 기능 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px !important;
            transition: background 0.2s ease;
            z-index: 100;
        }

        .sortable-header:hover {
            background: var(--grey-100);
        }

        .sort-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0.3;
            transition: opacity 0.2s ease;
        }

        .sortable-header:hover .sort-icon {
            opacity: 0.6;
        }

        .sort-icon.active {
            opacity: 1;
        }

        .sort-arrow {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }

        .sort-arrow.up {
            border-bottom: 5px solid var(--grey-700);
        }

        .sort-arrow.down {
            border-top: 5px solid var(--grey-700);
        }

        .sort-arrow.active {
            border-bottom-color: var(--primary-main);
            border-top-color: var(--primary-main);
        }

        /* 정렬 툴팁 */
        .sort-tooltip {
            position: fixed;
            transform: translate(-50%, -100%);
            background: var(--grey-900);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 9999;
            margin-top: -8px;
        }

        .sort-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--grey-900);
        }

        .sortable-header:hover .sort-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* 테이블 셀 색상 스케일 */
        .cell-value {
            position: relative;
            font-weight: 500;
        }

        .cell-bg {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            opacity: 0.15;
            transition: opacity 0.3s ease;
            border-radius: 4px;
        }

        tr:hover .cell-bg {
            opacity: 0.25;
        }

        /* 색상 스케일 - 각 메트릭별 */
        .scale-acquisition { background: linear-gradient(90deg, transparent, #673ab7); }
        .scale-activation { background: linear-gradient(90deg, transparent, #2196f3); }
        .scale-consideration { background: linear-gradient(90deg, transparent, #ff9800); }
        .scale-conversion { background: linear-gradient(90deg, transparent, #4caf50); }
        .scale-purchase { background: linear-gradient(90deg, transparent, #00c853); }
        .scale-revenue { background: linear-gradient(90deg, transparent, #f44336); }
        .scale-cvr { background: linear-gradient(90deg, transparent, #9c27b0); }

        /* 테이블 셀 패딩 조정 */
        td.has-bg {
            position: relative;
            padding: 14px 16px;
        }

        td.has-bg > span {
            position: relative;
            z-index: 1;
        }

        /* 더 보기/접기 기능 */
        .hidden-row {
            display: none;
        }

        .show-more-container {
            padding: 16px 24px;
            text-align: center;
        }

        .show-more-btn {
            padding: 10px 32px;
            background: var(--grey-100);
            color: var(--grey-700);
            border: 1px solid var(--grey-300);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .show-more-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
            border-color: var(--primary-main);
        }
    
/* ========== Qna.html CSS ========== */

        /* Embed Mode Styles - 사이드바 숨김 */
        html.embed-mode .sidebar { display: none !important; }
        html.embed-mode .main-content { margin-left: 0 !important; }
        html.embed-mode .mobile-menu-btn { display: none !important; }
        html.embed-mode .sidebar-overlay { display: none !important; }
        :root {
            /* Berry Theme Colors */
            --primary-main: #673ab7;
            --primary-light: #ede7f6;
            --primary-dark: #5e35b1;
            --secondary-main: #2196f3;
            --secondary-light: #e3f2fd;
            --success-main: #00c853;
            --success-light: #b9f6ca;
            --warning-main: #ffab00;
            --warning-light: #fff8e1;
            --error-main: #ff1744;
            --error-light: #ffeaea;
            --grey-50: #fafafa;
            --grey-100: #f5f5f5;
            --grey-200: #eeeeee;
            --grey-300: #e0e0e0;
            --grey-500: #9e9e9e;
            --grey-600: #757575;
            --grey-700: #616161;
            --grey-900: #212121;
            --paper: #ffffff;
            --background: #f8fafc;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--grey-900);
            line-height: 1.5;
        }

        /* 레이아웃 구조 */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--grey-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--grey-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--grey-900);
        }

        .sidebar-logo-subtitle {
            font-size: 11px;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Simplebar 스타일 래퍼 */
        .simplebar-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .simplebar-content-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb {
            background: var(--grey-300);
            border-radius: 3px;
        }

        .simplebar-content-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--grey-500);
        }

        .sidebar-content {
            padding: 16px 12px;
        }

        /* 네비게이션 그룹 */
        .nav-group {
            margin-bottom: 16px;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--grey-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 16px;
            margin-bottom: 4px;
        }

        /* 네비게이션 아이템 */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--grey-700);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--grey-100);
            color: var(--primary-main);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-item-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .nav-item-text {
            flex: 1;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 24px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 헤더 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--grey-900);
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: var(--grey-500);
            margin-top: 4px;
        }

        /* 카드 공통 스타일 */
        .card {
            background: var(--paper);
            border-radius: 12px;
            box-shadow: 0 2px 14px 0 rgba(32, 40, 45, 0.08);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px 0 rgba(32, 40, 45, 0.12);
        }

        /* 섹션 헤더 */
        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: var(--grey-900);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary-main);
            border-radius: 2px;
        }

        /* FAQ 섹션 */
        .faq-section {
            margin-bottom: 32px;
        }

        .faq-category {
            margin-bottom: 24px;
        }

        .faq-category-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-main);
            margin-bottom: 16px;
            padding-left: 12px;
            border-left: 3px solid var(--primary-main);
        }

        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .faq-item {
            background: var(--paper);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

        .faq-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .faq-question {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--grey-900);
            text-align: left;
            font-family: inherit;
            transition: background 0.2s ease;
        }

        .faq-question:hover {
            background: var(--grey-50);
        }

        .faq-icon {
            font-size: 12px;
            color: var(--grey-500);
            transition: transform 0.3s ease;
        }

        .faq-item.open .faq-icon {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .faq-item.open .faq-answer {
            max-height: 500px;
        }

        .faq-answer-content {
            padding: 0 20px 20px 20px;
            font-size: 14px;
            line-height: 1.8;
            color: var(--grey-700);
        }

        .faq-answer-content strong {
            color: var(--grey-900);
        }

        /* 문의하기 섹션 */
        .contact-section {
            padding: 32px;
        }

        .contact-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--grey-700);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-label .required {
            color: var(--error-main);
            font-size: 12px;
        }

        .form-input {
            padding: 14px 16px;
            border: 1px solid var(--grey-300);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            background: var(--paper);
            color: var(--grey-900);
            transition: all 0.2s ease;
        }

        .form-input:hover {
            border-color: var(--primary-main);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--grey-500);
        }

        .form-textarea {
            min-height: 180px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .submit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--primary-main) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(103, 58, 183, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(103, 58, 183, 0.5);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* 도움말 박스 */
        .help-box {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            background: var(--primary-light);
            border-radius: 10px;
            margin-top: 24px;
        }

        .help-box-icon {
            font-size: 24px;
        }

        .help-box-content {
            flex: 1;
        }

        .help-box-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }

        .help-box-text {
            font-size: 13px;
            color: var(--grey-700);
            line-height: 1.6;
        }

        .help-box-text a {
            color: var(--primary-main);
            font-weight: 500;
            text-decoration: none;
        }

        .help-box-text a:hover {
            text-decoration: underline;
        }

        /* 성공 메시지 */
        .success-message {
            display: none;
            padding: 20px;
            background: var(--success-light);
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }

        .success-message.show {
            display: block;
        }

        .success-message-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .success-message-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--success-main);
            margin-bottom: 8px;
        }

        .success-message-text {
            font-size: 14px;
            color: var(--grey-700);
        }

        /* 2열 레이아웃 */
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        /* 반응형 */
        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .two-column-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .contact-section {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }
        }

        /* 탭 네비게이션 */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: var(--paper);
            color: var(--grey-700);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .tab-btn:hover {
            background: var(--primary-light);
            color: var(--primary-main);
        }

        .tab-btn.active {
            background: var(--primary-main);
            color: white;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 검색 필터 */
        .search-box {
            position: relative;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border: 1px solid var(--grey-300);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            background: var(--paper);
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-main);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--grey-500);
        }
    
    </style>
</head>
<body>
    <div class="app-wrapper">
        
        <!-- 통합 사이드바 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#dashboard" class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="sidebar-logo-text">Analytics</div>
                        <div class="sidebar-logo-subtitle">Dashboard</div>
                    </div>
                </a>
            </div>

            <div class="simplebar-content-wrapper">
                <div class="sidebar-content">
                    <!-- 대시보드 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">대시보드</div>
                        <a href="#dashboard" class="nav-item" data-page="dashboard">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">광고 성과 대시보드</span>
                        </a>
                        <a href="#funnel" class="nav-item" data-page="funnel">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">퍼널 대시보드</span>
                        </a>
                    </div>

                    <!-- 분석 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">분석</div>
                        <a href="#creative" class="nav-item" data-page="creative">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">소재별 대시보드</span>
                        </a>
                        <a href="#timeseries" class="nav-item" data-page="timeseries">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M23 8c0 1.1-.9 2-2 2-.18 0-.35-.02-.51-.07l-3.56 3.55c.05.16.07.34.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.18.02-.36.07-.52l-2.55-2.55c-.16.05-.34.07-.52.07s-.36-.02-.52-.07l-4.55 4.56c.05.16.07.33.07.51 0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2c.18 0 .35.02.51.07l4.56-4.55C8.02 9.36 8 9.18 8 9c0-1.1.9-2 2-2s2 .9 2 2c0 .18-.02.36-.07.52l2.55 2.55c.16-.05.34-.07.52-.07s.36.02.52.07l3.55-3.56C19.02 8.35 19 8.18 19 8c0-1.1.9-2 2-2s2 .9 2 2z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">시계열 데이터 분석</span>
                        </a>
                        <a href="#type" class="nav-item" data-page="type">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H8V4h12v12z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">채널별 비교</span>
                        </a>
                    </div>

                    <!-- 도움말 그룹 -->
                    <div class="nav-group">
                        <div class="nav-group-title">도움말</div>
                        <a href="#qna" class="nav-item" data-page="qna">
                            <div class="nav-item-icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                                </svg>
                            </div>
                            <span class="nav-item-text">FAQ&문의하기</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>


        <!-- 메인 컨텐츠 영역 -->
        <main class="main-content">

            <!-- ========== 광고 성과 대시보드 (marketing_dashboard_v3.html) ========== -->
            <div class="page-section active" data-page="dashboard">
                
            <div class="container">
                <!-- 헤더 -->
                <div class="header">
                    <div>
                        <h1>마케팅 성과 대시보드</h1>
                        <div class="header-subtitle">광고 캠페인 성과 분석 및 KPI 모니터링</div>
                    </div>
                </div>

                <!-- 필터 설정 (접기/펼치기) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" id="filterCollapsibleHeader">
                        <div class="collapsible-title">필터 설정 <span class="collapsible-guide">* 펼쳐서 세부 성과를 필터링할 수 있어요</span></div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content" id="filterCollapsibleContent">
                        <!-- 기간 선택 + 기본 필터 -->
                        <div class="filter-section card" style="margin-bottom: 16px;">
                            <div class="filter-section-header">
                                <div class="filter-header">기간 및 기본 필터</div>
                                <button class="reset-btn" onclick="resetBasicFilters()">초기화</button>
                            </div>
                            <div class="filter-inline-container">
                                <!-- 기간 선택 -->
                                <div class="filter-date-section">
                                    <div class="filter-label">기간 선택</div>
                                    <div class="date-range">
                                        <input type="date" id="startDate">
                                        <span>~</span>
                                        <input type="date" id="endDate">
                                    </div>
                                </div>
                                <!-- 기본 필터 -->
                                <div class="filter-setting-section">
                                    <div class="filter-label">기본 필터</div>
                                    <div class="filter-items">
                                        <div class="filter-group">
                                            <label>유형구분</label>
                                            <select id="filterType">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label>브랜드명</label>
                                            <select id="filterBrand">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label>상품명</label>
                                            <select id="filterProduct">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label>프로모션</label>
                                            <select id="filterPromotion">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 세부 필터 -->
                        <div class="filter-section card">
                            <div class="filter-section-header">
                                <div class="filter-header">세부 필터</div>
                                <button class="reset-btn" onclick="resetDetailFilters()">초기화</button>
                            </div>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label>캠페인</label>
                                    <select id="filterCampaign">
                                        <option value="">전체</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>세트이름</label>
                                    <select id="filterSetName">
                                        <option value="">전체</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 통합 KPI 섹션 -->
                <div class="kpi-unified-section">
                    <!-- 기간 탭 + 주요/세부 성과 토글 (같은 행) -->
                    <div class="kpi-controls-row">
                        <!-- 기간 탭 -->
                        <div class="kpi-tab-section">
                            <button class="kpi-tab active" data-kpi-tab="total">전체</button>
                            <button class="kpi-tab" data-kpi-tab="monthly">월별</button>
                            <button class="kpi-tab" data-kpi-tab="weekly">주별</button>
                            <button class="kpi-tab" data-kpi-tab="daily">일별</button>
                        </div>
                        <!-- 주요/세부 성과 토글 -->
                        <div class="kpi-view-toggle">
                            <button class="kpi-view-btn active" data-kpi-view="primary">주요 성과</button>
                            <button class="kpi-view-btn" data-kpi-view="all">세부 성과</button>
                        </div>
                    </div>

                    <!-- 전체 탭 콘텐츠 (요약 데이터) -->
                    <div class="kpi-tab-content active" id="kpiTabTotal">
                        <div class="kpi-section">
                            <section class="kpi-grid kpi-grid-primary">
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">총 비용</span>
                                        <div class="kpi-icon">💰</div>
                                    </div>
                                    <div class="kpi-value" id="summaryTotalCost">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>전체 기간 합계</span>
                                    </div>
                                </div>
                                <div class="kpi-card highlight">
                                    <div class="kpi-header">
                                        <span class="kpi-title">ROAS</span>
                                        <div class="kpi-icon">📈</div>
                                    </div>
                                    <div class="kpi-value highlight-value" id="summaryTotalROAS">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>광고 수익률</span>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">CPA</span>
                                        <div class="kpi-icon">🎯</div>
                                    </div>
                                    <div class="kpi-value" id="summaryAvgCPA">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>전환당 비용</span>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">CPC</span>
                                        <div class="kpi-icon">🖱️</div>
                                    </div>
                                    <div class="kpi-value" id="summaryAvgCPC">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>클릭당 비용</span>
                                    </div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">CPM</span>
                                        <div class="kpi-icon">👁️</div>
                                    </div>
                                    <div class="kpi-value" id="summaryAvgCPM">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>노출당 비용</span>
                                    </div>
                                </div>
                            </section>
                            <section class="kpi-grid kpi-grid-secondary">
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">총 노출</span>
                                        <div class="kpi-icon">👀</div>
                                    </div>
                                    <div class="kpi-value" id="summaryTotalImpressions">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>회</span>
                                    </div>
                                </div>
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">총 클릭</span>
                                        <div class="kpi-icon">👆</div>
                                    </div>
                                    <div class="kpi-value" id="summaryTotalClicks">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>회</span>
                                    </div>
                                </div>
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">총 전환수</span>
                                        <div class="kpi-icon">✅</div>
                                    </div>
                                    <div class="kpi-value" id="summaryTotalConversions">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>건</span>
                                    </div>
                                </div>
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">총 전환값</span>
                                        <div class="kpi-icon">💵</div>
                                    </div>
                                    <div class="kpi-value" id="summaryTotalConversionValue">-</div>
                                    <div class="kpi-trend neutral">
                                        <span>원</span>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>

                    <!-- 기간별 탭 콘텐츠 (일별/주별/월별 - 트렌드 포함) -->
                    <div class="kpi-tab-content" id="kpiTabPeriod">
                        <div class="kpi-section">
                            <section class="kpi-grid kpi-grid-primary">
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">비용</span>
                                        <div class="kpi-icon">💰</div>
                                    </div>
                                    <div class="kpi-value" id="totalCost">-</div>
                                    <div class="kpi-trend" id="trendCost">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendCostPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendCostDetail"></div>
                                </div>
                                <div class="kpi-card highlight">
                                    <div class="kpi-header">
                                        <span class="kpi-title">ROAS</span>
                                        <div class="kpi-icon">📈</div>
                                    </div>
                                    <div class="kpi-value highlight-value" id="totalROAS">-</div>
                                    <div class="kpi-trend" id="trendROAS">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendROASPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendROASDetail"></div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">CPA</span>
                                        <div class="kpi-icon">🎯</div>
                                    </div>
                                    <div class="kpi-value" id="avgCPA">-</div>
                                    <div class="kpi-trend" id="trendCPA">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendCPAPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendCPADetail"></div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">CPC</span>
                                        <div class="kpi-icon">🖱️</div>
                                    </div>
                                    <div class="kpi-value" id="avgCPC">-</div>
                                    <div class="kpi-trend" id="trendCPC">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendCPCPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendCPCDetail"></div>
                                </div>
                                <div class="kpi-card">
                                    <div class="kpi-header">
                                        <span class="kpi-title">CPM</span>
                                        <div class="kpi-icon">👁️</div>
                                    </div>
                                    <div class="kpi-value" id="avgCPM">-</div>
                                    <div class="kpi-trend" id="trendCPM">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendCPMPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendCPMDetail"></div>
                                </div>
                            </section>
                            <section class="kpi-grid kpi-grid-secondary">
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">노출</span>
                                        <div class="kpi-icon">👀</div>
                                    </div>
                                    <div class="kpi-value" id="totalImpressions">-</div>
                                    <div class="kpi-trend" id="trendImpressions">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendImpressionsPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendImpressionsDetail"></div>
                                </div>
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">클릭</span>
                                        <div class="kpi-icon">👆</div>
                                    </div>
                                    <div class="kpi-value" id="totalClicks">-</div>
                                    <div class="kpi-trend" id="trendClicks">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendClicksPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendClicksDetail"></div>
                                </div>
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">전환수</span>
                                        <div class="kpi-icon">✅</div>
                                    </div>
                                    <div class="kpi-value" id="totalConversions">-</div>
                                    <div class="kpi-trend" id="trendConversions">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendConversionsPP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendConversionsDetail"></div>
                                </div>
                                <div class="kpi-card secondary">
                                    <div class="kpi-header">
                                        <span class="kpi-title">전환값</span>
                                        <div class="kpi-icon">💵</div>
                                    </div>
                                    <div class="kpi-value" id="totalConversionValue">-</div>
                                    <div class="kpi-trend" id="trendConversionValue">
                                        <span class="trend-value">-</span>
                                        <span class="trend-pp" id="trendConversionValuePP"></span>
                                    </div>
                                    <div class="trend-detail" id="trendConversionValueDetail"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- 차트 섹션 -->
                <div class="chart-section card">
                    <div class="chart-section-header">
                        <div class="chart-header">성과 지표 추이</div>
                        <button class="data-label-toggle" id="dataLabelToggle">
                            <span class="toggle-checkbox">☐</span>
                            <span>데이터 라벨</span>
                        </button>
                    </div>
                    <div class="chart-controls">
                        <div class="chart-toggle-group" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="data-label-toggle active" data-chart-toggle="chartCost">
                                <span class="toggle-checkbox">✓</span>
                                <span>비용</span>
                            </button>
                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPM">
                                <span class="toggle-checkbox">☐</span>
                                <span>CPM</span>
                            </button>
                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPC">
                                <span class="toggle-checkbox">☐</span>
                                <span>CPC</span>
                            </button>
                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPA">
                                <span class="toggle-checkbox">☐</span>
                                <span>CPA</span>
                            </button>
                            <button type="button" class="data-label-toggle active" data-chart-toggle="chartROAS">
                                <span class="toggle-checkbox">✓</span>
                                <span>ROAS</span>
                            </button>
                        </div>
                        <!-- 숨겨진 체크박스 (기존 기능 유지용) -->
                        <div style="display: none;">
                            <input type="checkbox" id="chartCost" checked>
                            <input type="checkbox" id="chartCPM">
                            <input type="checkbox" id="chartCPC">
                            <input type="checkbox" id="chartCPA">
                            <input type="checkbox" id="chartROAS" checked>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <!-- 데이터 테이블 -->
                <div class="table-section card">
                    <div class="table-header">상세 데이터</div>
                    <div class="table-container">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>기간</th>
                                    <th>비용</th>
                                    <th>노출</th>
                                    <th>CPM</th>
                                    <th>클릭</th>
                                    <th>CPC</th>
                                    <th>전환수</th>
                                    <th>CPA</th>
                                    <th>전환값</th>
                                    <th>ROAS</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="10" class="loading">데이터를 불러오는 중...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="show-more-container" id="showMoreContainer" style="display: none;">
                        <button class="show-more-btn" id="showMoreBtn">더 보기 (<span id="hiddenCount">0</span>개)</button>
                    </div>
                    <div class="show-more-container" id="collapseContainer" style="display: none;">
                        <button class="show-more-btn" id="collapseBtn">접기</button>
                    </div>
                </div>
            </div>
        
            </div>

            <!-- ========== 소재별 대시보드 (creative_analysis.html) ========== -->
            <div class="page-section" data-page="creative">
                
            <div class="container">
                <!-- 헤더 -->
                <div class="header">
                    <div>
                        <h1>광고 소재별 분석</h1>
                        <div class="header-subtitle">광고 소재(이미지/영상)별 성과 분석</div>
                    </div>
                </div>

                <!-- 필터 설정 (접기/펼치기) -->
                <div class="collapsible-section">
                    <div class="collapsible-header" id="filterCollapsibleHeader">
                        <div class="collapsible-title">필터 설정 <span class="collapsible-guide">* 펼쳐서 세부 성과를 필터링할 수 있어요</span></div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content" id="filterCollapsibleContent">
                        <!-- 기간 선택 + 기본 필터 -->
                        <div class="filter-section card" style="margin-bottom: 16px;">
                            <div class="filter-section-header">
                                <div class="filter-header">기간 및 기본 필터</div>
                                <button class="reset-btn" onclick="resetBasicFilters()">초기화</button>
                            </div>
                            <div class="filter-inline-container">
                                <!-- 기간 선택 -->
                                <div class="filter-date-section">
                                    <div class="filter-label">기간 선택</div>
                                    <div class="date-range">
                                        <input type="date" id="startDate">
                                        <span>~</span>
                                        <input type="date" id="endDate">
                                    </div>
                                </div>
                                <!-- 기본 필터 -->
                                <div class="filter-setting-section">
                                    <div class="filter-label">기본 필터</div>
                                    <div class="filter-items">
                                        <div class="filter-group">
                                            <label>유형구분</label>
                                            <select id="filterType">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label>브랜드명</label>
                                            <select id="filterBrand">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label>상품명</label>
                                            <select id="filterProduct">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                        <div class="filter-group">
                                            <label>프로모션</label>
                                            <select id="filterPromotion">
                                                <option value="">전체</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 세부 필터 -->
                        <div class="filter-section card">
                            <div class="filter-section-header">
                                <div class="filter-header">세부 필터</div>
                                <button class="reset-btn" onclick="resetDetailFilters()">초기화</button>
                            </div>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label>캠페인</label>
                                    <select id="filterCampaign">
                                        <option value="">전체</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>광고세트</label>
                                    <select id="filterAdSet">
                                        <option value="">전체</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label>소재 검색</label>
                                    <input type="text" id="searchText" placeholder="소재이름 검색..." style="flex: 1;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI 기준 필터 + 정렬 설정 통합 -->
                <div class="filter-section card">
                    <div class="unified-filter-container">
                        <!-- 왼쪽: KPI 기준 필터 -->
                        <div class="unified-filter-left">
                            <div class="unified-filter-title">
                                KPI 기준 필터
                                <button type="button" id="kpiFilterToggle" class="kpi-filter-toggle" style="margin-left: 12px; width: auto; padding: 4px 10px; font-size: 11px;">
                                    <span class="toggle-status">OFF</span>
                                </button>
                            </div>
                            <!-- 4분류 효율 필터 칩 -->
                            <div class="efficiency-chip-section" style="margin-bottom: 16px;">
                                <div class="chip-container">
                                    <button type="button" class="preset-chip" data-filter="high_efficiency"
                                            data-tooltip-title="고효율 소재"
                                            data-tooltip-icon="🏆"
                                            data-tooltip-type="high-efficiency"
                                            data-tooltip-criteria="효율 점수 상위 20%에 해당하는 소재입니다.&lt;br&gt;• ROAS, CPA, CPC, CPM 순위 종합&lt;br&gt;• 비용 대비 신뢰도 가중 적용"
                                            data-tooltip-action="예산 확대 검토"
                                            data-tooltip-action-type="positive"
                                            data-tooltip-action-detail="검증된 고성과 소재입니다. 예산을 증액하면 매출 상승이 기대됩니다.">
                                        <span class="chip-icon">🏆</span>고효율 소재
                                    </button>
                                    <button type="button" class="preset-chip" data-filter="potential"
                                            data-tooltip-title="가능성 있는 소재"
                                            data-tooltip-icon="💎"
                                            data-tooltip-type="potential"
                                            data-tooltip-criteria="중간 60% 중 신뢰도↓ 성과↑ 소재입니다.&lt;br&gt;• 비용이 적지만 기대 ROAS 이상&lt;br&gt;• 신뢰도 &lt; 50% (약 39만원 미만)"
                                            data-tooltip-action="테스트 확대 추천"
                                            data-tooltip-action-type="info"
                                            data-tooltip-action-detail="데이터가 부족하지만 성과가 좋습니다. 예산을 늘려 검증해보세요.">
                                        <span class="chip-icon">💎</span>가능성 있는 소재
                                    </button>
                                    <button type="button" class="preset-chip" data-filter="needs_attention"
                                            data-tooltip-title="주의 필요 소재"
                                            data-tooltip-icon="🔍"
                                            data-tooltip-type="needs-attention"
                                            data-tooltip-criteria="중간 60% 중 판단 유보 소재입니다.&lt;br&gt;• 신뢰도↑ 또는 성과↓&lt;br&gt;• 추가 데이터 수집 필요"
                                            data-tooltip-action="추가 관찰 필요"
                                            data-tooltip-action-type="warning"
                                            data-tooltip-action-detail="현재 상태로는 판단이 어렵습니다. 추이를 지켜보며 결정하세요.">
                                        <span class="chip-icon">🔍</span>주의 필요 소재
                                    </button>
                                    <button type="button" class="preset-chip" data-filter="low_efficiency"
                                            data-tooltip-title="저효율 소재"
                                            data-tooltip-icon="⚠️"
                                            data-tooltip-type="low-efficiency"
                                            data-tooltip-criteria="효율 점수 하위 20%에 해당하는 소재입니다.&lt;br&gt;• ROAS, CPA, CPC, CPM 모두 저조&lt;br&gt;• 개선이 시급한 소재"
                                            data-tooltip-action="예산 축소 검토"
                                            data-tooltip-action-type="negative"
                                            data-tooltip-action-detail="광고비 대비 성과가 낮습니다. 예산을 줄이거나 소재를 교체하세요.">
                                        <span class="chip-icon">⚠️</span>저효율 소재
                                    </button>
                                </div>
                                <div id="kpiPresetDescription" class="kpi-preset-description" style="display: none; margin-top: 8px;"></div>
                            </div>
                            <!-- 직접 입력 영역 -->
                            <div id="kpiManualInputSection" class="unified-filter-content" style="margin-bottom: 0;">
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>KPI 기준</label>
                                    <select id="kpiFilterMetric">
                                        <option value="비용">비용</option>
                                        <option value="노출">노출</option>
                                        <option value="클릭">클릭</option>
                                        <option value="전환수">전환수</option>
                                        <option value="전환값">전환값</option>
                                        <option value="CPC">CPC</option>
                                        <option value="CPA">CPA</option>
                                        <option value="ROAS">ROAS</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>조건</label>
                                    <select id="kpiFilterOperator">
                                        <option value=">">> (보다 큼)</option>
                                        <option value="<">< (보다 작음)</option>
                                        <option value=">=">>= (크거나 같음)</option>
                                        <option value="<="><= (작거나 같음)</option>
                                        <option value="=">= (같음)</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>기준값</label>
                                    <input type="text" id="kpiFilterValue" placeholder="수치 입력" class="formatted-number">
                                </div>
                                <div class="filter-group" style="flex: 0 0 140px;">
                                    <label>조합 조건</label>
                                    <div class="compound-radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="compoundLogic" value="none" checked>
                                            <span>없음</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="compoundLogic" value="or">
                                            <span>또는</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="compoundLogic" value="and">
                                            <span>그리고</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- 보조 필터 그룹 (OR/AND 선택시 표시) -->
                            <div class="filter-row secondary-filter-row" id="secondaryFilterRow" style="align-items: flex-end; margin-top: 12px; display: none;">
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>KPI 기준</label>
                                    <select id="kpiFilterMetricSecondary">
                                        <option value="비용">비용</option>
                                        <option value="노출">노출</option>
                                        <option value="클릭">클릭</option>
                                        <option value="전환수">전환수</option>
                                        <option value="전환값">전환값</option>
                                        <option value="CPC">CPC</option>
                                        <option value="CPA">CPA</option>
                                        <option value="ROAS">ROAS</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>조건</label>
                                    <select id="kpiFilterOperatorSecondary">
                                        <option value=">">> (보다 큼)</option>
                                        <option value="<">< (보다 작음)</option>
                                        <option value=">=">>= (크거나 같음)</option>
                                        <option value="<="><= (작거나 같음)</option>
                                        <option value="=">= (같음)</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>기준값</label>
                                    <input type="text" id="kpiFilterValueSecondary" placeholder="수치 입력" class="formatted-number">
                                </div>
                                <div class="filter-group" style="flex: 0 0 140px;">
                                    <label>조합 조건</label>
                                    <div class="compound-radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="compoundLogicSecondary" value="none" checked>
                                            <span>없음</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="compoundLogicSecondary" value="or">
                                            <span>또는</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="compoundLogicSecondary" value="and">
                                            <span>그리고</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- 3차 필터 그룹 (OR/AND 선택시 표시) -->
                            <div class="filter-row tertiary-filter-row" id="tertiaryFilterRow" style="align-items: flex-end; margin-top: 12px; display: none;">
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>KPI 기준</label>
                                    <select id="kpiFilterMetricTertiary">
                                        <option value="비용">비용</option>
                                        <option value="노출">노출</option>
                                        <option value="클릭">클릭</option>
                                        <option value="전환수">전환수</option>
                                        <option value="전환값">전환값</option>
                                        <option value="CPC">CPC</option>
                                        <option value="CPA">CPA</option>
                                        <option value="ROAS">ROAS</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>조건</label>
                                    <select id="kpiFilterOperatorTertiary">
                                        <option value=">">> (보다 큼)</option>
                                        <option value="<">< (보다 작음)</option>
                                        <option value=">=">>= (크거나 같음)</option>
                                        <option value="<="><= (작거나 같음)</option>
                                        <option value="=">= (같음)</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>기준값</label>
                                    <input type="text" id="kpiFilterValueTertiary" placeholder="수치 입력" class="formatted-number">
                                </div>
                            </div>
                        </div>

                        <!-- 오른쪽: 정렬 설정 -->
                        <div class="unified-filter-right">
                            <div class="unified-filter-title">정렬 설정</div>
                            <div class="unified-filter-content">
                                <div class="filter-group" style="flex: 0 0 100px;">
                                    <label>정렬 기준</label>
                                    <select id="sortMetric">
                                        <option value="-" disabled>-</option>
                                        <option value="비용">비용</option>
                                        <option value="노출">노출</option>
                                        <option value="클릭">클릭</option>
                                        <option value="전환수">전환수</option>
                                        <option value="전환값">전환값</option>
                                        <option value="CPC">CPC</option>
                                        <option value="CPA">CPA</option>
                                        <option value="ROAS">ROAS</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 0 0 auto;">
                                    <label>정렬 순서</label>
                                    <div class="sort-radio-group">
                                        <label class="radio-label">
                                            <input type="radio" name="sortOrder" value="desc" checked>
                                            <span>내림차순</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio" name="sortOrder" value="asc">
                                            <span>오름차순</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 요약 섹션 -->
                <div class="summary-section">
                    <div class="summary-grid">
                        <div class="summary-card card">
                            <h3>총 비용</h3>
                            <div class="value" id="totalCost">-</div>
                            <div class="unit">원</div>
                        </div>
                        <div class="summary-card card">
                            <h3>평균 CPM</h3>
                            <div class="value" id="avgCPM">-</div>
                            <div class="unit">원</div>
                        </div>
                        <div class="summary-card card">
                            <h3>평균 CPC</h3>
                            <div class="value" id="avgCPC">-</div>
                            <div class="unit">원</div>
                        </div>
                        <div class="summary-card card">
                            <h3>평균 CPA</h3>
                            <div class="value" id="avgCPA">-</div>
                            <div class="unit">원</div>
                        </div>
                        <div class="summary-card card">
                            <h3>평균 ROAS</h3>
                            <div class="value" id="avgROAS">-</div>
                            <div class="unit"></div>
                        </div>
                    </div>
                </div>

                <!-- 소재 그리드 -->
                <div class="creative-grid" id="creativeGrid">
                    <div class="loading">데이터를 불러오는 중...</div>
                </div>
            </div>
        
            </div>

            <!-- ========== 시계열 데이터 분석 (timeseries_analysis.html) ========== -->
            <div class="page-section" data-page="timeseries">
                
            <div class="container">
                <!-- 헤더 -->
                <div class="header">
                    <div>
                        <h1>시계열 데이터 분석</h1>
                        <div class="header-subtitle">AI 기반 예측 모델을 통한 광고 성과 예측 및 인사이트 <strong>(향후 30일 예측)</strong></div>
                    </div>
                </div>

                <!-- 0. AI 상태 요약 카드 (summary_card) -->
                <div id="summaryCardContainer" class="card" style="margin-bottom: 24px; display: none;">
                    <div style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                            <div id="summaryCardStatus" style="font-size: 24px; font-weight: 700;"></div>
                            <div>
                                <div id="summaryCardMessage" style="font-size: 14px; color: var(--grey-700);"></div>
                                <div id="summaryCardPeriod" style="font-size: 12px; color: var(--grey-500); margin-top: 4px;"></div>
                            </div>
                        </div>
                        <div id="summaryCardMetrics" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <!-- JS로 동적 생성 -->
                        </div>
                    </div>
                </div>

                <!-- 1. 핵심 KPI 요약 (제일 위, 펼쳐진 상태) -->
                <!-- 주요/세부 성과 토글 -->
                <div class="kpi-view-toggle">
                    <button class="kpi-view-btn active" data-kpi-view="primary">주요 성과</button>
                    <button class="kpi-view-btn" data-kpi-view="all">세부 성과</button>
                </div>
                <div class="kpi-section" id="kpiSectionContainer">
                    <div id="kpiSummaryGrid">
                        <!-- JS로 동적 생성 -->
                    </div>
                </div>

                <!-- 2. 통합 인사이트 대시보드 (접기/펼치기) -->
                <div class="collapsible-section" style="margin-bottom: 24px;">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">🔬</span>
                            <span>통합 인사이트 대시보드</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- AI 인사이트 요약 (스토리 기반 인트로) -->
                        <div id="aiSummaryContainer" style="display: none; margin-bottom: 20px;">
                            <!-- 스토리 배너 -->
                            <div style="margin-bottom: 16px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white;">
                                <div style="display: flex; align-items: flex-start; gap: 16px;">
                                    <div style="font-size: 40px; line-height: 1;">🤖</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 16px; font-weight: 700; margin-bottom: 6px;">AI가 분석한 오늘의 마케팅 인사이트</div>
                                        <div style="font-size: 13px; opacity: 0.9; line-height: 1.6;">
                                            Prophet 예측 모델 기반으로 <strong>성과 트렌드와 액션 아이템</strong>을 요약했습니다.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- AI 요약 기간 필터 -->
                            <div style="margin-bottom: 16px; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <span style="font-size: 12px; font-weight: 600; color: #495057;">📅 분석 기간:</span>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <button class="ai-period-btn active" data-ai-period="full" onclick="switchAiSummaryPeriod('full')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">전체</button>
                                        <button class="ai-period-btn" data-ai-period="180d" onclick="switchAiSummaryPeriod('180d')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">180일</button>
                                        <button class="ai-period-btn" data-ai-period="90d" onclick="switchAiSummaryPeriod('90d')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">90일</button>
                                        <button class="ai-period-btn" data-ai-period="30d" onclick="switchAiSummaryPeriod('30d')" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">30일</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 하위 탭 버튼 (데이터 기반 의사결정 도구 스타일) -->
                            <div class="view-type-section" style="margin-bottom: 20px; flex-wrap: wrap; gap: 8px;">
                                <button class="view-btn insights-tab-btn active" data-insights-tab="summary" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    📊 핵심 요약
                                </button>
                                <button class="view-btn insights-tab-btn" data-insights-tab="alerts" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    ⚠️ 경고 및 추천 <span id="alertsBadge" style="display: none; padding: 2px 8px; background: #ef5350; color: white; border-radius: 10px; font-size: 11px; margin-left: 4px;"></span>
                                </button>
                                <button class="view-btn insights-tab-btn" data-insights-tab="opportunities" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    🎯 기회 요소 <span id="opportunitiesBadge" style="display: none; padding: 2px 8px; background: #4caf50; color: white; border-radius: 10px; font-size: 11px; margin-left: 4px;"></span>
                                </button>
                                <button class="view-btn insights-tab-btn" data-insights-tab="matrix" style="padding: 10px 18px; font-size: 13px; font-weight: 600;">
                                    📈 주요 항목별 분석 <span id="matrixBadge" style="display: none; padding: 2px 8px; background: #673ab7; color: white; border-radius: 10px; font-size: 11px; margin-left: 4px;"></span>
                                </button>
                            </div>

                            <!-- 탭 0: 핵심 요약 -->
                            <div id="summaryTab" class="insights-tab-content" style="display: block; background: none; border: none; box-shadow: none; border-radius: 0; overflow: visible;">
                                <div id="aiSummaryContent" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding-top: 4px;">
                                    <!-- JS로 동적 생성 -->
                                </div>
                            </div>

                            <!-- 탭 1: 경고 및 추천 -->
                            <div id="alertsTab" class="insights-tab-content" style="display: none;">
                            <!-- 2열 그리드 컨텐츠 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; min-height: 300px;">
                                <!-- 주요 경고 -->
                                <div style="padding: 24px; border-right: 1px solid var(--grey-200); background: #fafafa;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #ef5350;">
                                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #ef5350 0%, #f44336 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <span style="font-size: 14px; filter: brightness(10);">🚨</span>
                                        </div>
                                        <div>
                                            <span style="font-size: 14px; font-weight: 700; color: var(--grey-900);">주요 경고</span>
                                            <span id="alertsCountBadge" style="font-size: 11px; color: var(--grey-500); font-weight: 500; margin-left: 8px;"></span>
                                        </div>
                                    </div>
                                    <div class="insight-content" id="insightContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <!-- JS로 동적 생성 -->
                                    </div>
                                </div>

                                <!-- 투자 추천 -->
                                <div style="padding: 24px; background: #fafafa;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #4caf50;">
                                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <span style="font-size: 14px; filter: brightness(10);">💡</span>
                                        </div>
                                        <div>
                                            <span style="font-size: 14px; font-weight: 700; color: var(--grey-900);">투자 추천</span>
                                            <span id="recommendationsCountBadge" style="font-size: 11px; color: var(--grey-500); font-weight: 500; margin-left: 8px;"></span>
                                        </div>
                                    </div>
                                    <div class="insight-content recommendation-list" id="recommendationContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral">
                                            <div class="insight-type">로딩</div>
                                            <div class="insight-message">데이터를 불러오는 중...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>

                            <!-- 탭 2: 기회 요소 (opportunities) -->
                            <div id="opportunitiesTab" class="insights-tab-content" style="display: none;">
                            <!-- 컨텐츠 영역 -->
                            <div style="padding: 24px; background: #fafafa; min-height: 250px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #2196f3;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 14px; filter: brightness(10);">💎</span>
                                    </div>
                                    <div>
                                        <span style="font-size: 14px; font-weight: 700; color: var(--grey-900);">성장 기회 발견</span>
                                    </div>
                                </div>
                                <div id="opportunitiesContent" class="insight-content" style="display: flex; flex-direction: column; gap: 12px;">
                                    <div class="insight-card opportunity">
                                        <div class="insight-type">분석 중</div>
                                        <div class="insight-message">현재 발견된 기회 요소가 없습니다.</div>
                                        <div class="insight-value">데이터가 축적되면 성장 기회가 표시됩니다.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 3: Forecast Matrix 4분면 분석 -->
                        <div id="matrixTab" class="insights-tab-content" style="display: none;">
                            <!-- 하위탭 버튼 -->
                            <div style="display: flex; gap: 0; background: #f5f5f5; border-bottom: 1px solid var(--grey-200);">
                                <button class="matrix-sub-tab active" data-matrix-tab="brand" style="flex: 1; padding: 12px 16px; border: none; background: #673ab7; color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>🏷️</span> 브랜드 <span id="matrixBrandCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                                <button class="matrix-sub-tab" data-matrix-tab="channel" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>📢</span> 채널 <span id="matrixChannelCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                                <button class="matrix-sub-tab" data-matrix-tab="product" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>📦</span> 상품 <span id="matrixProductCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                                <button class="matrix-sub-tab" data-matrix-tab="promotion" style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;">
                                    <span>🎁</span> 프로모션 <span id="matrixPromotionCount" style="font-size: 10px; opacity: 0.8;"></span>
                                </button>
                            </div>
                            <!-- 하위탭 컨텐츠 영역 -->
                            <div style="padding: 20px 24px; background: #fafafa; min-height: 350px;">
                                <!-- 브랜드 탭 -->
                                <div id="matrixBrandTab" class="matrix-sub-content" style="display: block;">
                                    <div id="matrixBrandContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                                <!-- 채널 탭 -->
                                <div id="matrixChannelTab" class="matrix-sub-content" style="display: none;">
                                    <div id="matrixChannelContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                                <!-- 상품 탭 -->
                                <div id="matrixProductTab" class="matrix-sub-content" style="display: none;">
                                    <div id="matrixProductContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                                <!-- 프로모션 탭 -->
                                <div id="matrixPromotionTab" class="matrix-sub-content" style="display: none;">
                                    <div id="matrixPromotionContent" style="display: flex; flex-direction: column; gap: 12px;">
                                        <div class="insight-card neutral"><div class="insight-message">데이터 로딩 중...</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                </div>

                <!-- 최근 변화 인사이트 (접기/펼치기) -->
                <div class="collapsible-section" style="margin-bottom: 24px;">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📈</span>
                            <span>최근 변화 인사이트</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 기간 비교 선택 -->
                        <div id="trendPeriodIndicator" style="margin-bottom: 16px; padding: 14px 18px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 10px; border: 1px solid #bbdefb;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="font-size: 16px;">📊</span>
                                <span style="font-size: 13px; font-weight: 600; color: #1565c0;">비교 기간:</span>
                                <div style="display: flex; gap: 6px;">
                                    <button class="trend-period-btn" data-trend-period="30d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">30일</button>
                                    <button class="trend-period-btn" data-trend-period="14d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">14일</button>
                                    <button class="trend-period-btn active" data-trend-period="7d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">7일</button>
                                </div>
                                <span id="trendPeriodText" style="font-size: 12px; color: #37474f; margin-left: auto;"></span>
                            </div>
                        </div>
                        <div class="compact-grid-2" style="margin-bottom: 0;">
                            <!-- 성과 개선 분석 -->
                            <div style="padding: 24px;">
                                <div class="insight-header">
                                    <span>✨ 좋은 소식: 어떤 부분이 좋아졌나요?</span>
                                </div>
                                <div class="insight-content" id="improvementTrendContent" style="display: block; max-height: 400px; overflow-y: auto; padding-top: 4px;">
                                    <div class="insight-card neutral">
                                        <div class="insight-text">데이터를 불러오는 중...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 성과 하락 경고 -->
                            <div style="padding: 24px;">
                                <div class="insight-header">
                                    <span>⚠️ 주의 필요: 성과 하락 감지</span>
                                </div>
                                <div class="insight-content" id="declineTrendContent" style="display: block; max-height: 400px; overflow-y: auto; padding-top: 4px;">
                                    <div class="insight-card neutral">
                                        <div class="insight-text">데이터를 불러오는 중...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 시뮬레이션 트렌드 대시보드 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📊</span>
                            <span>예산 시뮬레이션 및 주요 항목 추이</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 분석 타입 탭 -->
                        <div class="view-type-section" style="margin-bottom: 24px;">
                            <button class="view-btn analysis-tab-btn active" data-tab="budget-simulation">예산 시뮬레이션</button>
                            <button class="view-btn analysis-tab-btn" data-tab="segment-trend">주요 항목 트렌드</button>
                        </div>

                        <!-- 탭 1: 예산 시뮬레이션 -->
                        <div id="budgetSimulationMainTab" class="analysis-tab-content">
                            <div class="card" style="padding: 24px;">
                                <!-- 섹션 설명 -->
                                <div style="font-size: 13px; color: var(--grey-700); padding: 16px; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); line-height: 1.7; border-radius: 8px; margin-bottom: 24px;">
                                    <strong style="color: #f57c00;">💰 예산 시나리오 시뮬레이션이란?</strong><br>
                                    주요 항목별 예산 변경 시 예상되는 <strong>매출 변화</strong>를 시뮬레이션합니다.<br>
                                    <span style="color: var(--grey-600);">ROAS 기반 선형 모델 + 로그 체감 수익 함수를 적용하여 현실적인 예측을 제공합니다.</span>
                                </div>

                                <!-- 세그먼트 타입 선택 -->
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
                                        <!-- 세그먼트 유형 선택 -->
                                        <div>
                                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📊 주요 항목 유형 선택</div>
                                            <div class="view-type-section" style="margin-bottom: 0;">
                                                <button class="view-btn simulation-segment-btn active" data-sim-segment="all">전체</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="channel">채널별</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="product">제품별</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="brand">브랜드별</button>
                                                <button class="view-btn simulation-segment-btn" data-sim-segment="promotion">프로모션별</button>
                                            </div>
                                        </div>
                                        <!-- 항목 선택 드롭다운 -->
                                        <div>
                                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">🎯 항목 선택 <span id="simSelectedItemCount" style="font-size: 11px; color: #2e7d32; font-weight: 600;"></span></div>
                                            <div style="position: relative;">
                                                <button type="button" id="simItemDropdownBtn" style="min-width: 220px; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                                    <span id="simItemDropdownLabel" style="font-weight: 500;">항목을 선택하세요</span>
                                                    <span style="display: flex; align-items: center; gap: 6px;">
                                                        <span id="simItemSelectedCount" style="font-size: 11px; color: var(--grey-500);"></span>
                                                        <span style="font-size: 10px;">▼</span>
                                                    </span>
                                                </button>
                                                <div id="simItemDropdownList" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; min-width: 220px; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                    <div style="padding: 8px;">
                                                        <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                            <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                                <input type="checkbox" id="simItemSelectAll" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                                전체 선택
                                                            </label>
                                                        </div>
                                                        <div id="simItemCheckboxes"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 세그먼트별 예산 조정 슬라이더 -->
                                <div style="margin-bottom: 24px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📈 주요 항목별 예산 조정</div>
                                        <button id="resetSimulationBtn" class="reset-btn">초기화</button>
                                    </div>
                                    <div id="simulationSlidersContainer" style="display: flex; flex-direction: column; gap: 16px;">
                                        <!-- JavaScript에서 동적 생성 -->
                                    </div>
                                </div>

                                <!-- 시뮬레이션 결과 -->
                                <div style="background: var(--grey-50); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                    <div style="font-size: 14px; font-weight: 700; color: var(--grey-900); margin-bottom: 16px;">📊 시뮬레이션 결과</div>

                                    <!-- 결과 요약 카드 -->
                                    <div class="sim-result-cards">
                                        <div class="sim-result-card">
                                            <div class="sim-card-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">총 비용</div>
                                                <div class="sim-card-values">
                                                    <span id="simCurrentCost" class="sim-card-before">-</span>
                                                    <span class="sim-card-arrow">→</span>
                                                    <span id="simNewCost" class="sim-card-after" style="color: #8b5cf6;">-</span>
                                                </div>
                                                <div id="simCostChange" class="sim-card-change">-</div>
                                            </div>
                                        </div>
                                        <div class="sim-result-card highlight">
                                            <div class="sim-card-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">예상 매출</div>
                                                <div class="sim-card-values">
                                                    <span id="simCurrentRevenue" class="sim-card-before">-</span>
                                                    <span class="sim-card-arrow">→</span>
                                                    <span id="simNewRevenue" class="sim-card-after" style="color: #10b981;">-</span>
                                                </div>
                                                <div id="simRevenueChange" class="sim-card-change">-</div>
                                            </div>
                                        </div>
                                        <div class="sim-result-card">
                                            <div class="sim-card-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">평균 ROAS</div>
                                                <div class="sim-card-values">
                                                    <span id="simCurrentRoas" class="sim-card-before">-</span>
                                                    <span class="sim-card-arrow">→</span>
                                                    <span id="simNewRoas" class="sim-card-after" style="color: #f59e0b;">-</span>
                                                </div>
                                                <div id="simRoasChange" class="sim-card-change">-</div>
                                            </div>
                                        </div>
                                        <div class="sim-result-card featured">
                                            <div class="sim-card-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                            </div>
                                            <div class="sim-card-content">
                                                <div class="sim-card-label">투자 효율</div>
                                                <div id="simInvestmentEfficiency" class="sim-card-value-large">-</div>
                                                <div class="sim-card-subtitle">추가투자 대비 추가매출</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 세그먼트별 상세 결과 테이블 -->
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                        <div style="width: 28px; height: 28px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(103, 58, 183, 0.1)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                                <path d="M9 14l2 2 4-4"/>
                                            </svg>
                                        </div>
                                        <span style="font-size: 14px; font-weight: 600; color: var(--grey-800);">주요 항목별 상세 결과</span>
                                        <span style="font-size: 12px; color: var(--grey-400); margin-left: auto;">효율 기준: 고(150%+) / 중(50-150%) / 저(50%-)</span>
                                    </div>
                                    <div class="sim-table-container">
                                        <table id="simulationResultTable" class="sim-detail-table">
                                            <thead>
                                                <tr>
                                                    <th style="text-align: left;">주요 항목</th>
                                                    <th style="text-align: right;">현재 비용</th>
                                                    <th style="text-align: right;">변경 비용</th>
                                                    <th style="text-align: right;">현재 매출</th>
                                                    <th style="text-align: right;">예상 매출</th>
                                                    <th style="text-align: right;">현재 ROAS</th>
                                                    <th style="text-align: right;">예상 ROAS</th>
                                                    <th style="text-align: center;">추천</th>
                                                </tr>
                                            </thead>
                                            <tbody id="simulationResultBody">
                                                <!-- JavaScript에서 동적 생성 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- 통합 인사이트 박스 -->
                                <div class="sim-insight-box" id="simulationInsightBox">
                                    <div class="sim-insight-header">
                                        <div class="sim-insight-icon">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                            </svg>
                                        </div>
                                        <span class="sim-insight-title">시뮬레이션 분석</span>
                                        <div id="simulationInsightStatus" class="sim-insight-status neutral">
                                            <span>대기 중</span>
                                        </div>
                                    </div>
                                    <div class="sim-insight-content">
                                        <div class="sim-insight-main">
                                            <div class="sim-insight-main-title">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                                </svg>
                                                분석 결과
                                            </div>
                                            <div id="simulationInsight" class="sim-insight-main-text">
                                                주요 항목별 예산을 조정하면 예상 결과가 표시됩니다.
                                            </div>
                                        </div>
                                        <div class="sim-insight-notes">
                                            <div class="sim-insight-notes-title">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                </svg>
                                                시뮬레이션 주의사항
                                            </div>
                                            <ul class="sim-insight-notes-list" style="list-style: none; padding: 0; margin: 0;">
                                                <li>예산 증가 시 <strong>체감 수익 효과</strong>가 적용됩니다</li>
                                                <li>실제 결과는 시장 상황, 경쟁에 따라 달라질 수 있습니다</li>
                                                <li>본 시뮬레이션은 의사결정 <strong>참고용</strong>입니다</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 2: 세그먼트 트렌드 -->
                        <div id="segmentTrendTab" class="analysis-tab-content" style="display: none;">
                            <!-- 세그먼트 타입 하위탭 및 집계 단위 (탭 바로 아래) -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div class="view-type-section" style="margin-bottom: 0;">
                                    <button class="view-btn segment-trend-type-btn active" data-segment="overall">전체</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="channel">채널별</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="product">제품별</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="brand">브랜드별</button>
                                    <button class="view-btn segment-trend-type-btn" data-segment="promotion">프로모션별</button>
                                </div>
                                <div class="view-type-section" style="margin-bottom: 0;">
                                    <button class="view-btn segment-trend-view-btn active" data-view="monthly">월별</button>
                                    <button class="view-btn segment-trend-view-btn" data-view="weekly">주별</button>
                                    <button class="view-btn segment-trend-view-btn" data-view="daily">일별</button>
                                </div>
                            </div>

                            <!-- 전체 성과 예측 콘텐츠 (하위탭: 전체) -->
                            <div id="segmentTrendOverallContent" class="segment-trend-content">
                                <div class="chart-section card">
                                    <div class="chart-section-header">
                                        <div class="chart-header">성과 예측 추이</div>
                                    </div>
                                    <!-- 차트 컨트롤 영역 (기존 위치) -->
                                    <div class="chart-controls">
                                        <div class="chart-toggle-group" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button type="button" class="data-label-toggle active" data-chart-toggle="chartCostTrend">
                                                <span class="toggle-checkbox">✓</span>
                                                <span>비용</span>
                                            </button>
                                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPMTrend">
                                                <span class="toggle-checkbox">☐</span>
                                                <span>CPM</span>
                                            </button>
                                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPCTrend">
                                                <span class="toggle-checkbox">☐</span>
                                                <span>CPC</span>
                                            </button>
                                            <button type="button" class="data-label-toggle" data-chart-toggle="chartCPATrend">
                                                <span class="toggle-checkbox">☐</span>
                                                <span>CPA</span>
                                            </button>
                                            <button type="button" class="data-label-toggle active" data-chart-toggle="chartROASTrend">
                                                <span class="toggle-checkbox">✓</span>
                                                <span>ROAS</span>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- 숨겨진 체크박스 (기존 기능 유지용) -->
                                    <div style="display: none;">
                                        <input type="checkbox" id="chartCostTrend" checked>
                                        <input type="checkbox" id="chartCPMTrend">
                                        <input type="checkbox" id="chartCPCTrend">
                                        <input type="checkbox" id="chartCPATrend">
                                        <input type="checkbox" id="chartROASTrend" checked>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="forecastChartTrend"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- 세그먼트별 콘텐츠 (하위탭: 채널별/제품별/브랜드별/프로모션별) -->
                            <div id="segmentTrendSegmentContent" class="segment-trend-content" style="display: none;">
                                <div class="chart-section card">
                                <!-- 상단 헤더 -->
                                <div style="margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div class="chart-header" style="margin-bottom: 4px;">시간에 따른 주요 항목 성과 추이</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                        시간에 따른 각 주요 항목의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                    </p>
                                </div>

                                <!-- 지표 선택, 기간 선택, 항목 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="segmentTrendMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                        </select>
                                    </div>

                                    <!-- 항목 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📊 항목 선택 <span style="font-size: 12px; color: #2e7d32; font-weight: 600;">🎯 <span id="selectedSegmentCount">0</span>개 선택됨</span></div>
                                        <div style="position: relative;">
                                            <button type="button" id="segmentTrendDropdownBtn" style="min-width: 200px; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span id="segmentTrendDropdownLabel" style="font-weight: 500;">항목을 선택하세요</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span id="segmentTrendSelectedCount" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div id="segmentTrendDropdownList" style="display: none; position: absolute; top: 100%; left: 0; min-width: 250px; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" id="segmentTrendSelectAll" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택 (최대 5개)
                                                        </label>
                                                    </div>
                                                    <div id="segmentTrendCheckboxes" class="segment-trend-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="segmentTrendStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="segmentTrendEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 트렌드 차트 -->
                                <div class="chart-container">
                                    <canvas id="segmentTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 주요 항목은 예산을 확대하고, 하락 추세를 보이는 주요 항목은 원인을 분석하여 개선하세요.
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 4. 통합 시각화 대시보드 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📊</span>
                            <span>데이터 분석 알고리즘</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 시각화 타입 탭 -->
                        <!-- 통계 분석 시각화 -->
                        <div id="statisticsVizTab" class="viz-tab-content" style="display: block;">
                            <!-- 섹션 설명 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px; background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); line-height: 1.7; border-radius: 8px; margin-bottom: 24px;">
                                <strong style="color: var(--primary-main);">📖 통계 분석이란?</strong><br>
                                AI 알고리즘을 활용하여 <strong>데이터의 숨겨진 패턴과 미래 트렌드</strong>를 발견합니다.<br>
                                <span style="color: var(--grey-600);">시계열 예측, 계절성 분석, 지표 간 상관관계를 통해 데이터 기반 의사결정을 지원합니다.</span><br><br>
                                <strong style="color: var(--primary-main);">💡 어떻게 활용하나요?</strong><br>
                                • <strong>예측 & 트렌드</strong>: 미래 성과를 예측하고 계절적 패턴을 파악하여 선제적 대응<br>
                                • <strong>관계 & 품질</strong>: 지표 간 연관성을 이해하고 데이터 품질을 검증하여 정확한 분석
                            </div>

                            <!-- 통계 분석 서브 탭 -->
                            <div class="view-type-section" style="margin-bottom: 24px;">
                                <button class="view-btn statistics-subtab-btn active" data-statistics-tab="forecast-trend">📈 예측 & 트렌드</button>
                                <button class="view-btn statistics-subtab-btn" data-statistics-tab="correlation-quality">🔍 관계 & 품질</button>
                            </div>

                            <!-- 서브 탭 1: 예측 & 트렌드 -->
                            <div id="forecastTrendTab" class="statistics-subtab-content" style="display: block;">
                                <!-- 시계열 예측 분석 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div class="visualization-title" style="margin-bottom: 16px;">📈 시계열 예측 분석</div>
                                    <div class="img-tooltip-wrapper" data-tooltip="실제 데이터와 Prophet 모델을 사용한 미래 예측을 표시합니다. 신뢰구간과 함께 향후 추세를 확인할 수 있습니다." style="margin-bottom: 20px;">
                                        <img src="visualizations/timeseries_forecast.png" alt="시계열 예측" class="visualization-img">
                                    </div>

                                    <!-- 예측 분석 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 예측 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card positive" style="border-left-color: var(--secondary-main);">
                                            <div class="insight-title" style="font-size: 13px;">🎯 예측 정확도</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                Prophet 알고리즘을 통해 <strong>95% 신뢰구간</strong>으로 향후 30일 성과를 예측합니다.
                                                과거 패턴 기반의 신뢰할 수 있는 예측입니다.
                                            </div>
                                        </div>
                                        <div class="insight-card neutral">
                                            <div class="insight-title" style="font-size: 13px;">📊 추세 분석</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                장기 트렌드를 파악하여 <strong>성장 또는 하락 구간</strong>을 식별합니다.
                                                시즌별 성과 변동을 미리 대비하세요.
                                            </div>
                                        </div>
                                        <div class="insight-card positive">
                                            <div class="insight-title" style="font-size: 13px;">⚡ 실무 활용</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                예측 데이터로 <strong>사전 예산 조정</strong>, <strong>재고 계획</strong>,
                                                <strong>프로모션 타이밍</strong>을 최적화할 수 있습니다.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 예측 해석 가이드 -->
                                    <div style="background: var(--grey-50); padding: 16px; border-radius: 8px; border-left: 4px solid var(--secondary-main);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--grey-900);">📚 예측 차트 읽는 법</div>
                                        <div style="display: grid; gap: 8px; font-size: 12px; color: var(--grey-700);">
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--secondary-main); font-weight: 600;">●</span>
                                                <span><strong>파란색 실선</strong>: 실제 관측된 데이터 (과거 실적)</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--primary-main); font-weight: 600;">●</span>
                                                <span><strong>보라색 실선</strong>: AI 모델의 예측값 (미래 예상 성과)</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--grey-500); font-weight: 600;">▓</span>
                                                <span><strong>음영 영역</strong>: 95% 신뢰구간 (실제 값이 이 범위에 있을 확률 95%)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 계절성 분해 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div class="visualization-title" style="margin-bottom: 16px;">🔄 계절성 분해 분석</div>
                                    <div class="img-tooltip-wrapper" data-tooltip="시계열 데이터를 추세(Trend), 계절성(Seasonal), 잔차(Residual) 성분으로 분해하여 패턴을 분석합니다." style="margin-bottom: 20px;">
                                        <img src="visualizations/seasonal_decomposition.png" alt="계절성 분해" class="visualization-img">
                                    </div>

                                    <!-- 계절성 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 계절성 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card positive">
                                            <div class="insight-title" style="font-size: 13px;">📈 Trend (추세)</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                장기적인 <strong>상승/하락 방향</strong>을 보여줍니다.
                                                전체적인 비즈니스 성장세를 파악할 수 있습니다.
                                            </div>
                                        </div>
                                        <div class="insight-card neutral">
                                            <div class="insight-title" style="font-size: 13px;">🔄 Seasonal (계절성)</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                <strong>주기적으로 반복되는 패턴</strong>을 식별합니다.
                                                월별, 요일별 성과 변동을 예측할 수 있습니다.
                                            </div>
                                        </div>
                                        <div class="insight-card positive" style="border-left-color: var(--warning-main);">
                                            <div class="insight-title" style="font-size: 13px;">📊 Residual (잔차)</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                추세와 계절성으로 설명되지 않는 <strong>불규칙한 변동</strong>입니다.
                                                이상 이벤트나 외부 요인을 파악하세요.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 실무 활용 팁 -->
                                    <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); padding: 16px; border-radius: 8px;">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--primary-main);">🎯 실무 활용 팁</div>
                                        <div style="display: grid; gap: 8px; font-size: 12px; color: var(--grey-700);">
                                            <div><strong>✓ 계절성 패턴 활용</strong>: 성수기/비수기를 미리 파악하여 예산과 재고를 사전 조정</div>
                                            <div><strong>✓ 추세 기반 전략</strong>: 상승 추세 시 공격적 투자, 하락 추세 시 효율성 개선에 집중</div>
                                            <div><strong>✓ 잔차 분석</strong>: 큰 변동이 발생한 시점을 찾아 특별한 이벤트나 캠페인 효과 분석</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 서브 탭 2: 관계 & 품질 -->
                            <div id="correlationQualityTab" class="statistics-subtab-content" style="display: none;">
                                <!-- 상관관계 히트맵 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div class="visualization-title" style="margin-bottom: 16px;">🔗 상관관계 히트맵</div>
                                    <div class="img-tooltip-wrapper" data-tooltip="주요 마케팅 지표(비용, 전환수, 매출 등) 간의 상관관계를 색상으로 표현합니다. 진한 색일수록 강한 상관관계를 의미합니다." style="margin-bottom: 20px; max-width: 70%; margin-left: auto; margin-right: auto;">
                                        <img src="visualizations/correlation_heatmap.png" alt="상관관계" class="visualization-img">
                                    </div>

                                    <!-- 상관관계 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 상관관계 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card positive">
                                            <div class="insight-title" style="font-size: 13px;">🔴 강한 양의 상관</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                진한 빨간색(+0.7 이상)은 <strong>함께 증가하는 관계</strong>입니다.
                                                예: 비용↑ → 전환수↑
                                            </div>
                                        </div>
                                        <div class="insight-card neutral">
                                            <div class="insight-title" style="font-size: 13px;">🔵 강한 음의 상관</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                진한 파란색(-0.7 이하)은 <strong>반대로 움직이는 관계</strong>입니다.
                                                예: CPA↑ → ROAS↓
                                            </div>
                                        </div>
                                        <div class="insight-card positive" style="border-left-color: var(--warning-main);">
                                            <div class="insight-title" style="font-size: 13px;">⚪ 약한 상관</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                연한 색(-0.3 ~ +0.3)은 <strong>독립적인 관계</strong>입니다.
                                                서로 영향을 주지 않는 지표입니다.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 상관관계 활용 가이드 -->
                                    <div style="background: var(--grey-50); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success-main);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--grey-900);">📚 상관관계 활용 전략</div>
                                        <div style="display: grid; gap: 8px; font-size: 12px; color: var(--grey-700);">
                                            <div><strong>1. 레버리지 지표 발견</strong>: 전환수/매출과 강한 양의 상관관계를 가진 지표에 집중 투자</div>
                                            <div><strong>2. 비효율 요인 제거</strong>: 비용과 강한 양의 상관이지만 매출과 약한 상관인 채널은 재검토</div>
                                            <div><strong>3. 다변량 최적화</strong>: 여러 지표 간 관계를 고려한 종합적인 마케팅 전략 수립</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 이미지 좌우 배치: 이상치 & 데이터 분포 -->
                                <div class="card" style="padding: 24px; margin-bottom: 24px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                                        <!-- 왼쪽: 이상치 분석 -->
                                        <div>
                                            <div class="visualization-title" style="margin-bottom: 16px; text-align: center;">⚠️ 이상치 분석</div>
                                            <div class="img-tooltip-wrapper" data-tooltip="데이터 분포와 이상치(Outliers)를 박스플롯으로 시각화합니다. 상자 밖의 점들이 이상치를 나타냅니다.">
                                                <img src="visualizations/boxplot_outliers.png" alt="이상치 분석" class="visualization-img">
                                            </div>
                                        </div>

                                        <!-- 오른쪽: 데이터 분포 -->
                                        <div>
                                            <div class="visualization-title" style="margin-bottom: 16px; text-align: center;">📊 데이터 분포 분석</div>
                                            <div class="img-tooltip-wrapper" data-tooltip="주요 지표의 히스토그램과 확률 분포를 표시합니다. 데이터의 정규성과 편향을 확인할 수 있습니다.">
                                                <img src="visualizations/distribution_analysis.png" alt="분포 분석" class="visualization-img">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 데이터 품질 인사이트 -->
                                    <div class="insight-header" style="font-size: 14px; margin-bottom: 12px;">💡 데이터 품질 인사이트</div>
                                    <div class="insight-content" style="grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                        <div class="insight-card negative">
                                            <div class="insight-title" style="font-size: 13px;">⚠️ 이상치 탐지</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                박스플롯에서 <strong>상자 밖의 점</strong>은 이상치입니다.
                                                데이터 오류인지, 특별한 이벤트인지 확인하세요.
                                                <div style="margin-top: 8px; padding: 8px; background: var(--error-light); border-radius: 4px;">
                                                    <strong>체크포인트</strong>: 이상치가 5% 이상이면 데이터 품질 재검토 필요
                                                </div>
                                            </div>
                                        </div>
                                        <div class="insight-card positive" style="border-left-color: var(--secondary-main);">
                                            <div class="insight-title" style="font-size: 13px;">📊 분포 패턴</div>
                                            <div class="insight-text" style="font-size: 12px;">
                                                히스토그램이 <strong>종 모양</strong>이면 정규분포입니다.
                                                편향되거나 여러 봉우리가 있다면 주요 항목 분리를 고려하세요.
                                                <div style="margin-top: 8px; padding: 8px; background: var(--secondary-light); border-radius: 4px;">
                                                    <strong>TIP</strong>: 정규분포일수록 예측 모델의 정확도가 높아집니다
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 데이터 품질 체크리스트 -->
                                    <div style="background: linear-gradient(135deg, #fff4f0 0%, #ffebe8 100%); padding: 16px; border-radius: 8px; border-left: 4px solid var(--error-main);">
                                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: var(--error-main);">🔍 데이터 품질 체크리스트</div>
                                        <div style="display: grid; gap: 6px; font-size: 12px; color: var(--grey-700);">
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>이상치 비율이 5% 미만인가?</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>데이터 분포가 예상 범위 내에 있는가?</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>이상치 발생 시점에 특별 이벤트가 있었는가?</span>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <span style="color: var(--error-main);">□</span>
                                                <span>결측치나 0값이 비정상적으로 많지 않은가?</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            </div>

            <!-- ========== 채널별 비교 (type_dashboard.html) ========== -->
            <div class="page-section" data-page="type">
                
            <!-- 대시보드 헤더 -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">채널별 분석 대시보드</h1>
                <p class="dashboard-subtitle" id="period-info">데이터 로딩 중...</p>
            </div>

            <!-- 전체 개요 섹션 (항상 표시) -->
            <div>
                <!-- KPI 카드 -->
                <div class="kpi-view-toggle">
                    <button class="kpi-view-btn active" data-kpi-view="primary">주요 성과</button>
                    <button class="kpi-view-btn" data-kpi-view="all">세부 성과</button>
                </div>
                <div class="kpi-section" id="kpi-section">
                    <div class="kpi-wrapper" id="kpi-wrapper">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- 데이터 기반 의사결정 도구 -->
                <div class="collapsible-section" style="margin-bottom: 24px;">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">🔬</span>
                            <span>데이터 기반 의사결정 도구</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 기간 필터 버튼 -->
                        <div style="margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="font-size: 12px; font-weight: 600; color: #495057;">📅 분석 기간:</span>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="period-filter-btn active" data-period="full" onclick="switchPeriod('full')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">
                                        전체 기간
                                    </button>
                                    <button class="period-filter-btn" data-period="180d" onclick="switchPeriod('180d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 180일
                                    </button>
                                    <button class="period-filter-btn" data-period="90d" onclick="switchPeriod('90d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 90일
                                    </button>
                                </div>
                                <span id="periodDateRange" style="font-size: 11px; color: #6c757d; margin-left: auto;"></span>
                            </div>
                        </div>

                        <!-- 메인 탭 버튼 (컴팩트) -->
                        <div class="view-type-section" style="margin-bottom: 16px; flex-wrap: wrap; gap: 6px; align-items: center;">
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled active" data-tab="summary" style="padding: 8px 14px; font-size: 12px;" title="선택한 기간 필터가 적용됩니다">
                                📋 오늘의 요약
                            </button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="opportunity" style="padding: 8px 14px; font-size: 12px;" title="선택한 기간 필터가 적용됩니다">
                                🎯 성과 기회
                            </button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="warning" style="padding: 8px 14px; font-size: 12px;" title="선택한 기간 필터가 적용됩니다">
                                ⚠️ 주의 필요
                            </button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="targeting" style="padding: 8px 14px; font-size: 12px;" title="선택한 기간 필터가 적용됩니다">
                                👥 타겟 분석
                            </button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="forecast" style="padding: 8px 14px; font-size: 12px; position: relative;" title="선택한 기간 필터가 적용됩니다">
                                🔮 AI 예측
                                <span style="position: absolute; top: -6px; right: -6px; background: #78909c; color: white; font-size: 8px; padding: 2px 4px; border-radius: 8px; font-weight: 600;">향후 30일</span>
                            </button>
                            <button class="view-btn decision-tool-tab-btn period-filter-disabled" data-tab="dayAnalysis" style="padding: 8px 14px; font-size: 12px; position: relative;" title="전체 기간 데이터만 사용됩니다 (기간 필터 미적용)">
                                📊 계절성 분석
                                <span style="position: absolute; top: -6px; right: -6px; background: #78909c; color: white; font-size: 8px; padding: 2px 4px; border-radius: 8px; font-weight: 600;">전체 기간</span>
                            </button>
                            <!-- 범례 -->
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 12px; font-size: 10px; color: #6c757d;">
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 8px; height: 8px; background: #673ab7; border-radius: 2px;"></span>
                                    기간 필터 적용
                                </span>
                                <span style="display: flex; align-items: center; gap: 4px;">
                                    <span style="width: 8px; height: 8px; background: #78909c; border-radius: 2px;"></span>
                                    전체 기간 고정
                                </span>
                            </div>
                        </div>

                        <!-- 탭 0: 오늘의 요약 (새로운 메인 탭) -->
                        <div class="decision-tool-tab-content active" id="summaryTab">
                            <div id="summaryContent">
                                <p style="color: var(--grey-500); padding: 20px;">데이터를 불러오는 중...</p>
                            </div>
                        </div>

                        <!-- 탭 1: 성과 기회 분석 -->
                        <div class="decision-tool-tab-content" id="opportunityTab" style="display: none;">
                            <div id="opportunityContent">
                                <p style="color: var(--grey-500); padding: 20px;">데이터를 불러오는 중...</p>
                            </div>
                        </div>

                        <!-- 탭 2: 주의 필요 (경고) -->
                        <div class="decision-tool-tab-content" id="warningTab" style="display: none;">
                            <div id="warningContent">
                                <p style="color: var(--grey-500); padding: 20px;">데이터를 불러오는 중...</p>
                            </div>
                        </div>

                        <!-- 탭 3: 타겟 분석 -->
                        <div class="decision-tool-tab-content" id="targetingTab" style="display: none;">
                            <div id="targetingContent">
                                <p style="color: var(--grey-500); padding: 20px;">데이터를 불러오는 중...</p>
                            </div>
                        </div>

                        <!-- 탭 4: 요일별 분석 -->
                        <div class="decision-tool-tab-content" id="dayAnalysisTab" style="display: none;">
                            <!-- 전체 기간 안내 배너 -->
                            <div style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%); border-bottom: 1px solid #b0bec5;">
                                <span style="font-size: 14px;">🔒</span>
                                <span style="font-size: 11px; color: #546e7a; font-weight: 500;">
                                    이 탭은 <strong style="color: #37474f;">전체 기간</strong> 데이터를 사용합니다. 장기 트렌드 분석을 위해 기간 필터가 적용되지 않습니다.
                                </span>
                            </div>
                            <!-- 서브탭 버튼 -->
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 16px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                                <button class="day-analysis-subtab active" data-day-tab="quarterlyTrend"
                                        style="padding: 8px 16px; font-size: 12px; font-weight: 600; border: none; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">
                                    📈 분기별 추이
                                </button>
                                <button class="day-analysis-subtab" data-day-tab="dayConversion"
                                        style="padding: 8px 16px; font-size: 12px; font-weight: 600; border: 1px solid #b0bec5; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #546e7a;">
                                    📅 요일별 분석
                                </button>
                                <button class="day-analysis-subtab" data-day-tab="channelDay"
                                        style="padding: 8px 16px; font-size: 12px; font-weight: 600; border: 1px solid #b0bec5; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #546e7a;">
                                    📊 채널별 요일
                                </button>
                            </div>

                            <!-- 분기별 추이 뷰 -->
                            <div class="day-analysis-tab-content active" id="quarterlyTrendView">
                                <!-- 종합 계절성 인사이트 -->
                                <div style="padding: 20px 24px; background: linear-gradient(135deg, #e3f2fd 0%, #f5faff 100%); border-bottom: 1px solid #e9ecef;">
                                    <div style="font-size: 14px; color: #1565c0; font-weight: 600; margin-bottom: 12px;">📊 계절성 분석 인사이트</div>
                                    <div style="font-size: 13px; color: #424242; line-height: 1.8;" id="quarterlySeasonalityInsightText">로딩 중...</div>
                                </div>

                                <!-- 분기별 KPI 카드 -->
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 16px 20px; background: #fafafa;">
                                    <div id="quarterlyKpiCards" style="display: contents;"></div>
                                </div>

                                <!-- 분기별 추이 차트 -->
                                <div class="card" style="margin: 16px; border-radius: 12px;">
                                    <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                        <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">분기별 주요 지표 추이</h4>
                                        <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">분기별 비용, ROAS, CPA 변화를 한눈에 확인하세요</p>
                                    </div>
                                    <div style="padding: 20px;">
                                        <canvas id="quarterlyTrendChart" height="280"></canvas>
                                    </div>
                                </div>

                                <!-- 분기별 상세 테이블 -->
                                <div class="card" style="margin: 16px; border-radius: 12px;">
                                    <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                        <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">분기별 상세 성과</h4>
                                    </div>
                                    <div style="padding: 16px 20px; overflow-x: auto;">
                                        <table class="data-table" id="quarterlyTable" style="margin-top: 0;">
                                            <thead>
                                                <tr>
                                                    <th style="min-width: 100px; text-align: center;">분기</th>
                                                    <th style="min-width: 120px; text-align: right;">평균 비용</th>
                                                    <th style="min-width: 100px; text-align: right;">ROAS</th>
                                                    <th style="min-width: 100px; text-align: right;">CPA</th>
                                                    <th style="min-width: 100px; text-align: right;">전환수</th>
                                                    <th style="min-width: 120px; text-align: right;">전환값</th>
                                                    <th style="min-width: 100px;">성과 수준</th>
                                                </tr>
                                            </thead>
                                            <tbody id="quarterlyTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- 요일별 전환 뷰 -->
                            <div class="day-analysis-tab-content" id="dayConversionView" style="display: none;">
                                <!-- 자연어 인사이트 -->
                                <div style="padding: 20px 24px; background: linear-gradient(135deg, #fff8e1 0%, #fffef5 100%); border-bottom: 1px solid #e9ecef;">
                                    <div style="font-size: 14px; color: #f57c00; font-weight: 600; margin-bottom: 8px;">💡 요일별 성과 인사이트</div>
                                    <div style="font-size: 13px; color: #424242; line-height: 1.7;" id="seasonalityInsightText">로딩 중...</div>
                                </div>

                                <div class="card" style="margin: 16px; border-radius: 12px;">
                                    <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                        <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">요일별 성과 분석</h4>
                                        <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">어떤 요일에 광고 효율이 가장 좋은지 확인하세요 (헤더 클릭으로 정렬)</p>
                                    </div>
                                    <div style="padding: 16px 20px; overflow-x: auto;">
                                        <table class="data-table" id="seasonalityTable" style="margin-top: 0;">
                                            <thead>
                                                <tr>
                                                    <th style="min-width: 100px; text-align: center;">요일</th>
                                                    <th class="sortable-header" data-table="seasonality" data-column="roas" style="min-width: 100px; text-align: right;">
                                                        ROAS
                                                        <div class="sort-icon active"><div class="sort-arrow up"></div><div class="sort-arrow down active"></div></div>
                                                    </th>
                                                    <th class="sortable-header" data-table="seasonality" data-column="cpa" style="min-width: 100px; text-align: right;">
                                                        CPA
                                                        <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                                    </th>
                                                    <th class="sortable-header" data-table="seasonality" data-column="cost" style="min-width: 120px; text-align: right;">
                                                        광고비
                                                        <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                                    </th>
                                                    <th class="sortable-header" data-table="seasonality" data-column="conversions" style="min-width: 80px; text-align: right;">
                                                        전환수
                                                        <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                                    </th>
                                                    <th class="sortable-header" data-table="seasonality" data-column="revenue" style="min-width: 120px; text-align: right;">
                                                        전환값
                                                        <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                                    </th>
                                                    <th style="min-width: 120px;">성과 수준</th>
                                                </tr>
                                            </thead>
                                            <tbody id="seasonalityTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- 채널별 요일 뷰 -->
                            <div class="day-analysis-tab-content" id="channelDayView" style="display: none;">
                                <!-- 자연어 인사이트 (강화) -->
                                <div style="padding: 20px 24px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-bottom: 1px solid #a5d6a7;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                        <span style="font-size: 20px;">📊</span>
                                        <div style="font-size: 15px; color: #1b5e20; font-weight: 700;">채널별 요일 성과 분석</div>
                                    </div>
                                    <div style="font-size: 13px; color: #2e7d32; line-height: 1.8; background: rgba(255,255,255,0.7); padding: 12px 16px; border-radius: 8px;" id="seasonalityCategoryInsightText">로딩 중...</div>
                                </div>

                                <!-- 채널별 KPI 카드 -->
                                <div id="channelDayKpiCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; padding: 20px 24px; background: #fafafa;">
                                    <!-- 동적으로 채널 카드 생성 -->
                                </div>

                                <!-- 채널별 요일 ROAS 비교 차트 -->
                                <div class="card" style="margin: 0 16px 16px 16px; border-radius: 12px;">
                                    <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                        <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">📈 채널별 요일 ROAS 비교</h4>
                                        <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">각 채널의 요일별 ROAS를 비교하여 최적의 광고 집행 요일을 파악하세요</p>
                                    </div>
                                    <div style="padding: 20px; height: 350px;">
                                        <canvas id="channelDayRoasChart"></canvas>
                                    </div>
                                </div>

                                <!-- 채널별 상세 테이블 -->
                                <div class="card" style="margin: 0 16px 16px 16px; border-radius: 12px;">
                                    <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                                        <div>
                                            <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">📋 요일별 상세 성과</h4>
                                            <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">채널을 선택하여 요일별 성과를 확인하세요</p>
                                        </div>
                                        <select id="channelDaySelector" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; background: white; cursor: pointer; min-width: 160px;">
                                            <!-- 동적으로 채널 옵션 생성 -->
                                        </select>
                                    </div>
                                    <div style="padding: 16px 20px; overflow-x: auto;">
                                        <table class="data-table" id="seasonalityCategoryTable" style="margin-top: 0;">
                                            <thead>
                                                <tr>
                                                    <th style="min-width: 80px; text-align: center;">요일</th>
                                                    <th style="min-width: 110px; text-align: right;">평균 비용</th>
                                                    <th style="min-width: 110px; text-align: right;">평균 전환값</th>
                                                    <th style="min-width: 90px; text-align: right;">ROAS</th>
                                                    <th style="min-width: 100px; text-align: right;">CPA</th>
                                                    <th style="min-width: 80px; text-align: center;">성과</th>
                                                </tr>
                                            </thead>
                                            <tbody id="seasonalityCategoryTableBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 5: AI 예측 (Prophet) -->
                        <div class="decision-tool-tab-content" id="forecastTab" style="display: none;">
                            <div id="forecastContent">
                                <p style="color: var(--grey-500); padding: 20px;">데이터를 불러오는 중...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 성과 추이 분석 (통합 탭) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📈</span>
                            <span>성과 추이 분석 - 시간에 따른 성과 변화를 확인하세요</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 탭 버튼 -->
                        <div class="view-type-section" style="margin-bottom: 24px;">
                            <button class="view-btn trend-analysis-tab-btn active" data-tab="timeseries">광고세트 추이</button>
                            <button class="view-btn trend-analysis-tab-btn" data-tab="gender">성별 추이</button>
                            <button class="view-btn trend-analysis-tab-btn" data-tab="age">연령 추이</button>
                            <button class="view-btn trend-analysis-tab-btn" data-tab="platform">플랫폼 추이</button>
                            <button class="view-btn trend-analysis-tab-btn" data-tab="device-platform">기기플랫폼 추이</button>
                            <button class="view-btn trend-analysis-tab-btn" data-tab="device-type">기기 추이</button>
                        </div>

                        <!-- 탭 1: 광고세트 추이 -->
                        <div class="trend-analysis-tab-content active" id="timeseriesTab">
                            <!-- 컴팩트 설명 섹션 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <!-- 분석 목적 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">📊</span>
                                        <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                        시간에 따른 <strong style="color: #1565c0;">광고세트별 성과 변화</strong>를 추적하여<br>
                                        트렌드와 패턴을 한눈에 파악할 수 있습니다
                                    </p>
                                </div>

                                <!-- 사용 방법 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">💡</span>
                                        <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                        <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                            <span>드롭다운에서 원하는 필터 선택</span>
                                        </div>
                                        <div style="display: flex; align-items: start; gap: 8px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                            <span>차트에서 추이 패턴 확인</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <!-- 상단 헤더 및 컨트롤 -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div>
                                        <div class="card-title" style="margin-bottom: 4px;">시간에 따른 광고세트 성과 추이</div>
                                        <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                            시간에 따른 각 세그먼트의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                        </p>
                                    </div>
                                    <!-- 집계 단위 선택 버튼 -->
                                    <div class="view-type-section" style="margin-bottom: 0;">
                                        <button class="view-btn timeseries-period-btn active" data-period="monthly">월별</button>
                                        <button class="view-btn timeseries-period-btn" data-period="weekly">주별</button>
                                        <button class="view-btn timeseries-period-btn" data-period="daily">일별</button>
                                    </div>
                                </div>

                                <!-- 지표 선택 및 기간 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="timeseriesMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="cpa">CPA</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="timeseriesStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="timeseriesEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 드롭다운 형태 필터 -->
                                <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                        <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                            🎯 <span id="filteredAdsetCount">0</span>개 광고세트
                                        </div>
                                    </div>

                                    <!-- 드롭다운 버튼들 -->
                                    <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                        <!-- 채널별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="timeseries-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">채널_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="timeseries-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="timeseries-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="timeseries-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="timeseriesFilterChannelList" class="timeseries-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 제품별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="timeseries-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">제품_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="timeseries-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="timeseries-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="timeseries-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="timeseriesFilterProductList" class="timeseries-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 브랜드별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="timeseries-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">브랜드_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="timeseries-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="timeseries-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="timeseries-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="timeseriesFilterBrandList" class="timeseries-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 프로모션별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="timeseries-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">프로모션_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="timeseries-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="timeseries-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="timeseries-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="timeseriesFilterPromotionList" class="timeseries-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 광고세트 미리보기 -->
                                    <div id="filteredAdsetPreview" style="margin-top: 12px; padding: 10px 12px; background: white; border-radius: 6px; border: 1px solid var(--grey-200); display: none;">
                                        <div id="filteredAdsetList" style="font-size: 11px; color: var(--grey-600); max-height: 100px; overflow-y: auto; line-height: 1.6;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 트렌드 차트 -->
                                <div class="chart-container">
                                    <canvas id="timeseriesTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 (차트 하단) -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 광고세트는 예산을 확대하고, 하락 추세를 보이는 광고세트는 원인을 분석하여 개선하세요.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 2: 성별 추이 -->
                        <div class="trend-analysis-tab-content" id="genderTab" style="display: none;">
                            <!-- 컴팩트 설명 섹션 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <!-- 분석 목적 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">📊</span>
                                        <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                        시간에 따른 <strong style="color: #1565c0;">각 성별의 성과 변화</strong>를 추적하여<br>
                                        타겟팅 전략을 최적화할 수 있습니다
                                    </p>
                                </div>

                                <!-- 사용 방법 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">💡</span>
                                        <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                        <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                            <span>드롭다운에서 성별 선택 (최대 5개)</span>
                                        </div>
                                        <div style="display: flex; align-items: start; gap: 8px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                            <span>집계 단위 변경 및 차트 확인</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <!-- 필터 타입 선택 (상단) -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div>
                                        <div class="card-title" style="margin-bottom: 4px;">시간에 따른 성별 성과 추이</div>
                                        <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                            시간에 따른 각 성별의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                        </p>
                                    </div>
                                    <!-- 집계 단위 선택 버튼 -->
                                    <div class="view-type-section" style="margin-bottom: 0;">
                                        <button class="view-btn gender-period-btn active" data-period="monthly">월별</button>
                                        <button class="view-btn gender-period-btn" data-period="weekly">주별</button>
                                        <button class="view-btn gender-period-btn" data-period="daily">일별</button>
                                    </div>
                                </div>

                                <!-- 지표 선택 및 기간 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="genderMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="cpa">CPA</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="genderStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="genderEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 드롭다운 형태 필터 -->
                                <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                        <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                            🎯 <span id="filteredGenderCount">0</span>개 성별
                                        </div>
                                    </div>

                                    <!-- 드롭다운 버튼들 -->
                                    <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                        <!-- 채널별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="gender-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">채널_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="gender-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="gender-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="gender-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="genderFilterChannelList" class="gender-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 제품별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="gender-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">제품_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="gender-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="gender-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="gender-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="genderFilterProductList" class="gender-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 브랜드별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="gender-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">브랜드_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="gender-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="gender-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="gender-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="genderFilterBrandList" class="gender-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 프로모션별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="gender-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">프로모션_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="gender-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="gender-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="gender-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="genderFilterPromotionList" class="gender-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 광고세트별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="gender-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">광고세트_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="gender-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="gender-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="gender-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="genderFilterAdsetList" class="gender-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 트렌드 차트 -->
                                <div class="chart-container">
                                    <canvas id="genderTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 (차트 하단) -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 성별 타겟은 예산을 확대하고, 하락 추세를 보이는 경우 원인을 분석하여 개선하세요.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 3: 연령 추이 -->
                        <div class="trend-analysis-tab-content" id="ageTab" style="display: none;">
                            <!-- 컴팩트 설명 섹션 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <!-- 분석 목적 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">📊</span>
                                        <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                        시간에 따른 <strong style="color: #1565c0;">각 연령대의 성과 변화</strong>를 추적하여<br>
                                        타겟팅 전략을 최적화할 수 있습니다
                                    </p>
                                </div>

                                <!-- 사용 방법 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">💡</span>
                                        <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                        <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                            <span>드롭다운에서 연령대 선택 (최대 5개)</span>
                                        </div>
                                        <div style="display: flex; align-items: start; gap: 8px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                            <span>집계 단위 변경 및 차트 확인</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <!-- 필터 타입 선택 (상단) -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div>
                                        <div class="card-title" style="margin-bottom: 4px;">시간에 따른 연령대 성과 추이</div>
                                        <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                            시간에 따른 각 연령대의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                        </p>
                                    </div>
                                    <!-- 집계 단위 선택 버튼 -->
                                    <div class="view-type-section" style="margin-bottom: 0;">
                                        <button class="view-btn age-period-btn active" data-period="monthly">월별</button>
                                        <button class="view-btn age-period-btn" data-period="weekly">주별</button>
                                        <button class="view-btn age-period-btn" data-period="daily">일별</button>
                                    </div>
                                </div>

                                <!-- 지표 선택 및 기간 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="ageMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="cpa">CPA</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="ageStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="ageEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 드롭다운 형태 필터 -->
                                <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                        <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                            🎯 <span id="filteredAgeCount">0</span>개 연령대
                                        </div>
                                    </div>

                                    <!-- 드롭다운 버튼들 -->
                                    <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                        <!-- 채널별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="age-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">채널_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="age-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="age-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="age-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="ageFilterChannelList" class="age-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 제품별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="age-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">제품_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="age-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="age-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="age-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="ageFilterProductList" class="age-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 브랜드별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="age-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">브랜드_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="age-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="age-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="age-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="ageFilterBrandList" class="age-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 프로모션별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="age-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">프로모션_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="age-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="age-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="age-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="ageFilterPromotionList" class="age-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 광고세트별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="age-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">광고세트_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="age-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="age-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="age-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="ageFilterAdsetList" class="age-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 차트 -->
                                <div class="chart-container">
                                    <canvas id="ageTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 (차트 하단) -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 연령대 타겟은 예산을 확대하고, 하락 추세를 보이는 경우 원인을 분석하여 개선하세요.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 4: 플랫폼 추이 -->
                        <div class="trend-analysis-tab-content" id="platformTab" style="display: none;">
                            <!-- 컴팩트 설명 섹션 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <!-- 분석 목적 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">📊</span>
                                        <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                        시간에 따른 <strong style="color: #1565c0;">각 플랫폼의 성과 변화</strong>를 추적하여<br>
                                        플랫폼별 전략을 최적화할 수 있습니다
                                    </p>
                                </div>

                                <!-- 사용 방법 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">💡</span>
                                        <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                        <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                            <span>드롭다운에서 플랫폼 선택 (최대 5개)</span>
                                        </div>
                                        <div style="display: flex; align-items: start; gap: 8px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                            <span>집계 단위 변경 및 차트 확인</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <!-- 필터 타입 선택 (상단) -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div>
                                        <div class="card-title" style="margin-bottom: 4px;">시간에 따른 플랫폼 성과 추이</div>
                                        <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                            시간에 따른 각 플랫폼의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                        </p>
                                    </div>
                                    <!-- 집계 단위 선택 버튼 -->
                                    <div class="view-type-section" style="margin-bottom: 0;">
                                        <button class="view-btn platform-period-btn active" data-period="monthly">월별</button>
                                        <button class="view-btn platform-period-btn" data-period="weekly">주별</button>
                                        <button class="view-btn platform-period-btn" data-period="daily">일별</button>
                                    </div>
                                </div>

                                <!-- 지표 선택 및 기간 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="platformMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="cpa">CPA</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="platformStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="platformEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 드롭다운 형태 필터 -->
                                <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                        <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                            🎯 <span id="filteredPlatformCount">0</span>개 플랫폼
                                        </div>
                                    </div>

                                    <!-- 드롭다운 버튼들 -->
                                    <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                        <!-- 채널별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="platform-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">채널_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="platform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="platform-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="platform-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="platformFilterChannelList" class="platform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 제품별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="platform-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">제품_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="platform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="platform-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="platform-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="platformFilterProductList" class="platform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 브랜드별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="platform-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">브랜드_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="platform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="platform-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="platform-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="platformFilterBrandList" class="platform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 프로모션별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="platform-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">프로모션_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="platform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="platform-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="platform-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="platformFilterPromotionList" class="platform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 광고세트별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="platform-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">광고세트_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="platform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="platform-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="platform-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="platformFilterAdsetList" class="platform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 트렌드 차트 -->
                                <div class="chart-container">
                                    <canvas id="platformTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 (차트 하단) -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 플랫폼에 예산을 집중하고, 하락 추세를 보이는 플랫폼의 문제점을 파악하여 개선하세요.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 5: 기기플랫폼 추이 -->
                        <div class="trend-analysis-tab-content" id="devicePlatformTab" style="display: none;">
                            <!-- 컴팩트 설명 섹션 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <!-- 분석 목적 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">📊</span>
                                        <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                        시간에 따른 <strong style="color: #1565c0;">각 기기플랫폼의 성과 변화</strong>를 추적하여<br>
                                        플랫폼별 전략을 최적화할 수 있습니다
                                    </p>
                                </div>

                                <!-- 사용 방법 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">💡</span>
                                        <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                        <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                            <span>드롭다운에서 기기플랫폼 선택 (최대 5개)</span>
                                        </div>
                                        <div style="display: flex; align-items: start; gap: 8px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                            <span>집계 단위 변경 및 차트 확인</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <!-- 필터 타입 선택 (상단) -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div>
                                        <div class="card-title" style="margin-bottom: 4px;">시간에 따른 기기플랫폼 성과 추이</div>
                                        <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                            시간에 따른 각 기기플랫폼의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                        </p>
                                    </div>
                                    <!-- 집계 단위 선택 버튼 -->
                                    <div class="view-type-section" style="margin-bottom: 0;">
                                        <button class="view-btn deviceplatform-period-btn active" data-period="monthly">월별</button>
                                        <button class="view-btn deviceplatform-period-btn" data-period="weekly">주별</button>
                                        <button class="view-btn deviceplatform-period-btn" data-period="daily">일별</button>
                                    </div>
                                </div>

                                <!-- 지표 선택 및 기간 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="devicePlatformMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="cpa">CPA</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="devicePlatformStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="devicePlatformEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 드롭다운 형태 필터 -->
                                <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                        <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                            🎯 <span id="filteredDevicePlatformCount">0</span>개 기기플랫폼
                                        </div>
                                    </div>

                                    <!-- 드롭다운 버튼들 -->
                                    <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                        <!-- 채널별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="deviceplatform-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">채널_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="deviceplatform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="deviceplatform-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="deviceplatform-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="deviceplatformFilterChannelList" class="deviceplatform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 제품별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="deviceplatform-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">제품_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="deviceplatform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="deviceplatform-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="deviceplatform-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="deviceplatformFilterProductList" class="deviceplatform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 브랜드별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="deviceplatform-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">브랜드_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="deviceplatform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="deviceplatform-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="deviceplatform-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="deviceplatformFilterBrandList" class="deviceplatform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 프로모션별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="deviceplatform-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">프로모션_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="deviceplatform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="deviceplatform-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="deviceplatform-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="deviceplatformFilterPromotionList" class="deviceplatform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 광고세트별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="deviceplatform-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">광고세트_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="deviceplatform-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="deviceplatform-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="deviceplatform-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="deviceplatformFilterAdsetList" class="deviceplatform-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 트렌드 차트 -->
                                <div class="chart-container">
                                    <canvas id="devicePlatformTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 (차트 하단) -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 기기플랫폼에 예산을 집중하고, 하락 추세를 보이는 기기플랫폼의 문제점을 파악하여 개선하세요.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 6: 기기 추이 -->
                        <div class="trend-analysis-tab-content" id="deviceTypeTab" style="display: none;">
                            <!-- 컴팩트 설명 섹션 -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <!-- 분석 목적 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">📊</span>
                                        <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                    </div>
                                    <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                        시간에 따른 <strong style="color: #1565c0;">각 기기의 성과 변화</strong>를 추적하여<br>
                                        디바이스별 전략을 최적화할 수 있습니다
                                    </p>
                                </div>

                                <!-- 사용 방법 카드 -->
                                <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <span style="font-size: 16px;">💡</span>
                                        <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                        <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                            <span>드롭다운에서 기기 선택 (최대 5개)</span>
                                        </div>
                                        <div style="display: flex; align-items: start; gap: 8px;">
                                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                            <span>집계 단위 변경 및 차트 확인</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <!-- 필터 타입 선택 (상단) -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                    <div>
                                        <div class="card-title" style="margin-bottom: 4px;">시간에 따른 기기 성과 추이</div>
                                        <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                            시간에 따른 각 기기의 성과 변화를 추적하여 트렌드를 파악할 수 있습니다.
                                        </p>
                                    </div>
                                    <!-- 집계 단위 선택 버튼 -->
                                    <div class="view-type-section" style="margin-bottom: 0;">
                                        <button class="view-btn device-period-btn active" data-period="monthly">월별</button>
                                        <button class="view-btn device-period-btn" data-period="weekly">주별</button>
                                        <button class="view-btn device-period-btn" data-period="daily">일별</button>
                                    </div>
                                </div>

                                <!-- 지표 선택 및 기간 선택 -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                                    <!-- 지표 선택 -->
                                    <div style="flex: 0 0 auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📈 지표 선택</div>
                                        <select id="deviceTypeMetricDropdown" style="min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <option value="roas">ROAS</option>
                                            <option value="cost">비용</option>
                                            <option value="revenue">전환값</option>
                                            <option value="conversions">전환수</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="cpa">CPA</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                    </div>

                                    <!-- 기간 선택 -->
                                    <div style="flex: 0 0 auto; margin-left: auto;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <input type="date" id="deviceTypeStartDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                            <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                            <input type="date" id="deviceTypeEndDate" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer; transition: all 0.2s;">
                                        </div>
                                    </div>
                                </div>

                                <!-- 드롭다운 형태 필터 -->
                                <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                        <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                        <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                            🎯 <span id="filteredDeviceTypeCount">0</span>개 기기
                                        </div>
                                    </div>

                                    <!-- 드롭다운 버튼들 -->
                                    <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                        <!-- 채널별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="devicetype-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">채널_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="devicetype-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="devicetype-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="devicetype-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="devicetypeFilterChannelList" class="devicetype-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 제품별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="devicetype-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">제품_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="devicetype-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="devicetype-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="devicetype-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="devicetypeFilterProductList" class="devicetype-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 브랜드별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="devicetype-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">브랜드_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="devicetype-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="devicetype-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="devicetype-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="devicetypeFilterBrandList" class="devicetype-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 프로모션별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="devicetype-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">프로모션_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="devicetype-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="devicetype-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="devicetype-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="devicetypeFilterPromotionList" class="devicetype-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 광고세트별 드롭다운 -->
                                        <div style="position: relative; min-width: 180px; flex: 1;">
                                            <button type="button" class="devicetype-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; text-align: left;">
                                                <span style="font-weight: 500;">광고세트_전체</span>
                                                <span style="display: flex; align-items: center; gap: 6px;">
                                                    <span class="devicetype-selected-count" style="font-size: 11px; color: var(--grey-500);"></span>
                                                    <span style="font-size: 10px;">▼</span>
                                                </span>
                                            </button>
                                            <div class="devicetype-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                                <div style="padding: 8px;">
                                                    <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px; z-index: 1;">
                                                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                                                            <input type="checkbox" class="devicetype-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                            전체 선택
                                                        </label>
                                                    </div>
                                                    <div id="devicetypeFilterAdsetList" class="devicetype-filter-checkbox-list"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 트렌드 차트 -->
                                <div class="chart-container">
                                    <canvas id="deviceTypeTrendChart"></canvas>
                                </div>

                                <!-- 트렌드 분석 팁 (차트 하단) -->
                                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                        💡 트렌드 분석 팁
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        상승 추세를 보이는 기기에 예산을 집중하고, 하락 추세를 보이는 기기의 문제점을 파악하여 개선하세요.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 성과 테이블 분석 -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">📋</span>
                        <span>성과 테이블 분석 - 상세 지표를 테이블로 확인하세요</span>
                    </div>
                    <button class="collapsible-toggle">
                        <span>펼치기</span>
                        <span class="collapsible-toggle-icon collapsed">▼</span>
                    </button>
                </div>
                <div class="collapsible-content">
                    <!-- 탭 버튼 -->
                    <div class="view-type-section" style="margin-bottom: 24px;">
                        <button class="view-btn perf-table-tab-btn active" data-tab="adset">광고세트</button>
                        <button class="view-btn perf-table-tab-btn" data-tab="gender">성별</button>
                        <button class="view-btn perf-table-tab-btn" data-tab="age">연령</button>
                        <button class="view-btn perf-table-tab-btn" data-tab="genderAge">성별x연령</button>
                        <button class="view-btn perf-table-tab-btn" data-tab="platform">플랫폼</button>
                        <button class="view-btn perf-table-tab-btn" data-tab="devicePlatform">기기플랫폼</button>
                        <button class="view-btn perf-table-tab-btn" data-tab="deviceType">기기</button>
                    </div>

                    <!-- 광고세트 테이블 탭 -->
                    <div class="perf-table-tab-content active" id="perfTableAdsetTab">
                        <!-- 설명 섹션 -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    광고세트별 <strong style="color: #1565c0;">상세 성과 지표</strong>를 테이블 형식으로<br>
                                    정렬하고 비교할 수 있습니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>드롭다운에서 원하는 필터 선택</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>컬럼 헤더 클릭으로 정렬</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <!-- 상단 헤더 -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">광고세트별 성과 테이블</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                        광고세트별 상세 지표를 테이블로 확인할 수 있으며, KPI 버튼을 클릭해 원하는 기준으로 정렬할 수 있습니다.
                                    </p>
                                </div>
                            </div>

                            <!-- 기간 선택 -->
                            <div style="display: flex; justify-content: flex-end; align-items: flex-start; gap: 20px; margin-bottom: 20px;">
                                <div style="flex: 0 0 auto;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="perfTableAdsetStartDate" class="perf-table-date" data-tab="adset" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer;">
                                        <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                        <input type="date" id="perfTableAdsetEndDate" class="perf-table-date" data-tab="adset" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer;">
                                    </div>
                                </div>
                            </div>

                            <!-- 드롭다운 필터 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                    <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                        🎯 <span id="perfTableAdsetCount">0</span>개 광고세트
                                    </div>
                                </div>

                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <!-- 채널별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="channel" data-tab="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="channel" data-tab="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="channel" data-tab="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAdsetChannelList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>

                                    <!-- 제품별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="product" data-tab="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="product" data-tab="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="product" data-tab="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAdsetProductList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>

                                    <!-- 브랜드별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="brand" data-tab="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="brand" data-tab="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="brand" data-tab="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAdsetBrandList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>

                                    <!-- 프로모션별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="promotion" data-tab="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="promotion" data-tab="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="promotion" data-tab="adset" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAdsetPromotionList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 테이블 컨테이너 -->
                            <div id="perfTableAdsetContainer" style="overflow-x: auto; overflow-y: visible;">
                                <div style="text-align: center; padding: 60px 20px; color: var(--grey-500);">
                                    <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">필터를 선택해주세요</div>
                                    <div style="font-size: 13px; color: var(--grey-400);">위의 분류 기준에서 하나 이상의 항목을 선택해주세요.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 성별 테이블 탭 -->
                    <div class="perf-table-tab-content" id="perfTableGenderTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    성별 <strong style="color: #1565c0;">상세 성과 지표</strong>를 테이블 형식으로<br>
                                    정렬하고 비교할 수 있습니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>기간을 선택하여 데이터 필터링</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>컬럼 헤더 클릭으로 정렬</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">성별 성과 테이블</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">성별 상세 지표를 테이블로 확인할 수 있으며, KPI 버튼을 클릭해 원하는 기준으로 정렬할 수 있습니다.</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="perfTableGenderStartDate" class="perf-table-date" data-tab="gender" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                        <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                        <input type="date" id="perfTableGenderEndDate" class="perf-table-date" data-tab="gender" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            <!-- 드롭다운 필터 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                    <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                        🎯 <span id="perfTableGenderCount">0</span>개 항목
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <!-- 채널별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="channel" data-tab="gender" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="channel" data-tab="gender" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="channel" data-tab="gender" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderChannelList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 제품별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="product" data-tab="gender" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="product" data-tab="gender" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="product" data-tab="gender" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderProductList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 브랜드별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="brand" data-tab="gender" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="brand" data-tab="gender" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="brand" data-tab="gender" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderBrandList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 프로모션별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="promotion" data-tab="gender" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="promotion" data-tab="gender" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="promotion" data-tab="gender" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderPromotionList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="perfTableGenderContainer" style="overflow-x: auto;"></div>
                        </div>
                    </div>

                    <!-- 연령 테이블 탭 -->
                    <div class="perf-table-tab-content" id="perfTableAgeTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    연령대별 <strong style="color: #1565c0;">상세 성과 지표</strong>를 테이블 형식으로<br>
                                    정렬하고 비교할 수 있습니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>기간을 선택하여 데이터 필터링</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>컬럼 헤더 클릭으로 정렬</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">연령별 성과 테이블</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">연령대별 상세 지표를 테이블로 확인할 수 있으며, KPI 버튼을 클릭해 원하는 기준으로 정렬할 수 있습니다.</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="perfTableAgeStartDate" class="perf-table-date" data-tab="age" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                        <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                        <input type="date" id="perfTableAgeEndDate" class="perf-table-date" data-tab="age" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            <!-- 드롭다운 필터 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                    <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                        🎯 <span id="perfTableAgeCount">0</span>개 항목
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <!-- 채널별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="channel" data-tab="age" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="channel" data-tab="age" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="channel" data-tab="age" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAgeChannelList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 제품별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="product" data-tab="age" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="product" data-tab="age" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="product" data-tab="age" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAgeProductList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 브랜드별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="brand" data-tab="age" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="brand" data-tab="age" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="brand" data-tab="age" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAgeBrandList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 프로모션별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="promotion" data-tab="age" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="promotion" data-tab="age" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="promotion" data-tab="age" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableAgePromotionList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="perfTableAgeContainer" style="overflow-x: auto;"></div>
                        </div>
                    </div>

                    <!-- 성별연령 PIVOT 테이블 탭 -->
                    <div class="perf-table-tab-content" id="perfTableGenderAgeTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    성별과 연령대별 <strong style="color: #1565c0;">교차 분석</strong>을 통해<br>
                                    가장 효과적인 타겟 그룹을 파악합니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>분류 기준 드롭다운에서 필터 선택</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>색상 스케일로 높은/낮은 값 확인</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div style="margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div class="card-title" style="margin-bottom: 4px;">성별 × 연령대 성과 분석</div>
                                <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                    성별과 연령대의 교차 분석으로 최적의 타겟을 발견하세요. 모든 주요 지표(비용, CPM, CPC, CPA, ROAS)를 한눈에 비교할 수 있습니다.
                                </p>
                            </div>

                            <!-- 기간 선택 -->
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="perfTableGenderAgeStartDate" class="perf-table-date" data-tab="genderAge" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                        <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                        <input type="date" id="perfTableGenderAgeEndDate" class="perf-table-date" data-tab="genderAge" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                    </div>
                                </div>
                            </div>

                            <!-- 드롭다운 필터 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <!-- 채널별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="channel" data-tab="genderAge" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="channel" data-tab="genderAge" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="channel" data-tab="genderAge" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderAgeChannelList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 제품별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="product" data-tab="genderAge" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="product" data-tab="genderAge" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="product" data-tab="genderAge" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderAgeProductList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 브랜드별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="brand" data-tab="genderAge" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="brand" data-tab="genderAge" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="brand" data-tab="genderAge" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderAgeBrandList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 프로모션별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="promotion" data-tab="genderAge" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="promotion" data-tab="genderAge" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="promotion" data-tab="genderAge" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableGenderAgePromotionList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PIVOT 테이블 -->
                            <div id="perfTableGenderAgeContainer" style="overflow-x: auto; overflow-y: visible;">
                                <div style="text-align: center; padding: 60px 20px; color: var(--grey-500);">
                                    <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">필터를 선택해주세요</div>
                                    <div style="font-size: 13px; color: var(--grey-400);">위의 분류 기준에서 하나 이상의 항목을 선택해주세요.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 플랫폼 테이블 탭 -->
                    <div class="perf-table-tab-content" id="perfTablePlatformTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    플랫폼별 <strong style="color: #1565c0;">상세 성과 지표</strong>를 테이블 형식으로<br>
                                    정렬하고 비교할 수 있습니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>기간을 선택하여 데이터 필터링</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>컬럼 헤더 클릭으로 정렬</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">플랫폼별 성과 테이블</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">플랫폼별 상세 지표를 테이블로 확인할 수 있으며, KPI 버튼을 클릭해 원하는 기준으로 정렬할 수 있습니다.</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="perfTablePlatformStartDate" class="perf-table-date" data-tab="platform" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                        <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                        <input type="date" id="perfTablePlatformEndDate" class="perf-table-date" data-tab="platform" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            <!-- 드롭다운 필터 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                    <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                        🎯 <span id="perfTablePlatformCount">0</span>개 항목
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <!-- 채널별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="channel" data-tab="platform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="channel" data-tab="platform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="channel" data-tab="platform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTablePlatformChannelList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 제품별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="product" data-tab="platform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="product" data-tab="platform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="product" data-tab="platform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTablePlatformProductList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 브랜드별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="brand" data-tab="platform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="brand" data-tab="platform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="brand" data-tab="platform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTablePlatformBrandList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 프로모션별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="promotion" data-tab="platform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="promotion" data-tab="platform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="promotion" data-tab="platform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTablePlatformPromotionList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="perfTablePlatformContainer" style="overflow-x: auto;"></div>
                        </div>
                    </div>

                    <!-- 기기플랫폼 테이블 탭 -->
                    <div class="perf-table-tab-content" id="perfTableDevicePlatformTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    기기플랫폼별 <strong style="color: #1565c0;">상세 성과 지표</strong>를 테이블 형식으로<br>
                                    정렬하고 비교할 수 있습니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>기간을 선택하여 데이터 필터링</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>컬럼 헤더 클릭으로 정렬</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">기기플랫폼별 성과 테이블</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">기기플랫폼별 상세 지표를 테이블로 확인할 수 있으며, KPI 버튼을 클릭해 원하는 기준으로 정렬할 수 있습니다.</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="perfTableDevicePlatformStartDate" class="perf-table-date" data-tab="devicePlatform" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                        <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                        <input type="date" id="perfTableDevicePlatformEndDate" class="perf-table-date" data-tab="devicePlatform" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            <!-- 드롭다운 필터 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                    <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                        🎯 <span id="perfTableDevicePlatformCount">0</span>개 항목
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <!-- 채널별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="channel" data-tab="devicePlatform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="channel" data-tab="devicePlatform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="channel" data-tab="devicePlatform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDevicePlatformChannelList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 제품별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="product" data-tab="devicePlatform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="product" data-tab="devicePlatform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="product" data-tab="devicePlatform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDevicePlatformProductList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 브랜드별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="brand" data-tab="devicePlatform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="brand" data-tab="devicePlatform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="brand" data-tab="devicePlatform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDevicePlatformBrandList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 프로모션별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="promotion" data-tab="devicePlatform" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="promotion" data-tab="devicePlatform" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="promotion" data-tab="devicePlatform" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDevicePlatformPromotionList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="perfTableDevicePlatformContainer" style="overflow-x: auto;"></div>
                        </div>
                    </div>

                    <!-- 기기 테이블 탭 -->
                    <div class="perf-table-tab-content" id="perfTableDeviceTypeTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    기기유형별 <strong style="color: #1565c0;">상세 성과 지표</strong>를 테이블 형식으로<br>
                                    정렬하고 비교할 수 있습니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>기간을 선택하여 데이터 필터링</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>컬럼 헤더 클릭으로 정렬</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">기기유형별 성과 테이블</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">기기유형별 상세 지표를 테이블로 확인할 수 있으며, KPI 버튼을 클릭해 원하는 기준으로 정렬할 수 있습니다.</p>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 12px;">📅 기간 선택</div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="perfTableDeviceTypeStartDate" class="perf-table-date" data-tab="deviceType" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                        <span style="color: var(--grey-600); font-weight: 500;">~</span>
                                        <input type="date" id="perfTableDeviceTypeEndDate" class="perf-table-date" data-tab="deviceType" style="padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            <!-- 드롭다운 필터 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                    <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                        🎯 <span id="perfTableDeviceTypeCount">0</span>개 항목
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <!-- 채널별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="channel" data-tab="deviceType" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="channel" data-tab="deviceType" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="channel" data-tab="deviceType" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDeviceTypeChannelList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 제품별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="product" data-tab="deviceType" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="product" data-tab="deviceType" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="product" data-tab="deviceType" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDeviceTypeProductList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 브랜드별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="brand" data-tab="deviceType" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="brand" data-tab="deviceType" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="brand" data-tab="deviceType" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDeviceTypeBrandList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                    <!-- 프로모션별 드롭다운 -->
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="perf-table-filter-dropdown-btn" data-filter="promotion" data-tab="deviceType" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <span class="perf-table-selected-count" style="font-size: 11px; background: var(--grey-200); padding: 2px 8px; border-radius: 10px; color: var(--grey-600);">0개</span>
                                                <span style="color: var(--grey-400); font-size: 10px;">▼</span>
                                            </div>
                                        </button>
                                        <div class="perf-table-filter-dropdown-list" data-filter="promotion" data-tab="deviceType" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 250px; overflow-y: auto; margin-top: 4px;">
                                            <div style="padding: 8px 10px; border-bottom: 1px solid var(--grey-200); background: var(--grey-50);">
                                                <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--grey-700);">
                                                    <input type="checkbox" class="perf-table-filter-select-all" data-filter="promotion" data-tab="deviceType" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                    전체 선택
                                                </label>
                                            </div>
                                            <div id="perfTableDeviceTypePromotionList" class="perf-table-filter-checkbox-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="perfTableDeviceTypeContainer" style="overflow-x: auto;"></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 성과 비교 분석 (통합 탭) - 독립적 섹션 -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">📊</span>
                        <span>성과 비교 분석 - 다양한 기준으로 성과를 비교하세요</span>
                    </div>
                    <button class="collapsible-toggle">
                        <span>펼치기</span>
                        <span class="collapsible-toggle-icon collapsed">▼</span>
                    </button>
                </div>
                <div class="collapsible-content">
                    <!-- 탭 버튼 -->
                    <div class="view-type-section" style="margin-bottom: 24px;">
                        <button class="view-btn detail-analysis-tab-btn active" data-tab="detail-adset">광고세트</button>
                        <button class="view-btn detail-analysis-tab-btn" data-tab="detail-gender">성별</button>
                        <button class="view-btn detail-analysis-tab-btn" data-tab="detail-age">연령</button>
                        <button class="view-btn detail-analysis-tab-btn" data-tab="detail-platform">플랫폼</button>
                        <button class="view-btn detail-analysis-tab-btn" data-tab="detail-device-platform">기기플랫폼</button>
                        <button class="view-btn detail-analysis-tab-btn" data-tab="detail-device-type">기기</button>
                    </div>

                    <!-- 탭 1: 광고세트 -->
                    <div class="detail-analysis-tab-content active" id="detailAdsetTab">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    <strong style="color: #1565c0;">광고세트별 성과</strong>를 비교하여<br>
                                    최적의 광고세트를 파악할 수 있습니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                    <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                        <span>드롭다운에서 필터 선택</span>
                                    </div>
                                    <div style="display: flex; align-items: start; gap: 8px;">
                                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                        <span>막대 차트로 성과 비교</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">광고세트별 성과 비교</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">
                                        각 광고세트의 성과를 비교하여 최적의 세트를 파악하세요.
                                    </p>
                                </div>
                            </div>

                            <!-- 지표 선택 + 기간 선택 통합 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 16px; border-radius: 8px;">
                                <!-- 왼쪽: 지표 선택 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="detailAdsetMetricDropdown" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 120px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                        <select id="detailAdsetSortDropdown" class="detail-sort-dropdown" data-tab="adset" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 100px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 오른쪽: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📅 기간 선택</span>
                                        <button type="button" class="detail-compare-btn" data-tab="adset" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #4DABF5; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset" data-tab="adset" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailAdsetStartDate" class="detail-start-date" data-tab="adset" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailAdsetEndDate" class="detail-end-date" data-tab="adset" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="detail-compare-row" data-tab="adset" style="display: none; align-items: center; gap: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset-comp" data-tab="adset" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailAdsetStartDateComp" class="detail-start-date-comp" data-tab="adset" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailAdsetEndDateComp" class="detail-end-date-comp" data-tab="adset" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 분류 기준</div>
                                    <div style="font-size: 12px; color: #2e7d32; font-weight: 600;">
                                        🎯 <span id="detailFilteredAdsetCount">0</span>개 광고세트
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap;">
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailFilterChannelList" class="detail-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailFilterProductList" class="detail-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailFilterBrandList" class="detail-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; color: var(--grey-800); cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailFilterPromotionList" class="detail-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="chart-container" style="height: 400px; border: 1px solid var(--grey-200); border-radius: 8px; padding: 16px;">
                                <canvas id="detailAdsetBarChart"></canvas>
                            </div>
                            <!-- 더보기/접기 버튼 -->
                            <div id="detailAdsetShowMoreContainer" style="display: none; text-align: center; margin-top: 12px;">
                                <button id="detailAdsetShowMoreBtn" class="detail-show-more-btn" data-tab="adset" style="padding: 8px 24px; font-size: 13px; font-weight: 500; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; background: white; color: #495057; transition: all 0.2s;">
                                    <span class="btn-text">더보기</span>
                                    <span class="btn-count" style="color: #868e96; margin-left: 4px;"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 2: 성별 -->
                    <div class="detail-analysis-tab-content" id="detailGenderTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    <strong style="color: #1565c0;">성별 성과</strong>를 비교하여 타겟팅을 최적화합니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242;">지표와 필터를 선택하여 성별 성과를 비교하세요</div>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">성별 성과 비교</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">각 성별의 성과를 비교합니다.</p>
                                </div>
                            </div>
                            <!-- 지표 선택 + 기간 선택 통합 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <!-- 왼쪽: 지표 선택 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="detailGenderMetricDropdown" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 120px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                        <select id="detailGenderSortDropdown" class="detail-sort-dropdown" data-tab="gender" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 100px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 오른쪽: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📅 기간 선택</span>
                                        <button type="button" class="detail-compare-btn" data-tab="gender" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #4DABF5; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset" data-tab="gender" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailGenderStartDate" class="detail-start-date" data-tab="gender" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailGenderEndDate" class="detail-end-date" data-tab="gender" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="detail-compare-row" data-tab="gender" style="display: none; align-items: center; gap: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset-comp" data-tab="gender" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailGenderStartDateComp" class="detail-start-date-comp" data-tab="gender" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailGenderEndDateComp" class="detail-end-date-comp" data-tab="gender" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 14px;">📊 분류 기준</div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-gender-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-gender-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-gender-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailGenderFilterChannelList" class="detail-gender-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-gender-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-gender-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-gender-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailGenderFilterProductList" class="detail-gender-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-gender-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-gender-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-gender-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailGenderFilterBrandList" class="detail-gender-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-gender-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-gender-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-gender-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailGenderFilterPromotionList" class="detail-gender-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-gender-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">광고세트_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-gender-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-gender-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailGenderFilterAdsetList" class="detail-gender-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 300px; border: 1px solid var(--grey-200); border-radius: 8px; padding: 16px;">
                                <canvas id="detailGenderBarChart"></canvas>
                            </div>
                            <!-- 더보기/접기 버튼 -->
                            <div id="detailGenderShowMoreContainer" style="display: none; text-align: center; margin-top: 12px;">
                                <button id="detailGenderShowMoreBtn" class="detail-show-more-btn" data-tab="gender" style="padding: 8px 24px; font-size: 13px; font-weight: 500; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; background: white; color: #495057; transition: all 0.2s;">
                                    <span class="btn-text">더보기</span>
                                    <span class="btn-count" style="color: #868e96; margin-left: 4px;"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 3: 연령 -->
                    <div class="detail-analysis-tab-content" id="detailAgeTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    <strong style="color: #1565c0;">연령대별 성과</strong>를 비교하여 타겟팅을 최적화합니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242;">지표와 필터를 선택하여 연령대 성과를 비교하세요</div>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">연령대별 성과 비교</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">각 연령대의 성과를 비교합니다.</p>
                                </div>
                            </div>
                            <!-- 지표 선택 + 기간 선택 통합 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <!-- 왼쪽: 지표 선택 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="detailAgeMetricDropdown" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 120px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                        <select id="detailAgeSortDropdown" class="detail-sort-dropdown" data-tab="age" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 100px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 오른쪽: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📅 기간 선택</span>
                                        <button type="button" class="detail-compare-btn" data-tab="age" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #4DABF5; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset" data-tab="age" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailAgeStartDate" class="detail-start-date" data-tab="age" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailAgeEndDate" class="detail-end-date" data-tab="age" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="detail-compare-row" data-tab="age" style="display: none; align-items: center; gap: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset-comp" data-tab="age" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailAgeStartDateComp" class="detail-start-date-comp" data-tab="age" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailAgeEndDateComp" class="detail-end-date-comp" data-tab="age" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 14px;">📊 분류 기준</div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-age-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-age-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-age-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailAgeFilterChannelList" class="detail-age-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-age-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-age-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-age-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailAgeFilterProductList" class="detail-age-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-age-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-age-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-age-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailAgeFilterBrandList" class="detail-age-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-age-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-age-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-age-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailAgeFilterPromotionList" class="detail-age-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-age-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">광고세트_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-age-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-age-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailAgeFilterAdsetList" class="detail-age-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 350px; border: 1px solid var(--grey-200); border-radius: 8px; padding: 16px;">
                                <canvas id="detailAgeBarChart"></canvas>
                            </div>
                            <!-- 더보기/접기 버튼 -->
                            <div id="detailAgeShowMoreContainer" style="display: none; text-align: center; margin-top: 12px;">
                                <button id="detailAgeShowMoreBtn" class="detail-show-more-btn" data-tab="age" style="padding: 8px 24px; font-size: 13px; font-weight: 500; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; background: white; color: #495057; transition: all 0.2s;">
                                    <span class="btn-text">더보기</span>
                                    <span class="btn-count" style="color: #868e96; margin-left: 4px;"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 4: 플랫폼 -->
                    <div class="detail-analysis-tab-content" id="detailPlatformTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    <strong style="color: #1565c0;">플랫폼별 성과</strong>를 비교합니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242;">지표와 필터를 선택하여 플랫폼 성과를 비교하세요</div>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">플랫폼별 성과 비교</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">각 플랫폼의 성과를 비교합니다.</p>
                                </div>
                            </div>
                            <!-- 지표 선택 + 기간 선택 통합 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <!-- 왼쪽: 지표 선택 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="detailPlatformMetricDropdown" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 120px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                        <select id="detailPlatformSortDropdown" class="detail-sort-dropdown" data-tab="platform" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 100px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 오른쪽: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📅 기간 선택</span>
                                        <button type="button" class="detail-compare-btn" data-tab="platform" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #4DABF5; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset" data-tab="platform" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailPlatformStartDate" class="detail-start-date" data-tab="platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailPlatformEndDate" class="detail-end-date" data-tab="platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="detail-compare-row" data-tab="platform" style="display: none; align-items: center; gap: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset-comp" data-tab="platform" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailPlatformStartDateComp" class="detail-start-date-comp" data-tab="platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailPlatformEndDateComp" class="detail-end-date-comp" data-tab="platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 14px;">📊 분류 기준</div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-platform-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-platform-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-platform-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailPlatformFilterChannelList" class="detail-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-platform-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-platform-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-platform-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailPlatformFilterProductList" class="detail-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-platform-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-platform-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-platform-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailPlatformFilterBrandList" class="detail-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-platform-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-platform-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-platform-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailPlatformFilterPromotionList" class="detail-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-platform-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">광고세트_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-platform-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-platform-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailPlatformFilterAdsetList" class="detail-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 300px; border: 1px solid var(--grey-200); border-radius: 8px; padding: 16px;">
                                <canvas id="detailPlatformBarChart"></canvas>
                            </div>
                            <!-- 더보기/접기 버튼 -->
                            <div id="detailPlatformShowMoreContainer" style="display: none; text-align: center; margin-top: 12px;">
                                <button id="detailPlatformShowMoreBtn" class="detail-show-more-btn" data-tab="platform" style="padding: 8px 24px; font-size: 13px; font-weight: 500; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; background: white; color: #495057; transition: all 0.2s;">
                                    <span class="btn-text">더보기</span>
                                    <span class="btn-count" style="color: #868e96; margin-left: 4px;"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 5: 기기플랫폼 -->
                    <div class="detail-analysis-tab-content" id="detailDevicePlatformTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    <strong style="color: #1565c0;">기기플랫폼별 성과</strong>를 비교합니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242;">지표와 필터를 선택하여 기기플랫폼 성과를 비교하세요</div>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">기기플랫폼별 성과 비교</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">각 기기플랫폼의 성과를 비교합니다.</p>
                                </div>
                            </div>
                            <!-- 지표 선택 + 기간 선택 통합 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <!-- 왼쪽: 지표 선택 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="detailDevicePlatformMetricDropdown" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 120px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                        <select id="detailDevicePlatformSortDropdown" class="detail-sort-dropdown" data-tab="devicePlatform" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 100px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 오른쪽: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📅 기간 선택</span>
                                        <button type="button" class="detail-compare-btn" data-tab="device-platform" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #4DABF5; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset" data-tab="device-platform" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailDevicePlatformStartDate" class="detail-start-date" data-tab="device-platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailDevicePlatformEndDate" class="detail-end-date" data-tab="device-platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="detail-compare-row" data-tab="device-platform" style="display: none; align-items: center; gap: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset-comp" data-tab="device-platform" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailDevicePlatformStartDateComp" class="detail-start-date-comp" data-tab="device-platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailDevicePlatformEndDateComp" class="detail-end-date-comp" data-tab="device-platform" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 14px;">📊 분류 기준</div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-platform-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-platform-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-platform-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDevicePlatformFilterChannelList" class="detail-device-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-platform-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-platform-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-platform-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDevicePlatformFilterProductList" class="detail-device-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-platform-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-platform-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-platform-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDevicePlatformFilterBrandList" class="detail-device-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-platform-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-platform-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-platform-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDevicePlatformFilterPromotionList" class="detail-device-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-platform-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">광고세트_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-platform-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-platform-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDevicePlatformFilterAdsetList" class="detail-device-platform-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 300px; border: 1px solid var(--grey-200); border-radius: 8px; padding: 16px;">
                                <canvas id="detailDevicePlatformBarChart"></canvas>
                            </div>
                            <!-- 더보기/접기 버튼 -->
                            <div id="detailDevicePlatformShowMoreContainer" style="display: none; text-align: center; margin-top: 12px;">
                                <button id="detailDevicePlatformShowMoreBtn" class="detail-show-more-btn" data-tab="devicePlatform" style="padding: 8px 24px; font-size: 13px; font-weight: 500; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; background: white; color: #495057; transition: all 0.2s;">
                                    <span class="btn-text">더보기</span>
                                    <span class="btn-count" style="color: #868e96; margin-left: 4px;"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 6: 기기 -->
                    <div class="detail-analysis-tab-content" id="detailDeviceTypeTab" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">📊</span>
                                    <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                                </div>
                                <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                    <strong style="color: #1565c0;">기기별 성과</strong>를 비교합니다
                                </p>
                            </div>
                            <div style="padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <span style="font-size: 16px;">💡</span>
                                    <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                                </div>
                                <div style="font-size: 12px; color: #424242;">지표와 필터를 선택하여 기기 성과를 비교하세요</div>
                            </div>
                        </div>
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--grey-200); padding-bottom: 16px;">
                                <div>
                                    <div class="card-title" style="margin-bottom: 4px;">기기별 성과 비교</div>
                                    <p style="color: var(--grey-600); font-size: 13px; margin: 0;">각 기기의 성과를 비교합니다.</p>
                                </div>
                            </div>
                            <!-- 지표 선택 + 기간 선택 통합 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <!-- 왼쪽: 지표 선택 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select id="detailDeviceTypeMetricDropdown" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 120px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                            <option value="impressions">노출수</option>
                                            <option value="clicks">클릭수</option>
                                            <option value="cpm">CPM</option>
                                            <option value="cpc">CPC</option>
                                            <option value="ctr">CTR</option>
                                            <option value="cvr">전환율</option>
                                        </select>
                                        <select id="detailDeviceTypeSortDropdown" class="detail-sort-dropdown" data-tab="deviceType" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 100px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 오른쪽: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📅 기간 선택</span>
                                        <button type="button" class="detail-compare-btn" data-tab="device-type" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #4DABF5; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset" data-tab="device-type" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailDeviceTypeStartDate" class="detail-start-date" data-tab="device-type" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailDeviceTypeEndDate" class="detail-end-date" data-tab="device-type" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="detail-compare-row" data-tab="device-type" style="display: none; align-items: center; gap: 8px;">
                                        <span style="width: 10px; height: 10px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="detail-period-preset-comp" data-tab="device-type" style="padding: 6px 28px 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; background: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2710%27 height=%2710%27 viewBox=%270 0 10 10%27%3E%3Cpath d=%27M2.5 4L5 6.5L7.5 4%27 stroke=%27%23666%27 stroke-width=%271.2%27 fill=%27none%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 8px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" id="detailDeviceTypeStartDateComp" class="detail-start-date-comp" data-tab="device-type" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                        <span style="color: #999; font-size: 12px;">~</span>
                                        <input type="date" id="detailDeviceTypeEndDateComp" class="detail-end-date-comp" data-tab="device-type" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--grey-50); border-radius: 8px; border: 1px solid var(--grey-200);">
                                <div style="font-size: 13px; font-weight: 600; color: var(--grey-700); margin-bottom: 14px;">📊 분류 기준</div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-type-filter-dropdown-btn" data-filter="channel" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">채널_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-type-filter-dropdown-list" data-filter="channel" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-type-filter-select-all" data-filter="channel" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDeviceTypeFilterChannelList" class="detail-device-type-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-type-filter-dropdown-btn" data-filter="product" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">제품_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-type-filter-dropdown-list" data-filter="product" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-type-filter-select-all" data-filter="product" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDeviceTypeFilterProductList" class="detail-device-type-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-type-filter-dropdown-btn" data-filter="brand" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">브랜드_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-type-filter-dropdown-list" data-filter="brand" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-type-filter-select-all" data-filter="brand" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDeviceTypeFilterBrandList" class="detail-device-type-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-type-filter-dropdown-btn" data-filter="promotion" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">프로모션_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-type-filter-dropdown-list" data-filter="promotion" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-type-filter-select-all" data-filter="promotion" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDeviceTypeFilterPromotionList" class="detail-device-type-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="position: relative; min-width: 180px; flex: 1;">
                                        <button type="button" class="detail-device-type-filter-dropdown-btn" data-filter="adset" style="width: 100%; padding: 10px 14px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;">
                                            <span style="font-weight: 500;">광고세트_전체</span>
                                            <span style="font-size: 10px;">▼</span>
                                        </button>
                                        <div class="detail-device-type-filter-dropdown-list" data-filter="adset" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid var(--grey-300); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 100;">
                                            <div style="padding: 8px;">
                                                <div style="position: sticky; top: 0; background: white; padding: 6px 0; border-bottom: 1px solid var(--grey-200); margin-bottom: 6px;">
                                                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-weight: 600; font-size: 12px;">
                                                        <input type="checkbox" class="detail-device-type-filter-select-all" data-filter="adset" style="margin-right: 10px; width: 16px; height: 16px;">
                                                        전체 선택
                                                    </label>
                                                </div>
                                                <div id="detailDeviceTypeFilterAdsetList" class="detail-device-type-filter-checkbox-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 300px; border: 1px solid var(--grey-200); border-radius: 8px; padding: 16px;">
                                <canvas id="detailDeviceTypeBarChart"></canvas>
                            </div>
                            <!-- 더보기/접기 버튼 -->
                            <div id="detailDeviceTypeShowMoreContainer" style="display: none; text-align: center; margin-top: 12px;">
                                <button id="detailDeviceTypeShowMoreBtn" class="detail-show-more-btn" data-tab="deviceType" style="padding: 8px 24px; font-size: 13px; font-weight: 500; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; background: white; color: #495057; transition: all 0.2s;">
                                    <span class="btn-text">더보기</span>
                                    <span class="btn-count" style="color: #868e96; margin-left: 4px;"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 1. 성과 분석 (브랜드/상품/프로모션/타겟팅) -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">🏆</span>
                        <span>성과 구분 (브랜드/상품/프로모션/타겟팅) 비교 분석 - 비즈니스 현황을 빠르게 판단하세요</span>
                    </div>
                    <button class="collapsible-toggle">
                        <span>펼치기</span>
                        <span class="collapsible-toggle-icon collapsed">▼</span>
                    </button>
                </div>
                <div class="collapsible-content">
                    <!-- 서브탭 버튼 (상단 배치) -->
                    <div class="view-type-section" style="margin-bottom: 0; padding: 20px 24px;">
                        <button class="view-btn performance-subtab active" data-perf-tab="brand">브랜드</button>
                        <button class="view-btn performance-subtab" data-perf-tab="product">상품</button>
                        <button class="view-btn performance-subtab" data-perf-tab="promotion">프로모션</button>
                        <button class="view-btn performance-subtab" data-perf-tab="targeting">타겟팅</button>
                    </div>

                    <!-- 분석 목적/사용 방법 카드 -->
                    <div style="display: flex; gap: 16px; padding: 20px 24px; background: #fafafa; border-bottom: 1px solid #e9ecef;">
                        <!-- 분석 목적 카드 -->
                        <div style="flex: 1; padding: 14px 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span style="font-size: 16px;">📊</span>
                                <strong style="color: #1976d2; font-size: 13px;">이 분석의 목적</strong>
                            </div>
                            <p style="margin: 0; font-size: 12px; color: #424242; line-height: 1.6;">
                                <strong style="color: #1565c0;">브랜드/상품/프로모션/타겟팅별 성과</strong>를 비교하여<br>
                                가장 효율적인 광고 요소를 파악할 수 있습니다
                            </p>
                        </div>
                        <!-- 사용 방법 카드 -->
                        <div style="flex: 1; padding: 14px 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid #4caf50; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span style="font-size: 16px;">💡</span>
                                <strong style="color: #388e3c; font-size: 13px;">사용 방법</strong>
                            </div>
                            <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                                <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">1</span>
                                    <span>상단 탭에서 분석할 항목 선택</span>
                                </div>
                                <div style="display: flex; align-items: start; gap: 8px;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: #4caf50; color: white; border-radius: 50%; font-size: 10px; font-weight: 600; flex-shrink: 0;">2</span>
                                    <span>KPI 버튼으로 지표 변경, 비교 버튼으로 기간 비교</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 브랜드 뷰 -->
                    <div class="performance-filter-content active" id="brandView">
                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <!-- 지표 선택 + 정렬 + 기간 선택 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <!-- 좌측: 지표 선택 + 정렬 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 12px; font-weight: 600; color: #555;">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select class="perf-kpi-select" data-category="brand" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 140px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                        </select>
                                        <select class="perf-sort-select" data-category="brand" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 110px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 우측: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end; padding: 10px 16px;">
                                    <!-- 타이틀 + 비교 버튼 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 13px;">📅</span>
                                            <span style="font-size: 13px; font-weight: 600; color: #333;">기간 선택</span>
                                        </div>
                                        <button class="perf-compare-btn" data-category="brand" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #00C853; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset" data-category="brand" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date" data-category="brand" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date" data-category="brand" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="perf-compare-row" data-category="brand" style="display: none; align-items: center; gap: 12px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset-comp" data-category="brand" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date-comp" data-category="brand" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date-comp" data-category="brand" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <!-- 막대 그래프 -->
                            <div style="padding: 20px;">
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="brandPerformanceChart"></canvas>
                                </div>
                                <!-- 더보기 버튼 -->
                                <div id="perfBrandShowMoreContainer" style="display: none; justify-content: center; margin-top: 12px;">
                                    <button class="perf-show-more-btn" data-category="brand" style="padding: 8px 20px; font-size: 13px; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; background: #e3f2fd; color: #1976d2;">더보기</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 상품 뷰 -->
                    <div class="performance-filter-content" id="productView" style="display: none;">
                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <!-- 지표 선택 + 정렬 + 기간 선택 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <!-- 좌측: 지표 선택 + 정렬 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 12px; font-weight: 600; color: #555;">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select class="perf-kpi-select" data-category="product" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 140px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                        </select>
                                        <select class="perf-sort-select" data-category="product" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 110px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 우측: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end; padding: 10px 16px;">
                                    <!-- 타이틀 + 비교 버튼 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 13px;">📅</span>
                                            <span style="font-size: 13px; font-weight: 600; color: #333;">기간 선택</span>
                                        </div>
                                        <button class="perf-compare-btn" data-category="product" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #00C853; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset" data-category="product" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date" data-category="product" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date" data-category="product" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="perf-compare-row" data-category="product" style="display: none; align-items: center; gap: 12px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset-comp" data-category="product" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date-comp" data-category="product" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date-comp" data-category="product" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <!-- 막대 그래프 -->
                            <div style="padding: 20px;">
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="productPerformanceChart"></canvas>
                                </div>
                                <!-- 더보기 버튼 -->
                                <div id="perfProductShowMoreContainer" style="display: none; justify-content: center; margin-top: 12px;">
                                    <button class="perf-show-more-btn" data-category="product" style="padding: 8px 20px; font-size: 13px; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; background: #e3f2fd; color: #1976d2;">더보기</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 프로모션 뷰 -->
                    <div class="performance-filter-content" id="promotionView" style="display: none;">
                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <!-- 지표 선택 + 정렬 + 기간 선택 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <!-- 좌측: 지표 선택 + 정렬 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 12px; font-weight: 600; color: #555;">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select class="perf-kpi-select" data-category="promotion" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 140px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                        </select>
                                        <select class="perf-sort-select" data-category="promotion" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 110px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 우측: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end; padding: 10px 16px;">
                                    <!-- 타이틀 + 비교 버튼 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 13px;">📅</span>
                                            <span style="font-size: 13px; font-weight: 600; color: #333;">기간 선택</span>
                                        </div>
                                        <button class="perf-compare-btn" data-category="promotion" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #00C853; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset" data-category="promotion" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date" data-category="promotion" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date" data-category="promotion" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="perf-compare-row" data-category="promotion" style="display: none; align-items: center; gap: 12px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset-comp" data-category="promotion" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date-comp" data-category="promotion" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date-comp" data-category="promotion" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <!-- 막대 그래프 -->
                            <div style="padding: 20px;">
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="promotionPerformanceChart"></canvas>
                                </div>
                                <!-- 더보기 버튼 -->
                                <div id="perfPromotionShowMoreContainer" style="display: none; justify-content: center; margin-top: 12px;">
                                    <button class="perf-show-more-btn" data-category="promotion" style="padding: 8px 20px; font-size: 13px; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; background: #e3f2fd; color: #1976d2;">더보기</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 타겟팅 뷰 -->
                    <div class="performance-filter-content" id="targetingView" style="display: none;">
                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <!-- 지표 선택 + 정렬 + 기간 선택 -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <!-- 좌측: 지표 선택 + 정렬 -->
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <span style="font-size: 12px; font-weight: 600; color: #555;">📊 지표 선택</span>
                                    <div style="display: flex; gap: 10px;">
                                        <select class="perf-kpi-select" data-category="targeting" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 140px; background: white;">
                                            <option value="roas">ROAS</option>
                                            <option value="cpa">CPA</option>
                                            <option value="cost">비용</option>
                                            <option value="conversions">전환수</option>
                                            <option value="revenue">전환값</option>
                                        </select>
                                        <select class="perf-sort-select" data-category="targeting" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; cursor: pointer; min-width: 110px; background: white;">
                                            <option value="desc">내림차순</option>
                                            <option value="asc">오름차순</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- 우측: 기간 선택 -->
                                <div style="display: flex; flex-direction: column; align-items: flex-end; padding: 10px 16px;">
                                    <!-- 타이틀 + 비교 버튼 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 13px;">📅</span>
                                            <span style="font-size: 13px; font-weight: 600; color: #333;">기간 선택</span>
                                        </div>
                                        <button class="perf-compare-btn" data-category="targeting" style="padding: 4px 12px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 4px; cursor: pointer; background: white; color: #673ab7;">비교</button>
                                    </div>
                                    <!-- 기준 기간 행 -->
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #00C853; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset" data-category="targeting" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date" data-category="targeting" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date" data-category="targeting" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                    <!-- 비교 기간 행 -->
                                    <div class="perf-compare-row" data-category="targeting" style="display: none; align-items: center; gap: 12px;">
                                        <span style="width: 12px; height: 12px; border: 2px solid #dee2e6; border-radius: 50%; background: white; flex-shrink: 0;"></span>
                                        <select class="perf-period-preset-comp" data-category="targeting" style="width: 120px; padding: 8px 32px 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: white; background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath d=%27M3 4.5L6 7.5L9 4.5%27 stroke=%27%23666%27 stroke-width=%271.5%27 fill=%27none%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                                            <option value="" selected>항목 선택</option>
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                        <input type="date" class="perf-start-date-comp" data-category="targeting" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                        <span style="width: 20px; text-align: center; color: #999; font-size: 13px;">~</span>
                                        <input type="date" class="perf-end-date-comp" data-category="targeting" style="width: 130px; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 13px; color: #666; background: white;">
                                    </div>
                                </div>
                            </div>
                            <!-- 막대 그래프 -->
                            <div style="padding: 20px;">
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="targetingPerformanceChart"></canvas>
                                </div>
                                <!-- 더보기 버튼 -->
                                <div id="perfTargetingShowMoreContainer" style="display: none; justify-content: center; margin-top: 12px;">
                                    <button class="perf-show-more-btn" data-category="targeting" style="padding: 8px 20px; font-size: 13px; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; background: #e3f2fd; color: #1976d2;">더보기</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 리타겟팅 분석 -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title">
                        <span class="collapsible-icon">🎯</span>
                        <span>리타겟팅 분석 - 리타겟팅 캠페인의 타겟을 확인하세요</span>
                    </div>
                    <button class="collapsible-toggle">
                        <span>펼치기</span>
                        <span class="collapsible-toggle-icon collapsed">▼</span>
                    </button>
                </div>
                <div class="collapsible-content">
                    <!-- 서브탭 버튼 -->
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 16px 24px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                        <button class="retargeting-subtab active" data-retarget-tab="ageGender"
                                style="padding: 8px 16px; font-size: 12px; font-weight: 600; border: none; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">
                            성별/연령
                        </button>
                        <button class="retargeting-subtab" data-retarget-tab="device"
                                style="padding: 8px 16px; font-size: 12px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                            기기별
                        </button>
                        <button class="retargeting-subtab" data-retarget-tab="platform"
                                style="padding: 8px 16px; font-size: 12px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                            플랫폼별
                        </button>
                        <button class="retargeting-subtab" data-retarget-tab="devicePlatform"
                                style="padding: 8px 16px; font-size: 12px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                            노출기기별
                        </button>
                    </div>

                    <!-- 성별/연령 리타겟팅 뷰 -->
                    <div class="retargeting-tab-content active" id="ageGenderRetargetView">
                        <!-- 자연어 인사이트 -->
                        <div style="padding: 20px 24px; background: linear-gradient(135deg, #fce4ec 0%, #fff5f7 100%); border-bottom: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #c2185b; font-weight: 600; margin-bottom: 8px;">💡 성별/연령 타겟팅 인사이트</div>
                            <div style="font-size: 13px; color: #424242; line-height: 1.7;" id="ageGenderRetargetInsightText">로딩 중...</div>
                        </div>

                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">성별/연령 조합별 성과</h4>
                                <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">어떤 연령대와 성별 조합이 가장 효과적인지 확인하세요</p>
                            </div>
                            <div style="padding: 16px 20px; overflow-x: auto;">
                                <table class="data-table" id="ageGenderRetargetTable" style="margin-top: 0;">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 140px;">연령/성별</th>
                                            <th class="sortable-header" data-table="ageGender" data-column="roas" style="min-width: 100px; text-align: right;">
                                                ROAS
                                                <div class="sort-icon active"><div class="sort-arrow up"></div><div class="sort-arrow down active"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="ageGender" data-column="cpa" style="min-width: 100px; text-align: right;">
                                                CPA
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="ageGender" data-column="cost" style="min-width: 120px; text-align: right;">
                                                광고비
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="ageGender" data-column="conversions" style="min-width: 80px; text-align: right;">
                                                전환수
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="ageGender" data-column="revenue" style="min-width: 120px; text-align: right;">
                                                전환값
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th style="min-width: 80px; text-align: center;">효율등급</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ageGenderRetargetTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 기기별 리타겟팅 뷰 -->
                    <div class="retargeting-tab-content" id="deviceRetargetView" style="display: none;">
                        <!-- 자연어 인사이트 -->
                        <div style="padding: 20px 24px; background: linear-gradient(135deg, #e3f2fd 0%, #f5f9ff 100%); border-bottom: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #1565c0; font-weight: 600; margin-bottom: 8px;">💡 기기별 리타겟팅 인사이트</div>
                            <div style="font-size: 13px; color: #424242; line-height: 1.7;" id="deviceRetargetInsightText">로딩 중...</div>
                        </div>

                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">기기별 리타겟팅 성과</h4>
                                <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">Android, iPhone, Computers, Tablets 등 기기별 광고 효율</p>
                            </div>
                            <div style="padding: 16px 20px; overflow-x: auto;">
                                <table class="data-table" id="deviceRetargetTable" style="margin-top: 0;">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 150px;">기기</th>
                                            <th class="sortable-header" data-table="device" data-column="roas" style="min-width: 100px; text-align: right;">
                                                ROAS
                                                <div class="sort-icon active"><div class="sort-arrow up"></div><div class="sort-arrow down active"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="device" data-column="cpa" style="min-width: 100px; text-align: right;">
                                                CPA
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="device" data-column="cost" style="min-width: 120px; text-align: right;">
                                                광고비
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="device" data-column="conversions" style="min-width: 80px; text-align: right;">
                                                전환수
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="device" data-column="revenue" style="min-width: 120px; text-align: right;">
                                                전환값
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th style="min-width: 80px; text-align: center;">효율등급</th>
                                        </tr>
                                    </thead>
                                    <tbody id="deviceRetargetTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 플랫폼별 리타겟팅 뷰 -->
                    <div class="retargeting-tab-content" id="platformRetargetView" style="display: none;">
                        <!-- 자연어 인사이트 -->
                        <div style="padding: 20px 24px; background: linear-gradient(135deg, #f3e5f5 0%, #faf5ff 100%); border-bottom: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #7b1fa2; font-weight: 600; margin-bottom: 8px;">💡 플랫폼별 리타겟팅 인사이트</div>
                            <div style="font-size: 13px; color: #424242; line-height: 1.7;" id="platformRetargetInsightText">로딩 중...</div>
                        </div>

                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">플랫폼별 리타겟팅 성과</h4>
                                <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">Cross-network, YouTube, Display 등 플랫폼별 광고 효율</p>
                            </div>
                            <div style="padding: 16px 20px; overflow-x: auto;">
                                <table class="data-table" id="platformRetargetTable" style="margin-top: 0;">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 140px;">플랫폼</th>
                                            <th class="sortable-header" data-table="platform" data-column="roas" style="min-width: 100px; text-align: right;">
                                                ROAS
                                                <div class="sort-icon active"><div class="sort-arrow up"></div><div class="sort-arrow down active"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="platform" data-column="cpa" style="min-width: 100px; text-align: right;">
                                                CPA
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="platform" data-column="cost" style="min-width: 120px; text-align: right;">
                                                광고비
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="platform" data-column="conversions" style="min-width: 80px; text-align: right;">
                                                전환수
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="platform" data-column="revenue" style="min-width: 120px; text-align: right;">
                                                전환값
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th style="min-width: 80px; text-align: center;">효율등급</th>
                                        </tr>
                                    </thead>
                                    <tbody id="platformRetargetTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 노출기기별 리타겟팅 뷰 -->
                    <div class="retargeting-tab-content" id="devicePlatformRetargetView" style="display: none;">
                        <!-- 자연어 인사이트 -->
                        <div style="padding: 20px 24px; background: linear-gradient(135deg, #e0f2f1 0%, #f5fffd 100%); border-bottom: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #00796b; font-weight: 600; margin-bottom: 8px;">💡 노출기기별 리타겟팅 인사이트</div>
                            <div style="font-size: 13px; color: #424242; line-height: 1.7;" id="devicePlatformRetargetInsightText">로딩 중...</div>
                        </div>

                        <div class="card" style="margin: 16px; border-radius: 12px;">
                            <div style="padding: 16px 20px; border-bottom: 1px solid #e9ecef;">
                                <h4 style="font-size: 14px; font-weight: 600; color: var(--grey-800); margin: 0;">노출기기별 리타겟팅 성과</h4>
                                <p style="font-size: 12px; color: var(--grey-600); margin: 4px 0 0 0;">Mobile app, Mobile web, Desktop 등 노출기기별 광고 효율</p>
                            </div>
                            <div style="padding: 16px 20px; overflow-x: auto;">
                                <table class="data-table" id="devicePlatformRetargetTable" style="margin-top: 0;">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 140px;">노출기기</th>
                                            <th class="sortable-header" data-table="devicePlatform" data-column="roas" style="min-width: 100px; text-align: right;">
                                                ROAS
                                                <div class="sort-icon active"><div class="sort-arrow up"></div><div class="sort-arrow down active"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="devicePlatform" data-column="cpa" style="min-width: 100px; text-align: right;">
                                                CPA
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="devicePlatform" data-column="cost" style="min-width: 120px; text-align: right;">
                                                광고비
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="devicePlatform" data-column="conversions" style="min-width: 80px; text-align: right;">
                                                전환수
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th class="sortable-header" data-table="devicePlatform" data-column="revenue" style="min-width: 120px; text-align: right;">
                                                전환값
                                                <div class="sort-icon"><div class="sort-arrow up"></div><div class="sort-arrow down"></div></div>
                                            </th>
                                            <th style="min-width: 80px; text-align: center;">효율등급</th>
                                        </tr>
                                    </thead>
                                    <tbody id="devicePlatformRetargetTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        
            </div>

            <!-- ========== 퍼널 대시보드 (funnel_dashboard.html) ========== -->
            <div class="page-section" data-page="funnel">
                
            <div class="container">
                <!-- 헤더 -->
                <div class="header">
                    <div>
                        <h1>고객 구매 여정 분석 대시보드</h1>
                        <div class="header-subtitle">방문자가 고객이 되기까지의 전 과정을 한눈에 분석 <span id="analysisPeriod" style="color: var(--primary-main); font-weight: 600;"></span></div>
                        <div style="margin-top: 8px; font-size: 13px; color: var(--grey-600); line-height: 1.6;">
                            💡 <strong>이 대시보드는</strong> 웹사이트 방문자가 실제 구매까지 이르는 과정을 5단계로 나누어 보여줍니다. 각 단계에서 얼마나 많은 고객을 잃는지, 어떤 채널이 효과적인지 파악할 수 있습니다.
                        </div>
                    </div>
                </div>

                <!-- 0. 성과 요약 배너 -->
                <div id="summaryCardBanner" style="display: none; margin-bottom: 24px; padding: 20px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <div id="summaryCardTitle" style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">이번 달 성과 요약</div>
                            <div id="summaryCardMessage" style="font-size: 15px; opacity: 0.95;"></div>
                        </div>
                        <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">방문자</div>
                                <div id="summaryCardVisitors" style="font-size: 20px; font-weight: 700;"></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">구매자</div>
                                <div id="summaryCardPurchasers" style="font-size: 20px; font-weight: 700;"></div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">전환율</div>
                                <div id="summaryCardCVR" style="font-size: 20px; font-weight: 700;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1. 핵심 KPI 요약 -->
                <div class="kpi-summary-grid" id="kpiSummaryGrid">
                    <!-- JS로 동적 생성 -->
                </div>

                <!-- 2. 인터랙티브 퍼널 시각화 (D3.js) - KPI 바로 다음 배치 -->
                <div class="chart-section card">
                    <div class="chart-header">
                        📊 고객 구매 여정 5단계
                        <div style="float: right; display: flex; align-items: center; gap: 8px;">
                            <button id="funnelCompareBtn" class="view-btn" style="font-size: 14px; padding: 8px 20px;">
                                비교
                            </button>
                            <button id="funnelFilterBtn" class="view-btn" style="font-size: 14px; padding: 8px 20px;">
                                필터
                            </button>
                            <select id="funnelChannelFilter" style="display: none; padding: 8px 12px; font-size: 13px; border: 1px solid #dee2e6; border-radius: 6px; background: white; cursor: pointer; min-width: 150px;">
                                <option value="">채널 선택...</option>
                            </select>
                        </div>
                    </div>

                    <!-- 설명 -->
                    <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px;">
                        <strong>각 단계를 마우스로 가리키면</strong> 해당 단계의 전환율과 개선 방법을 확인할 수 있습니다.
                    </div>

                    <!-- 단일 퍼널 뷰 -->
                    <div id="singleFunnelView">
                        <div id="d3FunnelChart"></div>
                    </div>

                    <!-- 비교 퍼널 뷰 -->
                    <div id="compareFunnelView" style="display: none;">                       
                    
                        <!-- 기간 선택 카드 -->
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- 왼쪽 기간 선택 -->
                            <div class="filter-section card">
                                <div class="filter-header">왼쪽 기간 선택</div>
                                <div class="filter-row" style="margin-bottom: 0;">
                                    <div class="filter-group">
                                        <div class="date-range">
                                            <input type="date" id="leftStartDate">
                                            <span>~</span>
                                            <input type="date" id="leftEndDate">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 가운데 빈 공간 -->
                            <div style="min-width: 60px;"></div>

                            <!-- 오른쪽 기간 선택 -->
                            <div class="filter-section card">
                                <div class="filter-header">오른쪽 기간 선택</div>
                                <div class="filter-row" style="margin-bottom: 0;">
                                    <div class="filter-group">
                                        <div class="date-range">
                                            <input type="date" id="rightStartDate">
                                            <span>~</span>
                                            <input type="date" id="rightEndDate">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 퍼널 차트 비교 -->
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start;">
                            <!-- 왼쪽 퍼널 -->
                            <div id="d3FunnelChartLeft"></div>

                            <!-- 가운데 비교 인사이트 -->
                            <div id="comparisonInsights" style="min-width: 320px; max-width: 400px; padding: 16px; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); border-radius: 12px; border: 2px solid #e0e7ff;">
                                <div style="text-align: center; margin-bottom: 12px;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 변화 요약</div>
                                    <div style="font-size: 10px; color: var(--grey-500); margin-top: 2px;">왼쪽 → 오른쪽</div>
                                </div>
                                <div id="comparisonContent" style="font-size: 13px; color: var(--grey-700);"></div>
                            </div>

                            <!-- 오른쪽 퍼널 -->
                            <div id="d3FunnelChartRight"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. 고급 분석 결과 (A/B Testing, Clustering, Churn Prediction) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">🔬</span>
                            <span>데이터 기반 의사결정 도구 (핵심 요약, 긴급 개선, 채널 분석, 예산, CRM 가이드)</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 기간 필터 버튼 -->
                        <div style="margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="font-size: 12px; font-weight: 600; color: #495057;">📅 분석 기간:</span>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="period-filter-btn active" data-period="full" onclick="switchPeriod('full')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">
                                        전체 기간
                                    </button>
                                    <button class="period-filter-btn" data-period="180d" onclick="switchPeriod('180d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 180일
                                    </button>
                                    <button class="period-filter-btn" data-period="90d" onclick="switchPeriod('90d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 90일
                                    </button>
                                    <button class="period-filter-btn" data-period="30d" onclick="switchPeriod('30d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 30일
                                    </button>
                                </div>
                                <span id="periodDateRange" style="font-size: 11px; color: #6c757d; margin-left: auto;"></span>
                            </div>
                        </div>

                        <!-- 탭 버튼 -->
                        <div class="view-type-section" style="margin-bottom: 24px; flex-wrap: wrap; gap: 6px; align-items: center;">
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled active" data-tab="summary" title="선택한 기간 필터가 적용됩니다">📊 핵심 요약</button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="urgent" title="선택한 기간 필터가 적용됩니다">🚨 긴급 개선 <span id="urgentTotalCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="clustering" title="선택한 기간 필터가 적용됩니다">채널 그룹별 분석</button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="budget" title="선택한 기간 필터가 적용됩니다">예산 투자 가이드</button>
                            <button class="view-btn decision-tool-tab-btn period-filter-enabled" data-tab="crm_guide" title="선택한 기간 필터가 적용됩니다">CRM 가이드</button>
                        </div>

                        <!-- 탭 1: 핵심 요약 -->
                        <div class="decision-tool-tab-content active" id="summaryTab">
                            <div class="insight-content" id="insightContent">
                                <div class="insight-card neutral">
                                    <div class="insight-text">데이터를 불러오는 중...</div>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 2: 긴급 개선 포인트 -->
                        <div class="decision-tool-tab-content" id="urgentTab" style="display: none;">
                            <!-- 서브탭: 즉시 조치 / 개선 권장 -->
                            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                                <button class="view-btn urgent-alert-tab-btn active" data-tab="high" style="font-size: 13px;">⚠️ 즉시 조치 필요 <span id="highAlertCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                                <button class="view-btn urgent-alert-tab-btn" data-tab="medium" style="font-size: 13px;">📌 개선 권장 <span id="mediumAlertCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                            </div>
                            <!-- 즉시 조치 필요 -->
                            <div id="highAlertsTab" class="urgent-alert-tab-content active">
                                <div id="highAlertsCards" style="display: grid; gap: 12px;"></div>
                                <div id="highAlertsToggleContainer" style="text-align: center; margin-top: 12px; display: none;">
                                    <button id="highAlertsToggleBtn" class="view-btn" style="font-size: 13px; padding: 8px 20px;">더 보기</button>
                                </div>
                            </div>
                            <!-- 개선 권장 -->
                            <div id="mediumAlertsTab" class="urgent-alert-tab-content" style="display: none;">
                                <div id="mediumAlertsCards" style="display: grid; gap: 12px;"></div>
                                <div id="mediumAlertsToggleContainer" style="text-align: center; margin-top: 12px; display: none;">
                                    <button id="mediumAlertsToggleBtn" class="view-btn" style="font-size: 13px; padding: 8px 20px;">더 보기</button>
                                </div>
                            </div>
                        </div>

                        <!-- 탭 3: 채널 클러스터링 + BCG Matrix 통합 -->
                        <div class="decision-tool-tab-content" id="clusteringTab" style="display: none;">
                        <!-- BCG Matrix 채널 전략 -->
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📈 BCG Matrix 채널 전략</div>
                            <div style="font-size: 13px; color: var(--grey-600); padding: 0 20px 12px 20px;">
                                <strong>'지금 어떤 채널에 돈을 써야하나?'</strong> 투자 의사결정을 돕기위해 트래픽과 전환율을 기준으로 각 채널을 4가지 유형으로 분류했습니다.
                            </div>
                            <div id="bcgMatrixContent" style="padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <!-- JS로 동적 생성 -->
                            </div>
                        </div>
                        <!-- 채널 퍼널 건강도 분석 -->
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🩺 채널 퍼널 건강도 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); padding: 0 20px 12px 20px;">
                                <strong>'지금 어떤 채널의 퍼널 흐름이 건강해?'</strong> 각 채널의 유입→활동→관심→결제 단계별 전환 효율을 K-mean 툴로 종합 분석했습니다. 퍼널 건강 그룹은 모든 단계가 원활하고, 점검 필요 그룹은 중간 이탈이 심합니다.
                            </div>
                            <div id="channelClusters" style="padding: 20px;">
                                <p style="color: var(--grey-500);">데이터를 불러오는 중...</p>
                            </div>
                            <!-- A/B 테스트 통계 결과 컨테이너 -->
                            <div id="abTestStatsContainer" style="padding: 0 20px 20px 20px;"></div>
                        </div>
                        </div>

                        <!-- 탭 2: 예산 투자 가이드 -->
                        <div class="decision-tool-tab-content" id="budgetTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">💰 예산 투자 가이드: 채널별 투자 효율성 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); padding: 0 20px 12px 20px;">
                                각 채널의 전환율, 객단가, 실제 성과 데이터를 종합하여 <strong>100만원 투자 시 예상되는 구체적인 성과</strong>를 시뮬레이션했습니다.
                                <strong>"신뢰도"</strong>는 데이터 양에 기반한 분석의 정확도를 나타내며, 채널 타입별로 다른 투자 전략을 제시합니다.
                                <div style="margin-top: 8px; padding: 8px; background: var(--grey-50); border-radius: 6px; font-size: 12px;">
                                    <strong>📌 분석 기준:</strong> 광고 채널(1,500원/방문자), 오가닉 최적화(300원/방문자), 레퍼럴(500원/방문자) 등 업계 평균 CPA 적용
                                </div>
                            </div>
                            <div id="abTestResults" style="padding: 20px;">
                                <p style="color: var(--grey-500);">데이터를 불러오는 중...</p>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 3: CRM 가이드 (기간 필터 적용) -->
                        <div class="decision-tool-tab-content" id="crmGuideTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📋 CRM 액션 가이드</div>
                            <div style="font-size: 13px; color: var(--grey-600); padding: 0 20px 12px 20px;">
                                선택한 기간의 데이터를 분석하여 이탈 위험을 방지하기 위한 <strong>구체적인 CRM 액션</strong>을 제안합니다.
                                각 단계별로 즉시 실행 가능한 처방을 확인하세요.
                            </div>
                            <div id="crmActionsContainer" style="padding: 20px;">
                                <p style="color: var(--grey-500);">데이터를 불러오는 중...</p>
                            </div>
                        </div>
                        </div>


                    </div>
                </div>

                <!-- 4. 최근 변화 인사이트 (접기/펼치기) -->
                <div class="collapsible-section" style="margin-bottom: 24px;">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📈</span>
                            <span>최근 변화 인사이트</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 기간 비교 선택 -->
                        <div id="trendPeriodIndicator" style="margin-bottom: 16px; padding: 14px 18px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 10px; border: 1px solid #bbdefb;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="font-size: 16px;">📊</span>
                                <span style="font-size: 13px; font-weight: 600; color: #1565c0;">비교 기간:</span>
                                <div style="display: flex; gap: 6px;">
                                    <button class="trend-period-btn" data-trend-period="30d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">30일</button>
                                    <button class="trend-period-btn" data-trend-period="14d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">14일</button>
                                    <button class="trend-period-btn active" data-trend-period="7d" style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">7일</button>
                                </div>
                                <span id="trendPeriodText" style="font-size: 12px; color: #37474f; margin-left: auto;"></span>
                            </div>
                        </div>
                        <!-- 2열 그리드 -->
                        <div class="compact-grid-2" style="margin-bottom: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 0; background: white; border: 1px solid var(--grey-200); border-radius: 12px; overflow: hidden;">
                            <!-- 성과 개선 분석 -->
                            <div style="padding: 24px; border-right: 1px solid var(--grey-200); background: #fafafa;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #4caf50;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 14px; filter: brightness(10);">✨</span>
                                    </div>
                                    <span style="font-size: 14px; font-weight: 700; color: #2e7d32;">좋은 소식: 어떤 부분이 좋아졌나요?</span>
                                </div>
                                <div class="insight-content" id="improvementTrendContent" style="display: block; max-height: 400px; overflow-y: auto; padding-top: 4px;">
                                    <div class="insight-card neutral">
                                        <div class="insight-text">데이터를 불러오는 중...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 성과 하락 경고 -->
                            <div style="padding: 24px; background: #fafafa;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #ef5350;">
                                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #ef5350 0%, #f44336 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 14px; filter: brightness(10);">⚠️</span>
                                    </div>
                                    <span style="font-size: 14px; font-weight: 700; color: #c62828;">주의 필요: 성과 하락 감지</span>
                                </div>
                                <div class="insight-content" id="declineTrendContent" style="display: block; max-height: 400px; overflow-y: auto; padding-top: 4px;">
                                    <div class="insight-card neutral">
                                        <div class="insight-text">데이터를 불러오는 중...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. 유형별 조치 가이드 (독립 섹션) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">🎯</span>
                            <span>유형별 조치 가이드 (SA, DA, PR, CRM, etc)</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px;">
                            채널 카테고리(SA, DA, SNS 등)별로 <strong>맞춤 처방</strong>과 <strong>조치 가이드</strong>를 제공합니다. 카테고리를 선택하면 해당 유형의 문제점과 개선 방안을 확인할 수 있습니다.
                        </div>

                        <!-- 기간 필터 -->
                        <div style="margin-bottom: 12px; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span style="font-size: 12px; font-weight: 600; color: #495057;">📅 분석 기간:</span>
                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                    <button class="micro-segment-period-btn active" data-period="full" onclick="switchMicroSegmentPeriod('full')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #673ab7; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: #673ab7; color: white;">
                                        전체 기간
                                    </button>
                                    <button class="micro-segment-period-btn" data-period="180d" onclick="switchMicroSegmentPeriod('180d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 180일
                                    </button>
                                    <button class="micro-segment-period-btn" data-period="90d" onclick="switchMicroSegmentPeriod('90d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 90일
                                    </button>
                                    <button class="micro-segment-period-btn" data-period="30d" onclick="switchMicroSegmentPeriod('30d')"
                                            style="padding: 6px 14px; font-size: 11px; font-weight: 600; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s; background: white; color: #495057;">
                                        최근 30일
                                    </button>
                                </div>
                                <span id="microSegmentPeriodDateRange" style="font-size: 11px; color: #6c757d; margin-left: auto;"></span>
                            </div>
                        </div>

                        <!-- 카테고리 필터 -->
                        <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                            <span style="font-size: 12px; font-weight: 600; color: var(--grey-600);">카테고리:</span>
                            <button class="view-btn micro-category-filter active" data-category="all" style="font-size: 11px; padding: 5px 10px;">전체</button>
                            <button class="view-btn micro-category-filter" data-category="SA" style="font-size: 11px; padding: 5px 10px;">SA</button>
                            <button class="view-btn micro-category-filter" data-category="DA" style="font-size: 11px; padding: 5px 10px;">DA</button>
                            <button class="view-btn micro-category-filter" data-category="SNS" style="font-size: 11px; padding: 5px 10px;">SNS</button>
                            <button class="view-btn micro-category-filter" data-category="CRM" style="font-size: 11px; padding: 5px 10px;">CRM</button>
                            <button class="view-btn micro-category-filter" data-category="PR" style="font-size: 11px; padding: 5px 10px;">PR</button>
                            <button class="view-btn micro-category-filter" data-category="Organic" style="font-size: 11px; padding: 5px 10px;">Organic</button>
                            <button class="view-btn micro-category-filter" data-category="etc" style="font-size: 11px; padding: 5px 10px;">기타</button>
                        </div>

                        <!-- 세그먼트 알림 서브탭 -->
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button class="view-btn micro-segment-tab-btn active" data-type="problem" style="font-size: 13px;">🚧 문제점 <span id="microProblemCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                            <button class="view-btn micro-segment-tab-btn" data-type="opportunity" style="font-size: 13px;">🚀 기회 <span id="microOpportunityCount" style="font-size: 11px; opacity: 0.8;"></span></button>
                        </div>

                        <!-- 문제점 알림 -->
                        <div id="microProblemTab" class="micro-segment-tab-content" style="display: block;">
                            <div id="microProblemCards" style="display: grid; gap: 12px;"></div>
                            <div id="microProblemToggleContainer" style="text-align: center; margin-top: 12px; display: none;">
                                <button id="microProblemToggleBtn" class="view-btn" style="font-size: 13px; padding: 8px 20px;">더 보기</button>
                            </div>
                        </div>

                        <!-- 기회 알림 -->
                        <div id="microOpportunityTab" class="micro-segment-tab-content" style="display: none;">
                            <div id="microOpportunityCards" style="display: grid; gap: 12px;"></div>
                            <div id="microOpportunityToggleContainer" style="text-align: center; margin-top: 12px; display: none;">
                                <button id="microOpportunityToggleBtn" class="view-btn" style="font-size: 13px; padding: 8px 20px;">더 보기</button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 6. 채널별 분석 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">📊</span>
                            <span>유입 채널별 상세 분석 (네이버, 구글, 인스타그램 등)</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 탭 버튼 -->
                        <div class="view-type-section" style="margin-bottom: 24px;">
                            <button class="view-btn channel-analysis-tab-btn active" data-tab="table">채널별 고객 흐름</button>
                            <button class="view-btn channel-analysis-tab-btn" data-tab="kpi">지표별 비교</button>
                            <button class="view-btn channel-analysis-tab-btn" data-tab="balance">효율성과 규모</button>
                            <button class="view-btn channel-analysis-tab-btn" data-tab="top10">전환율 TOP 10</button>
                        </div>

                        <!-- 탭 1: 채널별 단계별 고객 수 테이블 -->
                        <div class="channel-analysis-tab-content active" id="tableTab">
                        <div class="table-section card" style="margin-bottom: 16px;">
                            <div class="table-header">📊 채널별 고객 흐름: 각 채널에서 얼마나 많은 고객이 구매까지 도달하나요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 표는 무엇을 보여주나요?</strong><br>
                                각 마케팅 채널(네이버, 구글, 인스타그램 등)에서 고객이 <strong>5단계 여정</strong>을 어떻게 거치는지 보여줍니다.<br>
                                <span style="color: var(--grey-600);">예시: 유입 1,000명 → 활동 800명 → 관심 400명 → 결제진행 100명 → 구매완료 50명 (CVR 5%)</span><br><br>
                                <strong style="color: var(--primary-main);">💡 표 보는 법:</strong><br>
                                • <strong>왼쪽에서 오른쪽</strong>으로 갈수록 숫자가 줄어드는 것이 정상입니다 (고객이 단계를 거치며 이탈)<br>
                                • <strong>CVR(전환율)</strong>은 방문자 100명 중 몇 명이 최종 구매했는지를 나타냅니다 (높을수록 좋음)<br>
                                • <strong>매출</strong>이 높아도 CVR이 낮으면 개선 여지가 많다는 의미입니다<br>
                                • <strong>열 제목을 클릭</strong>하면 해당 기준으로 정렬됩니다
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="channelTableInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 10px; border-left: 4px solid #4caf50;">
                                <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 8px;">
                                    🎯 데이터 분석 결과
                                </div>
                                <div id="channelTableInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div class="table-container">
                                <table id="channelTable">
                                    <thead>
                                        <tr>
                                            <th>채널</th>
                                            <th class="sortable-header" data-column="유입" data-type="number">
                                                유입
                                                <div class="sort-icon active">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down active"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 유입 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="활동" data-type="number">
                                                활동
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 활동 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="관심" data-type="number">
                                                관심
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 관심 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="결제진행" data-type="number">
                                                결제진행
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 결제진행 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="구매완료" data-type="number">
                                                구매완료
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 구매완료 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="Revenue" data-type="number">
                                                매출
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 매출 기준으로 정렬</div>
                                            </th>
                                            <th class="sortable-header" data-column="CVR" data-type="number">
                                                CVR
                                                <div class="sort-icon">
                                                    <div class="sort-arrow up"></div>
                                                    <div class="sort-arrow down"></div>
                                                </div>
                                                <div class="sort-tooltip">클릭하여 CVR 기준으로 정렬</div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="channelTableBody">
                                        <tr>
                                            <td colspan="8">데이터를 불러오는 중...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 데이터 해석 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- CVR이 높은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            ✅ CVR이 높은 채널 (3% 이상)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 효율적인 채널. 적은 방문자로도 많이 구매<br>
                                            <strong>전략:</strong> 광고비를 더 투자하고, 이 채널의 성공 요인을 다른 채널에 적용하세요
                                        </div>
                                    </div>

                                    <!-- 매출이 높지만 CVR이 낮은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            ⚠️ 매출은 높은데 CVR이 낮은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 방문자가 많지만 전환율이 낮아 비효율적<br>
                                            <strong>전략:</strong> 랜딩 페이지 개선, 타겟팅 정밀화로 CVR을 높이면 매출이 크게 증가합니다
                                        </div>
                                    </div>

                                    <!-- 방문자가 많지만 이탈이 높은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            🚪 유입은 많은데 활동 수가 급감하는 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 첫 화면에서 대부분 이탈. 광고와 페이지 불일치 가능성<br>
                                            <strong>전략:</strong> 광고 메시지와 랜딩 페이지의 일관성 확인, 로딩 속도 개선
                                        </div>
                                    </div>

                                    <!-- 관심까지는 가지만 결제로 안 가는 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #f3e5f5 0%, #faf5fc 100%); border-radius: 8px; border-left: 3px solid #9c27b0;">
                                        <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 6px;">
                                            💭 관심까지는 가는데 결제 안 하는 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 관심은 있지만 구매 결정을 망설임. 가격이나 신뢰 문제<br>
                                            <strong>전략:</strong> 리뷰/후기 강화, 첫 구매 할인 제공, 결제 과정 간소화
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 체크리스트 -->
                                <div style="padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fffcf5 100%); border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 10px;">
                                        ✅ 이 표를 보고 바로 실행할 수 있는 것들
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.8;">
                                        1. <strong>CVR 1위 채널</strong>을 찾아 광고 예산을 20% 더 배정하세요<br>
                                        2. <strong>유입은 많지만 CVR이 낮은 채널</strong>의 광고 소재와 랜딩 페이지를 점검하세요<br>
                                        3. <strong>단계별 이탈률이 가장 높은 구간</strong>을 찾아 집중 개선하세요 (예: 유입→활동 50% 이상 이탈)<br>
                                        4. <strong>매출 상위 3개 채널</strong>의 공통점을 찾아 성공 패턴을 문서화하세요<br>
                                        5. <strong>CVR 0.5% 이하 채널</strong>은 일시 중단하고 예산을 재배분하세요
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 2: KPI 차트 -->
                        <div class="channel-analysis-tab-content" id="kpiTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📈 각 지표별로 어떤 채널이 1등인가요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); margin-bottom: 16px; line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 차트는 무엇을 보여주나요?</strong><br>
                                원하는 지표(전환율, 방문자 수, 매출 등)별로 각 채널의 성과를 한눈에 비교할 수 있습니다.<br><br>
                                <strong style="color: var(--primary-main);">💡 사용 방법:</strong><br>
                                • 아래 버튼을 클릭하여 보고 싶은 지표를 선택하세요<br>
                                • <strong>전환율</strong>은 효율성을, <strong>매출</strong>은 실제 수익을, <strong>방문자 수</strong>는 트래픽 규모를 나타냅니다<br>
                                • <strong>차트 위에 마우스를 올리면</strong> 해당 지표에 대한 자세한 설명과 개선 전략을 볼 수 있습니다
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 보고 싶은 지표:</span>
                                <button class="view-btn channel-kpi-btn active" data-kpi="cvr" data-chart="kpi">전환율 (%)</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="acquisition" data-chart="kpi">방문자 수</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="activation" data-chart="kpi">활성 사용자</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="consideration" data-chart="kpi">관심 고객</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="conversion" data-chart="kpi">결제 시도</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="purchase" data-chart="kpi">구매 건수</button>
                                <button class="view-btn channel-kpi-btn" data-kpi="revenue" data-chart="kpi">매출액</button>
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="kpiChartInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 8px;">
                                    💡 지표 분석 인사이트
                                </div>
                                <div id="kpiChartInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    버튼을 클릭하여 지표를 선택하면 자동 분석 결과가 여기에 표시됩니다.
                                </div>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="channelKpiChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 각 지표를 볼 때 주의할 점
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <!-- 전환율 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            📊 전환율 (CVR)을 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>높을수록 좋음:</strong> 효율성을 나타냅니다<br>
                                            <strong>주의:</strong> 방문자가 너무 적으면 통계적으로 불안정할 수 있어요
                                        </div>
                                    </div>

                                    <!-- 방문자/매출 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            👥 방문자 수 / 💰 매출을 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>높을수록 좋음:</strong> 규모를 나타냅니다<br>
                                            <strong>주의:</strong> 방문자만 많고 전환율이 낮으면 비효율적이에요
                                        </div>
                                    </div>

                                    <!-- 활성 사용자 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            ⚡ 활성 사용자를 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 실제로 사이트를 사용한 방문자 수<br>
                                            <strong>활용:</strong> 방문자 수와 비교해 첫 이탈률을 파악하세요
                                        </div>
                                    </div>

                                    <!-- 관심/결제/구매 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #f3e5f5 0%, #faf5fc 100%); border-radius: 8px; border-left: 3px solid #9c27b0;">
                                        <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 6px;">
                                            🛒 관심/결제/구매를 볼 때
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 구매 여정의 각 단계별 고객 수<br>
                                            <strong>활용:</strong> 단계별로 급감하는 구간을 찾아 개선하세요
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 3: 비교 차트 -->
                        <div class="channel-analysis-tab-content" id="balanceTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🔄 어떤 채널이 효율성과 규모를 모두 갖췄나요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); margin-bottom: 16px; line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 차트는 무엇을 보여주나요?</strong><br>
                                전환율, 방문자 수, 구매 건수, 매출을 모두 <strong>100점 만점</strong>으로 환산하여 비교합니다.<br>
                                <span style="color: var(--grey-600);">예시: CVR이 가장 높은 채널을 100점으로 했을 때, 다른 채널들은 몇 점인지 보여줍니다.</span><br><br>
                                <strong style="color: var(--primary-main);">💡 차트 보는 법:</strong><br>
                                • <strong>모든 막대가 고르게 높은 채널</strong> = 효율도 좋고 규모도 큰 최고의 채널<br>
                                • <strong>CVR만 높고 다른 막대가 낮은 채널</strong> = 효율은 좋지만 규모가 작은 채널 (투자 확대 필요)<br>
                                • <strong>방문자/매출만 높고 CVR이 낮은 채널</strong> = 규모는 크지만 비효율적인 채널 (개선 필요)<br>
                                • <strong>차트 위에 마우스를 올리면</strong> 더 자세한 해석 방법을 볼 수 있습니다
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="compareChartInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #f3e5f5 0%, #faf5fc 100%); border-radius: 10px; border-left: 4px solid #9c27b0;">
                                <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 8px;">
                                    💎 균형 분석 결과
                                </div>
                                <div id="compareChartInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div style="position: relative; height: 450px;">
                                <canvas id="channelCompareChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 채널 유형별 전략
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <!-- 완벽한 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            🌟 모든 막대가 고르게 높은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 완벽한 채널 (효율↑ + 규모↑)<br>
                                            <strong>전략:</strong> 최우선 투자 대상. 광고비를 적극 늘리세요
                                        </div>
                                    </div>

                                    <!-- 효율은 좋은데 규모가 작은 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            💎 CVR은 높은데 방문자가 적은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 숨겨진 보석 (효율↑ + 규모↓)<br>
                                            <strong>전략:</strong> 광고 예산을 늘려 방문자를 확대하세요
                                        </div>
                                    </div>

                                    <!-- 규모는 큰데 효율이 낮은 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            ⚠️ 방문자/매출은 높은데 CVR이 낮은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 개선 필요 채널 (효율↓ + 규모↑)<br>
                                            <strong>전략:</strong> 랜딩 페이지 개선으로 CVR을 높이면 매출 급증
                                        </div>
                                    </div>

                                    <!-- 모든 게 낮은 채널 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #f44336;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f44336; margin-bottom: 6px;">
                                            ❌ 모든 막대가 낮은 채널
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>유형:</strong> 저성과 채널 (효율↓ + 규모↓)<br>
                                            <strong>전략:</strong> 일시 중단하고 예산을 상위 채널로 이동
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 팁 -->
                                <div style="margin-top: 12px; padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fffcf5 100%); border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 10px;">
                                        ✅ 이 차트로 바로 실행할 수 있는 것
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.8;">
                                        1. <strong>모든 막대가 높은 채널</strong>을 찾아 광고비를 30-50% 증액하세요<br>
                                        2. <strong>CVR만 높고 규모가 작은 채널</strong>은 타겟을 확대하여 방문자를 늘리세요<br>
                                        3. <strong>규모는 크지만 CVR이 낮은 채널</strong>은 랜딩 페이지 A/B 테스트를 시작하세요<br>
                                        4. <strong>모든 지표가 낮은 채널</strong>은 일시 중단하고 원인 분석을 먼저 하세요
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 4: TOP 10 전환율 차트 -->
                        <div class="channel-analysis-tab-content" id="top10Tab" style="display: none;">
                        <div class="chart-section card">
                            <div class="chart-header">🎯 각 단계별 전환율 TOP 10: 어떤 채널이 가장 효율적인가요?</div>

                            <!-- 설명 섹션 -->
                            <div style="font-size: 13px; color: var(--grey-700); padding: 16px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); margin-bottom: 16px; line-height: 1.7;">
                                <strong style="color: var(--primary-main);">📖 이 차트는 무엇을 보여주나요?</strong><br>
                                각 고객 여정 단계별로 전환율이 높은 상위 10개 채널을 보여줍니다.<br>
                                <span style="color: var(--grey-600);">예시: "활동" 단계를 선택하면, 유입한 고객 중 실제로 활동까지 이어진 비율이 높은 채널 순위를 볼 수 있습니다.</span><br><br>
                                <strong style="color: var(--primary-main);">💡 전환율이란?</strong><br>
                                • <strong>활동 전환율</strong> = (활동 고객 ÷ 유입 고객) × 100<br>
                                • <strong>관심 전환율</strong> = (관심 고객 ÷ 유입 고객) × 100<br>
                                • <strong>결제진행 전환율</strong> = (결제진행 ÷ 유입 고객) × 100<br>
                                • <strong>구매완료 전환율(CVR)</strong> = (구매 고객 ÷ 유입 고객) × 100 ← 가장 중요!<br><br>
                                <strong>높을수록</strong> 효율적인 채널입니다 (적은 방문자로도 많은 전환 달성)
                            </div>

                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 전환율 기준:</span>
                                <button class="view-btn channel-funnel-btn" data-funnel="activation">활동</button>
                                <button class="view-btn channel-funnel-btn" data-funnel="consideration">관심</button>
                                <button class="view-btn channel-funnel-btn" data-funnel="conversion">결제진행</button>
                                <button class="view-btn channel-funnel-btn active" data-funnel="purchase">구매완료</button>
                            </div>

                            <!-- 자동 인사이트 박스 -->
                            <div id="top10ChartInsightSummary" style="margin: 16px 24px; padding: 16px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 10px; border-left: 4px solid #ff9800;">
                                <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 8px;">
                                    🏆 TOP 10 분석 결과
                                </div>
                                <div id="top10ChartInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    버튼을 클릭하여 단계를 선택하면 자동 분석 결과가 여기에 표시됩니다.
                                </div>
                            </div>

                            <div class="chart-container-small">
                                <canvas id="campaignChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px 20px 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 전환율 순위를 볼 때 주의할 점
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- 전환율 높지만 규모 작은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            ⚠️ 전환율은 높은데 방문자가 적다면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 효율은 우수하지만 규모가 작음<br>
                                            <strong>전략:</strong> 광고 예산을 늘려 방문자 확대 (큰 성과 기대)
                                        </div>
                                    </div>

                                    <!-- 전환율 낮지만 규모 큰 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff8f0 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff9800; margin-bottom: 6px;">
                                            ⚠️ 전환율은 낮은데 매출이 높다면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 규모는 크지만 비효율적<br>
                                            <strong>전략:</strong> 랜딩 페이지 개선으로 CVR 상승 → 매출 폭발적 증가
                                        </div>
                                    </div>

                                    <!-- 초기 단계 전환율이 낮은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #f44336;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f44336; margin-bottom: 6px;">
                                            🚨 활동 전환율이 50% 이하라면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 첫 화면에서 절반 이상이 이탈<br>
                                            <strong>전략:</strong> 광고 메시지와 랜딩 페이지 일치 확인, 로딩 속도 개선
                                        </div>
                                    </div>

                                    <!-- 최종 전환율이 높은 경우 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #4caf50;">
                                        <div style="font-size: 13px; font-weight: 600; color: #4caf50; margin-bottom: 6px;">
                                            ✅ 구매완료 전환율이 3% 이상이라면?
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 매우 우수한 채널!<br>
                                            <strong>전략:</strong> 최우선 투자 대상. 광고비를 30-50% 증액하세요
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 팁 -->
                                <div style="padding: 16px; background: linear-gradient(135deg, #fff9e6 0%, #fffcf5 100%); border-radius: 8px; border-left: 3px solid #ffc107;">
                                    <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 10px;">
                                        ✅ 이 순위표로 바로 실행할 수 있는 것
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.8;">
                                        1. <strong>구매완료 TOP 3 채널</strong>의 공통점을 찾아 다른 채널에 적용하세요<br>
                                        2. <strong>활동 전환율이 높은 채널</strong>은 첫 화면이 효과적. 랜딩 페이지를 벤치마킹하세요<br>
                                        3. <strong>결제진행까지는 가지만 구매는 안 하는 채널</strong>은 결제 과정을 간소화하세요<br>
                                        4. <strong>전환율 1%  미만 채널</strong>은 일시 중단하고 원인 분석을 먼저 하세요<br>
                                        5. 각 단계별 탭을 클릭하며 어느 구간에서 이탈이 많은지 파악하세요
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- 6. 신규 vs 재방문 및 이탈 분석 (접기 가능) -->
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <div class="collapsible-title">
                            <span class="collapsible-icon">👥</span>
                            <span>고객 재방문 및 이탈 분석</span>
                        </div>
                        <button class="collapsible-toggle">
                            <span>펼치기</span>
                            <span class="collapsible-toggle-icon collapsed">▼</span>
                        </button>
                    </div>
                    <div class="collapsible-content">
                        <!-- 탭 버튼 -->
                        <div class="view-type-section" style="margin-bottom: 24px;">
                            <button class="view-btn customer-analysis-tab-btn active" data-tab="trend">신규 vs 재방문 추세</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="conversion">전환율 비교</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="churn">이탈률 분석</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="matrix">채널 품질 매트릭스</button>
                            <button class="view-btn customer-analysis-tab-btn" data-tab="engagement">고객 참여도</button>
                        </div>

                        <!-- 탭 1: 통합 신규/재방문 고객 추세 차트 -->
                        <div class="customer-analysis-tab-content active" id="trendTab">
                        <!-- 데이터 기준 선택 -->
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding: 16px 0;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--grey-700);">📊 데이터 기준:</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="view-btn new-vs-returning-view-btn active" data-view="monthly">📆 월별</button>
                                <button class="view-btn new-vs-returning-view-btn" data-view="weekly">📆 주별</button>
                                <button class="view-btn new-vs-returning-view-btn" data-view="daily">📅 일별</button>
                            </div>
                        </div>
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📊 신규 vs 재방문 고객 추세 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 12px; padding: 0 24px;">
                                시간에 따른 신규 고객 비율과 재방문율의 변화를 추적합니다. 신규 고객 비율이 높으면 새로운 고객 유입이 활발한 것이고, 재방문율이 높으면 고객 충성도가 높다는 뜻입니다. <strong>차트 위에 마우스를 올리면</strong> 추가 인사이트를 확인할 수 있습니다.
                            </div>
                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="customerTrendChart"></canvas>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 2: 신규 vs 재방문 고객 전환율 비교 -->
                        <div class="customer-analysis-tab-content" id="conversionTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🔄 첫 방문 고객 vs 재방문 고객: 구매 전환율 차이 분석</div>
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px; padding: 0 24px; line-height: 1.7;">
                                <strong>이 차트는 무엇을 보여주나요?</strong><br>
                                처음 우리 사이트에 온 사람(신규)과 이미 왔던 적이 있는 사람(재방문)의 행동을 비교합니다.
                                각 단계별로 얼마나 많은 사람이 다음 단계로 넘어가는지 전환율(%)로 표시됩니다.
                                <strong>차트 위에 마우스를 올리면</strong> 더 자세한 분석과 개선 방법을 확인할 수 있습니다.
                            </div>

                            <!-- 주요 인사이트 요약 -->
                            <div id="conversionInsightSummary" style="margin: 0 24px 16px 24px; padding: 16px; background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); border-radius: 10px; border-left: 4px solid var(--primary-main);">
                                <div style="font-size: 13px; font-weight: 600; color: var(--primary-main); margin-bottom: 8px;">
                                    💡 핵심 인사이트
                                </div>
                                <div id="conversionInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="newVsReturningConversionChart"></canvas>
                            </div>

                            <!-- 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 차트 해석 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 6px;">
                                            🆕 신규 고객 (주황색 막대)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            처음 방문한 고객들의 전환율입니다. 신규 고객은 우리 사이트를 처음 경험하기 때문에 일반적으로 전환율이 낮습니다.
                                            <strong>첫인상이 중요</strong>하므로 랜딩페이지와 첫 화면 최적화가 핵심입니다.
                                        </div>
                                    </div>
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ede7f6 0%, #f3f0ff 100%); border-radius: 8px; border-left: 3px solid #673ab7;">
                                        <div style="font-size: 13px; font-weight: 600; color: #673ab7; margin-bottom: 6px;">
                                            🔄 재방문 고객 (보라색 막대)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            이미 방문한 적이 있는 고객들의 전환율입니다. 재방문 고객은 우리 브랜드를 알고 있어 <strong>신뢰도가 높고 구매 가능성이 큽니다</strong>.
                                            이메일 마케팅이나 리타겟팅으로 재방문을 유도하세요.
                                        </div>
                                    </div>
                                </div>

                                <!-- 실행 가능한 팁 -->
                                <div style="margin-top: 12px; padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid var(--success-main);">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--success-main); margin-bottom: 6px;">
                                        ✅ 실행 가능한 개선 방법
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>신규 고객 전환율이 낮다면:</strong>
                                        첫 화면 로딩 속도 개선, 명확한 가치 제안 표시, 신뢰 요소 강화(리뷰, 보안 인증 등), 회원가입 없이 둘러보기 가능하게<br>
                                        <strong>재방문 고객 전환율이 낮다면:</strong>
                                        개인화된 추천 시스템 도입, 재방문 쿠폰 제공, 이메일로 신상품 알림, 로그인 시 이전 장바구니 자동 복원<br>
                                        <strong>두 그룹 모두 낮다면:</strong>
                                        전체적인 사용자 경험(UX) 점검 필요, 가격 경쟁력 확인, 결제 옵션 다양화
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 3: 이탈률 차트 -->
                        <div class="customer-analysis-tab-content" id="churnTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">📉 채널별 고객 이탈 분석: 어느 단계에서 가장 많이 떠나나요?</div>

                            <!-- 설명 -->
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px; padding: 0 24px; line-height: 1.7;">
                                <strong>이탈률이란?</strong><br>
                                각 퍼널 단계에서 다음 단계로 넘어가지 못하고 떠나는 고객의 비율입니다.
                                예를 들어, "유입→활동" 이탈률 80%는 방문자 100명 중 80명이 아무 행동도 하지 않고 떠났다는 뜻입니다.
                                <strong>이탈률이 높은 단계를 찾아 집중 개선</strong>하면 전체 전환율을 크게 향상시킬 수 있습니다.
                                <strong>차트 위에 마우스를 올리면</strong> 더 자세한 분석을 확인할 수 있습니다.
                            </div>

                            <!-- 이탈률 자동 인사이트 -->
                            <div id="churnInsightSummary" style="margin: 0 24px 16px 24px; padding: 16px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 10px; border-left: 4px solid #ff5722;">
                                <div style="font-size: 13px; font-weight: 600; color: #ff5722; margin-bottom: 8px;">
                                    ⚠️ 이탈률 분석 결과
                                </div>
                                <div id="churnInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <!-- 필터 버튼 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">📊 퍼널 단계:</span>
                                <button class="view-btn channel-churn-stage-btn" data-stage="activation">유입→활동</button>
                                <button class="view-btn channel-churn-stage-btn" data-stage="consideration">활동→관심</button>
                                <button class="view-btn channel-churn-stage-btn" data-stage="conversion">관심→결제진행</button>
                                <button class="view-btn channel-churn-stage-btn" data-stage="purchase">결제진행→구매완료</button>
                                <button class="view-btn channel-churn-stage-btn active" data-stage="avg">평균 이탈률</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; padding: 0 24px;">
                                <span style="font-size: 13px; font-weight: 600; color: var(--grey-700);">🔢 정렬:</span>
                                <button class="view-btn channel-churn-sort-btn active" data-sort="desc">📉 높은순</button>
                                <button class="view-btn channel-churn-sort-btn" data-sort="asc">📈 낮은순</button>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="channelChurnChart"></canvas>
                            </div>

                            <!-- 이탈률 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 단계별 이탈 원인과 개선 방법
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- 유입→활동 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                        <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                            🚪 유입→활동 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 랜딩 페이지가 느리거나, 광고 내용과 실제 페이지가 다르거나, 첫 화면이 복잡함<br>
                                            <strong>해결:</strong> 로딩 속도 개선(3초 이내), 광고와 랜딩 페이지 메시지 일치, 명확한 헤드라인 배치
                                        </div>
                                    </div>

                                    <!-- 활동→관심 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 6px;">
                                            👀 활동→관심 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 제품/서비스 정보 부족, 신뢰 요소 부족, 가격 정보 숨김<br>
                                            <strong>해결:</strong> 상세한 제품 설명, 고객 후기/리뷰 강조, 가격 투명하게 공개, 비교표 제공
                                        </div>
                                    </div>

                                    <!-- 관심→결제진행 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%); border-radius: 8px; border-left: 3px solid #9c27b0;">
                                        <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 6px;">
                                            🛒 관심→결제진행 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 가격이 예상보다 높음, 배송비 추가 비용 발견, 회원가입 강요<br>
                                            <strong>해결:</strong> 첫 구매 할인 제공, 무료 배송 임계값 낮추기, 게스트 체크아웃 허용
                                        </div>
                                    </div>

                                    <!-- 결제진행→구매완료 이탈 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #ff5722;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff5722; margin-bottom: 6px;">
                                            💳 결제진행→구매완료 이탈이 높다면
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>원인:</strong> 결제 과정 복잡, 보안 불안, 결제 수단 부족, 시스템 오류<br>
                                            <strong>해결:</strong> 간편 결제 도입(카카오페이, 네이버페이), SSL 인증 표시, 다양한 결제 옵션, 장바구니 복원 이메일
                                        </div>
                                    </div>
                                </div>

                                <!-- 이탈률 벤치마크 -->
                                <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #00c853; margin-bottom: 12px;">
                                    <div style="font-size: 13px; font-weight: 600; color: #00c853; margin-bottom: 6px;">
                                        📊 업계 평균 이탈률 벤치마크
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>유입→활동:</strong> 평균 40-60% (낮을수록 좋음)<br>
                                        <strong>활동→관심:</strong> 평균 50-70%<br>
                                        <strong>관심→결제진행:</strong> 평균 60-80%<br>
                                        <strong>결제진행→구매완료:</strong> 평균 20-40% (이 단계는 특히 낮아야 함)<br><br>
                                        <strong>💡 팁:</strong> 업계 평균보다 10%p 이상 높다면 즉시 개선이 필요합니다.
                                    </div>
                                </div>

                                <!-- 실행 체크리스트 -->
                                <div style="padding: 14px; background: var(--primary-light); border-radius: 8px; border-left: 3px solid var(--primary-main);">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--primary-main); margin-bottom: 8px;">
                                        ✅ 이탈률 개선 우선순위 체크리스트
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>1단계:</strong> 차트에서 <strong>이탈률이 가장 높은 단계</strong>를 찾기 (예: 유입→활동 80%)<br>
                                        <strong>2단계:</strong> 해당 단계에서 <strong>이탈률이 가장 높은 채널 TOP 3</strong> 확인<br>
                                        <strong>3단계:</strong> 위 가이드에서 해당 단계의 <strong>원인과 해결책</strong> 확인<br>
                                        <strong>4단계:</strong> 가장 이탈률이 높은 1-2개 채널에 대해 <strong>즉시 개선 작업 시작</strong><br>
                                        <strong>5단계:</strong> 2주 후 다시 측정하여 이탈률이 10%p 이상 감소했는지 확인<br><br>
                                        <strong>⚡ 빠른 개선 팁:</strong> 한 번에 모든 채널을 고치려 하지 마세요. 이탈률이 가장 높은 1-2개 채널에만 집중하면 전체 전환율이 극적으로 개선됩니다.
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 4: 채널별 재방문율 vs 이탈률 매트릭스 -->
                        <div class="customer-analysis-tab-content" id="matrixTab" style="display: none;">
                        <div class="chart-section card" style="margin-bottom: 16px;">
                            <div class="chart-header">🎯 채널 품질 매트릭스: 재방문율 vs 이탈률</div>
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 12px; padding: 0 24px;">
                                채널을 재방문율(Y축)과 이탈률(X축)로 분류합니다. 평균 기준선을 중심으로 4개 분면으로 자동 구분되며, 각 채널 유형에 맞는 액션 플랜을 아래에서 확인하세요.
                            </div>
                            <div style="position: relative; height: 450px;">
                                <canvas id="channelMatrixChart"></canvas>
                            </div>

                            <!-- 채널 유형별 액션 가이드 -->
                            <div style="margin-top: 24px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 16px;">
                                    📋 채널 유형별 액션 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <!-- 스타 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 10px; border-left: 4px solid #00c853;">
                                        <div style="font-size: 14px; font-weight: 700; color: #00c853; margin-bottom: 8px;">
                                            ⭐ 스타 채널 (낮은 이탈 + 높은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 투자 확대 및 현재 전략 유지<br>
                                            <strong>✨ 기대 효과:</strong> 안정적인 매출 증대, ROI 극대화<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>마케팅 예산을 20-30% 증액</li>
                                                <li>유사한 타겟 오디언스로 확장</li>
                                                <li>성공 요인 분석 후 다른 채널에 적용</li>
                                                <li>고객 추천 프로그램 운영</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 성장 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 10px; border-left: 4px solid #2196f3;">
                                        <div style="font-size: 14px; font-weight: 700; color: #2196f3; margin-bottom: 8px;">
                                            📈 성장 채널 (높은 이탈 + 높은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 이탈률 개선에 집중<br>
                                            <strong>✨ 기대 효과:</strong> 전환율 상승, 신규 고객 확보<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>랜딩 페이지 개선 (로딩 속도, 디자인)</li>
                                                <li>첫 방문 고객 경험 최적화</li>
                                                <li>명확한 CTA(행동 유도) 버튼 배치</li>
                                                <li>신뢰 요소 강화 (리뷰, 보안 인증)</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 안정 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%); border-radius: 10px; border-left: 4px solid #9e9e9e;">
                                        <div style="font-size: 14px; font-weight: 700; color: #757575; margin-bottom: 8px;">
                                            🔒 안정 채널 (낮은 이탈 + 낮은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 재방문 유도 전략 구축<br>
                                            <strong>✨ 기대 효과:</strong> 고객 생애가치(LTV) 증가<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>리타겟팅 광고 캠페인 운영</li>
                                                <li>이메일/SMS 마케팅 자동화</li>
                                                <li>쿠폰/할인 프로모션 제공</li>
                                                <li>회원 등급제 및 포인트 적립 도입</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 문제 채널 -->
                                    <div style="padding: 16px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 10px; border-left: 4px solid #ff5722;">
                                        <div style="font-size: 14px; font-weight: 700; color: #ff5722; margin-bottom: 8px;">
                                            ⚠️ 문제 채널 (높은 이탈 + 낮은 재방문)
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700); line-height: 1.6;">
                                            <strong>💡 해야 할 일:</strong> 전면 재검토 또는 중단<br>
                                            <strong>✨ 기대 효과:</strong> 비용 절감, 효율적 자원 배분<br>
                                            <strong>🎯 구체적 행동:</strong>
                                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                                <li>타겟 오디언스 재설정</li>
                                                <li>광고 크리에이티브 전면 교체</li>
                                                <li>예산 축소 또는 일시 중단</li>
                                                <li>A/B 테스트로 개선 가능성 검증</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- 추가 팁 -->
                                <div style="margin-top: 16px; padding: 12px 16px; background: var(--primary-light); border-radius: 8px; border-left: 4px solid var(--primary-main);">
                                    <div style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                        <strong>💡 프로 팁:</strong> 모든 채널을 한 번에 변경하지 마세요. 한 번에 1-2개 채널에 집중하여 개선하고, 2-4주 후 결과를 측정한 뒤 다음 채널로 넘어가는 것이 효과적입니다.
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- 탭 5: 채널별 참여도 분석 -->
                        <div class="customer-analysis-tab-content" id="engagementTab" style="display: none;">
                        <div class="chart-section card">
                            <div class="chart-header">💎 채널별 고객 참여도: 어떤 채널이 진짜 관심 있는 고객을 데려오나요?</div>

                            <!-- 설명 -->
                            <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 16px; padding: 0 24px; line-height: 1.7;">
                                <strong>참여도(Engagement Rate)란?</strong><br>
                                방문자 중 실제로 웹사이트를 적극적으로 사용한 비율입니다. 단순 클릭 실수나 즉시 이탈한 방문이 아니라,
                                <strong>페이지를 여러 개 보거나 일정 시간 이상 머문 "진짜 관심 있는" 고객의 비율</strong>입니다.
                                <strong>차트 위에 마우스를 올리면</strong> 더 자세한 분석을 확인할 수 있습니다.
                            </div>

                            <!-- 참여도 자동 인사이트 -->
                            <div id="engagementInsightSummary" style="margin: 0 24px 16px 24px; padding: 16px; background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%); border-radius: 10px; border-left: 4px solid #9c27b0;">
                                <div style="font-size: 13px; font-weight: 600; color: #9c27b0; margin-bottom: 8px;">
                                    💡 참여도 분석 결과
                                </div>
                                <div id="engagementInsightText" style="font-size: 13px; color: var(--grey-800); line-height: 1.6;">
                                    데이터를 불러오는 중...
                                </div>
                            </div>

                            <div class="chart-container-small" style="position: relative;">
                                <canvas id="channelEngagementChart"></canvas>
                            </div>

                            <!-- 참여도 해석 가이드 -->
                            <div style="margin-top: 20px; padding: 0 24px;">
                                <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 12px;">
                                    📋 참여도 수치 해석 가이드
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                                    <!-- 높은 참여도 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 3px solid #00c853;">
                                        <div style="font-size: 13px; font-weight: 600; color: #00c853; margin-bottom: 6px;">
                                            🌟 높음 (60% 이상)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 매우 질 좋은 트래픽. 관심도 높은 고객을 데려오고 있습니다.<br>
                                            <strong>행동:</strong> 이 채널에 예산을 더 투자하세요. 성공 요인을 분석하여 다른 채널에도 적용하세요.
                                        </div>
                                    </div>

                                    <!-- 중간 참여도 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid #ff9800;">
                                        <div style="font-size: 13px; font-weight: 600; color: #f57c00; margin-bottom: 6px;">
                                            ⚖️ 보통 (40-60%)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 평균적인 트래픽. 개선 여지가 있습니다.<br>
                                            <strong>행동:</strong> 랜딩 페이지를 최적화하거나 타겟팅을 조정하세요. A/B 테스트로 참여도 향상을 시도하세요.
                                        </div>
                                    </div>

                                    <!-- 낮은 참여도 -->
                                    <div style="padding: 14px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 8px; border-left: 3px solid #ff5722;">
                                        <div style="font-size: 13px; font-weight: 600; color: #ff5722; margin-bottom: 6px;">
                                            ⚠️ 낮음 (40% 미만)
                                        </div>
                                        <div style="font-size: 12px; color: var(--grey-700); line-height: 1.5;">
                                            <strong>의미:</strong> 품질이 낮은 트래픽. 잘못된 고객층이 유입되고 있을 수 있습니다.<br>
                                            <strong>행동:</strong> 광고 타겟팅을 재검토하거나 예산을 줄이세요. 광고 메시지와 랜딩 페이지의 일치 여부를 확인하세요.
                                        </div>
                                    </div>
                                </div>

                                <!-- 추가 팁 -->
                                <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #f1f8fc 100%); border-radius: 8px; border-left: 3px solid #2196f3;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2196f3; margin-bottom: 6px;">
                                        💡 참여도와 전환율의 관계
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        <strong>핵심:</strong> 참여도가 높으면 전환율도 높아집니다. 참여도가 낮은 채널은 방문자 수가 많아도 실제 매출은 적을 수 있습니다.
                                        따라서 단순히 클릭 수만 보지 말고, <strong>참여도와 전환율을 함께 고려</strong>하여 예산을 배분하세요.<br><br>
                                        <strong>예시:</strong> A채널은 방문자 1,000명에 참여도 30%, B채널은 방문자 500명에 참여도 70%라면,
                                        실제로 B채널이 더 많은 매출을 가져올 가능성이 큽니다.
                                    </div>
                                </div>

                                <!-- 실행 체크리스트 -->
                                <div style="margin-top: 12px; padding: 14px; background: var(--primary-light); border-radius: 8px; border-left: 3px solid var(--primary-main);">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--primary-main); margin-bottom: 8px;">
                                        ✅ 지금 바로 실행할 체크리스트
                                    </div>
                                    <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                        1. <strong>참여도 상위 3개 채널</strong>의 공통점을 찾아 다른 채널에 적용<br>
                                        2. <strong>참여도 하위 3개 채널</strong>의 광고 타겟팅 또는 랜딩 페이지 점검<br>
                                        3. 참여도가 높지만 전환율이 낮은 채널이 있다면 <strong>결제 프로세스나 가격 정책</strong> 개선<br>
                                        4. 참여도가 낮은 채널은 예산을 줄이고, 참여도가 높은 채널에 재투자
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

            </div>
        
            </div>

            <!-- ========== FAQ&문의하기 (Qna.html) ========== -->
            <div class="page-section" data-page="qna">
                
            <div class="container">
                <!-- 헤더 -->
                <div class="header">
                    <div>
                        <h1>FAQ & 문의하기</h1>
                        <div class="header-subtitle">자주 묻는 질문과 직접 문의하기</div>
                    </div>
                </div>

                <!-- 탭 네비게이션 -->
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="faq">자주 묻는 질문 (FAQ)</button>
                    <button class="tab-btn" data-tab="contact">문의하기</button>
                </div>

                <!-- FAQ 탭 -->
                <div class="tab-content active" id="tab-faq">
                    <!-- 검색 -->
                    <div class="search-box">
                        <span class="search-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                        </span>
                        <input type="text" class="search-input" id="faqSearch" placeholder="질문 검색하기...">
                    </div>

                    <div class="faq-section">
                        <!-- 마케팅 대시보드 FAQ -->
                        <div class="faq-category">
                            <div class="faq-category-title">마케팅 성과 대시보드</div>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>탭을 전환하면 차트와 테이블도 바뀌나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            네, 맞습니다. <strong>전체/일별/주별/월별</strong> 탭을 전환하면
                                            KPI 카드, 차트, 테이블이 모두 해당 집계 단위로 변경됩니다.<br><br>
                                            예를 들어, "월별" 탭을 선택하면:<br>
                                            • KPI 카드: 월별 집계 데이터의 마지막 월 vs 직전 월 비교<br>
                                            • 차트: 월별 추이 그래프<br>
                                            • 테이블: 월별 상세 데이터
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>증감율이 "-"로 표시되는 이유는 무엇인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            증감율이 "-"로 표시되는 경우는 다음과 같습니다:<br><br>
                                            • <strong>직전 기간 데이터가 없는 경우</strong>: 비교할 기준이 없음<br>
                                            • <strong>직전 기간 값이 0인 경우</strong>: 0으로 나눌 수 없음<br>
                                            • <strong>데이터가 1개 기간만 있는 경우</strong>: 비교 대상 없음<br><br>
                                            이 경우 필터 기간을 더 넓게 설정하면 해결될 수 있습니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>ROAS 퍼센트 포인트(%p)는 무엇인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            퍼센트 포인트(%p)는 <strong>비율의 절대적 차이</strong>를 나타냅니다.<br><br>
                                            예시:<br>
                                            • 지난달 ROAS: 200%<br>
                                            • 이번달 ROAS: 215%<br>
                                            • 변화: <strong>+15%p</strong> (215 - 200 = 15)<br><br>
                                            일반 증감율(%)과 다르게, ROAS는 이미 비율(%)이므로
                                            단순 뺄셈으로 변화량을 계산하여 %p로 표시합니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>CPA/CPC 증가가 왜 빨간색인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            <strong>CPA(전환당 비용)</strong>와 <strong>CPC(클릭당 비용)</strong>는
                                            <strong>낮을수록 효율적</strong>인 지표입니다.<br><br>
                                            따라서:<br>
                                            • CPA/CPC <strong>감소</strong> → 효율 개선 → <span style="color: #00c853; font-weight: 600;">녹색</span><br>
                                            • CPA/CPC <strong>증가</strong> → 효율 악화 → <span style="color: #ff1744; font-weight: 600;">빨간색</span><br><br>
                                            이는 ROAS(높을수록 좋음)와 반대되는 개념입니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>차트에서 여러 지표를 동시에 볼 수 있나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            네, <strong>체크박스를 여러 개 선택</strong>하면 됩니다.<br><br>
                                            • <strong>비용</strong>: 왼쪽 Y축 (Bar 차트)<br>
                                            • <strong>CPM/CPC/CPA/ROAS</strong>: 오른쪽 Y축 (Line 차트)<br><br>
                                            듀얼 Y축을 사용하므로 단위가 다른 지표도 함께 비교할 수 있습니다.
                                            예: 비용(원) + ROAS(%)를 한 차트에서 확인 가능
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>필터를 초기화하려면 어떻게 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            필터를 초기화하려면:<br>
                                            1. 각 필터 드롭다운에서 <strong>"전체"</strong> 옵션을 선택<br>
                                            2. 또는 <strong>페이지를 새로고침</strong> (F5)<br><br>
                                            새로고침 시 데이터가 다시 로드되며 모든 필터가 초기 상태로 돌아갑니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>테이블 데이터를 엑셀로 내보낼 수 있나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            현재 버전에서는 직접 내보내기 기능이 제공되지 않습니다.<br><br>
                                            임시 방법:<br>
                                            1. 테이블 영역을 <strong>마우스로 드래그</strong>하여 선택<br>
                                            2. <strong>Ctrl+C</strong>로 복사<br>
                                            3. Excel이나 Google Sheets에 <strong>Ctrl+V</strong>로 붙여넣기<br><br>
                                            추후 업데이트에서 CSV/Excel 내보내기 기능이 추가될 예정입니다.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 광고 소재별 분석 FAQ -->
                        <div class="faq-category">
                            <div class="faq-category-title">광고 소재별 분석</div>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>소재 이미지가 표시되지 않아요</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            소재 이미지는 광고 플랫폼(Facebook, Google 등)의 CDN에서 가져옵니다.
                                            다음 경우에 이미지가 표시되지 않을 수 있습니다:<br><br>
                                            • <strong>광고가 삭제/비활성화</strong>된 경우<br>
                                            • <strong>이미지 URL이 만료</strong>된 경우<br>
                                            • <strong>네트워크 문제</strong>로 로드 실패<br><br>
                                            이 경우 "이미지 로드 실패" 플레이스홀더가 표시됩니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>KPI 필터를 여러 개 설정하면 어떻게 적용되나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            KPI 필터는 최대 3개 조건을 설정할 수 있으며,
                                            <strong>"또는 (OR)"</strong>과 <strong>"그리고 (AND)"</strong> 연산자로 조합됩니다.<br><br>
                                            예시: ROAS ≥ 200% <strong>그리고</strong> CPA ≤ 15,000<br>
                                            → 두 조건을 <strong>모두 만족</strong>하는 소재만 표시<br><br>
                                            예시: ROAS ≥ 300% <strong>또는</strong> 전환수 ≥ 50<br>
                                            → 두 조건 중 <strong>하나라도 만족</strong>하는 소재 표시
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>ROAS가 0%로 표시되는 소재는 무엇인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            ROAS가 0%인 소재는 <strong>전환값(매출)이 0원</strong>인 경우입니다.<br><br>
                                            가능한 원인:<br>
                                            • 전환 추적이 제대로 설정되지 않음<br>
                                            • 아직 전환이 발생하지 않음 (러닝 초기)<br>
                                            • 전환값이 GA4/광고 플랫폼에 기록되지 않음<br><br>
                                            전환 추적 설정을 점검하거나, 충분한 러닝 기간이 지난 후 다시 확인하세요.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>소재 A/B 테스트 결과를 비교하고 싶어요</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            A/B 테스트 비교를 위한 추천 워크플로우:<br><br>
                                            1. <strong>캠페인 또는 광고세트 필터</strong>로 테스트 그룹 선택<br>
                                            2. <strong>ROAS 내림차순</strong>으로 정렬<br>
                                            3. 상위 소재들의 KPI 비교<br>
                                            4. 각 소재 클릭하여 <strong>일별 추이</strong> 확인<br><br>
                                            특정 기간의 테스트라면 <strong>날짜 필터</strong>를 함께 설정하세요.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 채널별 분석 FAQ -->
                        <div class="faq-category">
                            <div class="faq-category-title">채널별 분석 & 일반</div>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>데이터는 얼마나 자주 업데이트되나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            대시보드 데이터는 <strong>매일 자동으로 업데이트</strong>됩니다.
                                            각 광고 플랫폼(Meta, Google, Naver, Kakao 등)의 API를 통해 전일 데이터를 수집하며,
                                            보통 오전 중으로 전날까지의 성과가 반영됩니다.
                                            실시간 데이터가 아닌 점 참고해 주세요.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>ROAS가 100% 미만이면 문제가 있는 건가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            ROAS 100% 미만은 광고비보다 매출이 적다는 의미입니다.
                                            단, 이것이 항상 나쁜 것은 아닙니다. <strong>브랜드 인지도 캠페인</strong>이나
                                            <strong>신규 고객 확보</strong> 목적의 광고는 단기 ROAS보다
                                            LTV(고객 생애 가치)를 고려해야 합니다.
                                            지속적으로 ROAS가 낮다면 타겟팅, 크리에이티브, 랜딩페이지 등을 점검해 보세요.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>AI 예측은 얼마나 정확한가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            AI 예측은 과거 데이터 패턴을 학습하여 미래를 예측합니다.
                                            일반적으로 데이터가 많을수록, 패턴이 일정할수록 정확도가 높습니다.
                                            다만, 예상치 못한 외부 요인(시즌, 경쟁사 활동, 시장 변화 등)에 따라
                                            실제 결과는 달라질 수 있습니다.
                                            <strong>예측은 의사결정의 참고 자료</strong>로 활용하시고,
                                            정기적으로 실제 성과와 비교하여 검증하세요.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>모바일에서도 대시보드를 볼 수 있나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            네, 대시보드는 <strong>반응형 디자인</strong>으로 제작되어 모바일 기기에서도 확인할 수 있습니다.
                                            다만, 복잡한 차트와 테이블은 데스크톱 환경에서 보시는 것을 권장드립니다.
                                            주요 KPI와 AI 인사이트 확인은 모바일에서도 편하게 하실 수 있습니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>경고 알림이 떴는데 어떻게 대응해야 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            각 경고 알림에는 <strong>Financial Impact</strong>와 <strong>Action 가이드</strong>가 함께 제공됩니다.
                                            Action 가이드에 따라 1차 조치를 취하시고, 추가 분석이나 전략 수정이 필요하시면 담당 Growth Manager와 상의하세요.
                                            경고는 "문제"가 아닌 "개선 기회"로 보시면 됩니다!
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>데이터를 다운로드할 수 있나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            현재 대시보드 내 직접 다운로드 기능은 제공되지 않습니다.
                                            데이터 다운로드가 필요하시면 담당 Growth Manager에게 요청해 주세요.
                                            CSV 또는 Excel 형식으로 원하시는 기간과 지표의 데이터를 제공해 드립니다.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 실무 가이드 & 의사결정 FAQ -->
                        <div class="faq-category">
                            <div class="faq-category-title">실무 가이드 & 의사결정</div>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>오늘 아침에 대시보드에서 뭘 먼저 봐야 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            매일 아침 체크해야 할 순서를 알려드립니다:<br><br>
                                            <strong>1단계: AI 인사이트 확인</strong><br>
                                            • 시계열 분석 → 통합 인사이트에서 경고/이상 징후 확인<br><br>
                                            <strong>2단계: KPI 카드 훑어보기</strong><br>
                                            • 마케팅 대시보드 → 전일 대비 ROAS, CPA 변화 확인<br>
                                            • 빨간색 지표가 있으면 즉시 원인 파악<br><br>
                                            <strong>3단계: 문제 채널 드릴다운</strong><br>
                                            • 성과가 급락한 채널/캠페인 클릭하여 상세 분석<br><br>
                                            <strong>소요 시간:</strong> 5~10분이면 전체 현황 파악 가능!
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>어떤 채널에 예산을 더 투자해야 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            예산 배분 결정을 위한 3단계 분석법:<br><br>
                                            <strong>Step 1: BCG 매트릭스 확인</strong><br>
                                            • 퍼널 대시보드 → BCG 매트릭스에서 "Star" 위치 채널 확인<br>
                                            • 트래픽 높음 + 전환율 높음 = 예산 증액 1순위<br><br>
                                            <strong>Step 2: Forecast Matrix 확인</strong><br>
                                            • 시계열 분석 → "Super Star" 세그먼트 확인<br>
                                            • 현재 ROAS 높음 + 미래 성장 예측 = 투자 가치 높음<br><br>
                                            <strong>Step 3: 예산 시뮬레이션</strong><br>
                                            • 예산 슬라이더로 +20%, +50% 시뮬레이션<br>
                                            • 투자 효율이 100% 이상이면 증액 권장
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>갑자기 ROAS가 떨어졌어요. 어디서부터 확인해야 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            ROAS 하락 시 체계적인 원인 분석 방법:<br><br>
                                            <strong>1. 전체 vs 채널별 비교</strong><br>
                                            • 마케팅 대시보드에서 채널별 ROAS 확인<br>
                                            • 특정 채널만 하락? → 해당 채널 집중 분석<br>
                                            • 전체적으로 하락? → 외부 요인(시즌, 경쟁) 검토<br><br>
                                            <strong>2. 비용 vs 매출 분석</strong><br>
                                            • 비용이 급증했나? → CPC/CPM 상승 여부 확인<br>
                                            • 매출이 급감했나? → 전환율, 객단가 확인<br><br>
                                            <strong>3. 소재별 분석</strong><br>
                                            • 소재별 대시보드에서 ROAS 하락 소재 파악<br>
                                            • 피로도 높은 소재 교체 검토<br><br>
                                            <strong>4. 퍼널 점검</strong><br>
                                            • 퍼널 대시보드에서 이탈 급증 단계 확인
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>이번 주 리포트에 어떤 내용을 넣어야 할까요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            주간 리포트 작성 시 대시보드 활용법:<br><br>
                                            <strong>1. Executive Summary</strong><br>
                                            • 마케팅 대시보드 → "주별" 탭 선택<br>
                                            • 주간 총 비용, 매출, ROAS 요약<br><br>
                                            <strong>2. 채널별 성과 비교</strong><br>
                                            • 채널별 ROAS 테이블 캡처<br>
                                            • Top 3 / Bottom 3 채널 하이라이트<br><br>
                                            <strong>3. 핵심 인사이트</strong><br>
                                            • 시계열 분석 → AI 인사이트 요약 활용<br>
                                            • 주요 이상 징후 및 개선 제안 포함<br><br>
                                            <strong>4. 다음 주 액션 플랜</strong><br>
                                            • Forecast Matrix 기반 투자 방향<br>
                                            • 마이크로 세그먼트 기반 최적화 계획
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>상사/클라이언트에게 성과를 어떻게 설명해야 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            비전문가에게 설명할 때 유용한 표현:<br><br>
                                            <strong>ROAS 설명</strong><br>
                                            "광고비 100원당 ○○원의 매출이 발생했습니다."<br>
                                            예: ROAS 250% → "광고비 1만원당 2만5천원 매출"<br><br>
                                            <strong>CPA 설명</strong><br>
                                            "한 명의 고객을 확보하는 데 ○○원이 들었습니다."<br><br>
                                            <strong>증감 설명</strong><br>
                                            • 좋은 경우: "지난주 대비 효율이 15% 개선되었습니다."<br>
                                            • 나쁜 경우: "일시적 하락이지만 ○○ 조치로 회복 중입니다."<br><br>
                                            <strong>Tip:</strong> 차트 캡처 + 한 문장 요약이 가장 효과적!
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>광고를 껐다 켜야 할지 어떻게 판단하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            광고 ON/OFF 의사결정 기준:<br><br>
                                            <strong>끄는 것을 고려해야 할 때:</strong><br>
                                            • ROAS가 목표 대비 50% 이하로 2주 이상 지속<br>
                                            • 마이크로 세그먼트에서 "Traffic Waste"로 분류<br>
                                            • Forecast Matrix에서 "Problem Child" + 하락 추세<br><br>
                                            <strong>유지해야 할 때:</strong><br>
                                            • 신규 캠페인 (최소 2주 학습 기간 필요)<br>
                                            • 브랜딩 목적 캠페인 (ROAS 외 지표 확인)<br>
                                            • "Rising Star" 또는 "Hidden VIP" 분류<br><br>
                                            <strong>예산만 줄일 때:</strong><br>
                                            • ROAS 목표의 70~100% 수준<br>
                                            • 예산 시뮬레이션에서 "효율 점검" 등급
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AARRR 퍼널 대시보드 FAQ -->
                        <div class="faq-category">
                            <div class="faq-category-title">AARRR 퍼널 대시보드</div>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>AARRR 퍼널이란 무엇인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            AARRR은 고객 여정을 5단계로 분석하는 프레임워크입니다:<br><br>
                                            • <strong>Acquisition (유입)</strong>: 사용자가 처음 방문<br>
                                            • <strong>Activation (활동)</strong>: 첫 의미 있는 행동 (스크롤, 페이지뷰 등)<br>
                                            • <strong>Retention (관심)</strong>: 상품 조회, 장바구니 담기<br>
                                            • <strong>Revenue (결제)</strong>: 결제 시작<br>
                                            • <strong>Referral (구매)</strong>: 구매 완료<br><br>
                                            각 단계별 전환율과 이탈률을 분석하여 개선 포인트를 찾습니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>유형별 조치 가이드(마이크로 세그먼트)란 무엇인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            마이크로 세그먼트는 채널별 세부 데이터를 분석하여 <strong>4가지 유형</strong>으로 분류하고, 각 유형에 맞는 최적화 전략을 제시합니다:<br><br>
                                            • <strong>Hidden VIP</strong>: 높은 전환율, 낮은 트래픽 → 예산 확대 권장<br>
                                            • <strong>Traffic Waste</strong>: 낮은 전환율, 높은 트래픽 → 타겟팅 개선 필요<br>
                                            • <strong>Checkout Friction</strong>: 장바구니 이탈 높음 → 결제 프로세스 점검<br>
                                            • <strong>Rising Star</strong>: 성장률 높음 → 적극 투자 권장
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>마이크로 세그먼트 각 유형의 판별 조건은?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            각 유형은 다음 조건으로 판별됩니다:<br><br>
                                            <strong>Hidden VIP</strong><br>
                                            • 전환율 ≥ 전체 평균 × 1.5<br>
                                            • 트래픽 ≤ 전체 평균 × 0.5<br><br>
                                            <strong>Traffic Waste</strong><br>
                                            • 전환율 ≤ 전체 평균 × 0.5<br>
                                            • 트래픽 ≥ 전체 평균 × 1.5<br><br>
                                            <strong>Checkout Friction</strong><br>
                                            • 장바구니→결제 전환율 ≤ 30%<br><br>
                                            <strong>Rising Star</strong><br>
                                            • 전주 대비 전환수 성장률 ≥ 50%<br>
                                            • 전환율 ≥ 전체 평균
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>BCG 매트릭스의 분류 기준은 무엇인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            BCG 매트릭스는 두 가지 축으로 분류합니다:<br><br>
                                            • <strong>X축 (트래픽)</strong>: 채널별 방문자 수 (전체 평균 대비)<br>
                                            • <strong>Y축 (전환율)</strong>: 채널별 구매 전환율 (전체 평균 대비)<br><br>
                                            평균 이상이면 "높음", 평균 미만이면 "낮음"으로 분류하여 4분면에 배치합니다.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>퍼널에서 이탈이 가장 심한 단계를 어떻게 개선하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            단계별 이탈 개선 체크리스트:<br><br>
                                            <strong>유입 → 활동 이탈이 높을 때:</strong><br>
                                            • 랜딩 페이지 로딩 속도 체크 (3초 이내가 이상적)<br>
                                            • 광고 메시지와 랜딩 페이지 일관성 확인<br>
                                            • 모바일 최적화 상태 점검<br><br>
                                            <strong>관심 → 결제 이탈이 높을 때:</strong><br>
                                            • 장바구니 리마인더 이메일/푸시 설정<br>
                                            • 할인 쿠폰 팝업 테스트<br>
                                            • 상품 상세 페이지 정보 보강<br><br>
                                            <strong>결제 → 구매 이탈이 높을 때:</strong><br>
                                            • 결제 수단 다양화 (간편결제 추가)<br>
                                            • 결제 프로세스 단계 축소<br>
                                            • 보안 인증 마크 노출
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>Hidden VIP 채널을 발견했어요. 어떻게 활용하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            Hidden VIP는 숨겨진 보석! 다음 순서로 활용하세요:<br><br>
                                            <strong>1단계: 원인 분석</strong><br>
                                            • 왜 트래픽이 적은지 파악 (예산 부족? 노출 제한?)<br>
                                            • 현재 타겟팅 설정 확인<br><br>
                                            <strong>2단계: 테스트 확대</strong><br>
                                            • 예산 +30~50% 증액 테스트<br>
                                            • 유사 타겟으로 확장 테스트<br><br>
                                            <strong>3단계: 모니터링</strong><br>
                                            • 2주간 ROAS 변화 추적<br>
                                            • 전환율이 유지되면 추가 증액<br><br>
                                            <strong>주의:</strong> 급격한 예산 증가는 체감 수익 효과로 효율 하락 가능!
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>Traffic Waste 채널, 바로 꺼야 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            바로 끄기 전에 개선 가능성을 먼저 점검하세요:<br><br>
                                            <strong>끄기 전 체크리스트:</strong><br>
                                            • 타겟팅이 너무 넓지 않은가? → 세분화 테스트<br>
                                            • 광고 소재가 전환에 최적화되어 있나? → A/B 테스트<br>
                                            • 랜딩 페이지가 해당 채널에 맞는가? → 전용 랜딩 테스트<br><br>
                                            <strong>OFF 결정 기준:</strong><br>
                                            • 2주 이상 최적화 시도 후에도 개선 없음<br>
                                            • ROAS가 목표의 30% 미만 지속<br>
                                            • 예산을 다른 채널에 투입 시 더 높은 ROI 예상<br><br>
                                            <strong>대안:</strong> 완전 OFF 대신 예산 80% 감축 후 관찰
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 시계열 데이터 분석 FAQ -->
                        <div class="faq-category">
                            <div class="faq-category-title">시계열 데이터 분석</div>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>Forecast Matrix 4분면 분류 기준은 무엇인가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            Forecast Matrix는 <strong>현재 ROAS</strong>와 <strong>예측 성장률</strong>을 기준으로 4분면에 배치합니다:<br><br>
                                            • <strong>Super Star (★)</strong>: 현재 ROAS 높음 + 성장 예측 → 최우선 투자<br>
                                            • <strong>Fading Hero</strong>: 현재 ROAS 높음 + 하락 예측 → 대체 채널 준비<br>
                                            • <strong>Rising Potential</strong>: 현재 ROAS 낮음 + 성장 예측 → 테스트 확대<br>
                                            • <strong>Problem Child</strong>: 현재 ROAS 낮음 + 하락 예측 → 즉시 점검<br><br>
                                            기준값: ROAS 평균 대비 비교, 예측 성장률 0% 기준으로 상승/하락 판정
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>예산 시뮬레이션은 어떻게 계산되나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            예산 시뮬레이션은 <strong>체감 수익 모델</strong>을 적용하여 계산됩니다:<br><br>
                                            <strong>예산 증가 시:</strong><br>
                                            조정 ROAS = 현재 ROAS × (1 - 0.15 × ln(1 + 예산 변화율))<br><br>
                                            <strong>예산 감소 시:</strong><br>
                                            조정 ROAS = 현재 ROAS × (1 + 0.15 × ln(1 + |예산 변화율|) × 0.5)<br><br>
                                            <strong>추천 등급:</strong><br>
                                            • 투자 효율 ≥ 150%: 증액 추천<br>
                                            • 100% ~ 149%: 유지<br>
                                            • 50% ~ 99%: 효율 점검<br>
                                            • 50% 미만: 감액 검토
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>체감 수익 효과(Diminishing Returns)란?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            광고 예산을 늘릴수록 추가 전환당 비용이 증가하는 현상입니다.<br><br>
                                            <strong>왜 발생하나요?</strong><br>
                                            • 핵심 타겟 소진: 가장 반응 좋은 사용자부터 전환됨<br>
                                            • 광고 피로도: 동일 사용자에게 반복 노출 시 효과 감소<br>
                                            • 경쟁 심화: 예산 증가 시 입찰 경쟁으로 CPC 상승<br><br>
                                            <strong>시뮬레이션 상수:</strong> DIMINISHING_FACTOR = 0.15 (15% 체감률)<br>
                                            예: 예산 100% 증가 시 → ROAS 약 10.4% 감소 예상
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>Prophet 예측은 얼마나 정확한가요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            Prophet 예측의 정확도는 <strong>데이터의 양과 패턴의 일관성</strong>에 따라 달라집니다.
                                            일반적으로 데이터가 많고, 계절성이 뚜렷하며, 외부 요인 변동이 적을수록 정확도가 높습니다.<br><br>
                                            광고 데이터의 경우 평균 <strong>MAPE(평균 절대 백분율 오차) 10~20%</strong> 수준을 기대할 수 있습니다.
                                            예측은 참고용으로 활용하시고, 실제 데이터와 정기적으로 비교하여 검증하세요.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>주요 항목 트렌드 탭에서는 무엇을 볼 수 있나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            주요 항목 트렌드 탭에서는 세그먼트별로 주요 지표의 시계열 추이를 확인할 수 있습니다:<br><br>
                                            • <strong>비용 추이</strong>: 일/주/월별 광고비 변화<br>
                                            • <strong>ROAS 추이</strong>: 효율 변화 트렌드<br>
                                            • <strong>전환수 추이</strong>: 성과 볼륨 변화<br>
                                            • <strong>매출 추이</strong>: 매출액 시계열 분석<br><br>
                                            각 지표의 트렌드를 분석하여 성과 변화 원인을 파악하고 최적화 전략을 수립하세요.
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>예산을 얼마나 늘려야 최적일까요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            예산 시뮬레이션을 활용한 최적 증액폭 찾기:<br><br>
                                            <strong>Step 1: 현재 상태 확인</strong><br>
                                            • 시계열 분석 → 예산 시뮬레이션 탭 이동<br>
                                            • 세그먼트 선택 후 현재 ROAS 확인<br><br>
                                            <strong>Step 2: 단계별 시뮬레이션</strong><br>
                                            • 슬라이더로 +20%, +50%, +100% 테스트<br>
                                            • 각 단계별 예상 ROAS와 투자 효율 확인<br><br>
                                            <strong>Step 3: 최적점 찾기</strong><br>
                                            • 투자 효율이 100% 이상 유지되는 최대 증액폭 선택<br>
                                            • 보통 +30~50%가 효율 대비 안전한 증액폭<br><br>
                                            <strong>실무 팁:</strong> 한 번에 +100% 이상 증액보다 2주 간격 단계별 증액이 안전!
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>Fading Hero가 나왔어요. 지금 바로 조치해야 하나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            Fading Hero는 "지금은 좋지만 미래가 불투명"한 채널입니다:<br><br>
                                            <strong>즉시 조치 (1주 이내):</strong><br>
                                            • 해당 채널의 소재 피로도 점검<br>
                                            • 경쟁사 활동 증가 여부 확인<br>
                                            • 새로운 크리에이티브 테스트 시작<br><br>
                                            <strong>단기 대비 (2~4주):</strong><br>
                                            • 대체 가능한 "Rising Potential" 채널 예산 확대<br>
                                            • Fading Hero 채널 예산 점진적 감축 (주 10%씩)<br><br>
                                            <strong>중기 대비:</strong><br>
                                            • 해당 채널 완전 OFF 시 대체할 포트폴리오 구축<br>
                                            • 예측대로 하락 시 빠른 전환 가능하도록 준비<br><br>
                                            <strong>핵심:</strong> 당장 끄지 말고, 대안 준비하면서 점진적 축소!
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>예측값과 실제값 차이가 커요. 예측을 믿어도 되나요?</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            예측 신뢰도 판단 가이드:<br><br>
                                            <strong>예측을 신뢰할 수 있을 때:</strong><br>
                                            • 과거 예측값과 실제값 차이가 20% 이내였음<br>
                                            • 외부 요인(시즌, 프로모션)이 안정적<br>
                                            • 데이터가 6개월 이상 축적됨<br><br>
                                            <strong>예측을 참고만 해야 할 때:</strong><br>
                                            • 최근 예측 오차가 30% 이상<br>
                                            • 새로운 캠페인/채널 (데이터 부족)<br>
                                            • 시즌 변동기 (추석, 연말 등)<br><br>
                                            <strong>차이가 큰 이유 분석:</strong><br>
                                            • 프로모션 일정이 반영 안 됨<br>
                                            • 경쟁사 활동 변화<br>
                                            • 광고 설정 변경 (타겟, 입찰 등)<br><br>
                                            <strong>활용법:</strong> 예측값 자체보다 "방향성"을 참고하세요!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 트러블슈팅 FAQ -->
                        <div class="faq-category">
                            <div class="faq-category-title">트러블슈팅 & 문제해결</div>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>대시보드가 로딩되지 않거나 느려요</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            로딩 문제 해결 순서:<br><br>
                                            <strong>1. 기본 점검:</strong><br>
                                            • 인터넷 연결 상태 확인<br>
                                            • 브라우저 새로고침 (Ctrl+Shift+R)<br>
                                            • 다른 브라우저로 접속 시도 (Chrome 권장)<br><br>
                                            <strong>2. 캐시 정리:</strong><br>
                                            • Chrome: Ctrl+Shift+Delete → 캐시된 이미지 및 파일 삭제<br>
                                            • 시크릿 모드로 접속 테스트<br><br>
                                            <strong>3. 필터 범위 축소:</strong><br>
                                            • 날짜 범위를 최근 30일로 줄여서 로딩<br>
                                            • 채널/캠페인 필터로 데이터 양 줄이기<br><br>
                                            <strong>계속 문제 시:</strong> support@growthmaker.kr로 문의
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>데이터가 어제와 다르게 보여요</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            데이터 불일치 원인과 해결법:<br><br>
                                            <strong>정상적인 경우:</strong><br>
                                            • 광고 플랫폼의 전환 지연 반영 (최대 72시간)<br>
                                            • Attribution Window 내 전환 재집계<br>
                                            • 일별 → 주별/월별 탭 전환 시 집계 방식 차이<br><br>
                                            <strong>확인이 필요한 경우:</strong><br>
                                            • 특정 채널 데이터만 급변 → 해당 플랫폼 점검<br>
                                            • 모든 채널 데이터 급변 → 데이터 파이프라인 확인 필요<br><br>
                                            <strong>조치 방법:</strong><br>
                                            • 광고 플랫폼 관리자 화면에서 교차 검증<br>
                                            • 큰 차이 지속 시 담당 GM에게 연락
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>차트가 비어있거나 "데이터 없음"이 표시돼요</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            데이터 없음 문제 해결:<br><br>
                                            <strong>필터 설정 확인:</strong><br>
                                            • 날짜 범위가 너무 좁지 않은지 확인<br>
                                            • 채널/캠페인 필터가 빈 데이터 조합 아닌지 확인<br>
                                            • "전체"로 필터 초기화 후 다시 시도<br><br>
                                            <strong>데이터 존재 여부:</strong><br>
                                            • 해당 기간에 광고 집행이 있었는지 확인<br>
                                            • 새로 추가된 채널은 데이터 수집에 1~2일 소요<br><br>
                                            <strong>특정 차트만 빈 경우:</strong><br>
                                            • 해당 지표에 데이터가 없을 수 있음<br>
                                            • 예: 전환 추적 미설정 시 ROAS 차트 공백
                                        </div>
                                    </div>
                                </div>

                                <div class="faq-item">
                                    <button class="faq-question" onclick="toggleFaq(this)">
                                        <span>광고 플랫폼 수치와 대시보드 수치가 달라요</span>
                                        <span class="faq-icon">▼</span>
                                    </button>
                                    <div class="faq-answer">
                                        <div class="faq-answer-content">
                                            수치 차이가 발생하는 일반적인 이유:<br><br>
                                            <strong>1. 시간대 차이:</strong><br>
                                            • 대시보드: 한국 시간(KST) 기준<br>
                                            • 광고 플랫폼: 계정 설정 시간대 기준<br>
                                            • → 광고 플랫폼 시간대 설정 확인<br><br>
                                            <strong>2. 데이터 수집 시점:</strong><br>
                                            • 대시보드: 매일 새벽 배치 수집<br>
                                            • 플랫폼: 실시간 업데이트<br>
                                            • → 당일 데이터는 차이 발생 정상<br><br>
                                            <strong>3. Attribution 모델 차이:</strong><br>
                                            • 플랫폼마다 전환 귀속 방식이 다름<br>
                                            • → 대시보드 기준을 표준으로 사용 권장<br><br>
                                            <strong>5% 이상 차이 시:</strong> 담당 GM에게 점검 요청
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 문의하기 탭 -->
                <div class="tab-content" id="tab-contact">
                    <div class="card contact-section">
                        <div class="section-header">직접 문의하기</div>
                        <p style="color: var(--grey-600); margin-bottom: 24px; font-size: 14px;">
                            FAQ에서 답을 찾지 못하셨나요? 아래 양식을 작성해 주시면 담당자가 빠르게 답변 드리겠습니다.
                        </p>

                        <form class="contact-form" id="contactForm" onsubmit="submitForm(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        회사명
                                        <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-input" id="companyName" placeholder="회사명을 입력해 주세요" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        담당자명
                                    </label>
                                    <input type="text" class="form-input" id="contactName" placeholder="담당자명 (선택사항)">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">
                                        이메일
                                    </label>
                                    <input type="email" class="form-input" id="contactEmail" placeholder="회신받으실 이메일 (선택사항)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        문의 유형
                                    </label>
                                    <select class="form-input" id="inquiryType">
                                        <option value="일반 문의">일반 문의</option>
                                        <option value="기능 관련">기능 관련</option>
                                        <option value="데이터 관련">데이터 관련</option>
                                        <option value="오류 신고">오류 신고</option>
                                        <option value="기능 요청">기능 요청</option>
                                        <option value="기타">기타</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    문의 내용
                                    <span class="required">*</span>
                                </label>
                                <textarea class="form-input form-textarea" id="inquiryContent" placeholder="문의하실 내용을 상세히 작성해 주세요." required></textarea>
                            </div>

                            <button type="submit" class="submit-btn">
                                <svg viewBox="0 0 24 24">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                                문의 저장하기
                            </button>
                        </form>

                        <div class="success-message" id="successMessage">
                            <div class="success-message-icon">✅</div>
                            <div class="success-message-title">메일 앱이 열렸습니다!</div>
                            <div class="success-message-text">
                                Gmail 또는 기본 메일 앱에서 메일 전송을 완료해 주세요.<br>
                                빠른 시일 내에 답변 드리겠습니다.
                            </div>
                        </div>

                        <div class="help-box">
                            <div class="help-box-icon">💡</div>
                            <div class="help-box-content">
                                <div class="help-box-title">빠른 답변을 원하시나요?</div>
                                <div class="help-box-text">
                                    긴급한 문의는 <a href="mailto:support@growthmaker.kr">support@growthmaker.kr</a>로 직접 메일을 보내주시거나,
                                    담당 Growth Manager에게 연락해 주세요.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            </div>

        </main>
    </div>

    <!-- SPA 라우팅 스크립트 -->
    <script>
        // 페이지 라우팅
        function navigateToPage(pageId) {
            // 모든 페이지 섹션 숨기기
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });

            // 선택된 페이지 보이기
            const targetPage = document.querySelector(`.page-section[data-page="${pageId}"]`);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // 네비게이션 활성화 상태 업데이트
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeNav = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            // 페이지 상단으로 스크롤
            window.scrollTo(0, 0);

            // 페이지별 초기화 함수 호출
            if (typeof window[`init_${pageId}`] === 'function') {
                window[`init_${pageId}`]();
            }
        }

        // 해시 변경 감지
        function handleHashChange() {
            const hash = window.location.hash.slice(1) || 'dashboard';
            navigateToPage(hash);
        }

        // 이벤트 리스너 등록
        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('DOMContentLoaded', handleHashChange);

        // 네비게이션 클릭 이벤트
        document.addEventListener('click', function(e) {
            const navItem = e.target.closest('.nav-item');
            if (navItem && navItem.dataset.page) {
                e.preventDefault();
                window.location.hash = navItem.dataset.page;
            }
        });
    </script>


    <!-- ========== 광고 성과 대시보드 스크립트 (marketing_dashboard_v3.html) ========== -->
    <script>
    (function() {
        // dashboard 페이지 스크립트
        
        // Chart.js Datalabels 플러그인 등록
        Chart.register(ChartDataLabels);

        // 전역 변수
        let allData = [];
        let currentView = 'monthly';
        let showDataLabels = false;
        let filters = {
            type: '',
            brand: '',
            product: '',
            promotion: '',
            startDate: '',
            endDate: '',
            campaign: '',
            setName: ''
        };
        let trendChart = null;

        // CSV 파일 목록
        const csvFiles = [
            'raw/raw_data.csv'
        ];

        // CSV 파싱 함수 (RFC 4180 호환)
        function parseCSV(text) {
            const lines = text.trim().split('\n');

            // RFC 4180 호환 CSV 파싱
            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // 연속된 따옴표는 이스케이프된 따옴표
                            current += '"';
                            i++; // 다음 따옴표 건너뛰기
                        } else {
                            // 따옴표 시작/종료
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 따옴표 밖의 쉼표는 구분자
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                // 마지막 필드 추가
                result.push(current);
                return result;
            }

            const headers = parseLine(lines[0]).map(h => h.trim());

            return lines.slice(1).map(line => {
                const values = parseLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
        }

        // 데이터 로드
        async function loadData() {
            const promises = csvFiles.map(file =>
                fetch(file)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to load ${file}`);
                        return response.text();
                    })
                    .then(text => parseCSV(text))
                    .catch(err => {
                        console.warn(`Could not load ${file}:`, err);
                        return [];
                    })
            );

            const results = await Promise.all(promises);
            allData = results.flat();

            // unique 값으로 필터 옵션 설정
            populateFilters();

            // 날짜 범위 설정
            setDateRange();

            // 세부 필터 옵션 설정
            updateDetailFilters();

            // 초기 데이터 표시
            updateDashboard();
        }

        // 필터 옵션 설정 (유형구분만 초기화, 나머지는 계층 구조로 업데이트)
        function populateFilters() {
            const types = [...new Set(allData.map(d => d['유형구분']))].filter(Boolean).sort();
            populateSelect('filterType', types);

            // 브랜드명, 상품명, 프로모션은 계층 구조로 업데이트
            updateBrandFilter();
        }

        // 브랜드명 필터 업데이트 (유형구분의 하위 속성)
        function updateBrandFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                return true;
            });

            const brands = [...new Set(filteredData.map(d => d['브랜드명']))].filter(Boolean).sort();
            const currentBrand = filters.brand;
            const brandSelect = document.getElementById('filterBrand');

            brandSelect.innerHTML = '<option value="">전체</option>';
            brands.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                brandSelect.appendChild(option);
            });

            if (brands.includes(currentBrand)) {
                brandSelect.value = currentBrand;
            } else {
                filters.brand = '';
                brandSelect.value = '';
            }

            // 상품명 업데이트 (브랜드명에 종속)
            updateProductFilter();
        }

        // 상품명 필터 업데이트 (브랜드명의 하위 속성)
        function updateProductFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                return true;
            });

            const products = [...new Set(filteredData.map(d => d['상품명']))].filter(Boolean).sort();
            const currentProduct = filters.product;
            const productSelect = document.getElementById('filterProduct');

            productSelect.innerHTML = '<option value="">전체</option>';
            products.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                productSelect.appendChild(option);
            });

            if (products.includes(currentProduct)) {
                productSelect.value = currentProduct;
            } else {
                filters.product = '';
                productSelect.value = '';
            }

            // 프로모션 업데이트 (상품명에 종속)
            updatePromotionFilter();
        }

        // 프로모션 필터 업데이트 (상품명의 하위 속성)
        function updatePromotionFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                return true;
            });

            const promotions = [...new Set(filteredData.map(d => d['프로모션']))].filter(Boolean).sort();
            const currentPromotion = filters.promotion;
            const promotionSelect = document.getElementById('filterPromotion');

            promotionSelect.innerHTML = '<option value="">전체</option>';
            promotions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                promotionSelect.appendChild(option);
            });

            if (promotions.includes(currentPromotion)) {
                promotionSelect.value = currentPromotion;
            } else {
                filters.promotion = '';
                promotionSelect.value = '';
            }
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        // 세부 필터 옵션 동적 업데이트 (기존 필터 조건을 만족하는 데이터에서만 추출)
        function updateDetailFilters() {
            // 기존 필터 조건을 만족하는 데이터 필터링
            const filteredData = allData.filter(row => {
                // 기간 조건
                if (filters.startDate || filters.endDate) {
                    const rowDate = new Date(row['일 구분']);
                    if (isNaN(rowDate)) return false;
                    if (filters.startDate && rowDate < new Date(filters.startDate)) return false;
                    if (filters.endDate && rowDate > new Date(filters.endDate)) return false;
                }

                // 기본 필터 조건
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                if (filters.promotion && row['프로모션'] !== filters.promotion) return false;

                return true;
            });

            // 캠페인 unique 값 추출
            const campaigns = [...new Set(filteredData.map(d => d['캠페인']))].filter(Boolean).sort();

            // 기존 선택값 저장
            const currentCampaign = filters.campaign;

            // 캠페인 드롭다운 초기화 및 재설정
            const campaignSelect = document.getElementById('filterCampaign');

            campaignSelect.innerHTML = '<option value="">전체</option>';

            campaigns.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                campaignSelect.appendChild(option);
            });

            // 기존 선택값이 새 옵션에 존재하면 유지, 아니면 초기화
            if (campaigns.includes(currentCampaign)) {
                campaignSelect.value = currentCampaign;
            } else {
                filters.campaign = '';
                campaignSelect.value = '';
            }

            // 세트이름 업데이트 (캠페인에 종속)
            updateSetNameFilter();
        }

        // 세트이름 필터 업데이트 (캠페인의 하위 속성)
        function updateSetNameFilter() {
            // 기존 필터 조건 + 캠페인 조건을 만족하는 데이터 필터링
            const filteredData = allData.filter(row => {
                // 기간 조건
                if (filters.startDate || filters.endDate) {
                    const rowDate = new Date(row['일 구분']);
                    if (isNaN(rowDate)) return false;
                    if (filters.startDate && rowDate < new Date(filters.startDate)) return false;
                    if (filters.endDate && rowDate > new Date(filters.endDate)) return false;
                }

                // 기본 필터 조건
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                if (filters.promotion && row['프로모션'] !== filters.promotion) return false;

                // 캠페인 조건 (세트이름은 캠페인의 하위 속성)
                if (filters.campaign && row['캠페인'] !== filters.campaign) return false;

                return true;
            });

            // 세트이름 unique 값 추출
            const setNames = [...new Set(filteredData.map(d => d['세트이름']))].filter(Boolean).sort();

            // 기존 선택값 저장
            const currentSetName = filters.setName;

            // 세트이름 드롭다운 초기화 및 재설정
            const setNameSelect = document.getElementById('filterSetName');

            setNameSelect.innerHTML = '<option value="">전체</option>';

            setNames.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                setNameSelect.appendChild(option);
            });

            // 기존 선택값이 새 옵션에 존재하면 유지, 아니면 초기화
            if (setNames.includes(currentSetName)) {
                setNameSelect.value = currentSetName;
            } else {
                filters.setName = '';
                setNameSelect.value = '';
            }
        }

        // 기간 및 기본 필터 초기화
        function resetBasicFilters() {
            // 날짜 범위 초기화 (전체 기간으로)
            setDateRange();

            // 기본 필터 초기화
            filters.type = '';
            filters.brand = '';
            filters.product = '';
            filters.promotion = '';

            document.getElementById('filterType').value = '';
            document.getElementById('filterBrand').value = '';
            document.getElementById('filterProduct').value = '';
            document.getElementById('filterPromotion').value = '';

            // 계층 구조 필터 다시 로드
            updateBrandFilter();

            // 세부 필터도 업데이트
            updateDetailFilters();

            // 대시보드 갱신
            updateDashboard();
        }

        // 세부 필터 초기화
        function resetDetailFilters() {
            filters.campaign = '';
            filters.setName = '';

            document.getElementById('filterCampaign').value = '';
            document.getElementById('filterSetName').value = '';

            // 대시보드 갱신
            updateDashboard();
        }

        // 날짜 범위 설정
        function setDateRange() {
            const dates = allData
                .map(d => d['일 구분'])
                .filter(Boolean)
                .map(d => new Date(d))
                .filter(d => !isNaN(d));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                document.getElementById('startDate').value = formatDateForInput(minDate);
                document.getElementById('endDate').value = formatDateForInput(maxDate);

                filters.startDate = formatDateForInput(minDate);
                filters.endDate = formatDateForInput(maxDate);
            }
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // 데이터 필터링
        function filterData() {
            return allData.filter(row => {
                // 기본 필터 조건 확인
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                if (filters.promotion && row['프로모션'] !== filters.promotion) return false;

                // 날짜 범위 확인
                if (filters.startDate || filters.endDate) {
                    const rowDate = new Date(row['일 구분']);
                    if (isNaN(rowDate)) return false;

                    if (filters.startDate && rowDate < new Date(filters.startDate)) return false;
                    if (filters.endDate && rowDate > new Date(filters.endDate)) return false;
                }

                // 세부 필터 조건 확인
                if (filters.campaign && row['캠페인'] !== filters.campaign) return false;
                if (filters.setName && row['세트이름'] !== filters.setName) return false;

                return true;
            });
        }

        // 데이터 집계
        function aggregateData(data) {
            const groupKey = {
                'daily': '일 구분',
                'weekly': '주 구분',
                'monthly': '월 구분'
            }[currentView];

            const groups = {};

            data.forEach(row => {
                const key = row[groupKey];
                if (!key) return;

                if (!groups[key]) {
                    groups[key] = {
                        period: key,
                        비용: 0,
                        노출: 0,
                        클릭: 0,
                        전환수: 0,
                        전환값: 0
                    };
                }

                groups[key].비용 += parseFloat(row['비용']) || 0;
                groups[key].노출 += parseFloat(row['노출']) || 0;
                groups[key].클릭 += parseFloat(row['클릭']) || 0;
                groups[key].전환수 += parseFloat(row['전환수']) || 0;
                groups[key].전환값 += parseFloat(row['전환값']) || 0;
            });

            // KPI 계산
            return Object.values(groups).map(g => ({
                ...g,
                CPM: g.노출 > 0 ? (g.비용 / g.노출 * 1000) : 0,
                CPC: g.클릭 > 0 ? (g.비용 / g.클릭) : 0,
                CPA: g.전환수 > 0 ? (g.비용 / g.전환수) : 0,
                ROAS: g.비용 > 0 ? (g.전환값 / g.비용 * 100) : 0
            })).sort((a, b) => {
                // 날짜순 정렬
                const dateA = new Date(a.period.replace(/\. /g, '-').replace(/\./g, ''));
                const dateB = new Date(b.period.replace(/\. /g, '-').replace(/\./g, ''));
                return dateA - dateB;
            });
        }

        // 대시보드 업데이트
        function updateDashboard() {
            const filteredData = filterData();
            const aggregatedData = aggregateData(filteredData);

            // KPI 업데이트
            updateKPIs(aggregatedData);

            // 차트 업데이트
            updateChart(aggregatedData);

            // 테이블 업데이트
            updateTable(aggregatedData);
        }

        // 차트 데이터 저장
        let currentChartData = [];

        // 차트 업데이트
        function updateChart(data) {
            currentChartData = data;
            renderChart();
        }

        // 차트 렌더링
        function renderChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');

            // 기존 차트 제거
            if (trendChart) {
                trendChart.destroy();
            }

            const data = currentChartData;
            const labels = data.map(d => d.period);

            // 체크박스 상태 확인
            const showCost = document.getElementById('chartCost').checked;
            const showCPM = document.getElementById('chartCPM').checked;
            const showCPC = document.getElementById('chartCPC').checked;
            const showCPA = document.getElementById('chartCPA').checked;
            const showROAS = document.getElementById('chartROAS').checked;

            // Y축 결정 로직 (모든 조합 고려)
            // 우선순위: 비용 > CPM > CPC > CPA > ROAS
            // 첫 번째 지표는 왼쪽, 나머지는 오른쪽
            const hasCostMetric = showCost;
            const hasCpmMetric = showCPM;
            const hasCpcMetric = showCPC;
            const hasCpaMetric = showCPA;

            // 오른쪽 축 사용 여부 결정 (2개 이상 지표 선택 시)
            const selectedCount = (showCost ? 1 : 0) + (showCPM ? 1 : 0) + (showCPC ? 1 : 0) + (showCPA ? 1 : 0) + (showROAS ? 1 : 0);
            const useRightAxis = selectedCount >= 2;

            const datasets = [];

            if (showCost) {
                datasets.push({
                    label: '비용',
                    data: data.map(d => d.비용),
                    backgroundColor: 'rgba(103, 58, 183, 0.7)',
                    borderColor: 'rgba(103, 58, 183, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    yAxisID: 'y',
                    order: 4
                });
            }

            if (showCPM) {
                datasets.push({
                    label: 'CPM',
                    data: data.map(d => d.CPM),
                    type: 'line',
                    borderColor: 'rgba(255, 171, 0, 1)',
                    backgroundColor: 'rgba(255, 171, 0, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(255, 171, 0, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0.4,
                    yAxisID: hasCostMetric ? 'y1' : 'y',
                    order: 3
                });
            }

            if (showCPC) {
                datasets.push({
                    label: 'CPC',
                    data: data.map(d => d.CPC),
                    type: 'line',
                    borderColor: 'rgba(33, 150, 243, 1)',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(33, 150, 243, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0.4,
                    yAxisID: (hasCostMetric || hasCpmMetric) ? 'y1' : 'y',
                    order: 3
                });
            }

            if (showCPA) {
                datasets.push({
                    label: 'CPA',
                    data: data.map(d => d.CPA),
                    type: 'line',
                    borderColor: 'rgba(255, 152, 0, 1)',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(255, 152, 0, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0.4,
                    yAxisID: (hasCostMetric || hasCpmMetric || hasCpcMetric) ? 'y1' : 'y',
                    order: 2
                });
            }

            if (showROAS) {
                datasets.push({
                    label: 'ROAS (%)',
                    data: data.map(d => d.ROAS),
                    type: 'line',
                    borderColor: 'rgba(0, 200, 83, 1)',
                    backgroundColor: 'rgba(0, 200, 83, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(0, 200, 83, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    fill: true,
                    tension: 0.4,
                    yAxisID: (hasCostMetric || hasCpmMetric || hasCpcMetric || hasCpaMetric) ? 'y1' : 'y',
                    order: 1
                });
            }

            // 오른쪽 Y축 표시 여부와 타이틀 결정
            const showY1 = useRightAxis;

            // 오른쪽 Y축 타이틀 결정
            const y1Title = (function() {
                const rightMetrics = [];
                if (hasCostMetric && showCPM) rightMetrics.push('CPM');
                if ((hasCostMetric || hasCpmMetric) && showCPC) rightMetrics.push('CPC');
                if ((hasCostMetric || hasCpmMetric || hasCpcMetric) && showCPA) rightMetrics.push('CPA');
                if ((hasCostMetric || hasCpmMetric || hasCpcMetric || hasCpaMetric) && showROAS) rightMetrics.push('ROAS');

                if (rightMetrics.length === 0) return '';
                if (rightMetrics.includes('ROAS') && rightMetrics.length === 1) return 'ROAS (%)';
                if (rightMetrics.includes('ROAS')) return rightMetrics.join('/');
                return rightMetrics.join('/') + ' (원)';
            })();

            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.9)',
                            titleFont: {
                                family: "'Inter', sans-serif",
                                size: 13
                            },
                            bodyFont: {
                                family: "'Inter', sans-serif",
                                size: 12
                            },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'ROAS (%)') {
                                        label += Math.round(context.parsed.y) + '%';
                                    } else {
                                        label += formatNumber(context.parsed.y) + '원';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: showDataLabels,
                            anchor: function(context) {
                                // bar 차트는 end, line 차트는 end
                                return 'end';
                            },
                            align: function(context) {
                                // bar 차트는 top, line 차트는 top
                                return 'top';
                            },
                            offset: 4,
                            font: {
                                family: "'Inter', sans-serif",
                                size: 11,
                                weight: '600'
                            },
                            color: function(context) {
                                // 데이터셋의 색상 사용
                                return context.dataset.borderColor || context.dataset.backgroundColor;
                            },
                            formatter: function(value, context) {
                                if (context.dataset.label === 'ROAS (%)') {
                                    return Math.round(value) + '%';
                                } else {
                                    // 모든 숫자를 콤마로 구분하여 표시
                                    return formatNumber(Math.round(value));
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: (function() {
                                    if (showCost) return '비용 (원)';
                                    if (showCPM) return 'CPM (원)';
                                    if (showCPC) return 'CPC (원)';
                                    if (showCPA) return 'CPA (원)';
                                    if (showROAS) return 'ROAS (%)';
                                    return '금액 (원)';
                                })(),
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                },
                                callback: function(value) {
                                    // ROAS만 선택된 경우 % 표시
                                    if (!showCost && !showCPM && !showCPC && !showCPA && showROAS) {
                                        return value + '%';
                                    }
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: showY1,
                            position: 'right',
                            title: {
                                display: true,
                                text: y1Title,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                },
                                callback: function(value) {
                                    // 오른쪽 축에 ROAS만 있는 경우 % 표시
                                    const rightMetrics = [];
                                    if (hasCostMetric && showCPM) rightMetrics.push('CPM');
                                    if ((hasCostMetric || hasCpmMetric) && showCPC) rightMetrics.push('CPC');
                                    if ((hasCostMetric || hasCpmMetric || hasCpcMetric) && showCPA) rightMetrics.push('CPA');
                                    if ((hasCostMetric || hasCpmMetric || hasCpcMetric || hasCpaMetric) && showROAS) rightMetrics.push('ROAS');

                                    if (rightMetrics.includes('ROAS') && rightMetrics.length === 1) {
                                        return value + '%';
                                    } else if (!rightMetrics.includes('ROAS')) {
                                        return formatNumber(value);
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // KPI 업데이트
        function updateKPIs(data) {
            // 1. 신규 KPI 박스 - 전체 합계
            const totals = data.reduce((acc, row) => {
                acc.비용 += row.비용;
                acc.노출 += row.노출;
                acc.클릭 += row.클릭;
                acc.전환수 += row.전환수;
                acc.전환값 += row.전환값;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            const totalCPM = totals.노출 > 0 ? (totals.비용 / totals.노출 * 1000) : 0;
            const totalCPC = totals.클릭 > 0 ? (totals.비용 / totals.클릭) : 0;
            const totalCPA = totals.전환수 > 0 ? (totals.비용 / totals.전환수) : 0;
            const totalROASValue = totals.비용 > 0 ? (totals.전환값 / totals.비용 * 100) : 0;

            // 신규 KPI 박스 (총합계) 업데이트
            document.getElementById('summaryTotalCost').textContent = formatNumber(totals.비용);
            document.getElementById('summaryTotalImpressions').textContent = formatNumber(totals.노출);
            document.getElementById('summaryAvgCPM').textContent = formatNumber(totalCPM);
            document.getElementById('summaryTotalClicks').textContent = formatNumber(totals.클릭);
            document.getElementById('summaryAvgCPC').textContent = formatNumber(totalCPC);
            document.getElementById('summaryTotalConversions').textContent = formatNumber(totals.전환수);
            document.getElementById('summaryAvgCPA').textContent = formatNumber(totalCPA);
            document.getElementById('summaryTotalConversionValue').textContent = formatNumber(totals.전환값);
            document.getElementById('summaryTotalROAS').textContent = formatROAS(totalROASValue);

            // 2. 기존 KPI 박스 - 최신 기간 데이터
            if (data.length >= 1) {
                const lastPeriodData = data[data.length - 1];
                const lastCPM = lastPeriodData.노출 > 0 ? (lastPeriodData.비용 / lastPeriodData.노출 * 1000) : 0;
                const lastCPC = lastPeriodData.클릭 > 0 ? (lastPeriodData.비용 / lastPeriodData.클릭) : 0;
                const lastCPA = lastPeriodData.전환수 > 0 ? (lastPeriodData.비용 / lastPeriodData.전환수) : 0;
                const lastROAS = lastPeriodData.비용 > 0 ? (lastPeriodData.전환값 / lastPeriodData.비용 * 100) : 0;

                document.getElementById('totalCost').textContent = formatNumber(lastPeriodData.비용);
                document.getElementById('totalImpressions').textContent = formatNumber(lastPeriodData.노출);
                document.getElementById('avgCPM').textContent = formatNumber(lastCPM);
                document.getElementById('totalClicks').textContent = formatNumber(lastPeriodData.클릭);
                document.getElementById('avgCPC').textContent = formatNumber(lastCPC);
                document.getElementById('totalConversions').textContent = formatNumber(lastPeriodData.전환수);
                document.getElementById('avgCPA').textContent = formatNumber(lastCPA);
                document.getElementById('totalConversionValue').textContent = formatNumber(lastPeriodData.전환값);
                document.getElementById('totalROAS').textContent = formatROAS(lastROAS);
            } else {
                document.getElementById('totalCost').textContent = '-';
                document.getElementById('totalImpressions').textContent = '-';
                document.getElementById('avgCPM').textContent = '-';
                document.getElementById('totalClicks').textContent = '-';
                document.getElementById('avgCPC').textContent = '-';
                document.getElementById('totalConversions').textContent = '-';
                document.getElementById('avgCPA').textContent = '-';
                document.getElementById('totalConversionValue').textContent = '-';
                document.getElementById('totalROAS').textContent = '-';
            }

            // 증감율 계산 (마지막 기간 vs 직전 기간 비교)
            // 테이블 최하단이 최신 데이터, 그 위가 이전 데이터
            if (data.length >= 2) {
                // 마지막 기간과 직전 기간 (테이블 순서 기준)
                const lastPeriodData = data[data.length - 1];
                const prevPeriodData = data[data.length - 2];

                const calcMetrics = (row) => {
                    return {
                        비용: row.비용,
                        노출: row.노출,
                        클릭: row.클릭,
                        전환수: row.전환수,
                        전환값: row.전환값,
                        CPM: row.노출 > 0 ? (row.비용 / row.노출 * 1000) : 0,
                        CPC: row.클릭 > 0 ? (row.비용 / row.클릭) : 0,
                        CPA: row.전환수 > 0 ? (row.비용 / row.전환수) : 0,
                        ROAS: row.비용 > 0 ? (row.전환값 / row.비용 * 100) : 0
                    };
                };

                const first = calcMetrics(prevPeriodData);  // 이전 기간
                const second = calcMetrics(lastPeriodData); // 현재 기간 (마지막)

                const calcChange = (newVal, oldVal) => {
                    if (oldVal === 0) return newVal > 0 ? 100 : 0;
                    return ((newVal - oldVal) / oldVal * 100);
                };

                // 증감율 업데이트 함수
                const updateTrend = (id, change, oldValue, newValue, isGoodWhenUp = true, isPercentage = false) => {
                    const el = document.getElementById(id);
                    const ppEl = document.getElementById(id + 'PP');
                    const detailEl = document.getElementById(id + 'Detail');
                    if (!el) return;

                    const isUp = change >= 0;
                    const isGood = isGoodWhenUp ? isUp : !isUp;

                    // kpi-trend 클래스 업데이트
                    el.className = `kpi-trend ${isGood ? 'up' : 'down'}`;

                    // trend-value 업데이트
                    const trendValueEl = el.querySelector('.trend-value');
                    if (trendValueEl) {
                        const arrow = isUp ? '↑' : '↓';
                        trendValueEl.textContent = `${arrow} ${Math.abs(Math.round(change))}%`;
                    }

                    // trend-pp 업데이트 (%p 또는 수치 차이)
                    if (ppEl) {
                        if (isPercentage) {
                            // ROAS 등 퍼센트 지표: %p로 표시
                            const pp = newValue - oldValue;
                            const ppSign = pp >= 0 ? '+' : '';
                            ppEl.textContent = `${ppSign}${Math.round(pp)}%p`;
                            ppEl.className = `trend-pp ${pp >= 0 ? 'positive' : 'negative'}`;
                        } else {
                            // 일반 숫자: 차이값 표시
                            const diff = newValue - oldValue;
                            const diffSign = diff >= 0 ? '+' : '';
                            ppEl.textContent = `${diffSign}${formatNumber(diff)}`;
                            ppEl.className = `trend-pp ${isGood ? 'positive' : 'negative'}`;
                        }
                    }

                    // 상세 정보 업데이트 (이전 값)
                    if (detailEl) {
                        if (isPercentage) {
                            detailEl.innerHTML = `<span class="prev-label">이전</span><span class="prev-value">${Math.round(oldValue)}%</span>`;
                        } else {
                            detailEl.innerHTML = `<span class="prev-label">이전</span><span class="prev-value">${formatNumber(oldValue)}</span>`;
                        }
                    }
                };

                // 비용, 노출, 클릭, 전환수, 전환값은 증가가 좋음
                updateTrend('trendCost', calcChange(second.비용, first.비용), first.비용, second.비용, true, false);
                updateTrend('trendImpressions', calcChange(second.노출, first.노출), first.노출, second.노출, true, false);
                updateTrend('trendClicks', calcChange(second.클릭, first.클릭), first.클릭, second.클릭, true, false);
                updateTrend('trendConversions', calcChange(second.전환수, first.전환수), first.전환수, second.전환수, true, false);
                updateTrend('trendConversionValue', calcChange(second.전환값, first.전환값), first.전환값, second.전환값, true, false);
                updateTrend('trendROAS', calcChange(second.ROAS, first.ROAS), first.ROAS, second.ROAS, true, true);

                // CPM, CPC, CPA는 감소가 좋음
                updateTrend('trendCPM', calcChange(second.CPM, first.CPM), first.CPM, second.CPM, false, false);
                updateTrend('trendCPC', calcChange(second.CPC, first.CPC), first.CPC, second.CPC, false, false);
                updateTrend('trendCPA', calcChange(second.CPA, first.CPA), first.CPA, second.CPA, false, false);
            } else {
                // 데이터가 부족할 때 모든 trend 요소 초기화
                const resetTrend = (id) => {
                    const el = document.getElementById(id);
                    const ppEl = document.getElementById(id + 'PP');
                    const detailEl = document.getElementById(id + 'Detail');

                    if (el) {
                        el.className = 'kpi-trend neutral';
                        const trendValueEl = el.querySelector('.trend-value');
                        if (trendValueEl) {
                            trendValueEl.textContent = '-';
                        }
                    }
                    if (ppEl) {
                        ppEl.textContent = '';
                        ppEl.className = 'trend-pp';
                    }
                    if (detailEl) {
                        detailEl.innerHTML = '';
                    }
                };

                // 모든 KPI trend 요소 초기화
                resetTrend('trendCost');
                resetTrend('trendImpressions');
                resetTrend('trendClicks');
                resetTrend('trendConversions');
                resetTrend('trendConversionValue');
                resetTrend('trendROAS');
                resetTrend('trendCPM');
                resetTrend('trendCPC');
                resetTrend('trendCPA');
            }
        }

        // 테이블 업데이트
        const TABLE_ROW_LIMIT = 10;
        let isTableExpanded = false;

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            const showMoreContainer = document.getElementById('showMoreContainer');
            const hiddenCountSpan = document.getElementById('hiddenCount');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="loading">데이터가 없습니다.</td></tr>';
                showMoreContainer.style.display = 'none';
                return;
            }

            // 합계 계산
            const totals = data.reduce((acc, row) => {
                acc.비용 += row.비용;
                acc.노출 += row.노출;
                acc.클릭 += row.클릭;
                acc.전환수 += row.전환수;
                acc.전환값 += row.전환값;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            const hiddenCount = Math.max(0, data.length - TABLE_ROW_LIMIT);

            let html = data.map((row, index) => `
                <tr class="${!isTableExpanded && index >= TABLE_ROW_LIMIT ? 'hidden-row' : ''}">
                    <td>${row.period}</td>
                    <td>${formatNumber(row.비용)}</td>
                    <td>${formatNumber(row.노출)}</td>
                    <td>${formatNumber(row.CPM)}</td>
                    <td>${formatNumber(row.클릭)}</td>
                    <td>${formatNumber(row.CPC)}</td>
                    <td>${formatNumber(row.전환수)}</td>
                    <td>${formatNumber(row.CPA)}</td>
                    <td>${formatNumber(row.전환값)}</td>
                    <td class="${row.ROAS >= 100 ? 'positive' : 'negative'}">${formatROAS(row.ROAS)}</td>
                </tr>
            `).join('');

            // 합계 행 추가
            const totalCPM = totals.노출 > 0 ? (totals.비용 / totals.노출 * 1000) : 0;
            const totalCPC = totals.클릭 > 0 ? (totals.비용 / totals.클릭) : 0;
            const totalCPA = totals.전환수 > 0 ? (totals.비용 / totals.전환수) : 0;
            const totalROAS = totals.비용 > 0 ? (totals.전환값 / totals.비용 * 100) : 0;

            html += `
                <tr class="total-row">
                    <td>합계</td>
                    <td>${formatNumber(totals.비용)}</td>
                    <td>${formatNumber(totals.노출)}</td>
                    <td>${formatNumber(totalCPM)}</td>
                    <td>${formatNumber(totals.클릭)}</td>
                    <td>${formatNumber(totalCPC)}</td>
                    <td>${formatNumber(totals.전환수)}</td>
                    <td>${formatNumber(totalCPA)}</td>
                    <td>${formatNumber(totals.전환값)}</td>
                    <td class="${totalROAS >= 100 ? 'positive' : 'negative'}">${formatROAS(totalROAS)}</td>
                </tr>
            `;

            tbody.innerHTML = html;

            // 더 보기 버튼 표시/숨김
            if (hiddenCount > 0 && !isTableExpanded) {
                showMoreContainer.style.display = 'block';
                hiddenCountSpan.textContent = hiddenCount;
            } else {
                showMoreContainer.style.display = 'none';
            }
        }

        // 더 보기 버튼 클릭 핸들러
        function expandTableRows() {
            isTableExpanded = true;
            const hiddenRows = document.querySelectorAll('#tableBody .hidden-row');
            const showMoreContainer = document.getElementById('showMoreContainer');
            const collapseContainer = document.getElementById('collapseContainer');

            hiddenRows.forEach(row => {
                row.classList.remove('hidden-row');
            });

            showMoreContainer.style.display = 'none';
            collapseContainer.style.display = 'block';
        }

        // 접기 버튼 클릭 핸들러
        function collapseTableRows() {
            isTableExpanded = false;
            const tbody = document.getElementById('tableBody');
            const rows = tbody.querySelectorAll('tr:not(.total-row)');
            const showMoreContainer = document.getElementById('showMoreContainer');
            const collapseContainer = document.getElementById('collapseContainer');
            const hiddenCountSpan = document.getElementById('hiddenCount');

            rows.forEach((row, index) => {
                if (index >= TABLE_ROW_LIMIT) {
                    row.classList.add('hidden-row');
                }
            });

            const hiddenCount = Math.max(0, rows.length - TABLE_ROW_LIMIT);
            if (hiddenCount > 0) {
                showMoreContainer.style.display = 'block';
                hiddenCountSpan.textContent = hiddenCount;
            }
            collapseContainer.style.display = 'none';
        }

        // 숫자 포맷 - #,###;;-;@ 형식 (0은 '-'로 표시)
        function formatNumber(num) {
            if (num === 0 || num === null || num === undefined) return '-';
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // ROAS 포맷 - 0%;;-;@ 형식 (0은 '-'로 표시, %는 정수)
        function formatROAS(num) {
            if (num === 0 || num === null || num === undefined) return '-';
            return Math.round(num) + '%';
        }

        // 이벤트 리스너
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            // 필터 섹션 접기/펼치기
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', function() {
                    const section = this.parentElement;
                    const content = section.querySelector('.collapsible-content');
                    const toggleBtn = section.querySelector('.collapsible-toggle');
                    const toggleIcon = section.querySelector('.collapsible-toggle-icon');
                    const toggleText = toggleBtn.querySelector('span:first-child');

                    if (content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        toggleIcon.classList.add('collapsed');
                        toggleText.textContent = '펼치기';
                    } else {
                        content.classList.add('expanded');
                        toggleIcon.classList.remove('collapsed');
                        toggleText.textContent = '접기';
                    }
                });
            });

            // 기본 필터 변경 이벤트 (계층 구조: 유형구분 → 브랜드명 → 상품명 → 프로모션)
            document.getElementById('filterType').addEventListener('change', e => {
                filters.type = e.target.value;
                // 유형구분 변경 시 하위 필터 모두 업데이트
                updateBrandFilter();
                updateDetailFilters();
                updateDashboard();
            });

            document.getElementById('filterBrand').addEventListener('change', e => {
                filters.brand = e.target.value;
                // 브랜드명 변경 시 하위 필터 업데이트
                updateProductFilter();
                updateDetailFilters();
                updateDashboard();
            });

            document.getElementById('filterProduct').addEventListener('change', e => {
                filters.product = e.target.value;
                // 상품명 변경 시 하위 필터 업데이트
                updatePromotionFilter();
                updateDetailFilters();
                updateDashboard();
            });

            document.getElementById('filterPromotion').addEventListener('change', e => {
                filters.promotion = e.target.value;
                updateDetailFilters();
                updateDashboard();
            });

            document.getElementById('startDate').addEventListener('change', e => {
                filters.startDate = e.target.value;
                updateDetailFilters();
                updateDashboard();
            });

            document.getElementById('endDate').addEventListener('change', e => {
                filters.endDate = e.target.value;
                updateDetailFilters();
                updateDashboard();
            });

            // 세부 필터 변경 이벤트
            document.getElementById('filterCampaign').addEventListener('change', e => {
                filters.campaign = e.target.value;
                // 캠페인 변경 시 세트이름 필터 업데이트 (하위 속성)
                updateSetNameFilter();
                updateDashboard();
            });

            document.getElementById('filterSetName').addEventListener('change', e => {
                filters.setName = e.target.value;
                updateDashboard();
            });

            // KPI 탭 버튼 (전체/일별/주별/월별)
            document.querySelectorAll('.kpi-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    // 탭 버튼 활성화 토글
                    document.querySelectorAll('.kpi-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const tabType = btn.dataset.kpiTab;
                    const totalContent = document.getElementById('kpiTabTotal');
                    const periodContent = document.getElementById('kpiTabPeriod');

                    if (tabType === 'total') {
                        // 전체 탭: 요약 데이터 표시
                        totalContent.classList.add('active');
                        periodContent.classList.remove('active');
                    } else {
                        // 일별/주별/월별 탭: 기간별 데이터 표시
                        totalContent.classList.remove('active');
                        periodContent.classList.add('active');

                        // currentView 업데이트 및 대시보드 갱신
                        currentView = tabType;
                        updateDashboard();
                    }
                });
            });

            // KPI 주요/세부 성과 토글 버튼
            document.querySelectorAll('.kpi-unified-section .kpi-view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // 버튼 활성화 토글
                    document.querySelectorAll('.kpi-unified-section .kpi-view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // 모든 kpi-section에 show-all 토글 (전체 탭 + 기간별 탭)
                    document.querySelectorAll('.kpi-unified-section .kpi-section').forEach(section => {
                        if (btn.dataset.kpiView === 'all') {
                            section.classList.add('show-all');
                        } else {
                            section.classList.remove('show-all');
                        }
                    });
                });
            });

            // 차트 토글 버튼 이벤트 (data-label-toggle 스타일)
            document.querySelectorAll('.chart-toggle-group .data-label-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const checkboxId = this.dataset.chartToggle;
                    const checkbox = document.getElementById(checkboxId);
                    const toggleCheckbox = this.querySelector('.toggle-checkbox');

                    // 토글 상태 전환
                    checkbox.checked = !checkbox.checked;

                    if (checkbox.checked) {
                        this.classList.add('active');
                        toggleCheckbox.textContent = '✓';
                    } else {
                        this.classList.remove('active');
                        toggleCheckbox.textContent = '☐';
                    }

                    renderChart();
                });
            });

            // 데이터 라벨 토글 버튼 이벤트
            document.getElementById('dataLabelToggle').addEventListener('click', function() {
                showDataLabels = !showDataLabels;
                const toggleCheckbox = this.querySelector('.toggle-checkbox');

                if (showDataLabels) {
                    this.classList.add('active');
                    toggleCheckbox.textContent = '☑';
                } else {
                    this.classList.remove('active');
                    toggleCheckbox.textContent = '☐';
                }

                renderChart();
            });

            // 더 보기 버튼 이벤트
            document.getElementById('showMoreBtn').addEventListener('click', expandTableRows);

            // 접기 버튼 이벤트
            document.getElementById('collapseBtn').addEventListener('click', collapseTableRows);
        });
    
    })();
    </script>

    <!-- ========== 소재별 대시보드 스크립트 (creative_analysis.html) ========== -->
    <script>
    (function() {
        // creative 페이지 스크립트
        


        // Chart.js Datalabels 플러그인 등록
        Chart.register(ChartDataLabels);
        // 전역 변수
        let allData = [];
        let imageUrlMap = {}; // 소재이름 -> 이미지 URL 매핑 (1순위)
        let fallbackUrlMap = {}; // 소재이름 -> 대체 이미지 URL 매핑 (2순위)
        let originalUrlMap = {}; // 소재이름 -> 원본 URL 매핑
        let filters = {
            type: '',
            brand: '',
            product: '',
            promotion: '',
            campaign: '',
            adSet: '',
            startDate: '',
            endDate: '',
            searchText: ''
        };

        // KPI 기준 필터
        let kpiFilter = {
            metric: '비용',
            operator: '>',
            value: '',
            enabled: false,
            compoundLogic: 'none',
            secondaryMetric: '비용',
            secondaryOperator: '>',
            secondaryValue: '',
            secondaryCompoundLogic: 'none',
            tertiaryMetric: '비용',
            tertiaryOperator: '>',
            tertiaryValue: '',
            advancedFilterFunction: null  // 고급 필터 함수 (기하평균 기반 등)
        };

        // KPI 필터 프리셋
        const KPI_PRESETS = {
            'high_roas': {
                name: '📊 고ROAS 소재',
                description: 'ROAS > 500%',
                conditions: [
                    { metric: 'ROAS', operator: '>', value: 500 }
                ]
            },
            'high_revenue': {
                name: '💰 고매출 소재',
                description: '전환값 > 100만원',
                conditions: [
                    { metric: '전환값', operator: '>', value: 1000000 }
                ]
            },
            'low_cpa': {
                name: '🎯 저CPA 소재',
                description: 'CPA < 1만원',
                conditions: [
                    { metric: 'CPA', operator: '<', value: 10000 }
                ]
            },
            'high_conversion': {
                name: '📈 고전환 소재',
                description: '전환수 > 10건',
                conditions: [
                    { metric: '전환수', operator: '>', value: 10 }
                ]
            },
            'high_spend': {
                name: '🔥 고지출 소재',
                description: '비용 > 50만원',
                conditions: [
                    { metric: '비용', operator: '>', value: 500000 }
                ]
            },
            'low_efficiency': {
                name: '⚠️ 저효율 소재',
                description: 'ROAS < 100%',
                conditions: [
                    { metric: 'ROAS', operator: '<', value: 100 }
                ]
            },
            'hidden_gem': {
                name: '💎 숨은 보석',
                description: 'ROAS > 300% AND 비용 < 10만원',
                conditions: [
                    { metric: 'ROAS', operator: '>', value: 300 },
                    { compoundLogic: 'and' },
                    { metric: '비용', operator: '<', value: 100000 }
                ]
            },
            'scale_up': {
                name: '🚀 스케일업 후보',
                description: 'ROAS > 200% AND 전환수 > 5건',
                conditions: [
                    { metric: 'ROAS', operator: '>', value: 200 },
                    { compoundLogic: 'and' },
                    { metric: '전환수', operator: '>', value: 5 }
                ]
            },
            // ===== 4분류 효율 필터 (기하평균 기반) =====
            'high_efficiency': {
                name: '🏆 고효율 소재',
                description: '효율 점수 상위 20% - 검증된 고성과',
                isAdvancedFilter: true,
                filterFunction: 'filterHighEfficiency'
            },
            'potential': {
                name: '💎 가능성 있는 소재',
                description: '테스트 확대 추천 - 신뢰도↓ 성과↑',
                isAdvancedFilter: true,
                filterFunction: 'filterPotential'
            },
            'needs_attention': {
                name: '🔍 주의 필요 소재',
                description: '추가 관찰 필요 - 판단 유보',
                isAdvancedFilter: true,
                filterFunction: 'filterNeedsAttention'
            },
            'low_efficiency': {
                name: '⚠️ 저효율 소재',
                description: '효율 점수 하위 20% - 예산 축소 검토',
                isAdvancedFilter: true,
                filterFunction: 'filterLowEfficiency'
            }
        };

        // ========================================
        // 고효율 소재 필터 시스템 (데이터 기반 상대평가)
        // ========================================

        const EFFICIENCY_CONFIG = {
            MIN_SPEND: 50000,              // 최소 비용 기준 (5만원)
            FULL_CONFIDENCE_SPEND: 3000000, // 완전 신뢰 비용 (300만원)
            TOP_PERCENT: 0.20,             // 상위 20% (고효율)
            BOTTOM_PERCENT: 0.20,          // 하위 20% (저효율)
            CONFIDENCE_THRESHOLD: 0.5,     // 신뢰도 기준 (약 39만원)
            RELATIVE_PERF_THRESHOLD: 1.0   // 상대적 성과 기준 (기대 ROAS 대비)
        };

        // 비용 구간 정의 (로그 스케일)
        const SPEND_BUCKETS = [
            { min: 0, max: 100000, label: '~10만' },
            { min: 100000, max: 300000, label: '10~30만' },
            { min: 300000, max: 500000, label: '30~50만' },
            { min: 500000, max: 1000000, label: '50~100만' },
            { min: 1000000, max: 3000000, label: '100~300만' },
            { min: 3000000, max: Infinity, label: '300만+' }
        ];

        /**
         * 기하평균 계산
         */
        function calcGeometricMean(values) {
            const validValues = values.filter(v => v > 0);
            if (validValues.length === 0) return 0;

            const logSum = validValues.reduce((sum, v) => sum + Math.log(v), 0);
            return Math.exp(logSum / validValues.length);
        }

        /**
         * 중앙값 계산
         */
        function calcMedian(values) {
            if (values.length === 0) return 0;
            const sorted = [...values].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        /**
         * 비용 구간별 ROAS 기하평균 계산 (데이터 기반 기준선)
         */
        function calculateDataDrivenBaseline(data) {
            const validData = data.filter(d => d['비용'] > 0 && d['ROAS'] > 0);

            if (validData.length < 3) {
                return { method: 'insufficient_data', totalGeoMean: 200 };
            }

            // 구간별 통계 계산
            const bucketStats = SPEND_BUCKETS.map(bucket => {
                const bucketData = validData.filter(d =>
                    d['비용'] >= bucket.min && d['비용'] < bucket.max
                );

                if (bucketData.length === 0) {
                    return { ...bucket, geoMeanROAS: null, median: null, count: 0 };
                }

                const roasValues = bucketData.map(d => d['ROAS']);

                return {
                    ...bucket,
                    geoMeanROAS: calcGeometricMean(roasValues),
                    median: calcMedian(roasValues),
                    count: bucketData.length
                };
            });

            // 전체 기하평균
            const allROAS = validData.map(d => d['ROAS']);
            const totalGeoMean = calcGeometricMean(allROAS);

            return {
                method: 'data_driven',
                totalGeoMean: totalGeoMean,
                bucketStats: bucketStats,
                dataCount: validData.length
            };
        }

        /**
         * 비용 수준에 맞는 기대 ROAS 반환
         */
        function getExpectedROAS(spend, baseline) {
            if (baseline.method === 'insufficient_data') {
                return baseline.totalGeoMean;
            }

            // 해당 구간의 기하평균 찾기
            const bucket = baseline.bucketStats.find(b =>
                spend >= b.min && spend < b.max
            );

            if (bucket && bucket.geoMeanROAS) {
                return bucket.geoMeanROAS;
            }

            // 구간 데이터 없으면 인접 구간 또는 전체 평균
            return baseline.totalGeoMean;
        }

        /**
         * 신뢰도 가중치 계산 (로그 스케일)
         * 5만원: 0.0 → 300만원: 1.0
         */
        function calcConfidenceWeight(spend) {
            if (spend < EFFICIENCY_CONFIG.MIN_SPEND) return 0;
            if (spend >= EFFICIENCY_CONFIG.FULL_CONFIDENCE_SPEND) return 1;

            const logMin = Math.log(EFFICIENCY_CONFIG.MIN_SPEND);
            const logMax = Math.log(EFFICIENCY_CONFIG.FULL_CONFIDENCE_SPEND);
            const logSpend = Math.log(spend);

            return (logSpend - logMin) / (logMax - logMin);
        }

        /**
         * 상대 성과 점수 계산 (기대 ROAS 대비)
         */
        function calcRelativePerformance(actualROAS, spend, baseline) {
            const expectedROAS = getExpectedROAS(spend, baseline);
            if (expectedROAS <= 0) return 0;
            return actualROAS / expectedROAS;
        }

        /**
         * 백분위 순위 계산 (0~1, 높을수록 좋음)
         * lowerIsBetter=true: 낮은 값일수록 높은 순위 (CPA, CPC, CPM)
         * lowerIsBetter=false: 높은 값일수록 높은 순위 (ROAS)
         */
        function calcPercentileRanks(data, metric, lowerIsBetter = false) {
            const validData = data.filter(d => d[metric] != null && d[metric] > 0);
            if (validData.length === 0) return new Map();

            // lowerIsBetter면 내림차순 정렬 (낮은 값이 뒤로 → 높은 순위)
            const sorted = [...validData].sort((a, b) =>
                lowerIsBetter ? b[metric] - a[metric] : a[metric] - b[metric]
            );
            const ranks = new Map();

            sorted.forEach((item, idx) => {
                const pctRank = (idx + 1) / sorted.length;
                ranks.set(item.name, pctRank);
            });

            return ranks;
        }

        /**
         * 고효율 소재 복합 점수 계산 (메인 함수)
         */
        function calculateEfficiencyScores(data) {
            // 최소 비용 필터링
            const qualified = data.filter(d => (d['비용'] || 0) >= EFFICIENCY_CONFIG.MIN_SPEND);

            if (qualified.length < 3) {
                console.log('⚠️ 고효율 필터: 데이터 부족 (최소 3개 필요)');
                return { scored: [], baseline: null };
            }

            // 데이터 기반 기준선 계산
            const baseline = calculateDataDrivenBaseline(qualified);

            console.log('📊 데이터 기반 효율 기준:');
            console.log(`   전체 ROAS 기하평균: ${baseline.totalGeoMean?.toFixed(0)}%`);
            baseline.bucketStats?.forEach(b => {
                if (b.geoMeanROAS) {
                    console.log(`   ${b.label}: ${b.geoMeanROAS.toFixed(0)}% (n=${b.count})`);
                }
            });

            // 백분위 순위 계산 (CPA, CPC, CPM은 낮을수록 좋음)
            const roasRanks = calcPercentileRanks(qualified, 'ROAS', false);
            const cpaRanks = calcPercentileRanks(qualified, 'CPA', true);
            const cpcRanks = calcPercentileRanks(qualified, 'CPC', true);
            const cpmRanks = calcPercentileRanks(qualified, 'CPM', true);

            // 기본 가중치 (ROAS 중심)
            const defaultWeights = { ROAS: 0.40, CPA: 0.30, CPC: 0.20, CPM: 0.10 };
            // 전환값 없는 전환 목표용 가중치 (CPA 중심)
            const cpaFocusWeights = { ROAS: 0.00, CPA: 0.50, CPC: 0.30, CPM: 0.20 };

            const scored = qualified.map(item => {
                const spend = item['비용'] || 0;
                const actualROAS = item['ROAS'] || 0;
                const conversions = item['전환수'] || 0;
                const conversionValue = item['전환값'] || 0;

                // 전환값=0 & 전환수>0인 경우 CPA 중심 가중치 사용
                const isNonValueConversion = conversions > 0 && conversionValue === 0;
                const weights = isNonValueConversion ? cpaFocusWeights : defaultWeights;

                // 백분위 점수
                const roasScore = roasRanks.get(item.name) || 0;
                const cpaScore = cpaRanks.get(item.name) || 0;
                const cpcScore = cpcRanks.get(item.name) || 0;
                const cpmScore = cpmRanks.get(item.name) || 0;

                // 기하평균 (균형 잡힌 성과)
                // 전환값 없는 전환 목표의 경우 ROAS 제외
                const scores = isNonValueConversion
                    ? [
                        Math.max(cpaScore, 0.01),
                        Math.max(cpcScore, 0.01),
                        Math.max(cpmScore, 0.01)
                    ]
                    : [
                        Math.max(roasScore, 0.01),
                        Math.max(cpaScore, 0.01),
                        Math.max(cpcScore, 0.01),
                        Math.max(cpmScore, 0.01)
                    ];
                const weightArr = isNonValueConversion
                    ? [weights.CPA, weights.CPC, weights.CPM]
                    : [weights.ROAS, weights.CPA, weights.CPC, weights.CPM];

                let logSum = 0;
                let weightSum = 0;
                for (let i = 0; i < scores.length; i++) {
                    logSum += weightArr[i] * Math.log(scores[i]);
                    weightSum += weightArr[i];
                }
                const geoMean = Math.exp(logSum / weightSum);

                // 신뢰도 가중치
                const confidence = calcConfidenceWeight(spend);

                // 상대 성과 계산
                let relativePerf;
                if (isNonValueConversion) {
                    // 전환값 없는 전환: CPA 백분위 점수를 상대 성과로 사용
                    // CPA 점수가 높을수록(=CPA가 낮을수록) 좋은 성과
                    relativePerf = cpaScore > 0 ? 1 + cpaScore : 0.5;
                } else {
                    // 일반 소재: 기대 ROAS 대비 상대 성과
                    const expectedROAS = getExpectedROAS(spend, baseline);
                    relativePerf = expectedROAS > 0 ? actualROAS / expectedROAS : 0;
                }

                // 최종 점수 = 기하평균 × 신뢰도보정 × 상대성과보정
                const finalScore = geoMean
                    * (0.5 + 0.5 * confidence)           // 0.5~1.0
                    * Math.pow(Math.min(relativePerf, 3), 0.3);  // 상대성과 완만 반영

                return {
                    ...item,
                    efficiencyScore: finalScore,
                    confidenceWeight: confidence,
                    expectedROAS: isNonValueConversion ? null : getExpectedROAS(spend, baseline),
                    relativePerformance: relativePerf,
                    isNonValueConversion: isNonValueConversion,
                    rankScores: { roasScore, cpaScore, cpcScore, cpmScore, geoMean }
                };
            });

            return { scored, baseline };
        }

        /**
         * 소재 4분류 시스템
         * - 🏆 고효율: 상위 20%
         * - 💎 가능성: 중간 60% 중 신뢰도↓ + 상대적 성과↑
         * - 🔍 주의 필요: 중간 60% 중 그 외
         * - ⚠️ 저효율: 하위 20%
         */
        function classifyCreatives(scoredData) {
            if (scoredData.length === 0) return [];

            // 효율 점수 기준 정렬 (내림차순)
            const sorted = [...scoredData].sort((a, b) => b.efficiencyScore - a.efficiencyScore);
            const total = sorted.length;

            // 컷오프 인덱스 계산
            const topCutoffIdx = Math.ceil(total * EFFICIENCY_CONFIG.TOP_PERCENT);
            const bottomCutoffIdx = Math.floor(total * (1 - EFFICIENCY_CONFIG.BOTTOM_PERCENT));

            return sorted.map((item, index) => {
                let classification;

                if (index < topCutoffIdx) {
                    // 상위 20%
                    classification = 'high_efficiency';
                } else if (index >= bottomCutoffIdx) {
                    // 하위 20%
                    classification = 'low_efficiency';
                } else {
                    // 중간 60%: 신뢰도와 상대적 성과로 세분화
                    if (item.confidenceWeight < EFFICIENCY_CONFIG.CONFIDENCE_THRESHOLD &&
                        item.relativePerformance >= EFFICIENCY_CONFIG.RELATIVE_PERF_THRESHOLD) {
                        classification = 'potential';
                    } else {
                        classification = 'needs_attention';
                    }
                }

                return { ...item, classification };
            });
        }

        /**
         * 🏆 고효율 소재 필터 (상위 20%)
         */
        function _filterHighEfficiency(data) {
            const { scored, baseline } = calculateEfficiencyScores(data);
            if (scored.length === 0) return { filtered: [], baseline: null, stats: null };

            const classified = classifyCreatives(scored);
            const filtered = classified.filter(d => d.classification === 'high_efficiency');

            console.log(`🏆 고효율 소재: ${filtered.length}/${classified.length}개 (상위 ${(EFFICIENCY_CONFIG.TOP_PERCENT * 100).toFixed(0)}%)`);

            return { filtered, baseline, stats: { totalCount: classified.length, filteredCount: filtered.length } };
        }

        /**
         * 💎 가능성 있는 소재 필터 (중간 60% 중 신뢰도↓ + 성과↑)
         */
        function _filterPotential(data) {
            const { scored, baseline } = calculateEfficiencyScores(data);
            if (scored.length === 0) return { filtered: [], baseline: null, stats: null };

            const classified = classifyCreatives(scored);
            const filtered = classified.filter(d => d.classification === 'potential');

            console.log(`💎 가능성 있는 소재: ${filtered.length}/${classified.length}개`);

            return { filtered, baseline, stats: { totalCount: classified.length, filteredCount: filtered.length } };
        }

        /**
         * 🔍 주의 필요 소재 필터 (중간 60% 중 그 외)
         */
        function _filterNeedsAttention(data) {
            const { scored, baseline } = calculateEfficiencyScores(data);
            if (scored.length === 0) return { filtered: [], baseline: null, stats: null };

            const classified = classifyCreatives(scored);
            const filtered = classified.filter(d => d.classification === 'needs_attention');

            console.log(`🔍 주의 필요 소재: ${filtered.length}/${classified.length}개`);

            return { filtered, baseline, stats: { totalCount: classified.length, filteredCount: filtered.length } };
        }

        /**
         * ⚠️ 저효율 소재 필터 (하위 20%)
         */
        function _filterLowEfficiency(data) {
            const { scored, baseline } = calculateEfficiencyScores(data);
            if (scored.length === 0) return { filtered: [], baseline: null, stats: null };

            const classified = classifyCreatives(scored);
            const filtered = classified.filter(d => d.classification === 'low_efficiency');

            console.log(`⚠️ 저효율 소재: ${filtered.length}/${classified.length}개 (하위 ${(EFFICIENCY_CONFIG.BOTTOM_PERCENT * 100).toFixed(0)}%)`);

            return { filtered, baseline, stats: { totalCount: classified.length, filteredCount: filtered.length } };
        }

        // 고급 필터 함수를 window 객체에 등록 (updateDashboard에서 동적 호출용)
        window.filterHighEfficiency = function(data) {
            console.log('🔍 filterHighEfficiency 호출됨, 입력 데이터:', data.length, '개');
            const result = _filterHighEfficiency(data);
            console.log('🔍 filterHighEfficiency 결과:', result.filtered?.length || 0, '개');
            lastEfficiencyBaseline = result.baseline;
            return result.filtered;
        };

        window.filterPotential = function(data) {
            const result = _filterPotential(data);
            lastEfficiencyBaseline = result.baseline;
            return result.filtered;
        };

        window.filterNeedsAttention = function(data) {
            const result = _filterNeedsAttention(data);
            lastEfficiencyBaseline = result.baseline;
            return result.filtered;
        };

        window.filterLowEfficiency = function(data) {
            const result = _filterLowEfficiency(data);
            lastEfficiencyBaseline = result.baseline;
            return result.filtered;
        };

        // 현재 적용된 고급 필터 상태
        let activeAdvancedFilter = null;
        let lastEfficiencyBaseline = null;

        // 정렬 설정
        let sortConfig = {
            metric: '비용',
            order: 'desc'
        };

        // 칩 활성화 전 정렬 설정 저장 (복원용)
        let savedSortConfig = null;

        // 칩 활성화 상태에서 효율 점수 정렬 사용 여부
        let useEfficiencyScoreSort = false;

        // 숫자 포맷팅 함수 (#,###)
        function formatNumberInput(value) {
            // 숫자와 소수점만 남기기
            const num = value.replace(/[^\d.]/g, '');
            if (num === '') return '';

            // 소수점 처리
            const parts = num.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        // 포맷된 숫자에서 실제 값 추출
        function parseFormattedNumber(value) {
            return value.replace(/,/g, '');
        }

        // KPI 필터 초기화
        function resetKpiFilter() {
            kpiFilter.metric = '비용';
            kpiFilter.operator = '>';
            kpiFilter.value = '';
            kpiFilter.compoundLogic = 'none';
            kpiFilter.secondaryMetric = '비용';
            kpiFilter.secondaryOperator = '>';
            kpiFilter.secondaryValue = '';
            kpiFilter.secondaryCompoundLogic = 'none';
            kpiFilter.tertiaryMetric = '비용';
            kpiFilter.tertiaryOperator = '>';
            kpiFilter.tertiaryValue = '';
            kpiFilter.advancedFilterFunction = null;  // 고급 필터 함수 초기화

            // UI 초기화
            document.getElementById('kpiFilterMetric').value = '비용';
            document.getElementById('kpiFilterOperator').value = '>';
            document.getElementById('kpiFilterValue').value = '';
            document.getElementById('kpiFilterMetricSecondary').value = '비용';
            document.getElementById('kpiFilterOperatorSecondary').value = '>';
            document.getElementById('kpiFilterValueSecondary').value = '';
            document.getElementById('kpiFilterMetricTertiary').value = '비용';
            document.getElementById('kpiFilterOperatorTertiary').value = '>';
            document.getElementById('kpiFilterValueTertiary').value = '';

            // 라디오 버튼 초기화
            document.querySelector('input[name="compoundLogic"][value="none"]').checked = true;
            document.querySelector('input[name="compoundLogicSecondary"][value="none"]').checked = true;

            // 보조 필터 행 숨기기
            document.getElementById('secondaryFilterRow').style.display = 'none';
            document.getElementById('tertiaryFilterRow').style.display = 'none';
        }

        // KPI 프리셋 적용
        function applyKpiPreset(presetKey) {
            const preset = KPI_PRESETS[presetKey];
            const descriptionEl = document.getElementById('kpiPresetDescription');
            const manualInputSection = document.getElementById('kpiManualInputSection');

            if (!preset) {
                // 직접 입력 모드
                descriptionEl.style.display = 'none';
                manualInputSection.style.display = 'flex';
                resetKpiFilter();
                kpiFilter.enabled = false;
                updateKpiToggleUI(false);
                updateDashboard();
                return;
            }

            // 프리셋 적용
            resetKpiFilter();

            // 고급 필터 (기하평균 기반 등) 처리
            if (preset.isAdvancedFilter && preset.filterFunction) {
                // 고급 필터 함수 설정
                kpiFilter.advancedFilterFunction = preset.filterFunction;
                console.log('✅ 고급 필터 설정됨:', preset.filterFunction);

                // 프리셋 설명 표시
                descriptionEl.textContent = preset.description;
                descriptionEl.style.display = 'flex';

                // 직접 입력 영역 숨기기
                manualInputSection.style.display = 'none';

                // 필터 자동 활성화
                kpiFilter.enabled = true;
                updateKpiToggleUI(true);

                // 정렬 설정 저장 및 효율 점수 정렬 활성화
                if (!savedSortConfig) {
                    savedSortConfig = { ...sortConfig };
                }
                useEfficiencyScoreSort = true;

                // 정렬 기준 UI를 '-'로 변경
                const sortMetricEl = document.getElementById('sortMetric');
                sortMetricEl.value = '-';

                updateDashboard();
                return;
            }

            const conditions = preset.conditions;
            let conditionIndex = 0;

            for (let i = 0; i < conditions.length; i++) {
                const cond = conditions[i];

                if (cond.compoundLogic) {
                    // 조합 조건 설정
                    if (conditionIndex === 0) {
                        kpiFilter.compoundLogic = cond.compoundLogic;
                        document.querySelector(`input[name="compoundLogic"][value="${cond.compoundLogic}"]`).checked = true;
                        document.getElementById('secondaryFilterRow').style.display = 'flex';
                    } else if (conditionIndex === 1) {
                        kpiFilter.secondaryCompoundLogic = cond.compoundLogic;
                        document.querySelector(`input[name="compoundLogicSecondary"][value="${cond.compoundLogic}"]`).checked = true;
                        document.getElementById('tertiaryFilterRow').style.display = 'flex';
                    }
                } else {
                    // 조건 설정
                    if (conditionIndex === 0) {
                        kpiFilter.metric = cond.metric;
                        kpiFilter.operator = cond.operator;
                        kpiFilter.value = String(cond.value);
                        document.getElementById('kpiFilterMetric').value = cond.metric;
                        document.getElementById('kpiFilterOperator').value = cond.operator;
                        document.getElementById('kpiFilterValue').value = formatNumberInput(String(cond.value));
                    } else if (conditionIndex === 1) {
                        kpiFilter.secondaryMetric = cond.metric;
                        kpiFilter.secondaryOperator = cond.operator;
                        kpiFilter.secondaryValue = String(cond.value);
                        document.getElementById('kpiFilterMetricSecondary').value = cond.metric;
                        document.getElementById('kpiFilterOperatorSecondary').value = cond.operator;
                        document.getElementById('kpiFilterValueSecondary').value = formatNumberInput(String(cond.value));
                    } else if (conditionIndex === 2) {
                        kpiFilter.tertiaryMetric = cond.metric;
                        kpiFilter.tertiaryOperator = cond.operator;
                        kpiFilter.tertiaryValue = String(cond.value);
                        document.getElementById('kpiFilterMetricTertiary').value = cond.metric;
                        document.getElementById('kpiFilterOperatorTertiary').value = cond.operator;
                        document.getElementById('kpiFilterValueTertiary').value = formatNumberInput(String(cond.value));
                    }
                    conditionIndex++;
                }
            }

            // 프리셋 설명 표시
            descriptionEl.textContent = preset.description;
            descriptionEl.style.display = 'flex';

            // 직접 입력 영역 숨기기 (프리셋 사용 시)
            manualInputSection.style.display = 'none';

            // 필터 자동 활성화
            kpiFilter.enabled = true;
            updateKpiToggleUI(true);

            updateDashboard();
        }

        // KPI 토글 UI 업데이트 헬퍼
        function updateKpiToggleUI(enabled) {
            const toggle = document.getElementById('kpiFilterToggle');
            const status = toggle.querySelector('.toggle-status');
            if (enabled) {
                toggle.classList.add('active');
                status.textContent = 'ON';
            } else {
                toggle.classList.remove('active');
                status.textContent = 'OFF';
            }
        }

        // 소재 데이터 파일 (data/creative 폴더)
        const creativeDataFile = './creative/Creative_data.csv';
        // 이미지 URL 매핑 파일
        const imageUrlFile = './creative/Creative_url.csv';

        // CSV 한 줄 파싱 (RFC 4180 호환)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // 연속된 따옴표는 이스케이프된 따옴표
                        current += '"';
                        i++; // 다음 따옴표 건너뛰기
                    } else {
                        // 따옴표 시작/종료
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // 따옴표 밖의 쉼표는 구분자
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            // 마지막 필드 추가
            result.push(current);
            return result;
        }

        // CSV 파싱 함수 (RFC 4180 호환)
        function parseCSV(text) {
            const lines = text.trim().split('\n');

            const headers = parseCSVLine(lines[0]).map(h => h.trim());

            return lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
        }

        // CSV 파싱 함수 (따옴표 처리) - parseCSV와 동일하게 RFC 4180 호환
        function parseCSVWithQuotes(text) {
            const lines = text.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= 2) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim().replace(/^"|"$/g, '')] = (values[index] || '').trim().replace(/^"|"$/g, '');
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // 데이터 로드
        async function loadData() {
            try {
                // 1. 이미지 URL 매핑 데이터 로드
                const urlResponse = await fetch(imageUrlFile);
                if (urlResponse.ok) {
                    const urlText = await urlResponse.text();
                    const urlData = parseCSVWithQuotes(urlText);
                    // Google Drive URL을 thumbnail 형식으로 변환
                    function convertGoogleDriveUrl(url) {
                        const driveMatch = url.match(/drive\.google\.com\/file\/d\/([^\/]+)\/view/);
                        if (driveMatch) {
                            return `https://drive.google.com/thumbnail?id=${driveMatch[1]}&sz=w1000`;
                        }
                        return url;
                    }

                    // 소재이름 -> URL 매핑 생성
                    // 우선순위: 1.drive.google.com > 2.facebook.com/ads/image,youtube > 3.scontent > 4.기타
                    urlData.forEach(row => {
                        const creativeName = row['광고,에셋이름'] || row['광고'];
                        const url = row['url'];
                        const originalUrl = row['원본 url / ID'] || row['원본url/ID'] || '';

                        if (creativeName && url) {
                            // originalUrlMap은 imageUrlMap 우선순위와 독립적으로 저장
                            // 유효한 원본 URL이 있고, 기존에 저장된 값이 없으면 저장
                            if (originalUrl && originalUrl !== '-' && !originalUrlMap[creativeName]) {
                                originalUrlMap[creativeName] = originalUrl;
                            }

                            // URL 유형 판별
                            const isGoogleDrive = url.includes('drive.google.com');
                            const isFacebookAdsImage = url.includes('facebook.com/ads/image');
                            const isYoutubeThumbnail = url.includes('img.youtube.com/vi/');
                            const isScontent = url.includes('scontent') || url.includes('googlesyndication');

                            // 1순위: Google Drive URL (최우선, thumbnail 형식으로 변환)
                            if (isGoogleDrive) {
                                const existingUrl = imageUrlMap[creativeName];
                                // 기존에 Google Drive URL이 아니면 덮어쓰기
                                if (!existingUrl || !existingUrl.includes('drive.google.com/thumbnail')) {
                                    // 기존 URL이 있으면 fallback으로 이동
                                    if (existingUrl && !fallbackUrlMap[creativeName]) {
                                        fallbackUrlMap[creativeName] = existingUrl;
                                    }
                                    imageUrlMap[creativeName] = convertGoogleDriveUrl(url);
                                }
                            }
                            // 2순위: facebook.com/ads/image 또는 img.youtube.com
                            else if (isFacebookAdsImage || isYoutubeThumbnail) {
                                const existingUrl = imageUrlMap[creativeName];
                                // Google Drive URL이 이미 있으면 건너뛰기
                                const existingIsGoogleDrive = existingUrl && existingUrl.includes('drive.google.com/thumbnail');
                                if (!existingIsGoogleDrive) {
                                    const existingIsPrimary = existingUrl &&
                                        (existingUrl.includes('facebook.com/ads/image') || existingUrl.includes('img.youtube.com/vi/'));
                                    if (!existingIsPrimary) {
                                        // 기존 URL이 scontent면 fallback으로 이동
                                        if (existingUrl && (existingUrl.includes('scontent') || existingUrl.includes('googlesyndication'))) {
                                            fallbackUrlMap[creativeName] = existingUrl;
                                        }
                                        imageUrlMap[creativeName] = url;
                                    }
                                }
                            }
                            // 3순위: scontent 등 URL
                            else if (isScontent) {
                                const existingUrl = imageUrlMap[creativeName];
                                const existingIsGoogleDrive = existingUrl && existingUrl.includes('drive.google.com/thumbnail');
                                const existingIsPrimary = existingUrl &&
                                    (existingUrl.includes('facebook.com/ads/image') || existingUrl.includes('img.youtube.com/vi/'));

                                // 1,2순위 URL이 있으면 fallback으로 저장
                                if (existingIsGoogleDrive || existingIsPrimary) {
                                    if (!fallbackUrlMap[creativeName]) {
                                        fallbackUrlMap[creativeName] = url;
                                    }
                                }
                                // 1,2순위 URL이 없으면 primary로 저장
                                else if (!existingUrl) {
                                    imageUrlMap[creativeName] = url;
                                }
                            }
                            // 4순위: 기타 URL은 아무것도 없을 때만
                            else if (!imageUrlMap[creativeName]) {
                                imageUrlMap[creativeName] = url;
                            }
                        }
                    });
                    console.log('이미지 URL 매핑 완료:', Object.keys(imageUrlMap).length, '개');
                    console.log('Fallback URL 매핑 완료:', Object.keys(fallbackUrlMap).length, '개');
                    console.log('원본 URL 매핑 완료:', Object.keys(originalUrlMap).length, '개');
                }

                // 2. 소재 성과 데이터 로드
                const dataResponse = await fetch(creativeDataFile);
                if (!dataResponse.ok) throw new Error('Failed to load creative data');
                const dataText = await dataResponse.text();
                allData = parseCSV(dataText);

                // 필터 옵션 설정
                populateFilters();

                // 날짜 범위 설정
                setDateRange();

                // 대시보드 업데이트
                updateDashboard();
            } catch (err) {
                console.error('Error loading data:', err);
                document.getElementById('creativeGrid').innerHTML =
                    '<div class="empty-state" style="grid-column: 1 / -1;"><h3>데이터 로드 실패</h3><p>데이터를 불러올 수 없습니다</p></div>';
            }
        }

        // 필터 옵션 설정 (유형구분만 초기화, 나머지는 계층 구조)
        function populateFilters() {
            const types = [...new Set(allData.map(d => d['유형구분']))].filter(Boolean).sort();
            populateSelect('filterType', types);
            updateBrandFilter();
        }

        // 브랜드명 필터 (유형구분의 하위)
        function updateBrandFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                return true;
            });
            const brands = [...new Set(filteredData.map(d => d['브랜드명']))].filter(Boolean).sort();
            const brandSelect = document.getElementById('filterBrand');
            brandSelect.innerHTML = '<option value="">전체</option>';
            brands.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                brandSelect.appendChild(option);
            });
            if (!brands.includes(filters.brand)) {
                filters.brand = '';
                brandSelect.value = '';
            }
            updateProductFilter();
        }

        // 상품명 필터 (브랜드명의 하위)
        function updateProductFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                return true;
            });
            const products = [...new Set(filteredData.map(d => d['상품명']))].filter(Boolean).sort();
            const productSelect = document.getElementById('filterProduct');
            productSelect.innerHTML = '<option value="">전체</option>';
            products.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                productSelect.appendChild(option);
            });
            if (!products.includes(filters.product)) {
                filters.product = '';
                productSelect.value = '';
            }
            updatePromotionFilter();
        }

        // 프로모션 필터 (상품명의 하위)
        function updatePromotionFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                return true;
            });
            const promotions = [...new Set(filteredData.map(d => d['프로모션']))].filter(Boolean).sort();
            const promotionSelect = document.getElementById('filterPromotion');
            promotionSelect.innerHTML = '<option value="">전체</option>';
            promotions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                promotionSelect.appendChild(option);
            });
            if (!promotions.includes(filters.promotion)) {
                filters.promotion = '';
                promotionSelect.value = '';
            }
            updateCampaignFilter();
        }

        // 캠페인 필터 (프로모션의 하위)
        function updateCampaignFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                if (filters.promotion && row['프로모션'] !== filters.promotion) return false;
                return true;
            });
            const campaigns = [...new Set(filteredData.map(d => d['캠페인']))].filter(Boolean).sort();
            const campaignSelect = document.getElementById('filterCampaign');
            campaignSelect.innerHTML = '<option value="">전체</option>';
            campaigns.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                campaignSelect.appendChild(option);
            });
            if (!campaigns.includes(filters.campaign)) {
                filters.campaign = '';
                campaignSelect.value = '';
            }
            updateAdSetFilter();
        }

        // 광고세트 필터 (캠페인의 하위)
        function updateAdSetFilter() {
            const filteredData = allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                if (filters.promotion && row['프로모션'] !== filters.promotion) return false;
                if (filters.campaign && row['캠페인'] !== filters.campaign) return false;
                return true;
            });
            const adSets = [...new Set(filteredData.map(d => d['광고세트']))].filter(Boolean).sort();
            const adSetSelect = document.getElementById('filterAdSet');
            adSetSelect.innerHTML = '<option value="">전체</option>';
            adSets.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                adSetSelect.appendChild(option);
            });
            if (!adSets.includes(filters.adSet)) {
                filters.adSet = '';
                adSetSelect.value = '';
            }
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        // 날짜 범위 설정
        function setDateRange() {
            const dates = allData
                .map(d => d['날짜'])
                .filter(Boolean)
                .map(d => new Date(d))
                .filter(d => !isNaN(d));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                document.getElementById('startDate').value = formatDateForInput(minDate);
                document.getElementById('endDate').value = formatDateForInput(maxDate);

                filters.startDate = formatDateForInput(minDate);
                filters.endDate = formatDateForInput(maxDate);
            }
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // 데이터 필터링
        function filterData() {
            return allData.filter(row => {
                if (filters.type && row['유형구분'] !== filters.type) return false;
                if (filters.brand && row['브랜드명'] !== filters.brand) return false;
                if (filters.product && row['상품명'] !== filters.product) return false;
                if (filters.promotion && row['프로모션'] !== filters.promotion) return false;
                if (filters.campaign && row['캠페인'] !== filters.campaign) return false;
                if (filters.adSet && row['광고세트'] !== filters.adSet) return false;

                if (filters.startDate || filters.endDate) {
                    const rowDate = new Date(row['날짜']);
                    if (isNaN(rowDate)) return false;
                    if (filters.startDate && rowDate < new Date(filters.startDate)) return false;
                    if (filters.endDate && rowDate > new Date(filters.endDate)) return false;
                }

                return true;
            });
        }

        // 소재별 데이터 집계 (소재이름 기준)
        function aggregateByCreative(data) {
            const groups = {};

            data.forEach(row => {
                const key = row['소재이름'] || '기타';

                if (!groups[key]) {
                    groups[key] = {
                        name: key,
                        비용: 0,
                        노출: 0,
                        클릭: 0,
                        전환수: 0,
                        전환값: 0
                    };
                }

                groups[key].비용 += parseFloat(row['비용']) || 0;
                groups[key].노출 += parseFloat(row['노출']) || 0;
                groups[key].클릭 += parseFloat(row['클릭']) || 0;
                groups[key].전환수 += parseFloat(row['전환수']) || 0;
                groups[key].전환값 += parseFloat(row['전환값']) || 0;
            });

            // KPI 계산
            return Object.values(groups).map(g => ({
                ...g,
                CPM: g.노출 > 0 ? (g.비용 / g.노출 * 1000) : 0,
                CPC: g.클릭 > 0 ? (g.비용 / g.클릭) : 0,
                CPA: g.전환수 > 0 ? (g.비용 / g.전환수) : 0,
                ROAS: g.비용 > 0 ? (g.전환값 / g.비용 * 100) : 0
            })).sort((a, b) => {
                const aVal = a[sortConfig.metric];
                const bVal = b[sortConfig.metric];
                return sortConfig.order === 'desc' ? bVal - aVal : aVal - bVal;
            });
        }

        // 기간 및 기본 필터 초기화
        function resetBasicFilters() {
            setDateRange();
            filters.type = '';
            filters.brand = '';
            filters.product = '';
            filters.promotion = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterBrand').value = '';
            document.getElementById('filterProduct').value = '';
            document.getElementById('filterPromotion').value = '';
            updateBrandFilter();
            updateDashboard();
        }

        // 세부 필터 초기화
        function resetDetailFilters() {
            filters.campaign = '';
            filters.adSet = '';
            filters.searchText = '';
            document.getElementById('filterCampaign').value = '';
            document.getElementById('filterAdSet').value = '';
            document.getElementById('searchText').value = '';
            updateDashboard();
        }

        // 대시보드 업데이트
        function updateDashboard() {
            const filteredData = filterData();
            let creativeData = aggregateByCreative(filteredData);

            // KPI 기준 필터 적용 (소재 검색보다 먼저 적용)
            // 고급 필터 함수 (기하평균 기반 고효율 소재 등) 처리
            if (kpiFilter.enabled && kpiFilter.advancedFilterFunction) {
                const filterFunctionName = kpiFilter.advancedFilterFunction;
                console.log('🎯 고급 필터 적용:', filterFunctionName, 'enabled:', kpiFilter.enabled);
                console.log('🎯 필터 전 데이터:', creativeData.length, '개');
                if (typeof window[filterFunctionName] === 'function') {
                    creativeData = window[filterFunctionName](creativeData);
                    console.log('🎯 필터 후 데이터:', creativeData.length, '개');
                } else {
                    console.error(`고급 필터 함수를 찾을 수 없습니다: ${filterFunctionName}`);
                }
            }
            // 일반 조건 기반 필터 처리
            else if (kpiFilter.enabled && kpiFilter.value !== '') {
                const targetValue = parseFloat(kpiFilter.value);
                if (!isNaN(targetValue)) {
                    // 메트릭 값 가져오기 헬퍼 함수
                    const getMetricValue = (creative, metric) => {
                        switch (metric) {
                            case '비용': return creative.비용;
                            case '노출': return creative.노출;
                            case '클릭': return creative.클릭;
                            case '전환수': return creative.전환수;
                            case '전환값': return creative.전환값;
                            case 'CPC': return creative.CPC;
                            case 'CPA': return creative.CPA;
                            case 'ROAS': return creative.ROAS;
                            default: return 0;
                        }
                    };

                    // 비교 연산 헬퍼 함수
                    const compareValues = (metricValue, operator, targetVal) => {
                        switch (operator) {
                            case '>': return metricValue > targetVal;
                            case '<': return metricValue < targetVal;
                            case '>=': return metricValue >= targetVal;
                            case '<=': return metricValue <= targetVal;
                            case '=': return metricValue === targetVal;
                            default: return true;
                        }
                    };

                    creativeData = creativeData.filter(creative => {
                        // 기본 조건 평가
                        const metricValue = getMetricValue(creative, kpiFilter.metric);
                        const primaryResult = compareValues(metricValue, kpiFilter.operator, targetValue);

                        // 복합 조건이 없으면 기본 조건만 반환
                        if (kpiFilter.compoundLogic === 'none') {
                            return primaryResult;
                        }

                        // 보조 조건 평가
                        const secondaryTargetValue = parseFloat(kpiFilter.secondaryValue);
                        let secondaryResult = true;
                        if (!isNaN(secondaryTargetValue) && kpiFilter.secondaryValue !== '') {
                            const secondaryMetricValue = getMetricValue(creative, kpiFilter.secondaryMetric);
                            secondaryResult = compareValues(secondaryMetricValue, kpiFilter.secondaryOperator, secondaryTargetValue);
                        }

                        // 3차 조건 평가 (secondaryCompoundLogic이 설정된 경우에만)
                        let tertiaryResult = true;
                        let hasTertiaryCondition = false;
                        if (kpiFilter.secondaryCompoundLogic !== 'none') {
                            const tertiaryTargetValue = parseFloat(kpiFilter.tertiaryValue);
                            if (!isNaN(tertiaryTargetValue) && kpiFilter.tertiaryValue !== '') {
                                hasTertiaryCondition = true;
                                const tertiaryMetricValue = getMetricValue(creative, kpiFilter.tertiaryMetric);
                                tertiaryResult = compareValues(tertiaryMetricValue, kpiFilter.tertiaryOperator, tertiaryTargetValue);
                            }
                        }

                        // OR 또는 AND 연산 (1차-2차 조건)
                        let result12;
                        if (kpiFilter.compoundLogic === 'or') {
                            result12 = primaryResult || (kpiFilter.secondaryValue !== '' ? secondaryResult : false);
                        } else if (kpiFilter.compoundLogic === 'and') {
                            result12 = primaryResult && (kpiFilter.secondaryValue !== '' ? secondaryResult : true);
                        } else {
                            return primaryResult;
                        }

                        // 3차 조건 적용 (secondaryCompoundLogic 기반)
                        if (hasTertiaryCondition) {
                            if (kpiFilter.secondaryCompoundLogic === 'or') {
                                return result12 || tertiaryResult;
                            } else if (kpiFilter.secondaryCompoundLogic === 'and') {
                                return result12 && tertiaryResult;
                            }
                        }

                        return result12;
                    });
                }
            }

            // 소재 검색 필터 적용 (LIKE '%검색어%') - KPI 필터 이후에 적용
            if (filters.searchText) {
                const searchLower = filters.searchText.toLowerCase();
                creativeData = creativeData.filter(creative =>
                    creative.name.toLowerCase().includes(searchLower)
                );
            }

            // 최종 정렬 적용
            if (useEfficiencyScoreSort) {
                // 칩 활성화 시: 효율 점수 순위로 정렬 (내림차순)
                creativeData = creativeData.sort((a, b) => {
                    const aScore = a.efficiencyScore || 0;
                    const bScore = b.efficiencyScore || 0;
                    return bScore - aScore;
                });
            } else {
                // 일반 정렬: 사용자 설정대로 재정렬
                creativeData = creativeData.sort((a, b) => {
                    const aVal = a[sortConfig.metric] || 0;
                    const bVal = b[sortConfig.metric] || 0;
                    return sortConfig.order === 'desc' ? bVal - aVal : aVal - bVal;
                });
            }

            // 요약 업데이트
            updateSummary(creativeData);

            // 소재 그리드 업데이트
            updateCreativeGrid(creativeData);
        }

        // 요약 업데이트
        function updateSummary(data) {
            const totals = data.reduce((acc, row) => {
                acc.비용 += row.비용;
                acc.노출 += row.노출;
                acc.클릭 += row.클릭;
                acc.전환수 += row.전환수;
                acc.전환값 += row.전환값;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            const avgCPM = totals.노출 > 0 ? (totals.비용 / totals.노출 * 1000) : 0;
            const avgCPC = totals.클릭 > 0 ? (totals.비용 / totals.클릭) : 0;
            const avgCPA = totals.전환수 > 0 ? (totals.비용 / totals.전환수) : 0;
            const avgROAS = totals.비용 > 0 ? (totals.전환값 / totals.비용 * 100) : 0;

            document.getElementById('totalCost').textContent = formatNumber(totals.비용);
            document.getElementById('avgCPM').textContent = formatNumber(avgCPM);
            document.getElementById('avgCPC').textContent = formatNumber(avgCPC);
            document.getElementById('avgCPA').textContent = formatNumber(avgCPA);
            document.getElementById('avgROAS').textContent = formatROAS(avgROAS);
        }

        // 소재 그리드 업데이트
        function updateCreativeGrid(data) {
            const grid = document.getElementById('creativeGrid');

            if (data.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <h3>소재 데이터가 없습니다</h3>
                        <p>필터 조건을 변경해 주세요</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = data.map(creative => {
                // 이미지 URL 매핑에서 소재이름으로 URL 찾기
                const imageUrl = imageUrlMap[creative.name];
                const fallbackUrl = fallbackUrlMap[creative.name];
                const originalUrl = originalUrlMap[creative.name];

                // 클릭 가능 여부 및 링크 URL 결정
                const hasLink = originalUrl || imageUrl;
                const linkUrl = originalUrl || imageUrl || '#';

                // onerror 핸들러: fallback URL이 있으면 시도, 없으면 placeholder 표시
                const errorHandler = fallbackUrl
                    ? `onerror="if(!this.dataset.tried){this.dataset.tried='1';this.src='${fallbackUrl}';}else{this.style.display='none';this.nextElementSibling.style.display='block';}"`
                    : `onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"`;

                const imageContent = imageUrl
                    ? `<img src="${imageUrl}" alt="${creative.name}" class="creative-image" ${errorHandler}>
                       <div class="creative-placeholder" style="display: none;">
                           <svg viewBox="0 0 24 24">
                               <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                           </svg>
                           <div>이미지 로드 실패</div>
                       </div>`
                    : `<div class="creative-placeholder">
                           <svg viewBox="0 0 24 24">
                               <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                           </svg>
                           <div>이미지 없음</div>
                       </div>`;

                // 이미지 영역을 링크로 감싸기
                const imageWrapper = hasLink
                    ? `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer" class="creative-image-link" title="원본 보기">
                           <div class="creative-image-wrapper">
                               ${imageContent}
                           </div>
                       </a>`
                    : `<div class="creative-image-wrapper">
                           ${imageContent}
                       </div>`;

                return `
                <div class="creative-card card">
                    ${imageWrapper}
                    <div class="creative-info">
                        <div class="creative-name clickable" title="${creative.name}" onclick="showCreativeDetail('${creative.name.replace(/'/g, "\\'")}')">${creative.name}</div>
                        <div class="creative-metrics">
                            <div class="creative-metric">
                                <span class="metric-label">비용</span>
                                <span class="metric-value">${formatNumber(creative.비용)}</span>
                            </div>
                            <div class="creative-metric">
                                <span class="metric-label">CPC</span>
                                <span class="metric-value">${formatNumber(creative.CPC)}</span>
                            </div>
                            <div class="creative-metric">
                                <span class="metric-label">CPA</span>
                                <span class="metric-value">${formatNumber(creative.CPA)}</span>
                            </div>
                            <div class="creative-metric">
                                <span class="metric-label">ROAS</span>
                                <span class="metric-value ${creative.ROAS >= 100 ? 'positive' : 'negative'}">${formatROAS(creative.ROAS)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // 숫자 포맷
        function formatNumber(num) {
            if (num === 0 || num === null || num === undefined) return '-';
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // ROAS 포맷
        function formatROAS(num) {
            if (num === 0 || num === null || num === undefined) return '-';
            return Math.round(num) + '%';
        }

        // CTR 포맷 (소수점 2자리)
        function formatCTR(num) {
            if (num === 0 || num === null || num === undefined) return '-';
            return num.toFixed(2) + '%';
        }

        // 모달 관련 전역 변수
        let modalChartInstance = null;
        let currentModalData = [];
        let currentModalViewType = 'daily';
        let isModalTableExpanded = false;
        let modalTableSortOrder = 'desc'; // 'desc': 내림차순(최신순), 'asc': 오름차순(과거순)
        let showModalDataLabels = false;

        // 소재 세부 성과 모달 표시
        function showCreativeDetail(creativeName) {
            // 해당 소재의 데이터 필터링
            const creativeData = filterData().filter(row => row['소재이름'] === creativeName);

            if (creativeData.length === 0) {
                alert('해당 소재의 데이터가 없습니다.');
                return;
            }

            // 모달 데이터 저장
            currentModalData = creativeData;
            currentModalViewType = 'daily';
            isModalTableExpanded = false;
            modalTableSortOrder = 'desc'; // 정렬 순서 초기화 (내림차순)

            // 뷰 타입 버튼 초기화
            document.querySelectorAll('.modal-view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === 'daily') btn.classList.add('active');
            });

            // 모달 제목 업데이트
            document.getElementById('modalTitle').textContent = creativeName;

            // 모달 내용 업데이트
            updateModalContent();

            // 모달 표시
            document.getElementById('creativeModal').classList.add('active');
        }

        // 뷰 타입 변경
        function changeModalViewType(viewType) {
            currentModalViewType = viewType;
            isModalTableExpanded = false;
            modalTableSortOrder = 'desc'; // 정렬 순서 초기화

            // 버튼 활성화 상태 변경
            document.querySelectorAll('.modal-view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === viewType) btn.classList.add('active');
            });

            // 모달 내용 업데이트
            updateModalContent();
        }

        // 모달 내용 업데이트
        function updateModalContent() {
            // 데이터 집계
            const aggregatedData = aggregateModalData(currentModalData, currentModalViewType);

            // KPI 집계
            const totals = currentModalData.reduce((acc, row) => {
                acc.비용 += parseFloat(row['비용']) || 0;
                acc.노출 += parseFloat(row['노출']) || 0;
                acc.클릭 += parseFloat(row['클릭']) || 0;
                acc.전환수 += parseFloat(row['전환수']) || 0;
                acc.전환값 += parseFloat(row['전환값']) || 0;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            // 파생 지표 계산
            const kpis = {
                비용: totals.비용,
                노출: totals.노출,
                클릭: totals.클릭,
                전환수: totals.전환수,
                전환값: totals.전환값,
                CPC: totals.클릭 > 0 ? (totals.비용 / totals.클릭) : 0,
                CPA: totals.전환수 > 0 ? (totals.비용 / totals.전환수) : 0,
                ROAS: totals.비용 > 0 ? (totals.전환값 / totals.비용 * 100) : 0
            };

            // KPI 카드 렌더링 (상단: 비용, CPC, CPA, ROAS / 하단: 노출, 클릭, 전환수, 전환값)
            document.getElementById('modalKpiRowTop').innerHTML = `
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">비용</div>
                    <div class="modal-kpi-value">${formatNumber(kpis.비용)}원</div>
                </div>
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">CPC</div>
                    <div class="modal-kpi-value">${formatNumber(kpis.CPC)}원</div>
                </div>
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">CPA</div>
                    <div class="modal-kpi-value">${formatNumber(kpis.CPA)}원</div>
                </div>
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">ROAS</div>
                    <div class="modal-kpi-value">${formatROAS(kpis.ROAS)}</div>
                </div>
            `;

            document.getElementById('modalKpiRowBottom').innerHTML = `
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">노출</div>
                    <div class="modal-kpi-value">${formatNumber(kpis.노출)}</div>
                </div>
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">클릭</div>
                    <div class="modal-kpi-value">${formatNumber(kpis.클릭)}</div>
                </div>
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">전환수</div>
                    <div class="modal-kpi-value">${formatNumber(kpis.전환수)}</div>
                </div>
                <div class="modal-kpi-card">
                    <div class="modal-kpi-label">전환값</div>
                    <div class="modal-kpi-value">${formatNumber(kpis.전환값)}원</div>
                </div>
            `;

            // 테이블 업데이트
            updateModalTable(aggregatedData);

            // 정렬 아이콘 업데이트
            updateModalSortIcon();

            // 차트 업데이트
            updateModalChart();
        }

        // 모달 데이터 집계 (일별/주별/월별)
        function aggregateModalData(data, viewType) {
            const groups = {};

            data.forEach(row => {
                let key;
                const date = new Date(row['날짜']);

                if (viewType === 'daily') {
                    key = row['날짜'];
                } else if (viewType === 'weekly') {
                    // 주 시작일 (월요일) 계산
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(date.setDate(diff));
                    key = formatDateForInput(monday);
                } else if (viewType === 'monthly') {
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }

                if (!groups[key]) {
                    groups[key] = { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 };
                }

                groups[key].비용 += parseFloat(row['비용']) || 0;
                groups[key].노출 += parseFloat(row['노출']) || 0;
                groups[key].클릭 += parseFloat(row['클릭']) || 0;
                groups[key].전환수 += parseFloat(row['전환수']) || 0;
                groups[key].전환값 += parseFloat(row['전환값']) || 0;
            });

            // 파생 지표 계산 및 정렬 (modalTableSortOrder에 따라)
            return Object.entries(groups)
                .map(([period, values]) => ({
                    period,
                    ...values,
                    CPM: values.노출 > 0 ? (values.비용 / values.노출 * 1000) : 0,
                    CTR: values.노출 > 0 ? (values.클릭 / values.노출 * 100) : 0,
                    CPC: values.클릭 > 0 ? (values.비용 / values.클릭) : 0,
                    CPA: values.전환수 > 0 ? (values.비용 / values.전환수) : 0,
                    ROAS: values.비용 > 0 ? (values.전환값 / values.비용 * 100) : 0
                }))
                .sort((a, b) => modalTableSortOrder === 'desc'
                    ? b.period.localeCompare(a.period)
                    : a.period.localeCompare(b.period));
        }

        // 모달 테이블 업데이트
        function updateModalTable(data) {
            const tbody = document.getElementById('modalTableBody');
            const showMoreContainer = document.getElementById('modalShowMoreContainer');
            const collapseContainer = document.getElementById('modalCollapseContainer');
            const hiddenCount = document.getElementById('modalHiddenCount');

            // 테이블 행 생성
            tbody.innerHTML = data.map((row, index) => {
                const displayStyle = (!isModalTableExpanded && index >= 5) ? 'display: none;' : '';
                return `
                    <tr style="${displayStyle}">
                        <td>${formatPeriodLabel(row.period, currentModalViewType)}</td>
                        <td>${formatNumber(row.비용)}</td>
                        <td>${formatNumber(row.노출)}</td>
                        <td>${formatNumber(row.CPM)}</td>
                        <td>${formatNumber(row.클릭)}</td>
                        <td>${formatCTR(row.CTR)}</td>
                        <td>${formatNumber(row.CPC)}</td>
                        <td>${formatNumber(row.전환수)}</td>
                        <td>${formatNumber(row.CPA)}</td>
                        <td>${formatNumber(row.전환값)}</td>
                        <td>${formatROAS(row.ROAS)}</td>
                    </tr>
                `;
            }).join('');

            // 더보기/접기 버튼 표시
            if (data.length > 5) {
                if (isModalTableExpanded) {
                    showMoreContainer.style.display = 'none';
                    collapseContainer.style.display = 'block';
                } else {
                    hiddenCount.textContent = data.length - 5;
                    showMoreContainer.style.display = 'block';
                    collapseContainer.style.display = 'none';
                }
            } else {
                showMoreContainer.style.display = 'none';
                collapseContainer.style.display = 'none';
            }
        }

        // 기간 레이블 포맷
        function formatPeriodLabel(period, viewType) {
            if (viewType === 'monthly') {
                const [year, month] = period.split('-');
                return `${year}년 ${parseInt(month)}월`;
            } else if (viewType === 'weekly') {
                const date = new Date(period);
                const endDate = new Date(date);
                endDate.setDate(endDate.getDate() + 6);
                return `${date.getMonth() + 1}/${date.getDate()} ~ ${endDate.getMonth() + 1}/${endDate.getDate()}`;
            } else {
                const date = new Date(period);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }
        }

        // 모달 테이블 펼치기
        function expandModalTable() {
            isModalTableExpanded = true;
            const aggregatedData = aggregateModalData(currentModalData, currentModalViewType);
            updateModalTable(aggregatedData);
        }

        // 모달 테이블 접기
        function collapseModalTable() {
            isModalTableExpanded = false;
            const aggregatedData = aggregateModalData(currentModalData, currentModalViewType);
            updateModalTable(aggregatedData);
        }

        // 모달 테이블 정렬 토글
        function toggleModalTableSort() {
            // 정렬 순서 토글
            modalTableSortOrder = modalTableSortOrder === 'desc' ? 'asc' : 'desc';

            // 데이터 재집계 및 테이블 업데이트
            const aggregatedData = aggregateModalData(currentModalData, currentModalViewType);
            updateModalTable(aggregatedData);

            // 정렬 아이콘 업데이트
            updateModalSortIcon();
        }

        // 정렬 아이콘 업데이트
        function updateModalSortIcon() {
            const sortIcon = document.getElementById('modalSortIcon');
            if (sortIcon) {
                sortIcon.textContent = modalTableSortOrder === 'desc' ? '▼' : '▲';
            }
        }

        // 모달 차트 업데이트
        function updateModalChart() {
            const aggregatedData = aggregateModalData(currentModalData, currentModalViewType);

            // 오름차순으로 정렬 (차트용)
            const sortedData = [...aggregatedData].sort((a, b) => a.period.localeCompare(b.period));

            const chartLabels = sortedData.map(d => formatPeriodLabel(d.period, currentModalViewType));

            // 체크박스 상태 확인
            const showCost = document.getElementById('modalChartCost').checked;
            const showCPM = document.getElementById('modalChartCPM').checked;
            const showCPC = document.getElementById('modalChartCPC').checked;
            const showCPA = document.getElementById('modalChartCPA').checked;
            const showROAS = document.getElementById('modalChartROAS').checked;

            // Y축 결정 로직 (모든 조합 고려)
            // 우선순위: 비용 > CPM > CPC > CPA > ROAS
            // 첫 번째 지표는 왼쪽, 나머지는 오른쪽
            const hasCostMetric = showCost;
            const hasCpmMetric = showCPM;
            const hasCpcMetric = showCPC;
            const hasCpaMetric = showCPA;

            // 오른쪽 축 사용 여부 결정 (2개 이상 지표 선택 시)
            const selectedCount = (showCost ? 1 : 0) + (showCPM ? 1 : 0) + (showCPC ? 1 : 0) + (showCPA ? 1 : 0) + (showROAS ? 1 : 0);
            const useRightAxis = selectedCount >= 2;

            // 데이터셋 생성
            const datasets = [];

            if (showCost) {
                datasets.push({
                    label: '비용',
                    data: sortedData.map(d => d.비용),
                    borderColor: '#673ab7',
                    backgroundColor: 'rgba(103, 58, 183, 0.1)',
                    yAxisID: 'y',
                    tension: 0.3,
                    fill: true
                });
            }

            if (showCPM) {
                // CPM: 비용이 있으면 오른쪽, 없으면 왼쪽
                datasets.push({
                    label: 'CPM',
                    data: sortedData.map(d => d.CPM),
                    borderColor: '#9c27b0',
                    backgroundColor: 'rgba(156, 39, 176, 0.1)',
                    yAxisID: hasCostMetric ? 'y1' : 'y',
                    tension: 0.3,
                    fill: false
                });
            }

            if (showCPC) {
                // CPC: 비용 또는 CPM이 있으면 오른쪽, 없으면 왼쪽
                datasets.push({
                    label: 'CPC',
                    data: sortedData.map(d => d.CPC),
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    yAxisID: (hasCostMetric || hasCpmMetric) ? 'y1' : 'y',
                    tension: 0.3,
                    fill: false
                });
            }

            if (showCPA) {
                // CPA: 비용/CPM/CPC 중 하나라도 있으면 오른쪽, 없으면 왼쪽
                datasets.push({
                    label: 'CPA',
                    data: sortedData.map(d => d.CPA),
                    borderColor: '#ff9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    yAxisID: (hasCostMetric || hasCpmMetric || hasCpcMetric) ? 'y1' : 'y',
                    tension: 0.3,
                    fill: false
                });
            }

            if (showROAS) {
                // ROAS: 비용/CPM/CPC/CPA 중 하나라도 있으면 오른쪽, ROAS만 있으면 왼쪽
                datasets.push({
                    label: 'ROAS',
                    data: sortedData.map(d => d.ROAS),
                    borderColor: '#00c853',
                    backgroundColor: 'rgba(0, 200, 83, 0.1)',
                    yAxisID: (hasCostMetric || hasCpmMetric || hasCpcMetric || hasCpaMetric) ? 'y1' : 'y',
                    tension: 0.3,
                    fill: false
                });
            }

            // 차트 생성/업데이트
            const ctx = document.getElementById('modalChart').getContext('2d');

            if (modalChartInstance) {
                modalChartInstance.destroy();
            }

            modalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'ROAS') {
                                        label += Math.round(context.parsed.y) + '%';
                                    } else {
                                        label += formatNumber(context.parsed.y) + '원';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: showModalDataLabels,
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            font: {
                                family: "'Inter', sans-serif",
                                size: 11,
                                weight: '600'
                            },
                            color: function(context) {
                                return context.dataset.borderColor || context.dataset.backgroundColor;
                            },
                            formatter: function(value, context) {
                                if (context.dataset.label === 'ROAS') {
                                    return Math.round(value) + '%';
                                } else {
                                    return formatNumber(Math.round(value));
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: (function() {
                                    if (showCost) return '비용 (원)';
                                    if (showCPM) return 'CPM (원)';
                                    if (showCPC) return 'CPC (원)';
                                    if (showCPA) return 'CPA (원)';
                                    if (showROAS) return 'ROAS (%)';
                                    return '금액 (원)';
                                })()
                            },
                            ticks: {
                                callback: function(value) {
                                    if (!showCost && !showCPM && !showCPC && !showCPA && showROAS) {
                                        return value + '%';
                                    }
                                    return formatNumber(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: useRightAxis,
                            position: 'right',
                            title: {
                                display: true,
                                text: (function() {
                                    // 오른쪽 축에 있는 지표들 확인
                                    const rightMetrics = [];
                                    if (hasCostMetric && showCPM) rightMetrics.push('CPM');
                                    if ((hasCostMetric || hasCpmMetric) && showCPC) rightMetrics.push('CPC');
                                    if ((hasCostMetric || hasCpmMetric || hasCpcMetric) && showCPA) rightMetrics.push('CPA');
                                    if ((hasCostMetric || hasCpmMetric || hasCpcMetric || hasCpaMetric) && showROAS) rightMetrics.push('ROAS');

                                    if (rightMetrics.length === 0) return '';
                                    if (rightMetrics.includes('ROAS') && rightMetrics.length === 1) return 'ROAS (%)';
                                    if (rightMetrics.includes('ROAS')) return rightMetrics.join('/');
                                    return rightMetrics.join('/') + ' (원)';
                                })()
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    // 오른쪽 축에 ROAS만 있을 때는 % 표시
                                    const hasRightCPM = hasCostMetric && showCPM;
                                    const hasRightCPC = (hasCostMetric || hasCpmMetric) && showCPC;
                                    const hasRightCPA = (hasCostMetric || hasCpmMetric || hasCpcMetric) && showCPA;
                                    const hasRightROAS = (hasCostMetric || hasCpmMetric || hasCpcMetric || hasCpaMetric) && showROAS;

                                    if (hasRightROAS && !hasRightCPM && !hasRightCPC && !hasRightCPA) {
                                        return value + '%';
                                    }
                                    return formatNumber(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // 모달 닫기
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('creativeModal').classList.remove('active');
        }

        // 이벤트 리스너
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            // 접기/펼치기 토글 기능
            const filterCollapsibleHeader = document.getElementById('filterCollapsibleHeader');
            const filterCollapsibleContent = document.getElementById('filterCollapsibleContent');

            filterCollapsibleHeader.addEventListener('click', () => {
                const toggle = filterCollapsibleHeader.querySelector('.collapsible-toggle');
                const toggleText = toggle.querySelector('span:first-child');
                const toggleIcon = toggle.querySelector('.collapsible-toggle-icon');

                if (filterCollapsibleContent.classList.contains('expanded')) {
                    filterCollapsibleContent.classList.remove('expanded');
                    toggleText.textContent = '펼치기';
                    toggleIcon.classList.add('collapsed');
                } else {
                    filterCollapsibleContent.classList.add('expanded');
                    toggleText.textContent = '접기';
                    toggleIcon.classList.remove('collapsed');
                }
            });

            // 필터 변경 이벤트 (계층 구조)
            document.getElementById('filterType').addEventListener('change', e => {
                filters.type = e.target.value;
                updateBrandFilter();
                updateDashboard();
            });

            document.getElementById('filterBrand').addEventListener('change', e => {
                filters.brand = e.target.value;
                updateProductFilter();
                updateDashboard();
            });

            document.getElementById('filterProduct').addEventListener('change', e => {
                filters.product = e.target.value;
                updatePromotionFilter();
                updateDashboard();
            });

            document.getElementById('filterPromotion').addEventListener('change', e => {
                filters.promotion = e.target.value;
                updateCampaignFilter();
                updateDashboard();
            });

            document.getElementById('filterCampaign').addEventListener('change', e => {
                filters.campaign = e.target.value;
                updateAdSetFilter();
                updateDashboard();
            });

            document.getElementById('filterAdSet').addEventListener('change', e => {
                filters.adSet = e.target.value;
                updateDashboard();
            });

            document.getElementById('startDate').addEventListener('change', e => {
                filters.startDate = e.target.value;
                updateDashboard();
            });

            document.getElementById('endDate').addEventListener('change', e => {
                filters.endDate = e.target.value;
                updateDashboard();
            });

            // 소재 검색 이벤트 (입력 시 실시간 검색)
            document.getElementById('searchText').addEventListener('input', e => {
                filters.searchText = e.target.value;
                updateDashboard();
            });

            // 4분류 효율 필터 칩 이벤트
            document.querySelectorAll('.efficiency-chip-section .preset-chip').forEach(chip => {
                chip.addEventListener('click', e => {
                    const filterKey = chip.dataset.filter;
                    const isActive = chip.classList.contains('active');
                    console.log('🔘 칩 클릭:', filterKey, 'isActive:', isActive);

                    // 모든 칩 비활성화
                    document.querySelectorAll('.efficiency-chip-section .preset-chip').forEach(c => {
                        c.classList.remove('active');
                    });

                    if (isActive) {
                        // 이미 활성화된 칩 클릭 시 필터 해제
                        resetKpiFilter();
                        kpiFilter.enabled = false;
                        updateKpiToggleUI(false);
                        document.getElementById('kpiPresetDescription').style.display = 'none';
                        // KPI 필터 수동 입력 영역 다시 표시
                        document.getElementById('kpiManualInputSection').style.display = 'flex';
                        updateDashboard();
                    } else {
                        // 새 칩 활성화
                        chip.classList.add('active');
                        // applyKpiPreset 내부에서 updateDashboard 호출됨
                        applyKpiPreset(filterKey);
                    }
                });
            });

            // 칩 비활성화 헬퍼 함수
            function clearEfficiencyChips() {
                document.querySelectorAll('.efficiency-chip-section .preset-chip').forEach(c => {
                    c.classList.remove('active');
                });
                document.getElementById('kpiPresetDescription').style.display = 'none';

                // 효율 점수 정렬 비활성화 및 이전 정렬 설정 복원
                useEfficiencyScoreSort = false;
                if (savedSortConfig) {
                    sortConfig = { ...savedSortConfig };
                    savedSortConfig = null;

                    // 정렬 UI 복원
                    document.getElementById('sortMetric').value = sortConfig.metric;
                    document.querySelector(`input[name="sortOrder"][value="${sortConfig.order}"]`).checked = true;
                }
            }

            // KPI 필터 이벤트 (수동 변경 시 칩 초기화)
            document.getElementById('kpiFilterMetric').addEventListener('change', e => {
                kpiFilter.metric = e.target.value;
                clearEfficiencyChips();
                if (kpiFilter.enabled) {
                    updateDashboard();
                }
            });

            document.getElementById('kpiFilterOperator').addEventListener('change', e => {
                kpiFilter.operator = e.target.value;
                clearEfficiencyChips();
                if (kpiFilter.enabled) {
                    updateDashboard();
                }
            });

            document.getElementById('kpiFilterValue').addEventListener('input', e => {
                const formatted = formatNumberInput(e.target.value);
                e.target.value = formatted;
                kpiFilter.value = parseFormattedNumber(formatted);
                clearEfficiencyChips();

                // 기준값 입력에 따른 토글 자동 활성화/비활성화
                const toggle = document.getElementById('kpiFilterToggle');
                const status = toggle.querySelector('.toggle-status');
                const hasValue = formatted.trim() !== '';

                if (hasValue && !kpiFilter.enabled) {
                    // 값이 있고 비활성화 상태면 → 자동 활성화
                    kpiFilter.enabled = true;
                    toggle.classList.add('active');
                    status.textContent = 'ON';
                } else if (!hasValue && kpiFilter.enabled) {
                    // 값이 없고 활성화 상태면 → 자동 비활성화
                    kpiFilter.enabled = false;
                    toggle.classList.remove('active');
                    status.textContent = 'OFF';
                }

                if (kpiFilter.enabled) {
                    updateDashboard();
                }
            });

            document.getElementById('kpiFilterToggle').addEventListener('click', e => {
                kpiFilter.enabled = !kpiFilter.enabled;
                const toggle = e.target.closest('.kpi-filter-toggle');
                const status = toggle.querySelector('.toggle-status');

                if (kpiFilter.enabled) {
                    toggle.classList.add('active');
                    status.textContent = 'ON';
                } else {
                    toggle.classList.remove('active');
                    status.textContent = 'OFF';
                    // 필터 OFF 시 칩 초기화 및 인터페이스 복원
                    clearEfficiencyChips();
                    resetKpiFilter();
                    document.getElementById('kpiManualInputSection').style.display = 'flex';
                }
                updateDashboard();
            });

            // 조합 조건 라디오 버튼 이벤트 (조건1 -> 조건2)
            document.querySelectorAll('input[name="compoundLogic"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    kpiFilter.compoundLogic = e.target.value;
                    clearEfficiencyChips();
                    const secondaryFilterRow = document.getElementById('secondaryFilterRow');
                    const tertiaryFilterRow = document.getElementById('tertiaryFilterRow');

                    if (e.target.value === 'none') {
                        secondaryFilterRow.style.display = 'none';
                        tertiaryFilterRow.style.display = 'none';
                        // 조건2의 조합조건도 초기화
                        kpiFilter.secondaryCompoundLogic = 'none';
                        document.querySelector('input[name="compoundLogicSecondary"][value="none"]').checked = true;
                    } else {
                        secondaryFilterRow.style.display = 'flex';
                        // tertiaryFilterRow는 secondaryCompoundLogic에 의해 제어됨
                    }

                    if (kpiFilter.enabled) {
                        updateDashboard();
                    }
                });
            });

            // 조합 조건 라디오 버튼 이벤트 (조건2 -> 조건3)
            document.querySelectorAll('input[name="compoundLogicSecondary"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    kpiFilter.secondaryCompoundLogic = e.target.value;
                    clearEfficiencyChips();
                    const tertiaryFilterRow = document.getElementById('tertiaryFilterRow');

                    if (e.target.value === 'none') {
                        tertiaryFilterRow.style.display = 'none';
                    } else {
                        tertiaryFilterRow.style.display = 'flex';
                    }

                    if (kpiFilter.enabled && kpiFilter.compoundLogic !== 'none') {
                        updateDashboard();
                    }
                });
            });

            // 보조 필터 이벤트 (수동 변경 시 프리셋 초기화)
            document.getElementById('kpiFilterMetricSecondary').addEventListener('change', e => {
                kpiFilter.secondaryMetric = e.target.value;
                clearEfficiencyChips();
                if (kpiFilter.enabled && kpiFilter.compoundLogic !== 'none') {
                    updateDashboard();
                }
            });

            document.getElementById('kpiFilterOperatorSecondary').addEventListener('change', e => {
                kpiFilter.secondaryOperator = e.target.value;
                clearEfficiencyChips();
                if (kpiFilter.enabled && kpiFilter.compoundLogic !== 'none') {
                    updateDashboard();
                }
            });

            document.getElementById('kpiFilterValueSecondary').addEventListener('input', e => {
                const formatted = formatNumberInput(e.target.value);
                e.target.value = formatted;
                kpiFilter.secondaryValue = parseFormattedNumber(formatted);
                clearEfficiencyChips();
                if (kpiFilter.enabled && kpiFilter.compoundLogic !== 'none') {
                    updateDashboard();
                }
            });

            // 3차 필터 이벤트 (수동 변경 시 프리셋 초기화)
            document.getElementById('kpiFilterMetricTertiary').addEventListener('change', e => {
                kpiFilter.tertiaryMetric = e.target.value;
                clearEfficiencyChips();
                if (kpiFilter.enabled && kpiFilter.compoundLogic !== 'none') {
                    updateDashboard();
                }
            });

            document.getElementById('kpiFilterOperatorTertiary').addEventListener('change', e => {
                kpiFilter.tertiaryOperator = e.target.value;
                clearEfficiencyChips();
                if (kpiFilter.enabled && kpiFilter.compoundLogic !== 'none') {
                    updateDashboard();
                }
            });

            document.getElementById('kpiFilterValueTertiary').addEventListener('input', e => {
                const formatted = formatNumberInput(e.target.value);
                e.target.value = formatted;
                kpiFilter.tertiaryValue = parseFormattedNumber(formatted);
                clearEfficiencyChips();
                if (kpiFilter.enabled && kpiFilter.compoundLogic !== 'none' && kpiFilter.secondaryCompoundLogic !== 'none') {
                    updateDashboard();
                }
            });

            // 정렬 설정 이벤트
            document.getElementById('sortMetric').addEventListener('change', e => {
                sortConfig.metric = e.target.value;

                // 유저가 정렬 기준을 변경하면 효율 점수 정렬 비활성화
                if (useEfficiencyScoreSort && e.target.value !== '-') {
                    useEfficiencyScoreSort = false;
                    // savedSortConfig 업데이트 (새 설정으로)
                    if (savedSortConfig) {
                        savedSortConfig.metric = e.target.value;
                    }
                }

                updateDashboard();
            });

            document.querySelectorAll('input[name="sortOrder"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    sortConfig.order = e.target.value;
                    updateDashboard();
                });
            });

            // 모달 차트 토글 버튼 이벤트 (data-label-toggle 스타일)
            document.querySelectorAll('.modal-chart-toggle-group .data-label-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const checkboxId = this.dataset.chartToggle;
                    const checkbox = document.getElementById(checkboxId);
                    const toggleCheckbox = this.querySelector('.toggle-checkbox');

                    // 토글 상태 전환
                    checkbox.checked = !checkbox.checked;

                    if (checkbox.checked) {
                        this.classList.add('active');
                        toggleCheckbox.textContent = '✓';
                    } else {
                        this.classList.remove('active');
                        toggleCheckbox.textContent = '☐';
                    }

                    updateModalChart();
                });
            });

            // 모달 데이터 라벨 토글 버튼 이벤트
            document.getElementById('modalDataLabelToggle').addEventListener('click', function() {
                showModalDataLabels = !showModalDataLabels;
                const toggleCheckbox = this.querySelector('.toggle-checkbox');

                if (showModalDataLabels) {
                    this.classList.add('active');
                    toggleCheckbox.textContent = '☑';
                } else {
                    this.classList.remove('active');
                    toggleCheckbox.textContent = '☐';
                }

                updateModalChart();
            });

            // 칩 호버 툴팁 초기화
            initChipHoverTooltips();
        });

        // ========================================
        // 칩 호버 툴팁 기능
        // ========================================

        function initChipHoverTooltips() {
            // 글로벌 툴팁 엘리먼트 생성
            let chipTooltip = document.getElementById('chipHoverTooltip');
            if (!chipTooltip) {
                chipTooltip = document.createElement('div');
                chipTooltip.id = 'chipHoverTooltip';
                chipTooltip.className = 'chip-hover-tooltip';
                document.body.appendChild(chipTooltip);
            }

            // 이벤트 위임 방식으로 호버 처리
            document.addEventListener('mouseenter', function(e) {
                if (!e.target || !e.target.closest) return;
                const chip = e.target.closest('.preset-chip[data-tooltip-title]');
                if (chip) {
                    showChipTooltip(chip, chipTooltip);
                }
            }, true);

            document.addEventListener('mouseleave', function(e) {
                if (!e.target || !e.target.closest) return;
                const chip = e.target.closest('.preset-chip[data-tooltip-title]');
                if (chip) {
                    hideChipTooltip(chipTooltip);
                }
            }, true);

            document.addEventListener('mousemove', function(e) {
                if (!e.target || !e.target.closest) return;
                const chip = e.target.closest('.preset-chip[data-tooltip-title]');
                if (chip && chipTooltip.classList.contains('show')) {
                    positionChipTooltip(e, chipTooltip);
                }
            }, true);
        }

        function showChipTooltip(chip, tooltip) {
            const title = chip.dataset.tooltipTitle || '';
            const icon = chip.dataset.tooltipIcon || '💡';
            const type = chip.dataset.tooltipType || '';
            const criteria = chip.dataset.tooltipCriteria || '';
            const action = chip.dataset.tooltipAction || '';
            const actionType = chip.dataset.tooltipActionType || 'info';
            const actionDetail = chip.dataset.tooltipActionDetail || '';

            // 기존 타입 클래스 제거 후 새 타입 클래스 추가
            tooltip.classList.remove('high-efficiency', 'potential', 'needs-attention', 'low-efficiency');
            if (type) {
                tooltip.classList.add(type);
            }

            let html = `
                <div class="chip-tooltip-header ${type}">
                    <span class="chip-tooltip-header-icon">${icon}</span>
                    <span class="chip-tooltip-header-title">${title}</span>
                </div>
            `;

            if (criteria) {
                html += `
                    <div class="chip-tooltip-criteria">
                        <div class="chip-tooltip-criteria-label">📊 분류 기준</div>
                        <div class="chip-tooltip-criteria-text">${criteria}</div>
                    </div>
                `;
            }

            if (action || actionDetail) {
                html += `
                    <div class="chip-tooltip-action">
                        <div class="chip-tooltip-action-label ${actionType}">✅ ${action}</div>
                        <div class="chip-tooltip-action-text">${actionDetail}</div>
                    </div>
                `;
            }

            tooltip.innerHTML = html;
            tooltip.classList.add('show');
        }

        function positionChipTooltip(e, tooltip) {
            const padding = 15;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;

            let left = e.clientX + padding;
            let top = e.clientY + padding;

            // 오른쪽 화면 밖으로 나가면 왼쪽에 표시
            if (left + tooltipWidth > viewportWidth - padding) {
                left = e.clientX - tooltipWidth - padding;
            }

            // 아래 화면 밖으로 나가면 위에 표시
            if (top + tooltipHeight > viewportHeight - padding) {
                top = e.clientY - tooltipHeight - padding;
            }

            // 최소값 보정
            if (left < padding) left = padding;
            if (top < padding) top = padding;

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideChipTooltip(tooltip) {
            tooltip.classList.remove('show');
        }
    
    })();
    </script>

    <!-- ========== 시계열 데이터 분석 스크립트 (timeseries_analysis.html) ========== -->
    <script>
    (function() {
        // timeseries 페이지 스크립트
        
        // 전역 변수
        let forecastData = [];
        let currentView = 'monthly';
        let forecastChart = null;
        let forecastChartTrend = null;  // 세그먼트 트렌드 내 전체 성과 예측 차트
        let insightsData = null;
        let currentPeriod = 'full';  // 분석 기간 (full, 180d, 90d)
        let aiSummaryPeriod = 'full';  // AI 요약 분석 기간 (독립)
        let alertsExpanded = false;  // 경고 펼침 상태
        let recommendationsExpanded = false;  // 추천 펼침 상태
        const INITIAL_ALERTS_COUNT = 6;  // 초기 표시 개수 (2x3)
        const INITIAL_RECOMMENDATIONS_COUNT = 4;  // 초기 추천 표시 개수

        // ============================================================================
        // 기간 필터링 헬퍼 함수
        // ============================================================================

        /**
         * 현재 선택된 기간의 인사이트 데이터 반환
         * @returns {Object} 기간별 인사이트 데이터
         */
        function getPeriodData() {
            if (!insightsData) return null;

            // by_period 구조인 경우
            if (insightsData.by_period) {
                return insightsData.by_period[currentPeriod] || insightsData.by_period['full'];
            }

            // 단일 구조인 경우 (이전 버전 호환)
            return insightsData;
        }

        /**
         * 기간 전환 함수
         * @param {string} period - 기간 (full, 180d, 90d)
         */
        function switchPeriod(period) {
            currentPeriod = period;
            alertsExpanded = false;  // 기간 전환 시 경고 펼침 상태 초기화
            recommendationsExpanded = false;  // 기간 전환 시 추천 펼침 상태 초기화

            // 버튼 활성화 상태 변경 (pill 스타일)
            document.querySelectorAll('.period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.classList.add('active');
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                }
            });

            // 인사이트 데이터가 있으면 업데이트 (AI 요약 제외)
            if (insightsData) {
                updateAllInsights();
                updatePeriodIndicator();
            }

            console.log(`기간 전환: ${period}`);
        }

        /**
         * AI 요약 기간별 데이터 반환
         * @returns {Object} AI 요약용 기간별 인사이트 데이터
         */
        function getAiSummaryPeriodData() {
            if (!insightsData) return null;

            if (insightsData.by_period) {
                return insightsData.by_period[aiSummaryPeriod] || insightsData.by_period['full'];
            }

            return insightsData;
        }

        /**
         * AI 요약 기간 전환 함수 (통합: AI 요약 + 경고/추천/기회/Matrix 탭)
         * @param {string} period - 기간 (full, 180d, 90d, 30d)
         */
        function switchAiSummaryPeriod(period) {
            aiSummaryPeriod = period;
            currentPeriod = period;  // 분석 기간도 함께 동기화
            alertsExpanded = false;  // 펼침 상태 초기화
            recommendationsExpanded = false;

            // 버튼 활성화 상태 변경 (pill 스타일)
            document.querySelectorAll('.ai-period-btn').forEach(btn => {
                if (btn.dataset.aiPeriod === period) {
                    btn.classList.add('active');
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                }
            });

            // AI 요약 + 모든 인사이트 탭 업데이트
            updateAiSummary();
            if (insightsData) {
                updateAllInsights();
            }

            console.log(`AI 요약 기간 전환 (통합): ${period}`);
        }

        /**
         * 실제 데이터 기간 표시 업데이트
         */
        function updatePeriodIndicator() {
            const indicator = document.getElementById('actualPeriodIndicator');
            if (!indicator) return;

            const periodData = getPeriodData();
            if (!periodData || !periodData.overall) {
                indicator.textContent = '';
                return;
            }

            // current_period가 있으면 사용, 없으면 forecast_period 사용
            const current = periodData.overall.current_period;
            const forecast = periodData.overall.forecast_period;

            let startDate = '';
            let endDate = '';
            let label = '실제 분석';

            if (current && current.start_date && current.end_date) {
                startDate = current.start_date;
                endDate = current.end_date;
                label = '실제 분석';
            } else if (forecast && forecast.start_date && forecast.end_date) {
                startDate = forecast.start_date;
                endDate = forecast.end_date;
                label = '예측 기간';
            }

            if (startDate && endDate) {
                indicator.innerHTML = `<span style="margin-right: 4px;">📅</span> ${label}: ${startDate} ~ ${endDate}`;
            } else {
                indicator.textContent = '';
            }
        }

        /**
         * 모든 인사이트 섹션 업데이트 (AI 요약 제외 - 독립 기간 설정)
         */
        function updateAllInsights() {
            updateSummaryCard();
            // updateAiSummary는 독립적인 기간 설정을 사용하므로 여기서 호출하지 않음
            updateOpportunities();
            updateInsightsBadges();
            updateInsightsFromData();  // 경고 알림 업데이트
            updateRecommendations();
            updatePerformanceTrends();
        }

        // 세그먼트 관련 전역 변수
        let segmentData = {
            channel: [],
            product: [],
            brand: [],
            promotion: []
        };
        let segmentTrendChart = null;
        let currentTrendSegmentType = 'overall';  // 전체 성과 예측이 기본
        let segmentTrendViewType = 'monthly';  // 세그먼트 트렌드 뷰 타입 (monthly, weekly, daily)
        let segmentTrendMetric = 'roas';  // 세그먼트 트렌드 지표 (roas, cost, revenue, conversions)
        let segmentTrendStartDate = '';   // 세그먼트 트렌드 시작일
        let segmentTrendEndDate = '';     // 세그먼트 트렌드 종료일
        let dailyDataForKPI = [];  // KPI 요약용 일별 원본 데이터 (뷰 타입과 독립)

        // 숫자 포맷
        function formatNumber(num) {
            if (num === 0 || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        }

        // 소수점 포맷 (2자리)
        function formatDecimal(num) {
            if (num === 0 || num === null || num === undefined || !isFinite(num)) return '0';
            return num.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }

        // 퍼센트 포맷
        function formatPercent(num) {
            if (num === 0 || num === null || num === undefined || !isFinite(num)) return '0';
            return num.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
        }

        // CSV 파싱 (RFC 4180 호환)
        function parseCSV(text) {
            const lines = text.trim().split('\n');

            // RFC 4180 호환 CSV 파싱
            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // 연속된 따옴표는 이스케이프된 따옴표
                            current += '"';
                            i++; // 다음 따옴표 건너뛰기
                        } else {
                            // 따옴표 시작/종료
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 따옴표 밖의 쉼표는 구분자
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                // 마지막 필드 추가
                result.push(current);
                return result;
            }

            const headers = parseLine(lines[0]).map(h => h.trim());

            return lines.slice(1).map(line => {
                const values = parseLine(line);
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                return obj;
            });
        }

        // 데이터 로드
        async function loadData() {
            try {
                // 항상 일별 데이터를 로드하고 뷰에 따라 집계
                const response = await fetch('forecast/predictions_daily.csv');
                const text = await response.text();
                const dailyData = parseCSV(text);

                // KPI 요약용 일별 원본 데이터 저장 (최초 로드 시에만)
                if (dailyDataForKPI.length === 0) {
                    dailyDataForKPI = dailyData;
                }

                // 뷰 타입에 따라 데이터 집계 (차트용)
                if (currentView === 'daily') {
                    forecastData = dailyData;
                } else {
                    forecastData = aggregateData(dailyData, currentView);
                }

                updateDashboard();

                // 세그먼트 트렌드 전체 성과 예측 차트도 업데이트
                if (currentTrendSegmentType === 'overall') {
                    updateOverallForecastChart();
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
            }
        }

        // 인사이트 데이터 로드
        async function loadInsightsAndSegments() {
            try {
                // insights.json 로드
                const insightsResponse = await fetch('forecast/insights.json');
                if (!insightsResponse.ok) {
                    throw new Error(`insights.json 로드 실패: ${insightsResponse.status}`);
                }
                insightsData = await insightsResponse.json();

                // 인사이트 업데이트
                updateSummaryCard();
                updateAiSummary();
                updateInsightsFromData();
                updateRecommendations();
                updateOpportunities();
                updateInsightsBadges();
                updatePerformanceTrends();
                updatePeriodIndicator();
            } catch (error) {
                console.error('인사이트 데이터 로드 실패:', error);

                // 에러 메시지 표시
                const recommendationContainer = document.getElementById('recommendationContent');
                if (recommendationContainer) {
                    recommendationContainer.innerHTML = `
                        <div class="insight-card neutral">
                            <div class="insight-text">데이터 로드 실패: ${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // 세그먼트 CSV 데이터 로드
        async function loadSegmentData() {
            try {
                const segmentTypes = ['channel', 'product', 'brand', 'promotion'];

                for (const type of segmentTypes) {
                    const response = await fetch(`forecast/segment_${type}.csv`);
                    if (!response.ok) {
                        console.warn(`segment_${type}.csv 로드 실패`);
                        continue;
                    }
                    const text = await response.text();
                    segmentData[type] = parseCSV(text);
                }

                // 세그먼트 분석 초기화
                initSegmentAnalysis();
            } catch (error) {
                console.error('세그먼트 데이터 로드 실패:', error);
            }
        }

        // 세그먼트 분석 초기화
        function initSegmentAnalysis() {
            updateSegmentTrendCheckboxes();
            initSegmentTrendDateRange();  // 기간 초기값 설정

            // 예산 시뮬레이션 초기화 (기본 탭)
            if (typeof initSimulation === 'function') {
                initSimulation();
            }
        }

        // 세그먼트 트렌드 기간 초기값 설정
        function initSegmentTrendDateRange() {
            const data = segmentData['channel'];  // 기본적으로 channel 데이터 사용
            if (!data || data.length === 0) return;

            // 날짜 추출 및 정렬
            const dates = data.map(row => row['일 구분']).filter(Boolean).sort();
            if (dates.length === 0) return;

            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];

            // 날짜 입력 필드에 초기값 설정
            const startInput = document.getElementById('segmentTrendStartDate');
            const endInput = document.getElementById('segmentTrendEndDate');

            if (startInput) {
                startInput.value = minDate;
                startInput.min = minDate;
                startInput.max = maxDate;
                segmentTrendStartDate = minDate;
            }

            if (endInput) {
                endInput.value = maxDate;
                endInput.min = minDate;
                endInput.max = maxDate;
                segmentTrendEndDate = maxDate;
            }
        }

        // 세그먼트 트렌드 드롭다운 라벨 업데이트
        function updateSegmentTrendDropdownLabel() {
            const checkedBoxes = document.querySelectorAll('.segment-trend-checkbox:checked');
            const labelEl = document.getElementById('segmentTrendDropdownLabel');
            const countEl = document.getElementById('segmentTrendSelectedCount');
            const countEl2 = document.getElementById('selectedSegmentCount');

            if (labelEl) {
                if (checkedBoxes.length === 0) {
                    labelEl.textContent = '항목을 선택하세요';
                } else if (checkedBoxes.length === 1) {
                    labelEl.textContent = checkedBoxes[0].dataset.segment;
                } else {
                    labelEl.textContent = `${checkedBoxes[0].dataset.segment} 외 ${checkedBoxes.length - 1}개`;
                }
            }

            if (countEl) {
                countEl.textContent = checkedBoxes.length > 0 ? `${checkedBoxes.length}개` : '';
            }

            if (countEl2) {
                countEl2.textContent = checkedBoxes.length;
            }
        }

        // 세그먼트 트렌드 체크박스 업데이트
        function updateSegmentTrendCheckboxes() {
            const container = document.getElementById('segmentTrendCheckboxes');
            if (!container) return;

            const data = segmentData[currentTrendSegmentType];
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div style="padding: 12px; text-align: center; color: var(--grey-600); font-size: 12px;">
                        해당 주요 항목 데이터가 없습니다.
                    </div>
                `;
                updateSegmentTrendDropdownLabel();
                return;
            }

            // 세그먼트 이름 추출
            const segmentNames = [...new Set(data.map(row =>
                row[currentTrendSegmentType] || row.channel || row.product || row.brand || row.promotion
            ))].filter(Boolean);

            // 드롭다운 체크박스 아이템 생성
            const html = segmentNames.map((name, index) => `
                <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                    <input type="checkbox" class="segment-trend-checkbox" data-segment="${name}" ${index < 3 ? 'checked' : ''} style="margin-right: 10px; width: 14px; height: 14px; cursor: pointer;">
                    <span>${name}</span>
                </label>
            `).join('');

            container.innerHTML = html;

            // 전체 선택 체크박스 상태 업데이트
            updateSelectAllState();

            // 체크박스 이벤트 추가
            document.querySelectorAll('.segment-trend-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // 최대 5개만 선택 가능
                    const checkedCount = document.querySelectorAll('.segment-trend-checkbox:checked').length;
                    if (checkedCount > 5) {
                        this.checked = false;
                        alert('최대 5개 항목까지만 선택할 수 있습니다.');
                        return;
                    }
                    updateSelectAllState();
                    updateSegmentTrendDropdownLabel();
                    updateSegmentTrendChart();
                });
            });

            // 드롭다운 라벨 업데이트
            updateSegmentTrendDropdownLabel();

            // 초기 차트 그리기
            updateSegmentTrendChart();
        }

        // 전체 선택 체크박스 상태 업데이트
        function updateSelectAllState() {
            const selectAllCheckbox = document.getElementById('segmentTrendSelectAll');
            const allCheckboxes = document.querySelectorAll('.segment-trend-checkbox');
            const checkedCount = document.querySelectorAll('.segment-trend-checkbox:checked').length;

            if (selectAllCheckbox) {
                // 5개 또는 전체가 선택되어 있으면 체크
                selectAllCheckbox.checked = (checkedCount === allCheckboxes.length) || (checkedCount === 5);
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < Math.min(5, allCheckboxes.length);
            }
        }

        // 세그먼트 트렌드 차트 업데이트
        function updateSegmentTrendChart() {
            const data = segmentData[currentTrendSegmentType];
            if (!data || data.length === 0) return;

            // 선택된 세그먼트 가져오기
            const selectedSegments = Array.from(document.querySelectorAll('.segment-trend-checkbox:checked'))
                .map(cb => cb.dataset.segment);

            // 선택된 개수 업데이트
            const countEl = document.getElementById('selectedSegmentCount');
            if (countEl) {
                countEl.textContent = selectedSegments.length;
            }

            if (selectedSegments.length === 0) {
                // 차트 초기화
                if (segmentTrendChart) {
                    segmentTrendChart.destroy();
                    segmentTrendChart = null;
                }
                return;
            }

            // 날짜 키 생성 함수 (뷰 타입에 따라)
            const getDateKey = (dateStr) => {
                const date = new Date(dateStr);
                if (segmentTrendViewType === 'weekly') {
                    // 주 시작일 (월요일) 계산
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(date);
                    monday.setDate(diff);
                    return monday.toISOString().split('T')[0];
                } else if (segmentTrendViewType === 'monthly') {
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }
                return dateStr;  // daily
            };

            // 날짜별로 데이터 그룹화 (뷰 타입 적용 + 기간 필터)
            const dateGroups = {};
            data.forEach(row => {
                const rowDate = row['일 구분'];

                // 기간 필터 적용
                if (segmentTrendStartDate && rowDate < segmentTrendStartDate) return;
                if (segmentTrendEndDate && rowDate > segmentTrendEndDate) return;

                const dateKey = getDateKey(rowDate);
                const segmentName = row[currentTrendSegmentType] || row.channel || row.product || row.brand || row.promotion;

                if (!selectedSegments.includes(segmentName)) return;

                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = {};
                }
                if (!dateGroups[dateKey][segmentName]) {
                    dateGroups[dateKey][segmentName] = {
                        cost: 0,
                        conversions: 0,
                        revenue: 0,
                        hasActual: false,
                        hasForecast: false
                    };
                }

                dateGroups[dateKey][segmentName].cost += parseFloat(row['비용_예측']) || 0;
                dateGroups[dateKey][segmentName].conversions += parseFloat(row['전환수_예측']) || 0;
                dateGroups[dateKey][segmentName].revenue += parseFloat(row['전환값_예측']) || 0;

                // 타입 추적
                if (row.type === 'actual') dateGroups[dateKey][segmentName].hasActual = true;
                if (row.type === 'forecast') dateGroups[dateKey][segmentName].hasForecast = true;
            });

            // 날짜 정렬
            const dates = Object.keys(dateGroups).sort();

            // 지표별 값 계산 함수
            const getMetricValue = (seg) => {
                if (!seg) return 0;
                switch (segmentTrendMetric) {
                    case 'roas':
                        return seg.cost > 0 ? (seg.revenue / seg.cost * 100) : 0;
                    case 'cost':
                        return seg.cost;
                    case 'revenue':
                        return seg.revenue;
                    case 'conversions':
                        return seg.conversions;
                    default:
                        return seg.cost > 0 ? (seg.revenue / seg.cost * 100) : 0;
                }
            };

            // 지표별 Y축 라벨
            const metricLabels = {
                roas: 'ROAS (%)',
                cost: '비용 (원)',
                revenue: '전환값 (원)',
                conversions: '전환수'
            };

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#ff9800', '#4caf50', '#00c853', '#9c27b0', '#03a9f4', '#8bc34a', '#ff5722'];
            const datasets = selectedSegments.map((segmentName, index) => {
                const values = dates.map(date => {
                    const seg = dateGroups[date][segmentName];
                    return getMetricValue(seg);
                });

                // 실제/예측 구분 (주별/월별 집계 시 혼합 처리)
                const actualValues = values.map((val, idx) => {
                    const seg = dateGroups[dates[idx]][segmentName];
                    // 실제 데이터만 있거나, 혼합(실제+예측)인 경우 실제값으로 표시
                    const isActual = seg && seg.hasActual && !seg.hasForecast;
                    const isMixed = seg && seg.hasActual && seg.hasForecast;
                    return (isActual || isMixed) ? val : null;
                });
                const forecastValues = values.map((val, idx) => {
                    const seg = dateGroups[dates[idx]][segmentName];
                    // 예측 데이터만 있는 경우 예측값으로 표시
                    const isForecast = seg && seg.hasForecast && !seg.hasActual;
                    return isForecast ? val : null;
                });

                // 연결을 위해 마지막 실제값을 예측 시작점에 추가
                const lastActualIdx = actualValues.findLastIndex(v => v !== null);
                if (lastActualIdx >= 0 && lastActualIdx < forecastValues.length - 1) {
                    forecastValues[lastActualIdx] = actualValues[lastActualIdx];
                }

                const color = colors[index % colors.length];

                return [
                    {
                        label: segmentName,
                        data: actualValues,
                        borderColor: color,
                        backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: false,
                        tension: 0.4,
                        spanGaps: false
                    },
                    {
                        label: segmentName + ' (예측)',
                        data: forecastValues,
                        borderColor: color,
                        backgroundColor: color.replace(')', ', 0.05)').replace('rgb', 'rgba'),
                        borderWidth: 2,
                        borderDash: [6, 4],
                        pointRadius: 4,
                        pointStyle: 'triangle',
                        fill: false,
                        tension: 0.4,
                        spanGaps: false
                    }
                ];
            }).flat();

            // 차트 그리기
            const ctx = document.getElementById('segmentTrendChart');
            if (!ctx) return;

            if (segmentTrendChart) {
                segmentTrendChart.destroy();
            }

            segmentTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                filter: function(item) {
                                    // 예측 데이터셋은 범례에서 숨김
                                    return !item.text.includes('(예측)');
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    label = label.replace(' (예측)', '');
                                    if (label) {
                                        label += ': ';
                                    }

                                    // 지표별 포맷팅
                                    if (segmentTrendMetric === 'roas') {
                                        label += formatDecimal(context.parsed.y) + '%';
                                    } else if (segmentTrendMetric === 'conversions') {
                                        label += formatNumber(context.parsed.y) + '건';
                                    } else {
                                        label += formatNumber(context.parsed.y) + '원';
                                    }

                                    // 예측값 여부 표시
                                    if (context.dataset.borderDash) {
                                        label += ' (예측)';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: metricLabels[segmentTrendMetric] || 'ROAS (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (segmentTrendMetric === 'roas') {
                                        return value + '%';
                                    } else if (segmentTrendMetric === 'conversions') {
                                        return formatNumber(value);
                                    } else {
                                        return formatNumber(value);
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 데이터 집계 (주별/월별)
        function aggregateData(data, viewType) {
            const groups = {};

            data.forEach(row => {
                let key;
                const date = new Date(row['일 구분']);

                if (viewType === 'weekly') {
                    // 주 시작일 (월요일) 계산
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(date);
                    monday.setDate(diff);
                    key = monday.toISOString().split('T')[0];
                } else if (viewType === 'monthly') {
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                }

                if (!groups[key]) {
                    groups[key] = {
                        비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0,
                        hasActual: false, hasForecast: false
                    };
                }

                groups[key].비용 += parseFloat(row['비용_예측']) || 0;
                groups[key].노출 += parseFloat(row['노출_예측']) || 0;
                groups[key].클릭 += parseFloat(row['클릭_예측']) || 0;
                groups[key].전환수 += parseFloat(row['전환수_예측']) || 0;
                groups[key].전환값 += parseFloat(row['전환값_예측']) || 0;

                if (row.type === 'actual') groups[key].hasActual = true;
                if (row.type === 'forecast') groups[key].hasForecast = true;
            });

            // 정렬 및 변환
            return Object.entries(groups)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([period, values]) => ({
                    '일 구분': period,
                    '비용_예측': values.비용,
                    '노출_예측': values.노출,
                    '클릭_예측': values.클릭,
                    '전환수_예측': values.전환수,
                    '전환값_예측': values.전환값,
                    // 예측 데이터가 포함되어 있으면 forecast로 표시
                    type: values.hasForecast && !values.hasActual ? 'forecast' :
                          values.hasForecast && values.hasActual ? 'mixed' : 'actual'
                }));
        }

        // 대시보드 업데이트
        function updateDashboard() {
            updateKPISummary();
            updateChart();
        }

        // KPI 요약 업데이트 (일별 원본 데이터 사용 - 뷰 타입과 독립)
        function updateKPISummary() {
            // 일별 원본 데이터 사용 (뷰 타입 변경에 영향받지 않음)
            const dataSource = dailyDataForKPI.length > 0 ? dailyDataForKPI : forecastData;
            const actualData = dataSource.filter(d => d.type === 'actual');
            const forecastDataOnly = dataSource.filter(d => d.type === 'forecast');

            // 실제 데이터 합계
            const actualTotals = actualData.reduce((acc, row) => {
                acc.비용 += parseFloat(row['비용_예측']) || 0;
                acc.노출 += parseFloat(row['노출_예측']) || 0;
                acc.클릭 += parseFloat(row['클릭_예측']) || 0;
                acc.전환수 += parseFloat(row['전환수_예측']) || 0;
                acc.전환값 += parseFloat(row['전환값_예측']) || 0;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            // 예측 데이터 합계
            const forecastTotals = forecastDataOnly.reduce((acc, row) => {
                acc.비용 += parseFloat(row['비용_예측']) || 0;
                acc.노출 += parseFloat(row['노출_예측']) || 0;
                acc.클릭 += parseFloat(row['클릭_예측']) || 0;
                acc.전환수 += parseFloat(row['전환수_예측']) || 0;
                acc.전환값 += parseFloat(row['전환값_예측']) || 0;
                return acc;
            }, { 비용: 0, 노출: 0, 클릭: 0, 전환수: 0, 전환값: 0 });

            // 파생 지표 계산 (예측)
            const forecastCPM = forecastTotals.노출 > 0 ? (forecastTotals.비용 / forecastTotals.노출 * 1000) : 0;
            const forecastCPC = forecastTotals.클릭 > 0 ? (forecastTotals.비용 / forecastTotals.클릭) : 0;
            const forecastCPA = forecastTotals.전환수 > 0 ? (forecastTotals.비용 / forecastTotals.전환수) : 0;
            const forecastROAS = forecastTotals.비용 > 0 ? (forecastTotals.전환값 / forecastTotals.비용 * 100) : 0;

            // 파생 지표 계산 (실제)
            const actualCPM = actualTotals.노출 > 0 ? (actualTotals.비용 / actualTotals.노출 * 1000) : 0;
            const actualCPC = actualTotals.클릭 > 0 ? (actualTotals.비용 / actualTotals.클릭) : 0;
            const actualCPA = actualTotals.전환수 > 0 ? (actualTotals.비용 / actualTotals.전환수) : 0;
            const actualROAS = actualTotals.비용 > 0 ? (actualTotals.전환값 / actualTotals.비용 * 100) : 0;

            // 변화율 계산
            const calcChange = (forecast, actual) => {
                if (actual === 0) return 0;
                return ((forecast - actual) / actual * 100).toFixed(1);
            };

            // 상위 행: 주요 성과 (5개) - 비용 및 효율 지표
            const topKpis = [
                { label: '예측 비용', value: formatNumber(forecastTotals.비용), unit: '원', change: calcChange(forecastTotals.비용, actualTotals.비용), icon: '💰', highlight: false },
                { label: '예측 ROAS', value: formatPercent(forecastROAS), unit: '%', change: calcChange(forecastROAS, actualROAS), icon: '📈', highlight: true },
                { label: '예측 CPA', value: formatNumber(forecastCPA), unit: '원', change: calcChange(forecastCPA, actualCPA), icon: '🎯', highlight: false },
                { label: '예측 CPC', value: formatDecimal(forecastCPC), unit: '원', change: calcChange(forecastCPC, actualCPC), icon: '🖱️', highlight: false },
                { label: '예측 CPM', value: formatDecimal(forecastCPM), unit: '원', change: calcChange(forecastCPM, actualCPM), icon: '👁️', highlight: false }
            ];

            // 하위 행: 세부 성과 (4개) - 기본 성과 지표
            const bottomKpis = [
                { label: '예측 노출', value: formatNumber(forecastTotals.노출), unit: '회', change: calcChange(forecastTotals.노출, actualTotals.노출), icon: '👀' },
                { label: '예측 클릭', value: formatNumber(forecastTotals.클릭), unit: '회', change: calcChange(forecastTotals.클릭, actualTotals.클릭), icon: '👆' },
                { label: '예측 전환수', value: formatNumber(forecastTotals.전환수), unit: '건', change: calcChange(forecastTotals.전환수, actualTotals.전환수), icon: '✅' },
                { label: '예측 전환값', value: formatNumber(forecastTotals.전환값), unit: '원', change: calcChange(forecastTotals.전환값, actualTotals.전환값), icon: '💵' }
            ];

            // KPI 카드 HTML 생성 함수 (primary) - marketing_dashboard_v3.html 스타일
            const createKpiCard = (kpi) => `
                <div class="kpi-card${kpi.highlight ? ' highlight' : ''}">
                    <div class="kpi-header">
                        <span class="kpi-title">${kpi.label}</span>
                        <div class="kpi-icon">${kpi.icon}</div>
                    </div>
                    <div class="kpi-value${kpi.highlight ? ' highlight-value' : ''}">${kpi.value}</div>
                    <div class="kpi-trend ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                        <span class="trend-badge ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                            ${parseFloat(kpi.change) >= 0 ? '▲' : '▼'} ${Math.abs(kpi.change)}%
                        </span>
                        <span style="color: var(--grey-500); font-size: 12px;">vs 실제</span>
                    </div>
                </div>
            `;

            // KPI 카드 HTML 생성 함수 (secondary) - marketing_dashboard_v3.html 스타일
            const createSecondaryKpiCard = (kpi) => `
                <div class="kpi-card secondary">
                    <div class="kpi-header">
                        <span class="kpi-title">${kpi.label}</span>
                        <div class="kpi-icon">${kpi.icon}</div>
                    </div>
                    <div class="kpi-value">${kpi.value}</div>
                    <div class="kpi-trend ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                        <span class="trend-badge ${parseFloat(kpi.change) >= 0 ? 'up' : 'down'}">
                            ${parseFloat(kpi.change) >= 0 ? '▲' : '▼'} ${Math.abs(kpi.change)}%
                        </span>
                        <span style="color: var(--grey-500); font-size: 12px;">vs 실제</span>
                    </div>
                </div>
            `;

            // 주요 성과 / 세부 성과 토글 레이아웃 HTML 생성
            document.getElementById('kpiSummaryGrid').innerHTML = `
                <section class="kpi-grid kpi-grid-primary" style="margin-bottom: 0;">
                    ${topKpis.map(createKpiCard).join('')}
                </section>
                <section class="kpi-grid kpi-grid-secondary" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 0;">
                    ${bottomKpis.map(createSecondaryKpiCard).join('')}
                </section>
            `;
        }

        // Summary Card 업데이트 (summary_card)
        function updateSummaryCard() {
            const container = document.getElementById('summaryCardContainer');
            const periodData = getPeriodData();
            if (!container || !periodData || !periodData.summary_card) {
                return;
            }

            const card = periodData.summary_card;
            container.style.display = 'block';

            // 상태 색상 설정
            const colorMap = {
                'blue': { bg: '#e3f2fd', border: '#2196f3', text: '#1565c0' },
                'green': { bg: '#e8f5e9', border: '#4caf50', text: '#2e7d32' },
                'yellow': { bg: '#fff8e1', border: '#ffc107', text: '#f57f17' },
                'red': { bg: '#ffebee', border: '#f44336', text: '#c62828' }
            };
            const colors = colorMap[card.status_color] || colorMap['blue'];
            container.style.background = colors.bg;
            container.style.borderLeft = `4px solid ${colors.border}`;

            document.getElementById('summaryCardStatus').textContent = card.status_title || '';
            document.getElementById('summaryCardStatus').style.color = colors.text;
            document.getElementById('summaryCardMessage').textContent = card.status_message || '';
            document.getElementById('summaryCardPeriod').textContent = card.period || '';

            // 메트릭스 표시
            if (card.metrics) {
                const m = card.metrics;
                const metricsHtml = `
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">현재 매출</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--grey-900);">${m.current_revenue || '-'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">예측 매출</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--primary-main);">${m.forecast_revenue || '-'}</div>
                        <div style="font-size: 11px; color: ${m.revenue_change_pct >= 0 ? '#2e7d32' : '#c62828'};">${m.revenue_change_pct >= 0 ? '▲' : '▼'} ${Math.abs(m.revenue_change_pct || 0).toFixed(1)}%</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">현재 ROAS</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--grey-900);">${(m.current_roas || 0).toFixed(0)}%</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.7); border-radius: 8px; text-align: center;">
                        <div style="font-size: 11px; color: var(--grey-600);">예측 ROAS</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--primary-main);">${(m.forecast_roas || 0).toFixed(0)}%</div>
                        <div style="font-size: 11px; color: ${m.roas_change_val >= 0 ? '#2e7d32' : '#c62828'};">${m.roas_change_val >= 0 ? '▲' : '▼'} ${Math.abs(m.roas_change_val || 0).toFixed(1)}%p</div>
                    </div>
                `;
                document.getElementById('summaryCardMetrics').innerHTML = metricsHtml;
            }
        }

        // AI 요약 메시지 업데이트 (summary) - 독립적인 기간 설정 사용
        function updateAiSummary() {
            const container = document.getElementById('aiSummaryContainer');
            const contentContainer = document.getElementById('aiSummaryContent');
            const periodData = getAiSummaryPeriodData();  // 독립적인 AI 요약 기간 데이터 사용
            if (!container || !contentContainer || !periodData || !periodData.summary) {
                if (container) container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            // 요약 텍스트를 줄 단위로 파싱하여 카드로 표시
            const summary = periodData.summary;
            const lines = summary.split('\n').filter(line => line.trim());

            // 카테고리별 아이콘/색상 정의
            const categories = {
                performance: { icon: '📊', bg: '#e3f2fd', border: '#1976d2', color: '#1565c0', label: '성과 현황', keywords: ['전체 성과', 'ROAS', '전환수', '전환값'] },
                trend_up: { icon: '📈', bg: '#e8f5e9', border: '#43a047', color: '#2e7d32', label: '상승 트렌드', keywords: ['개선 예상', '증가', '상승'] },
                trend_down: { icon: '📉', bg: '#ffebee', border: '#e53935', color: '#c62828', label: '하락 트렌드', keywords: ['하락 예상', '감소', '하락'] },
                warning: { icon: '⚠️', bg: '#fff3e0', border: '#fb8c00', color: '#e65100', label: '주의 필요', keywords: ['위험', '경고', '심각'] },
                conversion: { icon: '🛒', bg: '#fce4ec', border: '#ec407a', color: '#c2185b', label: '전환 분석', keywords: ['전환 하락', '전환율'] },
                recommend: { icon: '💡', bg: '#f3e5f5', border: '#ab47bc', color: '#7b1fa2', label: '추천 액션', keywords: ['권장', '추천', '증액'] },
                review: { icon: '🔍', bg: '#e8eaf6', border: '#5c6bc0', color: '#3949ab', label: '검토 대상', keywords: ['검토', '분석 필요'] },
                info: { icon: '💬', bg: '#f5f5f5', border: '#9e9e9e', color: '#616161', label: '정보', keywords: [] }
            };

            // 카테고리 판별 (이모지 우선)
            const getCategory = (line) => {
                const trimmed = line.trim();

                // 1. 줄 시작 이모지로 먼저 판별 (다양한 이모지 변형 처리)
                // 성과 현황
                if (/^📊/.test(trimmed)) return categories.performance;
                // 상승 트렌드
                if (/^📈/.test(trimmed)) return categories.trend_up;
                // 하락 트렌드
                if (/^📉/.test(trimmed)) return categories.trend_down;
                // 경고/주의 (⚠️, 🚨, ⚠ 등)
                if (/^[⚠️🚨‼️❗❕⛔🔴]/.test(trimmed) || trimmed.startsWith('⚠')) return categories.warning;
                // 전환 분석
                if (/^🛒/.test(trimmed)) return categories.conversion;
                // 추천 액션
                if (/^💡/.test(trimmed)) return categories.recommend;
                // 검토 대상
                if (/^🔍/.test(trimmed)) return categories.review;

                // 2. 키워드 기반 판별 (이모지 없는 경우)
                // 주의/경고 관련
                if (/주의|경고|위험|심각|소진/.test(trimmed)) return categories.warning;
                // 트렌드 관련
                if (/트렌드|Trend/.test(trimmed)) {
                    if (/\+|개선|증가|상승/.test(trimmed)) return categories.trend_up;
                    if (/-|하락|감소|하향/.test(trimmed)) return categories.trend_down;
                }
                // 추천 관련
                if (/권장|추천|증액/.test(trimmed)) return categories.recommend;
                // 검토 관련
                if (/검토|분석 필요/.test(trimmed)) return categories.review;

                return categories.info;
            };

            // 이모지 및 중복 접두사 제거 함수
            const removeEmoji = (text) => {
                // 1. 이모지 제거
                let cleaned = text.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]/gu, '').trim();
                // 2. 중복 접두사 제거 (카테고리 라벨과 중복되는 텍스트)
                cleaned = cleaned.replace(/^(주의|경고|권장|추천|정보|알림|참고)\s*[:：]\s*/i, '');
                return cleaned;
            };

            // 증감 강조 함수
            const highlightChanges = (text) => {
                // +숫자% 또는 +숫자%p 패턴 (상승) - 초록색
                text = text.replace(/(\+[\d.]+%p?)/g, '<span style="color: #2e7d32; font-weight: 600;">$1</span>');
                // -숫자% 또는 -숫자%p 패턴 (하락) - 빨간색
                text = text.replace(/([-−][\d.]+%p?)/g, '<span style="color: #c62828; font-weight: 600;">$1</span>');
                // "N% 증가/상승" 패턴
                text = text.replace(/([\d.]+%)\s*(증가|상승|개선)/g, '<span style="color: #2e7d32; font-weight: 600;">$1 $2</span>');
                // "N% 감소/하락" 패턴
                text = text.replace(/([\d.]+%)\s*(감소|하락|하향)/g, '<span style="color: #c62828; font-weight: 600;">$1 $2</span>');
                return text;
            };

            // 핵심 3개 카드만 추출 (중복 제거)
            // 우선순위: 1. 성과 현황 (📊) 2. 주요 경고/트렌드 (🚨/📉) 3. 추천 액션 (💡)
            const coreCards = [];
            const seenTypes = new Set();

            // 연속된 줄들을 그룹화 (들여쓰기로 시작하면 이전 항목에 추가)
            const groupedLines = [];
            lines.forEach(line => {
                if (line.startsWith('   ') && groupedLines.length > 0) {
                    groupedLines[groupedLines.length - 1].subLines.push(line.trim());
                } else if (line.trim()) {
                    groupedLines.push({ main: line.trim(), subLines: [] });
                }
            });

            // 핵심 카드 선별 (각 타입별 1개씩, 키워드 기반 보강)
            for (const group of groupedLines) {
                const cat = getCategory(group.main);
                const text = group.main;

                // 성과 현황 (1개) - 📊 또는 '전체 성과' 키워드
                if ((cat.label === '성과 현황' || /전체 성과|ROAS.*전환수/.test(text)) && !seenTypes.has('performance')) {
                    seenTypes.add('performance');
                    coreCards.push({ ...group, cat, priority: 1 });
                }
                // 주요 경고/트렌드 (1개) - 🚨📉 또는 '하락/주의' 키워드
                else if ((cat.label === '주의 필요' || cat.label === '하락 트렌드' || /하락 예상|하락할 것으로/.test(text)) && !seenTypes.has('warning')) {
                    seenTypes.add('warning');
                    coreCards.push({ ...group, cat, priority: 2 });
                }
                // 추천 액션 (1개) - 💡 또는 '권장/추천' 키워드
                else if ((cat.label === '추천 액션' || /^💡|권장:|추천:/.test(text)) && !seenTypes.has('recommend')) {
                    seenTypes.add('recommend');
                    coreCards.push({ ...group, cat: categories.recommend, priority: 3 });
                }

                if (coreCards.length >= 3) break;
            }

            // 3개 미만이면 검토 대상 추가
            if (coreCards.length < 3) {
                for (const group of groupedLines) {
                    const cat = getCategory(group.main);
                    if ((cat.label === '검토 대상' || /검토 대상|🔍/.test(group.main)) && !seenTypes.has('review')) {
                        seenTypes.add('review');
                        coreCards.push({ ...group, cat: categories.review, priority: 4 });
                    }
                    if (coreCards.length >= 3) break;
                }
            }

            // 여전히 3개 미만이면 나머지 항목에서 보충
            if (coreCards.length < 3) {
                for (const group of groupedLines) {
                    const cat = getCategory(group.main);
                    const alreadyAdded = coreCards.some(c => c.main === group.main);
                    if (!alreadyAdded) {
                        coreCards.push({ ...group, cat, priority: 5 });
                    }
                    if (coreCards.length >= 3) break;
                }
            }

            // 우선순위 정렬
            coreCards.sort((a, b) => a.priority - b.priority);

            // 추천 데이터 가져오기
            const recommendations = periodData.segments?.recommendations || [];

            let html = '';  // wrapper 제거 - #aiSummaryContent가 이미 그리드 컨테이너

            coreCards.forEach((group, cardIndex) => {
                const cat = group.cat;
                const cleanText = highlightChanges(removeEmoji(group.main));
                // 추천 액션 카드가 아닌 경우에만 recommendations에서 매칭
                const matchedRec = cat.label !== '추천 액션' && recommendations.length > 0
                    ? recommendations[cardIndex % recommendations.length]
                    : null;
                const hasAction = matchedRec || group.subLines.length > 0;

                html += `
                    <div style="
                        background: ${cat.bg};
                        border: 2px solid ${cat.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                        display: flex;
                        flex-direction: column;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <div style="width: 32px; height: 32px; background: ${cat.border}20; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 16px;">${cat.icon}</span>
                            </div>
                            <span style="font-size: 11px; font-weight: 700; color: ${cat.color}; text-transform: uppercase; letter-spacing: 0.5px;">${cat.label}</span>
                        </div>
                        <!-- 메시지 -->
                        <div style="font-size: 13px; font-weight: 500; color: var(--grey-900); line-height: 1.6; flex: 1; margin-bottom: ${hasAction ? '10px' : '0'};">${cleanText}</div>
                        <!-- 서브라인 (들여쓰기 항목) -->
                        ${group.subLines.length > 0 ? `
                            <div style="background: rgba(255,255,255,0.7); border-radius: 6px; padding: 10px; border-left: 3px solid ${cat.border}; margin-bottom: ${matchedRec ? '10px' : '0'};">
                                <div style="font-size: 10px; font-weight: 600; color: ${cat.color}; margin-bottom: 4px;">📌 상세 정보</div>
                                ${group.subLines.map(sub => `<div style="font-size: 11px; color: #333; line-height: 1.5;">→ ${highlightChanges(sub)}</div>`).join('')}
                            </div>
                        ` : ''}
                        <!-- 추천 액션 (경고 및 추천 스타일) -->
                        ${matchedRec ? `
                            <div style="background: rgba(255,255,255,0.7); border-radius: 6px; padding: 10px; border-left: 3px solid #ab47bc;">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <div style="font-size: 10px; font-weight: 600; color: #7b1fa2;">💡 추천 액션</div>
                                    ${matchedRec.action_type ? `<span style="font-size: 9px; padding: 2px 6px; background: ${matchedRec.action_type === 'scale_up' ? '#e8f5e9' : matchedRec.action_type === 'defend' ? '#fff3e0' : matchedRec.action_type === 'optimize' ? '#e3f2fd' : '#ffebee'}; color: ${matchedRec.action_type === 'scale_up' ? '#2e7d32' : matchedRec.action_type === 'defend' ? '#e65100' : matchedRec.action_type === 'optimize' ? '#1565c0' : '#c62828'}; border-radius: 4px; font-weight: 600;">${matchedRec.action_type === 'scale_up' ? '증액' : matchedRec.action_type === 'defend' ? '방어' : matchedRec.action_type === 'optimize' ? '최적화' : '감액'}</span>` : ''}
                                </div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${matchedRec.action}</div>
                                ${matchedRec.context_advice ? `<div style="font-size: 10px; color: #5e35b1; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #d1c4e9; line-height: 1.4;">💬 ${matchedRec.context_advice}</div>` : ''}
                                ${matchedRec.expected_impact ? `<div style="font-size: 10px; color: #2e7d32; margin-top: 4px;">📈 ${matchedRec.expected_impact}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            // wrapper 닫는 태그 제거 - #aiSummaryContent가 이미 그리드 컨테이너
            contentContainer.innerHTML = html;
        }

        // 기회 요소 업데이트 (opportunities)
        function updateOpportunities() {
            const container = document.getElementById('opportunitiesContent');
            const badge = document.getElementById('opportunitiesBadge');
            const periodData = getPeriodData();
            if (!container || !periodData) {
                return;
            }

            const opportunities = periodData.opportunities || [];

            if (opportunities.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">현재 발견된 기회 요소가 없습니다.</div>
                    </div>
                `;
                if (badge) badge.style.display = 'none';
                return;
            }

            if (badge) {
                badge.textContent = opportunities.length;
                badge.style.display = 'inline';
            }

            // 기회 유형별 스타일
            const oppStyles = {
                'scale_up': { icon: '🚀', bg: '#e8f5e9', border: '#4caf50', titleColor: '#2e7d32', label: '예산 증액' },
                'hidden_gem': { icon: '💎', bg: '#e3f2fd', border: '#2196f3', titleColor: '#1565c0', label: '숨은 보석' },
                'growth_momentum': { icon: '📈', bg: '#fff3e0', border: '#ff9800', titleColor: '#e65100', label: '성장 모멘텀' },
                'default': { icon: '🎯', bg: '#e8f5e9', border: '#4caf50', titleColor: '#2e7d32', label: '기회' }
            };

            const html = opportunities.map((opp, idx) => {
                const style = oppStyles[opp.type] || oppStyles['default'];
                const hasAction = opp.action && opp.action.trim();
                const hasFinancial = opp.financial_impact && opp.financial_impact.trim();

                return `
                    <div style="
                        background: ${style.bg};
                        border: 2px solid ${style.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">${style.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${opp.title || '기회 요소 ' + (idx + 1)}</div>
                                ${opp.segment_value ? `<div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${opp.segment_type || ''} > ${opp.segment_value}</div>` : ''}
                            </div>
                            <span style="background: ${style.border}; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">${style.label}</span>
                        </div>
                        <!-- 메트릭스 배지 -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            ${opp.roas ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #a5d6a7;">ROAS ${opp.roas.toFixed(0)}%</span>` : ''}
                            ${opp.priority ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb;">우선순위 ${opp.priority}</span>` : ''}
                            ${opp.potential_uplift ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9;">+${(opp.potential_uplift/10000).toFixed(1)}만원</span>` : ''}
                        </div>
                        <!-- 메시지 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.5; margin-bottom: 10px;">
                            ${opp.message || ''}
                        </div>
                        <!-- 추천 액션 -->
                        ${hasAction ? `
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border}; margin-bottom: ${hasFinancial ? '8px' : '0'};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${opp.action}</div>
                        </div>
                        ` : ''}
                        <!-- 재무 영향 -->
                        ${hasFinancial ? `
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #673ab7;">
                            <div style="font-size: 10px; font-weight: 600; color: #5e35b1; margin-bottom: 4px;">💰 기대 효과</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${opp.financial_impact}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // 탭 배지 업데이트 (details)
        function updateInsightsBadges() {
            const periodData = getPeriodData();
            if (!periodData) return;

            // 경고 수 계산
            let totalAlerts = 0;
            if (periodData.details) {
                totalAlerts = (periodData.details.total_segment_alerts || 0) + (periodData.details.total_overall_alerts || 0);
            } else if (periodData.segments && periodData.segments.alerts) {
                totalAlerts = periodData.segments.alerts.length;
            }

            // 추천 수 계산
            let totalRecs = 0;
            if (periodData.details) {
                totalRecs = periodData.details.total_recommendations || 0;
            } else if (periodData.segments && periodData.segments.recommendations) {
                totalRecs = periodData.segments.recommendations.length;
            }

            // "경고 및 추천" 탭 배지 (경고 + 추천 합계)
            const alertsBadge = document.getElementById('alertsBadge');
            const alertsCountBadge = document.getElementById('alertsCountBadge');
            const totalAlertsAndRecs = totalAlerts + totalRecs;

            if (alertsBadge) {
                if (totalAlertsAndRecs > 0) {
                    alertsBadge.textContent = totalAlertsAndRecs;
                    alertsBadge.style.display = 'inline';
                    // 긴급 경고가 있으면 빨간색, 추천만 있으면 주황색
                    if (periodData.details && periodData.details.high_severity_alerts > 0) {
                        alertsBadge.style.background = '#ef5350';
                    } else if (totalAlerts > 0) {
                        alertsBadge.style.background = '#ff9800';
                    } else {
                        alertsBadge.style.background = '#7c4dff';  // 추천만 있을 때 보라색
                    }
                } else {
                    alertsBadge.style.display = 'none';
                }
            }

            if (alertsCountBadge) {
                alertsCountBadge.textContent = totalAlerts > 0 ? `(${totalAlerts}건)` : '';
            }

            // 추천 배지
            const recommendationsCountBadge = document.getElementById('recommendationsCountBadge');
            if (recommendationsCountBadge) {
                recommendationsCountBadge.textContent = totalRecs > 0 ? `(${totalRecs}건)` : '';
            }

            // Matrix 배지 업데이트
            const matrixBadge = document.getElementById('matrixBadge');
            if (matrixBadge && periodData.matrix_insights) {
                const matrixInsights = periodData.matrix_insights;
                let totalMatrix = 0;
                let hasCritical = false;
                ['brand', 'product', 'channel', 'promotion'].forEach(segment => {
                    const insights = matrixInsights[segment] || [];
                    totalMatrix += insights.length;
                    insights.forEach(i => {
                        if (i.severity === 'critical' || i.severity === 'high') hasCritical = true;
                    });
                });
                if (totalMatrix > 0) {
                    matrixBadge.textContent = totalMatrix;
                    matrixBadge.style.display = 'inline';
                    matrixBadge.style.background = hasCritical ? '#ef5350' : '#673ab7';
                } else {
                    matrixBadge.style.display = 'none';
                }
            }
        }

        // insights.json 데이터로 인사이트 업데이트
        function updateInsightsFromData() {
            const insightContainer = document.getElementById('insightContent');
            if (!insightContainer) {
                console.log('insightContent element not found - skipping updateInsightsFromData');
                return;
            }

            const periodData = getPeriodData();
            if (!periodData) {
                insightContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">데이터를 불러올 수 없습니다.</div>
                    </div>
                `;
                return;
            }

            // segment alerts + overall alerts 합치기
            const segmentAlerts = periodData.segments?.alerts || [];
            const overallAlerts = periodData.overall?.alerts || [];
            const allAlerts = [...segmentAlerts, ...overallAlerts];

            if (allAlerts.length === 0) {
                insightContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-title">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            모든 지표 정상
                        </div>
                        <div class="insight-text">현재 모든 주요 항목에서 특별한 경고 사항이 없습니다.</div>
                    </div>
                `;
                return;
            }

            const getAlertIcon = (type) => {
                const icons = {
                    'conversion_decline': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"/></svg>',
                    'roas_decline': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>',
                    'revenue_decline': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
                    'budget_alert': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>',
                    'default': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>'
                };
                return icons[type] || icons['default'];
            };

            const getAlertTitle = (alert) => {
                // overall alert는 title이 직접 있음
                if (alert.title) return alert.title;

                const titles = {
                    'conversion_decline': '전환수 감소 경고',
                    'roas_decline': 'ROAS 하락 경고',
                    'revenue_decline': '매출 감소 경고',
                    'budget_alert': '예산 경고'
                };
                return titles[alert.type] || '성과 변동 감지';
            };

            const getAlertText = (alert) => {
                // overall alert는 message가 직접 있음
                if (alert.message) return alert.message;

                const segmentTypeKr = {
                    'channel': '채널',
                    'product': '제품',
                    'brand': '브랜드'
                };
                return `${segmentTypeKr[alert.segment_type] || alert.segment_type} "${alert.segment_value}"의 ${alert.metric}이(가) ${Math.abs(alert.change_pct).toFixed(1)}% ${alert.change_pct < 0 ? '하락' : '상승'}할 것으로 예측됩니다.`;
            };

            const renderAlertCard = (alert) => {
                const severityColors = {
                    'high': { bg: '#ffebee', border: '#ef5350', titleColor: '#c62828' },
                    'medium': { bg: '#fff3e0', border: '#ff9800', titleColor: '#e65100' },
                    'low': { bg: '#e3f2fd', border: '#2196f3', titleColor: '#1565c0' }
                };
                const style = severityColors[alert.severity] || severityColors['medium'];
                const hasAction = alert.action && alert.action.trim();

                return `
                    <div style="
                        background: ${style.bg};
                        border: 2px solid ${style.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 16px;">${alert.severity === 'high' ? '🚨' : '⚠️'}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${getAlertTitle(alert)}</div>
                                ${alert.segment_value ? `<div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${alert.segment_type || ''} > ${alert.segment_value}</div>` : ''}
                            </div>
                            ${alert.severity === 'high' ? '<span style="background: #c62828; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600;">긴급</span>' : ''}
                        </div>
                        <!-- 메트릭스 배지 -->
                        ${alert.actual_roas !== undefined ? `
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #333; border: 1px solid ${style.border};">현재 ROAS ${alert.actual_roas?.toFixed(0) || 0}%</span>
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #c62828; border: 1px solid #ef9a9a;">예측 ROAS ${alert.forecast_roas?.toFixed(0) || 0}%</span>
                            ${alert.change_pct ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #c62828; border: 1px solid #ef9a9a;">변화 ${alert.change_pct > 0 ? '+' : ''}${alert.change_pct.toFixed(1)}%</span>` : ''}
                        </div>
                        ` : ''}
                        <!-- 메시지 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.5; margin-bottom: ${hasAction ? '10px' : '0'};">
                            ${getAlertText(alert)}
                        </div>
                        <!-- 추천 액션 -->
                        ${hasAction ? `
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${alert.action}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            };

            // 표시할 알림 결정
            const displayAlerts = alertsExpanded ? allAlerts : allAlerts.slice(0, INITIAL_ALERTS_COUNT);
            const hasMore = allAlerts.length > INITIAL_ALERTS_COUNT;
            const hiddenCount = allAlerts.length - INITIAL_ALERTS_COUNT;

            let html = displayAlerts.map(renderAlertCard).join('');

            // 더보기/접기 버튼 추가 (collapsible-toggle 스타일)
            if (hasMore) {
                html += `
                    <div style="text-align: center; margin-top: 16px;">
                        <button onclick="toggleAlerts()" class="collapsible-toggle" style="margin: 0 auto;">
                            <span>${alertsExpanded ? '접기' : `더보기 (+${hiddenCount}건)`}</span>
                            <span class="collapsible-toggle-icon ${alertsExpanded ? '' : 'collapsed'}">▼</span>
                        </button>
                    </div>
                `;
            }

            insightContainer.innerHTML = html;
        }

        // 경고 펼치기/접기 토글
        function toggleAlerts() {
            alertsExpanded = !alertsExpanded;
            updateInsightsFromData();
        }

        // 투자 추천 업데이트
        function updateRecommendations() {
            const recommendationContainer = document.getElementById('recommendationContent');

            if (!recommendationContainer) {
                console.error('recommendationContent element not found');
                return;
            }

            const periodData = getPeriodData();
            if (!periodData || !periodData.segments || !periodData.segments.recommendations) {
                console.log('Insights data not available yet');
                recommendationContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">데이터를 불러오는 중...</div>
                    </div>
                `;
                return;
            }

            const allRecommendations = periodData.segments.recommendations;

            if (allRecommendations.length === 0) {
                recommendationContainer.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text">현재 특별한 투자 추천 사항이 없습니다.</div>
                    </div>
                `;
                return;
            }

            const getTargetTypeKr = (type) => {
                const types = {
                    'channel': '채널',
                    'product': '제품',
                    'brand': '브랜드',
                    'promotion': '프로모션'
                };
                return types[type] || type;
            };

            const renderRecommendationCard = (rec) => {
                const priorityColors = {
                    1: { bg: '#e8f5e9', border: '#4caf50', titleColor: '#2e7d32', icon: '🥇' },
                    2: { bg: '#e3f2fd', border: '#2196f3', titleColor: '#1565c0', icon: '🥈' },
                    3: { bg: '#fff3e0', border: '#ff9800', titleColor: '#e65100', icon: '🥉' }
                };
                const style = priorityColors[rec.priority] || priorityColors[3];
                const metrics = rec.metrics || {};

                return `
                    <div style="
                        background: ${style.bg};
                        border: 2px solid ${style.border};
                        border-radius: 10px;
                        padding: 14px;
                        transition: transform 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">${style.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${rec.action}</div>
                                <div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${getTargetTypeKr(rec.target.type)} > ${rec.target.value}</div>
                            </div>
                            <span style="background: ${style.border}; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">우선순위 ${rec.priority}</span>
                        </div>
                        <!-- 메트릭스 배지 -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            ${metrics.roas ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #a5d6a7;">ROAS ${metrics.roas.toFixed(0)}%</span>` : ''}
                            ${metrics.cvr ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9;">CVR ${metrics.cvr.toFixed(2)}%</span>` : ''}
                            ${metrics.cpa ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb;">CPA ${(metrics.cpa/1000).toFixed(1)}천원</span>` : ''}
                        </div>
                        <!-- 이유 목록 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.6; margin-bottom: 10px;">
                            ${rec.reasons.map(reason => `<div style="display: flex; align-items: flex-start; gap: 6px;"><span style="color: ${style.border};">✓</span><span>${reason}</span></div>`).join('')}
                        </div>
                        <!-- 예상 효과 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">📈 예상 효과</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${rec.expected_impact}</div>
                        </div>
                    </div>
                `;
            };

            // 표시할 추천 결정
            const displayRecommendations = recommendationsExpanded
                ? allRecommendations
                : allRecommendations.slice(0, INITIAL_RECOMMENDATIONS_COUNT);
            const hasMore = allRecommendations.length > INITIAL_RECOMMENDATIONS_COUNT;
            const hiddenCount = allRecommendations.length - INITIAL_RECOMMENDATIONS_COUNT;

            let html = displayRecommendations.map(renderRecommendationCard).join('');

            // 더보기/접기 버튼 추가 (collapsible-toggle 스타일)
            if (hasMore) {
                html += `
                    <div style="text-align: center; margin-top: 16px; grid-column: 1 / -1;">
                        <button onclick="toggleRecommendations()" class="collapsible-toggle" style="margin: 0 auto;">
                            <span>${recommendationsExpanded ? '접기' : `더보기 (+${hiddenCount}건)`}</span>
                            <span class="collapsible-toggle-icon ${recommendationsExpanded ? '' : 'collapsed'}">▼</span>
                        </button>
                    </div>
                `;
            }

            recommendationContainer.innerHTML = html;
        }

        // 추천 펼치기/접기 토글
        function toggleRecommendations() {
            recommendationsExpanded = !recommendationsExpanded;
            updateRecommendations();
        }

        // 추천 카드 토글 함수
        function toggleRecommendationCard(card) {
            card.classList.toggle('expanded');
        }

        // ============================================================
        // Forecast Matrix 4분면 인사이트 렌더링 (v2.8)
        // ============================================================
        function renderMatrixInsights() {
            const periodData = getPeriodData();
            if (!periodData || !periodData.matrix_insights) {
                const noDataHtml = `
                    <div class="insight-card neutral">
                        <div class="insight-message" style="text-align: center; padding: 16px;">
                            <span style="font-size: 24px; display: block; margin-bottom: 8px;">📊</span>
                            <span style="color: var(--grey-600);">Matrix 인사이트가 없습니다.</span>
                        </div>
                    </div>
                `;
                ['Brand', 'Product', 'Channel', 'Promotion'].forEach(seg => {
                    const container = document.getElementById('matrix' + seg + 'Content');
                    const countBadge = document.getElementById('matrix' + seg + 'Count');
                    if (container) container.innerHTML = noDataHtml;
                    if (countBadge) countBadge.textContent = '';
                });
                return;
            }

            const matrixInsights = periodData.matrix_insights;

            // 4분면별 스타일 설정 (툴팁 설명 포함)
            const matrixStyles = {
                'super_star': {
                    icon: '🚀',
                    bg: '#e8f5e9',
                    border: '#4caf50',
                    titleColor: '#2e7d32',
                    label: 'Super Star',
                    tooltip: '고효율 + 고성장: 현재 ROAS가 높고 성장세도 좋습니다. 예산을 적극 증액하세요!'
                },
                'fading_hero': {
                    icon: '🛡️',
                    bg: '#fff3e0',
                    border: '#ff9800',
                    titleColor: '#e65100',
                    label: 'Fading Hero',
                    tooltip: '고효율 + 역성장: 효율은 좋지만 성장세가 둔화되고 있습니다. 현재 수익을 방어하세요.'
                },
                'rising_potential': {
                    icon: '🌱',
                    bg: '#e3f2fd',
                    border: '#2196f3',
                    titleColor: '#1565c0',
                    label: 'Rising Potential',
                    tooltip: '저효율 + 고성장: 효율은 낮지만 성장 잠재력이 있습니다. 최적화로 효율을 끌어올리세요.'
                },
                'problem_child': {
                    icon: '🗑️',
                    bg: '#ffebee',
                    border: '#ef5350',
                    titleColor: '#c62828',
                    label: 'Problem Child',
                    tooltip: '저효율 + 역성장: 효율도 낮고 성장세도 없습니다. 예산을 축소하거나 전략을 재검토하세요.'
                }
            };

            // severity별 추가 스타일
            const severityStyles = {
                'critical': { borderWidth: '3px', boxShadow: '0 0 8px rgba(239, 83, 80, 0.4)' },
                'high': { borderWidth: '2px', boxShadow: '0 0 4px rgba(239, 83, 80, 0.2)' },
                'warning': { borderWidth: '2px', boxShadow: 'none' },
                'opportunity': { borderWidth: '2px', boxShadow: '0 0 4px rgba(76, 175, 80, 0.2)' }
            };

            const renderMatrixCard = (insight) => {
                const style = matrixStyles[insight.sub_type] || matrixStyles['problem_child'];
                const sevStyle = severityStyles[insight.severity] || severityStyles['warning'];
                const metrics = insight.metrics || {};

                // ROAS 및 성장률 포맷팅 (필드명: current_roas, forecast_growth_pct, revenue_share_pct)
                const roas = metrics.current_roas || metrics.roas;
                const roasText = roas ? `ROAS ${roas.toLocaleString()}%` : '';
                const growthPct = metrics.forecast_growth_pct ?? metrics.forecast_growth_rate;
                const growthText = growthPct !== undefined && growthPct !== null
                    ? `예측 ${growthPct >= 0 ? '+' : ''}${growthPct.toFixed(1)}%`
                    : '';
                const revenueShare = metrics.revenue_share_pct ?? metrics.revenue_impact_share;
                const shareText = revenueShare !== undefined && revenueShare !== null
                    ? `매출비중 ${revenueShare.toFixed(1)}%`
                    : '';

                return `
                    <div class="matrix-card"
                        data-tooltip-icon="${style.icon}"
                        data-tooltip-label="${style.label}"
                        data-tooltip-desc="${style.tooltip}"
                        style="
                            background: ${style.bg};
                            border: ${sevStyle.borderWidth} solid ${style.border};
                            border-radius: 10px;
                            padding: 14px;
                            box-shadow: ${sevStyle.boxShadow};
                            transition: transform 0.2s, box-shadow 0.2s;
                            cursor: pointer;
                        ">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 18px;">${style.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.titleColor};">${insight.segment_value}</div>
                                <div style="font-size: 10px; color: ${style.titleColor}; opacity: 0.8;">${style.label}</div>
                            </div>
                            ${insight.severity === 'critical' ? '<span style="background: #c62828; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 600;">CORE RISK</span>' : ''}
                        </div>
                        <!-- 메트릭스 -->
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                            ${roasText ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #333; border: 1px solid ${style.border};">${roasText}</span>` : ''}
                            ${growthText ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: ${growthPct >= 0 ? '#2e7d32' : '#c62828'}; border: 1px solid ${growthPct >= 0 ? '#a5d6a7' : '#ef9a9a'};">${growthText}</span>` : ''}
                            ${shareText ? `<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb;">${shareText}</span>` : ''}
                        </div>
                        <!-- 메시지 -->
                        <div style="font-size: 11px; color: #555; line-height: 1.5; margin-bottom: 10px;">
                            ${insight.message}
                        </div>
                        <!-- 액션 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.border};">
                            <div style="font-size: 10px; font-weight: 600; color: ${style.titleColor}; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">${insight.action}</div>
                        </div>
                    </div>
                `;
            };

            // 각 세그먼트별 렌더링
            const segmentMap = {
                'brand': 'Brand',
                'product': 'Product',
                'channel': 'Channel',
                'promotion': 'Promotion'
            };

            Object.entries(segmentMap).forEach(([key, displayName]) => {
                const insights = matrixInsights[key] || [];
                const container = document.getElementById('matrix' + displayName + 'Content');
                const countBadge = document.getElementById('matrix' + displayName + 'Count');

                if (countBadge) {
                    countBadge.textContent = insights.length > 0 ? `(${insights.length}건)` : '';
                }

                if (!container) return;

                if (insights.length === 0) {
                    container.innerHTML = `
                        <div class="insight-card neutral" style="background: #f5f5f5; border: 1px dashed #ccc; text-align: center; padding: 20px;">
                            <div style="font-size: 24px; margin-bottom: 8px;">✨</div>
                            <div style="font-size: 12px; color: #666;">해당 세그먼트의 Matrix 인사이트가 없습니다.</div>
                        </div>
                    `;
                    return;
                }

                // severity 우선순위로 정렬 (critical > high > warning > opportunity)
                const severityOrder = { 'critical': 0, 'high': 1, 'warning': 2, 'opportunity': 3 };
                const sortedInsights = [...insights].sort((a, b) =>
                    (severityOrder[a.severity] || 4) - (severityOrder[b.severity] || 4)
                );

                container.innerHTML = sortedInsights.map(renderMatrixCard).join('');
            });

            // 툴팁 이벤트 설정
            setupMatrixCardTooltip();
        }

        // Matrix 카드 툴팁 이벤트 핸들러 (마우스 커서 따라가기)
        function setupMatrixCardTooltip() {
            const tooltip = document.getElementById('matrixCardTooltip');
            if (!tooltip) return;

            // 각 세그먼트 컨테이너에 이벤트 위임
            ['matrixBrandContent', 'matrixChannelContent', 'matrixProductContent', 'matrixPromotionContent'].forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;

                // 기존 이벤트 리스너 제거를 위해 클론
                const newContainer = container.cloneNode(true);
                container.parentNode.replaceChild(newContainer, container);

                // mouseenter 이벤트
                newContainer.addEventListener('mouseenter', function(event) {
                    const card = event.target.closest('.matrix-card');
                    if (!card) return;

                    const icon = card.dataset.tooltipIcon || '📊';
                    const label = card.dataset.tooltipLabel || 'Matrix';
                    const desc = card.dataset.tooltipDesc || '';

                    // 카드 스타일 변경
                    card.style.transform = 'translateY(-3px)';
                    card.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';

                    // 툴팁 내용 설정
                    tooltip.innerHTML = `
                        <div class="matrix-tooltip-header">
                            <span class="matrix-tooltip-icon">${icon}</span>
                            <div>
                                <div class="matrix-tooltip-title">${label}</div>
                                <div class="matrix-tooltip-subtitle">4분면 분류</div>
                            </div>
                        </div>
                        <div class="matrix-tooltip-content">${desc}</div>
                    `;

                    tooltip.classList.add('visible');
                }, true);

                // mousemove 이벤트 (커서 따라가기)
                newContainer.addEventListener('mousemove', function(event) {
                    const card = event.target.closest('.matrix-card');
                    if (!card || !tooltip.classList.contains('visible')) return;

                    const padding = 15;
                    let left = event.clientX + padding;
                    let top = event.clientY + padding;

                    // 툴팁 크기 가져오기
                    const tooltipRect = tooltip.getBoundingClientRect();

                    // 오른쪽 경계를 넘으면 왼쪽에 배치
                    if (left + tooltipRect.width + padding > window.innerWidth) {
                        left = event.clientX - tooltipRect.width - padding;
                    }

                    // 하단 경계를 넘으면 위로 조정
                    if (top + tooltipRect.height + padding > window.innerHeight) {
                        top = event.clientY - tooltipRect.height - padding;
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                }, true);

                // mouseleave 이벤트
                newContainer.addEventListener('mouseleave', function(event) {
                    const card = event.target.closest('.matrix-card');
                    if (!card) return;

                    // 카드 스타일 복원
                    card.style.transform = '';
                    card.style.boxShadow = '';

                    tooltip.classList.remove('visible');
                }, true);
            });
        }

        // 성과 트렌드 분석 업데이트 (7일/30일) - 항상 'full' 기간 데이터 사용
        function updatePerformanceTrends(improvementPeriod = '7d', declinePeriod = '7d') {
            // 성과 트렌드는 항상 전체 기간(full) 데이터 사용
            const fullPeriodData = insightsData?.by_period?.full || insightsData;

            // performance_trends 데이터가 없는 경우 빈 상태 표시
            if (!fullPeriodData || !fullPeriodData.performance_trends) {
                console.log('Performance trends data not available');
                const improvementContainer = document.getElementById('improvementTrendContent');
                const declineContainer = document.getElementById('declineTrendContent');

                const noDataHtml = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; color: var(--grey-500);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2v-2zm0-12h2v10h-2V5z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--grey-700);">데이터 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">성과 트렌드 데이터가 아직 생성되지 않았습니다.</p>
                        </div>
                    </div>
                `;

                if (improvementContainer) improvementContainer.innerHTML = noDataHtml;
                if (declineContainer) declineContainer.innerHTML = noDataHtml;
                return;
            }

            const trends = fullPeriodData.performance_trends;

            // 기간 표시 업데이트
            updateTrendPeriodIndicator(improvementPeriod);

            // 개선 항목 업데이트
            updateImprovementTrends(improvementPeriod, trends);

            // 하락 항목 업데이트
            updateDeclineTrends(declinePeriod, trends);
        }

        // 일반적인 추천 텍스트를 구체적인 액션으로 변환
        function transformRecommendationText(recommendation, metric) {
            // 일반적인 패턴들을 구체적인 액션으로 변환
            const transformations = {
                '비용': {
                    pattern: /마케팅 전략 점검이 필요합니다/,
                    replacement: '광고 예산 재분배를 고려해보세요. 성과가 낮은 채널의 예산을 줄이고, 효율이 좋은 채널로 예산을 이동시키는 것을 추천드립니다.'
                },
                '전환수': {
                    pattern: /마케팅 전략 점검이 필요합니다/,
                    replacement: '광고 소재나 타겟 주요 항목 조정이 필요합니다. 전환율이 낮은 캠페인의 타겟팅 설정을 검토하고, 잠재고객을 다시 정의해보시는 것을 추천드립니다.'
                },
                '전환값': {
                    pattern: /마케팅 전략 점검이 필요합니다/,
                    replacement: '고객 단가를 높이는 전략이 필요합니다. 프리미엄 제품 노출을 늘리거나, 교차 판매/업셀 전략을 강화해보시는 것을 추천드립니다.'
                },
                'ROAS': {
                    pattern: /광고 효율성 점검이 필요합니다/,
                    replacement: '광고 효율을 개선하기 위해 입찰 전략을 재검토하고, ROI가 낮은 키워드나 소재를 일시 중지하거나 최적화하는 것을 추천드립니다.'
                }
            };

            // 메트릭에 맞는 변환 규칙 찾기
            for (const [key, transform] of Object.entries(transformations)) {
                if (metric.includes(key) && transform.pattern.test(recommendation)) {
                    return recommendation.replace(transform.pattern, transform.replacement);
                }
            }

            return recommendation;
        }

        // 성과 트렌드 기간 표시 업데이트
        function updateTrendPeriodIndicator(period) {
            const indicator = document.getElementById('trendPeriodText');
            if (!indicator) return;

            // 실제 데이터의 마지막 날짜 기준으로 계산
            let lastDate = new Date();

            // dailyData에서 actual 데이터의 마지막 날짜 찾기
            if (window.dailyData && window.dailyData.length > 0) {
                const actualData = window.dailyData.filter(d => d.type === 'actual');
                if (actualData.length > 0) {
                    const lastDateStr = actualData[actualData.length - 1]['일 구분'] || actualData[actualData.length - 1].date;
                    if (lastDateStr) {
                        lastDate = new Date(lastDateStr);
                    }
                }
            }

            const formatDate = (date) => {
                const m = date.getMonth() + 1;
                const d = date.getDate();
                return `${m}/${d}`;
            };

            let recentStart, recentEnd, previousStart, previousEnd;

            if (period === '7d') {
                // 최근 7일: lastDate - 6일 ~ lastDate
                recentEnd = new Date(lastDate);
                recentStart = new Date(lastDate);
                recentStart.setDate(recentStart.getDate() - 6);

                // 이전 7일: lastDate - 13일 ~ lastDate - 7일
                previousEnd = new Date(lastDate);
                previousEnd.setDate(previousEnd.getDate() - 7);
                previousStart = new Date(lastDate);
                previousStart.setDate(previousStart.getDate() - 13);

                indicator.innerHTML = `
                    <strong style="color: #1565c0;">최근 7일</strong> (${formatDate(recentStart)}~${formatDate(recentEnd)}) vs
                    <strong style="color: #7b1fa2;">이전 7일</strong> (${formatDate(previousStart)}~${formatDate(previousEnd)})
                `;
            } else if (period === '14d') {
                // 최근 14일: lastDate - 13일 ~ lastDate
                recentEnd = new Date(lastDate);
                recentStart = new Date(lastDate);
                recentStart.setDate(recentStart.getDate() - 13);

                // 이전 14일: lastDate - 27일 ~ lastDate - 14일
                previousEnd = new Date(lastDate);
                previousEnd.setDate(previousEnd.getDate() - 14);
                previousStart = new Date(lastDate);
                previousStart.setDate(previousStart.getDate() - 27);

                indicator.innerHTML = `
                    <strong style="color: #1565c0;">최근 14일</strong> (${formatDate(recentStart)}~${formatDate(recentEnd)}) vs
                    <strong style="color: #7b1fa2;">이전 14일</strong> (${formatDate(previousStart)}~${formatDate(previousEnd)})
                `;
            } else {
                // 최근 30일: lastDate - 29일 ~ lastDate
                recentEnd = new Date(lastDate);
                recentStart = new Date(lastDate);
                recentStart.setDate(recentStart.getDate() - 29);

                // 이전 30일: lastDate - 59일 ~ lastDate - 30일
                previousEnd = new Date(lastDate);
                previousEnd.setDate(previousEnd.getDate() - 30);
                previousStart = new Date(lastDate);
                previousStart.setDate(previousStart.getDate() - 59);

                indicator.innerHTML = `
                    <strong style="color: #1565c0;">최근 30일</strong> (${formatDate(recentStart)}~${formatDate(recentEnd)}) vs
                    <strong style="color: #7b1fa2;">이전 30일</strong> (${formatDate(previousStart)}~${formatDate(previousEnd)})
                `;
            }
        }

        // 개선 트렌드 업데이트
        function updateImprovementTrends(period, trends) {
            const container = document.getElementById('improvementTrendContent');
            if (!container) return;

            const dataKeyMap = { '7d': 'improvements_7d', '14d': 'improvements_14d', '30d': 'improvements_30d' };
            const periodTextMap = { '7d': '최근 7일 vs 이전 7일', '14d': '최근 14일 vs 이전 14일', '30d': '최근 30일 vs 이전 30일' };
            const dataKey = dataKeyMap[period] || 'improvements_7d';
            const improvements = trends[dataKey] || [];
            const periodText = periodTextMap[period] || '최근 7일 vs 이전 7일';

            if (improvements.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; color: var(--grey-500);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2v-2zm0-12h2v10h-2V5z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--grey-700);">개선 사항 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">현재 기간에 유의미한 성과 개선이 감지되지 않았습니다.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${improvements.map(item => `
                        <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">📈</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: #2e7d32;">${item.metric}</div>
                                    <div style="font-size: 10px; color: #2e7d32; opacity: 0.8;">${periodText}</div>
                                </div>
                                <span style="background: #4caf50; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">+${item.change_pct}% ${item.improvement_level === 'high' ? '높음' : '중간'}</span>
                            </div>
                            <!-- 메트릭스 배지 -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">최근 ${formatNumber(item.recent_avg)}</span>
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">이전 ${formatNumber(item.previous_avg)}</span>
                            </div>
                            <!-- 추천 액션 -->
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #4caf50;">
                                <div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 4px;">💡 추천 액션</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${transformRecommendationText(item.recommendation, item.metric)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 하락 트렌드 업데이트
        function updateDeclineTrends(period, trends) {
            const container = document.getElementById('declineTrendContent');
            if (!container) return;

            const dataKeyMap = { '7d': 'declines_7d', '14d': 'declines_14d', '30d': 'declines_30d' };
            const periodTextMap = { '7d': '최근 7일 vs 이전 7일', '14d': '최근 14일 vs 이전 14일', '30d': '최근 30일 vs 이전 30일' };
            const dataKey = dataKeyMap[period] || 'declines_7d';
            const declines = trends[dataKey] || [];
            const periodText = periodTextMap[period] || '최근 7일 vs 이전 7일';

            if (declines.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; color: var(--success-main);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--success-main);">하락 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">모든 지표가 안정적이거나 개선되고 있습니다.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${declines.map(item => {
                        const isHigh = item.risk_level === 'high';
                        const bgColor = isHigh ? '#ffebee' : '#fff3e0';
                        const borderColor = isHigh ? '#f44336' : '#ff9800';
                        const textColor = isHigh ? '#c62828' : '#e65100';
                        const badgeColor = isHigh ? '#f44336' : '#ff9800';
                        return `
                        <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">📉</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: ${textColor};">${item.metric}</div>
                                    <div style="font-size: 10px; color: ${textColor}; opacity: 0.8;">${periodText}</div>
                                </div>
                                <span style="background: ${badgeColor}; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">${item.change_pct}% ${isHigh ? '높음' : '중간'}</span>
                            </div>
                            <!-- 메트릭스 배지 -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">최근 ${formatNumber(item.recent_avg)}</span>
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">이전 ${formatNumber(item.previous_avg)}</span>
                            </div>
                            <!-- 추천 액션 -->
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${borderColor};">
                                <div style="font-size: 10px; font-weight: 600; color: ${textColor}; margin-bottom: 4px;">⚠️ 주의 필요</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${transformRecommendationText(item.recommendation, item.metric)}</div>
                            </div>
                        </div>
                    `;}).join('')}
                </div>
            `;
        }

        // 차트 업데이트
        function updateChart() {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            if (forecastChart) {
                forecastChart.destroy();
            }

            const labels = forecastData.map(d => d['일 구분']);

            const showCost = document.getElementById('chartCost').checked;
            const showImpressions = document.getElementById('chartImpressions').checked;
            const showClicks = document.getElementById('chartClicks').checked;
            const showConversions = document.getElementById('chartConversions').checked;
            const showValue = document.getElementById('chartValue').checked;

            // 실제/예측 구분 인덱스 찾기
            const lastActualIndex = forecastData.findIndex(d => d.type === 'forecast' || d.type === 'mixed') - 1;

            // 데이터셋을 실제값과 예측값으로 분리하는 함수
            function createSplitDatasets(label, data, color, yAxisID) {
                const actualData = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'actual' || type === 'mixed') ? val : null;
                });
                const forecastDataArr = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'forecast' || type === 'mixed') ? val : null;
                });

                // 연결을 위해 마지막 실제값을 예측 데이터의 시작점에 추가
                if (lastActualIndex >= 0 && lastActualIndex < data.length - 1) {
                    forecastDataArr[lastActualIndex] = data[lastActualIndex];
                }

                const datasets = [];

                // 실제값 데이터셋 (실선)
                datasets.push({
                    label: label,
                    data: actualData,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    pointRadius: 3,
                    pointStyle: 'circle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                // 예측값 데이터셋 (점선)
                datasets.push({
                    label: label + ' (예측)',
                    data: forecastDataArr,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.05)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    borderDash: [6, 4],
                    pointRadius: 4,
                    pointStyle: 'triangle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                return datasets;
            }

            const datasets = [];

            // Y축 결정 로직: 비용/전환값은 금액(왼쪽), 노출/클릭/전환수는 수량(오른쪽)
            // 단, 금액 지표가 없으면 수량 지표가 왼쪽 축 사용
            const hasAmountMetric = showCost || showValue;

            if (showCost) {
                const data = forecastData.map(d => parseFloat(d['비용_예측']) || 0);
                datasets.push(...createSplitDatasets('비용', data, '#673ab7', 'y'));
            }

            if (showImpressions) {
                const data = forecastData.map(d => parseFloat(d['노출_예측']) || 0);
                datasets.push(...createSplitDatasets('노출', data, '#2196f3', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showClicks) {
                const data = forecastData.map(d => parseFloat(d['클릭_예측']) || 0);
                datasets.push(...createSplitDatasets('클릭', data, '#ff9800', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showConversions) {
                const data = forecastData.map(d => parseFloat(d['전환수_예측']) || 0);
                datasets.push(...createSplitDatasets('전환수', data, '#4caf50', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showValue) {
                const data = forecastData.map(d => parseFloat(d['전환값_예측']) || 0);
                datasets.push(...createSplitDatasets('전환값', data, '#00c853', 'y'));
            }

            // 오른쪽 축 표시 여부
            const showRightAxis = hasAmountMetric && (showImpressions || showClicks || showConversions);

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                filter: function(item) {
                                    // 예측 데이터셋은 범례에서 숨김
                                    return !item.text.includes('(예측)');
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    // (예측) 접미사 제거
                                    label = label.replace(' (예측)', '');
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatNumber(context.parsed.y);

                                    // 예측값 여부 표시
                                    const dataIndex = context.dataIndex;
                                    const type = forecastData[dataIndex].type;
                                    if (type === 'forecast' || (type === 'mixed' && context.dataset.borderDash)) {
                                        label += ' (예측)';
                                    }
                                    return label;
                                }
                            }
                        },
                        annotation: {
                            annotations: lastActualIndex >= 0 ? {
                                line1: {
                                    type: 'line',
                                    xMin: lastActualIndex + 0.5,
                                    xMax: lastActualIndex + 0.5,
                                    borderColor: 'rgba(103, 58, 183, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '예측 시작',
                                        position: 'start'
                                    }
                                }
                            } : {}
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: hasAmountMetric ? '금액 (원)' : '수량'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: showRightAxis,
                            position: 'right',
                            title: {
                                display: true,
                                text: '수량'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 세그먼트 트렌드 내 전체 성과 예측 차트 업데이트
        function updateOverallForecastChart() {
            const canvas = document.getElementById('forecastChartTrend');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            if (forecastChartTrend) {
                forecastChartTrend.destroy();
            }

            if (!forecastData || forecastData.length === 0) return;

            const labels = forecastData.map(d => d['일 구분']);

            const showCost = document.getElementById('chartCostTrend')?.checked;
            const showCPM = document.getElementById('chartCPMTrend')?.checked;
            const showCPC = document.getElementById('chartCPCTrend')?.checked;
            const showCPA = document.getElementById('chartCPATrend')?.checked;
            const showROAS = document.getElementById('chartROASTrend')?.checked;

            // 실제/예측 구분 인덱스 찾기
            const lastActualIndex = forecastData.findIndex(d => d.type === 'forecast' || d.type === 'mixed') - 1;

            // 데이터셋을 실제값과 예측값으로 분리하는 함수
            function createSplitDatasets(label, data, color, yAxisID) {
                const actualData = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'actual' || type === 'mixed') ? val : null;
                });
                const forecastDataArr = data.map((val, idx) => {
                    const type = forecastData[idx].type;
                    return (type === 'forecast' || type === 'mixed') ? val : null;
                });

                if (lastActualIndex >= 0 && lastActualIndex < data.length - 1) {
                    forecastDataArr[lastActualIndex] = data[lastActualIndex];
                }

                const datasets = [];

                datasets.push({
                    label: label,
                    data: actualData,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    pointRadius: 3,
                    pointStyle: 'circle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                datasets.push({
                    label: label + ' (예측)',
                    data: forecastDataArr,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.05)').replace('rgb', 'rgba'),
                    borderWidth: 2,
                    borderDash: [6, 4],
                    pointRadius: 4,
                    pointStyle: 'triangle',
                    yAxisID: yAxisID,
                    fill: false,
                    tension: 0.4,
                    spanGaps: false
                });

                return datasets;
            }

            const datasets = [];
            // 비용은 금액(원), 나머지는 효율 지표
            const hasAmountMetric = showCost;
            const hasEfficiencyMetric = showCPM || showCPC || showCPA || showROAS;

            if (showCost) {
                const data = forecastData.map(d => parseFloat(d['비용_예측']) || 0);
                datasets.push(...createSplitDatasets('비용', data, '#673ab7', 'y'));
            }

            if (showCPM) {
                // CPM = 비용 / 노출 * 1000
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const impressions = parseFloat(d['노출_예측']) || 0;
                    return impressions > 0 ? (cost / impressions * 1000) : 0;
                });
                datasets.push(...createSplitDatasets('CPM', data, '#ffab00', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showCPC) {
                // CPC = 비용 / 클릭
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const clicks = parseFloat(d['클릭_예측']) || 0;
                    return clicks > 0 ? (cost / clicks) : 0;
                });
                datasets.push(...createSplitDatasets('CPC', data, '#2196f3', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showCPA) {
                // CPA = 비용 / 전환수
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const conversions = parseFloat(d['전환수_예측']) || 0;
                    return conversions > 0 ? (cost / conversions) : 0;
                });
                datasets.push(...createSplitDatasets('CPA', data, '#ff9800', hasAmountMetric ? 'y1' : 'y'));
            }

            if (showROAS) {
                // ROAS = 전환값 / 비용 * 100 (%)
                const data = forecastData.map(d => {
                    const cost = parseFloat(d['비용_예측']) || 0;
                    const value = parseFloat(d['전환값_예측']) || 0;
                    return cost > 0 ? (value / cost * 100) : 0;
                });
                datasets.push(...createSplitDatasets('ROAS', data, '#00c853', hasAmountMetric ? 'y1' : 'y'));
            }

            const showRightAxis = hasAmountMetric && hasEfficiencyMetric;

            forecastChartTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                filter: function(item) {
                                    return !item.text.includes('(예측)');
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    const baseLabel = label.replace(' (예측)', '');
                                    let formattedValue = '';

                                    // KPI별 포맷 적용
                                    if (baseLabel === 'ROAS') {
                                        formattedValue = context.parsed.y.toFixed(1) + '%';
                                    } else if (baseLabel === '비용' || baseLabel === 'CPA') {
                                        formattedValue = formatNumber(context.parsed.y) + '원';
                                    } else if (baseLabel === 'CPM' || baseLabel === 'CPC') {
                                        formattedValue = formatNumber(Math.round(context.parsed.y)) + '원';
                                    } else {
                                        formattedValue = formatNumber(context.parsed.y);
                                    }

                                    let result = baseLabel + ': ' + formattedValue;

                                    const dataIndex = context.dataIndex;
                                    const type = forecastData[dataIndex]?.type;
                                    if (type === 'forecast') {
                                        result += ' (예측)';
                                    }
                                    return result;
                                }
                            }
                        },
                        annotation: {
                            annotations: lastActualIndex >= 0 ? {
                                line1: {
                                    type: 'line',
                                    xMin: lastActualIndex + 0.5,
                                    xMax: lastActualIndex + 0.5,
                                    borderColor: 'rgba(103, 58, 183, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: '예측 시작',
                                        position: 'start'
                                    }
                                }
                            } : {}
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: hasAmountMetric ? '비용 (원)' : '효율 지표'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: showRightAxis,
                            position: 'right',
                            title: {
                                display: true,
                                text: '효율 지표'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadInsightsAndSegments();
            loadSegmentData();

            // 뷰 타입 버튼 이벤트 (일별/주별/월별)
            document.querySelectorAll('.view-type-section .view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 부모의 view-btn만 토글
                    const parent = this.closest('.view-type-section');
                    parent.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    if (this.dataset.view) {
                        currentView = this.dataset.view;
                        loadData();
                    }
                });
            });

            // KPI 주요/세부 성과 토글 버튼
            document.querySelectorAll('.kpi-view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // 버튼 활성화 토글
                    document.querySelectorAll('.kpi-view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // kpi-section에 show-all 토글
                    const kpiSection = document.getElementById('kpiSectionContainer');
                    if (kpiSection) {
                        if (btn.dataset.kpiView === 'all') {
                            kpiSection.classList.add('show-all');
                        } else {
                            kpiSection.classList.remove('show-all');
                        }
                    }
                });
            });

            // 차트 체크박스 이벤트
            document.querySelectorAll('.chart-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', updateChart);
            });

            // 세그먼트 트렌드 전체 성과 예측 차트 체크박스 이벤트
            ['chartCostTrend', 'chartImpressionsTrend', 'chartClicksTrend', 'chartConversionsTrend', 'chartValueTrend'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', updateOverallForecastChart);
                }
            });

            // 세그먼트 트렌드 전체 성과 예측 차트 토글 버튼 이벤트
            document.querySelectorAll('.chart-toggle-group .data-label-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const checkboxId = this.dataset.chartToggle;
                    const checkbox = document.getElementById(checkboxId);
                    const toggleCheckbox = this.querySelector('.toggle-checkbox');

                    if (checkbox) {
                        // 체크박스 토글
                        checkbox.checked = !checkbox.checked;

                        // 버튼 스타일 및 아이콘 업데이트
                        if (checkbox.checked) {
                            this.classList.add('active');
                            toggleCheckbox.textContent = '✓';
                        } else {
                            this.classList.remove('active');
                            toggleCheckbox.textContent = '☐';
                        }

                        // 차트 업데이트
                        updateOverallForecastChart();
                    }
                });
            });

            // 성과 트렌드 기간 전환 (7일/14일/30일)
            document.querySelectorAll('.trend-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.dataset.trendPeriod;

                    // 버튼 스타일 업데이트
                    document.querySelectorAll('.trend-period-btn').forEach(b => {
                        if (b.dataset.trendPeriod === period) {
                            b.classList.add('active');
                            b.style.background = '#673ab7';
                            b.style.color = 'white';
                            b.style.borderColor = '#673ab7';
                        } else {
                            b.classList.remove('active');
                            b.style.background = 'white';
                            b.style.color = '#495057';
                            b.style.borderColor = '#dee2e6';
                        }
                    });

                    // 기간 표시 업데이트
                    updateTrendPeriodIndicator(period);

                    // 개선/하락 트렌드 모두 업데이트
                    const periodData = getPeriodData();
                    if (periodData && periodData.performance_trends) {
                        updateImprovementTrends(period, periodData.performance_trends);
                        updateDeclineTrends(period, periodData.performance_trends);
                    }
                });
            });

            // 인사이트 탭 전환 이벤트 (통합 인사이트 대시보드)
            document.querySelectorAll('.insights-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.insights-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.insightsTab;
                    document.querySelectorAll('.insights-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 탭 표시
                    if (targetTab === 'summary') {
                        document.getElementById('summaryTab').style.display = 'block';
                    } else if (targetTab === 'alerts') {
                        document.getElementById('alertsTab').style.display = 'block';
                    } else if (targetTab === 'opportunities') {
                        document.getElementById('opportunitiesTab').style.display = 'block';
                    } else if (targetTab === 'matrix') {
                        document.getElementById('matrixTab').style.display = 'block';
                        // Matrix 탭 렌더링
                        if (typeof renderMatrixInsights === 'function') {
                            renderMatrixInsights();
                        }
                    }
                });
            });

            // Matrix 하위탭 전환 이벤트
            document.querySelectorAll('.matrix-sub-tab').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.matrix-sub-tab').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = '#666';
                    });
                    this.classList.add('active');
                    this.style.background = '#673ab7';
                    this.style.color = 'white';

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.matrixTab;
                    document.querySelectorAll('.matrix-sub-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 탭 표시
                    const tabMap = {
                        'brand': 'matrixBrandTab',
                        'channel': 'matrixChannelTab',
                        'product': 'matrixProductTab',
                        'promotion': 'matrixPromotionTab'
                    };
                    const targetElement = document.getElementById(tabMap[targetTab]);
                    if (targetElement) {
                        targetElement.style.display = 'block';
                    }
                });
            });

            // 분석 탭 전환 이벤트 (성과 분석 대시보드)
            document.querySelectorAll('.analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 탭 표시
                    if (targetTab === 'forecast') {
                        document.getElementById('forecastTab').style.display = 'block';
                    } else if (targetTab === 'budget-simulation') {
                        document.getElementById('budgetSimulationMainTab').style.display = 'block';
                        // 시뮬레이션 초기화 (탭 전환 시)
                        if (typeof initSimulation === 'function') {
                            initSimulation();
                        }
                    } else if (targetTab === 'segment-trend') {
                        document.getElementById('segmentTrendTab').style.display = 'block';
                    }
                });
            });

            // 통계 분석 서브 탭 전환 이벤트
            document.querySelectorAll('.statistics-subtab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 활성화 상태 전환
                    document.querySelectorAll('.statistics-subtab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    const targetTab = this.dataset.statisticsTab;
                    document.querySelectorAll('.statistics-subtab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 선택된 서브 탭 표시
                    if (targetTab === 'forecast-trend') {
                        document.getElementById('forecastTrendTab').style.display = 'block';
                    } else if (targetTab === 'correlation-quality') {
                        document.getElementById('correlationQualityTab').style.display = 'block';
                    }
                });
            });

            // 세그먼트 트렌드 타입 버튼 이벤트
            document.querySelectorAll('.segment-trend-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.segment-trend-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTrendSegmentType = this.dataset.segment;

                    // 전체 vs 세그먼트별 콘텐츠 전환
                    const overallContent = document.getElementById('segmentTrendOverallContent');
                    const segmentContent = document.getElementById('segmentTrendSegmentContent');

                    if (currentTrendSegmentType === 'overall') {
                        overallContent.style.display = 'block';
                        segmentContent.style.display = 'none';
                        updateOverallForecastChart();
                    } else {
                        overallContent.style.display = 'none';
                        segmentContent.style.display = 'block';
                        updateSegmentTrendCheckboxes();
                    }
                });
            });

            // 세그먼트 트렌드 드롭다운 토글 이벤트
            const segmentTrendDropdownBtn = document.getElementById('segmentTrendDropdownBtn');
            const segmentTrendDropdownList = document.getElementById('segmentTrendDropdownList');

            if (segmentTrendDropdownBtn && segmentTrendDropdownList) {
                segmentTrendDropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = segmentTrendDropdownList.style.display === 'block';
                    segmentTrendDropdownList.style.display = isOpen ? 'none' : 'block';
                });

                // 드롭다운 외부 클릭 시 닫기
                document.addEventListener('click', function(e) {
                    if (!segmentTrendDropdownBtn.contains(e.target) && !segmentTrendDropdownList.contains(e.target)) {
                        segmentTrendDropdownList.style.display = 'none';
                    }
                });
            }

            // 세그먼트 트렌드 전체 선택 이벤트
            const segmentTrendSelectAll = document.getElementById('segmentTrendSelectAll');
            if (segmentTrendSelectAll) {
                segmentTrendSelectAll.addEventListener('change', function() {
                    const allCheckboxes = document.querySelectorAll('.segment-trend-checkbox');
                    const maxSelect = Math.min(5, allCheckboxes.length);

                    if (this.checked) {
                        // 최대 5개까지만 선택
                        allCheckboxes.forEach((cb, index) => {
                            cb.checked = index < maxSelect;
                        });
                    } else {
                        // 전체 해제
                        allCheckboxes.forEach(cb => {
                            cb.checked = false;
                        });
                    }

                    updateSegmentTrendDropdownLabel();
                    updateSegmentTrendChart();
                });
            }

            // 세그먼트 트렌드 뷰 타입 버튼 이벤트 (일별/주별/월별)
            document.querySelectorAll('.segment-trend-view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.segment-trend-view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    segmentTrendViewType = this.dataset.view;

                    // 전체 성과 예측 데이터도 갱신 (currentView 변경 및 데이터 로드)
                    currentView = this.dataset.view;
                    loadData();

                    // 현재 선택된 하위탭에 따라 차트 업데이트
                    if (currentTrendSegmentType === 'overall') {
                        // forecastData가 loadData에서 비동기로 갱신되므로 약간의 지연 후 업데이트
                        setTimeout(() => updateOverallForecastChart(), 100);
                    } else {
                        updateSegmentTrendChart();
                    }
                });
            });

            // 세그먼트 트렌드 지표 선택 이벤트
            const segmentTrendMetricDropdown = document.getElementById('segmentTrendMetricDropdown');
            if (segmentTrendMetricDropdown) {
                segmentTrendMetricDropdown.addEventListener('change', function() {
                    segmentTrendMetric = this.value;
                    updateSegmentTrendChart();
                });
            }

            // 세그먼트 트렌드 기간 선택 이벤트
            const segmentTrendStartDateInput = document.getElementById('segmentTrendStartDate');
            const segmentTrendEndDateInput = document.getElementById('segmentTrendEndDate');

            if (segmentTrendStartDateInput) {
                segmentTrendStartDateInput.addEventListener('change', function() {
                    segmentTrendStartDate = this.value;
                    updateSegmentTrendChart();
                });
            }

            if (segmentTrendEndDateInput) {
                segmentTrendEndDateInput.addEventListener('change', function() {
                    segmentTrendEndDate = this.value;
                    updateSegmentTrendChart();
                });
            }

            // 세그먼트 트렌드 기간 초기값 설정
            initSegmentTrendDateRange();

            // 접기/펼치기 이벤트 초기화
            initCollapsibles();
        });

        // 접기/펼치기 기능
        function initCollapsibles() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', function() {
                    const section = this.parentElement;
                    const content = section.querySelector('.collapsible-content');
                    const toggleBtn = section.querySelector('.collapsible-toggle');
                    const toggleIcon = section.querySelector('.collapsible-toggle-icon');
                    const toggleText = toggleBtn.querySelector('span');

                    if (content.classList.contains('expanded')) {
                        // 접기
                        content.classList.remove('expanded');
                        toggleIcon.classList.add('collapsed');
                        toggleText.textContent = '펼치기';
                    } else {
                        // 펼치기
                        content.classList.add('expanded');
                        toggleIcon.classList.remove('collapsed');
                        toggleText.textContent = '접기';

                        // 성과 분석 대시보드 섹션이 펼쳐질 때 차트 업데이트
                        if (content.querySelector('#segmentTrendTab')) {
                            setTimeout(() => {
                                if (currentTrendSegmentType === 'overall') {
                                    updateOverallForecastChart();
                                } else {
                                    updateSegmentTrendChart();
                                }
                            }, 50);
                        }
                    }
                });
            });
        }

        // =====================================================
        // 예산 시나리오 시뮬레이션 모듈
        // =====================================================

        // 시뮬레이션 상태 변수
        let currentSimSegmentType = 'all';
        let simulationData = {};
        let budgetAdjustments = {};
        const DIMINISHING_FACTOR = 0.15; // 체감 수익 계수

        // 통화 포맷
        function formatSimCurrency(value) {
            if (value >= 100000000) {
                return (value / 100000000).toFixed(1) + '억';
            } else if (value >= 10000000) {
                return (value / 10000).toFixed(0) + '만';
            } else if (value >= 10000) {
                return (value / 10000).toFixed(1) + '만';
            }
            return value.toLocaleString() + '원';
        }

        // 시뮬레이션 초기화
        function initSimulation() {
            loadSimulationData();
            renderSimulationSliders();
            updateSimulationResults();
            bindSimulationEvents();
        }

        // 호환성을 위한 별칭
        const initBudgetSimulation = initSimulation;

        // 세그먼트 데이터 로드
        function loadSimulationData() {
            simulationData = {};

            // '전체' 선택 시 모든 데이터를 하나로 통합
            if (currentSimSegmentType === 'all') {
                simulationData['전체'] = {
                    cost: 0,
                    revenue: 0,
                    conversions: 0,
                    clicks: 0
                };

                // 채널 데이터 기준으로 전체 집계 (중복 방지)
                const data = segmentData['channel'];
                if (data && data.length > 0) {
                    data.forEach(row => {
                        if (row.type !== 'actual') return;
                        simulationData['전체'].cost += parseFloat(row['비용_예측']) || 0;
                        simulationData['전체'].revenue += parseFloat(row['전환값_예측']) || 0;
                        simulationData['전체'].conversions += parseFloat(row['전환수_예측']) || 0;
                        simulationData['전체'].clicks += parseFloat(row['클릭_예측']) || 0;
                    });
                }
            } else {
                const data = segmentData[currentSimSegmentType];
                if (!data || data.length === 0) return;

                // 실제 데이터만 집계
                data.forEach(row => {
                    if (row.type !== 'actual') return;

                    const segmentName = row[currentSimSegmentType] || row.channel || row.product || row.brand || row.promotion;
                    if (!segmentName) return;

                    if (!simulationData[segmentName]) {
                        simulationData[segmentName] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            clicks: 0
                        };
                    }

                    simulationData[segmentName].cost += parseFloat(row['비용_예측']) || 0;
                    simulationData[segmentName].revenue += parseFloat(row['전환값_예측']) || 0;
                    simulationData[segmentName].conversions += parseFloat(row['전환수_예측']) || 0;
                    simulationData[segmentName].clicks += parseFloat(row['클릭_예측']) || 0;
                });
            }

            // ROAS 계산 및 초기 조정값 설정
            Object.keys(simulationData).forEach(segment => {
                const seg = simulationData[segment];
                seg.roas = seg.cost > 0 ? (seg.revenue / seg.cost * 100) : 0;
                seg.cvr = seg.clicks > 0 ? (seg.conversions / seg.clicks * 100) : 0;
                budgetAdjustments[segment] = 0; // 초기값 0%
            });

            // 체크박스 렌더링
            renderSimItemCheckboxes();
        }

        // 시뮬레이션 항목 선택 체크박스 렌더링
        function renderSimItemCheckboxes() {
            const container = document.getElementById('simItemCheckboxes');
            if (!container) return;

            const segments = Object.keys(simulationData).sort((a, b) => {
                return simulationData[b].cost - simulationData[a].cost;
            });

            if (segments.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: var(--grey-500); font-size: 12px;">항목이 없습니다.</div>';
                return;
            }

            container.innerHTML = segments.map((segment, index) => {
                const seg = simulationData[segment];
                return `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="sim-item-checkbox" data-segment="${segment}" ${index < segments.length ? 'checked' : ''} style="margin-right: 10px; width: 14px; height: 14px; cursor: pointer;">
                        <span>${segment}</span>
                        <span style="margin-left: auto; font-size: 10px; color: var(--grey-500);">${formatSimCurrency(seg.cost)}</span>
                    </label>
                `;
            }).join('');

            // 체크박스 이벤트 바인딩
            container.querySelectorAll('.sim-item-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    updateSimItemDropdownLabel();
                    updateSimItemSelectAllState();
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            });

            updateSimItemDropdownLabel();
            updateSimItemSelectAllState();
        }

        // 시뮬레이션 항목 드롭다운 라벨 업데이트
        function updateSimItemDropdownLabel() {
            const checkedBoxes = document.querySelectorAll('.sim-item-checkbox:checked');
            const labelEl = document.getElementById('simItemDropdownLabel');
            const countEl = document.getElementById('simItemSelectedCount');
            const countEl2 = document.getElementById('simSelectedItemCount');

            if (labelEl) {
                if (checkedBoxes.length === 0) {
                    labelEl.textContent = '항목을 선택하세요';
                } else if (checkedBoxes.length === 1) {
                    labelEl.textContent = checkedBoxes[0].dataset.segment;
                } else {
                    labelEl.textContent = `${checkedBoxes[0].dataset.segment} 외 ${checkedBoxes.length - 1}개`;
                }
            }

            if (countEl) {
                countEl.textContent = checkedBoxes.length > 0 ? `${checkedBoxes.length}개` : '';
            }

            if (countEl2) {
                countEl2.textContent = checkedBoxes.length > 0 ? `(${checkedBoxes.length}개 선택됨)` : '';
            }
        }

        // 시뮬레이션 항목 전체선택 상태 업데이트
        function updateSimItemSelectAllState() {
            const allCheckboxes = document.querySelectorAll('.sim-item-checkbox');
            const checkedBoxes = document.querySelectorAll('.sim-item-checkbox:checked');
            const selectAllCb = document.getElementById('simItemSelectAll');

            if (selectAllCb) {
                selectAllCb.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedBoxes.length;
                selectAllCb.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
            }
        }

        // 선택된 시뮬레이션 항목 가져오기
        function getSelectedSimItems() {
            const checkedBoxes = document.querySelectorAll('.sim-item-checkbox:checked');
            return Array.from(checkedBoxes).map(cb => cb.dataset.segment);
        }

        // 슬라이더 렌더링
        function renderSimulationSliders() {
            const container = document.getElementById('simulationSlidersContainer');
            if (!container) return;

            // 선택된 항목만 필터링
            const selectedItems = getSelectedSimItems();
            const segments = Object.keys(simulationData)
                .filter(seg => selectedItems.length === 0 || selectedItems.includes(seg))
                .sort((a, b) => simulationData[b].cost - simulationData[a].cost);

            if (segments.length === 0) {
                container.innerHTML = '<div style="color: var(--grey-600); text-align: center; padding: 20px;">표시할 항목을 선택하세요.</div>';
                return;
            }

            container.innerHTML = segments.map(segment => {
                const seg = simulationData[segment];
                const currentAdjust = budgetAdjustments[segment] || 0;
                const roasLevel = seg.roas >= 150 ? 'high' : seg.roas >= 50 ? 'medium' : 'low';
                const fillPercent = ((currentAdjust - (-30)) / (50 - (-30))) * 100;
                const newBudget = seg.cost * (1 + currentAdjust / 100);

                return `
                    <div class="sim-slider-group" data-segment="${segment}">
                        <div class="sim-slider-header">
                            <div class="sim-segment-info">
                                <div class="sim-segment-badge ${roasLevel}">${roasLevel === 'high' ? '고효율' : roasLevel === 'medium' ? '중효율' : '저효율'}</div>
                                <span class="sim-segment-name">${segment}</span>
                            </div>
                            <div class="sim-segment-metrics">
                                <span class="sim-roas-badge ${roasLevel}">ROAS ${seg.roas.toFixed(0)}%</span>
                                <span class="sim-current-budget">${formatSimCurrency(seg.cost)}</span>
                            </div>
                        </div>
                        <div class="sim-slider-container">
                            <span class="sim-slider-label">-30%</span>
                            <div class="sim-slider-track">
                                <input type="range" min="-30" max="50" value="${currentAdjust}" step="5"
                                       class="sim-slider simulation-slider" data-segment="${segment}">
                                <div class="sim-slider-fill" style="width: ${fillPercent}%;"></div>
                                <div class="sim-slider-thumb-value" style="left: ${fillPercent}%;">${currentAdjust > 0 ? '+' : ''}${currentAdjust}%</div>
                            </div>
                            <span class="sim-slider-label">+50%</span>
                        </div>
                        <div class="sim-slider-result">
                            <span class="sim-result-label">변경 예산</span>
                            <span class="sim-result-value ${currentAdjust >= 0 ? 'positive' : 'negative'}">
                                ${formatSimCurrency(newBudget)} <small>(${currentAdjust > 0 ? '+' : ''}${currentAdjust}%)</small>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            // 슬라이더 이벤트 바인딩
            container.querySelectorAll('.simulation-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const segment = this.dataset.segment;
                    const value = parseInt(this.value);
                    const min = parseInt(this.min);
                    const max = parseInt(this.max);
                    const percentage = ((value - min) / (max - min)) * 100;
                    budgetAdjustments[segment] = value;

                    const group = this.closest('.sim-slider-group');
                    const track = this.parentElement;

                    // 슬라이더 필 업데이트
                    const fill = track.querySelector('.sim-slider-fill');
                    if (fill) fill.style.width = percentage + '%';

                    // 썸 값 업데이트
                    const thumbValue = track.querySelector('.sim-slider-thumb-value');
                    if (thumbValue) {
                        thumbValue.textContent = (value > 0 ? '+' : '') + value + '%';
                        thumbValue.style.left = percentage + '%';
                    }

                    // 결과 값 업데이트
                    const resultValue = group.querySelector('.sim-result-value');
                    if (resultValue) {
                        const seg = simulationData[segment];
                        const newBudget = seg.cost * (1 + value / 100);
                        resultValue.innerHTML = `${formatSimCurrency(newBudget)} <small>(${value > 0 ? '+' : ''}${value}%)</small>`;
                        resultValue.className = 'sim-result-value ' + (value >= 0 ? 'positive' : 'negative');
                    }

                    updateSimulationResults();
                });
            });
        }

        // 로그 체감 함수 적용 ROAS 계산
        function calculateAdjustedRoas(currentRoas, budgetChangeRatio) {
            if (budgetChangeRatio > 0) {
                // 예산 증가: ROAS 하락 (체감 수익)
                return currentRoas * (1 - DIMINISHING_FACTOR * Math.log(1 + budgetChangeRatio));
            } else if (budgetChangeRatio < 0) {
                // 예산 감소: ROAS 상승 (효율적 타겟 집중)
                return currentRoas * (1 + DIMINISHING_FACTOR * Math.log(1 + Math.abs(budgetChangeRatio)) * 0.5);
            }
            return currentRoas;
        }

        // 시뮬레이션 결과 업데이트
        function updateSimulationResults() {
            let totalCurrentCost = 0;
            let totalCurrentRevenue = 0;
            let totalNewCost = 0;
            let totalNewRevenue = 0;
            const segmentResults = [];

            // 선택된 항목만 필터링
            const selectedItems = getSelectedSimItems();
            const segmentsToProcess = Object.keys(simulationData)
                .filter(seg => selectedItems.length === 0 || selectedItems.includes(seg));

            segmentsToProcess.forEach(segment => {
                const seg = simulationData[segment];
                const adjustment = (budgetAdjustments[segment] || 0) / 100;

                const newCost = seg.cost * (1 + adjustment);
                const adjustedRoas = calculateAdjustedRoas(seg.roas, adjustment);
                const newRevenue = newCost * (adjustedRoas / 100);

                totalCurrentCost += seg.cost;
                totalCurrentRevenue += seg.revenue;
                totalNewCost += newCost;
                totalNewRevenue += newRevenue;

                // 추천 등급 결정
                let recommendation = '';
                let recColor = '';
                if (adjustedRoas >= 150) {
                    recommendation = '증액 추천';
                    recColor = '#2e7d32';
                } else if (adjustedRoas >= 100) {
                    recommendation = '유지';
                    recColor = '#1565c0';
                } else if (adjustedRoas >= 50) {
                    recommendation = '효율 점검';
                    recColor = '#f57c00';
                } else {
                    recommendation = '감액 검토';
                    recColor = '#c62828';
                }

                segmentResults.push({
                    segment,
                    currentCost: seg.cost,
                    newCost,
                    currentRoas: seg.roas,
                    adjustedRoas,
                    currentRevenue: seg.revenue,
                    newRevenue,
                    recommendation,
                    recColor,
                    adjustment: budgetAdjustments[segment] || 0
                });
            });

            // 요약 카드 업데이트
            const currentRoas = totalCurrentCost > 0 ? (totalCurrentRevenue / totalCurrentCost * 100) : 0;
            const newRoas = totalNewCost > 0 ? (totalNewRevenue / totalNewCost * 100) : 0;
            const costChange = totalCurrentCost > 0 ? ((totalNewCost - totalCurrentCost) / totalCurrentCost * 100) : 0;
            const revenueChange = totalCurrentRevenue > 0 ? ((totalNewRevenue - totalCurrentRevenue) / totalCurrentRevenue * 100) : 0;
            const roasChange = newRoas - currentRoas;

            document.getElementById('simCurrentCost').textContent = formatSimCurrency(totalCurrentCost);
            document.getElementById('simNewCost').textContent = formatSimCurrency(totalNewCost);
            document.getElementById('simCostChange').textContent = (costChange >= 0 ? '+' : '') + costChange.toFixed(1) + '%';
            document.getElementById('simCostChange').style.color = costChange > 0 ? '#c62828' : costChange < 0 ? '#2e7d32' : 'var(--grey-600)';

            document.getElementById('simCurrentRevenue').textContent = formatSimCurrency(totalCurrentRevenue);
            document.getElementById('simNewRevenue').textContent = formatSimCurrency(totalNewRevenue);
            document.getElementById('simRevenueChange').textContent = (revenueChange >= 0 ? '+' : '') + revenueChange.toFixed(1) + '%';
            document.getElementById('simRevenueChange').style.color = revenueChange > 0 ? '#2e7d32' : revenueChange < 0 ? '#c62828' : 'var(--grey-600)';

            document.getElementById('simCurrentRoas').textContent = currentRoas.toFixed(0) + '%';
            document.getElementById('simNewRoas').textContent = newRoas.toFixed(0) + '%';
            document.getElementById('simRoasChange').textContent = (roasChange >= 0 ? '+' : '') + roasChange.toFixed(1) + '%p';
            document.getElementById('simRoasChange').style.color = roasChange > 0 ? '#2e7d32' : roasChange < 0 ? '#c62828' : 'var(--grey-600)';

            // 투자 효율 계산
            const additionalCost = totalNewCost - totalCurrentCost;
            const additionalRevenue = totalNewRevenue - totalCurrentRevenue;
            let efficiencyText = '-';
            if (additionalCost > 0 && additionalRevenue > 0) {
                const efficiency = (additionalRevenue / additionalCost * 100).toFixed(0);
                efficiencyText = efficiency + '%';
            } else if (additionalCost < 0 && additionalRevenue < 0) {
                efficiencyText = '비용 절감';
            } else if (additionalCost === 0) {
                efficiencyText = '변동 없음';
            }
            document.getElementById('simInvestmentEfficiency').textContent = efficiencyText;

            // 테이블 업데이트
            const tbody = document.getElementById('simulationResultBody');
            if (segmentResults.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 30px; text-align: center; color: var(--grey-500);">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5;">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                <span>표시할 항목을 선택하세요.</span>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                // 뱃지 클래스 매핑 함수
                const getBadgeClass = (rec) => {
                    if (rec === '증액 추천') return 'recommend';
                    if (rec === '유지') return 'maintain';
                    if (rec === '효율 점검') return 'review';
                    return 'warning';
                };

                // ROAS 레벨에 따른 dot 클래스
                const getDotClass = (roas) => {
                    if (roas >= 150) return 'high';
                    if (roas >= 50) return 'medium';
                    return 'low';
                };

                // 개별 행
                const rowsHtml = segmentResults.map(r => {
                    const dotClass = getDotClass(r.currentRoas);
                    const badgeClass = getBadgeClass(r.recommendation);
                    const rowClass = r.adjustment !== 0 ? 'sim-changed-row' : '';
                    const costChangeClass = r.adjustment > 0 ? 'positive' : r.adjustment < 0 ? 'negative' : 'neutral';
                    const roasClass = r.adjustedRoas >= 100 ? 'positive' : 'negative';

                    return `
                    <tr class="${rowClass}">
                        <td>
                            <div class="sim-segment-cell">
                                <span class="sim-segment-dot ${dotClass}"></span>
                                <span>${r.segment}</span>
                            </div>
                        </td>
                        <td style="text-align: right;">${formatSimCurrency(r.currentCost)}</td>
                        <td style="text-align: right;">
                            <span class="sim-highlight-cell ${costChangeClass}">
                                ${formatSimCurrency(r.newCost)}
                            </span>
                            <span style="font-size: 10px; color: var(--grey-400); margin-left: 4px;">(${r.adjustment > 0 ? '+' : ''}${r.adjustment}%)</span>
                        </td>
                        <td style="text-align: right;">${formatSimCurrency(r.currentRevenue)}</td>
                        <td style="text-align: right; font-weight: 600;">${formatSimCurrency(r.newRevenue)}</td>
                        <td style="text-align: right;">${r.currentRoas.toFixed(0)}%</td>
                        <td style="text-align: right;">
                            <span class="sim-highlight-cell ${roasClass}">${r.adjustedRoas.toFixed(0)}%</span>
                        </td>
                        <td style="text-align: center;">
                            <span class="sim-badge ${badgeClass}">${r.recommendation}</span>
                        </td>
                    </tr>
                `}).join('');

                // 총합 행
                const costChangeClass = costChange > 0 ? 'positive' : costChange < 0 ? 'negative' : 'neutral';
                const roasChangeClass = newRoas >= currentRoas ? 'positive' : 'negative';
                const totalHtml = `
                    <tr class="sim-total-row">
                        <td>
                            <div class="sim-total-cell">
                                <div class="sim-total-icon">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <path d="M4 6h16M4 12h16M4 18h16"/>
                                    </svg>
                                </div>
                                <span>총합</span>
                            </div>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value">${formatSimCurrency(totalCurrentCost)}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value sim-highlight-cell ${costChangeClass}">
                                ${formatSimCurrency(totalNewCost)}
                            </span>
                            <span style="font-size: 10px; color: var(--grey-500); margin-left: 4px;">(${costChange > 0 ? '+' : ''}${costChange.toFixed(1)}%)</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value">${formatSimCurrency(totalCurrentRevenue)}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value" style="color: #10b981;">${formatSimCurrency(totalNewRevenue)}</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value">${currentRoas.toFixed(0)}%</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="sim-total-value sim-highlight-cell ${roasChangeClass}">${newRoas.toFixed(0)}%</span>
                        </td>
                        <td style="text-align: center;">
                            <span style="font-size: 11px; color: var(--grey-400);">—</span>
                        </td>
                    </tr>
                `;

                tbody.innerHTML = rowsHtml + totalHtml;
            }

            // 인사이트 업데이트
            updateSimulationInsight(segmentResults, costChange, revenueChange, roasChange);
        }

        // 시뮬레이션 인사이트 생성
        function updateSimulationInsight(results, costChange, revenueChange, roasChange) {
            const insightEl = document.getElementById('simulationInsight');
            const statusEl = document.getElementById('simulationInsightStatus');
            if (!insightEl) return;

            const changedSegments = results.filter(r => r.adjustment !== 0);

            // 상태 업데이트 헬퍼
            const updateStatus = (statusClass, statusText) => {
                if (statusEl) {
                    statusEl.className = `sim-insight-status ${statusClass}`;
                    statusEl.innerHTML = `<span>${statusText}</span>`;
                }
            };

            if (changedSegments.length === 0) {
                insightEl.innerHTML = '주요 항목별 예산을 조정하면 예상 결과가 표시됩니다.';
                updateStatus('neutral', '대기 중');
                return;
            }

            const increased = changedSegments.filter(r => r.adjustment > 0);
            const decreased = changedSegments.filter(r => r.adjustment < 0);

            let insight = '';
            let statusClass = 'neutral';
            let statusText = '분석 중';

            if (revenueChange > 0 && roasChange >= -5) {
                statusClass = 'positive';
                statusText = '긍정적';
                insight = `<strong style="color: #059669;">긍정적 시나리오</strong><br>`;
                insight += `예산 ${costChange > 0 ? '증액' : '조정'}으로 매출이 <strong>${revenueChange.toFixed(1)}%</strong> 증가할 것으로 예상됩니다.`;
                if (roasChange < 0) {
                    insight += ` 다만 ROAS가 ${Math.abs(roasChange).toFixed(1)}%p 하락하므로 효율성 모니터링이 필요합니다.`;
                }
            } else if (revenueChange > 0 && roasChange < -5) {
                statusClass = 'warning';
                statusText = '주의 필요';
                insight = `<strong style="color: #d97706;">주의가 필요한 시나리오</strong><br>`;
                insight += `매출은 ${revenueChange.toFixed(1)}% 증가하지만, ROAS가 <strong>${Math.abs(roasChange).toFixed(1)}%p</strong> 크게 하락합니다. `;
                insight += `체감 수익 효과로 인한 효율 저하를 고려하세요.`;
            } else if (revenueChange < 0) {
                statusClass = 'negative';
                statusText = '재검토';
                insight = `<strong style="color: #dc2626;">재검토가 필요한 시나리오</strong><br>`;
                insight += `현재 설정으로는 매출이 ${Math.abs(revenueChange).toFixed(1)}% 감소할 것으로 예상됩니다. `;
                insight += `예산 배분을 다시 검토해보세요.`;
            } else {
                statusClass = 'neutral';
                statusText = '변동 없음';
                insight = `<strong style="color: #64748b;">변동 없음</strong><br>`;
                insight += `현재 설정에서는 매출 변화가 없습니다.`;
            }

            // 추가 정보
            if (increased.length > 0) {
                const topIncreased = increased.sort((a, b) => b.adjustment - a.adjustment)[0];
                insight += `<br><br><span style="color: var(--grey-500);">▸</span> <strong>${topIncreased.segment}</strong>에 가장 많은 증액(+${topIncreased.adjustment}%)이 설정됨`;
            }
            if (decreased.length > 0) {
                const topDecreased = decreased.sort((a, b) => a.adjustment - b.adjustment)[0];
                insight += `<br><span style="color: var(--grey-500);">▸</span> <strong>${topDecreased.segment}</strong>에 가장 많은 감액(${topDecreased.adjustment}%)이 설정됨`;
            }

            insightEl.innerHTML = insight;
            updateStatus(statusClass, statusText);
        }

        // 시뮬레이션 이벤트 바인딩
        function bindSimulationEvents() {
            // 세그먼트 타입 버튼
            document.querySelectorAll('.simulation-segment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.simulation-segment-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentSimSegmentType = this.dataset.simSegment;
                    budgetAdjustments = {}; // 조정값 초기화
                    loadSimulationData();
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            });

            // 초기화 버튼
            const resetBtn = document.getElementById('resetSimulationBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    Object.keys(budgetAdjustments).forEach(key => {
                        budgetAdjustments[key] = 0;
                    });
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            }

            // 시뮬레이션 항목 드롭다운 이벤트
            const simItemDropdownBtn = document.getElementById('simItemDropdownBtn');
            const simItemDropdownList = document.getElementById('simItemDropdownList');

            if (simItemDropdownBtn && simItemDropdownList) {
                simItemDropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = simItemDropdownList.style.display === 'block';
                    simItemDropdownList.style.display = isOpen ? 'none' : 'block';
                });

                // 드롭다운 외부 클릭 시 닫기
                document.addEventListener('click', function(e) {
                    if (!simItemDropdownBtn.contains(e.target) && !simItemDropdownList.contains(e.target)) {
                        simItemDropdownList.style.display = 'none';
                    }
                });
            }

            // 시뮬레이션 항목 전체 선택 이벤트
            const simItemSelectAll = document.getElementById('simItemSelectAll');
            if (simItemSelectAll) {
                simItemSelectAll.addEventListener('change', function() {
                    const allCheckboxes = document.querySelectorAll('.sim-item-checkbox');

                    if (this.checked) {
                        allCheckboxes.forEach(cb => {
                            cb.checked = true;
                        });
                    } else {
                        allCheckboxes.forEach(cb => {
                            cb.checked = false;
                        });
                    }

                    updateSimItemDropdownLabel();
                    renderSimulationSliders();
                    updateSimulationResults();
                });
            }
        }
    
    })();
    </script>

    <!-- ========== 채널별 비교 스크립트 (type_dashboard.html) ========== -->
    <script>
    (function() {
        // type 페이지 스크립트
        
        // 전역 변수
        let insightsData = null;
        let dimensionData = null;
        let currentPeriod = 'full';  // 기간 필터: 'full', '180d', '90d'

        // 현재 선택된 기간의 데이터 반환
        function getPeriodData() {
            if (!insightsData || !insightsData.by_period) {
                return insightsData;  // 이전 구조 호환
            }
            return insightsData.by_period[currentPeriod] || insightsData.by_period['full'];
        }

        // 분기별 추이 데이터 (전체 기간만 사용)
        function getSeasonalityData() {
            if (!insightsData) return null;
            // insightsData.seasonality가 있으면 반환, 없으면 최상위 레벨에서 찾기
            if (insightsData.seasonality) {
                return insightsData.seasonality;
            }
            // 최상위 레벨에 seasonality_analysis, seasonality_insights가 있는 경우
            return {
                seasonality_analysis: insightsData.seasonality_analysis || null,
                seasonality_insights: insightsData.seasonality_insights || []
            };
        }
        let currentTimeseriesPeriod = 'monthly';
        let currentTimeseriesMetric = 'roas';
        let timeseriesFilters = {
            channel: [],
            product: [],
            brand: [],
            promotion: []
        };
        let timeseriesStartDate = '';
        let timeseriesEndDate = '';
        let timeseriesTrendChart = null;
        let adsetDimensionData = null;  // 광고세트 추이 전용 데이터

        // 성별 추이 관련 변수
        let currentGenderFilter = 'channel';
        let currentGenderPeriod = 'monthly';
        let currentGenderMetric = 'roas';
        let genderStartDate = '';
        let genderEndDate = '';
        let selectedGenderItems = [];
        let genderTrendChart = null;
        let genderDimensionData = null;  // 성별 추이 전용 데이터

        // 연령 추이 관련 변수
        let currentAgeFilter = 'channel';
        let currentAgePeriod = 'monthly';
        let currentAgeMetric = 'roas';
        let ageStartDate = '';
        let ageEndDate = '';
        let selectedAgeItems = [];
        let ageTrendChart = null;
        let ageDimensionData = null;  // 연령 추이 전용 데이터

        // 플랫폼 추이 관련 변수
        let currentPlatformFilter = 'channel';
        let currentPlatformPeriod = 'monthly';
        let currentPlatformMetric = 'roas';
        let platformStartDate = '';
        let platformEndDate = '';
        let selectedPlatformItems = [];
        let platformTrendChart = null;
        let platformDimensionData = null;  // 플랫폼 추이 전용 데이터

        // 기기플랫폼 추이 관련 변수
        let currentDevicePlatformFilter = 'channel';
        let currentDevicePlatformPeriod = 'monthly';
        let currentDevicePlatformMetric = 'roas';
        let devicePlatformStartDate = '';
        let devicePlatformEndDate = '';
        let selectedDevicePlatformItems = [];
        let devicePlatformTrendChart = null;
        let devicePlatformDimensionData = null;  // 기기플랫폼 추이 전용 데이터

        // 기기유형 추이 관련 변수
        let currentDeviceTypeFilter = 'channel';
        let currentDeviceTypePeriod = 'monthly';
        let currentDeviceTypeMetric = 'roas';
        let deviceTypeStartDate = '';
        let deviceTypeEndDate = '';
        let selectedDeviceTypeItems = [];
        let deviceTypeTrendChart = null;
        let deviceTypeDimensionData = null;  // 기기유형 추이 전용 데이터

        // 성별연령 PIVOT 전용 데이터 (성과 테이블 분석에서 사용)
        let pivotDimensionData = null;

        // ========== 성과 비교 분석 섹션 변수 (독립적) ==========
        const DETAIL_DEFAULT_LIMIT = 10;  // 기본 표시 개수
        const DETAIL_EXPANDED_LIMIT = 50; // 더보기 시 표시 개수

        // 광고세트 상세
        let detailAdsetFilters = { channel: [], product: [], brand: [], promotion: [] };
        let detailAdsetMetric = 'roas';
        let detailAdsetSortOrder = 'desc';
        let detailAdsetStartDate = '';
        let detailAdsetEndDate = '';
        let detailAdsetCompareActive = false;
        let detailAdsetStartDateComp = '';
        let detailAdsetEndDateComp = '';
        let detailAdsetBarChart = null;
        let detailAdsetShowAll = false;
        let detailAdsetTotalCount = 0;

        // 성별 상세
        let detailGenderFilters = { channel: [], product: [], brand: [], promotion: [], adset: [] };
        let detailGenderMetric = 'roas';
        let detailGenderSortOrder = 'desc';
        let detailGenderStartDate = '';
        let detailGenderEndDate = '';
        let detailGenderCompareActive = false;
        let detailGenderStartDateComp = '';
        let detailGenderEndDateComp = '';
        let detailGenderBarChart = null;
        let detailGenderShowAll = false;
        let detailGenderTotalCount = 0;

        // 연령 상세
        let detailAgeFilters = { channel: [], product: [], brand: [], promotion: [], adset: [] };
        let detailAgeMetric = 'roas';
        let detailAgeSortOrder = 'desc';
        let detailAgeStartDate = '';
        let detailAgeEndDate = '';
        let detailAgeCompareActive = false;
        let detailAgeStartDateComp = '';
        let detailAgeEndDateComp = '';
        let detailAgeBarChart = null;
        let detailAgeShowAll = false;
        let detailAgeTotalCount = 0;

        // 플랫폼 상세
        let detailPlatformFilters = { channel: [], product: [], brand: [], promotion: [], adset: [] };
        let detailPlatformMetric = 'roas';
        let detailPlatformSortOrder = 'desc';
        let detailPlatformStartDate = '';
        let detailPlatformEndDate = '';
        let detailPlatformCompareActive = false;
        let detailPlatformStartDateComp = '';
        let detailPlatformEndDateComp = '';
        let detailPlatformBarChart = null;
        let detailPlatformShowAll = false;
        let detailPlatformTotalCount = 0;

        // 기기플랫폼 상세
        let detailDevicePlatformFilters = { channel: [], product: [], brand: [], promotion: [], adset: [] };
        let detailDevicePlatformMetric = 'roas';
        let detailDevicePlatformSortOrder = 'desc';
        let detailDevicePlatformStartDate = '';
        let detailDevicePlatformEndDate = '';
        let detailDevicePlatformCompareActive = false;
        let detailDevicePlatformStartDateComp = '';
        let detailDevicePlatformEndDateComp = '';
        let detailDevicePlatformBarChart = null;
        let detailDevicePlatformShowAll = false;
        let detailDevicePlatformTotalCount = 0;

        // 기기 상세
        let detailDeviceTypeFilters = { channel: [], product: [], brand: [], promotion: [], adset: [] };
        let detailDeviceTypeMetric = 'roas';
        let detailDeviceTypeSortOrder = 'desc';
        let detailDeviceTypeStartDate = '';
        let detailDeviceTypeEndDate = '';
        let detailDeviceTypeCompareActive = false;
        let detailDeviceTypeStartDateComp = '';
        let detailDeviceTypeEndDateComp = '';
        let detailDeviceTypeBarChart = null;
        let detailDeviceTypeShowAll = false;
        let detailDeviceTypeTotalCount = 0;

        // 데이터 로딩
        async function loadData() {
            try {
                // 캐시 방지를 위한 타임스탬프 추가
                const response = await fetch('type/insights.json?t=' + Date.now());
                insightsData = await response.json();

                // 차원 데이터 로딩 (merged_data.csv - 일별 데이터 포함)
                try {
                    const dimensionResponse = await fetch('type/merged_data.csv');
                    const dimensionText = await dimensionResponse.text();
                    dimensionData = parseCSV(dimensionText);
                } catch (err) {
                    console.warn('차원 데이터 로딩 실패:', err);
                }

                // 광고세트 추이 전용 데이터 로딩 (dimension_type1_campaign_adset.csv)
                try {
                    const adsetResponse = await fetch('type/dimension_type1_campaign_adset.csv');
                    const adsetText = await adsetResponse.text();
                    adsetDimensionData = parseCSV(adsetText);
                } catch (err) {
                    console.warn('광고세트 차원 데이터 로딩 실패:', err);
                }

                // 성별 추이 전용 데이터 로딩 (dimension_type4_adset_gender.csv)
                try {
                    const genderResponse = await fetch('type/dimension_type4_adset_gender.csv');
                    const genderText = await genderResponse.text();
                    genderDimensionData = parseCSV(genderText);
                } catch (err) {
                    console.warn('성별 차원 데이터 로딩 실패:', err);
                }

                // 연령 추이 전용 데이터 로딩 (dimension_type3_adset_age.csv)
                try {
                    const ageResponse = await fetch('type/dimension_type3_adset_age.csv');
                    const ageText = await ageResponse.text();
                    ageDimensionData = parseCSV(ageText);
                } catch (err) {
                    console.warn('연령 차원 데이터 로딩 실패:', err);
                }

                // 플랫폼 추이 전용 데이터 로딩 (dimension_type6_adset_platform.csv)
                try {
                    const platformResponse = await fetch('type/dimension_type6_adset_platform.csv');
                    const platformText = await platformResponse.text();
                    platformDimensionData = parseCSV(platformText);
                } catch (err) {
                    console.warn('플랫폼 차원 데이터 로딩 실패:', err);
                }

                // 기기플랫폼 추이 전용 데이터 로딩 (dimension_type7_adset_deviceplatform.csv)
                try {
                    const devicePlatformResponse = await fetch('type/dimension_type7_adset_deviceplatform.csv');
                    const devicePlatformText = await devicePlatformResponse.text();
                    devicePlatformDimensionData = parseCSV(devicePlatformText);
                } catch (err) {
                    console.warn('기기플랫폼 차원 데이터 로딩 실패:', err);
                }

                // 기기유형 추이 전용 데이터 로딩 (dimension_type5_adset_device.csv)
                try {
                    const deviceTypeResponse = await fetch('type/dimension_type5_adset_device.csv');
                    const deviceTypeText = await deviceTypeResponse.text();
                    deviceTypeDimensionData = parseCSV(deviceTypeText);
                } catch (err) {
                    console.warn('기기유형 차원 데이터 로딩 실패:', err);
                }

                // 성별연령 PIVOT 전용 데이터 로딩 (dimension_type2_adset_age_gender.csv)
                try {
                    const pivotResponse = await fetch('type/dimension_type2_adset_age_gender.csv');
                    const pivotText = await pivotResponse.text();
                    pivotDimensionData = parseCSV(pivotText);
                } catch (err) {
                    console.warn('성별연령 PIVOT 차원 데이터 로딩 실패:', err);
                }

                // 대시보드 초기화
                initDashboard();
                initTrendAnalysisFilters();
                setupEventListeners();
            } catch (error) {
                console.error('데이터 로딩 실패:', error);
                alert('데이터를 불러오는데 실패했습니다.');
            }
        }

        // CSV 파싱 함수 (RFC 4180 표준 준수)
        function parseCSV(text) {
            const lines = text.trim().split('\n');

            // RFC 4180 호환 CSV 파싱
            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // 연속된 따옴표는 이스케이프된 따옴표
                            current += '"';
                            i++; // 다음 따옴표 건너뛰기
                        } else {
                            // 따옴표 모드 전환
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 따옴표 밖의 쉼표는 구분자
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                // 마지막 필드 추가
                result.push(current.trim());
                return result;
            }

            // 헤더 파싱
            const headers = parseLine(lines[0]).map(h => h.replace(/^"|"$/g, '').trim());
            const result = [];

            // 데이터 행 파싱
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // 빈 줄 건너뛰기

                const values = parseLine(lines[i]);
                const obj = {};

                headers.forEach((header, index) => {
                    // 따옴표 제거 및 trim
                    let value = values[index] || '';
                    value = value.replace(/^"|"$/g, '').trim();
                    obj[header] = value;
                });

                result.push(obj);
            }

            return result;
        }

        // 대시보드 초기화
        function initDashboard() {
            updatePeriodInfo();
            renderKPICards();
            renderDecisionTools();
            initTimeseriesDropdowns();
            initGenderDropdowns();
            initAgeDropdowns();
            initPlatformDropdowns();
            initDevicePlatformDropdowns();
            initDeviceTypeDropdowns();
            initPerformanceCharts();
            initRetargetingAnalysis();
            initDetailAnalysis();
            initPerfTableAnalysis();
        }

        // 기간 정보 업데이트
        function updatePeriodInfo() {
            const periodData = getPeriodData();
            const period = periodData.summary.analysis_period;
            document.getElementById('period-info').textContent =
                `분석 기간: ${period.start_date} ~ ${period.end_date} (${period.total_days}일)`;
        }

        // KPI 카드 렌더링
        function renderKPICards() {
            const periodData = getPeriodData();
            const overall = periodData.overall;

            // adsetDimensionData(dimension_type1_campaign_adset.csv)에서 KPI 합계 계산
            let totalCost = 0;
            let totalImpressions = 0;
            let totalClicks = 0;
            let totalConversions = 0;
            let totalRevenue = 0;

            if (adsetDimensionData && adsetDimensionData.length > 0) {
                adsetDimensionData.forEach(row => {
                    // 캠페인이름, 광고세트가 존재하는 데이터만
                    const hasCampaign = row['캠페인이름'] && row['캠페인이름'] !== '-';
                    const hasAdset = row['광고세트'] && row['광고세트'] !== '-';

                    if (hasCampaign && hasAdset) {
                        totalCost += parseFloat(row['비용']) || 0;
                        totalImpressions += parseFloat(row['노출']) || 0;
                        totalClicks += parseFloat(row['클릭']) || 0;
                        totalConversions += parseFloat(row['전환수']) || 0;
                        totalRevenue += parseFloat(row['전환값']) || 0;
                    }
                });
            }

            // Primary KPIs (상단 5개): 비용, CPM, CPC, CPA, ROAS
            const cpm = totalImpressions > 0 ? (totalCost / totalImpressions * 1000) : 0;
            const cpc = totalClicks > 0 ? (totalCost / totalClicks) : 0;
            const cpa = totalConversions > 0 ? (totalCost / totalConversions) : 0;
            const roas = totalCost > 0 ? (totalRevenue / totalCost * 100) : 0;

            const html = `
                <section class="kpi-grid kpi-grid-primary">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">총 비용</span>
                            <div class="kpi-icon">💰</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(totalCost)}</div>
                        <div class="kpi-trend neutral">
                            <span>전체 기간 합계</span>
                        </div>
                    </div>
                    <div class="kpi-card highlight">
                        <div class="kpi-header">
                            <span class="kpi-title">ROAS</span>
                            <div class="kpi-icon">📈</div>
                        </div>
                        <div class="kpi-value highlight-value">${formatPercent(roas)}</div>
                        <div class="kpi-trend neutral">
                            <span>광고 수익률</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">CPA</span>
                            <div class="kpi-icon">🎯</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(cpa)}</div>
                        <div class="kpi-trend neutral">
                            <span>전환당 비용</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">CPC</span>
                            <div class="kpi-icon">🖱️</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(cpc)}</div>
                        <div class="kpi-trend neutral">
                            <span>클릭당 비용</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">CPM</span>
                            <div class="kpi-icon">👁️</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(cpm)}</div>
                        <div class="kpi-trend neutral">
                            <span>노출당 비용</span>
                        </div>
                    </div>
                </section>
                <section class="kpi-grid kpi-grid-secondary">
                    <div class="kpi-card secondary">
                        <div class="kpi-header">
                            <span class="kpi-title">총 노출</span>
                            <div class="kpi-icon">👀</div>
                        </div>
                        <div class="kpi-value">${formatNumber(totalImpressions)}</div>
                        <div class="kpi-trend neutral">
                            <span>회</span>
                        </div>
                    </div>
                    <div class="kpi-card secondary">
                        <div class="kpi-header">
                            <span class="kpi-title">총 클릭</span>
                            <div class="kpi-icon">👆</div>
                        </div>
                        <div class="kpi-value">${formatNumber(totalClicks)}</div>
                        <div class="kpi-trend neutral">
                            <span>회</span>
                        </div>
                    </div>
                    <div class="kpi-card secondary">
                        <div class="kpi-header">
                            <span class="kpi-title">총 전환수</span>
                            <div class="kpi-icon">✅</div>
                        </div>
                        <div class="kpi-value">${formatNumber(totalConversions)}</div>
                        <div class="kpi-trend neutral">
                            <span>건</span>
                        </div>
                    </div>
                    <div class="kpi-card secondary">
                        <div class="kpi-header">
                            <span class="kpi-title">총 전환값</span>
                            <div class="kpi-icon">💵</div>
                        </div>
                        <div class="kpi-value">${formatCurrency(totalRevenue)}</div>
                        <div class="kpi-trend neutral">
                            <span>원</span>
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('kpi-wrapper').innerHTML = html;
        }

        // 알수없음 데이터 필터링 헬퍼 함수
        function isValidGender(gender) {
            if (!gender || gender === '-') return false;
            const genderStr = String(gender).trim().toLowerCase();
            const unknownPattern = /^(구분없음|알\s?수\s?없음|un.*|unknown)/i;
            return !unknownPattern.test(genderStr);
        }

        function isValidAge(age) {
            if (!age || age === '-') return false;
            const ageStr = String(age).trim().toLowerCase();
            const unknownPattern = /^(구분없음|알\s?수\s?없음|un.*|unknown|age_range_undetermined)/i;
            return !unknownPattern.test(ageStr);
        }

        function normalizeGender(gender) {
            if (!isValidGender(gender)) return null;
            const genderStr = String(gender).trim().toLowerCase();
            if (/^(남자|남성|male|m)$/i.test(genderStr)) return '남성';
            if (/^(여자|여성|female|f)$/i.test(genderStr)) return '여성';
            return gender;
        }

        // 데이터 기반 의사결정 도구 렌더링
        function renderDecisionTools() {
            renderSummaryTab();
            renderOpportunityTab();
            renderWarningTab();
            renderTargetingTab();
            renderForecastTab();
            initDecisionToolTabs();
            initDecisionTooltips();
            initCardHoverTooltips();
            updatePeriodDateRange();
        }

        // 기간 전환 함수
        function switchPeriod(period) {
            currentPeriod = period;

            // 버튼 스타일 업데이트
            document.querySelectorAll('.period-filter-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                    btn.classList.remove('active');
                }
            });

            // 날짜 범위 표시 업데이트
            updatePeriodDateRange();

            // 모든 탭 다시 렌더링 (분기별 추이 제외)
            renderSummaryTab();
            renderOpportunityTab();
            renderWarningTab();
            renderTargetingTab();
            renderForecastTab();
            renderBudgetGuideTab();
            // 계절성 분석은 전체 기간 데이터만 사용하므로 다시 렌더링하지 않음
        }
        // 인라인 onclick에서 접근할 수 있도록 전역 스코프에 노출
        window.switchPeriod = switchPeriod;

        // 선택된 기간의 날짜 범위 표시
        function updatePeriodDateRange() {
            const periodData = getPeriodData();
            if (periodData && periodData.summary && periodData.summary.analysis_period) {
                const ap = periodData.summary.analysis_period;
                const dateRangeEl = document.getElementById('periodDateRange');
                if (dateRangeEl) {
                    dateRangeEl.textContent = `${ap.start_date} ~ ${ap.end_date} (${ap.total_days}일)`;
                }
            }
        }

        // 툴팁 초기화
        function initDecisionTooltips() {
            // 인라인 툴팁 (? 아이콘)
            document.addEventListener('mouseenter', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('inline-help-icon')) {
                    const tooltipText = e.target.getAttribute('data-tooltip');
                    if (tooltipText) {
                        showInlineTooltip(e.target, tooltipText);
                    }
                }
            }, true);

            document.addEventListener('mouseleave', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('inline-help-icon')) {
                    hideInlineTooltip();
                }
            }, true);
        }

        // 인라인 툴팁 표시
        function showInlineTooltip(element, text) {
            let tooltip = document.getElementById('inlineDecisionTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'inlineDecisionTooltip';
                tooltip.style.cssText = 'position: fixed; background: #1a1a2e; color: white; padding: 10px 14px; border-radius: 8px; font-size: 12px; max-width: 280px; line-height: 1.5; z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.25); pointer-events: none;';
                document.body.appendChild(tooltip);
            }
            tooltip.innerHTML = text;
            tooltip.style.display = 'block';

            const rect = element.getBoundingClientRect();
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.bottom + 8) + 'px';
        }

        // 인라인 툴팁 숨기기
        function hideInlineTooltip() {
            const tooltip = document.getElementById('inlineDecisionTooltip');
            if (tooltip) tooltip.style.display = 'none';
        }

        // 카드 호버 툴팁 초기화
        function initCardHoverTooltips() {
            // 글로벌 툴팁 엘리먼트 생성
            let cardTooltip = document.getElementById('cardHoverTooltip');
            if (!cardTooltip) {
                cardTooltip = document.createElement('div');
                cardTooltip.id = 'cardHoverTooltip';
                cardTooltip.className = 'card-hover-tooltip';
                document.body.appendChild(cardTooltip);
            }

            // 이벤트 위임 방식으로 호버 처리
            document.addEventListener('mouseenter', function(e) {
                if (!e.target || !e.target.closest) return;
                const card = e.target.closest('.hoverable-card');
                if (card && card.dataset.tooltipTitle) {
                    showCardTooltip(card, cardTooltip);
                }
            }, true);

            document.addEventListener('mouseleave', function(e) {
                if (!e.target || !e.target.closest) return;
                const card = e.target.closest('.hoverable-card');
                if (card && card.dataset.tooltipTitle) {
                    hideCardTooltip(cardTooltip);
                }
            }, true);

            document.addEventListener('mousemove', function(e) {
                if (!e.target || !e.target.closest) return;
                const card = e.target.closest('.hoverable-card');
                if (card && card.dataset.tooltipTitle && cardTooltip.classList.contains('show')) {
                    positionCardTooltip(e, cardTooltip);
                }
            }, true);
        }

        // 카드 툴팁 표시
        function showCardTooltip(card, tooltip) {
            const title = card.dataset.tooltipTitle || '';
            const icon = card.dataset.tooltipIcon || '💡';
            const insight = card.dataset.tooltipInsight || '';
            const recommendation = card.dataset.tooltipRecommendation || '';

            let html = `
                <div class="card-tooltip-header">
                    <span class="card-tooltip-header-icon">${icon}</span>
                    <span class="card-tooltip-header-title">${title}</span>
                </div>
            `;

            if (insight) {
                html += `
                    <div class="card-tooltip-insight">
                        <div class="card-tooltip-insight-label">💡 인사이트</div>
                        <div class="card-tooltip-insight-text">${insight}</div>
                    </div>
                `;
            }

            if (recommendation) {
                html += `
                    <div class="card-tooltip-recommendation">
                        <div class="card-tooltip-recommendation-label">✅ 활용 팁</div>
                        <div class="card-tooltip-recommendation-text">${recommendation}</div>
                    </div>
                `;
            }

            tooltip.innerHTML = html;
            tooltip.classList.add('show');
        }

        // 카드 툴팁 위치 조정
        function positionCardTooltip(e, tooltip) {
            const padding = 15;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;

            let left = e.clientX + padding;
            let top = e.clientY + padding;

            // 오른쪽 화면 밖으로 나가면 왼쪽에 표시
            if (left + tooltipWidth > viewportWidth - padding) {
                left = e.clientX - tooltipWidth - padding;
            }

            // 아래 화면 밖으로 나가면 위에 표시
            if (top + tooltipHeight > viewportHeight - padding) {
                top = e.clientY - tooltipHeight - padding;
            }

            // 최소값 보정
            if (left < padding) left = padding;
            if (top < padding) top = padding;

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // 카드 툴팁 숨기기
        function hideCardTooltip(tooltip) {
            tooltip.classList.remove('show');
        }

        // 탭 0: 오늘의 요약 (새로운 메인 탭)
        function renderSummaryTab() {
            const periodData = getPeriodData();
            const summary = periodData.summary || {};
            const summaryCard = periodData.summary_card || null;
            const topRecommendations = periodData.top_recommendations || [];
            const topCategories = periodData.top_categories || [];
            const productPerformance = periodData.product_performance || [];
            const genderData = (periodData.gender_performance || []).filter(g => isValidGender(g.gender));
            const timeseries = periodData.timeseries || {};

            const avgRoas = summary.overall_roas || 0;
            const avgCpa = summary.overall_cpa || 0;
            const totalConversions = summary.total_conversions || 0;
            const totalRevenue = summary.total_revenue || 0;
            const totalCost = summary.total_cost || 0;

            // 성과 상태 판단
            const roasStatus = avgRoas >= 200 ? 'excellent' : avgRoas >= 150 ? 'good' : avgRoas >= 100 ? 'normal' : 'warning';
            const statusConfig = {
                excellent: { text: '매우 좋음', color: '#00c853', bg: '#e8f5e9', icon: '🎉' },
                good: { text: '양호', color: '#2e7d32', bg: '#e8f5e9', icon: '👍' },
                normal: { text: '보통', color: '#f57c00', bg: '#fff3e0', icon: '📊' },
                warning: { text: '개선 필요', color: '#d32f2f', bg: '#ffebee', icon: '⚠️' }
            };
            const status = statusConfig[roasStatus];

            // 최고/최저 성과 찾기
            const sortedByRoas = [...topCategories].sort((a, b) => b.roas - a.roas);
            const sortedByCpa = [...topCategories].sort((a, b) => a.cpa - b.cpa);
            const topChannel = sortedByRoas[0];
            const lowCpaChannel = sortedByCpa[0];

            // 월별 추세에서 최근 변화 계산
            let recentTrend = '';
            let trendIcon = '';
            if (timeseries.monthly_growth && timeseries.monthly_growth.length > 0) {
                const lastMonth = timeseries.monthly_growth[timeseries.monthly_growth.length - 1];
                if (lastMonth.roas_change > 10) {
                    recentTrend = `지난달 대비 ROAS ${lastMonth.roas_change.toFixed(1)}%p 상승`;
                    trendIcon = '📈';
                } else if (lastMonth.roas_change < -10) {
                    recentTrend = `지난달 대비 ROAS ${Math.abs(lastMonth.roas_change).toFixed(1)}%p 하락`;
                    trendIcon = '📉';
                } else {
                    recentTrend = '지난달과 비슷한 성과 유지 중';
                    trendIcon = '➡️';
                }
            }

            // 선택된 기간 정보
            const periodLabels = {'full': '전체 기간', '180d': '최근 180일', '90d': '최근 90일'};
            const currentPeriodLabel = periodLabels[currentPeriod] || '전체 기간';

            let html = '';

            // 0. AI 컨설턴트 종합 진단 카드 (summary_card)
            if (summaryCard) {
                html += `
                    <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                        <div style="display: flex; align-items: flex-start; gap: 16px;">
                            <div style="font-size: 48px; line-height: 1;">🤖</div>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 18px; font-weight: 700;">${summaryCard.title || '마케팅 종합 진단'}</span>
                                    <span style="font-size: 11px; background: rgba(255,255,255,0.25); padding: 3px 10px; border-radius: 12px; margin-left: auto;">${currentPeriodLabel} 기준</span>
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px;">
                                    <div style="padding: 6px 14px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 13px; font-weight: 600;">
                                        ${summaryCard.total_roas_formatted || 'ROAS ' + formatPercent(avgRoas)}
                                    </div>
                                    <div style="padding: 6px 14px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 13px; font-weight: 600;">
                                        매출 ${summaryCard.total_revenue_formatted || formatCurrency(totalRevenue)}
                                    </div>
                                    <div style="padding: 6px 14px; background: rgba(255,255,255,0.2); border-radius: 20px; font-size: 13px; font-weight: 600;">
                                        비용 ${summaryCard.total_cost_formatted || formatCurrency(totalCost)}
                                    </div>
                                </div>
                                <div style="font-size: 14px; opacity: 0.95; line-height: 1.7; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 10px;">
                                    ${summaryCard.message || ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 1. 핵심 지표 대시보드 (카드 형태) - 호버 툴팁 적용
            html += `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                    <!-- 전체 ROAS -->
                    <div class="hoverable-card"
                         data-tooltip-title="ROAS (광고수익률)"
                         data-tooltip-icon="📈"
                         data-tooltip-insight="광고비 대비 매출 비율입니다. ROAS 200%는 1만원 광고비로 2만원 매출을 올렸다는 의미입니다."
                         data-tooltip-recommendation="ROAS 100% 이상이면 수익 발생, 200% 이상이면 효율적인 광고입니다."
                         style="padding: 16px; background: ${status.bg}; border-radius: 12px; border: 1px solid ${status.color}20; position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">ROAS</div>
                                <div style="font-size: 24px; font-weight: 800; color: ${status.color};">${formatPercent(avgRoas)}</div>
                            </div>
                            <div style="padding: 4px 8px; background: ${status.color}; color: white; border-radius: 12px; font-size: 10px; font-weight: 600;">
                                ${status.icon} ${status.text}
                            </div>
                        </div>
                    </div>

                    <!-- CPA -->
                    <div class="hoverable-card"
                         data-tooltip-title="CPA (전환당 비용)"
                         data-tooltip-icon="💰"
                         data-tooltip-insight="전환 1건당 드는 비용입니다. CPA 10,000원이면 구매 1건에 광고비 1만원이 든다는 의미입니다."
                         data-tooltip-recommendation="CPA가 낮을수록 효율적입니다. 상품 마진 대비 CPA를 확인하세요."
                         style="padding: 16px; background: #e3f2fd; border-radius: 12px; border: 1px solid #90caf920;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">CPA</div>
                        <div style="font-size: 24px; font-weight: 800; color: #1565c0;">${formatCurrency(avgCpa)}</div>
                    </div>

                    <!-- 총 전환 -->
                    <div class="hoverable-card"
                         data-tooltip-title="총 전환수"
                         data-tooltip-icon="🎯"
                         data-tooltip-insight="광고를 통해 발생한 구매, 가입 등의 목표 행동 수입니다."
                         data-tooltip-recommendation="전환수가 많을수록 광고가 잘 동작하고 있습니다."
                         style="padding: 16px; background: #f3e5f5; border-radius: 12px; border: 1px solid #ce93d820;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">총 전환수</div>
                        <div style="font-size: 24px; font-weight: 800; color: #7b1fa2;">${formatNumber(totalConversions)}</div>
                    </div>

                    <!-- 총 매출 -->
                    <div class="hoverable-card"
                         data-tooltip-title="총 매출"
                         data-tooltip-icon="💵"
                         data-tooltip-insight="광고를 통해 발생한 총 매출 금액입니다."
                         data-tooltip-recommendation="매출 대비 광고비 비율을 확인하여 수익성을 점검하세요."
                         style="padding: 16px; background: #fff8e1; border-radius: 12px; border: 1px solid #ffcc8020;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">총 매출</div>
                        <div style="font-size: 24px; font-weight: 800; color: #f57c00;">${formatCurrency(totalRevenue)}</div>
                    </div>
                </div>
            `;

            // 2. 한줄 요약 (스토리텔링)
            html += `
                <div style="margin-bottom: 20px; padding: 16px 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border-left: 4px solid ${status.color};">
                    <div style="font-size: 14px; color: var(--grey-900); line-height: 1.7;">
                        <span style="font-size: 18px; margin-right: 8px;">${trendIcon}</span>
                        ${recentTrend ? `<strong>${recentTrend}</strong>입니다. ` : ''}
                        ${topChannel ? `현재 <strong style="color: #2e7d32;">${topChannel.name}</strong> 채널이 ROAS ${formatPercent(topChannel.roas)}로 가장 좋은 성과를 보이고 있습니다.` : ''}
                    </div>
                </div>
            `;

            // 2.5. 액션 가이드 섹션 (하위 탭: 지금 바로 할 수 있는 일 / AI 핵심 추천)
            const hasRecommendations = topRecommendations && topRecommendations.length > 0;

            // Severity 기준 정렬 (high가 가장 상위)
            const recsSeverityOrder = { 'high': 0, 'warning': 1, 'opportunity': 2, 'info': 3 };
            const sortBySeverity = (a, b) => {
                const orderA = recsSeverityOrder[a.severity] !== undefined ? recsSeverityOrder[a.severity] : 4;
                const orderB = recsSeverityOrder[b.severity] !== undefined ? recsSeverityOrder[b.severity] : 4;
                return orderA - orderB;
            };

            const urgentRecs = topRecommendations
                .filter(r => r.priority === 'high' || r.severity === 'high')
                .sort(sortBySeverity);
            const otherRecs = topRecommendations
                .filter(r => r.priority !== 'high' && r.severity !== 'high')
                .sort(sortBySeverity);

            html += `
                <div style="margin-bottom: 20px; border: 1px solid var(--grey-200); border-radius: 12px; overflow: hidden;">
                    <!-- 하위 탭 헤더 -->
                    <div style="display: flex; background: #f8f9fa; border-bottom: 1px solid var(--grey-200);">
                        <button class="action-guide-tab active" data-action-tab="quickAction"
                                style="flex: 1; padding: 12px 16px; font-size: 12px; font-weight: 600; border: none; background: white; color: var(--primary-main); cursor: pointer; border-bottom: 2px solid var(--primary-main); transition: all 0.2s;">
                            ✅ 지금 바로 할 수 있는 일
                        </button>
                        <button class="action-guide-tab" data-action-tab="aiRecommend"
                                style="flex: 1; padding: 12px 16px; font-size: 12px; font-weight: 600; border: none; background: #f8f9fa; color: var(--grey-600); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">
                            🎯 AI 핵심 추천 ${urgentRecs.length > 0 ? '<span style="padding: 2px 6px; background: #ff5722; color: white; border-radius: 8px; font-size: 10px; margin-left: 4px;">' + urgentRecs.length + '</span>' : ''}
                        </button>
                    </div>

                    <!-- 탭 1: 지금 바로 할 수 있는 일 -->
                    <div id="quickActionContent" class="action-guide-content" style="padding: 16px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            `;

            // 액션 1: 확대할 채널
            if (topChannel && topChannel.roas >= 200) {
                html += `
                    <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">🔥</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: #2e7d32;">예산 늘리기</div>
                                <div style="font-size: 10px; color: #2e7d32; opacity: 0.8;">고효율 채널</div>
                            </div>
                            <span style="background: #4caf50; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">SCALE-UP</span>
                        </div>
                        <!-- 메트릭스 배지 -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #81c784; font-weight: 500;">${topChannel.name}</span>
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">ROAS ${formatPercent(topChannel.roas)}</span>
                        </div>
                        <!-- 추천 액션 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #4caf50;">
                            <div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">예산을 <strong>10-20%</strong> 더 투자하세요</div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">📊</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: #1565c0;">성과 분석</div>
                                <div style="font-size: 10px; color: #1565c0; opacity: 0.8;">채널 비교</div>
                            </div>
                            <span style="background: #2196f3; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">ANALYZE</span>
                        </div>
                        <!-- 추천 액션 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #2196f3;">
                            <div style="font-size: 10px; font-weight: 600; color: #1565c0; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">채널별 성과를 비교하여 <strong>가장 효율적인 채널</strong>을 찾아보세요</div>
                        </div>
                    </div>
                `;
            }

            // 액션 2: CPA 최적화
            if (lowCpaChannel) {
                html += `
                    <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">💰</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: #1565c0;">비용 효율화</div>
                                <div style="font-size: 10px; color: #1565c0; opacity: 0.8;">CPA 최적화</div>
                            </div>
                            <span style="background: #2196f3; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">EFFICIENT</span>
                        </div>
                        <!-- 메트릭스 배지 -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">${lowCpaChannel.name}</span>
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">CPA ${formatCurrency(lowCpaChannel.cpa)}</span>
                        </div>
                        <!-- 추천 액션 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #2196f3;">
                            <div style="font-size: 10px; font-weight: 600; color: #1565c0; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">전환당 비용이 가장 낮은 채널에 집중하세요</div>
                        </div>
                    </div>
                `;
            }

            // 액션 3: 개선 필요
            const poorChannel = sortedByRoas.length > 0 ? sortedByRoas[sortedByRoas.length - 1] : null;
            if (poorChannel && poorChannel.roas < 100) {
                html += `
                    <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">⚠️</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: #e65100;">점검 필요</div>
                                <div style="font-size: 10px; color: #e65100; opacity: 0.8;">저효율 채널</div>
                            </div>
                            <span style="background: #ff9800; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">REVIEW</span>
                        </div>
                        <!-- 메트릭스 배지 -->
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #e65100; border: 1px solid #ffcc80; font-weight: 500;">${poorChannel.name}</span>
                            <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #c62828; border: 1px solid #ef9a9a; font-weight: 500;">ROAS ${formatPercent(poorChannel.roas)}</span>
                        </div>
                        <!-- 추천 액션 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #ff9800;">
                            <div style="font-size: 10px; font-weight: 600; color: #e65100; margin-bottom: 4px;">⚠️ 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">광고 소재를 교체해보세요</div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">🎯</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: #7b1fa2;">타겟 최적화</div>
                                <div style="font-size: 10px; color: #7b1fa2; opacity: 0.8;">고객층 분석</div>
                            </div>
                            <span style="background: #9c27b0; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">OPTIMIZE</span>
                        </div>
                        <!-- 추천 액션 -->
                        <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #9c27b0;">
                            <div style="font-size: 10px; font-weight: 600; color: #7b1fa2; margin-bottom: 4px;">💡 추천 액션</div>
                            <div style="font-size: 11px; color: #333; line-height: 1.4;">'타겟 분석' 탭에서 가장 효과적인 <strong>고객층</strong>을 확인하세요</div>
                        </div>
                    </div>
                `;
            }

            html += `</div></div>`;

            // 탭 2: AI 핵심 추천 (접기/펼치기)
            html += `<div id="aiRecommendContent" class="action-guide-content" style="padding: 16px; display: none;">`;

            if (hasRecommendations) {
                // 긴급 카드 (항상 표시, 최대 3개)
                const urgentToShow = urgentRecs.slice(0, 3);
                const remainingRecs = [...urgentRecs.slice(3), ...otherRecs];

                if (urgentToShow.length > 0) {
                    html += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                    urgentToShow.forEach((rec, idx) => {
                        html += renderRecommendationCard(rec, idx);
                    });
                    html += `</div>`;
                }

                // 나머지 추천 (접기/펼치기) - 더보기/접기 버튼 분리
                if (remainingRecs.length > 0) {
                    const recsToggleId = 'recsToggle_' + Date.now();
                    html += `
                        <div id="${recsToggleId}_showMore" style="text-align: center; margin-top: 12px;">
                            <button class="show-more-btn" onclick="document.getElementById('${recsToggleId}_content').style.display='block'; document.getElementById('${recsToggleId}_showMore').style.display='none';">
                                더 보기 (${remainingRecs.length}건)
                            </button>
                        </div>
                        <div id="${recsToggleId}_content" style="display: none; margin-top: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                    `;
                    remainingRecs.forEach((rec, idx) => {
                        html += renderRecommendationCard(rec, idx + urgentToShow.length);
                    });
                    html += `
                            </div>
                            <div style="text-align: center; margin-top: 12px;">
                                <button class="show-more-btn" onclick="document.getElementById('${recsToggleId}_content').style.display='none'; document.getElementById('${recsToggleId}_showMore').style.display='block';">
                                    접기
                                </button>
                            </div>
                        </div>`;
                }

                if (urgentToShow.length === 0 && remainingRecs.length === 0) {
                    html += `<div style="text-align: center; padding: 20px; color: var(--grey-500);">현재 AI 추천 사항이 없습니다.</div>`;
                }
            } else {
                html += `<div style="text-align: center; padding: 20px; color: var(--grey-500);">현재 AI 추천 사항이 없습니다.</div>`;
            }

            html += `</div></div>`;

            // 추천 카드 렌더링 헬퍼 함수
            function renderRecommendationCard(rec, idx) {
                const severityConfig = {
                    'positive': { border: '#4caf50', bg: '#e8f5e9', text: '#2e7d32', icon: '👑', badge: 'SCALE-UP' },
                    'high': { border: '#f44336', bg: '#ffebee', text: '#c62828', icon: '🚨', badge: 'URGENT' },
                    'warning': { border: '#ff9800', bg: '#fff3e0', text: '#e65100', icon: '⚠️', badge: 'REVIEW' },
                    'opportunity': { border: '#2196f3', bg: '#e3f2fd', text: '#1565c0', icon: '💎', badge: 'GROW' },
                    'info': { border: '#2196f3', bg: '#e3f2fd', text: '#1565c0', icon: '💡', badge: 'INFO' }
                };
                const config = severityConfig[rec.severity] || severityConfig['info'];
                const priorityBadge = rec.priority === 'high' ? '<span style="background: #ff5722; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">긴급</span>' : '<span style="background: ' + config.border + '; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">' + config.badge + '</span>';

                return `
                    <div style="background: ${config.bg}; border: 2px solid ${config.border}; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">${config.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${config.text};">${rec.title || '추천 ' + (idx + 1)}</div>
                                <div style="font-size: 10px; color: ${config.text}; opacity: 0.8;">${rec.category || 'AI 분석'}</div>
                            </div>
                            ${priorityBadge}
                        </div>
                        <!-- 메시지 -->
                        <div style="font-size: 11px; color: #333; line-height: 1.5; margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px;">
                            ${rec.message || ''}
                        </div>
                        <!-- 추천 액션 -->
                        ${rec.action ? '<div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ' + config.border + ';"><div style="font-size: 10px; font-weight: 600; color: ' + config.text + '; margin-bottom: 4px;">💡 실행 가이드</div><div style="font-size: 11px; color: #333; line-height: 1.4;">' + rec.action + '</div></div>' : ''}
                        <!-- 기대 효과 -->
                        ${rec.expected_impact ? '<div style="margin-top: 8px; display: flex; gap: 6px;"><span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #81c784; font-weight: 500;">📈 ' + rec.expected_impact + '</span></div>' : ''}
                    </div>
                `;
            }

            // 4. 채널 성과 순위 (컴팩트 테이블) - 호버 툴팁 적용
            if (topCategories.length > 0) {
                html += `
                    <div class="hoverable-card"
                         data-tooltip-title="채널별 성과 순위"
                         data-tooltip-icon="📊"
                         data-tooltip-insight="ROAS 기준으로 정렬된 상위 5개 채널입니다."
                         data-tooltip-recommendation="🔥 확대: 예산 증액 추천 | ✓ 유지: 현재 전략 유지 | ⚠️ 검토: 개선 필요"
                         style="padding: 16px; background: white; border-radius: 12px; border: 1px solid var(--grey-200);">
                        <div style="font-size: 13px; font-weight: 700; color: var(--grey-900); margin-bottom: 12px;">
                            📊 채널별 성과 순위
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #f5f5f5; border-radius: 8px;">
                                    <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--grey-700);">채널</th>
                                    <th style="padding: 10px 8px; text-align: right; font-weight: 600; color: var(--grey-700);">ROAS</th>
                                    <th style="padding: 10px 8px; text-align: right; font-weight: 600; color: var(--grey-700);">CPA</th>
                                    <th style="padding: 10px 8px; text-align: center; font-weight: 600; color: var(--grey-700);">권장</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                sortedByRoas.slice(0, 5).forEach((cat, idx) => {
                    const roasLevel = cat.roas > 200 ? 'high' : cat.roas > 100 ? 'mid' : 'low';
                    let verdict = '', verdictColor = '', verdictBg = '';
                    if (roasLevel === 'high') {
                        verdict = '🔥 확대'; verdictColor = '#2e7d32'; verdictBg = '#e8f5e9';
                    } else if (roasLevel === 'low') {
                        verdict = '⚠️ 검토'; verdictColor = '#e65100'; verdictBg = '#fff3e0';
                    } else {
                        verdict = '✓ 유지'; verdictColor = '#757575'; verdictBg = '#f5f5f5';
                    }

                    const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';

                    html += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 10px 12px; font-weight: 500;">${medal} ${cat.name}</td>
                            <td style="padding: 10px 8px; text-align: right; font-weight: 700; color: ${roasLevel === 'high' ? '#2e7d32' : roasLevel === 'low' ? '#d32f2f' : 'var(--grey-900)'};">${formatPercent(cat.roas)}</td>
                            <td style="padding: 10px 8px; text-align: right; color: var(--grey-700);">${formatCurrency(cat.cpa)}</td>
                            <td style="padding: 10px 8px; text-align: center;">
                                <span style="display: inline-block; padding: 3px 8px; background: ${verdictBg}; color: ${verdictColor}; border-radius: 10px; font-size: 10px; font-weight: 600;">${verdict}</span>
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            }

            document.getElementById('summaryContent').innerHTML = html;

            // 액션 가이드 탭 이벤트 초기화
            initActionGuideTabs();
        }

        // 액션 가이드 하위 탭 이벤트 핸들러
        function initActionGuideTabs() {
            const tabs = document.querySelectorAll('.action-guide-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.actionTab;

                    // 모든 탭 비활성화
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.background = '#f8f9fa';
                        t.style.color = 'var(--grey-600)';
                        t.style.borderBottom = '2px solid transparent';
                    });

                    // 클릭한 탭 활성화
                    this.classList.add('active');
                    this.style.background = 'white';
                    this.style.color = 'var(--primary-main)';
                    this.style.borderBottom = '2px solid var(--primary-main)';

                    // 모든 컨텐츠 숨기기
                    document.querySelectorAll('.action-guide-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 해당 컨텐츠 표시
                    const contentId = targetTab === 'quickAction' ? 'quickActionContent' : 'aiRecommendContent';
                    const targetContent = document.getElementById(contentId);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                });
            });
        }

        // 탭 1: 성과 기회 분석 (컴팩트 + 스토리텔링)
        function renderOpportunityTab() {
            const periodData = getPeriodData();
            const topCategories = periodData.top_categories || [];
            const summary = periodData.summary || {};
            const productPerformance = periodData.product_performance || [];
            const topAdsets = periodData.top_adsets || [];

            const avgCpa = summary.overall_cpa || 0;
            const avgRoas = summary.overall_roas || 0;

            // 선택된 기간 정보
            const periodLabels = {'full': '전체 기간', '180d': '최근 180일', '90d': '최근 90일'};
            const currentPeriodLabel = periodLabels[currentPeriod] || '전체 기간';

            // ROAS 높은 순으로 정렬
            const sortedByRoas = [...topCategories].sort((a, b) => b.roas - a.roas);
            const goodChannels = sortedByRoas.filter(c => c.roas >= 200);
            const sortedProducts = [...productPerformance].sort((a, b) => b.roas - a.roas);
            const goodProducts = sortedProducts.filter(p => p.roas >= 150);

            let html = '';

            // 인트로 메시지 - 호버 툴팁 적용 (기간 표시 추가)
            html += `
                <div class="hoverable-card"
                     data-tooltip-title="예산 확대 기회"
                     data-tooltip-icon="🎯"
                     data-tooltip-insight="ROAS가 높다는 것은 광고비를 쓸수록 더 많은 매출이 발생한다는 의미입니다."
                     data-tooltip-recommendation="효율이 검증된 곳에 투자를 집중하세요. 예산 증액 시 성과 상승이 기대됩니다."
                     style="margin-bottom: 16px; padding: 16px 20px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 12px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 28px;">🎯</span>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 14px; font-weight: 700; color: #2e7d32;">성과가 좋은 곳에 더 투자하세요</span>
                                <span style="font-size: 10px; color: #4caf50; background: rgba(76, 175, 80, 0.1); padding: 2px 8px; border-radius: 10px; margin-left: auto;">${currentPeriodLabel} 기준</span>
                            </div>
                            <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                아래는 <strong>예산을 늘리면 더 좋은 성과</strong>를 낼 수 있는 채널과 상품입니다.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 1. 확대 추천 채널 (ROAS 200% 이상)
            if (goodChannels.length > 0) {
                html += `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 13px; font-weight: 700; color: var(--grey-900); margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                            🔥 예산 확대 추천 채널
                            <span style="font-size: 10px; color: var(--grey-500); font-weight: 400;">(ROAS 200% 이상)</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                `;

                goodChannels.slice(0, 4).forEach((cat, idx) => {
                    const increasePercent = cat.roas >= 500 ? '20-30%' : cat.roas >= 300 ? '15-20%' : '10-15%';
                    html += `
                        <div style="padding: 14px; background: white; border-radius: 10px; border: 2px solid #4caf50; position: relative;">
                            ${idx === 0 ? '<div style="position: absolute; top: -8px; right: 10px; padding: 2px 8px; background: #4caf50; color: white; font-size: 9px; font-weight: 600; border-radius: 8px;">TOP</div>' : ''}
                            <div style="font-size: 12px; font-weight: 600; color: var(--grey-800); margin-bottom: 8px;">${cat.name}</div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div>
                                    <div style="font-size: 10px; color: var(--grey-500);">ROAS</div>
                                    <div style="font-size: 20px; font-weight: 800; color: #2e7d32;">${formatPercent(cat.roas)}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 9px; color: var(--grey-500);">추천 증액</div>
                                    <div style="font-size: 12px; font-weight: 700; color: #1565c0;">${increasePercent}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            } else {
                html += `
                    <div style="margin-bottom: 16px; padding: 20px; background: #f5f5f5; border-radius: 10px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 8px;">📊</div>
                        <div style="font-size: 13px; color: var(--grey-700);">현재 ROAS 200% 이상 채널이 없습니다</div>
                        <div style="font-size: 11px; color: var(--grey-500); margin-top: 4px;">광고 소재 개선이나 타겟 최적화를 고려해보세요</div>
                    </div>
                `;
            }

            // 2. 효율 좋은 상품 (컴팩트) - 호버 툴팁 적용
            if (goodProducts.length > 0) {
                html += `
                    <div class="hoverable-card"
                         data-tooltip-title="효율 좋은 상품"
                         data-tooltip-icon="🛍️"
                         data-tooltip-insight="ROAS 150% 이상인 상품들입니다."
                         data-tooltip-recommendation="이 상품들의 광고를 더 활성화하면 전체 성과가 개선됩니다."
                         style="margin-bottom: 16px; padding: 14px; background: #f5f5f5; border-radius: 10px;">
                        <div style="font-size: 12px; font-weight: 700; color: var(--grey-900); margin-bottom: 10px;">
                            🛍️ 효율 좋은 상품
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                `;

                goodProducts.slice(0, 5).forEach(prod => {
                    html += `
                        <div style="padding: 6px 12px; background: white; border-radius: 16px; font-size: 11px; display: flex; align-items: center; gap: 6px;">
                            <span style="font-weight: 600; color: var(--grey-800);">${prod.product}</span>
                            <span style="color: #2e7d32; font-weight: 700;">${formatPercent(prod.roas)}</span>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // 3. TOP 광고세트 (데이터 색상 스케일 포함)
            if (topAdsets.length > 0) {
                // ROAS 최대값 계산 (스케일 바용)
                const maxRoas = Math.max(...topAdsets.slice(0, 5).map(a => a.roas || 0));

                html += `
                    <div style="border: 1px solid var(--grey-200); border-radius: 10px; overflow: hidden;">
                        <div style="padding: 10px 14px; background: #fafafa; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';">
                            <span style="font-size: 12px; font-weight: 600; color: var(--grey-800);">📈 성과 TOP 광고세트 (상위 5개)</span>
                            <span class="toggle-icon" style="font-size: 10px; color: var(--grey-500);">▶</span>
                        </div>
                        <div style="display: none; padding: 12px;">
                            <!-- 색상 범례 -->
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; flex-wrap: wrap;">
                                <span style="font-size: 10px; color: var(--grey-600); font-weight: 600;">ROAS 스케일:</span>
                                <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <div style="width: 14px; height: 14px; background: linear-gradient(90deg, #4caf50, #81c784); border-radius: 3px;"></div>
                                        <span style="font-size: 10px; color: #2e7d32; font-weight: 600;">500%+</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <div style="width: 14px; height: 14px; background: linear-gradient(90deg, #8bc34a, #aed581); border-radius: 3px;"></div>
                                        <span style="font-size: 10px; color: #558b2f; font-weight: 600;">300%</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <div style="width: 14px; height: 14px; background: linear-gradient(90deg, #ffeb3b, #fff176); border-radius: 3px;"></div>
                                        <span style="font-size: 10px; color: #f57f17; font-weight: 600;">200%</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <div style="width: 14px; height: 14px; background: linear-gradient(90deg, #ff9800, #ffb74d); border-radius: 3px;"></div>
                                        <span style="font-size: 10px; color: #e65100; font-weight: 600;">100%</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 3px;">
                                        <div style="width: 14px; height: 14px; background: linear-gradient(90deg, #ef5350, #e57373); border-radius: 3px;"></div>
                                        <span style="font-size: 10px; color: #c62828; font-weight: 600;">&lt;100%</span>
                                    </div>
                                </div>
                            </div>
                `;

                topAdsets.slice(0, 5).forEach((adset, idx) => {
                    // ROAS 기반 색상 계산
                    const roas = adset.roas || 0;
                    let barColor, textColor, barWidth;

                    if (roas >= 500) {
                        barColor = 'linear-gradient(90deg, #4caf50, #81c784)';
                        textColor = '#2e7d32';
                    } else if (roas >= 300) {
                        barColor = 'linear-gradient(90deg, #8bc34a, #aed581)';
                        textColor = '#558b2f';
                    } else if (roas >= 200) {
                        barColor = 'linear-gradient(90deg, #ffeb3b, #fff176)';
                        textColor = '#f57f17';
                    } else if (roas >= 100) {
                        barColor = 'linear-gradient(90deg, #ff9800, #ffb74d)';
                        textColor = '#e65100';
                    } else {
                        barColor = 'linear-gradient(90deg, #ef5350, #e57373)';
                        textColor = '#c62828';
                    }

                    // 스케일 바 너비 계산 (최대 100%)
                    barWidth = Math.min((roas / maxRoas) * 100, 100);

                    html += `
                        <div style="margin-bottom: 10px; padding: 10px 12px; background: #fafafa; border-radius: 8px; position: relative; overflow: hidden;">
                            <!-- 배경 스케일 바 -->
                            <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${barWidth}%; background: ${barColor}; opacity: 0.15; border-radius: 8px;"></div>
                            <div style="position: relative; z-index: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 11px; font-weight: 600; color: var(--grey-800); display: flex; align-items: center; gap: 6px;">
                                            <span style="width: 18px; height: 18px; background: ${barColor}; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 700;">${idx + 1}</span>
                                            ${adset.adset}
                                        </div>
                                        <div style="font-size: 10px; color: var(--grey-500); margin-top: 2px; margin-left: 24px;">${adset.category}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: 800; color: ${textColor};">${formatPercent(roas)}</div>
                                        <div style="font-size: 9px; color: var(--grey-500);">ROAS</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // 4. 액션 가이드
            html += `
                <div style="margin-top: 16px; padding: 12px 14px; background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%); border-radius: 10px; border-left: 3px solid #ffc107;">
                    <div style="font-size: 11px; font-weight: 600; color: #f57f17; margin-bottom: 6px;">💡 이렇게 실행하세요</div>
                    <div style="font-size: 11px; color: var(--grey-800); line-height: 1.7;">
                        1. 🔥 표시된 채널의 일일 예산을 <strong>10-20%</strong> 늘려보세요<br>
                        2. 효율 좋은 상품 광고의 <strong>노출을 확대</strong>하세요<br>
                        3. 3-5일 후 성과를 확인하고 추가 조정하세요
                    </div>
                </div>
            `;

            document.getElementById('opportunityContent').innerHTML = html;
        }

        // 탭 2: 예산 투자 가이드 (Compact + ROAS/CPA 인사이트)
        function renderBudgetGuideTab() {
            const periodData = getPeriodData();
            const recommendations = periodData.recommendations || [];
            const forecast = periodData.prophet_forecast || null;
            const topCategories = periodData.top_categories || [];
            const productPerformance = periodData.product_performance || [];
            const summary = periodData.summary || {};

            let html = '';
            const avgCpa = summary.overall_cpa || 0;
            const avgRoas = summary.overall_roas || 0;

            // 1. 투자 의사결정 매트릭스 (ROAS vs CPA)
            html += `
                <div style="margin-bottom: 16px; padding: 14px; background: #f5f5f5; border-radius: 10px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--grey-800); margin-bottom: 10px;">💡 투자 의사결정 기준</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 10px;">
                        <div style="padding: 8px; background: #e8f5e9; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #2e7d32;">🔥 확대</div>
                            <div style="color: var(--grey-700);">ROAS 200%↑<br>CPA 평균↓</div>
                        </div>
                        <div style="padding: 8px; background: #fff8e1; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #f57c00;">✓ 유지</div>
                            <div style="color: var(--grey-700);">ROAS 100-200%<br>CPA 평균</div>
                        </div>
                        <div style="padding: 8px; background: #ffebee; border-radius: 6px; text-align: center;">
                            <div style="font-weight: 700; color: #d32f2f;">⚠️ 검토</div>
                            <div style="color: var(--grey-700);">ROAS 100%↓<br>CPA 평균↑</div>
                        </div>
                    </div>
                </div>
            `;

            // 2. 채널별 투자 우선순위 (접기/펼치기)
            html += `
                <div style="margin-bottom: 16px; border: 1px solid var(--grey-200); border-radius: 10px; overflow: hidden;">
                    <div style="padding: 12px 16px; background: #e3f2fd; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                         onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';">
                        <span style="font-size: 13px; font-weight: 600; color: #0d47a1;">💰 채널별 투자 우선순위</span>
                        <span class="toggle-icon" style="font-size: 10px; color: var(--grey-500);">▼</span>
                    </div>
                    <div style="padding: 12px;">
            `;

            topCategories.slice(0, 5).forEach((cat, idx) => {
                const roasLevel = cat.roas > 200 ? 'high' : cat.roas > 100 ? 'mid' : 'low';
                const cpaLevel = cat.cpa < avgCpa ? 'good' : 'bad';
                let action = '', actionColor = '', actionBg = '';

                if (roasLevel === 'high' && cpaLevel === 'good') {
                    action = '🔥 적극 확대 (예산 +20%)'; actionColor = '#2e7d32'; actionBg = '#e8f5e9';
                } else if (roasLevel === 'high') {
                    action = '📈 확대 (예산 +10%)'; actionColor = '#1976d2'; actionBg = '#e3f2fd';
                } else if (roasLevel === 'low') {
                    action = '⚠️ 최적화 필요'; actionColor = '#d32f2f'; actionBg = '#ffebee';
                } else {
                    action = '✓ 현상 유지'; actionColor = '#757575'; actionBg = '#f5f5f5';
                }

                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                        <div style="flex: 1;">
                            <div style="font-size: 12px; font-weight: 600; color: var(--grey-900);">${idx + 1}. ${cat.name}</div>
                            <div style="font-size: 10px; color: var(--grey-600);">ROAS ${formatPercent(cat.roas)} | CPA ${formatCurrency(cat.cpa)}</div>
                        </div>
                        <div style="padding: 4px 10px; background: ${actionBg}; border-radius: 12px; font-size: 10px; color: ${actionColor}; font-weight: 600;">
                            ${action}
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;

            // 3. CPA 효율 순위 (접기/펼치기)
            if (topCategories.length > 0) {
                const sortedByCpa = [...topCategories].sort((a, b) => a.cpa - b.cpa);
                html += `
                    <div style="margin-bottom: 16px; border: 1px solid var(--grey-200); border-radius: 10px; overflow: hidden;">
                        <div style="padding: 12px 16px; background: #e8f5e9; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';">
                            <span style="font-size: 13px; font-weight: 600; color: #1b5e20;">💸 CPA 효율 순위 (전환당 비용 낮은 순)</span>
                            <span class="toggle-icon" style="font-size: 10px; color: var(--grey-500);">▶</span>
                        </div>
                        <div style="padding: 12px; display: none;">
                `;

                sortedByCpa.slice(0, 5).forEach((cat, idx) => {
                    const efficiency = cat.cpa < avgCpa ? '효율적' : '비효율적';
                    const effColor = cat.cpa < avgCpa ? '#2e7d32' : '#f57c00';
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <div>
                                <span style="font-size: 12px; font-weight: 600;">${idx + 1}. ${cat.name}</span>
                                <span style="font-size: 10px; color: ${effColor}; margin-left: 8px;">(${efficiency})</span>
                            </div>
                            <div style="font-size: 14px; font-weight: 700; color: #1b5e20;">${formatCurrency(cat.cpa)}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // 4. AI 예측 기반 추천 (있을 경우만)
            if (forecast && (forecast.by_category || forecast.by_product)) {
                html += `
                    <div style="margin-bottom: 16px; border: 1px solid #e1bee7; border-radius: 10px; overflow: hidden;">
                        <div style="padding: 12px 16px; background: #f3e5f5; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';">
                            <span style="font-size: 13px; font-weight: 600; color: #6a1b9a;">🔮 AI 예측 기반 추천</span>
                            <span class="toggle-icon" style="font-size: 10px; color: var(--grey-500);">▶</span>
                        </div>
                        <div style="padding: 12px; display: none;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                `;

                if (forecast.by_category) {
                    const upCategory = forecast.by_category.find(c => c.trend_direction === '상승');
                    if (upCategory) {
                        html += `
                            <div style="padding: 10px; background: #fce4ec; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #c2185b;">상승 예측 채널</div>
                                <div style="font-size: 12px; font-weight: 700; color: var(--grey-900);">${upCategory.category}</div>
                            </div>
                        `;
                    }
                }

                if (forecast.by_product && forecast.by_product.length > 0) {
                    const topProd = [...forecast.by_product].sort((a, b) => b.total_30day_forecast - a.total_30day_forecast)[0];
                    if (topProd) {
                        html += `
                            <div style="padding: 10px; background: #e8f5e9; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #2e7d32;">추천 상품</div>
                                <div style="font-size: 12px; font-weight: 700; color: var(--grey-900);">${topProd.product}</div>
                            </div>
                        `;
                    }
                }

                html += `</div></div></div>`;
            }

            // 5. 실행 체크리스트 (Compact)
            html += `
                <div style="padding: 12px 14px; background: #fff8e1; border-radius: 8px; border-left: 3px solid #ffc107;">
                    <div style="font-size: 11px; font-weight: 600; color: #f57f17; margin-bottom: 6px;">✅ 이번 주 체크리스트</div>
                    <div style="font-size: 10px; color: var(--grey-800); line-height: 1.7;">
                        □ ROAS 200%↑ 채널 예산 증액<br>
                        □ CPA 평균 초과 채널 타겟팅 재검토<br>
                        □ 비효율 캠페인 크리에이티브 교체
                    </div>
                </div>
            `;

            const budgetGuideEl = document.getElementById('budgetGuideContent');
            if (budgetGuideEl) {
                budgetGuideEl.innerHTML = html;
            }
        }

        // 탭 2: 주의 필요 (경고) - 사용자 친화적 버전
        function renderWarningTab() {
            const periodData = getPeriodData();
            if (!periodData) return;

            const allAlerts = periodData.alerts || [];
            const warnings = allAlerts.filter(a => a.severity === 'warning' || a.severity === 'high');
            const topCategories = periodData.top_categories || [];
            const summary = periodData.summary || {};
            const productPerformance = periodData.product_performance || [];

            const avgCpa = summary.overall_cpa || 0;
            const highCpaCategories = topCategories.filter(cat => cat.cpa > avgCpa * 1.5);
            const lowRoasCategories = topCategories.filter(cat => cat.roas < 100);
            const lowRoasProducts = productPerformance.filter(prod => prod.roas < 100);
            const totalIssues = highCpaCategories.length + lowRoasCategories.length + lowRoasProducts.length + warnings.length;

            let html = '';

            // 인트로 메시지
            if (totalIssues === 0) {
                html += `
                    <div style="padding: 40px 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🎉</div>
                        <div style="font-size: 18px; font-weight: 700; color: #2e7d32; margin-bottom: 8px;">모든 광고가 잘 돌아가고 있어요!</div>
                        <div style="font-size: 13px; color: var(--grey-600); line-height: 1.6;">
                            현재 특별히 주의가 필요한 항목이 없습니다.<br>
                            계속해서 좋은 성과를 유지해주세요.
                        </div>
                    </div>
                `;
                document.getElementById('warningContent').innerHTML = html;
                return;
            }

            // 선택된 기간 정보
            const periodLabels = {'full': '전체 기간', '180d': '최근 180일', '90d': '최근 90일'};
            const currentPeriodLabel = periodLabels[currentPeriod] || '전체 기간';

            // 경고 있을 때 인트로 - 호버 툴팁 적용 (기간 표시 추가)
            html += `
                <div class="hoverable-card"
                     data-tooltip-title="주의 필요 항목"
                     data-tooltip-icon="⚠️"
                     data-tooltip-insight="ROAS가 100% 미만이면 광고비보다 매출이 적다는 의미입니다."
                     data-tooltip-recommendation="계속 두면 손해가 커질 수 있어요. 빨리 조치하면 손실을 줄일 수 있습니다."
                     style="margin-bottom: 16px; padding: 16px 20px; background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%); border-radius: 12px; border-left: 4px solid #ef5350;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 28px;">⚠️</span>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 14px; font-weight: 700; color: #c62828;">확인이 필요한 항목이 있어요</span>
                                <span style="font-size: 10px; color: #ef5350; background: rgba(239, 83, 80, 0.1); padding: 2px 8px; border-radius: 10px; margin-left: auto;">${currentPeriodLabel} 기준</span>
                            </div>
                            <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                아래 항목들은 <strong>예산 낭비</strong>가 발생할 수 있어요. 빨리 조치하면 손실을 줄일 수 있습니다.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 서브탭 구현 - AI 분석 경고, CPA 높음, 비효율 상품
            const hasAiAlerts = warnings.length > 0;
            const hasHighCpa = highCpaCategories.length > 0;
            const hasLowRoasProducts = lowRoasProducts.length > 0;
            const firstActiveTab = hasAiAlerts ? 'aiAlert' : (hasHighCpa ? 'cpa' : (hasLowRoasProducts ? 'products' : 'cpa'));

            html += `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 8px; border-bottom: 2px solid var(--grey-200); padding-bottom: 0; flex-wrap: wrap;">
            `;

            // AI 분석 경고 탭
            if (hasAiAlerts) {
                html += `
                    <button class="warning-subtab ${firstActiveTab === 'aiAlert' ? 'active' : ''}" data-warning-tab="aiAlert"
                            style="padding: 10px 16px; font-size: 12px; font-weight: 600; border: none; background: ${firstActiveTab === 'aiAlert' ? '#ffebee' : 'transparent'};
                                   color: ${firstActiveTab === 'aiAlert' ? '#d32f2f' : 'var(--grey-600)'}; cursor: pointer; border-radius: 8px 8px 0 0;
                                   border-bottom: ${firstActiveTab === 'aiAlert' ? '3px solid #d32f2f' : '3px solid transparent'}; margin-bottom: -2px;
                                   transition: all 0.2s ease;">
                        🚨 AI 분석 경고 ${warnings.length}개
                    </button>
                `;
            }

            // CPA 높음 탭
            if (hasHighCpa) {
                html += `
                    <button class="warning-subtab ${firstActiveTab === 'cpa' ? 'active' : ''}" data-warning-tab="cpa"
                            style="padding: 10px 16px; font-size: 12px; font-weight: 600; border: none; background: ${firstActiveTab === 'cpa' ? '#fff3e0' : 'transparent'};
                                   color: ${firstActiveTab === 'cpa' ? '#e65100' : 'var(--grey-600)'}; cursor: pointer; border-radius: 8px 8px 0 0;
                                   border-bottom: ${firstActiveTab === 'cpa' ? '3px solid #e65100' : '3px solid transparent'}; margin-bottom: -2px;
                                   transition: all 0.2s ease;">
                        🟠 CPA 높음 ${highCpaCategories.length}개
                    </button>
                `;
            }

            // 비효율 상품 탭
            if (hasLowRoasProducts) {
                html += `
                    <button class="warning-subtab ${firstActiveTab === 'products' ? 'active' : ''}" data-warning-tab="products"
                            style="padding: 10px 16px; font-size: 12px; font-weight: 600; border: none; background: ${firstActiveTab === 'products' ? '#f3e5f5' : 'transparent'};
                                   color: ${firstActiveTab === 'products' ? '#7b1fa2' : 'var(--grey-600)'}; cursor: pointer; border-radius: 8px 8px 0 0;
                                   border-bottom: ${firstActiveTab === 'products' ? '3px solid #7b1fa2' : '3px solid transparent'}; margin-bottom: -2px;
                                   transition: all 0.2s ease;">
                        🟣 비효율 상품 ${lowRoasProducts.length}개
                    </button>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            // AI 분석 경고 컨텐츠 (default 3개 노출 + 접기/펼치기)
            if (hasAiAlerts) {
                // severity 기준 정렬 (high > warning > 기타)
                const severityOrder = { 'high': 0, 'warning': 1 };
                const sortedWarnings = [...warnings].sort((a, b) => {
                    const orderA = severityOrder[a.severity] !== undefined ? severityOrder[a.severity] : 2;
                    const orderB = severityOrder[b.severity] !== undefined ? severityOrder[b.severity] : 2;
                    return orderA - orderB;
                });
                const visibleAlerts = sortedWarnings.slice(0, 3);
                const hiddenAlerts = sortedWarnings.slice(3);

                html += `<div id="warningTabAiAlert" class="warning-tab-content" style="display: ${firstActiveTab === 'aiAlert' ? 'block' : 'none'};">`;
                html += `
                    <div style="padding: 14px; background: white; border-radius: 10px; border: 1px solid #ffcdd2;">
                        <div style="font-size: 12px; font-weight: 700; color: #d32f2f; margin-bottom: 12px;">
                            🚨 AI가 감지한 경고 알림
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                `;

                // 헬퍼 함수: 경고 카드 렌더링
                function renderAlertCard(alert) {
                    const severityConfig = {
                        'positive': { border: '#4caf50', bg: '#e8f5e9', text: '#2e7d32', badge: '핵심', icon: '👑' },
                        'high': { border: '#f44336', bg: '#ffebee', text: '#c62828', badge: '긴급', icon: '🚨' },
                        'warning': { border: '#ff9800', bg: '#fff3e0', text: '#e65100', badge: '주의', icon: '⚠️' },
                        'opportunity': { border: '#2196f3', bg: '#e3f2fd', text: '#1565c0', badge: '기회', icon: '💎' }
                    };
                    const config = severityConfig[alert.severity] || severityConfig['warning'];

                    // 타입별 한국어 제목 매핑
                    const typeTitleMap = {
                        'forecast_underperformance': '예측 대비 실적 미달',
                        'low_roas': '낮은 ROAS 경고',
                        'high_cpa': '높은 CPA 경고',
                        'budget_waste': '예산 낭비 가능성',
                        'performance_drop': '성과 하락 감지'
                    };
                    const alertTitle = alert.title || typeTitleMap[alert.type] || '경고';

                    let cardHtml = `
                        <div style="background: ${config.bg}; border: 2px solid ${config.border}; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">${config.icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: ${config.text};">${alertTitle}</div>
                                    <div style="font-size: 10px; color: ${config.text}; opacity: 0.8;">AI 분석</div>
                                </div>
                                <span style="background: ${config.border}; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">${config.badge}</span>
                            </div>
                            <!-- 메시지 -->
                            <div style="font-size: 11px; color: #333; line-height: 1.5; margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.6); border-radius: 6px;">
                                ${alert.message || ''}
                            </div>
                    `;

                    // Financial Impact 표시 (메트릭스 배지 스타일)
                    if (alert.financial_impact) {
                        const fi = alert.financial_impact;
                        cardHtml += `
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                ${fi.loss_amount ? '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #c62828; border: 1px solid #ef9a9a; font-weight: 500;">예상 손실 ' + fi.loss_amount + '</span>' : ''}
                                ${fi.potential_uplift ? '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #81c784; font-weight: 500;">기대 수익 ' + fi.potential_uplift + '</span>' : ''}
                            </div>
                        `;
                    }

                    // Action 가이드 표시
                    if (alert.action) {
                        cardHtml += `
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${config.border};">
                                <div style="font-size: 10px; font-weight: 600; color: ${config.text}; margin-bottom: 4px;">💡 실행 가이드</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${alert.action}</div>
                            </div>
                        `;
                    }

                    cardHtml += `</div>`;
                    return cardHtml;
                }

                // 기본 노출 카드 (3개)
                visibleAlerts.forEach((alert) => {
                    html += renderAlertCard(alert);
                });

                html += `</div>`;

                // 추가 카드 (접기/펼치기) - 더보기/접기 버튼 분리
                if (hiddenAlerts.length > 0) {
                    const alertsToggleId = 'alertsToggle_' + Date.now();
                    html += `
                        <div id="${alertsToggleId}_showMore" style="text-align: center; margin-top: 12px;">
                            <button class="show-more-btn warning-style" onclick="document.getElementById('${alertsToggleId}_content').style.display='block'; document.getElementById('${alertsToggleId}_showMore').style.display='none';">
                                더 보기 (${hiddenAlerts.length}건)
                            </button>
                        </div>
                        <div id="${alertsToggleId}_content" style="display: none; margin-top: 12px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                    `;
                    hiddenAlerts.forEach((alert) => {
                        html += renderAlertCard(alert);
                    });
                    html += `
                            </div>
                            <div style="text-align: center; margin-top: 12px;">
                                <button class="show-more-btn warning-style" onclick="document.getElementById('${alertsToggleId}_content').style.display='none'; document.getElementById('${alertsToggleId}_showMore').style.display='block';">
                                    접기
                                </button>
                            </div>
                        </div>`;
                }

                html += `</div></div>`;
            }

            // CPA 높은 채널 컨텐츠 (default 3개 노출 + 접기/펼치기)
            if (hasHighCpa) {
                const visibleCpa = highCpaCategories.slice(0, 3);
                const hiddenCpa = highCpaCategories.slice(3);

                html += `<div id="warningTabCpa" class="warning-tab-content" style="display: ${firstActiveTab === 'cpa' ? 'block' : 'none'};">`;
                html += `
                    <div class="hoverable-card"
                         data-tooltip-title="CPA 높은 채널"
                         data-tooltip-icon="🟠"
                         data-tooltip-insight="한 번의 구매/전환을 얻는 데 드는 비용이 평균보다 훨씬 높다는 의미입니다."
                         data-tooltip-recommendation="입찰 금액 조정 또는 타겟 정밀화를 고려하세요."
                         style="margin-bottom: 12px; padding: 14px; background: white; border-radius: 10px; border: 1px solid #ffe0b2;">
                        <div style="font-size: 12px; font-weight: 700; color: #e65100; margin-bottom: 10px;">
                            🟠 전환 비용이 너무 높은 채널
                        </div>
                `;

                // 헬퍼 함수: CPA 카드 렌더링
                function renderCpaCard(cat) {
                    const cpaRatio = ((cat.cpa / avgCpa - 1) * 100).toFixed(0);
                    return `
                        <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 14px; margin-bottom: 10px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">💰</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: #e65100;">${cat.name}</div>
                                    <div style="font-size: 10px; color: #e65100; opacity: 0.8;">CPA 초과</div>
                                </div>
                                <span style="background: #ff9800; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">+${cpaRatio}%</span>
                            </div>
                            <!-- 메트릭스 배지 -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #e65100; border: 1px solid #ffcc80; font-weight: 500;">CPA ${formatCurrency(cat.cpa)}</span>
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">평균 ${formatCurrency(avgCpa)}</span>
                            </div>
                        </div>
                    `;
                }

                // 기본 노출 (3개)
                visibleCpa.forEach(cat => {
                    html += renderCpaCard(cat);
                });

                // 추가 항목 (접기/펼치기) - 더보기/접기 버튼 분리
                if (hiddenCpa.length > 0) {
                    const cpaToggleId = 'cpaToggle_' + Date.now();
                    html += `
                        <div id="${cpaToggleId}_showMore" style="text-align: center; margin-top: 12px;">
                            <button class="show-more-btn caution-style" onclick="document.getElementById('${cpaToggleId}_content').style.display='block'; document.getElementById('${cpaToggleId}_showMore').style.display='none';">
                                더 보기 (${hiddenCpa.length}건)
                            </button>
                        </div>
                        <div id="${cpaToggleId}_content" style="display: none; margin-top: 8px;">
                    `;
                    hiddenCpa.forEach(cat => {
                        html += renderCpaCard(cat);
                    });
                    html += `
                            <div style="text-align: center; margin-top: 12px;">
                                <button class="show-more-btn caution-style" onclick="document.getElementById('${cpaToggleId}_content').style.display='none'; document.getElementById('${cpaToggleId}_showMore').style.display='block';">
                                    접기
                                </button>
                            </div>
                        </div>`;
                }

                html += `
                        <div style="margin-top: 10px; padding: 10px; background: #fff8f0; border-radius: 8px;">
                            <div style="font-size: 11px; font-weight: 600; color: #e65100; margin-bottom: 4px;">💡 이렇게 해보세요</div>
                            <div style="font-size: 10px; color: var(--grey-700); line-height: 1.6;">
                                • 입찰 금액을 낮춰보세요<br>
                                • 더 정확한 타겟에게만 광고를 노출하세요
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            // 비효율 상품 컨텐츠
            if (hasLowRoasProducts) {
                html += `<div id="warningTabProducts" class="warning-tab-content" style="display: ${firstActiveTab === 'products' ? 'block' : 'none'};">`;
                html += `<div style="display: flex; flex-direction: column; gap: 10px;">`;

                lowRoasProducts.forEach(prod => {
                    html += `
                        <div style="background: #f3e5f5; border: 2px solid #9c27b0; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">📦</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: #7b1fa2;">${prod.product}</div>
                                    <div style="font-size: 10px; color: #7b1fa2; opacity: 0.8;">비효율 상품</div>
                                </div>
                                <span style="background: #9c27b0; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">REVIEW</span>
                            </div>
                            <!-- 메트릭스 배지 -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #7b1fa2; border: 1px solid #ce93d8; font-weight: 500;">ROAS ${formatPercent(prod.roas)}</span>
                                ${prod.cost ? '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">비용 ' + formatCurrency(prod.cost) + '</span>' : ''}
                            </div>
                            <!-- 추천 액션 -->
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #9c27b0;">
                                <div style="font-size: 10px; font-weight: 600; color: #7b1fa2; margin-bottom: 4px;">💡 추천 액션</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">광고보다 프로모션/할인이 더 효과적일 수 있어요</div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            document.getElementById('warningContent').innerHTML = html;

            // 서브탭 클릭 이벤트 초기화
            initWarningSubtabs();
        }

        // 주의 필요 탭의 서브탭 이벤트 핸들러
        function initWarningSubtabs() {
            const subtabs = document.querySelectorAll('.warning-subtab');
            subtabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.warningTab;

                    // 모든 탭 비활성화
                    subtabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.background = 'transparent';
                        t.style.color = 'var(--grey-600)';
                        t.style.borderBottom = '3px solid transparent';
                    });

                    // 클릭한 탭 활성화
                    this.classList.add('active');
                    if (targetTab === 'aiAlert') {
                        this.style.background = '#ffebee';
                        this.style.color = '#d32f2f';
                        this.style.borderBottom = '3px solid #d32f2f';
                    } else if (targetTab === 'cpa') {
                        this.style.background = '#fff3e0';
                        this.style.color = '#e65100';
                        this.style.borderBottom = '3px solid #e65100';
                    } else if (targetTab === 'products') {
                        this.style.background = '#f3e5f5';
                        this.style.color = '#7b1fa2';
                        this.style.borderBottom = '3px solid #7b1fa2';
                    }

                    // 모든 컨텐츠 숨기기
                    document.querySelectorAll('.warning-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // 해당 컨텐츠 표시
                    const contentIdMap = {
                        'aiAlert': 'warningTabAiAlert',
                        'cpa': 'warningTabCpa',
                        'products': 'warningTabProducts'
                    };
                    const contentId = contentIdMap[targetTab] || 'warningTabCpa';
                    const targetContent = document.getElementById(contentId);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                });
            });
        }

        // 4분면 매트릭스 배지 렌더링 헬퍼 함수
        function renderMatrixBadge(matrixType) {
            const badges = {
                'core_driver': { label: '핵심 동력', bg: '#2e7d32', icon: '👑' },
                'efficiency_star': { label: '효율 스타', bg: '#1976d2', icon: '💎' },
                'budget_bleeder': { label: '예산 누수', bg: '#d32f2f', icon: '💸' },
                'underperformer': { label: '성과 부진', bg: '#ff9800', icon: '💤' }
            };
            const badge = badges[matrixType];
            if (!badge) return '';
            return `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px;
                    background: ${badge.bg}; color: white; border-radius: 12px; font-size: 10px; font-weight: 600;">
                    ${badge.icon} ${badge.label}</span>`;
        }

        // 4분면 인사이트를 기존 성과 데이터와 매칭
        function getMatrixInsightForTarget(matrixInsights, targetValue) {
            if (!matrixInsights || !Array.isArray(matrixInsights)) return null;
            return matrixInsights.find(m => m.target === targetValue);
        }

        // 탭 3: 타겟 분석 - 사용자 친화적 버전
        function renderTargetingTab() {
            const periodData = getPeriodData();
            const genderData = (periodData.gender_performance || []).filter(g => isValidGender(g.gender));
            const genderMatrixInsights = periodData.gender_matrix_insights || [];  // 4분면 인사이트
            const deviceData = (periodData.device_performance || []).filter(d =>
                d.device && d.device.toLowerCase() !== 'uncategorized' && d.device.toLowerCase() !== 'unknown'
            );
            const deviceMatrixInsights = periodData.device_matrix_insights || [];  // 4분면 인사이트
            const devicePlatformData = (periodData.deviceplatform_performance || []).filter(d =>
                d.deviceplatform && d.deviceplatform.toLowerCase() !== 'uncategorized' && d.deviceplatform.toLowerCase() !== 'unknown'
            );
            const deviceplatformMatrixInsights = periodData.deviceplatform_matrix_insights || [];  // 4분면 인사이트
            const ageGenderData = (periodData.age_gender_combinations || []).filter(item =>
                isValidGender(item.gender) && isValidAge(item.age)
            );
            const summary = periodData.summary || {};
            const avgCpa = summary.overall_cpa || 0;

            // 선택된 기간 정보
            const periodLabels = {'full': '전체 기간', '180d': '최근 180일', '90d': '최근 90일'};
            const currentPeriodLabel = periodLabels[currentPeriod] || '전체 기간';

            let html = '';

            // 인트로 메시지 - 호버 툴팁 적용 (기간 표시 추가)
            html += `
                <div class="hoverable-card"
                     data-tooltip-title="타겟 분석"
                     data-tooltip-icon="👥"
                     data-tooltip-insight="광고를 특정 그룹(성별, 나이, 관심사 등)에게만 보여주는 것을 타겟팅이라고 합니다."
                     data-tooltip-recommendation="효율적인 타겟에 집중하면 같은 비용으로 더 많은 성과를 얻을 수 있어요."
                     style="margin-bottom: 16px; padding: 16px 20px; background: linear-gradient(135deg, #e8eaf6 0%, #f5f5ff 100%); border-radius: 12px; border-left: 4px solid #5c6bc0;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 28px;">👥</span>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 14px; font-weight: 700; color: #3949ab;">누구에게 광고를 보여줘야 효과적일까요?</span>
                                <span style="font-size: 10px; color: #5c6bc0; background: rgba(92, 107, 192, 0.1); padding: 2px 8px; border-radius: 10px; margin-left: auto;">${currentPeriodLabel} 기준</span>
                            </div>
                            <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                성별, 연령, 기기별로 <strong>어떤 고객이 가장 잘 반응하는지</strong> 분석했습니다.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 1. 핵심 타겟 요약 (큰 카드)
            const topGender = genderData.length > 0 ? [...genderData].sort((a, b) => b.roas - a.roas)[0] : null;
            const topDevice = deviceData.length > 0 ? [...deviceData].sort((a, b) => b.roas - a.roas)[0] : null;
            const topAgeGender = ageGenderData.length > 0 ? ageGenderData[0] : null;

            html += `
                <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 12px; border: 1px solid var(--grey-200);">
                    <div style="font-size: 13px; font-weight: 700; color: var(--grey-900); margin-bottom: 12px;">🏆 가장 효과적인 타겟</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            `;

            // 최고 성별
            if (topGender) {
                const normalizedGender = normalizeGender(topGender.gender) || topGender.gender;
                html += `
                    <div style="padding: 12px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 10px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 4px;">👤</div>
                        <div style="font-size: 10px; color: var(--grey-500); margin-bottom: 2px;">성별</div>
                        <div style="font-size: 16px; font-weight: 800; color: #2e7d32;">${normalizedGender}</div>
                        <div style="font-size: 11px; color: var(--grey-600); margin-top: 4px;">ROAS ${formatPercent(topGender.roas)}</div>
                    </div>
                `;
            }

            // 최고 기기유형
            if (topDevice) {
                html += `
                    <div style="padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); border-radius: 10px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 4px;">📱</div>
                        <div style="font-size: 10px; color: var(--grey-500); margin-bottom: 2px;">기기</div>
                        <div style="font-size: 16px; font-weight: 800; color: #1565c0;">${topDevice.device}</div>
                        <div style="font-size: 11px; color: var(--grey-600); margin-top: 4px;">ROAS ${formatPercent(topDevice.roas)}</div>
                    </div>
                `;
            }

            // 최고 연령×성별
            if (topAgeGender) {
                const normalizedGender = normalizeGender(topAgeGender.gender) || topAgeGender.gender;
                html += `
                    <div style="padding: 12px; background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%); border-radius: 10px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 4px;">🎯</div>
                        <div style="font-size: 10px; color: var(--grey-500); margin-bottom: 2px;">최고 조합</div>
                        <div style="font-size: 14px; font-weight: 800; color: #7b1fa2;">${topAgeGender.age}</div>
                        <div style="font-size: 11px; color: var(--grey-600);">${normalizedGender}</div>
                    </div>
                `;
            }

            html += `</div></div>`;

            // 2. 성별 비교 (시각적) - 4분면 매트릭스 적용
            if (genderData.length > 0) {
                html += `
                    <div class="hoverable-card"
                         data-tooltip-title="성별 비교"
                         data-tooltip-icon="👥"
                         data-tooltip-insight="같은 광고를 봤을 때 남성과 여성 중 누가 더 잘 구매했는지 비교합니다."
                         data-tooltip-recommendation="효율이 높은 성별에 예산을 집중하면 성과가 개선됩니다."
                         style="margin-bottom: 12px; padding: 14px; background: white; border-radius: 10px; border: 1px solid var(--grey-200);">
                        <div style="font-size: 12px; font-weight: 700; color: var(--grey-900); margin-bottom: 12px;">
                            👥 성별 비교 <span style="font-size: 10px; color: var(--grey-500); font-weight: 400;"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;">
                `;

                const sortedGender = [...genderData].sort((a, b) => b.roas - a.roas);
                sortedGender.forEach((g, idx) => {
                    const normalizedGender = normalizeGender(g.gender) || g.gender;
                    const cpa = g.conversions > 0 ? g.cost / g.conversions : 0;

                    // 4분면 인사이트 매칭
                    const matrixInsight = getMatrixInsightForTarget(genderMatrixInsights, normalizedGender);
                    const matrixType = matrixInsight ? matrixInsight.sub_type : null;
                    const matrixAction = matrixInsight ? matrixInsight.action : null;

                    // 색상 결정 (4분면 기반)
                    let bgColor = '#f5f5f5';
                    let borderColor = '#e0e0e0';
                    let textColor = '#616161';
                    let badgeColor = '#9e9e9e';
                    let badgeText = '';
                    let icon = '👤';
                    if (matrixType === 'core_driver') {
                        bgColor = '#e8f5e9'; borderColor = '#4caf50'; textColor = '#2e7d32'; badgeColor = '#4caf50'; badgeText = 'SCALE-UP'; icon = '👑';
                    } else if (matrixType === 'efficiency_star') {
                        bgColor = '#e3f2fd'; borderColor = '#2196f3'; textColor = '#1565c0'; badgeColor = '#2196f3'; badgeText = 'GROW'; icon = '💎';
                    } else if (matrixType === 'budget_bleeder') {
                        bgColor = '#ffebee'; borderColor = '#f44336'; textColor = '#c62828'; badgeColor = '#f44336'; badgeText = 'OPTIMIZE'; icon = '💸';
                    } else if (matrixType === 'underperformer') {
                        bgColor = '#fff3e0'; borderColor = '#ff9800'; textColor = '#e65100'; badgeColor = '#ff9800'; badgeText = 'REVIEW'; icon = '💤';
                    }

                    html += `
                        <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">${icon}</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: ${textColor};">${normalizedGender}</div>
                                    <div style="font-size: 10px; color: ${textColor}; opacity: 0.8;">성별 타겟</div>
                                </div>
                                ${badgeText ? '<span style="background: ' + badgeColor + '; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">' + badgeText + '</span>' : ''}
                            </div>
                            <!-- 메트릭스 배지 -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">ROAS ${formatPercent(g.roas)}</span>
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">CPA ${formatCurrency(cpa)}</span>
                            </div>
                            <!-- 추천 액션 -->
                            ${matrixAction ? `
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${borderColor};">
                                <div style="font-size: 10px; font-weight: 600; color: ${textColor}; margin-bottom: 4px;">💡 추천 액션</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${matrixAction}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // 2.5 4분면 매트릭스 시각화 (전체 타겟 요약)
            const allMatrixInsights = [
                ...(genderMatrixInsights || []),
                ...(deviceMatrixInsights || []),
                ...(deviceplatformMatrixInsights || [])
            ];

            if (allMatrixInsights.length > 0) {
                // 4분면별로 그룹핑
                const quadrants = {
                    'core_driver': allMatrixInsights.filter(i => i.sub_type === 'core_driver'),
                    'efficiency_star': allMatrixInsights.filter(i => i.sub_type === 'efficiency_star'),
                    'budget_bleeder': allMatrixInsights.filter(i => i.sub_type === 'budget_bleeder'),
                    'underperformer': allMatrixInsights.filter(i => i.sub_type === 'underperformer')
                };

                html += `
                    <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 12px; border: 1px solid var(--grey-200);">
                        <div style="font-size: 13px; font-weight: 700; color: var(--grey-900); margin-bottom: 12px;">
                            📊 효율-규모 매트릭스 (4분면)
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <!-- 고지출 + 고효율: Core Driver -->
                            <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <!-- 헤더 -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 18px;">👑</span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 700; color: #2e7d32;">핵심 동력</div>
                                        <div style="font-size: 10px; color: #2e7d32; opacity: 0.8;">고지출 + 고효율</div>
                                    </div>
                                    <span style="background: #4caf50; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">SCALE-UP</span>
                                </div>
                                <!-- 타겟 배지 -->
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                    ${quadrants.core_driver.length > 0 ? quadrants.core_driver.map(i => '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #81c784; font-weight: 500;">' + i.target + '</span>').join('') : '<span style="font-size: 11px; color: var(--grey-500);">-</span>'}
                                </div>
                                <!-- 추천 액션 -->
                                ${quadrants.core_driver.length > 0 && quadrants.core_driver[0].action ? `
                                <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #4caf50;">
                                    <div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 4px;">💡 추천 액션</div>
                                    <div style="font-size: 11px; color: #333; line-height: 1.4;">${quadrants.core_driver[0].action}</div>
                                </div>
                                ` : ''}
                            </div>
                            <!-- 저지출 + 고효율: Efficiency Star -->
                            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <!-- 헤더 -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 18px;">💎</span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 700; color: #1565c0;">효율 스타</div>
                                        <div style="font-size: 10px; color: #1565c0; opacity: 0.8;">저지출 + 고효율</div>
                                    </div>
                                    <span style="background: #2196f3; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">GROW</span>
                                </div>
                                <!-- 타겟 배지 -->
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                    ${quadrants.efficiency_star.length > 0 ? quadrants.efficiency_star.map(i => '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">' + i.target + '</span>').join('') : '<span style="font-size: 11px; color: var(--grey-500);">-</span>'}
                                </div>
                                <!-- 추천 액션 -->
                                ${quadrants.efficiency_star.length > 0 && quadrants.efficiency_star[0].action ? `
                                <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #2196f3;">
                                    <div style="font-size: 10px; font-weight: 600; color: #1565c0; margin-bottom: 4px;">💡 추천 액션</div>
                                    <div style="font-size: 11px; color: #333; line-height: 1.4;">${quadrants.efficiency_star[0].action}</div>
                                </div>
                                ` : ''}
                            </div>
                            <!-- 고지출 + 저효율: Budget Bleeder -->
                            <div style="background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <!-- 헤더 -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 18px;">💸</span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 700; color: #c62828;">예산 누수</div>
                                        <div style="font-size: 10px; color: #c62828; opacity: 0.8;">고지출 + 저효율</div>
                                    </div>
                                    <span style="background: #f44336; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">OPTIMIZE</span>
                                </div>
                                <!-- 타겟 배지 -->
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                    ${quadrants.budget_bleeder.length > 0 ? quadrants.budget_bleeder.map(i => '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #c62828; border: 1px solid #ef9a9a; font-weight: 500;">' + i.target + '</span>').join('') : '<span style="font-size: 11px; color: var(--grey-500);">-</span>'}
                                </div>
                                <!-- 추천 액션 -->
                                ${quadrants.budget_bleeder.length > 0 && quadrants.budget_bleeder[0].action ? `
                                <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #f44336;">
                                    <div style="font-size: 10px; font-weight: 600; color: #c62828; margin-bottom: 4px;">🚨 추천 액션</div>
                                    <div style="font-size: 11px; color: #333; line-height: 1.4;">${quadrants.budget_bleeder[0].action}</div>
                                </div>
                                ` : ''}
                            </div>
                            <!-- 저지출 + 저효율: Underperformer -->
                            <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <!-- 헤더 -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 18px;">💤</span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 700; color: #e65100;">성과 부진</div>
                                        <div style="font-size: 10px; color: #e65100; opacity: 0.8;">저지출 + 저효율</div>
                                    </div>
                                    <span style="background: #ff9800; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">REVIEW</span>
                                </div>
                                <!-- 타겟 배지 -->
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                    ${quadrants.underperformer.length > 0 ? quadrants.underperformer.map(i => '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #e65100; border: 1px solid #ffcc80; font-weight: 500;">' + i.target + '</span>').join('') : '<span style="font-size: 11px; color: var(--grey-500);">-</span>'}
                                </div>
                                <!-- 추천 액션 -->
                                ${quadrants.underperformer.length > 0 && quadrants.underperformer[0].action ? `
                                <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #ff9800;">
                                    <div style="font-size: 10px; font-weight: 600; color: #e65100; margin-bottom: 4px;">⚠️ 추천 액션</div>
                                    <div style="font-size: 11px; color: #333; line-height: 1.4;">${quadrants.underperformer[0].action}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            // 3. 기기플랫폼별 성과 (웹/앱/모바일) - 순위 스타일
            if (devicePlatformData.length > 0) {
                const maxDevicePlatformRoas = Math.max(...devicePlatformData.map(d => d.roas || 0));
                html += `
                    <div style="border: 1px solid var(--grey-200); border-radius: 10px; overflow: hidden; margin-bottom: 12px;">
                        <div style="padding: 10px 14px; background: #fafafa; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';">
                            <span style="font-size: 12px; font-weight: 600; color: var(--grey-800);">📱 기기플랫폼별 성과</span>
                            <span class="toggle-icon" style="font-size: 10px; color: var(--grey-500);">▶</span>
                        </div>
                        <div style="display: none; padding: 12px;">
                            <div style="font-size: 10px; color: var(--grey-600); margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 6px;">
                                💡 웹, 앱, 모바일에서의 광고 반응 차이를 파악하세요
                            </div>
                `;

                const sortedDevicePlatforms = [...devicePlatformData].sort((a, b) => (b.roas || 0) - (a.roas || 0));
                sortedDevicePlatforms.slice(0, 5).forEach((d, idx) => {
                    const platformName = d.deviceplatform || '';
                    // ROAS 색상 스케일
                    const roas = d.roas || 0;
                    let roasColor = '#c62828';
                    if (roas >= 500) roasColor = '#2e7d32';
                    else if (roas >= 300) roasColor = '#558b2f';
                    else if (roas >= 200) roasColor = '#f57f17';
                    else if (roas >= 100) roasColor = '#e65100';
                    // 배경 스케일 바
                    const barWidth = Math.min((roas / maxDevicePlatformRoas) * 100, 100);

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 6px; background: #fafafa; border-radius: 8px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${barWidth}%; background: linear-gradient(90deg, ${roasColor}22, ${roasColor}11); border-radius: 8px;"></div>
                            <div style="position: relative; z-index: 1; font-size: 12px; font-weight: 600; color: var(--grey-800);">${idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `${idx + 1}.`} ${platformName}</div>
                            <div style="position: relative; z-index: 1; font-size: 13px; font-weight: 700; color: ${roasColor};">${formatPercent(d.roas)}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // 4. 기기별 성과 (안드로이드/애플/웹)
            if (deviceData.length > 0) {
                const maxDeviceRoas = Math.max(...deviceData.map(d => d.roas || 0));
                html += `
                    <div style="border: 1px solid var(--grey-200); border-radius: 10px; overflow: hidden; margin-bottom: 12px;">
                        <div style="padding: 10px 14px; background: #fafafa; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';">
                            <span style="font-size: 12px; font-weight: 600; color: var(--grey-800);">💻 기기별 성과</span>
                            <span class="toggle-icon" style="font-size: 10px; color: var(--grey-500);">▶</span>
                        </div>
                        <div style="display: none; padding: 12px;">
                `;

                const sortedDevice = [...deviceData].sort((a, b) => b.roas - a.roas);
                sortedDevice.slice(0, 5).forEach((d, idx) => {
                    const cpa = d.conversions > 0 ? d.cost / d.conversions : 0;
                    // ROAS 색상 스케일
                    const roas = d.roas || 0;
                    let roasColor = '#c62828';
                    if (roas >= 500) roasColor = '#2e7d32';
                    else if (roas >= 300) roasColor = '#558b2f';
                    else if (roas >= 200) roasColor = '#f57f17';
                    else if (roas >= 100) roasColor = '#e65100';
                    // 배경 스케일 바
                    const barWidth = Math.min((roas / maxDeviceRoas) * 100, 100);

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 6px; background: #fafafa; border-radius: 8px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${barWidth}%; background: linear-gradient(90deg, ${roasColor}22, ${roasColor}11); border-radius: 8px;"></div>
                            <div style="position: relative; z-index: 1; font-size: 12px; font-weight: 600; color: var(--grey-800);">${idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `${idx + 1}.`} ${d.device}</div>
                            <div style="position: relative; z-index: 1; font-size: 13px; font-weight: 700; color: ${roasColor};">${formatPercent(d.roas)}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // 5. 연령+성별 조합 TOP 5 - 세 번째
            if (ageGenderData.length > 0) {
                const maxAgeGenderRoas = Math.max(...ageGenderData.slice(0, 5).map(item => item.roas || 0));
                html += `
                    <div style="border: 1px solid var(--grey-200); border-radius: 10px; overflow: hidden;">
                        <div style="padding: 10px 14px; background: #fafafa; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';">
                            <span style="font-size: 12px; font-weight: 600; color: var(--grey-800);">🎯 연령+성별 조합 TOP 5</span>
                            <span class="toggle-icon" style="font-size: 10px; color: var(--grey-500);">▶</span>
                        </div>
                        <div style="display: none; padding: 12px;">
                            <div style="font-size: 10px; color: var(--grey-600); margin-bottom: 10px; padding: 8px; background: #f5f5f5; border-radius: 6px;">
                                💡 이 조합의 타겟에게 광고를 집중하면 더 좋은 성과를 얻을 수 있어요
                            </div>
                `;

                ageGenderData.slice(0, 5).forEach((item, idx) => {
                    const normalizedGender = normalizeGender(item.gender) || item.gender;
                    const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : `${idx + 1}.`;
                    // ROAS 색상 스케일
                    const roas = item.roas || 0;
                    let roasColor = '#c62828';
                    if (roas >= 500) roasColor = '#2e7d32';
                    else if (roas >= 300) roasColor = '#558b2f';
                    else if (roas >= 200) roasColor = '#f57f17';
                    else if (roas >= 100) roasColor = '#e65100';
                    // 배경 스케일 바
                    const barWidth = Math.min((roas / maxAgeGenderRoas) * 100, 100);

                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 6px; background: #fafafa; border-radius: 8px; position: relative; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; height: 100%; width: ${barWidth}%; background: linear-gradient(90deg, ${roasColor}22, ${roasColor}11); border-radius: 8px;"></div>
                            <div style="position: relative; z-index: 1;">
                                <span style="font-size: 14px;">${medal}</span>
                                <span style="font-size: 12px; font-weight: 600; margin-left: 8px; color: var(--grey-800);">${item.age} ${normalizedGender}</span>
                            </div>
                            <div style="position: relative; z-index: 1; font-size: 14px; font-weight: 800; color: ${roasColor};">${formatPercent(item.roas)}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // 5. 실행 가이드
            html += `
                <div style="margin-top: 16px; padding: 12px 14px; background: linear-gradient(135deg, #e8eaf6 0%, #f5f5ff 100%); border-radius: 10px; border-left: 3px solid #5c6bc0;">
                    <div style="font-size: 11px; font-weight: 600; color: #3949ab; margin-bottom: 6px;">💡 이렇게 활용하세요</div>
                    <div style="font-size: 11px; color: var(--grey-800); line-height: 1.7;">
                        1. 🏆 표시된 타겟에게 <strong>광고 예산을 더 배정</strong>하세요<br>
                        2. 효율 낮은 타겟은 광고 <strong>노출을 줄이거나 제외</strong>하세요<br>
                        3. 연령+성별 조합으로 <strong>맞춤 광고 소재</strong>를 만들어보세요
                    </div>
                </div>
            `;

            document.getElementById('targetingContent').innerHTML = html;
        }

        // 탭 5: AI 예측 (Prophet Forecast)
        function renderForecastTab() {
            const periodData = getPeriodData();
            const forecast = periodData.prophet_forecast || null;
            let html = '';

            // forecast 데이터가 없어도 insightsData 기반 AI 분석 표시
            if (!forecast) {
                // 인트로 메시지 - 호버 툴팁 적용
                html += `
                    <div class="hoverable-card"
                         data-tooltip-title="AI 데이터 분석"
                         data-tooltip-icon="🤖"
                         data-tooltip-insight="현재 데이터를 기반으로 AI가 분석한 기회와 추천 액션입니다."
                         data-tooltip-recommendation="AI 추천을 참고하여 광고 전략을 최적화하세요."
                         style="margin-bottom: 16px; padding: 14px 18px; background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%); border-radius: 12px; border-left: 4px solid #7c4dff;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">🤖</span>
                            <span style="font-size: 13px; font-weight: 700; color: #5e35b1;">AI 데이터 분석 인사이트</span>
                        </div>
                        <div style="font-size: 11px; color: #7c4dff; margin-top: 6px;">📊 현재 광고 성과 데이터를 기반으로 분석했습니다</div>
                    </div>
                `;

                // 핵심 성과 요약 (periodData 기반)
                if (periodData && periodData.summary) {
                    const summary = periodData.summary;
                    const overallRoas = summary.overall_roas || 0;
                    const overallCpa = summary.overall_cpa || 0;
                    const isPositiveRoas = overallRoas >= 100;

                    html += `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;">
                            <div style="padding: 14px; background: ${isPositiveRoas ? 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)' : 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)'}; border-radius: 10px; text-align: center;">
                                <div style="font-size: 10px; color: ${isPositiveRoas ? '#2e7d32' : '#c62828'}; font-weight: 600; margin-bottom: 2px;">
                                    ${isPositiveRoas ? '📈 전체 ROAS' : '📉 전체 ROAS'}
                                </div>
                                <div style="font-size: 22px; font-weight: 800; color: ${isPositiveRoas ? '#1b5e20' : '#b71c1c'};">${overallRoas.toFixed(0)}%</div>
                            </div>
                            <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; text-align: center;">
                                <div style="font-size: 10px; color: #1565c0; font-weight: 600; margin-bottom: 2px;">💰 평균 CPA</div>
                                <div style="font-size: 18px; font-weight: 800; color: #0d47a1;">${formatCurrency(overallCpa)}</div>
                            </div>
                            <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 10px; text-align: center;">
                                <div style="font-size: 10px; color: #e65100; font-weight: 600; margin-bottom: 2px;">📊 전환 수</div>
                                <div style="font-size: 18px; font-weight: 700; color: #bf360c;">${formatNumber(summary.total_conversions || 0)}</div>
                            </div>
                        </div>
                    `;
                }

                // 최적 타겟 정보 (insightsData 기반)
                html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;">`;

                // 최적 채널
                if (periodData && periodData.top_categories && periodData.top_categories.length > 0) {
                    const sorted = [...periodData.top_categories].sort((a, b) => (b.roas || 0) - (a.roas || 0));
                    const top = sorted[0];
                    if (top) {
                        html += `
                            <div style="padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; text-align: center;">
                                <div style="font-size: 9px; color: #1565c0; font-weight: 600; margin-bottom: 2px;">📊 최적 채널</div>
                                <div style="font-size: 11px; font-weight: 700; color: #0d47a1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${top.name}</div>
                                <div style="font-size: 10px; color: #1565c0;">ROAS ${(top.roas || 0).toFixed(0)}%</div>
                            </div>
                        `;
                    }
                }

                // 최적 성별
                if (periodData && periodData.gender_performance && periodData.gender_performance.length > 0) {
                    const validGenders = periodData.gender_performance.filter(function(g) { return g.cost > 0 && isValidGender(g.gender); });
                    if (validGenders.length > 0) {
                        const sorted = [...validGenders].sort((a, b) => (b.roas || 0) - (a.roas || 0));
                        const top = sorted[0];
                        if (top) {
                            const genderName = normalizeGender(top.gender) || top.gender;
                            html += `
                                <div style="padding: 12px; background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border-radius: 10px; text-align: center;">
                                    <div style="font-size: 9px; color: #c2185b; font-weight: 600; margin-bottom: 2px;">👫 최적 성별</div>
                                    <div style="font-size: 12px; font-weight: 700; color: #880e4f;">${genderName}</div>
                                    <div style="font-size: 10px; color: #c2185b;">ROAS ${(top.roas || 0).toFixed(0)}%</div>
                                </div>
                            `;
                        }
                    }
                }

                // 최적 상품
                if (periodData && periodData.product_performance && periodData.product_performance.length > 0) {
                    const sorted = [...periodData.product_performance].sort((a, b) => (b.roas || 0) - (a.roas || 0));
                    const top = sorted[0];
                    if (top) {
                        html += `
                            <div style="padding: 12px; background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%); border-radius: 10px; text-align: center;">
                                <div style="font-size: 9px; color: #3949ab; font-weight: 600; margin-bottom: 2px;">🛍️ 최적 상품</div>
                                <div style="font-size: 11px; font-weight: 700; color: #1a237e;">${top.product}</div>
                                <div style="font-size: 10px; color: #3949ab;">ROAS ${(top.roas || 0).toFixed(0)}%</div>
                            </div>
                        `;
                    }
                }
                html += '</div>';

                // 채널별 ROAS 순위 (컴팩트 테이블)
                if (periodData && periodData.top_categories && periodData.top_categories.length > 1) {
                    const sorted = [...periodData.top_categories].sort((a, b) => (b.roas || 0) - (a.roas || 0));
                    html += `
                        <div style="margin-bottom: 12px; padding: 12px; background: white; border: 1px solid var(--grey-200); border-radius: 10px;">
                            <div style="font-size: 11px; font-weight: 700; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                <span>📈</span> 채널별 ROAS 순위
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
                    `;
                    sorted.slice(0, 6).forEach((cat, idx) => {
                        const roas = cat.roas || 0;
                        const isGood = roas >= 100;
                        const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: ${isGood ? '#f1f8e9' : '#fff3e0'}; border-radius: 6px; font-size: 10px;">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">${medal} ${cat.name}</span>
                                <span style="font-weight: 700; color: ${isGood ? '#2e7d32' : '#e65100'};">${roas.toFixed(0)}%</span>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                }

                // AI가 발견한 기회 (insightsData 기반)
                const opportunityData = generateAIOpportunities(null) || [];
                const opportunityCount = opportunityData.length;

                let opportunityItemsHtml = '';
                if (opportunityData.length > 0) {
                    opportunityItemsHtml = '<div style="display: flex; flex-direction: column; gap: 10px; padding: 12px;">';
                    opportunityData.forEach(function(item, idx) {
                        const metricBadge = item.metric ? '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #81c784; font-weight: 500;">' + item.metric + '</span>' : '';
                        opportunityItemsHtml +=
                            '<div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
                                '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">' +
                                    '<span style="font-size: 18px;">' + item.icon + '</span>' +
                                    '<div style="flex: 1;">' +
                                        '<div style="font-size: 13px; font-weight: 700; color: #2e7d32;">' + item.title + '</div>' +
                                        '<div style="font-size: 10px; color: #2e7d32; opacity: 0.8;">성장 기회</div>' +
                                    '</div>' +
                                    '<span style="background: #4caf50; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">GROW</span>' +
                                '</div>' +
                                (metricBadge ? '<div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">' + metricBadge + '</div>' : '') +
                                '<div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #4caf50;">' +
                                    '<div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 4px;">💡 인사이트</div>' +
                                    '<div style="font-size: 11px; color: #333; line-height: 1.4;">' + item.description + '</div>' +
                                '</div>' +
                            '</div>';
                    });
                    opportunityItemsHtml += '</div>';
                } else {
                    opportunityItemsHtml = '<div style="padding: 16px; text-align: center; color: #666; font-size: 11px;">데이터를 분석 중입니다...</div>';
                }

                html += '<div class="forecast-accordion" style="margin-bottom: 10px; border-radius: 10px; overflow: hidden;">' +
                    '<div class="forecast-accordion-header" data-target="forecastOpportunityContent" style="background: #e8f5e9; padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">' +
                        '<div style="display: flex; align-items: center; gap: 8px;">' +
                            '<span style="font-size: 18px;">🚀</span>' +
                            '<span style="font-size: 13px; font-weight: 700; color: #2e7d32;">AI가 발견한 기회 (' + opportunityCount + '건)</span>' +
                        '</div>' +
                        '<span class="forecast-accordion-icon" style="font-size: 12px; color: #2e7d32; transition: transform 0.3s;">▼</span>' +
                    '</div>' +
                    '<div id="forecastOpportunityContent" class="forecast-accordion-content" style="display: none; background: #f1f8e9; padding: 0;">' +
                        opportunityItemsHtml +
                    '</div>' +
                '</div>';

                // AI 추천 액션 (insightsData 기반)
                const actionData = generateAIActions(null) || [];
                const actionCount = actionData.length;

                let actionItemsHtml = '';
                if (actionData.length > 0) {
                    actionItemsHtml = '<div style="display: flex; flex-direction: column; gap: 10px; padding: 12px;">';
                    actionData.forEach(function(item, idx) {
                        let bgColor = '#e3f2fd';
                        let borderColor = '#2196f3';
                        let textColor = '#1565c0';
                        let badgeText = 'ACTION';
                        if (item.priority === 'high') {
                            bgColor = '#ffebee'; borderColor = '#f44336'; textColor = '#c62828'; badgeText = '긴급';
                        } else if (item.priority === 'medium') {
                            bgColor = '#fff3e0'; borderColor = '#ff9800'; textColor = '#e65100'; badgeText = '중요';
                        }
                        const effectBadge = item.expectedEffect ? '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">예상 효과: ' + item.expectedEffect + '</span>' : '';
                        actionItemsHtml +=
                            '<div style="background: ' + bgColor + '; border: 2px solid ' + borderColor + '; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
                                '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">' +
                                    '<span style="font-size: 18px;">' + item.icon + '</span>' +
                                    '<div style="flex: 1;">' +
                                        '<div style="font-size: 13px; font-weight: 700; color: ' + textColor + ';">' + item.title + '</div>' +
                                        '<div style="font-size: 10px; color: ' + textColor + '; opacity: 0.8;">AI 추천</div>' +
                                    '</div>' +
                                    '<span style="background: ' + borderColor + '; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">' + badgeText + '</span>' +
                                '</div>' +
                                (effectBadge ? '<div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">' + effectBadge + '</div>' : '') +
                                '<div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ' + borderColor + ';">' +
                                    '<div style="font-size: 10px; font-weight: 600; color: ' + textColor + '; margin-bottom: 4px;">💡 실행 가이드</div>' +
                                    '<div style="font-size: 11px; color: #333; line-height: 1.4;">' + item.description + '</div>' +
                                '</div>' +
                            '</div>';
                    });
                    actionItemsHtml += '</div>';
                } else {
                    actionItemsHtml = '<div style="padding: 16px; text-align: center; color: #666; font-size: 11px;">데이터를 분석 중입니다...</div>';
                }

                html += '<div class="forecast-accordion" style="margin-bottom: 12px; border-radius: 10px; overflow: hidden;">' +
                    '<div class="forecast-accordion-header" data-target="forecastActionContent" style="background: #e3f2fd; padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">' +
                        '<div style="display: flex; align-items: center; gap: 8px;">' +
                            '<span style="font-size: 18px;">💡</span>' +
                            '<span style="font-size: 13px; font-weight: 700; color: #1565c0;">AI 추천 액션 (' + actionCount + '건)</span>' +
                        '</div>' +
                        '<span class="forecast-accordion-icon" style="font-size: 12px; color: #1565c0; transition: transform 0.3s;">▼</span>' +
                    '</div>' +
                    '<div id="forecastActionContent" class="forecast-accordion-content" style="display: none; background: #e8f4fd; padding: 0;">' +
                        actionItemsHtml +
                    '</div>' +
                '</div>';

                // 활용 가이드
                html += `
                    <div style="padding: 10px 12px; background: linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%); border-radius: 8px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 10px; color: #546e7a;">
                            <span>✅ ROAS 100%+ 채널에 예산 집중</span>
                            <span>✅ CPA 높은 상품 소재/타겟 점검</span>
                            <span>✅ 고효율 타겟 활용</span>
                        </div>
                    </div>
                `;

                document.getElementById('forecastContent').innerHTML = html;

                // 아코디언 초기화
                initForecastAccordions();
                return;
            }

            // forecast 데이터가 있는 경우
            html = '';

            // 선택된 기간 정보 가져오기
            const periodLabels = {'full': '전체 기간', '180d': '최근 180일', '90d': '최근 90일'};
            const currentPeriodLabel = periodLabels[currentPeriod] || '전체 기간';

            // 인트로 메시지 - 호버 툴팁 적용 (기간 표시 추가)
            html += `
                <div class="hoverable-card"
                     data-tooltip-title="AI 예측 분석"
                     data-tooltip-icon="🔮"
                     data-tooltip-insight="ROAS(광고수익률)가 100% 이상이면 광고비보다 많은 수익이 발생한다는 의미예요."
                     data-tooltip-recommendation="AI 예측을 참고하여 예산 배분을 최적화하세요."
                     style="margin-bottom: 16px; padding: 14px 18px; background: linear-gradient(135deg, #e8eaf6 0%, #f3e5f5 100%); border-radius: 12px; border-left: 4px solid #7c4dff;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">🔮</span>
                        <span style="font-size: 13px; font-weight: 700; color: #5e35b1;">AI 분석 인사이트</span>
                        <span style="font-size: 10px; color: #7c4dff; background: rgba(124, 77, 255, 0.1); padding: 2px 8px; border-radius: 10px; margin-left: auto;">${currentPeriodLabel} 기준</span>
                    </div>
                </div>
            `;

            // 1. 핵심 성과 요약 (향후 30일 예측 데이터) - 기간별로 다른 예측 데이터 표시
            if (forecast && forecast.summary && forecast.summary.overall) {
                const forecastSummary = forecast.summary.overall;
                const forecastRoas = forecastSummary.avg_forecast_roas || 0;
                const forecastCpa = forecastSummary.avg_forecast_cpa || 0;
                const isPositiveRoas = forecastRoas >= 100;
                const forecastConversions = forecastSummary.total_forecast_conversions || 0;

                html += `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                        <div style="padding: 14px; background: ${isPositiveRoas ? 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)' : 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)'}; border-radius: 10px; text-align: center;">
                            <div style="font-size: 10px; color: ${isPositiveRoas ? '#2e7d32' : '#c62828'}; font-weight: 600; margin-bottom: 2px;">
                                ${isPositiveRoas ? '📈 예측 ROAS' : '📉 예측 ROAS'}
                            </div>
                            <div style="font-size: 22px; font-weight: 800; color: ${isPositiveRoas ? '#1b5e20' : '#b71c1c'};">${forecastRoas.toFixed(0)}%</div>
                        </div>
                        <div style="padding: 14px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; text-align: center;">
                            <div style="font-size: 10px; color: #1565c0; font-weight: 600; margin-bottom: 2px;">💰 예측 CPA</div>
                            <div style="font-size: 18px; font-weight: 800; color: #0d47a1;">${formatCurrency(forecastCpa)}</div>
                        </div>
                        <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 10px; text-align: center;">
                            <div style="font-size: 10px; color: #e65100; font-weight: 600; margin-bottom: 2px;">🎯 예측 전환</div>
                            <div style="font-size: 16px; font-weight: 700; color: #bf360c;">${forecastConversions.toFixed(0)}</div>
                        </div>
                    </div>
                `;
            }

            // 2. 최적 타겟 (향후 30일 예측 데이터 사용)
            html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;">`;

            // 최적 기기유형 (forecast.by_device 사용)
            if (forecast.by_device && forecast.by_device.length > 0) {
                const validDevices = forecast.by_device.filter(d => d.device !== 'Uncategorized' && d.device !== 'unknown');
                if (validDevices.length > 0) {
                    const sortedDevices = [...validDevices].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    const topDevice = sortedDevices[0];
                    html += `
                        <div style="padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; text-align: center;">
                            <div style="font-size: 9px; color: #1565c0; font-weight: 600; margin-bottom: 2px;">📱 최적 기기</div>
                            <div style="font-size: 12px; font-weight: 700; color: #0d47a1;">${topDevice.device}</div>
                            <div style="font-size: 10px; color: #1565c0;">ROAS ${(topDevice.avg_forecast_roas || 0).toFixed(0)}%</div>
                        </div>
                    `;
                }
            }

            // 최적 성별 (forecast.by_gender 사용)
            if (forecast.by_gender && forecast.by_gender.length > 0) {
                const validGenders = forecast.by_gender.filter(g => isValidGender(g.gender));
                if (validGenders.length > 0) {
                    const sorted = [...validGenders].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    const top = sorted[0];
                    html += `
                        <div style="padding: 12px; background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border-radius: 10px; text-align: center;">
                            <div style="font-size: 9px; color: #c2185b; font-weight: 600; margin-bottom: 2px;">👫 최적 성별</div>
                            <div style="font-size: 12px; font-weight: 700; color: #880e4f;">${normalizeGender(top.gender) || top.gender}</div>
                            <div style="font-size: 10px; color: #c2185b;">ROAS ${(top.avg_forecast_roas || 0).toFixed(0)}%</div>
                        </div>
                    `;
                }
            }

            // 최적 연령 (forecast.by_age 사용)
            if (forecast.by_age && forecast.by_age.length > 0) {
                const validAges = forecast.by_age.filter(a => isValidAge(a.age));
                if (validAges.length > 0) {
                    const sorted = [...validAges].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    const top = sorted[0];
                    html += `
                        <div style="padding: 12px; background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%); border-radius: 10px; text-align: center;">
                            <div style="font-size: 9px; color: #3949ab; font-weight: 600; margin-bottom: 2px;">👤 최적 연령</div>
                            <div style="font-size: 11px; font-weight: 700; color: #1a237e;">${top.age}</div>
                            <div style="font-size: 10px; color: #3949ab;">ROAS ${(top.avg_forecast_roas || 0).toFixed(0)}%</div>
                        </div>
                    `;
                }
            }
            html += '</div>';

            // 3. 상품별 예측 + 서브탭 (성별&연령, 기기, 플랫폼, 노출기기)
            html += `
                <div style="margin-bottom: 16px; background: white; border: 1px solid var(--grey-200); border-radius: 12px; overflow: hidden;">
                    <div style="display: flex; border-bottom: 1px solid var(--grey-200); background: #f8f9fa;">
                        <button class="forecast-subtab active" data-subtab="product" style="flex: 1; padding: 10px 8px; font-size: 11px; font-weight: 600; border: none; background: none; cursor: pointer; color: var(--grey-600); border-bottom: 2px solid transparent;">🛍️ 상품별</button>
                        <button class="forecast-subtab" data-subtab="gender-age" style="flex: 1; padding: 10px 8px; font-size: 11px; font-weight: 600; border: none; background: none; cursor: pointer; color: var(--grey-600); border-bottom: 2px solid transparent;">👫 성별&연령</button>
                        <button class="forecast-subtab" data-subtab="deviceplatform" style="flex: 1; padding: 10px 8px; font-size: 11px; font-weight: 600; border: none; background: none; cursor: pointer; color: var(--grey-600); border-bottom: 2px solid transparent;">📱 기기플랫폼</button>
                        <button class="forecast-subtab" data-subtab="category" style="flex: 1; padding: 10px 8px; font-size: 11px; font-weight: 600; border: none; background: none; cursor: pointer; color: var(--grey-600); border-bottom: 2px solid transparent;">📊 채널</button>
                    </div>
                    <div id="forecastSubtabContent" style="padding: 12px;"></div>
                </div>
            `;

            // 4. AI 발견 기회 (펼치기/접기)
            const opportunityData = generateAIOpportunities(forecast) || [];
            const opportunityCount = opportunityData.length;

            let opportunityItemsHtml = '';
            if (opportunityData.length > 0) {
                opportunityItemsHtml = '<div style="display: flex; flex-direction: column; gap: 10px; padding: 12px;">';
                opportunityData.forEach(function(item, idx) {
                    const metricBadge = item.metric ? '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #2e7d32; border: 1px solid #81c784; font-weight: 500;">' + item.metric + '</span>' : '';
                    opportunityItemsHtml +=
                        '<div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
                            '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">' +
                                '<span style="font-size: 18px;">' + item.icon + '</span>' +
                                '<div style="flex: 1;">' +
                                    '<div style="font-size: 13px; font-weight: 700; color: #2e7d32;">' + item.title + '</div>' +
                                    '<div style="font-size: 10px; color: #2e7d32; opacity: 0.8;">성장 기회</div>' +
                                '</div>' +
                                '<span style="background: #4caf50; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">GROW</span>' +
                            '</div>' +
                            (metricBadge ? '<div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">' + metricBadge + '</div>' : '') +
                            '<div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #4caf50;">' +
                                '<div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 4px;">💡 인사이트</div>' +
                                '<div style="font-size: 11px; color: #333; line-height: 1.4;">' + item.description + '</div>' +
                            '</div>' +
                        '</div>';
                });
                opportunityItemsHtml += '</div>';
            } else {
                opportunityItemsHtml = '<div style="padding: 16px; text-align: center; color: #666; font-size: 11px;">데이터를 분석 중입니다...</div>';
            }

            html += '<div class="forecast-accordion" style="margin-bottom: 10px; border-radius: 10px; overflow: hidden;">' +
                '<div class="forecast-accordion-header" data-target="forecastOpportunityContent" style="background: #e8f5e9; padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">' +
                    '<div style="display: flex; align-items: center; gap: 8px;">' +
                        '<span style="font-size: 18px;">🚀</span>' +
                        '<span style="font-size: 13px; font-weight: 700; color: #2e7d32;">AI가 발견한 기회 (' + opportunityCount + '건)</span>' +
                    '</div>' +
                    '<span class="forecast-accordion-icon" style="font-size: 12px; color: #2e7d32; transition: transform 0.3s;">▼</span>' +
                '</div>' +
                '<div id="forecastOpportunityContent" class="forecast-accordion-content" style="display: none; background: #f1f8e9; padding: 0;">' +
                    opportunityItemsHtml +
                '</div>' +
            '</div>';

            // 5. AI 추천 액션 (펼치기/접기)
            const actionData = generateAIActions(forecast) || [];
            const actionCount = actionData.length;

            let actionItemsHtml = '';
            if (actionData.length > 0) {
                actionItemsHtml = '<div style="display: flex; flex-direction: column; gap: 10px; padding: 12px;">';
                actionData.forEach(function(item, idx) {
                    let bgColor = '#e3f2fd';
                    let borderColor = '#2196f3';
                    let textColor = '#1565c0';
                    let badgeText = 'ACTION';
                    if (item.priority === 'high') {
                        bgColor = '#ffebee'; borderColor = '#f44336'; textColor = '#c62828'; badgeText = '긴급';
                    } else if (item.priority === 'medium') {
                        bgColor = '#fff3e0'; borderColor = '#ff9800'; textColor = '#e65100'; badgeText = '중요';
                    }
                    const effectBadge = item.expectedEffect ? '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">예상 효과: ' + item.expectedEffect + '</span>' : '';
                    actionItemsHtml +=
                        '<div style="background: ' + bgColor + '; border: 2px solid ' + borderColor + '; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'translateY(0)\'">' +
                            '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">' +
                                '<span style="font-size: 18px;">' + item.icon + '</span>' +
                                '<div style="flex: 1;">' +
                                    '<div style="font-size: 13px; font-weight: 700; color: ' + textColor + ';">' + item.title + '</div>' +
                                    '<div style="font-size: 10px; color: ' + textColor + '; opacity: 0.8;">AI 추천</div>' +
                                '</div>' +
                                '<span style="background: ' + borderColor + '; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">' + badgeText + '</span>' +
                            '</div>' +
                            (effectBadge ? '<div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">' + effectBadge + '</div>' : '') +
                            '<div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ' + borderColor + ';">' +
                                '<div style="font-size: 10px; font-weight: 600; color: ' + textColor + '; margin-bottom: 4px;">💡 실행 가이드</div>' +
                                '<div style="font-size: 11px; color: #333; line-height: 1.4;">' + item.description + '</div>' +
                            '</div>' +
                        '</div>';
                });
                actionItemsHtml += '</div>';
            } else {
                actionItemsHtml = '<div style="padding: 16px; text-align: center; color: #666; font-size: 11px;">데이터를 분석 중입니다...</div>';
            }

            html += '<div class="forecast-accordion" style="margin-bottom: 12px; border-radius: 10px; overflow: hidden;">' +
                '<div class="forecast-accordion-header" data-target="forecastActionContent" style="background: #e3f2fd; padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">' +
                    '<div style="display: flex; align-items: center; gap: 8px;">' +
                        '<span style="font-size: 18px;">💡</span>' +
                        '<span style="font-size: 13px; font-weight: 700; color: #1565c0;">AI 추천 액션 (' + actionCount + '건)</span>' +
                    '</div>' +
                    '<span class="forecast-accordion-icon" style="font-size: 12px; color: #1565c0; transition: transform 0.3s;">▼</span>' +
                '</div>' +
                '<div id="forecastActionContent" class="forecast-accordion-content" style="display: none; background: #e8f4fd; padding: 0;">' +
                    actionItemsHtml +
                '</div>' +
            '</div>';

            // 5. 예측 활용 가이드 (컴팩트)
            html += `
                <div style="padding: 10px 12px; background: linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%); border-radius: 8px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 10px; color: #546e7a;">
                        <span>✅ ROAS 100%+ 채널에 예산 집중</span>
                        <span>✅ CPA 높은 상품 소재/타겟 점검</span>
                        <span>✅ 최적 타겟 활용</span>
                    </div>
                </div>
            `;

            document.getElementById('forecastContent').innerHTML = html;

            // 서브탭 초기화
            initForecastSubtabs(forecast);

            // 아코디언 초기화
            initForecastAccordions();
        }

        // AI 예측 서브탭 초기화
        function initForecastSubtabs(forecast) {
            const subtabBtns = document.querySelectorAll('.forecast-subtab');
            const contentDiv = document.getElementById('forecastSubtabContent');

            subtabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    subtabBtns.forEach(b => {
                        b.classList.remove('active');
                        b.style.color = 'var(--grey-600)';
                        b.style.borderBottom = '2px solid transparent';
                    });
                    this.classList.add('active');
                    this.style.color = '#7c4dff';
                    this.style.borderBottom = '2px solid #7c4dff';
                    renderForecastSubtab(this.dataset.subtab, forecast, contentDiv);
                });
            });

            // 기본 탭 활성화
            const defaultBtn = document.querySelector('.forecast-subtab[data-subtab="product"]');
            if (defaultBtn) {
                defaultBtn.style.color = '#7c4dff';
                defaultBtn.style.borderBottom = '2px solid #7c4dff';
                renderForecastSubtab('product', forecast, contentDiv);
            }
        }

        // AI 예측 아코디언 초기화
        function initForecastAccordions() {
            const forecastContent = document.getElementById('forecastContent');
            if (!forecastContent) return;

            // 이벤트 위임 방식으로 변경 - 기존 리스너 제거 후 재등록
            forecastContent.removeEventListener('click', handleForecastAccordionClick);
            forecastContent.addEventListener('click', handleForecastAccordionClick);
        }

        // 아코디언 클릭 핸들러 (이벤트 위임)
        function handleForecastAccordionClick(e) {
            const header = e.target.closest('.forecast-accordion-header');
            if (!header) return;

            const targetId = header.dataset.target;
            const content = document.getElementById(targetId);
            const icon = header.querySelector('.forecast-accordion-icon');

            if (!content || !icon) return;

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // AI가 발견한 기회 데이터 생성 (5개) - forecast 기반 (향후 30일 예측)
        function generateAIOpportunities(forecast) {
            const opportunities = [];

            if (!forecast) return opportunities;

            try {
                // 1. 최고 성과 기기플랫폼 기회 (forecast.by_deviceplatform)
                if (forecast.by_deviceplatform && forecast.by_deviceplatform.length > 0) {
                    const validPlatforms = forecast.by_deviceplatform.filter(p => p.deviceplatform !== 'Uncategorized');
                    if (validPlatforms.length > 0) {
                        const sorted = [...validPlatforms].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                        const top = sorted[0];
                        if (top && (top.avg_forecast_roas || 0) >= 100) {
                            opportunities.push({
                                icon: '📱',
                                title: top.deviceplatform + ' 기기플랫폼 고효율 예측',
                                description: top.deviceplatform + '에서 향후 30일 예측 ROAS ' + (top.avg_forecast_roas || 0).toFixed(0) + '%로 높은 효율이 예상됩니다. 해당 기기플랫폼의 예산을 확대하면 성과 개선이 기대됩니다.',
                                metric: '예측 ROAS ' + (top.avg_forecast_roas || 0).toFixed(0) + '%'
                            });
                        }
                    }
                }

                // 2. 고성과 채널 기회 (forecast.by_category)
                if (forecast.by_category && forecast.by_category.length > 0) {
                    const sorted = [...forecast.by_category].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    const top = sorted[0];
                    if (top && (top.avg_forecast_roas || 0) >= 100) {
                        opportunities.push({
                            icon: '📊',
                            title: top.category + ' 채널 확대 기회',
                            description: top.category + ' 채널의 향후 30일 예측 ROAS가 ' + (top.avg_forecast_roas || 0).toFixed(0) + '%로 매우 높습니다. 이 채널에 예산을 집중하면 높은 수익을 기대할 수 있습니다.',
                            metric: '예측 ROAS ' + (top.avg_forecast_roas || 0).toFixed(0) + '%'
                        });
                    }
                }

                // 3. 최적 성별 기회 (forecast.by_gender)
                if (forecast.by_gender && forecast.by_gender.length > 0) {
                    const validGenders = forecast.by_gender.filter(function(g) { return isValidGender(g.gender); });
                    if (validGenders.length > 0) {
                        const sorted = [...validGenders].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                        const top = sorted[0];
                        if (top && (top.avg_forecast_roas || 0) >= 100) {
                            const genderName = normalizeGender(top.gender) || top.gender;
                            opportunities.push({
                                icon: '👫',
                                title: genderName + ' 타겟 확대 기회',
                                description: genderName + ' 타겟에서 향후 30일 예측 ROAS ' + (top.avg_forecast_roas || 0).toFixed(0) + '%로 우수한 성과가 예상됩니다. 성별 맞춤 메시지 전략을 강화하세요.',
                                metric: '예측 ROAS ' + (top.avg_forecast_roas || 0).toFixed(0) + '%'
                            });
                        }
                    }
                }

                // 4. 고성과 상품 기회 (forecast.by_product)
                if (forecast.by_product && forecast.by_product.length > 0) {
                    const sorted = [...forecast.by_product].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    const top = sorted[0];
                    if (top && (top.avg_forecast_roas || 0) >= 100) {
                        opportunities.push({
                            icon: '🛍️',
                            title: top.product + ' 상품 확대 기회',
                            description: top.product + ' 상품의 향후 30일 예측 ROAS가 ' + (top.avg_forecast_roas || 0).toFixed(0) + '%로 가장 높습니다. 해당 상품 중심의 프로모션 및 광고 예산 집중을 권장합니다.',
                            metric: '예측 ROAS ' + (top.avg_forecast_roas || 0).toFixed(0) + '%'
                        });
                    }
                }

                // 5. 전체 예측 성과 기회 (forecast.summary.overall)
                if (forecast.summary && forecast.summary.overall) {
                    const overallRoas = forecast.summary.overall.avg_forecast_roas || 0;
                    if (overallRoas >= 100) {
                        opportunities.push({
                            icon: '📈',
                            title: '전체 캠페인 성장 기회',
                            description: '향후 30일 예측 ROAS가 ' + overallRoas.toFixed(0) + '%로 양호합니다. 현재 전략을 유지하면서 고효율 채널에 추가 투자를 검토하세요.',
                            metric: '예측 ROAS ' + overallRoas.toFixed(0) + '%'
                        });
                    }
                }
            } catch (e) {
                console.error('generateAIOpportunities error:', e);
            }

            // 최소 5개 보장 - 기본값 추가
            const defaults = [
                { icon: '🎯', title: '타겟 최적화 기회', description: '예측 데이터를 기반으로 타겟팅 전략을 개선하면 더 높은 성과를 기대할 수 있습니다.', metric: null },
                { icon: '💰', title: '예산 재배분 기회', description: '고효율 채널로 예산을 재배분하여 전체 ROAS를 개선할 수 있는 기회가 있습니다.', metric: null },
                { icon: '🔄', title: '크리에이티브 갱신 기회', description: '새로운 크리에이티브 테스트를 통해 광고 피로도를 낮추고 성과를 개선할 수 있습니다.', metric: null },
                { icon: '📊', title: '데이터 기반 최적화 기회', description: 'A/B 테스트를 통해 더 효과적인 광고 소재와 타겟을 발굴할 기회가 있습니다.', metric: null },
                { icon: '⚡', title: '시즌 대응 기회', description: '시즌별 트렌드에 맞춰 상품과 메시지를 최적화하면 추가 성과를 기대할 수 있습니다.', metric: null }
            ];

            let defaultIdx = 0;
            while (opportunities.length < 5) {
                opportunities.push(defaults[defaultIdx]);
                defaultIdx++;
            }

            return opportunities.slice(0, 5);
        }

        // AI 추천 액션 데이터 생성 (5개) - forecast 기반 (향후 30일 예측)
        function generateAIActions(forecast) {
            const actions = [];

            if (!forecast) return actions;

            try {
                // 1. 저효율 상품 개선 액션 (forecast.by_product)
                if (forecast.by_product && forecast.by_product.length > 0) {
                    const sorted = [...forecast.by_product].sort((a, b) => (a.avg_forecast_roas || 0) - (b.avg_forecast_roas || 0));
                    const worst = sorted[0];
                    if (worst && (worst.avg_forecast_roas || 0) < 100) {
                        actions.push({
                            icon: '🔧',
                            title: worst.product + ' 상품 광고 개선',
                            description: worst.product + '의 향후 30일 예측 ROAS가 ' + (worst.avg_forecast_roas || 0).toFixed(0) + '%로 낮습니다. 타겟 재설정, 크리에이티브 교체, 또는 예산 축소를 검토하세요.',
                            priority: 'high',
                            expectedEffect: 'CPA 15~20% 개선'
                        });
                    }
                }

                // 2. 고효율 기기플랫폼 예산 확대 액션 (forecast.by_deviceplatform)
                if (forecast.by_deviceplatform && forecast.by_deviceplatform.length > 0) {
                    const validPlatforms = forecast.by_deviceplatform.filter(function(p) { return p.deviceplatform !== 'Uncategorized'; });
                    if (validPlatforms.length > 0) {
                        const sorted = [...validPlatforms].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                        const top = sorted[0];
                        if (top && (top.avg_forecast_roas || 0) >= 150) {
                            actions.push({
                                icon: '💵',
                                title: top.deviceplatform + ' 예산 20% 증액',
                                description: top.deviceplatform + '의 향후 30일 예측 ROAS가 ' + (top.avg_forecast_roas || 0).toFixed(0) + '%로 매우 높습니다. 해당 기기플랫폼 예산을 20% 증액하여 성과를 극대화하세요.',
                                priority: 'high',
                                expectedEffect: '매출 증가 기대'
                            });
                        }
                    }
                }

                // 3. 고효율 채널 집중 액션 (forecast.by_category)
                if (forecast.by_category && forecast.by_category.length > 0) {
                    const sorted = [...forecast.by_category].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    const top = sorted[0];
                    if (top) {
                        actions.push({
                            icon: '🎯',
                            title: top.category + ' 채널 캠페인 강화',
                            description: top.category + ' 채널의 향후 30일 예측 성과가 가장 우수합니다(ROAS ' + (top.avg_forecast_roas || 0).toFixed(0) + '%). 해당 채널 전용 캠페인을 신설하거나 기존 캠페인의 예산 비중을 높이세요.',
                            priority: 'medium',
                            expectedEffect: 'ROAS 10~15% 개선'
                        });
                    }
                }

                // 4. 저효율 기기플랫폼 개선 또는 축소 액션 (forecast.by_deviceplatform)
                if (forecast.by_deviceplatform && forecast.by_deviceplatform.length > 1) {
                    const validPlatforms = forecast.by_deviceplatform.filter(function(p) { return p.deviceplatform !== 'Uncategorized'; });
                    if (validPlatforms.length > 0) {
                        const sorted = [...validPlatforms].sort((a, b) => (a.avg_forecast_roas || 0) - (b.avg_forecast_roas || 0));
                        const worst = sorted[0];
                        if (worst && (worst.avg_forecast_roas || 0) < 100) {
                            actions.push({
                                icon: '⚠️',
                                title: worst.deviceplatform + ' 예산 재검토',
                                description: worst.deviceplatform + '의 향후 30일 예측 ROAS가 ' + (worst.avg_forecast_roas || 0).toFixed(0) + '%로 손익분기점 미달입니다. 타겟 및 소재 최적화 후에도 개선되지 않으면 예산 축소를 고려하세요.',
                                priority: 'medium',
                                expectedEffect: '비용 효율화'
                            });
                        }
                    }
                }

                // 5. 전체 전략 액션 (forecast.summary.overall)
                if (forecast.summary && forecast.summary.overall) {
                    const avgCpa = forecast.summary.overall.avg_forecast_cpa || 0;
                    actions.push({
                        icon: '📋',
                        title: 'CPA 기반 입찰 전략 최적화',
                        description: '향후 30일 예측 CPA가 ' + formatCurrency(avgCpa) + '입니다. 목표 CPA를 기준으로 자동 입찰 전략을 조정하고, 고CPA 광고세트는 수동 검토하세요.',
                        priority: 'low',
                        expectedEffect: '전체 CPA 5~10% 개선'
                    });
                }
            } catch (e) {
                console.error('generateAIActions error:', e);
            }

            // 최소 5개 보장 - 기본값 추가
            const defaults = [
                { icon: '🔄', title: '크리에이티브 A/B 테스트', description: '현재 운영 중인 광고 소재의 다양한 버전을 테스트하여 최적의 성과를 찾으세요.', priority: 'low', expectedEffect: 'CTR 향상' },
                { icon: '📱', title: '랜딩페이지 최적화', description: '광고 클릭 후 전환율을 높이기 위해 랜딩페이지 로딩 속도와 UX를 점검하세요.', priority: 'low', expectedEffect: '전환율 향상' },
                { icon: '🕐', title: '광고 노출 시간대 최적화', description: '성과가 좋은 시간대에 예산을 집중하여 효율을 극대화하세요.', priority: 'low', expectedEffect: 'ROAS 개선' },
                { icon: '📊', title: '리타겟팅 캠페인 강화', description: '사이트 방문자 및 장바구니 이탈자 대상 리타겟팅을 강화하세요.', priority: 'low', expectedEffect: '전환 증가' },
                { icon: '🎨', title: '시즌 맞춤 소재 제작', description: '현재 시즌 및 트렌드에 맞는 새로운 광고 소재를 제작하세요.', priority: 'low', expectedEffect: '광고 피로도 감소' }
            ];

            let defaultIdx = 0;
            while (actions.length < 5) {
                actions.push(defaults[defaultIdx]);
                defaultIdx++;
            }

            return actions.slice(0, 5);
        }

        // AI 예측 서브탭 렌더링
        function renderForecastSubtab(tab, forecast, container) {
            let html = '';

            if (tab === 'product') {
                // 상품별 예측
                if (forecast.by_product && forecast.by_product.length > 0) {
                    const sorted = [...forecast.by_product].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">`;

                    // ROAS TOP
                    html += `<div style="padding: 10px; background: #e8f5e9; border-radius: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 6px;">🏆 ROAS TOP</div>`;
                    sorted.slice(0, 4).forEach((prod, idx) => {
                        const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                <span>${medal} ${prod.product}</span>
                                <span style="font-weight: 700; color: #1b5e20;">${(prod.avg_forecast_roas || 0).toFixed(0)}%</span>
                            </div>
                        `;
                    });
                    html += '</div>';

                    // CPA 개선 필요 (CPA가 높은 상품)
                    const bottomByCpa = [...forecast.by_product].sort((a, b) => (b.avg_forecast_cpa || 0) - (a.avg_forecast_cpa || 0)).slice(0, 4);
                    html += `<div style="padding: 10px; background: #fff3e0; border-radius: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #e65100; margin-bottom: 6px;">📉 CPA 개선 필요</div>`;
                    bottomByCpa.forEach(prod => {
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                <span>${prod.product}</span>
                                <span style="font-weight: 700; color: #bf360c;">${formatCurrency(prod.avg_forecast_cpa || 0)}</span>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
            } else if (tab === 'gender-age') {
                // 성별 & 연령 예측
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">`;

                // 성별
                if (forecast.by_gender && forecast.by_gender.length > 0) {
                    const validGenders = forecast.by_gender.filter(g => isValidGender(g.gender));
                    html += `<div style="padding: 10px; background: #fce4ec; border-radius: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #c2185b; margin-bottom: 6px;">👫 성별 예측</div>`;
                    validGenders.forEach(g => {
                        const roas = g.avg_forecast_roas || 0;
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                <span>${normalizeGender(g.gender) || g.gender}</span>
                                <span style="font-weight: 700; color: ${roas >= 100 ? '#2e7d32' : '#c62828'};">${roas.toFixed(0)}%</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // 연령
                if (forecast.by_age && forecast.by_age.length > 0) {
                    const validAges = forecast.by_age.filter(a => isValidAge(a.age));
                    const sorted = [...validAges].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    html += `<div style="padding: 10px; background: #e8eaf6; border-radius: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #3949ab; margin-bottom: 6px;">👤 연령 예측 TOP 5</div>`;
                    sorted.slice(0, 5).forEach((a, idx) => {
                        const roas = a.avg_forecast_roas || 0;
                        const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                <span>${medal} ${a.age}</span>
                                <span style="font-weight: 700; color: ${roas >= 100 ? '#2e7d32' : '#c62828'};">${roas.toFixed(0)}%</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                html += '</div>';
            } else if (tab === 'deviceplatform') {
                // 기기플랫폼 예측
                if (forecast.by_deviceplatform && forecast.by_deviceplatform.length > 0) {
                    const sorted = [...forecast.by_deviceplatform].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">`;
                    sorted.forEach((dev, idx) => {
                        const roas = dev.avg_forecast_roas || 0;
                        const isTop = idx === 0;
                        const platformName = dev.deviceplatform || dev.device || '';
                        html += `
                            <div style="padding: 10px; background: ${isTop ? 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)' : '#f5f5f5'}; border-radius: 8px; text-align: center; ${isTop ? 'border: 2px solid #1976d2;' : ''}">
                                <div style="font-size: 9px; color: var(--grey-600); margin-bottom: 2px;">${platformName}</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${roas >= 100 ? '#1565c0' : '#c62828'};">${roas.toFixed(0)}%</div>
                                ${isTop ? '<div style="font-size: 8px; color: #1976d2; margin-top: 2px;">🏆 1위</div>' : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            } else if (tab === 'category') {
                // 채널별 예측
                if (forecast.by_category && forecast.by_category.length > 0) {
                    const sorted = [...forecast.by_category].sort((a, b) => (b.avg_forecast_roas || 0) - (a.avg_forecast_roas || 0));
                    const good = sorted.filter(c => (c.avg_forecast_roas || 0) >= 100);
                    const poor = sorted.filter(c => (c.avg_forecast_roas || 0) < 100);

                    html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">`;

                    // 효율 양호
                    html += `<div style="padding: 10px; background: #e8f5e9; border-radius: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 6px;">✅ 효율 양호</div>`;
                    good.forEach(cat => {
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;">${cat.category}</span>
                                <span style="font-weight: 700; color: #1b5e20;">${(cat.avg_forecast_roas || 0).toFixed(0)}%</span>
                            </div>
                        `;
                    });
                    if (good.length === 0) html += '<div style="font-size: 10px; color: var(--grey-500);">데이터 없음</div>';
                    html += '</div>';

                    // 개선 필요
                    html += `<div style="padding: 10px; background: #ffebee; border-radius: 8px;">
                        <div style="font-size: 10px; font-weight: 600; color: #c62828; margin-bottom: 6px;">⚠️ 개선 필요</div>`;
                    poor.forEach(cat => {
                        html += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;">${cat.category}</span>
                                <span style="font-weight: 700; color: #b71c1c;">${(cat.avg_forecast_roas || 0).toFixed(0)}%</span>
                            </div>
                        `;
                    });
                    if (poor.length === 0) html += '<div style="font-size: 10px; color: var(--grey-500);">데이터 없음</div>';
                    html += '</div></div>';
                }
            }

            container.innerHTML = html || '<div style="text-align: center; padding: 20px; color: var(--grey-500); font-size: 12px;">데이터가 없습니다</div>';
        }

        // 의사결정 도구 탭 전환 초기화
        function initDecisionToolTabs() {
            const tabMapping = {
                'summary': 'summaryTab',
                'opportunity': 'opportunityTab',
                'warning': 'warningTab',
                'targeting': 'targetingTab',
                'dayAnalysis': 'dayAnalysisTab',
                'forecast': 'forecastTab'
            };

            document.querySelectorAll('.decision-tool-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.decision-tool-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.decision-tool-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    const tabId = tabMapping[targetTab];
                    const selectedTab = tabId ? document.getElementById(tabId) : null;

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }

                    // 계절성 분석 탭 선택 시 기본 렌더링 (분기별 추이가 기본)
                    if (targetTab === 'dayAnalysis') {
                        renderQuarterlyTrendChart();
                        renderQuarterlyTable();
                        renderSeasonalityTable();
                        renderSeasonalityCategoryTable();
                        setupRetargetingSortEvents();
                    }
                });
            });

            // 기본으로 '오늘의 요약' 탭 활성화
            const defaultBtn = document.querySelector('.decision-tool-tab-btn[data-tab="summary"]');
            if (defaultBtn) {
                defaultBtn.click();
            }

            // 기간 필터 버튼 이벤트 리스너 추가
            document.querySelectorAll('.period-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.dataset.period;
                    if (period) {
                        switchPeriod(period);
                    }
                });
            });

            // 요일별 분석 서브탭 이벤트 초기화
            initDayAnalysisSubtabs();
        }

        // 요일별 분석 서브탭 전환 이벤트
        function initDayAnalysisSubtabs() {
            document.querySelectorAll('.day-analysis-subtab').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 스타일 변경
                    document.querySelectorAll('.day-analysis-subtab').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#546e7a';
                        b.style.border = '1px solid #b0bec5';
                    });
                    this.style.background = '#673ab7';
                    this.style.color = 'white';
                    this.style.border = 'none';

                    // 콘텐츠 전환
                    const targetTab = this.dataset.dayTab;
                    document.querySelectorAll('.day-analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    const viewMap = {
                        'quarterlyTrend': 'quarterlyTrendView',
                        'dayConversion': 'dayConversionView',
                        'channelDay': 'channelDayView'
                    };

                    const targetView = document.getElementById(viewMap[targetTab]);
                    if (targetView) {
                        targetView.style.display = 'block';
                        targetView.classList.add('active');

                        // 분기별 추이 탭 선택 시 차트 렌더링
                        if (targetTab === 'quarterlyTrend') {
                            renderQuarterlyTrendChart();
                            renderQuarterlyTable();
                        }

                        // 채널별 요일 탭 선택 시 차트 및 KPI 카드 렌더링
                        if (targetTab === 'channelDay') {
                            renderChannelDayKpiCards();
                            renderChannelDayRoasChart();
                            renderSeasonalityCategoryTable();
                        }
                    }
                });
            });
        }

        // 성별 차트
        function renderGenderChart() {
            const periodData = getPeriodData();
            // 알수없음 필터링 및 비용 > 0 필터 적용
            const genders = periodData.gender_performance
                .filter(g => g.cost > 0 && isValidGender(g.gender))
                .map(g => ({
                    ...g,
                    displayGender: normalizeGender(g.gender) || g.gender
                }));

            const ctx = document.getElementById('genderChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: genders.map(g => g.displayGender),
                    datasets: [{
                        data: genders.map(g => g.roas),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = genders[context.dataIndex];
                                    return [
                                        `${item.displayGender}`,
                                        `ROAS: ${formatPercent(item.roas)}`,
                                        `전환수: ${formatNumber(item.conversions)}`,
                                        `성과: ${item.performance_level}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // 플랫폼 차트
        function renderPlatformChart() {
            const periodData = getPeriodData();
            const platforms = periodData.deviceplatform_performance;

            const ctx = document.getElementById('platformChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: platforms.map(p => p.deviceplatform),
                    datasets: [{
                        data: platforms.map(p => p.revenue),
                        backgroundColor: [
                            'rgba(103, 58, 183, 0.8)',
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(0, 200, 83, 0.8)',
                            'rgba(255, 171, 0, 0.8)',
                            'rgba(255, 23, 68, 0.8)',
                            'rgba(156, 39, 176, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = platforms[context.dataIndex];
                                    return [
                                        `${item.deviceplatform}`,
                                        `전환값: ${formatCurrency(item.revenue)}`,
                                        `ROAS: ${formatPercent(item.roas)}`,
                                        `전환수: ${formatNumber(item.conversions)}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // 브랜드 성과 차트
        // 성과분석 차트 상태 관리
        // 성과 분석 차트 기본 표시 개수
        const PERF_DEFAULT_LIMIT = 10;
        const PERF_EXPANDED_LIMIT = 50;

        let perfChartState = {
            brand: { kpi: 'roas', sort: 'desc', chart: null, startDate: '', endDate: '', compareActive: false, startDateComp: '', endDateComp: '', showAll: false, totalCount: 0 },
            product: { kpi: 'roas', sort: 'desc', chart: null, startDate: '', endDate: '', compareActive: false, startDateComp: '', endDateComp: '', showAll: false, totalCount: 0 },
            promotion: { kpi: 'roas', sort: 'desc', chart: null, startDate: '', endDate: '', compareActive: false, startDateComp: '', endDateComp: '', showAll: false, totalCount: 0 },
            targeting: { kpi: 'roas', sort: 'desc', chart: null, startDate: '', endDate: '', compareActive: false, startDateComp: '', endDateComp: '', showAll: false, totalCount: 0 }
        };

        // KPI별 색상
        const kpiColors = {
            roas: { bg: 'rgba(0, 200, 83, 0.8)', border: 'rgba(0, 200, 83, 1)' },
            cost: { bg: 'rgba(255, 152, 0, 0.8)', border: 'rgba(255, 152, 0, 1)' },
            cpa: { bg: 'rgba(244, 67, 54, 0.8)', border: 'rgba(244, 67, 54, 1)' },
            conversions: { bg: 'rgba(33, 150, 243, 0.8)', border: 'rgba(33, 150, 243, 1)' },
            revenue: { bg: 'rgba(156, 39, 176, 0.8)', border: 'rgba(156, 39, 176, 1)' }
        };

        // KPI별 라벨
        const kpiLabels = {
            roas: 'ROAS (%)',
            cost: '비용 (원)',
            cpa: 'CPA (원)',
            conversions: '전환수',
            revenue: '전환값 (원)'
        };

        // 비교 기간 색상
        const compareColors = {
            current: { bg: 'rgba(0, 200, 83, 0.8)', border: 'rgba(0, 200, 83, 1)' },
            previous: { bg: 'rgba(158, 158, 158, 0.5)', border: 'rgba(158, 158, 158, 1)' }
        };

        // 기간별 데이터 필터링 함수
        function filterDataByDateRange(data, startDate, endDate) {
            if (!startDate && !endDate) return data;

            return data.filter(row => {
                const rowDate = row['일'];
                if (!rowDate) return true;

                const date = new Date(rowDate);
                if (isNaN(date)) return true;

                if (startDate && date < new Date(startDate)) return false;
                if (endDate && date > new Date(endDate)) return false;
                return true;
            });
        }

        // 비교 기간 계산 함수
        function getComparisonDateRange(startDate, endDate, compareMode) {
            if (!startDate || !endDate || compareMode === 'none') return null;

            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

            let prevStart, prevEnd;

            if (compareMode === 'wow') {
                // 전주 대비: 7일 전 기간
                prevEnd = new Date(start);
                prevEnd.setDate(prevEnd.getDate() - 1);
                prevStart = new Date(prevEnd);
                prevStart.setDate(prevStart.getDate() - daysDiff);
            } else if (compareMode === 'mom') {
                // 전월 대비: 한 달 전 기간
                prevEnd = new Date(start);
                prevEnd.setDate(prevEnd.getDate() - 1);
                prevStart = new Date(prevEnd);
                prevStart.setMonth(prevStart.getMonth() - 1);
            }

            return {
                startDate: prevStart.toISOString().split('T')[0],
                endDate: prevEnd.toISOString().split('T')[0]
            };
        }

        // 증감률 계산 함수
        function calculateChangeRate(current, previous) {
            if (!previous || previous === 0) return null;
            return ((current - previous) / previous) * 100;
        }

        // 증감 화살표 HTML 생성
        function getChangeArrowHtml(changeRate) {
            if (changeRate === null || changeRate === undefined) return '';

            const isPositive = changeRate >= 0;
            const arrow = isPositive ? '▲' : '▼';
            const color = isPositive ? '#2e7d32' : '#d32f2f';
            const absRate = Math.abs(changeRate).toFixed(1);

            return `<span style="font-size: 10px; font-weight: 600; color: ${color}; margin-left: 4px;">${arrow}${absRate}%</span>`;
        }

        // 성과분석 차트 날짜 초기화 (공통)
        function initPerfChartDates() {
            if (!adsetDimensionData || adsetDimensionData.length === 0) return;

            // 데이터에서 최소/최대 날짜 찾기
            const dates = adsetDimensionData
                .map(row => row['일'])
                .filter(d => d)
                .map(d => new Date(d))
                .filter(d => !isNaN(d));

            if (dates.length === 0) return;

            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));

            const minStr = minDate.toISOString().split('T')[0];
            const maxStr = maxDate.toISOString().split('T')[0];

            // 공통 날짜 입력 초기화
            const startInput = document.getElementById('perfStartDate');
            const endInput = document.getElementById('perfEndDate');
            const periodPreset = document.getElementById('perfPeriodPreset');

            // 프리셋 기반 초기 날짜 계산 (최근 30일)
            const presetDays = periodPreset ? parseInt(periodPreset.value) || 30 : 30;
            const today = maxDate; // 데이터의 최대 날짜를 기준으로
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - presetDays + 1);

            // 데이터 범위 내로 조정
            const adjustedStart = startDate < minDate ? minDate : startDate;
            const startStr = adjustedStart.toISOString().split('T')[0];

            if (startInput && endInput) {
                startInput.value = startStr;
                endInput.value = maxStr;
                startInput.min = minStr;
                startInput.max = maxStr;
                endInput.min = minStr;
                endInput.max = maxStr;
            }

            // 공통 상태 설정
            perfCommonState.startDate = startStr;
            perfCommonState.endDate = maxStr;

            // 모든 카테고리에 동일 적용
            const categories = ['brand', 'product', 'promotion', 'targeting'];
            categories.forEach(category => {
                perfChartState[category].startDate = startStr;
                perfChartState[category].endDate = maxStr;

                // 상품/프로모션/타겟팅 뷰의 날짜 입력 필드 초기화
                const catStartInput = document.querySelector(`.perf-start-date[data-category="${category}"]`);
                const catEndInput = document.querySelector(`.perf-end-date[data-category="${category}"]`);
                if (catStartInput) {
                    catStartInput.value = startStr;
                    catStartInput.min = minStr;
                    catStartInput.max = maxStr;
                }
                if (catEndInput) {
                    catEndInput.value = maxStr;
                    catEndInput.min = minStr;
                    catEndInput.max = maxStr;
                }
            });
        }

        // 공통 성과분석 상태
        let perfCommonState = {
            kpi: 'roas',
            startDate: '',
            endDate: '',
            compareActive: false,
            startDateComp: '',
            endDateComp: ''
        };

        // 성과분석 날짜/비교 이벤트 설정 (각 탭 독립적 처리)
        function setupPerfChartDateEvents() {
            const categories = ['brand', 'product', 'promotion', 'targeting'];

            // ========== 모든 탭 이벤트 (클래스 기반 - 독립적 처리) ==========

            // KPI 선택 이벤트 (클래스 기반)
            document.querySelectorAll('.perf-kpi-select').forEach(kpiSelect => {
                kpiSelect.addEventListener('change', function() {
                    const category = this.dataset.category;
                    perfChartState[category].kpi = this.value;
                    renderPerformanceChart(category);
                });
            });

            // 정렬 선택 이벤트 (클래스 기반)
            document.querySelectorAll('.perf-sort-select').forEach(sortSelect => {
                sortSelect.addEventListener('change', function() {
                    const category = this.dataset.category;
                    perfChartState[category].sort = this.value;
                    renderPerformanceChart(category);
                });
            });

            // 기간 프리셋 드롭다운 이벤트 (클래스 기반)
            document.querySelectorAll('.perf-period-preset').forEach(preset => {
                preset.addEventListener('change', function() {
                    const category = this.dataset.category;
                    const days = parseInt(this.value);
                    if (!this.value || isNaN(days)) return;

                    const today = new Date();
                    const startDate = new Date();
                    startDate.setDate(today.getDate() - days + 1);

                    const formatDate = (d) => d.toISOString().split('T')[0];
                    const startInput = document.querySelector(`.perf-start-date[data-category="${category}"]`);
                    const endInput = document.querySelector(`.perf-end-date[data-category="${category}"]`);

                    if (startInput) startInput.value = formatDate(startDate);
                    if (endInput) endInput.value = formatDate(today);

                    perfChartState[category].startDate = formatDate(startDate);
                    perfChartState[category].endDate = formatDate(today);
                    renderPerformanceChart(category);
                });
            });

            // 기간 프리셋 드롭다운 이벤트 - 비교 기간 (클래스 기반)
            document.querySelectorAll('.perf-period-preset-comp').forEach(preset => {
                preset.addEventListener('change', function() {
                    const category = this.dataset.category;
                    const days = parseInt(this.value);
                    if (!this.value || isNaN(days)) return;

                    const baseStart = perfChartState[category].startDate ? new Date(perfChartState[category].startDate) : new Date();
                    const endDate = new Date(baseStart);
                    endDate.setDate(baseStart.getDate() - 1);
                    const startDate = new Date(endDate);
                    startDate.setDate(endDate.getDate() - days + 1);

                    const formatDate = (d) => d.toISOString().split('T')[0];
                    const startInputComp = document.querySelector(`.perf-start-date-comp[data-category="${category}"]`);
                    const endInputComp = document.querySelector(`.perf-end-date-comp[data-category="${category}"]`);

                    if (startInputComp) startInputComp.value = formatDate(startDate);
                    if (endInputComp) endInputComp.value = formatDate(endDate);

                    perfChartState[category].startDateComp = formatDate(startDate);
                    perfChartState[category].endDateComp = formatDate(endDate);
                    renderPerformanceChart(category);
                });
            });

            // 날짜 입력 이벤트 (클래스 기반)
            document.querySelectorAll('.perf-start-date').forEach(input => {
                input.addEventListener('change', function() {
                    const category = this.dataset.category;
                    perfChartState[category].startDate = this.value;
                    // 수동 날짜 지정 시 프리셋 초기화
                    const preset = document.querySelector(`.perf-period-preset[data-category="${category}"]`);
                    if (preset) preset.value = '';
                    renderPerformanceChart(category);
                });
            });

            document.querySelectorAll('.perf-end-date').forEach(input => {
                input.addEventListener('change', function() {
                    const category = this.dataset.category;
                    perfChartState[category].endDate = this.value;
                    // 수동 날짜 지정 시 프리셋 초기화
                    const preset = document.querySelector(`.perf-period-preset[data-category="${category}"]`);
                    if (preset) preset.value = '';
                    renderPerformanceChart(category);
                });
            });

            // 비교 기간 날짜 입력 이벤트 (클래스 기반)
            document.querySelectorAll('.perf-start-date-comp').forEach(input => {
                input.addEventListener('change', function() {
                    const category = this.dataset.category;
                    perfChartState[category].startDateComp = this.value;
                    // 수동 날짜 지정 시 프리셋 초기화
                    const preset = document.querySelector(`.perf-period-preset-comp[data-category="${category}"]`);
                    if (preset) preset.value = '';
                    renderPerformanceChart(category);
                });
            });

            document.querySelectorAll('.perf-end-date-comp').forEach(input => {
                input.addEventListener('change', function() {
                    const category = this.dataset.category;
                    perfChartState[category].endDateComp = this.value;
                    // 수동 날짜 지정 시 프리셋 초기화
                    const preset = document.querySelector(`.perf-period-preset-comp[data-category="${category}"]`);
                    if (preset) preset.value = '';
                    renderPerformanceChart(category);
                });
            });

            // 비교 버튼 이벤트 (클래스 기반)
            document.querySelectorAll('.perf-compare-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const compareRow = document.querySelector(`.perf-compare-row[data-category="${category}"]`);

                    perfChartState[category].compareActive = !perfChartState[category].compareActive;

                    if (perfChartState[category].compareActive) {
                        // 비교 모드 활성화
                        if (compareRow) compareRow.style.display = 'flex';
                        this.textContent = '취소';
                        this.style.background = '#d32f2f';
                        this.style.color = 'white';
                        this.style.borderColor = '#d32f2f';

                        // 비교 기간 기본값 설정
                        if (perfChartState[category].startDate && perfChartState[category].endDate) {
                            const start = new Date(perfChartState[category].startDate);
                            const end = new Date(perfChartState[category].endDate);
                            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

                            const prevEnd = new Date(start);
                            prevEnd.setDate(prevEnd.getDate() - 1);
                            const prevStart = new Date(prevEnd);
                            prevStart.setDate(prevStart.getDate() - daysDiff);

                            perfChartState[category].startDateComp = prevStart.toISOString().split('T')[0];
                            perfChartState[category].endDateComp = prevEnd.toISOString().split('T')[0];

                            const startInputComp = document.querySelector(`.perf-start-date-comp[data-category="${category}"]`);
                            const endInputComp = document.querySelector(`.perf-end-date-comp[data-category="${category}"]`);
                            if (startInputComp) startInputComp.value = perfChartState[category].startDateComp;
                            if (endInputComp) endInputComp.value = perfChartState[category].endDateComp;
                        }
                    } else {
                        // 비교 모드 비활성화
                        if (compareRow) compareRow.style.display = 'none';
                        this.textContent = '비교';
                        this.style.background = 'white';
                        this.style.color = '#673ab7';
                        this.style.borderColor = '#673ab7';

                        perfChartState[category].startDateComp = '';
                        perfChartState[category].endDateComp = '';
                    }

                    renderPerformanceChart(category);
                });
            });
        }

        // 성과 분석 더보기 버튼 업데이트 함수
        function updatePerfShowMoreButton(category, totalCount, currentLimit, isExpanded) {
            const container = document.getElementById(`perf${category.charAt(0).toUpperCase() + category.slice(1)}ShowMoreContainer`);
            if (!container) return;

            if (totalCount <= PERF_DEFAULT_LIMIT) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            const button = container.querySelector('.perf-show-more-btn');
            if (!button) return;

            if (isExpanded) {
                button.textContent = '접기';
                button.style.background = '#f5f5f5';
                button.style.color = '#666';
            } else {
                const remaining = totalCount - currentLimit;
                button.textContent = `더보기 (+${remaining}개)`;
                button.style.background = '#e3f2fd';
                button.style.color = '#1976d2';
            }
        }

        // 모든 성과분석 차트 렌더링
        function renderAllPerformanceCharts() {
            renderBrandPerformanceChart();
            renderProductPerformanceChart();
            renderPromotionPerformanceChart();
            renderTargetingPerformanceChart();
        }

        // 브랜드 성과 차트 - adsetDimensionData(dimension_type1_campaign_adset.csv) 사용
        function renderBrandPerformanceChart() {
            const state = perfChartState.brand;

            // 데이터 집계 헬퍼 함수
            function aggregateBrandData(data) {
                const groupedData = {};
                data.forEach(row => {
                    const brand = row['브랜드명'];
                    if (!brand) return;
                    if (!groupedData[brand]) {
                        groupedData[brand] = { brand: brand, cost: 0, conversions: 0, revenue: 0 };
                    }
                    groupedData[brand].cost += parseFloat(row['비용']) || 0;
                    groupedData[brand].conversions += parseFloat(row['전환수']) || 0;
                    groupedData[brand].revenue += parseFloat(row['전환값']) || 0;
                });
                return Object.values(groupedData).map(g => ({
                    ...g,
                    roas: g.cost > 0 ? (g.revenue / g.cost) * 100 : 0,
                    cpa: g.conversions > 0 ? g.cost / g.conversions : 0
                })).filter(g => g.cost > 0);
            }

            // 현재 기간 데이터 필터링 및 집계
            let brandData = [];
            let prevBrandData = [];

            if (adsetDimensionData && adsetDimensionData.length > 0) {
                const filteredData = filterDataByDateRange(adsetDimensionData, state.startDate, state.endDate);
                brandData = aggregateBrandData(filteredData);

                // 비교 기간 데이터 처리
                if (state.compareActive && state.startDateComp && state.endDateComp) {
                    const prevFilteredData = filterDataByDateRange(adsetDimensionData, state.startDateComp, state.endDateComp);
                    prevBrandData = aggregateBrandData(prevFilteredData);
                }
            }

            // 정렬 (현재 기간 기준)
            const allSorted = [...brandData].sort((a, b) => {
                const aVal = a[state.kpi];
                const bVal = b[state.kpi];
                return state.sort === 'desc' ? bVal - aVal : aVal - bVal;
            });
            state.totalCount = allSorted.length;
            const limit = state.showAll ? PERF_EXPANDED_LIMIT : PERF_DEFAULT_LIMIT;
            let sorted = allSorted.slice(0, limit);

            // 비교 데이터 매핑
            const prevDataMap = {};
            prevBrandData.forEach(item => {
                prevDataMap[item.brand] = item;
            });

            // 라벨에 증감 화살표 추가
            const labels = sorted.map(b => {
                if (state.compareActive && prevDataMap[b.brand]) {
                    const changeRate = calculateChangeRate(b[state.kpi], prevDataMap[b.brand][state.kpi]);
                    const arrow = changeRate !== null ? (changeRate >= 0 ? ' ▲' : ' ▼') : '';
                    return b.brand + arrow;
                }
                return b.brand;
            });

            const currentValues = sorted.map(b => b[state.kpi]);
            const prevValues = sorted.map(b => prevDataMap[b.brand] ? prevDataMap[b.brand][state.kpi] : 0);

            if (state.chart) state.chart.destroy();

            const ctx = document.getElementById('brandPerformanceChart').getContext('2d');

            // 데이터셋 구성
            const datasets = [];

            if (state.compareActive && prevBrandData.length > 0) {
                // 비교 모드: 누적 바 차트
                datasets.push({
                    label: '이전 기간',
                    data: prevValues,
                    backgroundColor: compareColors.previous.bg,
                    borderColor: compareColors.previous.border,
                    borderWidth: 1,
                    borderRadius: 4
                });
                datasets.push({
                    label: '현재 기간',
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            } else {
                // 일반 모드: 단일 바 차트
                datasets.push({
                    label: kpiLabels[state.kpi],
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            }

            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: state.compareActive },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const item = sorted[idx];
                                    const prevItem = prevDataMap[item.brand];

                                    let lines = [
                                        `ROAS: ${formatPercent(item.roas)}`,
                                        `비용: ${formatCurrency(item.cost)}`,
                                        `CPA: ${formatCurrency(item.cpa)}`,
                                        `전환수: ${formatNumber(item.conversions)}`
                                    ];

                                    if (state.compareActive && prevItem) {
                                        const changeRate = calculateChangeRate(item[state.kpi], prevItem[state.kpi]);
                                        if (changeRate !== null) {
                                            const sign = changeRate >= 0 ? '+' : '';
                                            lines.push(`변화율: ${sign}${changeRate.toFixed(1)}%`);
                                        }
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            stacked: false
                        },
                        y: {
                            stacked: false,
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 15 ? label.substring(0, 15) + '...' : label;
                                }
                            }
                        }
                    }
                }
            });

            // 더보기 버튼 업데이트
            updatePerfShowMoreButton('brand', state.totalCount, limit, state.showAll);
        }

        // 상품 성과 차트 - adsetDimensionData(dimension_type1_campaign_adset.csv) 사용
        function renderProductPerformanceChart() {
            const state = perfChartState.product;

            // 데이터 집계 헬퍼 함수
            function aggregateProductData(data) {
                const groupedData = {};
                data.forEach(row => {
                    const product = row['상품명'];
                    if (!product) return;
                    if (!groupedData[product]) {
                        groupedData[product] = { product: product, cost: 0, conversions: 0, revenue: 0 };
                    }
                    groupedData[product].cost += parseFloat(row['비용']) || 0;
                    groupedData[product].conversions += parseFloat(row['전환수']) || 0;
                    groupedData[product].revenue += parseFloat(row['전환값']) || 0;
                });
                return Object.values(groupedData).map(g => ({
                    ...g,
                    roas: g.cost > 0 ? (g.revenue / g.cost) * 100 : 0,
                    cpa: g.conversions > 0 ? g.cost / g.conversions : 0
                })).filter(g => g.cost > 0);
            }

            let productData = [];
            let prevProductData = [];

            if (adsetDimensionData && adsetDimensionData.length > 0) {
                const filteredData = filterDataByDateRange(adsetDimensionData, state.startDate, state.endDate);
                productData = aggregateProductData(filteredData);

                if (state.compareActive && state.startDateComp && state.endDateComp) {
                    const prevFilteredData = filterDataByDateRange(adsetDimensionData, state.startDateComp, state.endDateComp);
                    prevProductData = aggregateProductData(prevFilteredData);
                }
            }

            const allSorted = [...productData].sort((a, b) => {
                const aVal = a[state.kpi];
                const bVal = b[state.kpi];
                return state.sort === 'desc' ? bVal - aVal : aVal - bVal;
            });
            state.totalCount = allSorted.length;
            const limit = state.showAll ? PERF_EXPANDED_LIMIT : PERF_DEFAULT_LIMIT;
            let sorted = allSorted.slice(0, limit);

            const prevDataMap = {};
            prevProductData.forEach(item => {
                prevDataMap[item.product] = item;
            });

            const labels = sorted.map(p => {
                if (state.compareActive && prevDataMap[p.product]) {
                    const changeRate = calculateChangeRate(p[state.kpi], prevDataMap[p.product][state.kpi]);
                    const arrow = changeRate !== null ? (changeRate >= 0 ? ' ▲' : ' ▼') : '';
                    return p.product + arrow;
                }
                return p.product;
            });

            const currentValues = sorted.map(p => p[state.kpi]);
            const prevValues = sorted.map(p => prevDataMap[p.product] ? prevDataMap[p.product][state.kpi] : 0);

            if (state.chart) state.chart.destroy();

            const ctx = document.getElementById('productPerformanceChart').getContext('2d');

            const datasets = [];
            if (state.compareActive && prevProductData.length > 0) {
                datasets.push({
                    label: '이전 기간',
                    data: prevValues,
                    backgroundColor: compareColors.previous.bg,
                    borderColor: compareColors.previous.border,
                    borderWidth: 1,
                    borderRadius: 4
                });
                datasets.push({
                    label: '현재 기간',
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            } else {
                datasets.push({
                    label: kpiLabels[state.kpi],
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            }

            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: state.compareActive },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const item = sorted[idx];
                                    const prevItem = prevDataMap[item.product];

                                    let lines = [
                                        `ROAS: ${formatPercent(item.roas)}`,
                                        `비용: ${formatCurrency(item.cost)}`,
                                        `CPA: ${formatCurrency(item.cpa)}`,
                                        `전환수: ${formatNumber(item.conversions)}`
                                    ];

                                    if (state.compareActive && prevItem) {
                                        const changeRate = calculateChangeRate(item[state.kpi], prevItem[state.kpi]);
                                        if (changeRate !== null) {
                                            const sign = changeRate >= 0 ? '+' : '';
                                            lines.push(`변화율: ${sign}${changeRate.toFixed(1)}%`);
                                        }
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, stacked: false },
                        y: {
                            stacked: false,
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 15 ? label.substring(0, 15) + '...' : label;
                                }
                            }
                        }
                    }
                }
            });

            // 더보기 버튼 업데이트
            updatePerfShowMoreButton('product', state.totalCount, limit, state.showAll);
        }

        // 프로모션 성과 차트 - adsetDimensionData(dimension_type1_campaign_adset.csv) 사용
        function renderPromotionPerformanceChart() {
            const state = perfChartState.promotion;

            // 데이터 집계 헬퍼 함수
            function aggregatePromotionData(data) {
                const groupedData = {};
                data.forEach(row => {
                    const promotion = row['프로모션'];
                    if (!promotion) return;
                    if (!groupedData[promotion]) {
                        groupedData[promotion] = { promotion: promotion, cost: 0, conversions: 0, revenue: 0 };
                    }
                    groupedData[promotion].cost += parseFloat(row['비용']) || 0;
                    groupedData[promotion].conversions += parseFloat(row['전환수']) || 0;
                    groupedData[promotion].revenue += parseFloat(row['전환값']) || 0;
                });
                return Object.values(groupedData).map(g => ({
                    ...g,
                    roas: g.cost > 0 ? (g.revenue / g.cost) * 100 : 0,
                    cpa: g.conversions > 0 ? g.cost / g.conversions : 0
                })).filter(g => g.cost > 0);
            }

            let promotionData = [];
            let prevPromotionData = [];

            if (adsetDimensionData && adsetDimensionData.length > 0) {
                const filteredData = filterDataByDateRange(adsetDimensionData, state.startDate, state.endDate);
                promotionData = aggregatePromotionData(filteredData);

                if (state.compareActive && state.startDateComp && state.endDateComp) {
                    const prevFilteredData = filterDataByDateRange(adsetDimensionData, state.startDateComp, state.endDateComp);
                    prevPromotionData = aggregatePromotionData(prevFilteredData);
                }
            }

            const allSorted = [...promotionData].sort((a, b) => {
                const aVal = a[state.kpi];
                const bVal = b[state.kpi];
                return state.sort === 'desc' ? bVal - aVal : aVal - bVal;
            });
            state.totalCount = allSorted.length;
            const limit = state.showAll ? PERF_EXPANDED_LIMIT : PERF_DEFAULT_LIMIT;
            let sorted = allSorted.slice(0, limit);

            const prevDataMap = {};
            prevPromotionData.forEach(item => {
                prevDataMap[item.promotion] = item;
            });

            const labels = sorted.map(p => {
                if (state.compareActive && prevDataMap[p.promotion]) {
                    const changeRate = calculateChangeRate(p[state.kpi], prevDataMap[p.promotion][state.kpi]);
                    const arrow = changeRate !== null ? (changeRate >= 0 ? ' ▲' : ' ▼') : '';
                    return p.promotion + arrow;
                }
                return p.promotion;
            });

            const currentValues = sorted.map(p => p[state.kpi]);
            const prevValues = sorted.map(p => prevDataMap[p.promotion] ? prevDataMap[p.promotion][state.kpi] : 0);

            if (state.chart) state.chart.destroy();

            const ctx = document.getElementById('promotionPerformanceChart').getContext('2d');

            const datasets = [];
            if (state.compareActive && prevPromotionData.length > 0) {
                datasets.push({
                    label: '이전 기간',
                    data: prevValues,
                    backgroundColor: compareColors.previous.bg,
                    borderColor: compareColors.previous.border,
                    borderWidth: 1,
                    borderRadius: 4
                });
                datasets.push({
                    label: '현재 기간',
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            } else {
                datasets.push({
                    label: kpiLabels[state.kpi],
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            }

            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: state.compareActive },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const item = sorted[idx];
                                    const prevItem = prevDataMap[item.promotion];

                                    let lines = [
                                        `ROAS: ${formatPercent(item.roas)}`,
                                        `비용: ${formatCurrency(item.cost)}`,
                                        `CPA: ${formatCurrency(item.cpa)}`,
                                        `전환수: ${formatNumber(item.conversions)}`
                                    ];

                                    if (state.compareActive && prevItem) {
                                        const changeRate = calculateChangeRate(item[state.kpi], prevItem[state.kpi]);
                                        if (changeRate !== null) {
                                            const sign = changeRate >= 0 ? '+' : '';
                                            lines.push(`변화율: ${sign}${changeRate.toFixed(1)}%`);
                                        }
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, stacked: false },
                        y: {
                            stacked: false,
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 15 ? label.substring(0, 15) + '...' : label;
                                }
                            }
                        }
                    }
                }
            });

            // 더보기 버튼 업데이트
            updatePerfShowMoreButton('promotion', state.totalCount, limit, state.showAll);
        }

        // 타겟팅 성과 차트 - adsetDimensionData(dimension_type1_campaign_adset.csv)의 '타겟팅' 컬럼 사용
        function renderTargetingPerformanceChart() {
            const state = perfChartState.targeting;

            // 데이터 집계 헬퍼 함수
            function aggregateTargetingData(data) {
                const groupedData = {};
                data.forEach(row => {
                    const targeting = row['타겟팅'];
                    if (!targeting || targeting === '' || targeting === '-') return;

                    if (!groupedData[targeting]) {
                        groupedData[targeting] = { targeting: targeting, cost: 0, conversions: 0, revenue: 0 };
                    }
                    groupedData[targeting].cost += parseFloat(row['비용']) || 0;
                    groupedData[targeting].conversions += parseFloat(row['전환수']) || 0;
                    groupedData[targeting].revenue += parseFloat(row['전환값']) || 0;
                });

                return Object.values(groupedData).map(g => ({
                    ...g,
                    roas: g.cost > 0 ? (g.revenue / g.cost) * 100 : 0,
                    cpa: g.conversions > 0 ? g.cost / g.conversions : 0,
                    label: g.targeting
                })).filter(g => g.cost > 0);
            }

            let targetingData = [];
            let prevTargetingData = [];

            if (adsetDimensionData && adsetDimensionData.length > 0) {
                const filteredData = filterDataByDateRange(adsetDimensionData, state.startDate, state.endDate);
                targetingData = aggregateTargetingData(filteredData);

                if (state.compareActive && state.startDateComp && state.endDateComp) {
                    const prevFilteredData = filterDataByDateRange(adsetDimensionData, state.startDateComp, state.endDateComp);
                    prevTargetingData = aggregateTargetingData(prevFilteredData);
                }
            }

            const allSorted = [...targetingData].sort((a, b) => {
                const aVal = a[state.kpi];
                const bVal = b[state.kpi];
                return state.sort === 'desc' ? bVal - aVal : aVal - bVal;
            });
            state.totalCount = allSorted.length;
            const limit = state.showAll ? PERF_EXPANDED_LIMIT : PERF_DEFAULT_LIMIT;
            let sorted = allSorted.slice(0, limit);

            const prevDataMap = {};
            prevTargetingData.forEach(item => {
                prevDataMap[item.targeting] = item;
            });

            const labels = sorted.map(t => {
                if (state.compareActive && prevDataMap[t.targeting]) {
                    const changeRate = calculateChangeRate(t[state.kpi], prevDataMap[t.targeting][state.kpi]);
                    const arrow = changeRate !== null ? (changeRate >= 0 ? ' ▲' : ' ▼') : '';
                    return t.label + arrow;
                }
                return t.label;
            });

            const currentValues = sorted.map(t => t[state.kpi]);
            const prevValues = sorted.map(t => prevDataMap[t.targeting] ? prevDataMap[t.targeting][state.kpi] : 0);

            if (state.chart) state.chart.destroy();

            const ctx = document.getElementById('targetingPerformanceChart').getContext('2d');

            const datasets = [];
            if (state.compareActive && prevTargetingData.length > 0) {
                datasets.push({
                    label: '이전 기간',
                    data: prevValues,
                    backgroundColor: compareColors.previous.bg,
                    borderColor: compareColors.previous.border,
                    borderWidth: 1,
                    borderRadius: 4
                });
                datasets.push({
                    label: '현재 기간',
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            } else {
                datasets.push({
                    label: kpiLabels[state.kpi],
                    data: currentValues,
                    backgroundColor: kpiColors[state.kpi].bg,
                    borderColor: kpiColors[state.kpi].border,
                    borderWidth: 1,
                    borderRadius: 4
                });
            }

            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: state.compareActive },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const idx = context.dataIndex;
                                    const item = sorted[idx];
                                    const prevItem = prevDataMap[item.targeting];

                                    let lines = [
                                        `ROAS: ${formatPercent(item.roas)}`,
                                        `비용: ${formatCurrency(item.cost)}`,
                                        `CPA: ${formatCurrency(item.cpa)}`,
                                        `전환수: ${formatNumber(item.conversions)}`
                                    ];

                                    if (state.compareActive && prevItem) {
                                        const changeRate = calculateChangeRate(item[state.kpi], prevItem[state.kpi]);
                                        if (changeRate !== null) {
                                            const sign = changeRate >= 0 ? '+' : '';
                                            lines.push(`변화율: ${sign}${changeRate.toFixed(1)}%`);
                                        }
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, stacked: false },
                        y: {
                            stacked: false,
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });

            // 더보기 버튼 업데이트
            updatePerfShowMoreButton('targeting', state.totalCount, limit, state.showAll);
        }

        // 성과분석 KPI/정렬 드롭다운 이벤트
        function setupPerformanceControls() {
            // 정렬 드롭다운
            document.querySelectorAll('.perf-sort-select').forEach(select => {
                select.addEventListener('change', function() {
                    const category = this.dataset.category;
                    const sort = this.value;

                    // 상태 업데이트 및 차트 재렌더링
                    perfChartState[category].sort = sort;
                    renderPerformanceChart(category);
                });
            });
        }

        // 카테고리별 차트 렌더링
        function renderPerformanceChart(category) {
            switch(category) {
                case 'brand': renderBrandPerformanceChart(); break;
                case 'product': renderProductPerformanceChart(); break;
                case 'promotion': renderPromotionPerformanceChart(); break;
                case 'targeting': renderTargetingPerformanceChart(); break;
            }
        }

        // 성과 분석 더보기 버튼 이벤트 설정
        function setupPerfShowMoreButtons() {
            document.querySelectorAll('.perf-show-more-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.dataset.category;
                    perfChartState[category].showAll = !perfChartState[category].showAll;
                    renderPerformanceChart(category);
                });
            });
        }

        // 모든 성과분석 차트 초기화
        function initPerformanceCharts() {
            // 공통 날짜 초기화
            initPerfChartDates();

            // 날짜/비교 이벤트 설정
            setupPerfChartDateEvents();

            // 차트 렌더링
            renderAllPerformanceCharts();
            setupPerformanceControls();

            // 더보기 버튼 이벤트 설정
            setupPerfShowMoreButtons();
        }

        // ========== 성과 테이블 분석 ==========

        // 성과 테이블 상태 관리
        const perfTableState = {
            adset: { filters: { channel: [], product: [], brand: [], promotion: [] }, startDate: '', endDate: '', sortColumn: 'roas', sortDirection: 'desc' },
            gender: { filters: { channel: [], product: [], brand: [], promotion: [] }, startDate: '', endDate: '', sortColumn: 'roas', sortDirection: 'desc' },
            age: { filters: { channel: [], product: [], brand: [], promotion: [] }, startDate: '', endDate: '', sortColumn: 'roas', sortDirection: 'desc' },
            platform: { filters: { channel: [], product: [], brand: [], promotion: [] }, startDate: '', endDate: '', sortColumn: 'roas', sortDirection: 'desc' },
            devicePlatform: { filters: { channel: [], product: [], brand: [], promotion: [] }, startDate: '', endDate: '', sortColumn: 'roas', sortDirection: 'desc' },
            deviceType: { filters: { channel: [], product: [], brand: [], promotion: [] }, startDate: '', endDate: '', sortColumn: 'roas', sortDirection: 'desc' },
            genderAge: { filters: { channel: [], product: [], brand: [], promotion: [] }, startDate: '', endDate: '' }
        };

        // 테이블 지표 정의
        const perfTableMetrics = [
            { key: 'cost', label: '비용', format: (v) => formatCurrency(v) },
            { key: 'impressions', label: '노출수', format: (v) => formatNumber(v) },
            { key: 'cpm', label: 'CPM', format: (v) => formatCurrency(v) },
            { key: 'clicks', label: '클릭수', format: (v) => formatNumber(v) },
            { key: 'cpc', label: 'CPC', format: (v) => formatCurrency(v) },
            { key: 'ctr', label: 'CTR', format: (v) => v.toFixed(2) + '%' },
            { key: 'conversions', label: '전환수', format: (v) => formatNumber(v) },
            { key: 'cpa', label: 'CPA', format: (v) => formatCurrency(v) },
            { key: 'cvr', label: '전환율', format: (v) => v.toFixed(2) + '%' },
            { key: 'revenue', label: '전환값', format: (v) => formatCurrency(v) },
            { key: 'roas', label: 'ROAS', format: (v) => v.toFixed(1) + '%' }
        ];

        // 색상 스케일 함수
        function getPerfTableColorScale(value, min, max, isInverse = false) {
            if (max === min) return 'rgba(103, 58, 183, 0.1)';
            let ratio = (value - min) / (max - min);
            if (isInverse) ratio = 1 - ratio;
            const r = Math.round(255 - (152 * ratio));
            const g = Math.round(255 - (197 * ratio));
            const b = Math.round(255 - (72 * ratio));
            const alpha = 0.1 + (ratio * 0.3);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // 모든 탭 필터 초기화
        function initPerfTableFilters() {
            if (!adsetDimensionData || adsetDimensionData.length === 0) return;

            // 탭별 필터 설정
            const tabConfigs = ['Adset', 'Gender', 'Age', 'Platform', 'DevicePlatform', 'DeviceType', 'GenderAge'];

            tabConfigs.forEach(tabName => {
                const tabKey = tabName === 'Adset' ? 'adset' :
                               tabName === 'DevicePlatform' ? 'devicePlatform' :
                               tabName === 'DeviceType' ? 'deviceType' :
                               tabName === 'GenderAge' ? 'genderAge' : tabName.toLowerCase();

                const filterConfigs = [
                    { key: 'channel', column: '유형구분', listId: `perfTable${tabName}ChannelList` },
                    { key: 'product', column: '상품명', listId: `perfTable${tabName}ProductList` },
                    { key: 'brand', column: '브랜드명', listId: `perfTable${tabName}BrandList` },
                    { key: 'promotion', column: '프로모션', listId: `perfTable${tabName}PromotionList` }
                ];

                filterConfigs.forEach(config => {
                    const values = [...new Set(adsetDimensionData.map(row => row[config.column]).filter(v => v && v !== '' && v !== '-'))].sort();
                    const listContainer = document.getElementById(config.listId);
                    if (!listContainer) return;

                    listContainer.innerHTML = values.map(value => `
                        <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-size: 12px; color: var(--grey-700); transition: background 0.2s; border-radius: 4px;">
                            <input type="checkbox" class="perf-table-filter-checkbox" data-filter="${config.key}" data-tab="${tabKey}" value="${value}" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                            ${value}
                        </label>
                    `).join('');
                });
            });
        }

        // 광고세트 테이블 렌더링
        function renderPerfTableAdset() {
            const container = document.getElementById('perfTableAdsetContainer');
            if (!container || !adsetDimensionData) return;

            const state = perfTableState.adset;
            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션' };

            // 필터 조건 확인
            const allFiltersEmpty = Object.values(state.filters).every(arr => !arr || arr.length === 0);
            if (allFiltersEmpty) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--grey-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">필터를 선택해주세요</div>
                        <div style="font-size: 13px; color: var(--grey-400);">위의 분류 기준에서 하나 이상의 항목을 선택해주세요.</div>
                    </div>
                `;
                document.getElementById('perfTableAdsetCount').textContent = '0';
                return;
            }

            // 데이터 필터링 및 집계
            const aggregatedData = {};
            adsetDimensionData.forEach(row => {
                // 필터 조건 확인
                for (const filterKey of Object.keys(filterMap)) {
                    const column = filterMap[filterKey];
                    const selectedValues = state.filters[filterKey];
                    if (selectedValues && selectedValues.length > 0) {
                        if (!selectedValues.includes(row[column])) return;
                    }
                }

                // 기간 필터링
                const date = row['일'];
                if (state.startDate || state.endDate) {
                    const rowDate = new Date(date);
                    if (isNaN(rowDate)) return;
                    if (state.startDate && rowDate < new Date(state.startDate)) return;
                    if (state.endDate && rowDate > new Date(state.endDate)) return;
                }

                const adset = row['광고세트'];
                if (!adset || adset === '' || adset === '-') return;

                if (!aggregatedData[adset]) {
                    aggregatedData[adset] = { name: adset, cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                }

                aggregatedData[adset].cost += parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                aggregatedData[adset].revenue += parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                aggregatedData[adset].conversions += parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                aggregatedData[adset].impressions += parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                aggregatedData[adset].clicks += parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;
            });

            // 지표 계산
            let dataList = Object.values(aggregatedData);
            dataList.forEach(item => {
                item.roas = item.cost > 0 ? (item.revenue / item.cost * 100) : 0;
                item.cpm = item.impressions > 0 ? (item.cost / item.impressions * 1000) : 0;
                item.cpc = item.clicks > 0 ? (item.cost / item.clicks) : 0;
                item.cpa = item.conversions > 0 ? (item.cost / item.conversions) : 0;
                item.ctr = item.impressions > 0 ? (item.clicks / item.impressions * 100) : 0;
                item.cvr = item.clicks > 0 ? (item.conversions / item.clicks * 100) : 0;
            });

            document.getElementById('perfTableAdsetCount').textContent = dataList.length;

            if (dataList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--grey-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">데이터가 없습니다</div>
                        <div style="font-size: 13px; color: var(--grey-400);">선택한 조건에 맞는 데이터가 없습니다.</div>
                    </div>
                `;
                return;
            }

            // 정렬
            dataList.sort((a, b) => {
                const aVal = a[state.sortColumn] || 0;
                const bVal = b[state.sortColumn] || 0;
                return state.sortDirection === 'desc' ? bVal - aVal : aVal - bVal;
            });

            // 지표별 최소/최대값 계산
            const metricRanges = {};
            perfTableMetrics.forEach(metric => {
                let min = Infinity, max = -Infinity;
                dataList.forEach(item => {
                    const value = item[metric.key] || 0;
                    if (value < min) min = value;
                    if (value > max) max = value;
                });
                metricRanges[metric.key] = { min, max };
            });

            // 테이블 HTML 생성
            const isInverseMetric = (key) => ['cpm', 'cpc', 'cpa'].includes(key);

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1200px;">
                    <thead>
                        <tr style="background: var(--grey-100);">
                            <th style="padding: 12px 10px; text-align: left; font-weight: 700; border: 1px solid var(--grey-300); background: var(--grey-200); min-width: 150px; position: sticky; left: 0; z-index: 10;">
                                광고세트
                            </th>
            `;

            perfTableMetrics.forEach(metric => {
                const isSorted = state.sortColumn === metric.key;
                const sortIcon = isSorted ? (state.sortDirection === 'desc' ? ' ▼' : ' ▲') : '';
                tableHTML += `
                    <th class="perf-table-sort-header" data-column="${metric.key}" data-tab="adset" style="padding: 12px 8px; text-align: right; font-weight: 600; border: 1px solid var(--grey-300); background: ${isSorted ? 'var(--primary-light)' : 'var(--grey-100)'}; cursor: pointer; white-space: nowrap; transition: background 0.2s;">
                        ${metric.label}${sortIcon}
                    </th>
                `;
            });

            tableHTML += `</tr></thead><tbody>`;

            dataList.forEach((item, index) => {
                const rowBg = index % 2 === 0 ? 'var(--paper)' : 'var(--grey-50)';
                tableHTML += `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 10px; font-weight: 500; border: 1px solid var(--grey-300); background: var(--grey-50); position: sticky; left: 0; z-index: 5; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.name}">
                            ${item.name}
                        </td>
                `;

                perfTableMetrics.forEach(metric => {
                    const value = item[metric.key] || 0;
                    const range = metricRanges[metric.key];
                    const bgColor = getPerfTableColorScale(value, range.min, range.max, isInverseMetric(metric.key));
                    tableHTML += `
                        <td style="padding: 10px 8px; text-align: right; border: 1px solid var(--grey-300); background: ${bgColor}; font-variant-numeric: tabular-nums;">
                            ${metric.format(value)}
                        </td>
                    `;
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        // 범용 테이블 렌더링 함수 (성별, 연령, 플랫폼, 기기플랫폼, 기기용)
        function renderPerfTableGeneric(tabName, dataSource, dimensionColumn, dimensionLabel) {
            const tabNameCapitalized = tabName === 'devicePlatform' ? 'DevicePlatform' :
                                       tabName === 'deviceType' ? 'DeviceType' :
                                       tabName.charAt(0).toUpperCase() + tabName.slice(1);
            const containerId = `perfTable${tabNameCapitalized}Container`;
            const countId = `perfTable${tabNameCapitalized}Count`;
            const container = document.getElementById(containerId);
            if (!container || !dataSource || dataSource.length === 0) return;

            const state = perfTableState[tabName];
            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션' };

            // 필터 조건 확인
            const allFiltersEmpty = !state.filters || Object.values(state.filters).every(arr => !arr || arr.length === 0);
            if (allFiltersEmpty) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--grey-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">필터를 선택해주세요</div>
                        <div style="font-size: 13px; color: var(--grey-400);">위의 분류 기준에서 하나 이상의 항목을 선택해주세요.</div>
                    </div>
                `;
                const countEl = document.getElementById(countId);
                if (countEl) countEl.textContent = '0';
                return;
            }

            // 데이터 집계
            const aggregatedData = {};
            dataSource.forEach(row => {
                // 필터 조건 확인 (adsetDimensionData에서 필터 컬럼 사용)
                if (state.filters) {
                    for (const filterKey of Object.keys(filterMap)) {
                        const column = filterMap[filterKey];
                        const selectedValues = state.filters[filterKey];
                        if (selectedValues && selectedValues.length > 0) {
                            if (!selectedValues.includes(row[column])) return;
                        }
                    }
                }

                // 기간 필터링
                const date = row['일'];
                if (state.startDate || state.endDate) {
                    const rowDate = new Date(date);
                    if (isNaN(rowDate)) return;
                    if (state.startDate && rowDate < new Date(state.startDate)) return;
                    if (state.endDate && rowDate > new Date(state.endDate)) return;
                }

                let dimensionValue = row[dimensionColumn + '_통합'] || row[dimensionColumn];
                if (!dimensionValue || dimensionValue === '' || dimensionValue === '-') return;

                // 성별 정규화
                if (tabName === 'gender') {
                    dimensionValue = normalizeGender(dimensionValue);
                    if (!dimensionValue || dimensionValue === 'Unknown') return;
                }

                if (!aggregatedData[dimensionValue]) {
                    aggregatedData[dimensionValue] = { name: dimensionValue, cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                }

                aggregatedData[dimensionValue].cost += parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                aggregatedData[dimensionValue].revenue += parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                aggregatedData[dimensionValue].conversions += parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                aggregatedData[dimensionValue].impressions += parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                aggregatedData[dimensionValue].clicks += parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;
            });

            // 지표 계산
            let dataList = Object.values(aggregatedData);
            dataList.forEach(item => {
                item.roas = item.cost > 0 ? (item.revenue / item.cost * 100) : 0;
                item.cpm = item.impressions > 0 ? (item.cost / item.impressions * 1000) : 0;
                item.cpc = item.clicks > 0 ? (item.cost / item.clicks) : 0;
                item.cpa = item.conversions > 0 ? (item.cost / item.conversions) : 0;
                item.ctr = item.impressions > 0 ? (item.clicks / item.impressions * 100) : 0;
                item.cvr = item.clicks > 0 ? (item.conversions / item.clicks * 100) : 0;
            });

            const countEl = document.getElementById(countId);
            if (countEl) countEl.textContent = dataList.length;

            if (dataList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--grey-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">데이터가 없습니다</div>
                        <div style="font-size: 13px; color: var(--grey-400);">선택한 조건에 맞는 데이터가 없습니다.</div>
                    </div>
                `;
                return;
            }

            // 정렬
            dataList.sort((a, b) => {
                const aVal = a[state.sortColumn] || 0;
                const bVal = b[state.sortColumn] || 0;
                return state.sortDirection === 'desc' ? bVal - aVal : aVal - bVal;
            });

            // 지표별 최소/최대값 계산
            const metricRanges = {};
            perfTableMetrics.forEach(metric => {
                let min = Infinity, max = -Infinity;
                dataList.forEach(item => {
                    const value = item[metric.key] || 0;
                    if (value < min) min = value;
                    if (value > max) max = value;
                });
                metricRanges[metric.key] = { min, max };
            });

            const isInverseMetric = (key) => ['cpm', 'cpc', 'cpa'].includes(key);

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1200px;">
                    <thead>
                        <tr style="background: var(--grey-100);">
                            <th style="padding: 12px 10px; text-align: left; font-weight: 700; border: 1px solid var(--grey-300); background: var(--grey-200); min-width: 120px; position: sticky; left: 0; z-index: 10;">
                                ${dimensionLabel}
                            </th>
            `;

            perfTableMetrics.forEach(metric => {
                const isSorted = state.sortColumn === metric.key;
                const sortIcon = isSorted ? (state.sortDirection === 'desc' ? ' ▼' : ' ▲') : '';
                tableHTML += `
                    <th class="perf-table-sort-header" data-column="${metric.key}" data-tab="${tabName}" style="padding: 12px 8px; text-align: right; font-weight: 600; border: 1px solid var(--grey-300); background: ${isSorted ? 'var(--primary-light)' : 'var(--grey-100)'}; cursor: pointer; white-space: nowrap; transition: background 0.2s;">
                        ${metric.label}${sortIcon}
                    </th>
                `;
            });

            tableHTML += `</tr></thead><tbody>`;

            dataList.forEach((item, index) => {
                const rowBg = index % 2 === 0 ? 'var(--paper)' : 'var(--grey-50)';
                tableHTML += `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 10px; font-weight: 500; border: 1px solid var(--grey-300); background: var(--grey-50); position: sticky; left: 0; z-index: 5;">
                            ${item.name}
                        </td>
                `;

                perfTableMetrics.forEach(metric => {
                    const value = item[metric.key] || 0;
                    const range = metricRanges[metric.key];
                    const bgColor = getPerfTableColorScale(value, range.min, range.max, isInverseMetric(metric.key));
                    tableHTML += `
                        <td style="padding: 10px 8px; text-align: right; border: 1px solid var(--grey-300); background: ${bgColor}; font-variant-numeric: tabular-nums;">
                            ${metric.format(value)}
                        </td>
                    `;
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        // 각 탭별 렌더링 래퍼 함수
        function renderPerfTableGender() {
            renderPerfTableGeneric('gender', genderDimensionData, '성별', '성별');
        }

        function renderPerfTableAge() {
            renderPerfTableGeneric('age', ageDimensionData, '연령', '연령');
        }

        function renderPerfTablePlatform() {
            renderPerfTableGeneric('platform', platformDimensionData, '플랫폼', '플랫폼');
        }

        function renderPerfTableDevicePlatform() {
            renderPerfTableGeneric('devicePlatform', devicePlatformDimensionData, '기기플랫폼', '기기플랫폼');
        }

        function renderPerfTableDeviceType() {
            renderPerfTableGeneric('deviceType', deviceTypeDimensionData, '기기유형', '기기유형');
        }

        // 성별연령 PIVOT 테이블 렌더링 (성과 테이블 분석 탭)
        function renderPerfTableGenderAge() {
            const container = document.getElementById('perfTableGenderAgeContainer');
            if (!container || !pivotDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션'
            };

            const state = perfTableState.genderAge;

            // 필터 조건을 만족하는 행만 필터링하는 헬퍼 함수
            const rowMatchesFilters = (row) => {
                // 모든 필터가 비어있는지 확인
                const allFiltersEmpty = Object.values(state.filters).every(arr => !arr || arr.length === 0);

                // 모든 필터가 비어있으면 false 반환 (데이터 표시 안 함)
                if (allFiltersEmpty) {
                    return false;
                }

                // 모든 필터를 AND 조건으로 확인
                for (const filterKey of Object.keys(filterMap)) {
                    const column = filterMap[filterKey];
                    const selectedValues = state.filters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            return false;
                        }
                    }
                }
                return true;
            };

            // 성별과 연령대별 데이터 집계
            const pivotData = {};

            pivotDimensionData.forEach(row => {
                if (!rowMatchesFilters(row)) return;

                // 성별_통합, 연령_통합 컬럼 우선 사용
                const rawGender = row['성별_통합'] || row['성별'];
                const normalizedGender = normalizeGender(rawGender);
                const age = row['연령_통합'] || row['연령'];

                if (!normalizedGender || !age || age === '' || age === '-') return;

                // 기간 필터링
                const date = row['일'];
                if (state.startDate || state.endDate) {
                    const rowDate = new Date(date);
                    if (isNaN(rowDate)) return;
                    if (state.startDate && rowDate < new Date(state.startDate)) return;
                    if (state.endDate && rowDate > new Date(state.endDate)) return;
                }

                const key = `${normalizedGender}_${age}`;
                if (!pivotData[key]) {
                    pivotData[key] = {
                        gender: normalizedGender,
                        age: age,
                        cost: 0,
                        revenue: 0,
                        conversions: 0,
                        impressions: 0,
                        clicks: 0
                    };
                }

                const cost = parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                const revenue = parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                const conversions = parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                const impressions = parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                const clicks = parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;

                pivotData[key].cost += cost;
                pivotData[key].revenue += revenue;
                pivotData[key].conversions += conversions;
                pivotData[key].impressions += impressions;
                pivotData[key].clicks += clicks;
            });

            // 지표 계산
            Object.keys(pivotData).forEach(key => {
                const data = pivotData[key];
                data.roas = data.cost > 0 ? (data.revenue / data.cost * 100) : 0;
                data.cpm = data.impressions > 0 ? (data.cost / data.impressions * 1000) : 0;
                data.cpc = data.clicks > 0 ? (data.cost / data.clicks) : 0;
                data.cpa = data.conversions > 0 ? (data.cost / data.conversions) : 0;
            });

            // 고유한 성별과 연령 추출 및 정렬
            let genders = [...new Set(Object.values(pivotData).map(d => d.gender))].sort();
            const ages = [...new Set(Object.values(pivotData).map(d => d.age))].filter(a => isValidAge(a)).sort();

            // Unknown 제외하고 남성, 여성만 사용
            genders = genders.filter(g => g === '남성' || g === '여성');

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(state.filters).every(arr => !arr || arr.length === 0);

            // 데이터가 없으면 안내 메시지 표시
            if (allFiltersEmpty || Object.keys(pivotData).length === 0 || genders.length === 0 || ages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--grey-500);">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">${allFiltersEmpty ? '필터를 선택해주세요' : '데이터를 표시할 수 없습니다'}</div>
                        <div style="font-size: 13px; color: var(--grey-400);">
                            ${allFiltersEmpty ? '위의 분류 기준에서 하나 이상의 항목을 선택해주세요.' : '필터 조건에 맞는 데이터가 없습니다.'}
                        </div>
                    </div>
                `;
                return;
            }

            // 테이블 HTML 생성 - 연령별 행, 지표별 남자/여자 컬럼
            const metrics = [
                { key: 'cost', label: '비용', format: (v) => formatCurrency(v) },
                { key: 'cpm', label: 'CPM', format: (v) => formatCurrency(v) },
                { key: 'cpc', label: 'CPC', format: (v) => formatCurrency(v) },
                { key: 'cpa', label: 'CPA', format: (v) => formatCurrency(v) },
                { key: 'roas', label: 'ROAS', format: (v) => v.toFixed(1) + '%' }
            ];

            // 지표별 최소/최대값 계산 (색상 스케일용)
            const metricRanges = {};
            metrics.forEach(metric => {
                let min = Infinity;
                let max = -Infinity;
                Object.values(pivotData).forEach(data => {
                    const value = data[metric.key];
                    if (value < min) min = value;
                    if (value > max) max = value;
                });
                metricRanges[metric.key] = { min, max };
            });

            // 색상 계산 함수 (지표별)
            function getColorScaleForMetric(value, metricKey) {
                const range = metricRanges[metricKey];
                if (range.max === range.min) return 'rgba(103, 58, 183, 0.1)';

                const ratio = (value - range.min) / (range.max - range.min);
                const r = Math.round(255 - (152 * ratio));
                const g = Math.round(255 - (197 * ratio));
                const b = Math.round(255 - (72 * ratio));
                const alpha = 0.1 + (ratio * 0.3);

                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: var(--grey-100);">
                            <th rowspan="2" style="padding: 10px 8px; text-align: center; font-weight: 700; border: 1px solid var(--grey-300); background: var(--grey-200); width: 70px;">
                                연령
                            </th>
            `;

            // 헤더: 지표별로 남자/여자 컬럼
            metrics.forEach(metric => {
                tableHTML += `
                    <th colspan="2" style="padding: 8px 6px; text-align: center; font-weight: 700; border: 1px solid var(--grey-300); background: var(--primary-light); color: var(--primary-dark); font-size: 11px;">
                        ${metric.label}
                    </th>
                `;
            });

            tableHTML += `
                        </tr>
                        <tr style="background: var(--grey-50);">
            `;

            // 두 번째 헤더 행: 남자/여자 반복
            metrics.forEach(metric => {
                genders.forEach(gender => {
                    tableHTML += `
                        <th style="padding: 6px 4px; text-align: center; font-weight: 600; border: 1px solid var(--grey-300); font-size: 10px;">
                            ${getGenderDisplayName(gender)}
                        </th>
                    `;
                });
            });

            tableHTML += `</tr></thead><tbody>`;

            // 데이터 행: 연령별
            ages.forEach((age, ageIndex) => {
                const rowBg = ageIndex % 2 === 0 ? 'var(--paper)' : 'var(--grey-50)';
                tableHTML += `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 8px 6px; font-weight: 600; text-align: center; border: 1px solid var(--grey-300); background: var(--grey-100); font-size: 11px;">
                            ${age}
                        </td>
                `;

                // 각 지표별로 남자/여자 데이터 출력
                metrics.forEach(metric => {
                    genders.forEach(gender => {
                        const key = `${gender}_${age}`;
                        const data = pivotData[key];

                        if (data) {
                            const value = data[metric.key];
                            const bgColor = getColorScaleForMetric(value, metric.key);
                            const formattedValue = metric.format(value);

                            tableHTML += `
                                <td style="padding: 6px 4px; text-align: right; background: ${bgColor}; border: 1px solid var(--grey-300); cursor: pointer; transition: all 0.2s; font-weight: 500; font-size: 10px; white-space: nowrap;"
                                    onmouseover="this.style.background='var(--primary-light)'; this.style.transform='scale(1.02)';"
                                    onmouseout="this.style.background='${bgColor}'; this.style.transform='scale(1)';"
                                    title="${getGenderDisplayName(gender)} / ${age}&#10;${metric.label}: ${formattedValue}&#10;&#10;비용: ${formatCurrency(data.cost)}&#10;CPM: ${formatCurrency(data.cpm)}&#10;CPC: ${formatCurrency(data.cpc)}&#10;CPA: ${formatCurrency(data.cpa)}&#10;ROAS: ${data.roas.toFixed(1)}%&#10;전환수: ${data.conversions.toFixed(0)}">
                                    ${formattedValue}
                                </td>
                            `;
                        } else {
                            tableHTML += `
                                <td style="padding: 6px 4px; text-align: center; background: var(--grey-50); border: 1px solid var(--grey-300); color: var(--grey-400); font-size: 10px;">
                                    -
                                </td>
                            `;
                        }
                    });
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;

            // 통계 요약 추가
            const totalCost = Object.values(pivotData).reduce((sum, d) => sum + d.cost, 0);
            const totalRevenue = Object.values(pivotData).reduce((sum, d) => sum + d.revenue, 0);
            const totalConversions = Object.values(pivotData).reduce((sum, d) => sum + d.conversions, 0);
            const totalImpressions = Object.values(pivotData).reduce((sum, d) => sum + d.impressions, 0);
            const totalClicks = Object.values(pivotData).reduce((sum, d) => sum + d.clicks, 0);

            const avgRoas = totalCost > 0 ? (totalRevenue / totalCost * 100) : 0;
            const avgCpm = totalImpressions > 0 ? (totalCost / totalImpressions * 1000) : 0;
            const avgCpc = totalClicks > 0 ? (totalCost / totalClicks) : 0;
            const avgCpa = totalConversions > 0 ? (totalCost / totalConversions) : 0;

            const statsHTML = `
                <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%); border-radius: 8px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">전체 비용</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--grey-900);">${formatCurrency(totalCost)}</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">평균 CPM</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--grey-900);">${formatCurrency(avgCpm)}</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">평균 CPC</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--grey-900);">${formatCurrency(avgCpc)}</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">평균 CPA</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--grey-900);">${formatCurrency(avgCpa)}</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">전체 ROAS</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--primary-main);">${avgRoas.toFixed(1)}%</div>
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML + statsHTML;
        }

        // 성과 테이블 탭 전환
        function setupPerfTableTabs() {
            document.querySelectorAll('.perf-table-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.perf-table-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.perf-table-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    const targetTab = this.dataset.tab;
                    const tabMap = {
                        'adset': 'perfTableAdsetTab',
                        'gender': 'perfTableGenderTab',
                        'age': 'perfTableAgeTab',
                        'platform': 'perfTablePlatformTab',
                        'devicePlatform': 'perfTableDevicePlatformTab',
                        'deviceType': 'perfTableDeviceTypeTab',
                        'genderAge': 'perfTableGenderAgeTab'
                    };

                    const targetElement = document.getElementById(tabMap[targetTab]);
                    if (targetElement) {
                        targetElement.style.display = 'block';
                        targetElement.classList.add('active');

                        // 탭 전환 시 렌더링
                        if (targetTab === 'gender') renderPerfTableGender();
                        else if (targetTab === 'age') renderPerfTableAge();
                        else if (targetTab === 'platform') renderPerfTablePlatform();
                        else if (targetTab === 'devicePlatform') renderPerfTableDevicePlatform();
                        else if (targetTab === 'deviceType') renderPerfTableDeviceType();
                        else if (targetTab === 'genderAge') renderPerfTableGenderAge();
                    }
                });
            });
        }

        // 모든 탭 필터 드롭다운 이벤트
        function setupPerfTableFilterEvents() {
            // 드롭다운 버튼 클릭
            document.querySelectorAll('.perf-table-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filterKey = this.dataset.filter;
                    const tabName = this.dataset.tab;
                    const dropdown = document.querySelector(`.perf-table-filter-dropdown-list[data-filter="${filterKey}"][data-tab="${tabName}"]`);

                    // 모든 드롭다운 닫기
                    document.querySelectorAll('.perf-table-filter-dropdown-list').forEach(d => {
                        if (d !== dropdown) d.style.display = 'none';
                    });

                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                });
            });

            // 전체 선택 체크박스
            document.querySelectorAll('.perf-table-filter-select-all').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filterKey = this.dataset.filter;
                    const tabName = this.dataset.tab;
                    const isChecked = this.checked;

                    document.querySelectorAll(`.perf-table-filter-checkbox[data-filter="${filterKey}"][data-tab="${tabName}"]`).forEach(cb => {
                        cb.checked = isChecked;
                    });

                    updatePerfTableFilters(tabName, filterKey);
                });
            });

            // 개별 체크박스
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('perf-table-filter-checkbox')) {
                    updatePerfTableFilters(e.target.dataset.tab, e.target.dataset.filter);
                }
            });

            // 문서 클릭 시 드롭다운 닫기
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.perf-table-filter-dropdown-btn') && !e.target.closest('.perf-table-filter-dropdown-list')) {
                    document.querySelectorAll('.perf-table-filter-dropdown-list').forEach(d => {
                        d.style.display = 'none';
                    });
                }
            });
        }

        // 필터 상태 업데이트 (범용)
        function updatePerfTableFilters(tabName, filterKey) {
            const selectedValues = [];
            document.querySelectorAll(`.perf-table-filter-checkbox[data-filter="${filterKey}"][data-tab="${tabName}"]:checked`).forEach(cb => {
                selectedValues.push(cb.value);
            });

            perfTableState[tabName].filters[filterKey] = selectedValues;

            // 버튼 텍스트 업데이트
            const btn = document.querySelector(`.perf-table-filter-dropdown-btn[data-filter="${filterKey}"][data-tab="${tabName}"]`);
            if (btn) {
                const countSpan = btn.querySelector('.perf-table-selected-count');
                if (countSpan) {
                    countSpan.textContent = selectedValues.length > 0 ? `${selectedValues.length}개` : '0개';
                }
            }

            // 해당 탭 렌더링
            if (tabName === 'adset') renderPerfTableAdset();
            else if (tabName === 'gender') renderPerfTableGender();
            else if (tabName === 'age') renderPerfTableAge();
            else if (tabName === 'platform') renderPerfTablePlatform();
            else if (tabName === 'devicePlatform') renderPerfTableDevicePlatform();
            else if (tabName === 'deviceType') renderPerfTableDeviceType();
            else if (tabName === 'genderAge') renderPerfTableGenderAge();
        }

        // 날짜 이벤트 설정
        function setupPerfTableDateEvents() {
            document.querySelectorAll('.perf-table-date').forEach(input => {
                input.addEventListener('change', function() {
                    const tabName = this.dataset.tab;
                    const isStart = this.id.includes('Start');

                    if (isStart) {
                        perfTableState[tabName].startDate = this.value;
                    } else {
                        perfTableState[tabName].endDate = this.value;
                    }

                    // 렌더링
                    if (tabName === 'adset') renderPerfTableAdset();
                    else if (tabName === 'gender') renderPerfTableGender();
                    else if (tabName === 'age') renderPerfTableAge();
                    else if (tabName === 'platform') renderPerfTablePlatform();
                    else if (tabName === 'devicePlatform') renderPerfTableDevicePlatform();
                    else if (tabName === 'deviceType') renderPerfTableDeviceType();
                    else if (tabName === 'genderAge') renderPerfTableGenderAge();
                });
            });
        }

        // 정렬 헤더 이벤트 설정
        function setupPerfTableSortEvents() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('perf-table-sort-header')) {
                    const column = e.target.dataset.column;
                    const tabName = e.target.dataset.tab;
                    const state = perfTableState[tabName];

                    if (state.sortColumn === column) {
                        state.sortDirection = state.sortDirection === 'desc' ? 'asc' : 'desc';
                    } else {
                        state.sortColumn = column;
                        state.sortDirection = 'desc';
                    }

                    // 렌더링
                    if (tabName === 'adset') renderPerfTableAdset();
                    else if (tabName === 'gender') renderPerfTableGender();
                    else if (tabName === 'age') renderPerfTableAge();
                    else if (tabName === 'platform') renderPerfTablePlatform();
                    else if (tabName === 'devicePlatform') renderPerfTableDevicePlatform();
                    else if (tabName === 'deviceType') renderPerfTableDeviceType();
                    else if (tabName === 'genderAge') renderPerfTableGenderAge();
                }
            });
        }

        // 날짜 초기화
        function initPerfTableDates() {
            if (!adsetDimensionData || adsetDimensionData.length === 0) return;

            const dates = adsetDimensionData.map(row => row['일']).filter(d => d).sort();
            if (dates.length === 0) return;

            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];

            // 모든 탭의 날짜 입력 초기화
            ['Adset', 'Gender', 'Age', 'Platform', 'DevicePlatform', 'DeviceType', 'GenderAge'].forEach(tab => {
                const startInput = document.getElementById(`perfTable${tab}StartDate`);
                const endInput = document.getElementById(`perfTable${tab}EndDate`);
                if (startInput) startInput.value = minDate;
                if (endInput) endInput.value = maxDate;

                const tabKey = tab.charAt(0).toLowerCase() + tab.slice(1);
                if (perfTableState[tabKey]) {
                    perfTableState[tabKey].startDate = minDate;
                    perfTableState[tabKey].endDate = maxDate;
                }
            });
        }

        // 성과 테이블 분석 초기화
        function initPerfTableAnalysis() {
            initPerfTableDates();
            initPerfTableFilters();  // 모든 탭 필터 초기화
            setupPerfTableTabs();
            setupPerfTableFilterEvents();  // 모든 탭 필터 이벤트 설정
            setupPerfTableDateEvents();
            setupPerfTableSortEvents();

            // 초기 상태: 필터 선택 전이므로 렌더링은 필터 선택 시 수행됨
        }

        // ========== 리타겟팅 및 계절성 분석 ==========

        // 리타겟팅 테이블 정렬 상태
        const retargetingSortState = {
            ageGender: { column: 'roas', direction: 'desc' },
            device: { column: 'roas', direction: 'desc' },
            platform: { column: 'roas', direction: 'desc' },
            devicePlatform: { column: 'roas', direction: 'desc' },
            seasonality: { column: 'roas', direction: 'desc' }
        };

        // 리타겟팅 분석 초기화
        function initRetargetingAnalysis() {
            renderAgeGenderRetargetTable();
            renderDeviceRetargetTable();
            renderPlatformRetargetTable();
            renderDevicePlatformRetargetTable();
            setupRetargetingTabEvents();
            setupRetargetingSortEvents();
        }

        // 리타겟팅 테이블 정렬 이벤트 설정
        function setupRetargetingSortEvents() {
            document.querySelectorAll('.sortable-header[data-table]').forEach(th => {
                th.addEventListener('click', function() {
                    const tableType = this.getAttribute('data-table');
                    const column = this.getAttribute('data-column');

                    // 같은 열 클릭시 방향 토글, 다른 열이면 desc로 시작
                    if (retargetingSortState[tableType].column === column) {
                        retargetingSortState[tableType].direction =
                            retargetingSortState[tableType].direction === 'desc' ? 'asc' : 'desc';
                    } else {
                        retargetingSortState[tableType].column = column;
                        retargetingSortState[tableType].direction = 'desc';
                    }

                    // 해당 테이블 다시 렌더링
                    switch(tableType) {
                        case 'ageGender': renderAgeGenderRetargetTable(); break;
                        case 'device': renderDeviceRetargetTable(); break;
                        case 'platform': renderPlatformRetargetTable(); break;
                        case 'devicePlatform': renderDevicePlatformRetargetTable(); break;
                        case 'seasonality': renderSeasonalityTable(); break;
                    }

                    // 정렬 아이콘 업데이트
                    updateRetargetingSortIcons(tableType);
                });
            });
        }

        // 정렬 아이콘 업데이트
        function updateRetargetingSortIcons(tableType) {
            const headers = document.querySelectorAll(`.sortable-header[data-table="${tableType}"]`);
            headers.forEach(th => {
                const column = th.getAttribute('data-column');
                const sortIcon = th.querySelector('.sort-icon');
                const upArrow = th.querySelector('.sort-arrow.up');
                const downArrow = th.querySelector('.sort-arrow.down');

                if (column === retargetingSortState[tableType].column) {
                    sortIcon.classList.add('active');
                    if (retargetingSortState[tableType].direction === 'asc') {
                        upArrow.classList.add('active');
                        downArrow.classList.remove('active');
                    } else {
                        upArrow.classList.remove('active');
                        downArrow.classList.add('active');
                    }
                } else {
                    sortIcon.classList.remove('active');
                    upArrow.classList.remove('active');
                    downArrow.classList.remove('active');
                }
            });
        }

        // 리타겟팅 탭 전환 이벤트
        function setupRetargetingTabEvents() {
            document.querySelectorAll('.retargeting-subtab').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 버튼 스타일 변경
                    document.querySelectorAll('.retargeting-subtab').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#495057';
                        b.style.border = '1px solid #dee2e6';
                    });
                    this.style.background = '#673ab7';
                    this.style.color = 'white';
                    this.style.border = 'none';

                    // 콘텐츠 전환
                    const targetTab = this.dataset.retargetTab;
                    document.querySelectorAll('.retargeting-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    const viewMap = {
                        'ageGender': 'ageGenderRetargetView',
                        'device': 'deviceRetargetView',
                        'platform': 'platformRetargetView',
                        'devicePlatform': 'devicePlatformRetargetView'
                    };

                    const targetView = document.getElementById(viewMap[targetTab]);
                    if (targetView) {
                        targetView.style.display = 'block';
                        targetView.classList.add('active');
                    }
                });
            });
        }

        // 성별/연령 리타겟팅 테이블 렌더링
        function renderAgeGenderRetargetTable() {
            const periodData = getPeriodData();
            const retargeting = periodData.retargeting_analysis || {};
            const data = retargeting.by_age_gender || [];
            const insights = periodData.retargeting_insights || [];
            const tbody = document.getElementById('ageGenderRetargetTableBody');

            if (!tbody || data.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            // 정렬 상태에 따른 정렬
            const filteredData = data.filter(item => item.roas > 0);
            const { column, direction } = retargetingSortState.ageGender;
            const sortedData = [...filteredData].sort((a, b) => {
                const aVal = a[column] || 0;
                const bVal = b[column] || 0;
                return direction === 'desc' ? bVal - aVal : aVal - bVal;
            });
            const maxRoas = Math.max(...filteredData.map(d => d.roas), 100);

            let html = '';
            sortedData.forEach((item, index) => {
                const genderIcon = item.gender === '남성' ? '👨' : '👩';
                const roasColor = item.roas >= 50 ? '#2e7d32' : item.roas >= 20 ? '#1565c0' : '#d32f2f';
                const efficiencyGrade = getEfficiencyGrade(item.roas, maxRoas);

                html += `
                    <tr>
                        <td style="font-weight: 500;">${genderIcon} ${item.label || (item.age + ' ' + item.gender)}</td>
                        <td style="text-align: right; font-weight: 700; color: ${roasColor};">${formatPercent(item.roas)}</td>
                        <td style="text-align: right;">${item.cpa > 0 ? formatCurrency(item.cpa) : '-'}</td>
                        <td style="text-align: right;">${formatCurrency(item.cost)}</td>
                        <td style="text-align: right;">${formatNumber(item.conversions)}</td>
                        <td style="text-align: right;">${formatCurrency(item.revenue)}</td>
                        <td style="text-align: center;">${efficiencyGrade}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // 인사이트 업데이트
            const ageGenderInsight = insights.find(i => i.type === 'retargeting_best_age_gender');
            const insightText = document.getElementById('ageGenderRetargetInsightText');
            if (insightText && ageGenderInsight) {
                insightText.innerHTML = ageGenderInsight.message;
            } else if (insightText && sortedData.length > 0) {
                insightText.innerHTML = `<strong>${sortedData[0].label}</strong> 타겟이 ROAS <strong>${formatPercent(sortedData[0].roas)}</strong>로 가장 높은 효율을 보이고 있습니다.`;
            }
        }

        // 기기별 리타겟팅 테이블 렌더링
        function renderDeviceRetargetTable() {
            const periodData = getPeriodData();
            const retargeting = periodData.retargeting_analysis || {};
            const data = retargeting.by_device || [];
            const insights = periodData.retargeting_insights || [];
            const tbody = document.getElementById('deviceRetargetTableBody');

            if (!tbody || data.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            // 정렬 상태에 따른 정렬
            const filteredData = data.filter(item => item.roas > 0);
            const { column, direction } = retargetingSortState.device;
            const sortedData = [...filteredData].sort((a, b) => {
                const aVal = a[column] || 0;
                const bVal = b[column] || 0;
                return direction === 'desc' ? bVal - aVal : aVal - bVal;
            });
            const maxRoas = Math.max(...filteredData.map(d => d.roas), 100);

            let html = '';
            sortedData.forEach((item, index) => {
                const deviceIcon = getDeviceIcon(item.device);
                const roasColor = item.roas >= 200 ? '#2e7d32' : item.roas >= 100 ? '#1565c0' : '#d32f2f';
                const efficiencyGrade = getEfficiencyGrade(item.roas, maxRoas);

                html += `
                    <tr>
                        <td style="font-weight: 500;">${deviceIcon} ${item.device}</td>
                        <td style="text-align: right; font-weight: 700; color: ${roasColor};">${formatPercent(item.roas)}</td>
                        <td style="text-align: right;">${item.cpa > 0 ? formatCurrency(item.cpa) : '-'}</td>
                        <td style="text-align: right;">${formatCurrency(item.cost)}</td>
                        <td style="text-align: right;">${formatNumber(item.conversions)}</td>
                        <td style="text-align: right;">${formatCurrency(item.revenue)}</td>
                        <td style="text-align: center;">${efficiencyGrade}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // 인사이트 업데이트
            const deviceInsight = insights.find(i => i.type === 'retargeting_best_device');
            const insightText = document.getElementById('deviceRetargetInsightText');
            if (insightText && deviceInsight) {
                insightText.innerHTML = deviceInsight.message;
            } else if (insightText && sortedData.length > 0) {
                insightText.innerHTML = `<strong>${sortedData[0].device}</strong> 기기가 ROAS <strong>${formatPercent(sortedData[0].roas)}</strong>로 가장 높은 효율을 보이고 있습니다.`;
            }
        }

        // 플랫폼별 리타겟팅 테이블 렌더링
        function renderPlatformRetargetTable() {
            const periodData = getPeriodData();
            const retargeting = periodData.retargeting_analysis || {};
            const data = retargeting.by_platform || [];
            const insights = periodData.retargeting_insights || [];
            const tbody = document.getElementById('platformRetargetTableBody');

            if (!tbody || data.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            // 정렬 상태에 따른 정렬
            const { column, direction } = retargetingSortState.platform;
            const sortedData = [...data].sort((a, b) => {
                const aVal = a[column] || 0;
                const bVal = b[column] || 0;
                return direction === 'desc' ? bVal - aVal : aVal - bVal;
            });
            const maxRoas = Math.max(...data.filter(d => d.roas > 0).map(d => d.roas), 100);

            let html = '';
            sortedData.forEach(item => {
                const platformIcon = getPlatformIcon(item.platform);
                const roasColor = item.roas >= 150 ? '#2e7d32' : item.roas >= 50 ? '#1565c0' : item.roas > 0 ? '#e65100' : '#9e9e9e';
                const efficiencyGrade = item.roas > 0 ? getEfficiencyGrade(item.roas, maxRoas) : '<span style="background: #f5f5f5; color: #9e9e9e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">-</span>';

                html += `
                    <tr>
                        <td style="font-weight: 500;">${platformIcon} ${item.platform}</td>
                        <td style="text-align: right; font-weight: 700; color: ${roasColor};">${item.roas > 0 ? formatPercent(item.roas) : '-'}</td>
                        <td style="text-align: right;">${item.cpa > 0 ? formatCurrency(item.cpa) : '-'}</td>
                        <td style="text-align: right;">${formatCurrency(item.cost)}</td>
                        <td style="text-align: right;">${formatNumber(item.conversions)}</td>
                        <td style="text-align: right;">${formatCurrency(item.revenue)}</td>
                        <td style="text-align: center;">${efficiencyGrade}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // 인사이트 업데이트
            const platformInsight = insights.find(i => i.type === 'retargeting_best_platform');
            const insightText = document.getElementById('platformRetargetInsightText');
            if (insightText && platformInsight) {
                insightText.innerHTML = platformInsight.message;
            } else if (insightText && sortedData.length > 0 && sortedData[0].roas > 0) {
                insightText.innerHTML = `<strong>${sortedData[0].platform}</strong> 플랫폼이 ROAS <strong>${formatPercent(sortedData[0].roas)}</strong>로 가장 높은 효율을 기록 중입니다.`;
            }
        }

        // 노출기기별 리타겟팅 테이블 렌더링
        function renderDevicePlatformRetargetTable() {
            const periodData = getPeriodData();
            const retargeting = periodData.retargeting_analysis || {};
            const data = retargeting.by_device_platform || [];
            const insights = periodData.retargeting_insights || [];
            const tbody = document.getElementById('devicePlatformRetargetTableBody');

            if (!tbody || data.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            // 정렬 상태에 따른 정렬
            const { column, direction } = retargetingSortState.devicePlatform;
            const sortedData = [...data].sort((a, b) => {
                const aVal = a[column] || 0;
                const bVal = b[column] || 0;
                return direction === 'desc' ? bVal - aVal : aVal - bVal;
            });
            const maxRoas = Math.max(...data.filter(d => d.roas > 0).map(d => d.roas), 100);

            let html = '';
            sortedData.forEach(item => {
                const devicePlatformIcon = getDevicePlatformIcon(item.device_platform);
                const roasColor = item.roas >= 30 ? '#2e7d32' : item.roas >= 10 ? '#1565c0' : item.roas > 0 ? '#e65100' : '#9e9e9e';
                const efficiencyGrade = item.roas > 0 ? getEfficiencyGrade(item.roas, maxRoas) : '<span style="background: #f5f5f5; color: #9e9e9e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">-</span>';

                html += `
                    <tr>
                        <td style="font-weight: 500;">${devicePlatformIcon} ${item.device_platform}</td>
                        <td style="text-align: right; font-weight: 700; color: ${roasColor};">${item.roas > 0 ? formatPercent(item.roas) : '-'}</td>
                        <td style="text-align: right;">${item.cpa > 0 ? formatCurrency(item.cpa) : '-'}</td>
                        <td style="text-align: right;">${formatCurrency(item.cost)}</td>
                        <td style="text-align: right;">${formatNumber(item.conversions)}</td>
                        <td style="text-align: right;">${formatCurrency(item.revenue)}</td>
                        <td style="text-align: center;">${efficiencyGrade}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // 인사이트 업데이트
            const devicePlatformInsight = insights.find(i => i.type === 'retargeting_best_device_platform');
            const insightText = document.getElementById('devicePlatformRetargetInsightText');
            if (insightText && devicePlatformInsight) {
                insightText.innerHTML = devicePlatformInsight.message;
            } else if (insightText && sortedData.length > 0 && sortedData[0].roas > 0) {
                insightText.innerHTML = `<strong>${sortedData[0].device_platform}</strong> 노출기기가 ROAS <strong>${formatPercent(sortedData[0].roas)}</strong>로 가장 높은 효율을 기록 중입니다.`;
            }
        }

        // 노출기기 아이콘 반환
        function getDevicePlatformIcon(devicePlatform) {
            const icons = {
                'Mobile app': '📱',
                'Mobile web': '📲',
                'Desktop': '🖥️',
                'Uncategorized': '❓'
            };
            return icons[devicePlatform] || '📊';
        }

        // ========== 분기별 추이 차트 및 테이블 ==========
        let quarterlyTrendChartInstance = null;

        // 분기별 추이 차트 렌더링
        function renderQuarterlyTrendChart() {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const quarterlyData = seasonality.quarterly_overall || [];
            const insights = getSeasonalityData().seasonality_insights || [];

            if (quarterlyData.length === 0) return;

            // 분기 순서 정렬
            const quarterOrder = ['Q1(1~3월)', 'Q2(4~6월)', 'Q3(7~9월)', 'Q4(10~12월)'];
            const sortedData = [...quarterlyData].sort((a, b) =>
                quarterOrder.indexOf(a.quarter) - quarterOrder.indexOf(b.quarter)
            );

            const labels = sortedData.map(d => d.quarter);
            const costData = sortedData.map(d => Math.round(d.avg_cost / 10000)); // 만원 단위
            const roasData = sortedData.map(d => d.avg_roas);
            const cpaData = sortedData.map(d => Math.round(d.avg_cpa / 1000)); // 천원 단위

            const ctx = document.getElementById('quarterlyTrendChart');
            if (!ctx) return;

            // 기존 차트 제거
            if (quarterlyTrendChartInstance) {
                quarterlyTrendChartInstance.destroy();
            }

            quarterlyTrendChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '비용 (만원)',
                            data: costData,
                            backgroundColor: 'rgba(66, 133, 244, 0.7)',
                            borderColor: 'rgba(66, 133, 244, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'ROAS (%)',
                            data: roasData,
                            type: 'line',
                            borderColor: '#34a853',
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#34a853',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1',
                            order: 1
                        },
                        {
                            label: 'CPA (천원)',
                            data: cpaData,
                            type: 'line',
                            borderColor: '#ea4335',
                            backgroundColor: 'rgba(234, 67, 53, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#ea4335',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y2',
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12, weight: '500' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#e0e0e0',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (label.includes('비용')) return label + ': ' + value.toLocaleString() + '만원';
                                    if (label.includes('ROAS')) return label + ': ' + value.toFixed(1) + '%';
                                    if (label.includes('CPA')) return label + ': ' + value.toLocaleString() + '천원';
                                    return label + ': ' + value;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 12, weight: '600' } }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '비용 (만원)',
                                color: '#4285f4',
                                font: { size: 11, weight: '600' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: {
                                color: '#4285f4',
                                callback: function(value) { return value.toLocaleString(); }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ROAS (%)',
                                color: '#34a853',
                                font: { size: 11, weight: '600' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: {
                                color: '#34a853',
                                callback: function(value) { return value.toFixed(0) + '%'; }
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // KPI 카드 렌더링
            renderQuarterlyKpiCards(sortedData);

            // 계절성 인사이트 렌더링
            renderQuarterlySeasonalityInsight(sortedData, insights);
        }

        // 분기별 KPI 카드 렌더링
        function renderQuarterlyKpiCards(quarterlyData) {
            const container = document.getElementById('quarterlyKpiCards');
            if (!container || quarterlyData.length === 0) return;

            // 분기별 색상
            const quarterColors = {
                'Q1(1~3월)': { bg: '#e3f2fd', text: '#1565c0', icon: '🌸' },
                'Q2(4~6월)': { bg: '#e8f5e9', text: '#2e7d32', icon: '☀️' },
                'Q3(7~9월)': { bg: '#fff3e0', text: '#ef6c00', icon: '🍂' },
                'Q4(10~12월)': { bg: '#fce4ec', text: '#c2185b', icon: '❄️' }
            };

            let html = '';
            quarterlyData.forEach(q => {
                const color = quarterColors[q.quarter] || { bg: '#f5f5f5', text: '#757575', icon: '📊' };
                html += `
                    <div style="background: ${color.bg}; border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="font-size: 20px; margin-bottom: 8px;">${color.icon}</div>
                        <div style="font-size: 13px; font-weight: 600; color: ${color.text}; margin-bottom: 4px;">${q.quarter}</div>
                        <div style="font-size: 18px; font-weight: 700; color: ${color.text};">${q.avg_roas.toFixed(1)}%</div>
                        <div style="font-size: 11px; color: #757575; margin-top: 4px;">ROAS</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 분기별 계절성 인사이트 렌더링
        function renderQuarterlySeasonalityInsight(quarterlyData, insights) {
            const insightText = document.getElementById('quarterlySeasonalityInsightText');
            if (!insightText) return;

            // 분기별 데이터에서 최고/최저 분기 찾기
            const bestQuarter = [...quarterlyData].sort((a, b) => b.avg_roas - a.avg_roas)[0];
            const worstQuarter = [...quarterlyData].sort((a, b) => a.avg_roas - b.avg_roas)[0];
            const lowestCpaQuarter = [...quarterlyData].sort((a, b) => a.avg_cpa - b.avg_cpa)[0];

            // 요일별 인사이트
            const bestDayInsight = insights.find(i => i.type === 'best_day_overall');
            const worstDayInsight = insights.find(i => i.type === 'worst_day_overall');
            const weekdayInsight = insights.find(i => i.type === 'weekday_better' || i.type === 'weekend_better');

            let insightHtml = '<div style="display: flex; flex-direction: column; gap: 12px;">';

            // 분기별 인사이트
            insightHtml += `
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <span style="color: #1565c0; font-size: 16px;">📈</span>
                    <div>
                        <strong style="color: #1565c0;">분기별 성과:</strong>
                        <strong>${bestQuarter.quarter}</strong>이 ROAS <strong>${bestQuarter.avg_roas.toFixed(1)}%</strong>로 가장 효율이 높고,
                        ${worstQuarter.quarter}이 ${worstQuarter.avg_roas.toFixed(1)}%로 가장 낮습니다.
                        ${lowestCpaQuarter.quarter !== bestQuarter.quarter ?
                            ` CPA는 ${lowestCpaQuarter.quarter}이 ${Math.round(lowestCpaQuarter.avg_cpa).toLocaleString()}원으로 가장 낮습니다.` : ''}
                    </div>
                </div>
            `;

            // 요일별 인사이트
            if (bestDayInsight) {
                insightHtml += `
                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                        <span style="color: #2e7d32; font-size: 16px;">📅</span>
                        <div>
                            <strong style="color: #2e7d32;">요일별 성과:</strong>
                            <strong>${bestDayInsight.day}</strong>이 ROAS ${bestDayInsight.avg_roas.toFixed(1)}%로 최고,
                            ${worstDayInsight ? worstDayInsight.day + '이 ' + worstDayInsight.avg_roas.toFixed(1) + '%로 최저입니다.' : ''}
                        </div>
                    </div>
                `;
            }

            // 주중/주말 인사이트
            if (weekdayInsight) {
                const isWeekdayBetter = weekdayInsight.type === 'weekday_better';
                insightHtml += `
                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                        <span style="color: #f57c00; font-size: 16px;">💡</span>
                        <div>
                            <strong style="color: #f57c00;">운영 제안:</strong>
                            ${isWeekdayBetter ?
                                '주중이 주말보다 ROAS가 ' + weekdayInsight.diff_percent.toFixed(1) + '% 높습니다. <strong>주중 집중 운영</strong>을 권장합니다.' :
                                '주말이 주중보다 ROAS가 높습니다. <strong>주말 예산 증액</strong>을 고려해보세요.'}
                        </div>
                    </div>
                `;
            }

            insightHtml += '</div>';
            insightText.innerHTML = insightHtml;
        }

        // 분기별 테이블 렌더링
        function renderQuarterlyTable() {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const quarterlyData = seasonality.quarterly_overall || [];
            const tbody = document.getElementById('quarterlyTableBody');

            if (!tbody || quarterlyData.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            // 분기 순서 정렬
            const quarterOrder = ['Q1(1~3월)', 'Q2(4~6월)', 'Q3(7~9월)', 'Q4(10~12월)'];
            const sortedData = [...quarterlyData].sort((a, b) =>
                quarterOrder.indexOf(a.quarter) - quarterOrder.indexOf(b.quarter)
            );

            // ROAS 기준 최대/최소 계산
            const maxRoas = Math.max(...sortedData.map(d => d.avg_roas));
            const minRoas = Math.min(...sortedData.map(d => d.avg_roas));

            // 분기별 이모지
            const quarterEmoji = {
                'Q1(1~3월)': '🌸',
                'Q2(4~6월)': '☀️',
                'Q3(7~9월)': '🍂',
                'Q4(10~12월)': '❄️'
            };

            let html = '';
            sortedData.forEach(item => {
                const emoji = quarterEmoji[item.quarter] || '📊';

                // 효율 등급 계산
                let efficiencyGrade = '';
                let gradeColor = '';
                if (item.avg_roas >= maxRoas * 0.95) {
                    efficiencyGrade = '최고';
                    gradeColor = '#2e7d32';
                } else if (item.avg_roas <= minRoas * 1.05) {
                    efficiencyGrade = '최저';
                    gradeColor = '#d32f2f';
                } else {
                    efficiencyGrade = '보통';
                    gradeColor = '#757575';
                }

                // 성과 바
                const barWidth = maxRoas > minRoas ? ((item.avg_roas - minRoas) / (maxRoas - minRoas) * 100).toFixed(0) : 50;
                const performanceBar = '<div style="display: flex; align-items: center; gap: 8px;">' +
                    '<div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 8px; overflow: hidden;">' +
                    '<div style="width: ' + barWidth + '%; background: ' + gradeColor + '; height: 100%; border-radius: 4px;"></div>' +
                    '</div>' +
                    '<span style="font-size: 11px; color: ' + gradeColor + '; font-weight: 600;">' + efficiencyGrade + '</span>' +
                    '</div>';

                html += '<tr>';
                html += '<td style="text-align: center; font-weight: 600;">' + emoji + ' ' + item.quarter + '</td>';
                html += '<td style="text-align: right;">' + formatCurrency(item.avg_cost) + '</td>';
                html += '<td style="text-align: right; font-weight: 600; color: #1565c0;">' + item.avg_roas.toFixed(1) + '%</td>';
                html += '<td style="text-align: right;">' + formatCurrency(item.avg_cpa) + '</td>';
                html += '<td style="text-align: right;">' + item.avg_conversions.toFixed(1) + '</td>';
                html += '<td style="text-align: right; font-weight: 500;">' + formatCurrency(item.avg_revenue) + '</td>';
                html += '<td>' + performanceBar + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        // 요일별 전환 테이블 렌더링
        function renderSeasonalityTable() {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const data = seasonality.overall || [];
            const insights = getSeasonalityData().seasonality_insights || [];
            const tbody = document.getElementById('seasonalityTableBody');

            if (!tbody || data.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            // 데이터 정규화 (필드명 매핑)
            const normalizedData = data.map(item => ({
                day: item.day,
                roas: item.avg_roas || 0,
                cpa: item.avg_cpa || 0,
                cost: item.avg_cost || 0,
                conversions: item.avg_conversions || 0,
                revenue: item.avg_revenue || 0
            }));

            // 정렬 상태에 따른 정렬
            const { column, direction } = retargetingSortState.seasonality;
            const sortedData = [...normalizedData].sort((a, b) => {
                const aVal = a[column] || 0;
                const bVal = b[column] || 0;
                return direction === 'desc' ? bVal - aVal : aVal - bVal;
            });

            // ROAS 기준 최대/최소 계산 (성과 수준 바 표시용)
            const maxRoas = Math.max(...normalizedData.map(d => d.roas));
            const minRoas = Math.min(...normalizedData.map(d => d.roas));

            let html = '';
            sortedData.forEach(item => {
                const dayEmoji = getDayEmoji(item.day);

                // 효율 등급 계산 (ROAS 기준)
                let efficiencyGrade = '';
                let gradeColor = '';
                if (item.roas >= maxRoas * 0.95) {
                    efficiencyGrade = '최고';
                    gradeColor = '#2e7d32';
                } else if (item.roas <= minRoas * 1.05) {
                    efficiencyGrade = '최저';
                    gradeColor = '#d32f2f';
                } else if (item.roas >= maxRoas * 0.8) {
                    efficiencyGrade = '우수';
                    gradeColor = '#1565c0';
                } else {
                    efficiencyGrade = '보통';
                    gradeColor = '#757575';
                }

                // 성과 바 (ROAS 기준)
                const barWidth = maxRoas > minRoas ? ((item.roas - minRoas) / (maxRoas - minRoas) * 100).toFixed(0) : 50;
                const performanceBar = '<div style="display: flex; align-items: center; gap: 8px;">' +
                    '<div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 8px; overflow: hidden;">' +
                    '<div style="width: ' + barWidth + '%; background: ' + gradeColor + '; height: 100%; border-radius: 4px;"></div>' +
                    '</div>' +
                    '<span style="font-size: 11px; color: ' + gradeColor + '; font-weight: 600;">' + efficiencyGrade + '</span>' +
                    '</div>';

                html += '<tr>';
                html += '<td style="text-align: center; font-weight: 600;">' + dayEmoji + ' ' + item.day + '</td>';
                html += '<td style="text-align: right; font-weight: 600; color: #1565c0;">' + item.roas.toFixed(1) + '%</td>';
                html += '<td style="text-align: right;">' + formatCurrency(item.cpa) + '</td>';
                html += '<td style="text-align: right;">' + formatCurrency(item.cost) + '</td>';
                html += '<td style="text-align: right;">' + item.conversions.toFixed(1) + '</td>';
                html += '<td style="text-align: right; font-weight: 500;">' + formatCurrency(item.revenue) + '</td>';
                html += '<td>' + performanceBar + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;

            // 정렬 아이콘 업데이트
            updateRetargetingSortIcons('seasonality');

            // 인사이트 업데이트
            const insightText = document.getElementById('seasonalityInsightText');
            if (insightText) {
                const bestDay = insights.find(i => i.type === 'best_day_overall');
                const worstDay = insights.find(i => i.type === 'worst_day_overall');
                const weekendInsight = insights.find(i => i.type === 'weekend_better' || i.type === 'weekday_better');

                let insightHtml = '';
                if (bestDay) insightHtml += bestDay.message + ' ';
                if (worstDay) insightHtml += worstDay.message + ' ';
                if (weekendInsight) insightHtml += '<br>' + weekendInsight.message;

                insightText.innerHTML = insightHtml || '요일별 전환 데이터를 분석 중입니다.';
            }
        }

        // ========================================
        // 채널별 요일 분석 - 강화된 버전
        // ========================================

        // 채널별 KPI 카드 렌더링
        function renderChannelDayKpiCards() {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const byCategory = seasonality.by_category || {};
            const container = document.getElementById('channelDayKpiCards');

            if (!container) return;

            const categories = Object.keys(byCategory);
            if (categories.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--grey-500); padding: 20px;">채널 데이터가 없습니다</div>';
                return;
            }

            // 채널별 색상 정의
            const channelColors = {
                '메타_전환': { bg: '#e3f2fd', border: '#1976d2', icon: '📘', gradient: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)' },
                '네이버_쇼핑검색': { bg: '#e8f5e9', border: '#388e3c', icon: '🛒', gradient: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)' },
                '네이버_파워링크': { bg: '#fff3e0', border: '#f57c00', icon: '🔗', gradient: 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)' },
                '네이버_신제품검색광고': { bg: '#fce4ec', border: '#c2185b', icon: '✨', gradient: 'linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%)' },
                '구분필요': { bg: '#f3e5f5', border: '#7b1fa2', icon: '❓', gradient: 'linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%)' }
            };

            let html = '';
            categories.forEach(category => {
                const dayData = byCategory[category];
                if (!dayData || dayData.length === 0) return;

                // 최고/최저 ROAS 요일 찾기
                const sortedByRoas = [...dayData].sort((a, b) => (b.avg_roas || 0) - (a.avg_roas || 0));
                const bestRoasDay = sortedByRoas[0];
                const worstRoasDay = sortedByRoas[sortedByRoas.length - 1];

                // 평균 계산
                const avgRoas = dayData.reduce((sum, d) => sum + (d.avg_roas || 0), 0) / dayData.length;
                const avgCost = dayData.reduce((sum, d) => sum + (d.avg_cost || 0), 0) / dayData.length;
                const avgRevenue = dayData.reduce((sum, d) => sum + (d.avg_revenue || 0), 0) / dayData.length;

                const roasDiff = bestRoasDay.avg_roas && worstRoasDay.avg_roas
                    ? ((bestRoasDay.avg_roas - worstRoasDay.avg_roas) / worstRoasDay.avg_roas * 100).toFixed(1)
                    : '0';

                const colorConfig = channelColors[category] || { bg: '#f5f5f5', border: '#757575', icon: '📊', gradient: 'linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%)' };

                html += `
                <div style="background: ${colorConfig.gradient}; border-radius: 12px; padding: 20px; border-left: 4px solid ${colorConfig.border}; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span style="font-size: 24px;">${colorConfig.icon}</span>
                        <div>
                            <div style="font-size: 15px; font-weight: 700; color: #212121;">${category}</div>
                            <div style="font-size: 11px; color: #757575;">일평균 비용 ${formatCurrency(avgCost)}</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 10px; color: #757575; margin-bottom: 4px;">🏆 최고 ROAS 요일</div>
                            <div style="font-size: 14px; font-weight: 700; color: #2e7d32;">${getDayEmoji(bestRoasDay.day)} ${bestRoasDay.day}</div>
                            <div style="font-size: 18px; font-weight: 800; color: #1b5e20;">${(bestRoasDay.avg_roas || 0).toFixed(0)}%</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
                            <div style="font-size: 10px; color: #757575; margin-bottom: 4px;">📉 최저 ROAS 요일</div>
                            <div style="font-size: 14px; font-weight: 700; color: #c62828;">${getDayEmoji(worstRoasDay.day)} ${worstRoasDay.day}</div>
                            <div style="font-size: 18px; font-weight: 800; color: #b71c1c;">${(worstRoasDay.avg_roas || 0).toFixed(0)}%</div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.6); padding: 10px 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px; color: #616161;">요일별 ROAS 편차</span>
                        <span style="font-size: 13px; font-weight: 700; color: ${parseFloat(roasDiff) > 20 ? '#d32f2f' : '#1565c0'};">+${roasDiff}%</span>
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
        }

        // 채널별 요일 ROAS 비교 차트 렌더링
        let channelDayRoasChartInstance = null;
        function renderChannelDayRoasChart() {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const byCategory = seasonality.by_category || {};
            const canvas = document.getElementById('channelDayRoasChart');

            if (!canvas) return;

            const categories = Object.keys(byCategory);
            if (categories.length === 0) return;

            // 요일 순서 정의
            const dayOrder = ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'];
            const dayLabels = ['월', '화', '수', '목', '금', '토', '일'];

            // 채널별 색상
            const channelColorMap = {
                '메타_전환': { bg: 'rgba(25, 118, 210, 0.7)', border: '#1976d2' },
                '네이버_쇼핑검색': { bg: 'rgba(56, 142, 60, 0.7)', border: '#388e3c' },
                '네이버_파워링크': { bg: 'rgba(245, 124, 0, 0.7)', border: '#f57c00' },
                '네이버_신제품검색광고': { bg: 'rgba(194, 24, 91, 0.7)', border: '#c2185b' },
                '구분필요': { bg: 'rgba(123, 31, 162, 0.7)', border: '#7b1fa2' }
            };

            // 데이터셋 생성
            const datasets = categories.map(category => {
                const dayData = byCategory[category];
                const roasByDay = {};
                dayData.forEach(d => { roasByDay[d.day] = d.avg_roas || 0; });

                const colors = channelColorMap[category] || { bg: 'rgba(158, 158, 158, 0.7)', border: '#9e9e9e' };

                return {
                    label: category,
                    data: dayOrder.map(day => roasByDay[day] || 0),
                    backgroundColor: colors.bg,
                    borderColor: colors.border,
                    borderWidth: 1,
                    borderRadius: 4
                };
            });

            // 기존 차트 제거
            if (channelDayRoasChartInstance) {
                channelDayRoasChartInstance.destroy();
            }

            const ctx = canvas.getContext('2d');
            channelDayRoasChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ROAS ' + context.raw.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ROAS (%)',
                                font: { size: 11 }
                            },
                            ticks: {
                                callback: function(value) { return value + '%'; }
                            }
                        }
                    }
                }
            });
        }

        // 채널별 요일 분석 테이블 렌더링 (드롭다운 방식)
        let channelDaySelectorInitialized = false;

        function renderSeasonalityCategoryTable() {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const byCategory = seasonality.by_category || {};
            const selector = document.getElementById('channelDaySelector');
            const tbody = document.getElementById('seasonalityCategoryTableBody');

            const categories = Object.keys(byCategory);
            if (!tbody || categories.length === 0) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            // 드롭다운 옵션 생성 (최초 1회)
            if (selector && !channelDaySelectorInitialized) {
                const channelIcons = {
                    '메타_전환': '📘',
                    '네이버_쇼핑검색': '🛒',
                    '네이버_파워링크': '🔗',
                    '네이버_신제품검색광고': '✨',
                    '구분필요': '❓'
                };

                selector.innerHTML = categories.map((cat, idx) => {
                    const icon = channelIcons[cat] || '📊';
                    return `<option value="${cat}" ${idx === 0 ? 'selected' : ''}>${icon} ${cat}</option>`;
                }).join('');

                // 드롭다운 변경 이벤트
                selector.addEventListener('change', function() {
                    renderChannelDayTableForCategory(this.value);
                });

                channelDaySelectorInitialized = true;
            }

            // 첫 번째 채널 데이터 렌더링
            const selectedCategory = selector ? selector.value : categories[0];
            renderChannelDayTableForCategory(selectedCategory);

            // 인사이트 업데이트
            renderChannelDayInsight();
        }

        // 선택된 채널의 요일별 데이터 렌더링
        function renderChannelDayTableForCategory(category) {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const byCategory = seasonality.by_category || {};
            const tbody = document.getElementById('seasonalityCategoryTableBody');

            if (!tbody || !byCategory[category]) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--grey-500);">데이터가 없습니다</td></tr>';
                return;
            }

            const dayData = byCategory[category];
            const dayOrder = ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'];

            // 요일 데이터 맵 생성
            const dayMap = {};
            dayData.forEach(d => { dayMap[d.day] = d; });

            // 최고/최저 ROAS 찾기
            const roasValues = dayData.map(d => d.avg_roas || 0);
            const maxRoas = Math.max(...roasValues);
            const minRoas = Math.min(...roasValues);

            let html = '';
            dayOrder.forEach((day) => {
                const d = dayMap[day];
                if (!d) return;

                const isBest = d.avg_roas === maxRoas;
                const isWorst = d.avg_roas === minRoas;

                // 성과 레벨 판단
                let performanceLabel = '보통';
                let performanceColor = '#757575';
                let performanceBg = '#f5f5f5';
                if (isBest) {
                    performanceLabel = '🏆 최고';
                    performanceColor = '#1b5e20';
                    performanceBg = '#c8e6c9';
                } else if (isWorst) {
                    performanceLabel = '📉 최저';
                    performanceColor = '#b71c1c';
                    performanceBg = '#ffcdd2';
                } else if (d.avg_roas > (maxRoas + minRoas) / 2) {
                    performanceLabel = '양호';
                    performanceColor = '#2e7d32';
                    performanceBg = '#e8f5e9';
                }

                const rowBg = isBest ? 'background: #f1f8e9;' : (isWorst ? 'background: #fff8f8;' : '');

                html += `<tr style="${rowBg}">`;
                html += `<td style="text-align: center; font-weight: 600;">${getDayEmoji(day)} ${day}</td>`;
                html += `<td style="text-align: right;">${formatCurrency(d.avg_cost || 0)}</td>`;
                html += `<td style="text-align: right; font-weight: 500;">${formatCurrency(d.avg_revenue || 0)}</td>`;
                html += `<td style="text-align: right; font-weight: 700; font-size: 14px; color: ${isBest ? '#1b5e20' : (isWorst ? '#b71c1c' : '#424242')};">${(d.avg_roas || 0).toFixed(1)}%</td>`;
                html += `<td style="text-align: right; color: ${isWorst ? '#b71c1c' : '#616161'};">${formatCurrency(d.avg_cpa || 0)}</td>`;
                html += `<td style="text-align: center;"><span style="background: ${performanceBg}; color: ${performanceColor}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${performanceLabel}</span></td>`;
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        // 채널별 요일 인사이트 렌더링 (강화)
        function renderChannelDayInsight() {
            const seasonality = getSeasonalityData().seasonality_analysis || {};
            const byCategory = seasonality.by_category || {};
            const insights = getSeasonalityData().seasonality_insights || [];
            const insightText = document.getElementById('seasonalityCategoryInsightText');

            if (!insightText) return;

            const categories = Object.keys(byCategory);
            if (categories.length === 0) {
                insightText.innerHTML = '채널별 요일 데이터를 분석 중입니다.';
                return;
            }

            let insightParts = [];

            // 각 채널별 분석
            categories.forEach(category => {
                const dayData = byCategory[category];
                if (!dayData || dayData.length === 0) return;

                const sortedByRoas = [...dayData].sort((a, b) => (b.avg_roas || 0) - (a.avg_roas || 0));
                const bestDay = sortedByRoas[0];
                const worstDay = sortedByRoas[sortedByRoas.length - 1];

                const roasDiff = ((bestDay.avg_roas - worstDay.avg_roas) / worstDay.avg_roas * 100).toFixed(0);

                insightParts.push(`<strong>${category}</strong>: ${getDayEmoji(bestDay.day)} <span style="color: #1b5e20; font-weight: 600;">${bestDay.day}</span>이 ROAS ${bestDay.avg_roas.toFixed(0)}%로 가장 효율적 (vs ${worstDay.day} ${worstDay.avg_roas.toFixed(0)}%, +${roasDiff}% 차이)`);
            });

            // 전략적 제안 추가
            let strategy = '';
            if (categories.includes('메타_전환') && categories.includes('네이버_쇼핑검색')) {
                const metaData = byCategory['메타_전환'];
                const naverData = byCategory['네이버_쇼핑검색'];

                if (metaData && naverData) {
                    const metaBest = [...metaData].sort((a, b) => (b.avg_roas || 0) - (a.avg_roas || 0))[0];
                    const naverBest = [...naverData].sort((a, b) => (b.avg_roas || 0) - (a.avg_roas || 0))[0];

                    if (metaBest.day !== naverBest.day) {
                        strategy = `<br><br>💡 <strong>전략 제안</strong>: 메타는 <span style="color: #1976d2; font-weight: 600;">${metaBest.day}</span>, 네이버는 <span style="color: #388e3c; font-weight: 600;">${naverBest.day}</span>에 예산을 집중하면 채널별 최적화가 가능합니다.`;
                    } else {
                        strategy = `<br><br>💡 <strong>전략 제안</strong>: 두 채널 모두 <span style="font-weight: 600;">${metaBest.day}</span>이 최적입니다. 해당 요일에 전체 예산을 집중 배분하세요.`;
                    }
                }
            }

            insightText.innerHTML = insightParts.join('<br>') + strategy;
        }

        // 기기 아이콘 반환
        function getDeviceIcon(device) {
            const icons = {
                'Computers': '🖥️',
                'Mobile phones': '📱',
                'Tablets': '📱',
                'TV screens': '📺',
                'OTHER': '❓'
            };
            return icons[device] || '📊';
        }

        // 플랫폼 아이콘 반환
        function getPlatformIcon(platform) {
            const icons = {
                'Cross-network': '🌐',
                'Display Network': '🖼️',
                'Google search': '🔍',
                'Search partners': '🔎',
                'YouTube': '▶️'
            };
            return icons[platform] || '📊';
        }

        // 요일 이모지 반환
        function getDayEmoji(day) {
            const emojis = {
                '월요일': '🌙',
                '화요일': '🔥',
                '수요일': '💧',
                '목요일': '🌳',
                '금요일': '💰',
                '토요일': '🌍',
                '일요일': '☀️'
            };
            return emojis[day] || '📅';
        }

        // 채널 아이콘 반환
        function getCategoryIcon(category) {
            if (category.includes('메타')) return '📘';
            if (category.includes('네이버')) return '🟢';
            if (category.includes('구글')) return '🔵';
            return '📊';
        }

        // 효율 등급 뱃지 반환
        function getEfficiencyGrade(roas, maxRoas) {
            if (maxRoas === 0) return '<span style="background: #f5f5f5; color: #9e9e9e; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">-</span>';
            const ratio = roas / maxRoas;
            if (ratio >= 0.8) {
                return '<span style="background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">A등급</span>';
            } else if (ratio >= 0.5) {
                return '<span style="background: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">B등급</span>';
            } else if (ratio >= 0.2) {
                return '<span style="background: #fff3e0; color: #e65100; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">C등급</span>';
            } else {
                return '<span style="background: #ffebee; color: #d32f2f; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">D등급</span>';
            }
        }

        // 유틸리티 함수들
        function formatCurrency(value) {
            if (value === null || value === undefined) return '₩0';
            return '₩' + Math.round(value).toLocaleString('ko-KR');
        }

        function formatNumber(value) {
            if (value === null || value === undefined) return '0';
            return Math.round(value).toLocaleString('ko-KR');
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '0%';
            return value.toFixed(1) + '%';
        }

        function formatValue(value) {
            if (value === null || value === undefined) return '0';
            return value.toFixed(1);
        }

        function getSeverityLabel(severity) {
            const labels = {
                'high': '높음',
                'warning': '경고',
                'opportunity': '기회',
                'positive': '긍정',
                'low': '낮음'
            };
            return labels[severity] || severity;
        }

        // 접기/펼치기 기능 (최적화)
        document.querySelectorAll('.collapsible-header').forEach(header => {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.collapsible-toggle-icon');
            const toggleText = header.querySelector('.collapsible-toggle span:first-child');

            header.addEventListener('click', function(e) {
                e.preventDefault();
                const isExpanded = content.classList.contains('expanded');
                content.classList.toggle('expanded', !isExpanded);
                icon.classList.toggle('collapsed', isExpanded);
                toggleText.textContent = isExpanded ? '펼치기' : '접기';
            });
        });

        // KPI 주요/세부 성과 토글 버튼
        document.querySelectorAll('.kpi-view-toggle .kpi-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // 버튼 활성화 토글
                document.querySelectorAll('.kpi-view-toggle .kpi-view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // kpi-section에 show-all 토글
                const kpiSection = document.getElementById('kpi-section');
                if (kpiSection) {
                    if (this.dataset.kpiView === 'all') {
                        kpiSection.classList.add('show-all');
                    } else {
                        kpiSection.classList.remove('show-all');
                    }
                }
            });
        });

        // 성과 분석 서브탭 버튼
        document.querySelectorAll('.performance-subtab').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetTab = this.dataset.perfTab;

                // 버튼 active 클래스 토글 (view-btn 스타일 사용)
                document.querySelectorAll('.performance-subtab').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');

                // 컨텐츠 표시
                document.querySelectorAll('.performance-filter-content').forEach(content => {
                    content.style.display = 'none';
                    content.classList.remove('active');
                });

                const viewMap = {
                    'brand': 'brandView',
                    'product': 'productView',
                    'promotion': 'promotionView',
                    'targeting': 'targetingView'
                };

                const targetView = document.getElementById(viewMap[targetTab]);
                if (targetView) {
                    targetView.style.display = 'block';
                    targetView.classList.add('active');
                }
            });
        });

        // 페이지 로드 시 데이터 로딩
        // 탭 전환 및 이벤트 리스너 설정
        function setupEventListeners() {
            // 추이 분석 탭 전환
            document.querySelectorAll('.trend-analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.trend-analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.trend-analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    let selectedTab = null;
                    if (targetTab === 'timeseries') selectedTab = document.getElementById('timeseriesTab');
                    else if (targetTab === 'gender') selectedTab = document.getElementById('genderTab');
                    else if (targetTab === 'age') selectedTab = document.getElementById('ageTab');
                    else if (targetTab === 'platform') selectedTab = document.getElementById('platformTab');
                    else if (targetTab === 'device-platform') selectedTab = document.getElementById('devicePlatformTab');
                    else if (targetTab === 'device-type') selectedTab = document.getElementById('deviceTypeTab');

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });

            // 시계열 기간 버튼 이벤트
            document.querySelectorAll('.timeseries-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.timeseries-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTimeseriesPeriod = this.dataset.period;
                    renderTimeseriesTrendChart();
                });
            });

            // 시계열 지표 드롭다운 이벤트
            const timeseriesMetricDropdown = document.getElementById('timeseriesMetricDropdown');
            if (timeseriesMetricDropdown) {
                timeseriesMetricDropdown.addEventListener('change', function() {
                    currentTimeseriesMetric = this.value;
                    renderTimeseriesTrendChart();
                });
            }

            // 시계열 기간 선택 이벤트
            const timeseriesStartDateInput = document.getElementById('timeseriesStartDate');
            const timeseriesEndDateInput = document.getElementById('timeseriesEndDate');

            if (timeseriesStartDateInput) {
                timeseriesStartDateInput.addEventListener('change', function(e) {
                    timeseriesStartDate = e.target.value;
                    renderTimeseriesTrendChart();
                });
            }

            if (timeseriesEndDateInput) {
                timeseriesEndDateInput.addEventListener('change', function(e) {
                    timeseriesEndDate = e.target.value;
                    renderTimeseriesTrendChart();
                });
            }

            // 시계열 필터 버튼 이벤트
            // 시계열 필터 - 이제 체크박스로 처리됨 (initTimeseriesDropdowns에서 처리)

            // 성별 필터 버튼 이벤트
            document.querySelectorAll('.gender-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.gender-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentGenderFilter = this.dataset.filter;
                    selectedGenderItems = [];
                    initGenderDropdowns();
                });
            });

            // 성별 기간 버튼 이벤트
            document.querySelectorAll('.gender-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.gender-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentGenderPeriod = this.dataset.period;
                    renderGenderTrendChart();
                });
            });

            // 성별 지표 드롭다운 이벤트
            const genderMetricDropdown = document.getElementById('genderMetricDropdown');
            if (genderMetricDropdown) {
                genderMetricDropdown.addEventListener('change', function() {
                    currentGenderMetric = this.value;
                    renderGenderTrendChart();
                });
            }

            // 성별 기간 선택 이벤트
            const genderStartDateInput = document.getElementById('genderStartDate');
            const genderEndDateInput = document.getElementById('genderEndDate');

            if (genderStartDateInput) {
                genderStartDateInput.addEventListener('change', function(e) {
                    genderStartDate = e.target.value;
                    renderGenderTrendChart();
                });
            }

            if (genderEndDateInput) {
                genderEndDateInput.addEventListener('change', function(e) {
                    genderEndDate = e.target.value;
                    renderGenderTrendChart();
                });
            }

            // 연령 필터 버튼 이벤트
            document.querySelectorAll('.age-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.age-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentAgeFilter = this.dataset.filter;
                    selectedAgeItems = [];
                    initAgeDropdowns();
                });
            });

            // 연령 기간 버튼 이벤트
            document.querySelectorAll('.age-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.age-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentAgePeriod = this.dataset.period;
                    renderAgeTrendChart();
                });
            });

            // 연령 지표 드롭다운 이벤트
            const ageMetricDropdown = document.getElementById('ageMetricDropdown');
            if (ageMetricDropdown) {
                ageMetricDropdown.addEventListener('change', function() {
                    currentAgeMetric = this.value;
                    renderAgeTrendChart();
                });
            }

            // 연령 기간 선택 이벤트
            const ageStartDateInput = document.getElementById('ageStartDate');
            const ageEndDateInput = document.getElementById('ageEndDate');

            if (ageStartDateInput) {
                ageStartDateInput.addEventListener('change', function(e) {
                    ageStartDate = e.target.value;
                    renderAgeTrendChart();
                });
            }

            if (ageEndDateInput) {
                ageEndDateInput.addEventListener('change', function(e) {
                    ageEndDate = e.target.value;
                    renderAgeTrendChart();
                });
            }

            // 플랫폼 필터 버튼 이벤트
            document.querySelectorAll('.platform-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.platform-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPlatformFilter = this.dataset.filter;
                    selectedPlatformItems = [];
                    initPlatformDropdowns();
                });
            });

            // 플랫폼 기간 버튼 이벤트
            document.querySelectorAll('.platform-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.platform-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPlatformPeriod = this.dataset.period;
                    renderPlatformTrendChart();
                });
            });

            // 플랫폼 지표 드롭다운 이벤트
            const platformMetricDropdown = document.getElementById('platformMetricDropdown');
            if (platformMetricDropdown) {
                platformMetricDropdown.addEventListener('change', function() {
                    currentPlatformMetric = this.value;
                    renderPlatformTrendChart();
                });
            }

            // 플랫폼 기간 선택 이벤트
            const platformStartDateInput = document.getElementById('platformStartDate');
            const platformEndDateInput = document.getElementById('platformEndDate');

            if (platformStartDateInput) {
                platformStartDateInput.addEventListener('change', function(e) {
                    platformStartDate = e.target.value;
                    renderPlatformTrendChart();
                });
            }

            if (platformEndDateInput) {
                platformEndDateInput.addEventListener('change', function(e) {
                    platformEndDate = e.target.value;
                    renderPlatformTrendChart();
                });
            }

            // 기기플랫폼 필터 버튼 이벤트
            document.querySelectorAll('.device-platform-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.device-platform-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDevicePlatformFilter = this.dataset.filter;
                    selectedDevicePlatformItems = [];
                    initDevicePlatformDropdowns();
                });
            });

            // 기기플랫폼 기간 버튼 이벤트
            document.querySelectorAll('.deviceplatform-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.deviceplatform-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDevicePlatformPeriod = this.dataset.period;
                    renderDevicePlatformTrendChart();
                });
            });

            // 기기플랫폼 지표 드롭다운 이벤트
            const devicePlatformMetricDropdown = document.getElementById('devicePlatformMetricDropdown');
            if (devicePlatformMetricDropdown) {
                devicePlatformMetricDropdown.addEventListener('change', function() {
                    currentDevicePlatformMetric = this.value;
                    renderDevicePlatformTrendChart();
                });
            }

            // 기기플랫폼 기간 선택 이벤트
            const devicePlatformStartDateInput = document.getElementById('devicePlatformStartDate');
            const devicePlatformEndDateInput = document.getElementById('devicePlatformEndDate');

            if (devicePlatformStartDateInput) {
                devicePlatformStartDateInput.addEventListener('change', function(e) {
                    devicePlatformStartDate = e.target.value;
                    renderDevicePlatformTrendChart();
                });
            }

            if (devicePlatformEndDateInput) {
                devicePlatformEndDateInput.addEventListener('change', function(e) {
                    devicePlatformEndDate = e.target.value;
                    renderDevicePlatformTrendChart();
                });
            }

            // 기기유형 필터 버튼 이벤트
            document.querySelectorAll('.device-type-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.device-type-filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDeviceTypeFilter = this.dataset.filter;
                    selectedDeviceTypeItems = [];
                    initDeviceTypeDropdowns();
                });
            });

            // 기기유형 기간 버튼 이벤트
            document.querySelectorAll('.device-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.device-period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentDeviceTypePeriod = this.dataset.period;
                    renderDeviceTypeTrendChart();
                });
            });

            // 기기유형 지표 드롭다운 이벤트
            const deviceTypeMetricDropdown = document.getElementById('deviceTypeMetricDropdown');
            if (deviceTypeMetricDropdown) {
                deviceTypeMetricDropdown.addEventListener('change', function() {
                    currentDeviceTypeMetric = this.value;
                    renderDeviceTypeTrendChart();
                });
            }

            // 기기유형 기간 선택 이벤트
            const deviceTypeStartDateInput = document.getElementById('deviceTypeStartDate');
            const deviceTypeEndDateInput = document.getElementById('deviceTypeEndDate');

            if (deviceTypeStartDateInput) {
                deviceTypeStartDateInput.addEventListener('change', function(e) {
                    deviceTypeStartDate = e.target.value;
                    renderDeviceTypeTrendChart();
                });
            }

            if (deviceTypeEndDateInput) {
                deviceTypeEndDateInput.addEventListener('change', function(e) {
                    deviceTypeEndDate = e.target.value;
                    renderDeviceTypeTrendChart();
                });
            }

        }

        // 초기화 필터 함수
        function initTrendAnalysisFilters() {
            // 현재는 별도 필터 필요 없음
        }

        // 시계열 드롭다운 초기화
        function initTimeseriesDropdowns() {
            if (!adsetDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'timeseriesFilterChannelList', label: '채널' },
                'product': { column: '상품명', listId: 'timeseriesFilterProductList', label: '제품' },
                'brand': { column: '브랜드명', listId: 'timeseriesFilterBrandList', label: '브랜드' },
                'promotion': { column: '프로모션', listId: 'timeseriesFilterPromotionList', label: '프로모션' }
            };

            // 각 필터에 대한 체크박스 리스트 생성
            Object.keys(filterMap).forEach(filterKey => {
                const { column, listId } = filterMap[filterKey];
                const list = document.getElementById(listId);
                if (!list) return;

                const items = [...new Set(adsetDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                items.sort();

                list.innerHTML = items.map(item => `
                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--grey-100)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" class="filter-item-checkbox" data-filter="${filterKey}" value="${item}" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                        ${item}
                    </label>
                `).join('');

                // 개별 체크박스 이벤트
                list.querySelectorAll('.filter-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updateTimeseriesFilters();
                        updateFilterButtonText(filterKey);
                    });
                });
            });

            // 드롭다운 버튼 클릭 이벤트
            document.querySelectorAll('.timeseries-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filterType = this.dataset.filter;
                    const dropdown = document.querySelector(`.timeseries-filter-dropdown-list[data-filter="${filterType}"]`);

                    // 다른 드롭다운 닫기
                    document.querySelectorAll('.timeseries-filter-dropdown-list').forEach(dd => {
                        if (dd !== dropdown) dd.style.display = 'none';
                    });

                    // 현재 드롭다운 토글
                    if (dropdown) {
                        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                    }
                });
            });

            // 전체 선택 체크박스 이벤트
            document.querySelectorAll('.timeseries-filter-select-all').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filterType = this.dataset.filter;
                    const list = document.getElementById(`timeseriesFilter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}List`);
                    if (!list) return;

                    const itemCheckboxes = list.querySelectorAll('.filter-item-checkbox');
                    itemCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });

                    updateTimeseriesFilters();
                    updateFilterButtonText(filterType);
                });
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.timeseries-filter-dropdown-btn') && !e.target.closest('.timeseries-filter-dropdown-list')) {
                    document.querySelectorAll('.timeseries-filter-dropdown-list').forEach(dd => {
                        dd.style.display = 'none';
                    });
                }
            });

            // 기간 선택 초기값 설정 (전체 데이터의 최소/최대 날짜)
            const dates = dimensionData
                .map(row => row['일'])
                .filter(date => date && date !== '' && date !== '-')
                .map(date => new Date(date))
                .filter(date => !isNaN(date));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const startInput = document.getElementById('timeseriesStartDate');
                const endInput = document.getElementById('timeseriesEndDate');

                if (startInput && endInput) {
                    startInput.value = formatDateForInput(minDate);
                    endInput.value = formatDateForInput(maxDate);
                    timeseriesStartDate = formatDateForInput(minDate);
                    timeseriesEndDate = formatDateForInput(maxDate);
                }
            }

            // 초기 차트 렌더링 (필터 미선택 상태)
            renderTimeseriesTrendChart();
        }

        function updateFilterButtonText(filterKey) {
            const filterMap = {
                'channel': '채널',
                'product': '제품',
                'brand': '브랜드',
                'promotion': '프로모션'
            };

            const btn = document.querySelector(`.timeseries-filter-dropdown-btn[data-filter="${filterKey}"]`);
            const list = document.getElementById(`timeseriesFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`);

            if (!btn || !list) return;

            const checkedBoxes = list.querySelectorAll('.filter-item-checkbox:checked');
            const totalBoxes = list.querySelectorAll('.filter-item-checkbox');
            const btnText = btn.querySelector('span:first-child');
            const countText = btn.querySelector('.timeseries-selected-count');

            if (checkedBoxes.length === 0) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = '';
            } else if (checkedBoxes.length === totalBoxes.length) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = `(${checkedBoxes.length})`;
            } else if (checkedBoxes.length === 1) {
                btnText.textContent = checkedBoxes[0].value;
                countText.textContent = '';
            } else {
                btnText.textContent = `${checkedBoxes[0].value} 외`;
                countText.textContent = `(${checkedBoxes.length})`;
            }
        }

        function updateTimeseriesFilters() {
            if (!adsetDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'timeseriesFilterChannelList' },
                'product': { column: '상품명', listId: 'timeseriesFilterProductList' },
                'brand': { column: '브랜드명', listId: 'timeseriesFilterBrandList' },
                'promotion': { column: '프로모션', listId: 'timeseriesFilterPromotionList' }
            };

            // 선택된 필터 값 수집
            Object.keys(filterMap).forEach(filterKey => {
                const { listId } = filterMap[filterKey];
                const list = document.getElementById(listId);

                if (list) {
                    const checkedBoxes = list.querySelectorAll('.filter-item-checkbox:checked');
                    timeseriesFilters[filterKey] = Array.from(checkedBoxes).map(cb => cb.value);
                } else {
                    timeseriesFilters[filterKey] = [];
                }
            });

            // 필터링된 광고세트 계산 및 표시
            updateFilteredAdsets();

            // 차트 업데이트
            renderTimeseriesTrendChart();
        }

        function updateFilteredAdsets() {
            if (!adsetDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션'
            };

            // AND 연산으로 광고세트 필터링
            const filteredAdsets = new Set();

            adsetDimensionData.forEach(row => {
                const adset = row['광고세트'];
                if (!adset || adset === '' || adset === '-') return;

                let matchesAllFilters = true;

                // 각 필터 타입별로 AND 연산
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = timeseriesFilters[filterKey];

                    // 해당 필터가 활성화되어 있고 값이 선택된 경우
                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        // 선택된 값 중 하나라도 일치하지 않으면 제외
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (matchesAllFilters) {
                    filteredAdsets.add(adset);
                }
            });

            // 결과 표시
            const adsetArray = Array.from(filteredAdsets).sort();
            const countEl = document.getElementById('filteredAdsetCount');
            const listEl = document.getElementById('filteredAdsetList');

            if (countEl) countEl.textContent = adsetArray.length;

            if (listEl) {
                if (adsetArray.length === 0) {
                    listEl.textContent = '필터를 선택하면 해당하는 광고세트가 표시됩니다.';
                } else {
                    listEl.innerHTML = adsetArray.map(adset =>
                        `<div style="padding: 4px 8px; margin: 4px 0; background: white; border-radius: 4px; border: 1px solid var(--grey-200);">${adset}</div>`
                    ).join('');
                }
            }
        }

        // 성별 드롭다운 초기화
        function initGenderDropdowns() {
            if (!genderDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'genderFilterChannelList', label: '채널' },
                'product': { column: '상품명', listId: 'genderFilterProductList', label: '제품' },
                'brand': { column: '브랜드명', listId: 'genderFilterBrandList', label: '브랜드' },
                'promotion': { column: '프로모션', listId: 'genderFilterPromotionList', label: '프로모션' },
                'adset': { column: '광고세트', listId: 'genderFilterAdsetList', label: '광고세트' }
            };

            // 각 필터에 대한 체크박스 리스트 생성
            Object.keys(filterMap).forEach(filterKey => {
                const { column, listId } = filterMap[filterKey];
                const list = document.getElementById(listId);
                if (!list) return;

                const items = [...new Set(genderDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                items.sort();

                list.innerHTML = items.map(item => `
                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--grey-100)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" class="gender-filter-item-checkbox" data-filter="${filterKey}" value="${item}" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                        ${item}
                    </label>
                `).join('');

                // 개별 체크박스 이벤트
                list.querySelectorAll('.gender-filter-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // 전체 선택 체크박스 상태 업데이트
                        const selectAllCheckbox = document.querySelector(`.gender-filter-select-all[data-filter="${filterKey}"]`);
                        if (selectAllCheckbox) {
                            const allCheckboxes = list.querySelectorAll('.gender-filter-item-checkbox');
                            const checkedCheckboxes = list.querySelectorAll('.gender-filter-item-checkbox:checked');
                            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                        }

                        updateGenderFilters();
                        updateGenderFilterButtonText(filterKey);
                    });
                });
            });

            // 드롭다운 버튼 클릭 이벤트
            document.querySelectorAll('.gender-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filterType = this.dataset.filter;
                    const dropdown = document.querySelector(`.gender-filter-dropdown-list[data-filter="${filterType}"]`);

                    // 다른 드롭다운 닫기
                    document.querySelectorAll('.gender-filter-dropdown-list').forEach(dd => {
                        if (dd !== dropdown) dd.style.display = 'none';
                    });

                    // 현재 드롭다운 토글
                    if (dropdown) {
                        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                    }
                });
            });

            // 전체 선택 체크박스 이벤트
            document.querySelectorAll('.gender-filter-select-all').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filterType = this.dataset.filter;
                    const list = document.getElementById(`genderFilter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}List`);
                    if (!list) return;

                    const itemCheckboxes = list.querySelectorAll('.gender-filter-item-checkbox');
                    itemCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });

                    updateGenderFilters();
                    updateGenderFilterButtonText(filterType);
                });
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.gender-filter-dropdown-btn') && !e.target.closest('.gender-filter-dropdown-list')) {
                    document.querySelectorAll('.gender-filter-dropdown-list').forEach(dd => {
                        dd.style.display = 'none';
                    });
                }
            });

            // 기간 선택 초기값 설정 (전체 데이터의 최소/최대 날짜)
            const dates = dimensionData
                .map(row => row['일'])
                .filter(date => date && date !== '' && date !== '-')
                .map(date => new Date(date))
                .filter(date => !isNaN(date));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const startInput = document.getElementById('genderStartDate');
                const endInput = document.getElementById('genderEndDate');

                if (startInput && endInput) {
                    startInput.value = formatDateForInput(minDate);
                    endInput.value = formatDateForInput(maxDate);
                    genderStartDate = formatDateForInput(minDate);
                    genderEndDate = formatDateForInput(maxDate);
                }
            }

            // 초기 차트 렌더링 (필터 미선택 상태 메시지 표시)
            renderGenderTrendChart();
        }

        function updateGenderFilterButtonText(filterKey) {
            const filterMap = {
                'channel': '채널',
                'product': '제품',
                'brand': '브랜드',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const btn = document.querySelector(`.gender-filter-dropdown-btn[data-filter="${filterKey}"]`);
            const list = document.getElementById(`genderFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`);

            if (!btn || !list) return;

            const checkedBoxes = list.querySelectorAll('.gender-filter-item-checkbox:checked');
            const totalBoxes = list.querySelectorAll('.gender-filter-item-checkbox');
            const btnText = btn.querySelector('span:first-child');
            const countText = btn.querySelector('.gender-selected-count');

            if (checkedBoxes.length === 0) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = '';
            } else if (checkedBoxes.length === totalBoxes.length) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = `(${checkedBoxes.length})`;
            } else if (checkedBoxes.length === 1) {
                btnText.textContent = checkedBoxes[0].value;
                countText.textContent = '';
            } else {
                btnText.textContent = `${checkedBoxes[0].value} 외`;
                countText.textContent = `(${checkedBoxes.length})`;
            }
        }

        // 전역 필터 상태 저장
        let currentGenderFilters = {
            channel: [],
            product: [],
            brand: [],
            promotion: [],
            adset: []
        };

        function updateGenderFilters() {
            if (!genderDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'genderFilterChannelList' },
                'product': { column: '상품명', listId: 'genderFilterProductList' },
                'brand': { column: '브랜드명', listId: 'genderFilterBrandList' },
                'promotion': { column: '프로모션', listId: 'genderFilterPromotionList' },
                'adset': { column: '광고세트', listId: 'genderFilterAdsetList' }
            };

            // 선택된 필터 값 수집
            Object.keys(filterMap).forEach(filterKey => {
                const { listId } = filterMap[filterKey];
                const list = document.getElementById(listId);

                if (list) {
                    const checkedBoxes = list.querySelectorAll('.gender-filter-item-checkbox:checked');
                    currentGenderFilters[filterKey] = Array.from(checkedBoxes).map(cb => cb.value);
                } else {
                    currentGenderFilters[filterKey] = [];
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentGenderFilters).every(arr => arr.length === 0);

            if (allFiltersEmpty) {
                // 모든 필터가 해제되면 필터 상태 초기화
                currentGenderFilters = {
                    channel: [],
                    product: [],
                    brand: [],
                    promotion: [],
                    adset: []
                };
            }

            // 필터링된 성별 데이터 계산
            updateFilteredGenderCount(currentGenderFilters);

            // 차트 업데이트
            renderGenderTrendChart();
        }

        function updateFilteredGenderCount(filters) {
            if (!genderDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const gendersToShow = new Set();

            genderDimensionData.forEach(row => {
                // 성별_통합 컬럼 우선 사용 (없으면 성별 컬럼 사용)
                const rawGender = row['성별_통합'] || row['성별'];
                // 알수없음 필터링 및 정규화 적용
                const normalizedGender = normalizeGender(rawGender);
                if (!normalizedGender) return;

                let matchesAllFilters = true;

                // AND 연산으로 모든 필터 확인
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = filters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (matchesAllFilters) {
                    gendersToShow.add(normalizedGender);
                }
            });

            document.getElementById('filteredGenderCount').textContent = gendersToShow.size;
        }

        function handleGenderDropdownChange(dropdown, index) {
            if (dropdown.value && selectedGenderItems.length < 5) {
                const nextIndex = index + 1;
                const nextDropdown = document.getElementById(`genderDropdown${nextIndex}`);
                if (!nextDropdown && nextIndex < 5) {
                    addGenderDropdown(nextIndex);
                }
            } else if (!dropdown.value) {
                removeGenderDropdownsAfter(index);
            }
            updateSelectedGenderItems();
        }

        function addGenderDropdown(index) {
            if (!dimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션'
            };

            const column = filterMap[currentGenderFilter];
            const items = [...new Set(dimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
            items.sort();

            const container = document.getElementById('genderDropdownContainer');
            if (!container) return;

            const wrapper = document.createElement('div');
            wrapper.id = `genderDropdown${index}`;
            wrapper.className = 'gender-dropdown-wrapper';
            wrapper.style.position = 'relative';

            const dropdown = document.createElement('select');
            dropdown.className = 'gender-dropdown';
            dropdown.style.cssText = 'min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer;';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '항목을 선택하세요';
            dropdown.appendChild(defaultOption);

            items.forEach(item => {
                if (!selectedGenderItems.includes(item)) {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    dropdown.appendChild(option);
                }
            });

            dropdown.addEventListener('change', function() {
                handleGenderDropdownChange(this, index);
            });

            wrapper.appendChild(dropdown);
            container.appendChild(wrapper);
        }

        function removeGenderDropdownsAfter(index) {
            for (let i = index + 1; i <= 5; i++) {
                const dropdown = document.getElementById(`genderDropdown${i}`);
                if (dropdown) dropdown.remove();
            }
        }

        function updateSelectedGenderItems() {
            const container = document.getElementById('genderDropdownContainer');
            if (!container) return;

            selectedGenderItems = [];
            container.querySelectorAll('.gender-dropdown').forEach(dropdown => {
                if (dropdown.value) {
                    selectedGenderItems.push(dropdown.value);
                }
            });

            document.getElementById('selectedGenderCount').textContent = selectedGenderItems.length;
            renderGenderTrendChart();
        }

        // 연령 드롭다운 초기화
        function initAgeDropdowns() {
            if (!ageDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'ageFilterChannelList', label: '채널' },
                'product': { column: '상품명', listId: 'ageFilterProductList', label: '제품' },
                'brand': { column: '브랜드명', listId: 'ageFilterBrandList', label: '브랜드' },
                'promotion': { column: '프로모션', listId: 'ageFilterPromotionList', label: '프로모션' },
                'adset': { column: '광고세트', listId: 'ageFilterAdsetList', label: '광고세트' }
            };

            // 각 필터에 대한 체크박스 리스트 생성
            Object.keys(filterMap).forEach(filterKey => {
                const { column, listId } = filterMap[filterKey];
                const list = document.getElementById(listId);
                if (!list) return;

                const items = [...new Set(ageDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                items.sort();

                list.innerHTML = items.map(item => `
                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--grey-100)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" class="age-filter-item-checkbox" data-filter="${filterKey}" value="${item}" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                        ${item}
                    </label>
                `).join('');

                // 개별 체크박스 이벤트
                list.querySelectorAll('.age-filter-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // 전체 선택 체크박스 상태 업데이트
                        const selectAllCheckbox = document.querySelector(`.age-filter-select-all[data-filter="${filterKey}"]`);
                        if (selectAllCheckbox) {
                            const allCheckboxes = list.querySelectorAll('.age-filter-item-checkbox');
                            const checkedCheckboxes = list.querySelectorAll('.age-filter-item-checkbox:checked');
                            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                        }

                        updateAgeFilters();
                        updateAgeFilterButtonText(filterKey);
                    });
                });
            });

            // 드롭다운 버튼 클릭 이벤트
            document.querySelectorAll('.age-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filterType = this.dataset.filter;
                    const dropdown = document.querySelector(`.age-filter-dropdown-list[data-filter="${filterType}"]`);

                    // 다른 드롭다운 닫기
                    document.querySelectorAll('.age-filter-dropdown-list').forEach(dd => {
                        if (dd !== dropdown) dd.style.display = 'none';
                    });

                    // 현재 드롭다운 토글
                    if (dropdown) {
                        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                    }
                });
            });

            // 전체 선택 체크박스 이벤트
            document.querySelectorAll('.age-filter-select-all').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filterType = this.dataset.filter;
                    const list = document.getElementById(`ageFilter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}List`);
                    if (!list) return;

                    const itemCheckboxes = list.querySelectorAll('.age-filter-item-checkbox');
                    itemCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });

                    updateAgeFilters();
                    updateAgeFilterButtonText(filterType);
                });
            });

            // 기간 선택 초기값 설정 (전체 데이터의 최소/최대 날짜)
            const dates = dimensionData
                .map(row => row['일'])
                .filter(date => date && date !== '' && date !== '-')
                .map(date => new Date(date))
                .filter(date => !isNaN(date));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const startInput = document.getElementById('ageStartDate');
                const endInput = document.getElementById('ageEndDate');

                if (startInput && endInput) {
                    startInput.value = formatDateForInput(minDate);
                    endInput.value = formatDateForInput(maxDate);
                    ageStartDate = formatDateForInput(minDate);
                    ageEndDate = formatDateForInput(maxDate);
                }
            }

            // 초기 차트 렌더링 (필터 미선택 상태 메시지 표시)
            renderAgeTrendChart();
        }

        function updateAgeFilterButtonText(filterKey) {
            const filterMap = {
                'channel': '채널',
                'product': '제품',
                'brand': '브랜드',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const btn = document.querySelector(`.age-filter-dropdown-btn[data-filter="${filterKey}"]`);
            const list = document.getElementById(`ageFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`);

            if (!btn || !list) return;

            const checkedBoxes = list.querySelectorAll('.age-filter-item-checkbox:checked');
            const totalBoxes = list.querySelectorAll('.age-filter-item-checkbox');
            const btnText = btn.querySelector('span:first-child');
            const countText = btn.querySelector('.age-selected-count');

            if (checkedBoxes.length === 0) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = '';
            } else if (checkedBoxes.length === totalBoxes.length) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = `(${checkedBoxes.length})`;
            } else if (checkedBoxes.length === 1) {
                btnText.textContent = checkedBoxes[0].value;
                countText.textContent = '';
            } else {
                btnText.textContent = `${checkedBoxes[0].value} 외`;
                countText.textContent = `(${checkedBoxes.length})`;
            }
        }

        // 전역 필터 상태 저장
        let currentAgeFilters = {
            channel: [],
            product: [],
            brand: [],
            promotion: [],
            adset: []
        };

        function updateAgeFilters() {
            if (!ageDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'ageFilterChannelList' },
                'product': { column: '상품명', listId: 'ageFilterProductList' },
                'brand': { column: '브랜드명', listId: 'ageFilterBrandList' },
                'promotion': { column: '프로모션', listId: 'ageFilterPromotionList' },
                'adset': { column: '광고세트', listId: 'ageFilterAdsetList' }
            };

            // 선택된 필터 값 수집
            Object.keys(filterMap).forEach(filterKey => {
                const { listId } = filterMap[filterKey];
                const list = document.getElementById(listId);

                if (list) {
                    const checkedBoxes = list.querySelectorAll('.age-filter-item-checkbox:checked');
                    currentAgeFilters[filterKey] = Array.from(checkedBoxes).map(cb => cb.value);
                } else {
                    currentAgeFilters[filterKey] = [];
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentAgeFilters).every(arr => arr.length === 0);

            if (allFiltersEmpty) {
                // 모든 필터가 해제되면 필터 상태 초기화
                currentAgeFilters = {
                    channel: [],
                    product: [],
                    brand: [],
                    promotion: [],
                    adset: []
                };
            }

            // 필터링된 연령 데이터 계산
            updateFilteredAgeCount(currentAgeFilters);

            // 차트 업데이트
            renderAgeTrendChart();
        }

        function updateFilteredAgeCount(filters) {
            if (!ageDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const agesToShow = new Set();

            ageDimensionData.forEach(row => {
                // 연령_통합 컬럼 우선 사용
                const age = row['연령_통합'] || row['연령'];
                if (!age || age === '' || age === '-') return;

                let matchesAllFilters = true;

                // AND 연산으로 모든 필터 확인
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = filters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (matchesAllFilters) {
                    agesToShow.add(age);
                }
            });

            document.getElementById('filteredAgeCount').textContent = agesToShow.size;
        }

        function handleAgeDropdownChange(dropdown, index) {
            if (dropdown.value && selectedAgeItems.length < 5) {
                const nextIndex = index + 1;
                const nextDropdown = document.getElementById(`ageDropdown${nextIndex}`);
                if (!nextDropdown && nextIndex < 5) {
                    addAgeDropdown(nextIndex);
                }
            } else if (!dropdown.value) {
                removeAgeDropdownsAfter(index);
            }
            updateSelectedAgeItems();
        }

        function addAgeDropdown(index) {
            if (!dimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션'
            };

            const column = filterMap[currentAgeFilter];
            const items = [...new Set(dimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
            items.sort();

            const container = document.getElementById('ageDropdownContainer');
            if (!container) return;

            const wrapper = document.createElement('div');
            wrapper.id = `ageDropdown${index}`;
            wrapper.className = 'age-dropdown-wrapper';
            wrapper.style.position = 'relative';

            const dropdown = document.createElement('select');
            dropdown.className = 'age-dropdown';
            dropdown.style.cssText = 'min-width: 200px; padding: 10px 12px; border: 1px solid var(--grey-300); border-radius: 6px; background: white; font-size: 13px; color: var(--grey-800); cursor: pointer;';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '항목을 선택하세요';
            dropdown.appendChild(defaultOption);

            items.forEach(item => {
                if (!selectedAgeItems.includes(item)) {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    dropdown.appendChild(option);
                }
            });

            dropdown.addEventListener('change', function() {
                handleAgeDropdownChange(this, index);
            });

            wrapper.appendChild(dropdown);
            container.appendChild(wrapper);
        }

        function removeAgeDropdownsAfter(index) {
            for (let i = index + 1; i <= 5; i++) {
                const dropdown = document.getElementById(`ageDropdown${i}`);
                if (dropdown) dropdown.remove();
            }
        }

        function updateSelectedAgeItems() {
            const container = document.getElementById('ageDropdownContainer');
            if (!container) return;

            selectedAgeItems = [];
            container.querySelectorAll('.age-dropdown').forEach(dropdown => {
                if (dropdown.value) {
                    selectedAgeItems.push(dropdown.value);
                }
            });

            document.getElementById('selectedAgeCount').textContent = selectedAgeItems.length;
            renderAgeTrendChart();
        }

        // 플랫폼 드롭다운 초기화
        function initPlatformDropdowns() {
            if (!platformDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'platformFilterChannelList', label: '채널' },
                'product': { column: '상품명', listId: 'platformFilterProductList', label: '제품' },
                'brand': { column: '브랜드명', listId: 'platformFilterBrandList', label: '브랜드' },
                'promotion': { column: '프로모션', listId: 'platformFilterPromotionList', label: '프로모션' },
                'adset': { column: '광고세트', listId: 'platformFilterAdsetList', label: '광고세트' }
            };

            // 각 필터에 대한 체크박스 리스트 생성
            Object.keys(filterMap).forEach(filterKey => {
                const { column, listId } = filterMap[filterKey];
                const list = document.getElementById(listId);
                if (!list) return;

                const items = [...new Set(platformDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                items.sort();

                list.innerHTML = items.map(item => `
                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--grey-100)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" class="platform-filter-item-checkbox" data-filter="${filterKey}" value="${item}" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                        ${item}
                    </label>
                `).join('');

                // 개별 체크박스 이벤트
                list.querySelectorAll('.platform-filter-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // 전체 선택 체크박스 상태 업데이트
                        const selectAllCheckbox = document.querySelector(`.platform-filter-select-all[data-filter="${filterKey}"]`);
                        if (selectAllCheckbox) {
                            const allCheckboxes = list.querySelectorAll('.platform-filter-item-checkbox');
                            const checkedCheckboxes = list.querySelectorAll('.platform-filter-item-checkbox:checked');
                            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                        }

                        updatePlatformFilters();
                        updatePlatformFilterButtonText(filterKey);
                    });
                });
            });

            // 드롭다운 버튼 클릭 이벤트
            document.querySelectorAll('.platform-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filterType = this.dataset.filter;
                    const dropdown = document.querySelector(`.platform-filter-dropdown-list[data-filter="${filterType}"]`);

                    // 다른 드롭다운 닫기
                    document.querySelectorAll('.platform-filter-dropdown-list').forEach(dd => {
                        if (dd !== dropdown) dd.style.display = 'none';
                    });

                    // 현재 드롭다운 토글
                    if (dropdown) {
                        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                    }
                });
            });

            // 전체 선택 체크박스 이벤트
            document.querySelectorAll('.platform-filter-select-all').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filterType = this.dataset.filter;
                    const list = document.getElementById(`platformFilter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}List`);
                    if (!list) return;

                    const itemCheckboxes = list.querySelectorAll('.platform-filter-item-checkbox');
                    itemCheckboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });

                    updatePlatformFilters();
                    updatePlatformFilterButtonText(filterType);
                });
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.platform-filter-dropdown-btn') && !e.target.closest('.platform-filter-dropdown-list')) {
                    document.querySelectorAll('.platform-filter-dropdown-list').forEach(dd => {
                        dd.style.display = 'none';
                    });
                }
            });

            // 기간 선택 초기값 설정 (전체 데이터의 최소/최대 날짜)
            const dates = dimensionData
                .map(row => row['일'])
                .filter(date => date && date !== '' && date !== '-')
                .map(date => new Date(date))
                .filter(date => !isNaN(date));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const startInput = document.getElementById('platformStartDate');
                const endInput = document.getElementById('platformEndDate');

                if (startInput && endInput) {
                    startInput.value = formatDateForInput(minDate);
                    endInput.value = formatDateForInput(maxDate);
                    platformStartDate = formatDateForInput(minDate);
                    platformEndDate = formatDateForInput(maxDate);
                }
            }

            // 초기 차트 렌더링 (필터 미선택 상태 메시지 표시)
            renderPlatformTrendChart();
        }

        function updatePlatformFilterButtonText(filterKey) {
            const filterMap = {
                'channel': '채널',
                'product': '제품',
                'brand': '브랜드',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const btn = document.querySelector(`.platform-filter-dropdown-btn[data-filter="${filterKey}"]`);
            const list = document.getElementById(`platformFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`);

            if (!btn || !list) return;

            const checkedBoxes = list.querySelectorAll('.platform-filter-item-checkbox:checked');
            const totalBoxes = list.querySelectorAll('.platform-filter-item-checkbox');
            const btnText = btn.querySelector('span:first-child');
            const countText = btn.querySelector('.platform-selected-count');

            if (checkedBoxes.length === 0) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = '';
            } else if (checkedBoxes.length === totalBoxes.length) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = `(${checkedBoxes.length})`;
            } else if (checkedBoxes.length === 1) {
                btnText.textContent = checkedBoxes[0].value;
                countText.textContent = '';
            } else {
                btnText.textContent = `${checkedBoxes[0].value} 외`;
                countText.textContent = `(${checkedBoxes.length})`;
            }
        }

        // 전역 필터 상태 저장
        let currentPlatformFilters = {
            channel: [],
            product: [],
            brand: [],
            promotion: [],
            adset: []
        };

        function updatePlatformFilters() {
            if (!platformDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'platformFilterChannelList' },
                'product': { column: '상품명', listId: 'platformFilterProductList' },
                'brand': { column: '브랜드명', listId: 'platformFilterBrandList' },
                'promotion': { column: '프로모션', listId: 'platformFilterPromotionList' },
                'adset': { column: '광고세트', listId: 'platformFilterAdsetList' }
            };

            // 선택된 필터 값 수집
            Object.keys(filterMap).forEach(filterKey => {
                const { listId } = filterMap[filterKey];
                const list = document.getElementById(listId);

                if (list) {
                    const checkedBoxes = list.querySelectorAll('.platform-filter-item-checkbox:checked');
                    currentPlatformFilters[filterKey] = Array.from(checkedBoxes).map(cb => cb.value);
                } else {
                    currentPlatformFilters[filterKey] = [];
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentPlatformFilters).every(arr => arr.length === 0);

            if (allFiltersEmpty) {
                // 모든 필터가 해제되면 필터 상태 초기화
                currentPlatformFilters = {
                    channel: [],
                    product: [],
                    brand: [],
                    promotion: [],
                    adset: []
                };
            }

            // 필터링된 플랫폼 데이터 계산
            updateFilteredPlatformCount(currentPlatformFilters);

            // 차트 업데이트
            renderPlatformTrendChart();
        }

        function updateFilteredPlatformCount(filters) {
            if (!platformDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const platformsToShow = new Set();

            platformDimensionData.forEach(row => {
                const platform = row['플랫폼'];
                if (!platform || platform === '' || platform === '-') return;

                let matchesAllFilters = true;

                // AND 연산으로 모든 필터 확인
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = filters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (matchesAllFilters) {
                    platformsToShow.add(platform);
                }
            });

            document.getElementById('filteredPlatformCount').textContent = platformsToShow.size;
        }

        // 차트 렌더링 함수들
        function renderTimeseriesTrendChart() {
            const canvas = document.getElementById('timeseriesTrendChart');
            if (!canvas) return;

            if (timeseriesTrendChart) {
                timeseriesTrendChart.destroy();
            }

            if (!adsetDimensionData) {
                const ctx = canvas.getContext('2d');
                timeseriesTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: '데이터 로딩 중...' }
                        }
                    }
                });
                return;
            }

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션'
            };

            // AND 연산으로 광고세트 찾기
            const adsetsToShow = new Set();

            // 필터가 하나도 선택되지 않은 경우 체크
            const hasActiveFilters = Object.values(timeseriesFilters).some(arr => arr.length > 0);

            adsetDimensionData.forEach(row => {
                const adset = row['광고세트'];
                if (!adset || adset === '' || adset === '-') return;

                let matchesAllFilters = true;

                // 각 필터 타입별로 AND 연산
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = timeseriesFilters[filterKey];

                    // 해당 필터가 활성화되어 있고 값이 선택된 경우
                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        // 선택된 값 중 하나라도 일치하지 않으면 제외
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (matchesAllFilters && row['일']) {
                    adsetsToShow.add(adset);
                }
            });

            if (adsetsToShow.size === 0 || !hasActiveFilters) {
                const ctx = canvas.getContext('2d');
                timeseriesTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: hasActiveFilters ? '필터 조건에 맞는 데이터가 없습니다' : '필터를 선택해주세요' }
                        }
                    }
                });
                return;
            }

            // 광고세트별 일별 데이터 집계
            const timeSeriesData = {};
            adsetsToShow.forEach(adset => {
                timeSeriesData[adset] = {};
            });

            adsetDimensionData.forEach(row => {
                const adset = row['광고세트'];
                if (!adsetsToShow.has(adset) || !row['일']) return;

                // AND 연산으로 필터 체크
                let matchesAllFilters = true;
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = timeseriesFilters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (!matchesAllFilters) return;

                const date = row['일'];

                // 기간 필터링
                if (timeseriesStartDate || timeseriesEndDate) {
                    const rowDate = new Date(date);
                    if (isNaN(rowDate)) return;
                    if (timeseriesStartDate && rowDate < new Date(timeseriesStartDate)) return;
                    if (timeseriesEndDate && rowDate > new Date(timeseriesEndDate)) return;
                }
                const cost = parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                const revenue = parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                const conversions = parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                const impressions = parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                const clicks = parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;

                if (!timeSeriesData[adset][date]) {
                    timeSeriesData[adset][date] = {
                        cost: 0,
                        revenue: 0,
                        conversions: 0,
                        impressions: 0,
                        clicks: 0
                    };
                }
                timeSeriesData[adset][date].cost += cost;
                timeSeriesData[adset][date].revenue += revenue;
                timeSeriesData[adset][date].conversions += conversions;
                timeSeriesData[adset][date].impressions += impressions;
                timeSeriesData[adset][date].clicks += clicks;
            });

            // 기간별 집계
            const aggregatedData = {};
            Array.from(adsetsToShow).forEach(adset => {
                aggregatedData[adset] = {};
            });

            Object.keys(timeSeriesData).forEach(adset => {
                Object.keys(timeSeriesData[adset]).forEach(date => {
                    const periodKey = getPeriodKey(date, currentTimeseriesPeriod);
                    if (!aggregatedData[adset][periodKey]) {
                        aggregatedData[adset][periodKey] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    aggregatedData[adset][periodKey].cost += timeSeriesData[adset][date].cost;
                    aggregatedData[adset][periodKey].revenue += timeSeriesData[adset][date].revenue;
                    aggregatedData[adset][periodKey].conversions += timeSeriesData[adset][date].conversions;
                    aggregatedData[adset][periodKey].impressions += timeSeriesData[adset][date].impressions;
                    aggregatedData[adset][periodKey].clicks += timeSeriesData[adset][date].clicks;
                });
            });

            // 선택된 지표에 따라 데이터 계산
            const metricData = {};
            Object.keys(aggregatedData).forEach(adset => {
                metricData[adset] = {};
                Object.keys(aggregatedData[adset]).forEach(period => {
                    const { cost, revenue, conversions, impressions, clicks } = aggregatedData[adset][period];

                    switch(currentTimeseriesMetric) {
                        case 'roas':
                            metricData[adset][period] = cost > 0 ? (revenue / cost * 100) : 0;
                            break;
                        case 'cost':
                            metricData[adset][period] = cost;
                            break;
                        case 'revenue':
                            metricData[adset][period] = revenue;
                            break;
                        case 'conversions':
                            metricData[adset][period] = conversions;
                            break;
                        case 'impressions':
                            metricData[adset][period] = impressions;
                            break;
                        case 'clicks':
                            metricData[adset][period] = clicks;
                            break;
                        case 'cpm':
                            metricData[adset][period] = impressions > 0 ? (cost / impressions * 1000) : 0;
                            break;
                        case 'cpc':
                            metricData[adset][period] = clicks > 0 ? (cost / clicks) : 0;
                            break;
                        case 'cpa':
                            metricData[adset][period] = conversions > 0 ? (cost / conversions) : 0;
                            break;
                        case 'ctr':
                            metricData[adset][period] = impressions > 0 ? (clicks / impressions * 100) : 0;
                            break;
                        case 'cvr':
                            metricData[adset][period] = clicks > 0 ? (conversions / clicks * 100) : 0;
                            break;
                        default:
                            metricData[adset][period] = 0;
                    }
                });
            });

            // 기간 정렬
            const allPeriods = [...new Set(Object.values(metricData).flatMap(data => Object.keys(data)))].sort();

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#4caf50', '#ff9800', '#f44336', '#e91e63', '#009688', '#795548', '#607d8b', '#3f51b5'];
            const adsetArray = Array.from(adsetsToShow).sort();
            const datasets = adsetArray.map((adset, index) => {
                return {
                    label: adset,
                    data: allPeriods.map(period => metricData[adset][period] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.3
                };
            });

            const ctx = canvas.getContext('2d');
            timeseriesTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allPeriods, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const adset = adsetArray[context.datasetIndex];
                                    const period = allPeriods[context.dataIndex];
                                    const data = aggregatedData[adset][period] || {};
                                    const { cost = 0, revenue = 0, conversions = 0, impressions = 0, clicks = 0 } = data;

                                    const roas = cost > 0 ? (revenue / cost * 100) : 0;
                                    const cpm = impressions > 0 ? (cost / impressions * 1000) : 0;
                                    const cpc = clicks > 0 ? (cost / clicks) : 0;
                                    const cpa = conversions > 0 ? (cost / conversions) : 0;
                                    const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
                                    const cvr = clicks > 0 ? (conversions / clicks * 100) : 0;

                                    const lines = [`${adset}`];

                                    switch(currentTimeseriesMetric) {
                                        case 'roas':
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`전환값: ${formatCurrency(revenue)}`);
                                            break;
                                        case 'cost':
                                            lines.push(`비용: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'revenue':
                                            lines.push(`전환값: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'conversions':
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`전환율: ${cvr.toFixed(2)}%`);
                                            break;
                                        case 'impressions':
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'clicks':
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'cpm':
                                            lines.push(`CPM: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cpc':
                                            lines.push(`CPC: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                        case 'cpa':
                                            lines.push(`CPA: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            break;
                                        case 'ctr':
                                            lines.push(`CTR: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cvr':
                                            lines.push(`전환율: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (function() {
                                    switch(currentTimeseriesMetric) {
                                        case 'roas': return 'ROAS (%)';
                                        case 'cost': return '비용 (원)';
                                        case 'revenue': return '전환값 (원)';
                                        case 'conversions': return '전환수 (건)';
                                        case 'impressions': return '노출수 (회)';
                                        case 'clicks': return '클릭수 (회)';
                                        case 'cpm': return 'CPM (원)';
                                        case 'cpc': return 'CPC (원)';
                                        case 'cpa': return 'CPA (원)';
                                        case 'ctr': return 'CTR (%)';
                                        case 'cvr': return '전환율 (%)';
                                        default: return '지표';
                                    }
                                })()
                            },
                            ticks: {
                                callback: function(value) {
                                    switch(currentTimeseriesMetric) {
                                        case 'roas':
                                        case 'ctr':
                                        case 'cvr':
                                            return value.toFixed(1) + '%';
                                        case 'cost':
                                        case 'revenue':
                                        case 'cpm':
                                        case 'cpc':
                                        case 'cpa':
                                            return formatCurrency(value);
                                        case 'conversions':
                                        case 'impressions':
                                        case 'clicks':
                                            return value.toLocaleString();
                                        default:
                                            return value;
                                    }
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: '기간' }
                        }
                    }
                }
            });
        }

        function renderGenderTrendChart() {
            const canvas = document.getElementById('genderTrendChart');
            if (!canvas) return;

            if (genderTrendChart) {
                genderTrendChart.destroy();
            }

            if (!genderDimensionData) {
                const ctx = canvas.getContext('2d');
                genderTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: '데이터 로딩 중...' }
                        }
                    }
                });
                return;
            }

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            // 필터 조건을 만족하는 행만 필터링하는 헬퍼 함수
            const rowMatchesFilters = (row) => {
                // 모든 필터가 비어있는지 확인
                const allFiltersEmpty = Object.values(currentGenderFilters).every(arr => !arr || arr.length === 0);

                // 모든 필터가 비어있으면 false 반환 (데이터 표시 안 함)
                if (allFiltersEmpty) {
                    return false;
                }

                // 모든 필터를 AND 조건으로 확인
                for (const filterKey of Object.keys(filterMap)) {
                    const column = filterMap[filterKey];
                    const selectedValues = currentGenderFilters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            return false;
                        }
                    }
                }
                return true;
            };

            // 성별 목록 가져오기 (성별_통합 컬럼 우선 사용)
            const gendersToShow = new Set();
            genderDimensionData.forEach(row => {
                if (rowMatchesFilters(row)) {
                    const rawGender = row['성별_통합'] || row['성별'];
                    const normalizedGender = normalizeGender(rawGender);
                    if (normalizedGender) {
                        gendersToShow.add(normalizedGender);
                    }
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentGenderFilters).every(arr => !arr || arr.length === 0);

            if (allFiltersEmpty || gendersToShow.size === 0) {
                const ctx = canvas.getContext('2d');
                genderTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: allFiltersEmpty ? '필터를 선택해주세요' : '필터 조건에 맞는 데이터가 없습니다' }
                        }
                    }
                });
                return;
            }

            // 성별별 일별 데이터 집계
            const timeSeriesData = {};
            gendersToShow.forEach(gender => {
                timeSeriesData[gender] = {};
            });

            genderDimensionData.forEach(row => {
                if (!rowMatchesFilters(row)) return;

                // 성별_통합 컬럼 우선 사용
                const rawGender = row['성별_통합'] || row['성별'];
                const normalizedGender = normalizeGender(rawGender);

                if (normalizedGender && gendersToShow.has(normalizedGender) && row['일']) {
                    const date = row['일'];

                    // 기간 필터링
                    if (genderStartDate || genderEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (genderStartDate && rowDate < new Date(genderStartDate)) return;
                        if (genderEndDate && rowDate > new Date(genderEndDate)) return;
                    }

                    const cost = parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                    const revenue = parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                    const conversions = parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                    const impressions = parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                    const clicks = parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;

                    if (!timeSeriesData[normalizedGender][date]) {
                        timeSeriesData[normalizedGender][date] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    timeSeriesData[normalizedGender][date].cost += cost;
                    timeSeriesData[normalizedGender][date].revenue += revenue;
                    timeSeriesData[normalizedGender][date].conversions += conversions;
                    timeSeriesData[normalizedGender][date].impressions += impressions;
                    timeSeriesData[normalizedGender][date].clicks += clicks;
                }
            });

            // 기간별 집계
            const aggregatedData = {};
            gendersToShow.forEach(gender => {
                aggregatedData[gender] = {};
            });

            Object.keys(timeSeriesData).forEach(gender => {
                Object.keys(timeSeriesData[gender]).forEach(date => {
                    const periodKey = getPeriodKey(date, currentGenderPeriod);
                    if (!aggregatedData[gender][periodKey]) {
                        aggregatedData[gender][periodKey] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    aggregatedData[gender][periodKey].cost += timeSeriesData[gender][date].cost;
                    aggregatedData[gender][periodKey].revenue += timeSeriesData[gender][date].revenue;
                    aggregatedData[gender][periodKey].conversions += timeSeriesData[gender][date].conversions;
                    aggregatedData[gender][periodKey].impressions += timeSeriesData[gender][date].impressions;
                    aggregatedData[gender][periodKey].clicks += timeSeriesData[gender][date].clicks;
                });
            });

            // 선택된 지표에 따라 데이터 계산
            const metricData = {};
            Object.keys(aggregatedData).forEach(gender => {
                metricData[gender] = {};
                Object.keys(aggregatedData[gender]).forEach(period => {
                    const { cost, revenue, conversions, impressions, clicks } = aggregatedData[gender][period];

                    switch(currentGenderMetric) {
                        case 'roas':
                            metricData[gender][period] = cost > 0 ? (revenue / cost * 100) : 0;
                            break;
                        case 'cost':
                            metricData[gender][period] = cost;
                            break;
                        case 'revenue':
                            metricData[gender][period] = revenue;
                            break;
                        case 'conversions':
                            metricData[gender][period] = conversions;
                            break;
                        case 'impressions':
                            metricData[gender][period] = impressions;
                            break;
                        case 'clicks':
                            metricData[gender][period] = clicks;
                            break;
                        case 'cpm':
                            metricData[gender][period] = impressions > 0 ? (cost / impressions * 1000) : 0;
                            break;
                        case 'cpc':
                            metricData[gender][period] = clicks > 0 ? (cost / clicks) : 0;
                            break;
                        case 'cpa':
                            metricData[gender][period] = conversions > 0 ? (cost / conversions) : 0;
                            break;
                        case 'ctr':
                            metricData[gender][period] = impressions > 0 ? (clicks / impressions * 100) : 0;
                            break;
                        case 'cvr':
                            metricData[gender][period] = clicks > 0 ? (conversions / clicks * 100) : 0;
                            break;
                        default:
                            metricData[gender][period] = 0;
                    }
                });
            });

            // 기간 정렬
            const allPeriods = [...new Set(Object.values(metricData).flatMap(data => Object.keys(data)))].sort();

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#4caf50', '#ff9800', '#f44336'];
            const genderArray = Array.from(gendersToShow).sort();
            const datasets = genderArray.map((gender, index) => {
                return {
                    label: getGenderDisplayName(gender),
                    data: allPeriods.map(period => metricData[gender][period] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.3
                };
            });

            const ctx = canvas.getContext('2d');
            genderTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allPeriods, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const gender = genderArray[context.datasetIndex];
                                    const period = allPeriods[context.dataIndex];
                                    const data = aggregatedData[gender][period] || {};
                                    const { cost = 0, revenue = 0, conversions = 0, impressions = 0, clicks = 0 } = data;

                                    const roas = cost > 0 ? (revenue / cost * 100) : 0;
                                    const cpm = impressions > 0 ? (cost / impressions * 1000) : 0;
                                    const cpc = clicks > 0 ? (cost / clicks) : 0;
                                    const cpa = conversions > 0 ? (cost / conversions) : 0;
                                    const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
                                    const cvr = clicks > 0 ? (conversions / clicks * 100) : 0;

                                    const lines = [`${getGenderDisplayName(gender)}`];

                                    switch(currentGenderMetric) {
                                        case 'roas':
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`전환값: ${formatCurrency(revenue)}`);
                                            break;
                                        case 'cost':
                                            lines.push(`비용: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'revenue':
                                            lines.push(`전환값: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'conversions':
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`전환율: ${cvr.toFixed(2)}%`);
                                            break;
                                        case 'impressions':
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'clicks':
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'cpm':
                                            lines.push(`CPM: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cpc':
                                            lines.push(`CPC: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                        case 'cpa':
                                            lines.push(`CPA: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            break;
                                        case 'ctr':
                                            lines.push(`CTR: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cvr':
                                            lines.push(`전환율: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (function() {
                                    switch(currentGenderMetric) {
                                        case 'roas': return 'ROAS (%)';
                                        case 'cost': return '비용 (원)';
                                        case 'revenue': return '전환값 (원)';
                                        case 'conversions': return '전환수 (건)';
                                        case 'impressions': return '노출수 (회)';
                                        case 'clicks': return '클릭수 (회)';
                                        case 'cpm': return 'CPM (원)';
                                        case 'cpc': return 'CPC (원)';
                                        case 'cpa': return 'CPA (원)';
                                        case 'ctr': return 'CTR (%)';
                                        case 'cvr': return '전환율 (%)';
                                        default: return '지표';
                                    }
                                })()
                            },
                            ticks: {
                                callback: function(value) {
                                    switch(currentGenderMetric) {
                                        case 'roas':
                                        case 'ctr':
                                        case 'cvr':
                                            return value.toFixed(1) + '%';
                                        case 'cost':
                                        case 'revenue':
                                        case 'cpm':
                                        case 'cpc':
                                        case 'cpa':
                                            return formatCurrency(value);
                                        case 'conversions':
                                        case 'impressions':
                                        case 'clicks':
                                            return value.toLocaleString();
                                        default:
                                            return value;
                                    }
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: '기간' }
                        }
                    }
                }
            });
        }

        function renderAgeTrendChart() {
            const canvas = document.getElementById('ageTrendChart');
            if (!canvas) return;

            if (ageTrendChart) {
                ageTrendChart.destroy();
            }

            if (!ageDimensionData) {
                const ctx = canvas.getContext('2d');
                ageTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: '데이터 로딩 중...' }
                        }
                    }
                });
                return;
            }

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            // 필터 조건을 만족하는 행만 필터링하는 헬퍼 함수
            const rowMatchesFilters = (row) => {
                // 모든 필터가 비어있는지 확인
                const allFiltersEmpty = Object.values(currentAgeFilters).every(arr => !arr || arr.length === 0);

                // 모든 필터가 비어있으면 false 반환 (데이터 표시 안 함)
                if (allFiltersEmpty) {
                    return false;
                }

                // 모든 필터를 AND 조건으로 확인
                for (const filterKey of Object.keys(filterMap)) {
                    const column = filterMap[filterKey];
                    const selectedValues = currentAgeFilters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            return false;
                        }
                    }
                }
                return true;
            };

            // 연령 목록 가져오기
            const agesToShow = new Set();
            ageDimensionData.forEach(row => {
                if (rowMatchesFilters(row)) {
                    const age = row['연령_통합'] || row['연령'];
                    if (age && age !== '' && age !== '-') {
                        agesToShow.add(age);
                    }
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentAgeFilters).every(arr => !arr || arr.length === 0);

            if (allFiltersEmpty || agesToShow.size === 0) {
                const ctx = canvas.getContext('2d');
                ageTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: allFiltersEmpty ? '필터를 선택해주세요' : '필터 조건에 맞는 데이터가 없습니다' }
                        }
                    }
                });
                return;
            }

            // 연령대별 일별 데이터 집계
            const timeSeriesData = {};
            agesToShow.forEach(age => {
                timeSeriesData[age] = {};
            });

            ageDimensionData.forEach(row => {
                if (!rowMatchesFilters(row)) return;

                const age = row['연령_통합'] || row['연령'];

                if (agesToShow.has(age) && row['일']) {
                    const date = row['일'];

                    // 기간 필터링
                    if (ageStartDate || ageEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (ageStartDate && rowDate < new Date(ageStartDate)) return;
                        if (ageEndDate && rowDate > new Date(ageEndDate)) return;
                    }

                    const cost = parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                    const revenue = parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                    const conversions = parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                    const impressions = parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                    const clicks = parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;

                    if (!timeSeriesData[age][date]) {
                        timeSeriesData[age][date] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    timeSeriesData[age][date].cost += cost;
                    timeSeriesData[age][date].revenue += revenue;
                    timeSeriesData[age][date].conversions += conversions;
                    timeSeriesData[age][date].impressions += impressions;
                    timeSeriesData[age][date].clicks += clicks;
                }
            });

            // 기간별 집계
            const aggregatedData = {};
            agesToShow.forEach(age => {
                aggregatedData[age] = {};
            });

            Object.keys(timeSeriesData).forEach(age => {
                Object.keys(timeSeriesData[age]).forEach(date => {
                    const periodKey = getPeriodKey(date, currentAgePeriod);
                    if (!aggregatedData[age][periodKey]) {
                        aggregatedData[age][periodKey] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    aggregatedData[age][periodKey].cost += timeSeriesData[age][date].cost;
                    aggregatedData[age][periodKey].revenue += timeSeriesData[age][date].revenue;
                    aggregatedData[age][periodKey].conversions += timeSeriesData[age][date].conversions;
                    aggregatedData[age][periodKey].impressions += timeSeriesData[age][date].impressions;
                    aggregatedData[age][periodKey].clicks += timeSeriesData[age][date].clicks;
                });
            });

            // 선택된 지표에 따라 데이터 계산
            const metricData = {};
            Object.keys(aggregatedData).forEach(age => {
                metricData[age] = {};
                Object.keys(aggregatedData[age]).forEach(period => {
                    const { cost, revenue, conversions, impressions, clicks } = aggregatedData[age][period];

                    switch(currentAgeMetric) {
                        case 'roas':
                            metricData[age][period] = cost > 0 ? (revenue / cost * 100) : 0;
                            break;
                        case 'cost':
                            metricData[age][period] = cost;
                            break;
                        case 'revenue':
                            metricData[age][period] = revenue;
                            break;
                        case 'conversions':
                            metricData[age][period] = conversions;
                            break;
                        case 'impressions':
                            metricData[age][period] = impressions;
                            break;
                        case 'clicks':
                            metricData[age][period] = clicks;
                            break;
                        case 'cpm':
                            metricData[age][period] = impressions > 0 ? (cost / impressions * 1000) : 0;
                            break;
                        case 'cpc':
                            metricData[age][period] = clicks > 0 ? (cost / clicks) : 0;
                            break;
                        case 'cpa':
                            metricData[age][period] = conversions > 0 ? (cost / conversions) : 0;
                            break;
                        case 'ctr':
                            metricData[age][period] = impressions > 0 ? (clicks / impressions * 100) : 0;
                            break;
                        case 'cvr':
                            metricData[age][period] = clicks > 0 ? (conversions / clicks * 100) : 0;
                            break;
                        default:
                            metricData[age][period] = 0;
                    }
                });
            });

            // 기간 정렬
            const allPeriods = [...new Set(Object.values(metricData).flatMap(data => Object.keys(data)))].sort();

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#4caf50', '#ff9800', '#f44336'];
            const ageArray = Array.from(agesToShow).sort();
            const datasets = ageArray.map((age, index) => {
                return {
                    label: age,
                    data: allPeriods.map(period => metricData[age][period] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.3
                };
            });

            const ctx = canvas.getContext('2d');
            ageTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allPeriods, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const age = ageArray[context.datasetIndex];
                                    const period = allPeriods[context.dataIndex];
                                    const data = aggregatedData[age][period] || {};
                                    const { cost = 0, revenue = 0, conversions = 0, impressions = 0, clicks = 0 } = data;

                                    const roas = cost > 0 ? (revenue / cost * 100) : 0;
                                    const cpm = impressions > 0 ? (cost / impressions * 1000) : 0;
                                    const cpc = clicks > 0 ? (cost / clicks) : 0;
                                    const cpa = conversions > 0 ? (cost / conversions) : 0;
                                    const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
                                    const cvr = clicks > 0 ? (conversions / clicks * 100) : 0;

                                    const lines = [`${age}`];

                                    switch(currentAgeMetric) {
                                        case 'roas':
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`전환값: ${formatCurrency(revenue)}`);
                                            break;
                                        case 'cost':
                                            lines.push(`비용: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'revenue':
                                            lines.push(`전환값: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'conversions':
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`전환율: ${cvr.toFixed(2)}%`);
                                            break;
                                        case 'impressions':
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'clicks':
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'cpm':
                                            lines.push(`CPM: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cpc':
                                            lines.push(`CPC: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                        case 'cpa':
                                            lines.push(`CPA: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            break;
                                        case 'ctr':
                                            lines.push(`CTR: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cvr':
                                            lines.push(`전환율: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (function() {
                                    switch(currentAgeMetric) {
                                        case 'roas': return 'ROAS (%)';
                                        case 'cost': return '비용 (원)';
                                        case 'revenue': return '전환값 (원)';
                                        case 'conversions': return '전환수 (건)';
                                        case 'impressions': return '노출수 (회)';
                                        case 'clicks': return '클릭수 (회)';
                                        case 'cpm': return 'CPM (원)';
                                        case 'cpc': return 'CPC (원)';
                                        case 'cpa': return 'CPA (원)';
                                        case 'ctr': return 'CTR (%)';
                                        case 'cvr': return '전환율 (%)';
                                        default: return '지표';
                                    }
                                })()
                            },
                            ticks: {
                                callback: function(value) {
                                    switch(currentAgeMetric) {
                                        case 'roas':
                                        case 'ctr':
                                        case 'cvr':
                                            return value.toFixed(1) + '%';
                                        case 'cost':
                                        case 'revenue':
                                        case 'cpm':
                                        case 'cpc':
                                        case 'cpa':
                                            return formatCurrency(value);
                                        case 'conversions':
                                        case 'impressions':
                                        case 'clicks':
                                            return value.toLocaleString();
                                        default:
                                            return value;
                                    }
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: '기간' }
                        }
                    }
                }
            });
        }

        function renderPlatformTrendChart() {
            const canvas = document.getElementById('platformTrendChart');
            if (!canvas) return;

            if (platformTrendChart) {
                platformTrendChart.destroy();
            }

            if (!platformDimensionData) {
                const ctx = canvas.getContext('2d');
                platformTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: '데이터 로딩 중...' }
                        }
                    }
                });
                return;
            }

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            // 필터 조건을 만족하는 행만 필터링하는 헬퍼 함수
            const rowMatchesFilters = (row) => {
                // 모든 필터가 비어있는지 확인
                const allFiltersEmpty = Object.values(currentPlatformFilters).every(arr => !arr || arr.length === 0);

                // 모든 필터가 비어있으면 false 반환 (데이터 표시 안 함)
                if (allFiltersEmpty) {
                    return false;
                }

                // 모든 필터를 AND 조건으로 확인
                for (const filterKey of Object.keys(filterMap)) {
                    const column = filterMap[filterKey];
                    const selectedValues = currentPlatformFilters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            return false;
                        }
                    }
                }
                return true;
            };

            // 플랫폼 목록 가져오기
            const platformsToShow = new Set();
            platformDimensionData.forEach(row => {
                if (rowMatchesFilters(row)) {
                    const platform = row['플랫폼'];
                    if (platform && platform !== '' && platform !== '-') {
                        platformsToShow.add(platform);
                    }
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentPlatformFilters).every(arr => !arr || arr.length === 0);

            if (allFiltersEmpty || platformsToShow.size === 0) {
                const ctx = canvas.getContext('2d');
                platformTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: allFiltersEmpty ? '필터를 선택해주세요' : '필터 조건에 맞는 데이터가 없습니다' }
                        }
                    }
                });
                return;
            }

            // 플랫폼별 일별 데이터 집계
            const timeSeriesData = {};
            platformsToShow.forEach(platform => {
                timeSeriesData[platform] = {};
            });

            platformDimensionData.forEach(row => {
                if (!rowMatchesFilters(row)) return;

                const platform = row['플랫폼'];
                if (platformsToShow.has(platform) && row['일']) {
                    const date = row['일'];

                    // 기간 필터링
                    if (platformStartDate || platformEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (platformStartDate && rowDate < new Date(platformStartDate)) return;
                        if (platformEndDate && rowDate > new Date(platformEndDate)) return;
                    }

                    const cost = parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                    const revenue = parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                    const conversions = parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                    const impressions = parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                    const clicks = parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;

                    if (!timeSeriesData[platform][date]) {
                        timeSeriesData[platform][date] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    timeSeriesData[platform][date].cost += cost;
                    timeSeriesData[platform][date].revenue += revenue;
                    timeSeriesData[platform][date].conversions += conversions;
                    timeSeriesData[platform][date].impressions += impressions;
                    timeSeriesData[platform][date].clicks += clicks;
                }
            });

            // 기간별 집계
            const aggregatedData = {};
            platformsToShow.forEach(platform => {
                aggregatedData[platform] = {};
            });

            Object.keys(timeSeriesData).forEach(platform => {
                Object.keys(timeSeriesData[platform]).forEach(date => {
                    const periodKey = getPeriodKey(date, currentPlatformPeriod);
                    if (!aggregatedData[platform][periodKey]) {
                        aggregatedData[platform][periodKey] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    aggregatedData[platform][periodKey].cost += timeSeriesData[platform][date].cost;
                    aggregatedData[platform][periodKey].revenue += timeSeriesData[platform][date].revenue;
                    aggregatedData[platform][periodKey].conversions += timeSeriesData[platform][date].conversions;
                    aggregatedData[platform][periodKey].impressions += timeSeriesData[platform][date].impressions;
                    aggregatedData[platform][periodKey].clicks += timeSeriesData[platform][date].clicks;
                });
            });

            // 선택된 지표에 따라 데이터 계산
            const metricData = {};
            Object.keys(aggregatedData).forEach(platform => {
                metricData[platform] = {};
                Object.keys(aggregatedData[platform]).forEach(period => {
                    const { cost, revenue, conversions, impressions, clicks } = aggregatedData[platform][period];

                    switch(currentPlatformMetric) {
                        case 'roas':
                            metricData[platform][period] = cost > 0 ? (revenue / cost * 100) : 0;
                            break;
                        case 'cost':
                            metricData[platform][period] = cost;
                            break;
                        case 'revenue':
                            metricData[platform][period] = revenue;
                            break;
                        case 'conversions':
                            metricData[platform][period] = conversions;
                            break;
                        case 'impressions':
                            metricData[platform][period] = impressions;
                            break;
                        case 'clicks':
                            metricData[platform][period] = clicks;
                            break;
                        case 'cpm':
                            metricData[platform][period] = impressions > 0 ? (cost / impressions * 1000) : 0;
                            break;
                        case 'cpc':
                            metricData[platform][period] = clicks > 0 ? (cost / clicks) : 0;
                            break;
                        case 'cpa':
                            metricData[platform][period] = conversions > 0 ? (cost / conversions) : 0;
                            break;
                        case 'ctr':
                            metricData[platform][period] = impressions > 0 ? (clicks / impressions * 100) : 0;
                            break;
                        case 'cvr':
                            metricData[platform][period] = clicks > 0 ? (conversions / clicks * 100) : 0;
                            break;
                        default:
                            metricData[platform][period] = 0;
                    }
                });
            });

            // 기간 정렬
            const allPeriods = [...new Set(Object.values(metricData).flatMap(data => Object.keys(data)))].sort();

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#4caf50', '#ff9800', '#f44336'];
            const platformArray = Array.from(platformsToShow).sort();
            const datasets = platformArray.map((platform, index) => {
                return {
                    label: platform,
                    data: allPeriods.map(period => metricData[platform][period] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.3
                };
            });

            const ctx = canvas.getContext('2d');
            platformTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allPeriods, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const platform = platformArray[context.datasetIndex];
                                    const period = allPeriods[context.dataIndex];
                                    const data = aggregatedData[platform][period] || {};
                                    const { cost = 0, revenue = 0, conversions = 0, impressions = 0, clicks = 0 } = data;

                                    const roas = cost > 0 ? (revenue / cost * 100) : 0;
                                    const cpm = impressions > 0 ? (cost / impressions * 1000) : 0;
                                    const cpc = clicks > 0 ? (cost / clicks) : 0;
                                    const cpa = conversions > 0 ? (cost / conversions) : 0;
                                    const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
                                    const cvr = clicks > 0 ? (conversions / clicks * 100) : 0;

                                    const lines = [`${platform}`];

                                    switch(currentPlatformMetric) {
                                        case 'roas':
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`전환값: ${formatCurrency(revenue)}`);
                                            break;
                                        case 'cost':
                                            lines.push(`비용: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'revenue':
                                            lines.push(`전환값: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'conversions':
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`전환율: ${cvr.toFixed(2)}%`);
                                            break;
                                        case 'impressions':
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'clicks':
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'cpm':
                                            lines.push(`CPM: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cpc':
                                            lines.push(`CPC: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                        case 'cpa':
                                            lines.push(`CPA: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            break;
                                        case 'ctr':
                                            lines.push(`CTR: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cvr':
                                            lines.push(`전환율: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (function() {
                                    switch(currentPlatformMetric) {
                                        case 'roas': return 'ROAS (%)';
                                        case 'cost': return '비용 (원)';
                                        case 'revenue': return '전환값 (원)';
                                        case 'conversions': return '전환수 (건)';
                                        case 'impressions': return '노출수 (회)';
                                        case 'clicks': return '클릭수 (회)';
                                        case 'cpm': return 'CPM (원)';
                                        case 'cpc': return 'CPC (원)';
                                        case 'cpa': return 'CPA (원)';
                                        case 'ctr': return 'CTR (%)';
                                        case 'cvr': return '전환율 (%)';
                                        default: return '지표';
                                    }
                                })()
                            },
                            ticks: {
                                callback: function(value) {
                                    switch(currentPlatformMetric) {
                                        case 'roas':
                                        case 'ctr':
                                        case 'cvr':
                                            return value.toFixed(1) + '%';
                                        case 'cost':
                                        case 'revenue':
                                        case 'cpm':
                                        case 'cpc':
                                        case 'cpa':
                                            return formatCurrency(value);
                                        case 'conversions':
                                        case 'impressions':
                                        case 'clicks':
                                            return value.toLocaleString();
                                        default:
                                            return value;
                                    }
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: '기간' }
                        }
                    }
                }
            });
        }

        // 기기플랫폼 드롭다운 초기화
        let devicePlatformDropdownsInitialized = false;

        function initDevicePlatformDropdowns() {
            if (!devicePlatformDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'deviceplatformFilterChannelList', label: '채널' },
                'product': { column: '상품명', listId: 'deviceplatformFilterProductList', label: '제품' },
                'brand': { column: '브랜드명', listId: 'deviceplatformFilterBrandList', label: '브랜드' },
                'promotion': { column: '프로모션', listId: 'deviceplatformFilterPromotionList', label: '프로모션' },
                'adset': { column: '광고세트', listId: 'deviceplatformFilterAdsetList', label: '광고세트' }
            };

            // 각 필터에 대한 체크박스 리스트 생성
            Object.keys(filterMap).forEach(filterKey => {
                const { column, listId } = filterMap[filterKey];
                const list = document.getElementById(listId);
                if (!list) return;

                const items = [...new Set(devicePlatformDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                items.sort();

                list.innerHTML = items.map(item => `
                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--grey-100)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" class="device-platform-filter-item-checkbox" data-filter="${filterKey}" value="${item}" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                        ${item}
                    </label>
                `).join('');

                // 개별 체크박스 이벤트
                list.querySelectorAll('.device-platform-filter-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // 전체 선택 체크박스 상태 업데이트
                        const selectAllCheckbox = document.querySelector(`.deviceplatform-filter-select-all[data-filter="${filterKey}"]`);
                        if (selectAllCheckbox) {
                            const allCheckboxes = list.querySelectorAll('.device-platform-filter-item-checkbox');
                            const checkedCheckboxes = list.querySelectorAll('.device-platform-filter-item-checkbox:checked');
                            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                        }

                        updateDevicePlatformFilters();
                        updateDevicePlatformFilterButtonText(filterKey);
                    });
                });
            });

            // 이벤트 리스너는 한 번만 등록
            if (!devicePlatformDropdownsInitialized) {
                // 드롭다운 버튼 클릭 이벤트
                document.querySelectorAll('.deviceplatform-filter-dropdown-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const filterType = this.dataset.filter;
                        const dropdown = document.querySelector(`.deviceplatform-filter-dropdown-list[data-filter="${filterType}"]`);

                        // 다른 드롭다운 닫기
                        document.querySelectorAll('.deviceplatform-filter-dropdown-list').forEach(dd => {
                            if (dd !== dropdown) dd.style.display = 'none';
                        });

                        // 현재 드롭다운 토글
                        if (dropdown) {
                            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                        }
                    });
                });

                // 전체 선택 체크박스 이벤트
                document.querySelectorAll('.deviceplatform-filter-select-all').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const filterType = this.dataset.filter;
                        const list = document.getElementById(`deviceplatformFilter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}List`);
                        if (!list) return;

                        const itemCheckboxes = list.querySelectorAll('.device-platform-filter-item-checkbox');
                        itemCheckboxes.forEach(cb => {
                            cb.checked = this.checked;
                        });

                        updateDevicePlatformFilters();
                        updateDevicePlatformFilterButtonText(filterType);
                    });
                });

                devicePlatformDropdownsInitialized = true;
            }

            // 기간 선택 초기값 설정 (전체 데이터의 최소/최대 날짜)
            const dates = dimensionData
                .map(row => row['일'])
                .filter(date => date && date !== '' && date !== '-')
                .map(date => new Date(date))
                .filter(date => !isNaN(date));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const startInput = document.getElementById('devicePlatformStartDate');
                const endInput = document.getElementById('devicePlatformEndDate');

                if (startInput && endInput) {
                    startInput.value = formatDateForInput(minDate);
                    endInput.value = formatDateForInput(maxDate);
                    devicePlatformStartDate = formatDateForInput(minDate);
                    devicePlatformEndDate = formatDateForInput(maxDate);
                }
            }

            // 초기 차트 렌더링 (필터 미선택 상태 메시지 표시)
            updateDevicePlatformFilters();
            renderDevicePlatformTrendChart();
        }

        function updateDevicePlatformFilterButtonText(filterKey) {
            const filterMap = {
                'channel': '채널',
                'product': '제품',
                'brand': '브랜드',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const btn = document.querySelector(`.deviceplatform-filter-dropdown-btn[data-filter="${filterKey}"]`);
            const list = document.getElementById(`deviceplatformFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`);

            if (!btn || !list) return;

            const checkedBoxes = list.querySelectorAll('.device-platform-filter-item-checkbox:checked');
            const totalBoxes = list.querySelectorAll('.device-platform-filter-item-checkbox');
            const btnText = btn.querySelector('span:first-child');
            const countText = btn.querySelector('.deviceplatform-selected-count');

            if (checkedBoxes.length === 0) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = '';
            } else if (checkedBoxes.length === totalBoxes.length) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = `(${checkedBoxes.length})`;
            } else if (checkedBoxes.length === 1) {
                btnText.textContent = checkedBoxes[0].value;
                countText.textContent = '';
            } else {
                btnText.textContent = `${checkedBoxes[0].value} 외`;
                countText.textContent = `(${checkedBoxes.length})`;
            }
        }

        // 전역 필터 상태 저장
        let currentDevicePlatformFilters = {
            channel: [],
            product: [],
            brand: [],
            promotion: [],
            adset: []
        };

        function updateDevicePlatformFilters() {
            if (!devicePlatformDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'deviceplatformFilterChannelList' },
                'product': { column: '상품명', listId: 'deviceplatformFilterProductList' },
                'brand': { column: '브랜드명', listId: 'deviceplatformFilterBrandList' },
                'promotion': { column: '프로모션', listId: 'deviceplatformFilterPromotionList' },
                'adset': { column: '광고세트', listId: 'deviceplatformFilterAdsetList' }
            };

            // 선택된 필터 값 수집
            Object.keys(filterMap).forEach(filterKey => {
                const { listId } = filterMap[filterKey];
                const list = document.getElementById(listId);

                if (list) {
                    const checkedBoxes = list.querySelectorAll('.device-platform-filter-item-checkbox:checked');
                    currentDevicePlatformFilters[filterKey] = Array.from(checkedBoxes).map(cb => cb.value);
                } else {
                    currentDevicePlatformFilters[filterKey] = [];
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentDevicePlatformFilters).every(arr => arr.length === 0);

            if (allFiltersEmpty) {
                // 모든 필터가 해제되면 필터 상태 초기화
                currentDevicePlatformFilters = {
                    channel: [],
                    product: [],
                    brand: [],
                    promotion: [],
                    adset: []
                };
            }

            // 필터링된 기기플랫폼 데이터 계산
            updateFilteredDevicePlatformCount(currentDevicePlatformFilters);

            // 차트 업데이트
            renderDevicePlatformTrendChart();
        }

        function updateFilteredDevicePlatformCount(filters) {
            if (!devicePlatformDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const devicePlatformsToShow = new Set();

            devicePlatformDimensionData.forEach(row => {
                const devicePlatform = row['기기플랫폼'];
                if (!devicePlatform || devicePlatform === '' || devicePlatform === '-') return;

                let matchesAllFilters = true;

                // AND 연산으로 모든 필터 확인
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = filters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (matchesAllFilters) {
                    devicePlatformsToShow.add(devicePlatform);
                }
            });

            document.getElementById('filteredDevicePlatformCount').textContent = devicePlatformsToShow.size;
        }

        // 기기유형 드롭다운 초기화
        let deviceTypeDropdownsInitialized = false;

        function initDeviceTypeDropdowns() {
            if (!deviceTypeDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'devicetypeFilterChannelList', label: '채널' },
                'product': { column: '상품명', listId: 'devicetypeFilterProductList', label: '제품' },
                'brand': { column: '브랜드명', listId: 'devicetypeFilterBrandList', label: '브랜드' },
                'promotion': { column: '프로모션', listId: 'devicetypeFilterPromotionList', label: '프로모션' },
                'adset': { column: '광고세트', listId: 'devicetypeFilterAdsetList', label: '광고세트' }
            };

            // 각 필터에 대한 체크박스 리스트 생성
            Object.keys(filterMap).forEach(filterKey => {
                const { column, listId } = filterMap[filterKey];
                const list = document.getElementById(listId);
                if (!list) return;

                const items = [...new Set(deviceTypeDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                items.sort();

                list.innerHTML = items.map(item => `
                    <label style="display: flex; align-items: center; padding: 8px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='var(--grey-100)'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" class="device-type-filter-item-checkbox" data-filter="${filterKey}" value="${item}" style="margin-right: 10px; width: 16px; height: 16px; cursor: pointer;">
                        ${item}
                    </label>
                `).join('');

                // 개별 체크박스 이벤트
                list.querySelectorAll('.device-type-filter-item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        // 전체 선택 체크박스 상태 업데이트
                        const selectAllCheckbox = document.querySelector(`.devicetype-filter-select-all[data-filter="${filterKey}"]`);
                        if (selectAllCheckbox) {
                            const allCheckboxes = list.querySelectorAll('.device-type-filter-item-checkbox');
                            const checkedCheckboxes = list.querySelectorAll('.device-type-filter-item-checkbox:checked');
                            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
                        }

                        updateDeviceTypeFilters();
                        updateDeviceTypeFilterButtonText(filterKey);
                    });
                });
            });

            // 이벤트 리스너는 한 번만 등록
            if (!deviceTypeDropdownsInitialized) {
                // 드롭다운 버튼 클릭 이벤트
                document.querySelectorAll('.devicetype-filter-dropdown-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const filterType = this.dataset.filter;
                        const dropdown = document.querySelector(`.devicetype-filter-dropdown-list[data-filter="${filterType}"]`);

                        // 다른 드롭다운 닫기
                        document.querySelectorAll('.devicetype-filter-dropdown-list').forEach(dd => {
                            if (dd !== dropdown) dd.style.display = 'none';
                        });

                        // 현재 드롭다운 토글
                        if (dropdown) {
                            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                        }
                    });
                });

                // 전체 선택 체크박스 이벤트
                document.querySelectorAll('.devicetype-filter-select-all').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const filterType = this.dataset.filter;
                        const list = document.getElementById(`devicetypeFilter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}List`);
                        if (!list) return;

                        const itemCheckboxes = list.querySelectorAll('.device-type-filter-item-checkbox');
                        itemCheckboxes.forEach(cb => {
                            cb.checked = this.checked;
                        });

                        updateDeviceTypeFilters();
                        updateDeviceTypeFilterButtonText(filterType);
                    });
                });

                deviceTypeDropdownsInitialized = true;
            }

            // 기간 선택 초기값 설정 (전체 데이터의 최소/최대 날짜)
            const dates = dimensionData
                .map(row => row['일'])
                .filter(date => date && date !== '' && date !== '-')
                .map(date => new Date(date))
                .filter(date => !isNaN(date));

            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));

                const formatDateForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const startInput = document.getElementById('deviceTypeStartDate');
                const endInput = document.getElementById('deviceTypeEndDate');

                if (startInput && endInput) {
                    startInput.value = formatDateForInput(minDate);
                    endInput.value = formatDateForInput(maxDate);
                    deviceTypeStartDate = formatDateForInput(minDate);
                    deviceTypeEndDate = formatDateForInput(maxDate);
                }
            }

            // 초기 차트 렌더링 (필터 미선택 상태 메시지 표시)
            updateDeviceTypeFilters();
            renderDeviceTypeTrendChart();
        }

        function updateDeviceTypeFilterButtonText(filterKey) {
            const filterMap = {
                'channel': '채널',
                'product': '제품',
                'brand': '브랜드',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const btn = document.querySelector(`.devicetype-filter-dropdown-btn[data-filter="${filterKey}"]`);
            const list = document.getElementById(`devicetypeFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`);

            if (!btn || !list) return;

            const checkedBoxes = list.querySelectorAll('.device-type-filter-item-checkbox:checked');
            const totalBoxes = list.querySelectorAll('.device-type-filter-item-checkbox');
            const btnText = btn.querySelector('span:first-child');
            const countText = btn.querySelector('.devicetype-selected-count');

            if (checkedBoxes.length === 0) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = '';
            } else if (checkedBoxes.length === totalBoxes.length) {
                btnText.textContent = `${filterMap[filterKey]}_전체`;
                countText.textContent = `(${checkedBoxes.length})`;
            } else if (checkedBoxes.length === 1) {
                btnText.textContent = checkedBoxes[0].value;
                countText.textContent = '';
            } else {
                btnText.textContent = `${checkedBoxes[0].value} 외`;
                countText.textContent = `(${checkedBoxes.length})`;
            }
        }

        // 전역 필터 상태 저장
        let currentDeviceTypeFilters = {
            channel: [],
            product: [],
            brand: [],
            promotion: [],
            adset: []
        };

        function updateDeviceTypeFilters() {
            if (!deviceTypeDimensionData) return;

            const filterMap = {
                'channel': { column: '유형구분', listId: 'devicetypeFilterChannelList' },
                'product': { column: '상품명', listId: 'devicetypeFilterProductList' },
                'brand': { column: '브랜드명', listId: 'devicetypeFilterBrandList' },
                'promotion': { column: '프로모션', listId: 'devicetypeFilterPromotionList' },
                'adset': { column: '광고세트', listId: 'devicetypeFilterAdsetList' }
            };

            // 선택된 필터 값 수집
            Object.keys(filterMap).forEach(filterKey => {
                const { listId } = filterMap[filterKey];
                const list = document.getElementById(listId);

                if (list) {
                    const checkedBoxes = list.querySelectorAll('.device-type-filter-item-checkbox:checked');
                    currentDeviceTypeFilters[filterKey] = Array.from(checkedBoxes).map(cb => cb.value);
                } else {
                    currentDeviceTypeFilters[filterKey] = [];
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentDeviceTypeFilters).every(arr => arr.length === 0);

            if (allFiltersEmpty) {
                // 모든 필터가 해제되면 필터 상태 초기화
                currentDeviceTypeFilters = {
                    channel: [],
                    product: [],
                    brand: [],
                    promotion: [],
                    adset: []
                };
            }

            // 필터링된 기기유형 데이터 계산
            updateFilteredDeviceTypeCount(currentDeviceTypeFilters);

            // 차트 업데이트
            renderDeviceTypeTrendChart();
        }

        function updateFilteredDeviceTypeCount(filters) {
            if (!deviceTypeDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            const deviceTypesToShow = new Set();

            deviceTypeDimensionData.forEach(row => {
                const deviceType = row['기기유형'];
                if (!deviceType || deviceType === '' || deviceType === '-') return;

                let matchesAllFilters = true;

                // AND 연산으로 모든 필터 확인
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = filters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            matchesAllFilters = false;
                        }
                    }
                });

                if (matchesAllFilters) {
                    deviceTypesToShow.add(deviceType);
                }
            });

            document.getElementById('filteredDeviceTypeCount').textContent = deviceTypesToShow.size;
        }

        // 기기플랫폼 추이 차트 렌더링
        function renderDevicePlatformTrendChart() {
            const canvas = document.getElementById('devicePlatformTrendChart');
            if (!canvas) return;

            if (devicePlatformTrendChart) {
                devicePlatformTrendChart.destroy();
            }

            if (!devicePlatformDimensionData) {
                const ctx = canvas.getContext('2d');
                devicePlatformTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: '데이터 로딩 중...' }
                        }
                    }
                });
                return;
            }

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            // 필터 조건을 만족하는 행만 필터링하는 헬퍼 함수
            const rowMatchesFilters = (row) => {
                // 모든 필터가 비어있는지 확인
                const allFiltersEmpty = Object.values(currentDevicePlatformFilters).every(arr => !arr || arr.length === 0);

                // 모든 필터가 비어있으면 false 반환 (데이터 표시 안 함)
                if (allFiltersEmpty) {
                    return false;
                }

                // 모든 필터를 AND 조건으로 확인
                for (const filterKey of Object.keys(filterMap)) {
                    const column = filterMap[filterKey];
                    const selectedValues = currentDevicePlatformFilters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            return false;
                        }
                    }
                }
                return true;
            };

            // 기기플랫폼 목록 가져오기
            const devicePlatformsToShow = new Set();
            devicePlatformDimensionData.forEach(row => {
                if (rowMatchesFilters(row)) {
                    const devicePlatform = row['기기플랫폼'];
                    if (devicePlatform && devicePlatform !== '' && devicePlatform !== '-') {
                        devicePlatformsToShow.add(devicePlatform);
                    }
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentDevicePlatformFilters).every(arr => !arr || arr.length === 0);

            if (allFiltersEmpty || devicePlatformsToShow.size === 0) {
                const ctx = canvas.getContext('2d');
                devicePlatformTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: allFiltersEmpty ? '필터를 선택해주세요' : '필터 조건에 맞는 데이터가 없습니다' }
                        }
                    }
                });
                return;
            }

            // 기기플랫폼별 일별 데이터 집계
            const timeSeriesData = {};
            devicePlatformsToShow.forEach(devicePlatform => {
                timeSeriesData[devicePlatform] = {};
            });

            devicePlatformDimensionData.forEach(row => {
                if (!rowMatchesFilters(row)) return;

                const devicePlatform = row['기기플랫폼'];
                if (devicePlatformsToShow.has(devicePlatform) && row['일']) {
                    const date = row['일'];

                    // 기간 필터링
                    if (devicePlatformStartDate || devicePlatformEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (devicePlatformStartDate && rowDate < new Date(devicePlatformStartDate)) return;
                        if (devicePlatformEndDate && rowDate > new Date(devicePlatformEndDate)) return;
                    }

                    const cost = parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                    const revenue = parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                    const conversions = parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                    const impressions = parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                    const clicks = parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;

                    if (!timeSeriesData[devicePlatform][date]) {
                        timeSeriesData[devicePlatform][date] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    timeSeriesData[devicePlatform][date].cost += cost;
                    timeSeriesData[devicePlatform][date].revenue += revenue;
                    timeSeriesData[devicePlatform][date].conversions += conversions;
                    timeSeriesData[devicePlatform][date].impressions += impressions;
                    timeSeriesData[devicePlatform][date].clicks += clicks;
                }
            });

            // 기간별 집계
            const aggregatedData = {};
            devicePlatformsToShow.forEach(devicePlatform => {
                aggregatedData[devicePlatform] = {};
            });

            Object.keys(timeSeriesData).forEach(devicePlatform => {
                Object.keys(timeSeriesData[devicePlatform]).forEach(date => {
                    const periodKey = getPeriodKey(date, currentDevicePlatformPeriod);
                    if (!aggregatedData[devicePlatform][periodKey]) {
                        aggregatedData[devicePlatform][periodKey] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    aggregatedData[devicePlatform][periodKey].cost += timeSeriesData[devicePlatform][date].cost;
                    aggregatedData[devicePlatform][periodKey].revenue += timeSeriesData[devicePlatform][date].revenue;
                    aggregatedData[devicePlatform][periodKey].conversions += timeSeriesData[devicePlatform][date].conversions;
                    aggregatedData[devicePlatform][periodKey].impressions += timeSeriesData[devicePlatform][date].impressions;
                    aggregatedData[devicePlatform][periodKey].clicks += timeSeriesData[devicePlatform][date].clicks;
                });
            });

            // 선택된 지표에 따라 데이터 계산
            const metricData = {};
            Object.keys(aggregatedData).forEach(devicePlatform => {
                metricData[devicePlatform] = {};
                Object.keys(aggregatedData[devicePlatform]).forEach(period => {
                    const { cost, revenue, conversions, impressions, clicks } = aggregatedData[devicePlatform][period];

                    switch(currentDevicePlatformMetric) {
                        case 'roas':
                            metricData[devicePlatform][period] = cost > 0 ? (revenue / cost * 100) : 0;
                            break;
                        case 'cost':
                            metricData[devicePlatform][period] = cost;
                            break;
                        case 'revenue':
                            metricData[devicePlatform][period] = revenue;
                            break;
                        case 'conversions':
                            metricData[devicePlatform][period] = conversions;
                            break;
                        case 'impressions':
                            metricData[devicePlatform][period] = impressions;
                            break;
                        case 'clicks':
                            metricData[devicePlatform][period] = clicks;
                            break;
                        case 'cpm':
                            metricData[devicePlatform][period] = impressions > 0 ? (cost / impressions * 1000) : 0;
                            break;
                        case 'cpc':
                            metricData[devicePlatform][period] = clicks > 0 ? (cost / clicks) : 0;
                            break;
                        case 'cpa':
                            metricData[devicePlatform][period] = conversions > 0 ? (cost / conversions) : 0;
                            break;
                        case 'ctr':
                            metricData[devicePlatform][period] = impressions > 0 ? (clicks / impressions * 100) : 0;
                            break;
                        case 'cvr':
                            metricData[devicePlatform][period] = clicks > 0 ? (conversions / clicks * 100) : 0;
                            break;
                        default:
                            metricData[devicePlatform][period] = 0;
                    }
                });
            });

            // 기간 정렬
            const allPeriods = [...new Set(Object.values(metricData).flatMap(data => Object.keys(data)))].sort();

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#4caf50', '#ff9800', '#f44336'];
            const devicePlatformArray = Array.from(devicePlatformsToShow).sort();
            const datasets = devicePlatformArray.map((devicePlatform, index) => {
                return {
                    label: devicePlatform,
                    data: allPeriods.map(period => metricData[devicePlatform][period] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.3
                };
            });

            const ctx = canvas.getContext('2d');
            devicePlatformTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allPeriods, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const devicePlatform = devicePlatformArray[context.datasetIndex];
                                    const period = allPeriods[context.dataIndex];
                                    const data = aggregatedData[devicePlatform][period] || {};
                                    const { cost = 0, revenue = 0, conversions = 0, impressions = 0, clicks = 0 } = data;

                                    const roas = cost > 0 ? (revenue / cost * 100) : 0;
                                    const cpm = impressions > 0 ? (cost / impressions * 1000) : 0;
                                    const cpc = clicks > 0 ? (cost / clicks) : 0;
                                    const cpa = conversions > 0 ? (cost / conversions) : 0;
                                    const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
                                    const cvr = clicks > 0 ? (conversions / clicks * 100) : 0;

                                    const lines = [`${devicePlatform}`];

                                    switch(currentDevicePlatformMetric) {
                                        case 'roas':
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`전환값: ${formatCurrency(revenue)}`);
                                            break;
                                        case 'cost':
                                            lines.push(`비용: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'revenue':
                                            lines.push(`전환값: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'conversions':
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`전환율: ${cvr.toFixed(2)}%`);
                                            break;
                                        case 'impressions':
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'clicks':
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'cpm':
                                            lines.push(`CPM: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cpc':
                                            lines.push(`CPC: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                        case 'cpa':
                                            lines.push(`CPA: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            break;
                                        case 'ctr':
                                            lines.push(`CTR: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cvr':
                                            lines.push(`전환율: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (function() {
                                    switch(currentDevicePlatformMetric) {
                                        case 'roas': return 'ROAS (%)';
                                        case 'cost': return '비용 (원)';
                                        case 'revenue': return '전환값 (원)';
                                        case 'conversions': return '전환수 (건)';
                                        case 'impressions': return '노출수 (회)';
                                        case 'clicks': return '클릭수 (회)';
                                        case 'cpm': return 'CPM (원)';
                                        case 'cpc': return 'CPC (원)';
                                        case 'cpa': return 'CPA (원)';
                                        case 'ctr': return 'CTR (%)';
                                        case 'cvr': return '전환율 (%)';
                                        default: return '지표';
                                    }
                                })()
                            },
                            ticks: {
                                callback: function(value) {
                                    switch(currentDevicePlatformMetric) {
                                        case 'roas':
                                        case 'ctr':
                                        case 'cvr':
                                            return value.toFixed(1) + '%';
                                        case 'cost':
                                        case 'revenue':
                                        case 'cpm':
                                        case 'cpc':
                                        case 'cpa':
                                            return formatCurrency(value);
                                        case 'conversions':
                                        case 'impressions':
                                        case 'clicks':
                                            return value.toLocaleString();
                                        default:
                                            return value;
                                    }
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: '기간' }
                        }
                    }
                }
            });
        }

        // 기기유형 추이 차트 렌더링
        function renderDeviceTypeTrendChart() {
            const canvas = document.getElementById('deviceTypeTrendChart');
            if (!canvas) return;

            if (deviceTypeTrendChart) {
                deviceTypeTrendChart.destroy();
            }

            if (!deviceTypeDimensionData) {
                const ctx = canvas.getContext('2d');
                deviceTypeTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: '데이터 로딩 중...' }
                        }
                    }
                });
                return;
            }

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션',
                'adset': '광고세트'
            };

            // 필터 조건을 만족하는 행만 필터링하는 헬퍼 함수
            const rowMatchesFilters = (row) => {
                // 모든 필터가 비어있는지 확인
                const allFiltersEmpty = Object.values(currentDeviceTypeFilters).every(arr => !arr || arr.length === 0);

                // 모든 필터가 비어있으면 false 반환 (데이터 표시 안 함)
                if (allFiltersEmpty) {
                    return false;
                }

                // 모든 필터를 AND 조건으로 확인
                for (const filterKey of Object.keys(filterMap)) {
                    const column = filterMap[filterKey];
                    const selectedValues = currentDeviceTypeFilters[filterKey];

                    if (selectedValues && selectedValues.length > 0) {
                        const rowValue = row[column];
                        if (!selectedValues.includes(rowValue)) {
                            return false;
                        }
                    }
                }
                return true;
            };

            // 기기유형 목록 가져오기
            const deviceTypesToShow = new Set();
            deviceTypeDimensionData.forEach(row => {
                if (rowMatchesFilters(row)) {
                    const deviceType = row['기기유형'];
                    if (deviceType && deviceType !== '' && deviceType !== '-') {
                        deviceTypesToShow.add(deviceType);
                    }
                }
            });

            // 모든 필터가 비어있는지 확인
            const allFiltersEmpty = Object.values(currentDeviceTypeFilters).every(arr => !arr || arr.length === 0);

            if (allFiltersEmpty || deviceTypesToShow.size === 0) {
                const ctx = canvas.getContext('2d');
                deviceTypeTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: allFiltersEmpty ? '필터를 선택해주세요' : '필터 조건에 맞는 데이터가 없습니다' }
                        }
                    }
                });
                return;
            }

            // 기기유형별 일별 데이터 집계
            const timeSeriesData = {};
            deviceTypesToShow.forEach(deviceType => {
                timeSeriesData[deviceType] = {};
            });

            deviceTypeDimensionData.forEach(row => {
                if (!rowMatchesFilters(row)) return;

                const deviceType = row['기기유형'];
                if (deviceTypesToShow.has(deviceType) && row['일']) {
                    const date = row['일'];

                    // 기간 필터링
                    if (deviceTypeStartDate || deviceTypeEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (deviceTypeStartDate && rowDate < new Date(deviceTypeStartDate)) return;
                        if (deviceTypeEndDate && rowDate > new Date(deviceTypeEndDate)) return;
                    }

                    const cost = parseFloat(row['비용']?.replace(/,/g, '') || row['비용']) || 0;
                    const revenue = parseFloat(row['전환값']?.replace(/,/g, '') || row['전환값']) || 0;
                    const conversions = parseFloat(row['전환수']?.replace(/,/g, '') || row['전환수']) || 0;
                    const impressions = parseFloat(row['노출']?.replace(/,/g, '') || row['노출']) || 0;
                    const clicks = parseFloat(row['클릭']?.replace(/,/g, '') || row['클릭']) || 0;

                    if (!timeSeriesData[deviceType][date]) {
                        timeSeriesData[deviceType][date] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    timeSeriesData[deviceType][date].cost += cost;
                    timeSeriesData[deviceType][date].revenue += revenue;
                    timeSeriesData[deviceType][date].conversions += conversions;
                    timeSeriesData[deviceType][date].impressions += impressions;
                    timeSeriesData[deviceType][date].clicks += clicks;
                }
            });

            // 기간별 집계
            const aggregatedData = {};
            deviceTypesToShow.forEach(deviceType => {
                aggregatedData[deviceType] = {};
            });

            Object.keys(timeSeriesData).forEach(deviceType => {
                Object.keys(timeSeriesData[deviceType]).forEach(date => {
                    const periodKey = getPeriodKey(date, currentDeviceTypePeriod);
                    if (!aggregatedData[deviceType][periodKey]) {
                        aggregatedData[deviceType][periodKey] = {
                            cost: 0,
                            revenue: 0,
                            conversions: 0,
                            impressions: 0,
                            clicks: 0
                        };
                    }
                    aggregatedData[deviceType][periodKey].cost += timeSeriesData[deviceType][date].cost;
                    aggregatedData[deviceType][periodKey].revenue += timeSeriesData[deviceType][date].revenue;
                    aggregatedData[deviceType][periodKey].conversions += timeSeriesData[deviceType][date].conversions;
                    aggregatedData[deviceType][periodKey].impressions += timeSeriesData[deviceType][date].impressions;
                    aggregatedData[deviceType][periodKey].clicks += timeSeriesData[deviceType][date].clicks;
                });
            });

            // 선택된 지표에 따라 데이터 계산
            const metricData = {};
            Object.keys(aggregatedData).forEach(deviceType => {
                metricData[deviceType] = {};
                Object.keys(aggregatedData[deviceType]).forEach(period => {
                    const { cost, revenue, conversions, impressions, clicks } = aggregatedData[deviceType][period];

                    switch(currentDeviceTypeMetric) {
                        case 'roas':
                            metricData[deviceType][period] = cost > 0 ? (revenue / cost * 100) : 0;
                            break;
                        case 'cost':
                            metricData[deviceType][period] = cost;
                            break;
                        case 'revenue':
                            metricData[deviceType][period] = revenue;
                            break;
                        case 'conversions':
                            metricData[deviceType][period] = conversions;
                            break;
                        case 'impressions':
                            metricData[deviceType][period] = impressions;
                            break;
                        case 'clicks':
                            metricData[deviceType][period] = clicks;
                            break;
                        case 'cpm':
                            metricData[deviceType][period] = impressions > 0 ? (cost / impressions * 1000) : 0;
                            break;
                        case 'cpc':
                            metricData[deviceType][period] = clicks > 0 ? (cost / clicks) : 0;
                            break;
                        case 'cpa':
                            metricData[deviceType][period] = conversions > 0 ? (cost / conversions) : 0;
                            break;
                        case 'ctr':
                            metricData[deviceType][period] = impressions > 0 ? (clicks / impressions * 100) : 0;
                            break;
                        case 'cvr':
                            metricData[deviceType][period] = clicks > 0 ? (conversions / clicks * 100) : 0;
                            break;
                        default:
                            metricData[deviceType][period] = 0;
                    }
                });
            });

            // 기간 정렬
            const allPeriods = [...new Set(Object.values(metricData).flatMap(data => Object.keys(data)))].sort();

            // 데이터셋 생성
            const colors = ['#673ab7', '#2196f3', '#4caf50', '#ff9800', '#f44336'];
            const deviceTypeArray = Array.from(deviceTypesToShow).sort();
            const datasets = deviceTypeArray.map((deviceType, index) => {
                return {
                    label: deviceType,
                    data: allPeriods.map(period => metricData[deviceType][period] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.3
                };
            });

            const ctx = canvas.getContext('2d');
            deviceTypeTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: allPeriods, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const deviceType = deviceTypeArray[context.datasetIndex];
                                    const period = allPeriods[context.dataIndex];
                                    const data = aggregatedData[deviceType][period] || {};
                                    const { cost = 0, revenue = 0, conversions = 0, impressions = 0, clicks = 0 } = data;

                                    const roas = cost > 0 ? (revenue / cost * 100) : 0;
                                    const cpm = impressions > 0 ? (cost / impressions * 1000) : 0;
                                    const cpc = clicks > 0 ? (cost / clicks) : 0;
                                    const cpa = conversions > 0 ? (cost / conversions) : 0;
                                    const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
                                    const cvr = clicks > 0 ? (conversions / clicks * 100) : 0;

                                    const lines = [`${deviceType}`];

                                    switch(currentDeviceTypeMetric) {
                                        case 'roas':
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`전환값: ${formatCurrency(revenue)}`);
                                            break;
                                        case 'cost':
                                            lines.push(`비용: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'revenue':
                                            lines.push(`전환값: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`비용: ${formatCurrency(cost)}`);
                                            lines.push(`ROAS: ${roas.toFixed(1)}%`);
                                            break;
                                        case 'conversions':
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`전환율: ${cvr.toFixed(2)}%`);
                                            break;
                                        case 'impressions':
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'clicks':
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`CTR: ${ctr.toFixed(2)}%`);
                                            break;
                                        case 'cpm':
                                            lines.push(`CPM: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cpc':
                                            lines.push(`CPC: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                        case 'cpa':
                                            lines.push(`CPA: ${formatCurrency(context.parsed.y)}`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            break;
                                        case 'ctr':
                                            lines.push(`CTR: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            lines.push(`노출수: ${impressions.toLocaleString()}회`);
                                            break;
                                        case 'cvr':
                                            lines.push(`전환율: ${context.parsed.y.toFixed(2)}%`);
                                            lines.push(`전환수: ${conversions.toLocaleString()}건`);
                                            lines.push(`클릭수: ${clicks.toLocaleString()}회`);
                                            break;
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (function() {
                                    switch(currentDeviceTypeMetric) {
                                        case 'roas': return 'ROAS (%)';
                                        case 'cost': return '비용 (원)';
                                        case 'revenue': return '전환값 (원)';
                                        case 'conversions': return '전환수 (건)';
                                        case 'impressions': return '노출수 (회)';
                                        case 'clicks': return '클릭수 (회)';
                                        case 'cpm': return 'CPM (원)';
                                        case 'cpc': return 'CPC (원)';
                                        case 'cpa': return 'CPA (원)';
                                        case 'ctr': return 'CTR (%)';
                                        case 'cvr': return '전환율 (%)';
                                        default: return '지표';
                                    }
                                })()
                            },
                            ticks: {
                                callback: function(value) {
                                    switch(currentDeviceTypeMetric) {
                                        case 'roas':
                                        case 'ctr':
                                        case 'cvr':
                                            return value.toFixed(1) + '%';
                                        case 'cost':
                                        case 'revenue':
                                        case 'cpm':
                                        case 'cpc':
                                        case 'cpa':
                                            return formatCurrency(value);
                                        case 'conversions':
                                        case 'impressions':
                                        case 'clicks':
                                            return value.toLocaleString();
                                        default:
                                            return value;
                                    }
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: '기간' }
                        }
                    }
                }
            });
        }

        // 유틸리티 함수들
        function getPeriodKey(dateString, period) {
            const date = new Date(dateString);
            if (period === 'daily') {
                return dateString;
            } else if (period === 'weekly') {
                // 해당 주의 월요일(시작일)을 구함
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1); // 월요일로 조정
                const monday = new Date(date);
                monday.setDate(diff);
                const year = monday.getFullYear();
                const month = String(monday.getMonth() + 1).padStart(2, '0');
                const dayOfMonth = String(monday.getDate()).padStart(2, '0');
                return `${year}-${month}-${dayOfMonth}`;
            } else if (period === 'monthly') {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                return `${year}-${String(month).padStart(2, '0')}`;
            }
            return dateString;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                minimumFractionDigits: 0
            }).format(value);
        }

        // 성별 한글 레이블 함수 (하위 호환성 유지)
        function getGenderDisplayName(normalizedGender) {
            if (normalizedGender === '남성' || normalizedGender === 'Male') return '남성';
            if (normalizedGender === '여성' || normalizedGender === 'Female') return '여성';
            return null;
        }

        // ========== 성과 비교 분석 섹션 함수들 ==========

        // 공통 헬퍼: 지표 값 계산
        function calculateMetricValue(data, metric) {
            const cost = data.cost || 0;
            const revenue = data.revenue || 0;
            const conversions = data.conversions || 0;
            const impressions = data.impressions || 0;
            const clicks = data.clicks || 0;

            switch(metric) {
                case 'roas': return cost > 0 ? (revenue / cost * 100) : 0;
                case 'cost': return cost;
                case 'revenue': return revenue;
                case 'conversions': return conversions;
                case 'impressions': return impressions;
                case 'clicks': return clicks;
                case 'cpm': return impressions > 0 ? (cost / impressions * 1000) : 0;
                case 'cpc': return clicks > 0 ? (cost / clicks) : 0;
                case 'cpa': return conversions > 0 ? (cost / conversions) : 0;
                case 'ctr': return impressions > 0 ? (clicks / impressions * 100) : 0;
                case 'cvr': return clicks > 0 ? (conversions / clicks * 100) : 0;
                default: return 0;
            }
        }

        // 공통 헬퍼: 지표 포맷팅
        function formatMetricValue(value, metric) {
            switch(metric) {
                case 'roas':
                case 'ctr':
                case 'cvr':
                    return value.toFixed(1) + '%';
                case 'cost':
                case 'revenue':
                case 'cpm':
                case 'cpc':
                case 'cpa':
                    return formatCurrency(value);
                default:
                    return value.toLocaleString();
            }
        }

        // 비교 Bar 차트 렌더링 함수 (두 기간 비교)
        function renderDetailCompareBarChart(canvasId, chartVar, labels, values, valuesComp, metric, periodLabel, periodLabelComp) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;

            if (chartVar) {
                chartVar.destroy();
            }

            const metricLabels = {
                'roas': 'ROAS (%)',
                'cost': '비용 (원)',
                'revenue': '전환값 (원)',
                'conversions': '전환수',
                'impressions': '노출수',
                'clicks': '클릭수',
                'cpm': 'CPM (원)',
                'cpc': 'CPC (원)',
                'cpa': 'CPA (원)',
                'ctr': 'CTR (%)',
                'cvr': '전환율 (%)'
            };

            const ctx = canvas.getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: periodLabel || '기준 기간',
                            data: values,
                            backgroundColor: 'rgba(33, 150, 243, 0.8)',
                            borderColor: 'rgba(33, 150, 243, 1)',
                            borderWidth: 1
                        },
                        {
                            label: periodLabelComp || '비교 기간',
                            data: valuesComp,
                            backgroundColor: 'rgba(158, 158, 158, 0.6)',
                            borderColor: 'rgba(158, 158, 158, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatMetricValue(context.raw, metric);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: metricLabels[metric] || metric
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // 더보기 버튼 상태 업데이트 함수
        function updateDetailShowMoreButton(tabName, totalCount, currentLimit, isExpanded) {
            const container = document.getElementById(`detail${tabName.charAt(0).toUpperCase() + tabName.slice(1)}ShowMoreContainer`);
            const btn = document.getElementById(`detail${tabName.charAt(0).toUpperCase() + tabName.slice(1)}ShowMoreBtn`);
            if (!container || !btn) return;

            // 기본 제한보다 데이터가 많을 때만 버튼 표시
            if (totalCount > DETAIL_DEFAULT_LIMIT) {
                container.style.display = 'block';
                const btnText = btn.querySelector('.btn-text');
                const btnCount = btn.querySelector('.btn-count');
                if (isExpanded) {
                    btnText.textContent = '접기';
                    btnCount.textContent = '';
                    btn.style.background = '#f8f9fa';
                } else {
                    const remaining = totalCount - currentLimit;
                    btnText.textContent = '더보기';
                    btnCount.textContent = `(+${remaining > DETAIL_EXPANDED_LIMIT - DETAIL_DEFAULT_LIMIT ? DETAIL_EXPANDED_LIMIT - DETAIL_DEFAULT_LIMIT : remaining}개)`;
                    btn.style.background = 'white';
                }
            } else {
                container.style.display = 'none';
            }
        }

        // 공통 Bar 차트 렌더링 함수 (수평 막대) - 단순 버전
        function renderDetailBarChart(canvasId, chartVar, labels, values, metric, chartTitle) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;

            if (chartVar) {
                chartVar.destroy();
            }

            const colors = [
                'rgba(33, 150, 243, 0.8)',
                'rgba(76, 175, 80, 0.8)',
                'rgba(255, 152, 0, 0.8)',
                'rgba(156, 39, 176, 0.8)',
                'rgba(244, 67, 54, 0.8)',
                'rgba(0, 188, 212, 0.8)',
                'rgba(255, 87, 34, 0.8)',
                'rgba(63, 81, 181, 0.8)',
                'rgba(139, 195, 74, 0.8)',
                'rgba(255, 193, 7, 0.8)'
            ];

            const metricLabels = {
                'roas': 'ROAS (%)',
                'cost': '비용 (원)',
                'revenue': '전환값 (원)',
                'conversions': '전환수',
                'impressions': '노출수',
                'clicks': '클릭수',
                'cpm': 'CPM (원)',
                'cpc': 'CPC (원)',
                'cpa': 'CPA (원)',
                'ctr': 'CTR (%)',
                'cvr': '전환율 (%)'
            };

            const ctx = canvas.getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: metricLabels[metric] || metric,
                        data: values,
                        backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                        borderColor: labels.map((_, i) => colors[i % colors.length].replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: !!chartTitle,
                            text: chartTitle || ''
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatMetricValue(context.raw, metric);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: metricLabels[metric] || metric
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // 누적 바 차트 렌더링 함수 (분류기준별 색상)
        function renderDetailStackedBarChart(canvasId, chartVar, dimensionLabels, stackedData, metric) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;

            if (chartVar) {
                chartVar.destroy();
            }

            const stackColors = [
                'rgba(33, 150, 243, 0.8)',   // 파랑
                'rgba(76, 175, 80, 0.8)',    // 초록
                'rgba(255, 152, 0, 0.8)',    // 주황
                'rgba(156, 39, 176, 0.8)',   // 보라
                'rgba(244, 67, 54, 0.8)',    // 빨강
                'rgba(0, 188, 212, 0.8)',    // 청록
                'rgba(255, 87, 34, 0.8)',    // 딥오렌지
                'rgba(63, 81, 181, 0.8)',    // 인디고
                'rgba(139, 195, 74, 0.8)',   // 라이트그린
                'rgba(255, 193, 7, 0.8)'     // 앰버
            ];

            const metricLabels = {
                'roas': 'ROAS (%)',
                'cost': '비용 (원)',
                'revenue': '전환값 (원)',
                'conversions': '전환수',
                'impressions': '노출수',
                'clicks': '클릭수',
                'cpm': 'CPM (원)',
                'cpc': 'CPC (원)',
                'cpa': 'CPA (원)',
                'ctr': 'CTR (%)',
                'cvr': '전환율 (%)'
            };

            // stackedData 형식: { '채널A': [val1, val2, ...], '채널B': [val1, val2, ...] }
            const datasets = Object.entries(stackedData).map(([stackLabel, values], idx) => ({
                label: stackLabel,
                data: values,
                backgroundColor: stackColors[idx % stackColors.length],
                borderColor: stackColors[idx % stackColors.length].replace('0.8', '1'),
                borderWidth: 1
            }));

            const ctx = canvas.getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dimensionLabels,
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatMetricValue(context.raw, metric)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: metricLabels[metric] || metric
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // 드롭다운 버튼 텍스트 업데이트 헬퍼 함수
        function updateFilterDropdownText(btnSelector, filter, selectedValues, filterLabels, checkboxSelector) {
            const btn = document.querySelector(`${btnSelector}[data-filter="${filter}"]`);
            if (!btn) return;

            const textSpan = btn.querySelector('span:first-child');
            if (!textSpan) return;

            // 전체 항목 개수 확인
            const totalItems = checkboxSelector ?
                document.querySelectorAll(`${checkboxSelector}[data-filter="${filter}"]`).length : 0;

            // 오른쪽 영역 (개수 + 화살표) 찾거나 생성
            let rightWrapper = btn.querySelector('.filter-right-area');
            if (!rightWrapper) {
                const arrowSpan = btn.querySelector('span:last-child');
                if (arrowSpan) {
                    rightWrapper = document.createElement('span');
                    rightWrapper.className = 'filter-right-area';
                    rightWrapper.style.cssText = 'display: flex; align-items: center; gap: 4px;';

                    const countSpan = document.createElement('span');
                    countSpan.className = 'selected-count';
                    countSpan.style.cssText = 'font-size: 11px; color: var(--grey-500);';

                    rightWrapper.appendChild(countSpan);
                    rightWrapper.appendChild(arrowSpan.cloneNode(true));
                    arrowSpan.replaceWith(rightWrapper);
                }
            }

            const countSpan = rightWrapper ? rightWrapper.querySelector('.selected-count') : null;
            const label = filterLabels[filter] || filter;

            // 전체 선택 시 또는 미선택 시 "_전체" 표시
            if (selectedValues.length === 0 || (totalItems > 0 && selectedValues.length === totalItems)) {
                textSpan.textContent = `${label}_전체`;
                if (countSpan) countSpan.textContent = '';
            } else if (selectedValues.length === 1) {
                textSpan.textContent = selectedValues[0];
                if (countSpan) countSpan.textContent = '';
            } else {
                textSpan.textContent = `${selectedValues[0]} 외`;
                if (countSpan) countSpan.textContent = `(${selectedValues.length})`;
            }
        }

        // 광고세트 상세 필터 초기화
        function initDetailAdsetDropdowns() {
            if (!adsetDimensionData) return;

            const filterMap = {
                'channel': '유형구분',
                'product': '상품명',
                'brand': '브랜드명',
                'promotion': '프로모션'
            };

            Object.keys(filterMap).forEach(filterKey => {
                const column = filterMap[filterKey];
                const uniqueValues = [...new Set(adsetDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                uniqueValues.sort();

                const listId = `detailFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`;
                const listContainer = document.getElementById(listId);
                if (!listContainer) return;

                listContainer.innerHTML = uniqueValues.map(value => `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.2s;">
                        <input type="checkbox" class="detail-filter-checkbox" data-filter="${filterKey}" data-value="${value}" style="margin-right: 10px; width: 14px; height: 14px; cursor: pointer;">
                        ${value}
                    </label>
                `).join('');
            });

            // 드롭다운 토글 이벤트
            document.querySelectorAll('.detail-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filter = this.dataset.filter;
                    document.querySelectorAll('.detail-filter-dropdown-list').forEach(list => {
                        if (list.dataset.filter === filter) {
                            list.style.display = list.style.display === 'none' ? 'block' : 'none';
                        } else {
                            list.style.display = 'none';
                        }
                    });
                });
            });

            // 필터 라벨 매핑
            const adsetFilterLabels = { 'channel': '채널', 'product': '제품', 'brand': '브랜드', 'promotion': '프로모션' };

            // 체크박스 변경 이벤트
            document.querySelectorAll('.detail-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    const value = this.dataset.value;
                    if (this.checked) {
                        if (!detailAdsetFilters[filter].includes(value)) {
                            detailAdsetFilters[filter].push(value);
                        }
                    } else {
                        detailAdsetFilters[filter] = detailAdsetFilters[filter].filter(v => v !== value);
                    }
                    updateFilterDropdownText('.detail-filter-dropdown-btn', filter, detailAdsetFilters[filter], adsetFilterLabels, '.detail-filter-checkbox');
                    updateDetailAdsetCount();
                    renderDetailAdsetBarChart();
                });
            });

            // 전체 선택 이벤트
            document.querySelectorAll('.detail-filter-select-all').forEach(selectAll => {
                selectAll.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    const checkboxes = document.querySelectorAll(`.detail-filter-checkbox[data-filter="${filter}"]`);
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                        const value = cb.dataset.value;
                        if (this.checked) {
                            if (!detailAdsetFilters[filter].includes(value)) {
                                detailAdsetFilters[filter].push(value);
                            }
                        } else {
                            detailAdsetFilters[filter] = [];
                        }
                    });
                    updateFilterDropdownText('.detail-filter-dropdown-btn', filter, detailAdsetFilters[filter], adsetFilterLabels, '.detail-filter-checkbox');
                    updateDetailAdsetCount();
                    renderDetailAdsetBarChart();
                });
            });

            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.detail-filter-dropdown-btn') && !e.target.closest('.detail-filter-dropdown-list')) {
                    document.querySelectorAll('.detail-filter-dropdown-list').forEach(list => {
                        list.style.display = 'none';
                    });
                }
            });
        }

        function updateDetailAdsetCount() {
            if (!adsetDimensionData) return;
            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션' };
            const hasActiveFilters = Object.values(detailAdsetFilters).some(arr => arr.length > 0);

            const matchedAdsets = new Set();
            adsetDimensionData.forEach(row => {
                const adset = row['광고세트'];
                if (!adset || adset === '' || adset === '-') return;
                let matches = true;
                Object.keys(filterMap).forEach(filterKey => {
                    const column = filterMap[filterKey];
                    const selectedValues = detailAdsetFilters[filterKey];
                    if (selectedValues && selectedValues.length > 0) {
                        if (!selectedValues.includes(row[column])) {
                            matches = false;
                        }
                    }
                });
                if (matches && hasActiveFilters) matchedAdsets.add(adset);
            });

            const countEl = document.getElementById('detailFilteredAdsetCount');
            if (countEl) countEl.textContent = matchedAdsets.size;
        }

        // 광고세트 상세 Bar 차트 렌더링
        function renderDetailAdsetBarChart() {
            if (!adsetDimensionData) {
                detailAdsetBarChart = renderDetailBarChart('detailAdsetBarChart', detailAdsetBarChart, [], [], detailAdsetMetric, '데이터를 로드 중...');
                return;
            }

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션' };
            const hasActiveFilters = Object.values(detailAdsetFilters).some(arr => arr.length > 0);

            // 비교 모드 처리
            if (detailAdsetCompareActive && detailAdsetStartDateComp && detailAdsetEndDateComp) {
                // 데이터 집계 함수
                const aggregateData = (startDate, endDate) => {
                    const dataMap = {};
                    adsetDimensionData.forEach(row => {
                        const adset = row['광고세트'];
                        if (!adset || adset === '' || adset === '-') return;

                        // 필터 매칭 확인
                        let matches = true;
                        Object.keys(filterMap).forEach(filterKey => {
                            const column = filterMap[filterKey];
                            const selectedValues = detailAdsetFilters[filterKey];
                            if (selectedValues && selectedValues.length > 0) {
                                if (!selectedValues.includes(row[column])) matches = false;
                            }
                        });
                        if (!matches && hasActiveFilters) return;

                        const date = row['일'];
                        if (startDate || endDate) {
                            const rowDate = new Date(date);
                            if (isNaN(rowDate)) return;
                            if (startDate && rowDate < new Date(startDate)) return;
                            if (endDate && rowDate > new Date(endDate)) return;
                        }

                        if (!dataMap[adset]) {
                            dataMap[adset] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                        }
                        dataMap[adset].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[adset].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[adset].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[adset].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[adset].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                    });
                    return dataMap;
                };

                const mainData = aggregateData(detailAdsetStartDate, detailAdsetEndDate);
                const compData = aggregateData(detailAdsetStartDateComp, detailAdsetEndDateComp);

                // 정렬 (기준 기간 기준)
                const allSortedAdsets = Object.keys(mainData)
                    .sort((a, b) => {
                        const valA = calculateMetricValue(mainData[a], detailAdsetMetric);
                        const valB = calculateMetricValue(mainData[b], detailAdsetMetric);
                        return detailAdsetSortOrder === 'desc' ? valB - valA : valA - valB;
                    });

                detailAdsetTotalCount = allSortedAdsets.length;
                const limit = detailAdsetShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedAdsets = allSortedAdsets.slice(0, limit);

                const labels = sortedAdsets;
                const values = sortedAdsets.map(adset => calculateMetricValue(mainData[adset] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailAdsetMetric));
                const valuesComp = sortedAdsets.map(adset => calculateMetricValue(compData[adset] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailAdsetMetric));

                detailAdsetBarChart = renderDetailCompareBarChart('detailAdsetBarChart', detailAdsetBarChart, labels, values, valuesComp, detailAdsetMetric, '기준 기간', '비교 기간');
                updateDetailShowMoreButton('adset', detailAdsetTotalCount, limit, detailAdsetShowAll);
                return;
            }

            // 활성화된 필터 찾기
            let activeFilterKey = null;
            let activeFilterValues = [];
            for (const [key, values] of Object.entries(detailAdsetFilters)) {
                if (values && values.length > 0) {
                    activeFilterKey = key;
                    activeFilterValues = values;
                    break;
                }
            }

            if (hasActiveFilters && activeFilterKey) {
                // 스택 바 차트: 필터 분류 기준별로 그룹화
                const stackedDataMap = {}; // { adset: { stackValue: {metrics} } }

                adsetDimensionData.forEach(row => {
                    const adset = row['광고세트'];
                    if (!adset || adset === '' || adset === '-') return;

                    // 필터 매칭 확인
                    let matches = true;
                    Object.keys(filterMap).forEach(filterKey => {
                        const column = filterMap[filterKey];
                        const selectedValues = detailAdsetFilters[filterKey];
                        if (selectedValues && selectedValues.length > 0) {
                            if (!selectedValues.includes(row[column])) matches = false;
                        }
                    });
                    if (!matches) return;

                    const date = row['일'];
                    if (detailAdsetStartDate || detailAdsetEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (detailAdsetStartDate && rowDate < new Date(detailAdsetStartDate)) return;
                        if (detailAdsetEndDate && rowDate > new Date(detailAdsetEndDate)) return;
                    }

                    const stackValue = row[filterMap[activeFilterKey]] || '기타';

                    if (!stackedDataMap[adset]) {
                        stackedDataMap[adset] = {};
                    }
                    if (!stackedDataMap[adset][stackValue]) {
                        stackedDataMap[adset][stackValue] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                    }

                    stackedDataMap[adset][stackValue].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[adset][stackValue].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[adset][stackValue].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[adset][stackValue].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[adset][stackValue].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                });

                // 광고세트 합계로 정렬
                const adsetTotals = {};
                Object.entries(stackedDataMap).forEach(([adset, stacks]) => {
                    let total = 0;
                    Object.values(stacks).forEach(data => {
                        total += calculateMetricValue(data, detailAdsetMetric);
                    });
                    adsetTotals[adset] = total;
                });
                const allSortedAdsets = Object.keys(adsetTotals).sort((a, b) => detailAdsetSortOrder === 'desc' ? adsetTotals[b] - adsetTotals[a] : adsetTotals[a] - adsetTotals[b]);
                detailAdsetTotalCount = allSortedAdsets.length;
                const limit = detailAdsetShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedAdsets = allSortedAdsets.slice(0, limit);

                // 모든 스택 값 수집
                const allStackValues = new Set();
                Object.values(stackedDataMap).forEach(stacks => {
                    Object.keys(stacks).forEach(sv => allStackValues.add(sv));
                });
                const stackValuesList = Array.from(allStackValues);

                // 스택 데이터 구조 변환
                const stackedData = {};
                stackValuesList.forEach(sv => {
                    stackedData[sv] = sortedAdsets.map(adset => {
                        if (stackedDataMap[adset] && stackedDataMap[adset][sv]) {
                            return calculateMetricValue(stackedDataMap[adset][sv], detailAdsetMetric);
                        }
                        return 0;
                    });
                });

                detailAdsetBarChart = renderDetailStackedBarChart('detailAdsetBarChart', detailAdsetBarChart, sortedAdsets, stackedData, detailAdsetMetric);
                updateDetailShowMoreButton('adset', detailAdsetTotalCount, limit, detailAdsetShowAll);
            } else {
                // 필터 없을 때: 초기화 상태 메시지 표시
                detailAdsetBarChart = renderDetailBarChart('detailAdsetBarChart', detailAdsetBarChart, [], [], detailAdsetMetric, '필터를 선택해주세요');
                updateDetailShowMoreButton('adset', 0, DETAIL_DEFAULT_LIMIT, false);
            }
        }

        // 성별 상세 필터 초기화 및 차트 렌더링
        function initDetailGenderDropdowns() {
            if (!genderDimensionData) return;

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };

            Object.keys(filterMap).forEach(filterKey => {
                const column = filterMap[filterKey];
                const uniqueValues = [...new Set(genderDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                uniqueValues.sort();

                const listId = `detailGenderFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`;
                const listContainer = document.getElementById(listId);
                if (!listContainer) return;

                listContainer.innerHTML = uniqueValues.map(value => `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="detail-gender-filter-checkbox" data-filter="${filterKey}" data-value="${value}" style="margin-right: 10px; width: 14px; height: 14px;">
                        ${value}
                    </label>
                `).join('');
            });

            document.querySelectorAll('.detail-gender-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filter = this.dataset.filter;
                    document.querySelectorAll('.detail-gender-filter-dropdown-list').forEach(list => {
                        list.style.display = list.dataset.filter === filter ? (list.style.display === 'none' ? 'block' : 'none') : 'none';
                    });
                });
            });

            const genderFilterLabels = { 'channel': '채널', 'product': '제품', 'brand': '브랜드', 'promotion': '프로모션', 'adset': '광고세트' };

            document.querySelectorAll('.detail-gender-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    const value = this.dataset.value;
                    if (this.checked) {
                        if (!detailGenderFilters[filter].includes(value)) detailGenderFilters[filter].push(value);
                    } else {
                        detailGenderFilters[filter] = detailGenderFilters[filter].filter(v => v !== value);
                    }
                    updateFilterDropdownText('.detail-gender-filter-dropdown-btn', filter, detailGenderFilters[filter], genderFilterLabels, '.detail-gender-filter-checkbox');
                    renderDetailGenderBarChart();
                });
            });

            document.querySelectorAll('.detail-gender-filter-select-all').forEach(selectAll => {
                selectAll.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    document.querySelectorAll(`.detail-gender-filter-checkbox[data-filter="${filter}"]`).forEach(cb => {
                        cb.checked = this.checked;
                        const value = cb.dataset.value;
                        if (this.checked) {
                            if (!detailGenderFilters[filter].includes(value)) detailGenderFilters[filter].push(value);
                        }
                    });
                    if (!this.checked) detailGenderFilters[filter] = [];
                    updateFilterDropdownText('.detail-gender-filter-dropdown-btn', filter, detailGenderFilters[filter], genderFilterLabels, '.detail-gender-filter-checkbox');
                    renderDetailGenderBarChart();
                });
            });
        }

        function renderDetailGenderBarChart() {
            if (!genderDimensionData) {
                detailGenderBarChart = renderDetailBarChart('detailGenderBarChart', detailGenderBarChart, [], [], detailGenderMetric, '데이터 로딩 중...');
                return;
            }

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };
            const hasActiveFilters = Object.values(detailGenderFilters).some(arr => arr.length > 0);
            const genderColumn = '성별_통합';

            // 비교 모드 처리
            if (detailGenderCompareActive && detailGenderStartDateComp && detailGenderEndDateComp) {
                const aggregateData = (startDate, endDate) => {
                    const dataMap = {};
                    genderDimensionData.forEach(row => {
                        const rawGender = row[genderColumn] || row['성별'];
                        if (!rawGender || rawGender === '' || rawGender === '-' || rawGender === 'unknown') return;

                        let matches = true;
                        Object.keys(filterMap).forEach(filterKey => {
                            const column = filterMap[filterKey];
                            const selectedValues = detailGenderFilters[filterKey];
                            if (selectedValues && selectedValues.length > 0) {
                                if (!selectedValues.includes(row[column])) matches = false;
                            }
                        });
                        if (!matches && hasActiveFilters) return;

                        const date = row['일'];
                        if (startDate || endDate) {
                            const rowDate = new Date(date);
                            if (isNaN(rowDate)) return;
                            if (startDate && rowDate < new Date(startDate)) return;
                            if (endDate && rowDate > new Date(endDate)) return;
                        }

                        if (!dataMap[rawGender]) {
                            dataMap[rawGender] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                        }
                        dataMap[rawGender].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawGender].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawGender].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawGender].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawGender].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                    });
                    return dataMap;
                };

                const mainData = aggregateData(detailGenderStartDate, detailGenderEndDate);
                const compData = aggregateData(detailGenderStartDateComp, detailGenderEndDateComp);

                const allSortedGenders = Object.keys(mainData)
                    .sort((a, b) => {
                        const valA = calculateMetricValue(mainData[a], detailGenderMetric);
                        const valB = calculateMetricValue(mainData[b], detailGenderMetric);
                        return detailGenderSortOrder === 'desc' ? valB - valA : valA - valB;
                    });

                detailGenderTotalCount = allSortedGenders.length;
                const limit = detailGenderShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedGenders = allSortedGenders.slice(0, limit);

                const labels = sortedGenders;
                const values = sortedGenders.map(g => calculateMetricValue(mainData[g] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailGenderMetric));
                const valuesComp = sortedGenders.map(g => calculateMetricValue(compData[g] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailGenderMetric));

                detailGenderBarChart = renderDetailCompareBarChart('detailGenderBarChart', detailGenderBarChart, labels, values, valuesComp, detailGenderMetric, '기준 기간', '비교 기간');
                updateDetailShowMoreButton('gender', detailGenderTotalCount, limit, detailGenderShowAll);
                return;
            }

            // 어떤 필터가 활성화되어 있는지 확인
            let activeFilterKey = null;
            let activeFilterColumn = null;
            Object.keys(filterMap).forEach(filterKey => {
                if (detailGenderFilters[filterKey] && detailGenderFilters[filterKey].length > 0) {
                    activeFilterKey = filterKey;
                    activeFilterColumn = filterMap[filterKey];
                }
            });

            if (hasActiveFilters && activeFilterKey) {
                // 누적 바 차트: 성별별로 분류기준별 데이터 집계
                const genderStackData = {};  // { '남성': { '채널A': {}, '채널B': {} }, ... }

                genderDimensionData.forEach(row => {
                    const rawGender = row[genderColumn] || row['성별'];
                    if (!rawGender || rawGender === '' || rawGender === '-' || rawGender === 'unknown') return;

                    const stackValue = row[activeFilterColumn];
                    if (!stackValue || stackValue === '' || stackValue === '-') return;
                    if (!detailGenderFilters[activeFilterKey].includes(stackValue)) return;

                    // 기간 필터링
                    const date = row['일'];
                    if (detailGenderStartDate || detailGenderEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (detailGenderStartDate && rowDate < new Date(detailGenderStartDate)) return;
                        if (detailGenderEndDate && rowDate > new Date(detailGenderEndDate)) return;
                    }

                    if (!genderStackData[rawGender]) genderStackData[rawGender] = {};
                    if (!genderStackData[rawGender][stackValue]) {
                        genderStackData[rawGender][stackValue] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                    }

                    genderStackData[rawGender][stackValue].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                    genderStackData[rawGender][stackValue].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                    genderStackData[rawGender][stackValue].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                    genderStackData[rawGender][stackValue].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                    genderStackData[rawGender][stackValue].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                });

                // 누적 바 차트 데이터 구성 - 지표 값 기준 정렬
                const genderTotals = {};
                Object.keys(genderStackData).forEach(gender => {
                    let total = 0;
                    Object.values(genderStackData[gender]).forEach(data => {
                        total += calculateMetricValue(data, detailGenderMetric);
                    });
                    genderTotals[gender] = total;
                });
                const allGenderLabels = Object.keys(genderStackData).sort((a, b) => detailGenderSortOrder === 'desc' ? genderTotals[b] - genderTotals[a] : genderTotals[a] - genderTotals[b]);
                detailGenderTotalCount = allGenderLabels.length;
                const limit = detailGenderShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const genderLabels = allGenderLabels.slice(0, limit);
                const stackLabels = detailGenderFilters[activeFilterKey];
                const stackedData = {};

                stackLabels.forEach(stackLabel => {
                    stackedData[stackLabel] = genderLabels.map(gender => {
                        const data = genderStackData[gender]?.[stackLabel];
                        return data ? calculateMetricValue(data, detailGenderMetric) : 0;
                    });
                });

                detailGenderBarChart = renderDetailStackedBarChart('detailGenderBarChart', detailGenderBarChart, genderLabels, stackedData, detailGenderMetric);
                updateDetailShowMoreButton('gender', detailGenderTotalCount, limit, detailGenderShowAll);
            } else {
                // 필터 없을 때: 초기화 상태 메시지 표시
                detailGenderBarChart = renderDetailBarChart('detailGenderBarChart', detailGenderBarChart, [], [], detailGenderMetric, '필터를 선택해주세요');
                updateDetailShowMoreButton('gender', 0, DETAIL_DEFAULT_LIMIT, false);
            }
        }

        // 연령 상세 필터 초기화 및 차트 렌더링
        function initDetailAgeDropdowns() {
            if (!ageDimensionData) return;

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };

            Object.keys(filterMap).forEach(filterKey => {
                const column = filterMap[filterKey];
                const uniqueValues = [...new Set(ageDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                uniqueValues.sort();

                const listId = `detailAgeFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`;
                const listContainer = document.getElementById(listId);
                if (!listContainer) return;

                listContainer.innerHTML = uniqueValues.map(value => `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="detail-age-filter-checkbox" data-filter="${filterKey}" data-value="${value}" style="margin-right: 10px; width: 14px; height: 14px;">
                        ${value}
                    </label>
                `).join('');
            });

            document.querySelectorAll('.detail-age-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filter = this.dataset.filter;
                    document.querySelectorAll('.detail-age-filter-dropdown-list').forEach(list => {
                        list.style.display = list.dataset.filter === filter ? (list.style.display === 'none' ? 'block' : 'none') : 'none';
                    });
                });
            });

            const ageFilterLabels = { 'channel': '채널', 'product': '제품', 'brand': '브랜드', 'promotion': '프로모션', 'adset': '광고세트' };

            document.querySelectorAll('.detail-age-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    const value = this.dataset.value;
                    if (this.checked) {
                        if (!detailAgeFilters[filter].includes(value)) detailAgeFilters[filter].push(value);
                    } else {
                        detailAgeFilters[filter] = detailAgeFilters[filter].filter(v => v !== value);
                    }
                    updateFilterDropdownText('.detail-age-filter-dropdown-btn', filter, detailAgeFilters[filter], ageFilterLabels, '.detail-age-filter-checkbox');
                    renderDetailAgeBarChart();
                });
            });

            document.querySelectorAll('.detail-age-filter-select-all').forEach(selectAll => {
                selectAll.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    document.querySelectorAll(`.detail-age-filter-checkbox[data-filter="${filter}"]`).forEach(cb => {
                        cb.checked = this.checked;
                        const value = cb.dataset.value;
                        if (this.checked) {
                            if (!detailAgeFilters[filter].includes(value)) detailAgeFilters[filter].push(value);
                        }
                    });
                    if (!this.checked) detailAgeFilters[filter] = [];
                    updateFilterDropdownText('.detail-age-filter-dropdown-btn', filter, detailAgeFilters[filter], ageFilterLabels, '.detail-age-filter-checkbox');
                    renderDetailAgeBarChart();
                });
            });
        }

        function renderDetailAgeBarChart() {
            if (!ageDimensionData) {
                detailAgeBarChart = renderDetailBarChart('detailAgeBarChart', detailAgeBarChart, [], [], detailAgeMetric, '데이터 로딩 중...');
                return;
            }

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };
            const hasActiveFilters = Object.values(detailAgeFilters).some(arr => arr.length > 0);
            const ageColumn = '연령_통합';

            // 비교 모드 처리
            if (detailAgeCompareActive && detailAgeStartDateComp && detailAgeEndDateComp) {
                const aggregateData = (startDate, endDate) => {
                    const dataMap = {};
                    ageDimensionData.forEach(row => {
                        const rawAge = row[ageColumn] || row['연령'];
                        if (!rawAge || rawAge === '' || rawAge === '-' || rawAge === 'unknown') return;

                        let matches = true;
                        Object.keys(filterMap).forEach(filterKey => {
                            const column = filterMap[filterKey];
                            const selectedValues = detailAgeFilters[filterKey];
                            if (selectedValues && selectedValues.length > 0) {
                                if (!selectedValues.includes(row[column])) matches = false;
                            }
                        });
                        if (!matches && hasActiveFilters) return;

                        const date = row['일'];
                        if (startDate || endDate) {
                            const rowDate = new Date(date);
                            if (isNaN(rowDate)) return;
                            if (startDate && rowDate < new Date(startDate)) return;
                            if (endDate && rowDate > new Date(endDate)) return;
                        }

                        if (!dataMap[rawAge]) {
                            dataMap[rawAge] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                        }
                        dataMap[rawAge].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawAge].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawAge].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawAge].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawAge].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                    });
                    return dataMap;
                };

                const mainData = aggregateData(detailAgeStartDate, detailAgeEndDate);
                const compData = aggregateData(detailAgeStartDateComp, detailAgeEndDateComp);

                const allSortedAges = Object.keys(mainData)
                    .sort((a, b) => {
                        const valA = calculateMetricValue(mainData[a], detailAgeMetric);
                        const valB = calculateMetricValue(mainData[b], detailAgeMetric);
                        return detailAgeSortOrder === 'desc' ? valB - valA : valA - valB;
                    });

                detailAgeTotalCount = allSortedAges.length;
                const limit = detailAgeShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedAges = allSortedAges.slice(0, limit);

                const labels = sortedAges;
                const values = sortedAges.map(a => calculateMetricValue(mainData[a] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailAgeMetric));
                const valuesComp = sortedAges.map(a => calculateMetricValue(compData[a] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailAgeMetric));

                detailAgeBarChart = renderDetailCompareBarChart('detailAgeBarChart', detailAgeBarChart, labels, values, valuesComp, detailAgeMetric, '기준 기간', '비교 기간');
                updateDetailShowMoreButton('age', detailAgeTotalCount, limit, detailAgeShowAll);
                return;
            }

            // 어떤 필터가 활성화되어 있는지 확인
            let activeFilterKey = null;
            let activeFilterColumn = null;
            Object.keys(filterMap).forEach(filterKey => {
                if (detailAgeFilters[filterKey] && detailAgeFilters[filterKey].length > 0) {
                    activeFilterKey = filterKey;
                    activeFilterColumn = filterMap[filterKey];
                }
            });

            if (hasActiveFilters && activeFilterKey) {
                // 누적 바 차트: 연령별로 분류기준별 데이터 집계
                const ageStackData = {};

                ageDimensionData.forEach(row => {
                    const rawAge = row[ageColumn] || row['연령'];
                    if (!rawAge || rawAge === '' || rawAge === '-' || rawAge === 'unknown') return;

                    const stackValue = row[activeFilterColumn];
                    if (!stackValue || stackValue === '' || stackValue === '-') return;
                    if (!detailAgeFilters[activeFilterKey].includes(stackValue)) return;

                    // 기간 필터링
                    const date = row['일'];
                    if (detailAgeStartDate || detailAgeEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (detailAgeStartDate && rowDate < new Date(detailAgeStartDate)) return;
                        if (detailAgeEndDate && rowDate > new Date(detailAgeEndDate)) return;
                    }

                    if (!ageStackData[rawAge]) ageStackData[rawAge] = {};
                    if (!ageStackData[rawAge][stackValue]) {
                        ageStackData[rawAge][stackValue] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                    }

                    ageStackData[rawAge][stackValue].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                    ageStackData[rawAge][stackValue].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                    ageStackData[rawAge][stackValue].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                    ageStackData[rawAge][stackValue].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                    ageStackData[rawAge][stackValue].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                });

                // 누적 바 차트 데이터 구성 - 지표 값 기준 정렬
                const ageTotals = {};
                Object.keys(ageStackData).forEach(age => {
                    let total = 0;
                    Object.values(ageStackData[age]).forEach(data => {
                        total += calculateMetricValue(data, detailAgeMetric);
                    });
                    ageTotals[age] = total;
                });
                const allAgeLabels = Object.keys(ageStackData).sort((a, b) => detailAgeSortOrder === 'desc' ? ageTotals[b] - ageTotals[a] : ageTotals[a] - ageTotals[b]);
                detailAgeTotalCount = allAgeLabels.length;
                const limit = detailAgeShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const ageLabels = allAgeLabels.slice(0, limit);
                const stackLabels = detailAgeFilters[activeFilterKey];
                const stackedData = {};

                stackLabels.forEach(stackLabel => {
                    stackedData[stackLabel] = ageLabels.map(age => {
                        const data = ageStackData[age]?.[stackLabel];
                        return data ? calculateMetricValue(data, detailAgeMetric) : 0;
                    });
                });

                detailAgeBarChart = renderDetailStackedBarChart('detailAgeBarChart', detailAgeBarChart, ageLabels, stackedData, detailAgeMetric);
                updateDetailShowMoreButton('age', detailAgeTotalCount, limit, detailAgeShowAll);
            } else {
                // 필터 없을 때: 초기화 상태 메시지 표시
                detailAgeBarChart = renderDetailBarChart('detailAgeBarChart', detailAgeBarChart, [], [], detailAgeMetric, '필터를 선택해주세요');
                updateDetailShowMoreButton('age', 0, DETAIL_DEFAULT_LIMIT, false);
            }
        }

        // 플랫폼 상세 필터 초기화 및 차트 렌더링
        function initDetailPlatformDropdowns() {
            if (!platformDimensionData) return;

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };

            Object.keys(filterMap).forEach(filterKey => {
                const column = filterMap[filterKey];
                const uniqueValues = [...new Set(platformDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                uniqueValues.sort();

                const listId = `detailPlatformFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`;
                const listContainer = document.getElementById(listId);
                if (!listContainer) return;

                listContainer.innerHTML = uniqueValues.map(value => `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="detail-platform-filter-checkbox" data-filter="${filterKey}" data-value="${value}" style="margin-right: 10px; width: 14px; height: 14px;">
                        ${value}
                    </label>
                `).join('');
            });

            document.querySelectorAll('.detail-platform-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filter = this.dataset.filter;
                    document.querySelectorAll('.detail-platform-filter-dropdown-list').forEach(list => {
                        list.style.display = list.dataset.filter === filter ? (list.style.display === 'none' ? 'block' : 'none') : 'none';
                    });
                });
            });

            const platformFilterLabels = { 'channel': '채널', 'product': '제품', 'brand': '브랜드', 'promotion': '프로모션', 'adset': '광고세트' };

            document.querySelectorAll('.detail-platform-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    const value = this.dataset.value;
                    if (this.checked) {
                        if (!detailPlatformFilters[filter].includes(value)) detailPlatformFilters[filter].push(value);
                    } else {
                        detailPlatformFilters[filter] = detailPlatformFilters[filter].filter(v => v !== value);
                    }
                    updateFilterDropdownText('.detail-platform-filter-dropdown-btn', filter, detailPlatformFilters[filter], platformFilterLabels, '.detail-platform-filter-checkbox');
                    renderDetailPlatformBarChart();
                });
            });

            document.querySelectorAll('.detail-platform-filter-select-all').forEach(selectAll => {
                selectAll.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    document.querySelectorAll(`.detail-platform-filter-checkbox[data-filter="${filter}"]`).forEach(cb => {
                        cb.checked = this.checked;
                        const value = cb.dataset.value;
                        if (this.checked) {
                            if (!detailPlatformFilters[filter].includes(value)) detailPlatformFilters[filter].push(value);
                        }
                    });
                    if (!this.checked) detailPlatformFilters[filter] = [];
                    updateFilterDropdownText('.detail-platform-filter-dropdown-btn', filter, detailPlatformFilters[filter], platformFilterLabels, '.detail-platform-filter-checkbox');
                    renderDetailPlatformBarChart();
                });
            });
        }

        function renderDetailPlatformBarChart() {
            if (!platformDimensionData) {
                detailPlatformBarChart = renderDetailBarChart('detailPlatformBarChart', detailPlatformBarChart, [], [], detailPlatformMetric, '데이터 로딩 중...');
                return;
            }

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };
            const hasActiveFilters = Object.values(detailPlatformFilters).some(arr => arr.length > 0);
            const platformColumn = '플랫폼_통합';

            // 비교 모드 처리
            if (detailPlatformCompareActive && detailPlatformStartDateComp && detailPlatformEndDateComp) {
                const aggregateData = (startDate, endDate) => {
                    const dataMap = {};
                    platformDimensionData.forEach(row => {
                        const rawPlatform = row[platformColumn] || row['플랫폼'];
                        if (!rawPlatform || rawPlatform === '' || rawPlatform === '-' || rawPlatform === 'unknown') return;

                        let matches = true;
                        Object.keys(filterMap).forEach(filterKey => {
                            const column = filterMap[filterKey];
                            const selectedValues = detailPlatformFilters[filterKey];
                            if (selectedValues && selectedValues.length > 0) {
                                if (!selectedValues.includes(row[column])) matches = false;
                            }
                        });
                        if (!matches && hasActiveFilters) return;

                        const date = row['일'];
                        if (startDate || endDate) {
                            const rowDate = new Date(date);
                            if (isNaN(rowDate)) return;
                            if (startDate && rowDate < new Date(startDate)) return;
                            if (endDate && rowDate > new Date(endDate)) return;
                        }

                        if (!dataMap[rawPlatform]) {
                            dataMap[rawPlatform] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                        }
                        dataMap[rawPlatform].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawPlatform].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawPlatform].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawPlatform].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawPlatform].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                    });
                    return dataMap;
                };

                const mainData = aggregateData(detailPlatformStartDate, detailPlatformEndDate);
                const compData = aggregateData(detailPlatformStartDateComp, detailPlatformEndDateComp);

                const allSortedPlatforms = Object.keys(mainData)
                    .sort((a, b) => {
                        const valA = calculateMetricValue(mainData[a], detailPlatformMetric);
                        const valB = calculateMetricValue(mainData[b], detailPlatformMetric);
                        return detailPlatformSortOrder === 'desc' ? valB - valA : valA - valB;
                    });

                detailPlatformTotalCount = allSortedPlatforms.length;
                const limit = detailPlatformShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedPlatforms = allSortedPlatforms.slice(0, limit);

                const labels = sortedPlatforms;
                const values = sortedPlatforms.map(p => calculateMetricValue(mainData[p] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailPlatformMetric));
                const valuesComp = sortedPlatforms.map(p => calculateMetricValue(compData[p] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailPlatformMetric));

                detailPlatformBarChart = renderDetailCompareBarChart('detailPlatformBarChart', detailPlatformBarChart, labels, values, valuesComp, detailPlatformMetric, '기준 기간', '비교 기간');
                updateDetailShowMoreButton('platform', detailPlatformTotalCount, limit, detailPlatformShowAll);
                return;
            }

            // 어떤 필터가 활성화되어 있는지 확인
            let activeFilterKey = null;
            let activeFilterColumn = null;
            Object.keys(filterMap).forEach(filterKey => {
                if (detailPlatformFilters[filterKey] && detailPlatformFilters[filterKey].length > 0) {
                    activeFilterKey = filterKey;
                    activeFilterColumn = filterMap[filterKey];
                }
            });

            if (hasActiveFilters && activeFilterKey) {
                // 누적 바 차트
                const platformStackData = {};

                platformDimensionData.forEach(row => {
                    const rawPlatform = row[platformColumn] || row['플랫폼'];
                    if (!rawPlatform || rawPlatform === '' || rawPlatform === '-' || rawPlatform === 'unknown') return;

                    const stackValue = row[activeFilterColumn];
                    if (!stackValue || stackValue === '' || stackValue === '-') return;
                    if (!detailPlatformFilters[activeFilterKey].includes(stackValue)) return;

                    const date = row['일'];
                    if (detailPlatformStartDate || detailPlatformEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (detailPlatformStartDate && rowDate < new Date(detailPlatformStartDate)) return;
                        if (detailPlatformEndDate && rowDate > new Date(detailPlatformEndDate)) return;
                    }

                    if (!platformStackData[rawPlatform]) platformStackData[rawPlatform] = {};
                    if (!platformStackData[rawPlatform][stackValue]) {
                        platformStackData[rawPlatform][stackValue] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                    }

                    platformStackData[rawPlatform][stackValue].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                    platformStackData[rawPlatform][stackValue].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                    platformStackData[rawPlatform][stackValue].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                    platformStackData[rawPlatform][stackValue].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                    platformStackData[rawPlatform][stackValue].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                });

                // 지표 값 기준 정렬
                const platformTotals = {};
                Object.keys(platformStackData).forEach(platform => {
                    let total = 0;
                    Object.values(platformStackData[platform]).forEach(data => {
                        total += calculateMetricValue(data, detailPlatformMetric);
                    });
                    platformTotals[platform] = total;
                });
                const allPlatformLabels = Object.keys(platformStackData).sort((a, b) => detailPlatformSortOrder === 'desc' ? platformTotals[b] - platformTotals[a] : platformTotals[a] - platformTotals[b]);
                detailPlatformTotalCount = allPlatformLabels.length;
                const limit = detailPlatformShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const platformLabels = allPlatformLabels.slice(0, limit);
                const stackLabels = detailPlatformFilters[activeFilterKey];
                const stackedData = {};

                stackLabels.forEach(stackLabel => {
                    stackedData[stackLabel] = platformLabels.map(platform => {
                        const data = platformStackData[platform]?.[stackLabel];
                        return data ? calculateMetricValue(data, detailPlatformMetric) : 0;
                    });
                });

                detailPlatformBarChart = renderDetailStackedBarChart('detailPlatformBarChart', detailPlatformBarChart, platformLabels, stackedData, detailPlatformMetric);
                updateDetailShowMoreButton('platform', detailPlatformTotalCount, limit, detailPlatformShowAll);
            } else {
                // 필터 없을 때: 초기화 상태 메시지 표시
                detailPlatformBarChart = renderDetailBarChart('detailPlatformBarChart', detailPlatformBarChart, [], [], detailPlatformMetric, '필터를 선택해주세요');
                updateDetailShowMoreButton('platform', 0, DETAIL_DEFAULT_LIMIT, false);
            }
        }

        // 기기플랫폼 상세 필터 초기화 및 차트 렌더링
        function initDetailDevicePlatformDropdowns() {
            if (!devicePlatformDimensionData) return;

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };

            Object.keys(filterMap).forEach(filterKey => {
                const column = filterMap[filterKey];
                const uniqueValues = [...new Set(devicePlatformDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                uniqueValues.sort();

                const listId = `detailDevicePlatformFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`;
                const listContainer = document.getElementById(listId);
                if (!listContainer) return;

                listContainer.innerHTML = uniqueValues.map(value => `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="detail-device-platform-filter-checkbox" data-filter="${filterKey}" data-value="${value}" style="margin-right: 10px; width: 14px; height: 14px;">
                        ${value}
                    </label>
                `).join('');
            });

            document.querySelectorAll('.detail-device-platform-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filter = this.dataset.filter;
                    document.querySelectorAll('.detail-device-platform-filter-dropdown-list').forEach(list => {
                        list.style.display = list.dataset.filter === filter ? (list.style.display === 'none' ? 'block' : 'none') : 'none';
                    });
                });
            });

            const devicePlatformFilterLabels = { 'channel': '채널', 'product': '제품', 'brand': '브랜드', 'promotion': '프로모션', 'adset': '광고세트' };

            document.querySelectorAll('.detail-device-platform-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    const value = this.dataset.value;
                    if (this.checked) {
                        if (!detailDevicePlatformFilters[filter].includes(value)) detailDevicePlatformFilters[filter].push(value);
                    } else {
                        detailDevicePlatformFilters[filter] = detailDevicePlatformFilters[filter].filter(v => v !== value);
                    }
                    updateFilterDropdownText('.detail-device-platform-filter-dropdown-btn', filter, detailDevicePlatformFilters[filter], devicePlatformFilterLabels, '.detail-device-platform-filter-checkbox');
                    renderDetailDevicePlatformBarChart();
                });
            });

            document.querySelectorAll('.detail-device-platform-filter-select-all').forEach(selectAll => {
                selectAll.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    document.querySelectorAll(`.detail-device-platform-filter-checkbox[data-filter="${filter}"]`).forEach(cb => {
                        cb.checked = this.checked;
                        const value = cb.dataset.value;
                        if (this.checked) {
                            if (!detailDevicePlatformFilters[filter].includes(value)) detailDevicePlatformFilters[filter].push(value);
                        }
                    });
                    if (!this.checked) detailDevicePlatformFilters[filter] = [];
                    updateFilterDropdownText('.detail-device-platform-filter-dropdown-btn', filter, detailDevicePlatformFilters[filter], devicePlatformFilterLabels, '.detail-device-platform-filter-checkbox');
                    renderDetailDevicePlatformBarChart();
                });
            });
        }

        function renderDetailDevicePlatformBarChart() {
            if (!devicePlatformDimensionData) {
                detailDevicePlatformBarChart = renderDetailBarChart('detailDevicePlatformBarChart', detailDevicePlatformBarChart, [], [], detailDevicePlatformMetric, '데이터를 로드 중...');
                return;
            }

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };
            const hasActiveFilters = Object.values(detailDevicePlatformFilters).some(arr => arr.length > 0);
            const devicePlatformColumn = '기기플랫폼_통합';

            // 비교 모드 처리
            console.log('Device-Platform Compare Mode:', detailDevicePlatformCompareActive, 'Comp dates:', detailDevicePlatformStartDateComp, '~', detailDevicePlatformEndDateComp);
            console.log('Main period dates:', detailDevicePlatformStartDate, '~', detailDevicePlatformEndDate);
            console.log('devicePlatformDimensionData count:', devicePlatformDimensionData ? devicePlatformDimensionData.length : 0);
            if (detailDevicePlatformCompareActive && detailDevicePlatformStartDateComp && detailDevicePlatformEndDateComp) {
                console.log('Entering compare mode rendering');
                const aggregateData = (startDate, endDate) => {
                    console.log('Aggregating data for period:', startDate, '~', endDate);
                    const dataMap = {};
                    let rowCount = 0;
                    devicePlatformDimensionData.forEach(row => {
                        const rawDP = row[devicePlatformColumn] || row['기기플랫폼'];
                        if (!rawDP || rawDP === '' || rawDP === '-') return;

                        let matches = true;
                        Object.keys(filterMap).forEach(filterKey => {
                            const column = filterMap[filterKey];
                            const selectedValues = detailDevicePlatformFilters[filterKey];
                            if (selectedValues && selectedValues.length > 0) {
                                if (!selectedValues.includes(row[column])) matches = false;
                            }
                        });
                        if (!matches && hasActiveFilters) return;

                        const date = row['일'];
                        if (startDate || endDate) {
                            const rowDate = new Date(date);
                            if (isNaN(rowDate)) return;
                            if (startDate && rowDate < new Date(startDate)) return;
                            if (endDate && rowDate > new Date(endDate)) return;
                        }

                        if (!dataMap[rawDP]) {
                            dataMap[rawDP] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                        }
                        dataMap[rawDP].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDP].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDP].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDP].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDP].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                        rowCount++;
                    });
                    console.log('Total rows aggregated:', rowCount);
                    return dataMap;
                };

                const mainData = aggregateData(detailDevicePlatformStartDate, detailDevicePlatformEndDate);
                const compData = aggregateData(detailDevicePlatformStartDateComp, detailDevicePlatformEndDateComp);
                console.log('Main data keys:', Object.keys(mainData), 'Comp data keys:', Object.keys(compData));
                console.log('Main data:', JSON.stringify(mainData));
                console.log('Comp data:', JSON.stringify(compData));

                const allSortedDPs = Object.keys(mainData)
                    .sort((a, b) => {
                        const valA = calculateMetricValue(mainData[a], detailDevicePlatformMetric);
                        const valB = calculateMetricValue(mainData[b], detailDevicePlatformMetric);
                        return detailDevicePlatformSortOrder === 'desc' ? valB - valA : valA - valB;
                    });

                detailDevicePlatformTotalCount = allSortedDPs.length;
                const limit = detailDevicePlatformShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedDPs = allSortedDPs.slice(0, limit);

                const labels = sortedDPs;
                const values = sortedDPs.map(dp => calculateMetricValue(mainData[dp] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailDevicePlatformMetric));
                const valuesComp = sortedDPs.map(dp => calculateMetricValue(compData[dp] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailDevicePlatformMetric));
                console.log('Labels:', labels);
                console.log('Values (main):', values);
                console.log('Values (comp):', valuesComp);

                detailDevicePlatformBarChart = renderDetailCompareBarChart('detailDevicePlatformBarChart', detailDevicePlatformBarChart, labels, values, valuesComp, detailDevicePlatformMetric, '기준 기간', '비교 기간');
                updateDetailShowMoreButton('devicePlatform', detailDevicePlatformTotalCount, limit, detailDevicePlatformShowAll);
                return;
            }

            // 활성화된 필터 찾기
            let activeFilterKey = null;
            let activeFilterValues = [];
            for (const [key, values] of Object.entries(detailDevicePlatformFilters)) {
                if (values && values.length > 0) {
                    activeFilterKey = key;
                    activeFilterValues = values;
                    break;
                }
            }

            if (hasActiveFilters && activeFilterKey) {
                // 스택 바 차트: 필터 분류 기준별로 그룹화
                const stackedDataMap = {}; // { devicePlatform: { stackValue: {metrics} } }

                devicePlatformDimensionData.forEach(row => {
                    const rawDevicePlatform = row[devicePlatformColumn] || row['기기플랫폼'];
                    if (!rawDevicePlatform || rawDevicePlatform === '' || rawDevicePlatform === '-') return;

                    // 필터 매칭 확인
                    let matches = true;
                    Object.keys(filterMap).forEach(filterKey => {
                        const column = filterMap[filterKey];
                        const selectedValues = detailDevicePlatformFilters[filterKey];
                        if (selectedValues && selectedValues.length > 0) {
                            if (!selectedValues.includes(row[column])) matches = false;
                        }
                    });
                    if (!matches) return;

                    const date = row['일'];
                    if (detailDevicePlatformStartDate || detailDevicePlatformEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (detailDevicePlatformStartDate && rowDate < new Date(detailDevicePlatformStartDate)) return;
                        if (detailDevicePlatformEndDate && rowDate > new Date(detailDevicePlatformEndDate)) return;
                    }

                    const stackValue = row[filterMap[activeFilterKey]] || '기타';

                    if (!stackedDataMap[rawDevicePlatform]) {
                        stackedDataMap[rawDevicePlatform] = {};
                    }
                    if (!stackedDataMap[rawDevicePlatform][stackValue]) {
                        stackedDataMap[rawDevicePlatform][stackValue] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                    }

                    stackedDataMap[rawDevicePlatform][stackValue].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDevicePlatform][stackValue].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDevicePlatform][stackValue].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDevicePlatform][stackValue].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDevicePlatform][stackValue].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                });

                // 기기플랫폼 합계로 정렬
                const devicePlatformTotals = {};
                Object.entries(stackedDataMap).forEach(([dp, stacks]) => {
                    let total = 0;
                    Object.values(stacks).forEach(data => {
                        total += calculateMetricValue(data, detailDevicePlatformMetric);
                    });
                    devicePlatformTotals[dp] = total;
                });
                const allSortedDevicePlatforms = Object.keys(devicePlatformTotals).sort((a, b) => detailDevicePlatformSortOrder === 'desc' ? devicePlatformTotals[b] - devicePlatformTotals[a] : devicePlatformTotals[a] - devicePlatformTotals[b]);
                detailDevicePlatformTotalCount = allSortedDevicePlatforms.length;
                const limit = detailDevicePlatformShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedDevicePlatforms = allSortedDevicePlatforms.slice(0, limit);

                // 모든 스택 값 수집
                const allStackValues = new Set();
                Object.values(stackedDataMap).forEach(stacks => {
                    Object.keys(stacks).forEach(sv => allStackValues.add(sv));
                });
                const stackValuesList = Array.from(allStackValues);

                // 스택 데이터 구조 변환
                const stackedData = {};
                stackValuesList.forEach(sv => {
                    stackedData[sv] = sortedDevicePlatforms.map(dp => {
                        if (stackedDataMap[dp] && stackedDataMap[dp][sv]) {
                            return calculateMetricValue(stackedDataMap[dp][sv], detailDevicePlatformMetric);
                        }
                        return 0;
                    });
                });

                detailDevicePlatformBarChart = renderDetailStackedBarChart('detailDevicePlatformBarChart', detailDevicePlatformBarChart, sortedDevicePlatforms, stackedData, detailDevicePlatformMetric);
                updateDetailShowMoreButton('devicePlatform', detailDevicePlatformTotalCount, limit, detailDevicePlatformShowAll);
            } else {
                // 필터 없을 때: 초기화 상태 메시지 표시
                detailDevicePlatformBarChart = renderDetailBarChart('detailDevicePlatformBarChart', detailDevicePlatformBarChart, [], [], detailDevicePlatformMetric, '필터를 선택해주세요');
                updateDetailShowMoreButton('devicePlatform', 0, DETAIL_DEFAULT_LIMIT, false);
            }
        }

        // 기기 상세 필터 초기화 및 차트 렌더링
        function initDetailDeviceTypeDropdowns() {
            if (!deviceTypeDimensionData) return;

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };

            Object.keys(filterMap).forEach(filterKey => {
                const column = filterMap[filterKey];
                const uniqueValues = [...new Set(deviceTypeDimensionData.map(row => row[column]).filter(v => v && v !== '' && v !== '-'))];
                uniqueValues.sort();

                const listId = `detailDeviceTypeFilter${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}List`;
                const listContainer = document.getElementById(listId);
                if (!listContainer) return;

                listContainer.innerHTML = uniqueValues.map(value => `
                    <label style="display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="detail-device-type-filter-checkbox" data-filter="${filterKey}" data-value="${value}" style="margin-right: 10px; width: 14px; height: 14px;">
                        ${value}
                    </label>
                `).join('');
            });

            document.querySelectorAll('.detail-device-type-filter-dropdown-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const filter = this.dataset.filter;
                    document.querySelectorAll('.detail-device-type-filter-dropdown-list').forEach(list => {
                        list.style.display = list.dataset.filter === filter ? (list.style.display === 'none' ? 'block' : 'none') : 'none';
                    });
                });
            });

            const deviceTypeFilterLabels = { 'channel': '채널', 'product': '제품', 'brand': '브랜드', 'promotion': '프로모션', 'adset': '광고세트' };

            document.querySelectorAll('.detail-device-type-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    const value = this.dataset.value;
                    if (this.checked) {
                        if (!detailDeviceTypeFilters[filter].includes(value)) detailDeviceTypeFilters[filter].push(value);
                    } else {
                        detailDeviceTypeFilters[filter] = detailDeviceTypeFilters[filter].filter(v => v !== value);
                    }
                    updateFilterDropdownText('.detail-device-type-filter-dropdown-btn', filter, detailDeviceTypeFilters[filter], deviceTypeFilterLabels, '.detail-device-type-filter-checkbox');
                    renderDetailDeviceTypeBarChart();
                });
            });

            document.querySelectorAll('.detail-device-type-filter-select-all').forEach(selectAll => {
                selectAll.addEventListener('change', function() {
                    const filter = this.dataset.filter;
                    document.querySelectorAll(`.detail-device-type-filter-checkbox[data-filter="${filter}"]`).forEach(cb => {
                        cb.checked = this.checked;
                        const value = cb.dataset.value;
                        if (this.checked) {
                            if (!detailDeviceTypeFilters[filter].includes(value)) detailDeviceTypeFilters[filter].push(value);
                        }
                    });
                    if (!this.checked) detailDeviceTypeFilters[filter] = [];
                    updateFilterDropdownText('.detail-device-type-filter-dropdown-btn', filter, detailDeviceTypeFilters[filter], deviceTypeFilterLabels, '.detail-device-type-filter-checkbox');
                    renderDetailDeviceTypeBarChart();
                });
            });
        }

        function renderDetailDeviceTypeBarChart() {
            if (!deviceTypeDimensionData) {
                detailDeviceTypeBarChart = renderDetailBarChart('detailDeviceTypeBarChart', detailDeviceTypeBarChart, [], [], detailDeviceTypeMetric, '데이터를 로드 중...');
                return;
            }

            const filterMap = { 'channel': '유형구분', 'product': '상품명', 'brand': '브랜드명', 'promotion': '프로모션', 'adset': '광고세트' };
            const hasActiveFilters = Object.values(detailDeviceTypeFilters).some(arr => arr.length > 0);
            const deviceTypeColumn = '기기유형_통합';

            // 비교 모드 처리
            if (detailDeviceTypeCompareActive && detailDeviceTypeStartDateComp && detailDeviceTypeEndDateComp) {
                const aggregateData = (startDate, endDate) => {
                    const dataMap = {};
                    deviceTypeDimensionData.forEach(row => {
                        const rawDT = row[deviceTypeColumn] || row['기기유형'];
                        if (!rawDT || rawDT === '' || rawDT === '-') return;

                        let matches = true;
                        Object.keys(filterMap).forEach(filterKey => {
                            const column = filterMap[filterKey];
                            const selectedValues = detailDeviceTypeFilters[filterKey];
                            if (selectedValues && selectedValues.length > 0) {
                                if (!selectedValues.includes(row[column])) matches = false;
                            }
                        });
                        if (!matches && hasActiveFilters) return;

                        const date = row['일'];
                        if (startDate || endDate) {
                            const rowDate = new Date(date);
                            if (isNaN(rowDate)) return;
                            if (startDate && rowDate < new Date(startDate)) return;
                            if (endDate && rowDate > new Date(endDate)) return;
                        }

                        if (!dataMap[rawDT]) {
                            dataMap[rawDT] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                        }
                        dataMap[rawDT].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDT].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDT].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDT].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                        dataMap[rawDT].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                    });
                    return dataMap;
                };

                const mainData = aggregateData(detailDeviceTypeStartDate, detailDeviceTypeEndDate);
                const compData = aggregateData(detailDeviceTypeStartDateComp, detailDeviceTypeEndDateComp);

                const allSortedDTs = Object.keys(mainData)
                    .sort((a, b) => {
                        const valA = calculateMetricValue(mainData[a], detailDeviceTypeMetric);
                        const valB = calculateMetricValue(mainData[b], detailDeviceTypeMetric);
                        return detailDeviceTypeSortOrder === 'desc' ? valB - valA : valA - valB;
                    });

                detailDeviceTypeTotalCount = allSortedDTs.length;
                const limit = detailDeviceTypeShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedDTs = allSortedDTs.slice(0, limit);

                const labels = sortedDTs;
                const values = sortedDTs.map(dt => calculateMetricValue(mainData[dt] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailDeviceTypeMetric));
                const valuesComp = sortedDTs.map(dt => calculateMetricValue(compData[dt] || {cost:0,revenue:0,conversions:0,impressions:0,clicks:0}, detailDeviceTypeMetric));

                detailDeviceTypeBarChart = renderDetailCompareBarChart('detailDeviceTypeBarChart', detailDeviceTypeBarChart, labels, values, valuesComp, detailDeviceTypeMetric, '기준 기간', '비교 기간');
                updateDetailShowMoreButton('deviceType', detailDeviceTypeTotalCount, limit, detailDeviceTypeShowAll);
                return;
            }

            // 활성화된 필터 찾기
            let activeFilterKey = null;
            let activeFilterValues = [];
            for (const [key, values] of Object.entries(detailDeviceTypeFilters)) {
                if (values && values.length > 0) {
                    activeFilterKey = key;
                    activeFilterValues = values;
                    break;
                }
            }

            if (hasActiveFilters && activeFilterKey) {
                // 스택 바 차트: 필터 분류 기준별로 그룹화
                const stackedDataMap = {}; // { deviceType: { stackValue: {metrics} } }

                deviceTypeDimensionData.forEach(row => {
                    const rawDeviceType = row[deviceTypeColumn] || row['기기유형'];
                    if (!rawDeviceType || rawDeviceType === '' || rawDeviceType === '-') return;

                    // 필터 매칭 확인
                    let matches = true;
                    Object.keys(filterMap).forEach(filterKey => {
                        const column = filterMap[filterKey];
                        const selectedValues = detailDeviceTypeFilters[filterKey];
                        if (selectedValues && selectedValues.length > 0) {
                            if (!selectedValues.includes(row[column])) matches = false;
                        }
                    });
                    if (!matches) return;

                    const date = row['일'];
                    if (detailDeviceTypeStartDate || detailDeviceTypeEndDate) {
                        const rowDate = new Date(date);
                        if (isNaN(rowDate)) return;
                        if (detailDeviceTypeStartDate && rowDate < new Date(detailDeviceTypeStartDate)) return;
                        if (detailDeviceTypeEndDate && rowDate > new Date(detailDeviceTypeEndDate)) return;
                    }

                    const stackValue = row[filterMap[activeFilterKey]] || '기타';

                    if (!stackedDataMap[rawDeviceType]) {
                        stackedDataMap[rawDeviceType] = {};
                    }
                    if (!stackedDataMap[rawDeviceType][stackValue]) {
                        stackedDataMap[rawDeviceType][stackValue] = { cost: 0, revenue: 0, conversions: 0, impressions: 0, clicks: 0 };
                    }

                    stackedDataMap[rawDeviceType][stackValue].cost += parseFloat(row['비용']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDeviceType][stackValue].revenue += parseFloat(row['전환값']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDeviceType][stackValue].conversions += parseFloat(row['전환수']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDeviceType][stackValue].impressions += parseFloat(row['노출']?.toString().replace(/,/g, '') || 0) || 0;
                    stackedDataMap[rawDeviceType][stackValue].clicks += parseFloat(row['클릭']?.toString().replace(/,/g, '') || 0) || 0;
                });

                // 기기유형 합계로 정렬
                const deviceTypeTotals = {};
                Object.entries(stackedDataMap).forEach(([dt, stacks]) => {
                    let total = 0;
                    Object.values(stacks).forEach(data => {
                        total += calculateMetricValue(data, detailDeviceTypeMetric);
                    });
                    deviceTypeTotals[dt] = total;
                });
                const allSortedDeviceTypes = Object.keys(deviceTypeTotals).sort((a, b) => detailDeviceTypeSortOrder === 'desc' ? deviceTypeTotals[b] - deviceTypeTotals[a] : deviceTypeTotals[a] - deviceTypeTotals[b]);
                detailDeviceTypeTotalCount = allSortedDeviceTypes.length;
                const limit = detailDeviceTypeShowAll ? DETAIL_EXPANDED_LIMIT : DETAIL_DEFAULT_LIMIT;
                const sortedDeviceTypes = allSortedDeviceTypes.slice(0, limit);

                // 모든 스택 값 수집
                const allStackValues = new Set();
                Object.values(stackedDataMap).forEach(stacks => {
                    Object.keys(stacks).forEach(sv => allStackValues.add(sv));
                });
                const stackValuesList = Array.from(allStackValues);

                // 스택 데이터 구조 변환
                const stackedData = {};
                stackValuesList.forEach(sv => {
                    stackedData[sv] = sortedDeviceTypes.map(dt => {
                        if (stackedDataMap[dt] && stackedDataMap[dt][sv]) {
                            return calculateMetricValue(stackedDataMap[dt][sv], detailDeviceTypeMetric);
                        }
                        return 0;
                    });
                });

                detailDeviceTypeBarChart = renderDetailStackedBarChart('detailDeviceTypeBarChart', detailDeviceTypeBarChart, sortedDeviceTypes, stackedData, detailDeviceTypeMetric);
                updateDetailShowMoreButton('deviceType', detailDeviceTypeTotalCount, limit, detailDeviceTypeShowAll);
            } else {
                // 필터 없을 때: 초기화 상태 메시지 표시
                detailDeviceTypeBarChart = renderDetailBarChart('detailDeviceTypeBarChart', detailDeviceTypeBarChart, [], [], detailDeviceTypeMetric, '필터를 선택해주세요');
                updateDetailShowMoreButton('deviceType', 0, DETAIL_DEFAULT_LIMIT, false);
            }
        }

        // 성과 비교 분석 탭 전환 이벤트 설정
        function setupDetailAnalysisTabEvents() {
            document.querySelectorAll('.detail-analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.detail-analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.detail-analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    const tabMap = {
                        'detail-adset': 'detailAdsetTab',
                        'detail-gender': 'detailGenderTab',
                        'detail-age': 'detailAgeTab',
                        'detail-platform': 'detailPlatformTab',
                        'detail-device-platform': 'detailDevicePlatformTab',
                        'detail-device-type': 'detailDeviceTypeTab'
                    };

                    const selectedTab = document.getElementById(tabMap[targetTab]);
                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });

            // 지표 드롭다운 이벤트
            const metricDropdowns = [
                { id: 'detailAdsetMetricDropdown', varName: 'detailAdsetMetric', renderFn: renderDetailAdsetBarChart },
                { id: 'detailGenderMetricDropdown', varName: 'detailGenderMetric', renderFn: renderDetailGenderBarChart },
                { id: 'detailAgeMetricDropdown', varName: 'detailAgeMetric', renderFn: renderDetailAgeBarChart },
                { id: 'detailPlatformMetricDropdown', varName: 'detailPlatformMetric', renderFn: renderDetailPlatformBarChart },
                { id: 'detailDevicePlatformMetricDropdown', varName: 'detailDevicePlatformMetric', renderFn: renderDetailDevicePlatformBarChart },
                { id: 'detailDeviceTypeMetricDropdown', varName: 'detailDeviceTypeMetric', renderFn: renderDetailDeviceTypeBarChart }
            ];

            metricDropdowns.forEach(({ id, varName, renderFn }) => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    dropdown.addEventListener('change', function() {
                        window[varName] = this.value;
                        if (varName === 'detailAdsetMetric') detailAdsetMetric = this.value;
                        else if (varName === 'detailGenderMetric') detailGenderMetric = this.value;
                        else if (varName === 'detailAgeMetric') detailAgeMetric = this.value;
                        else if (varName === 'detailPlatformMetric') detailPlatformMetric = this.value;
                        else if (varName === 'detailDevicePlatformMetric') detailDevicePlatformMetric = this.value;
                        else if (varName === 'detailDeviceTypeMetric') detailDeviceTypeMetric = this.value;
                        renderFn();
                    });
                }
            });

            // 정렬 드롭다운 이벤트
            const sortDropdowns = [
                { id: 'detailAdsetSortDropdown', varName: 'detailAdsetSortOrder', renderFn: renderDetailAdsetBarChart },
                { id: 'detailGenderSortDropdown', varName: 'detailGenderSortOrder', renderFn: renderDetailGenderBarChart },
                { id: 'detailAgeSortDropdown', varName: 'detailAgeSortOrder', renderFn: renderDetailAgeBarChart },
                { id: 'detailPlatformSortDropdown', varName: 'detailPlatformSortOrder', renderFn: renderDetailPlatformBarChart },
                { id: 'detailDevicePlatformSortDropdown', varName: 'detailDevicePlatformSortOrder', renderFn: renderDetailDevicePlatformBarChart },
                { id: 'detailDeviceTypeSortDropdown', varName: 'detailDeviceTypeSortOrder', renderFn: renderDetailDeviceTypeBarChart }
            ];

            sortDropdowns.forEach(({ id, varName, renderFn }) => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    dropdown.addEventListener('change', function() {
                        if (varName === 'detailAdsetSortOrder') detailAdsetSortOrder = this.value;
                        else if (varName === 'detailGenderSortOrder') detailGenderSortOrder = this.value;
                        else if (varName === 'detailAgeSortOrder') detailAgeSortOrder = this.value;
                        else if (varName === 'detailPlatformSortOrder') detailPlatformSortOrder = this.value;
                        else if (varName === 'detailDevicePlatformSortOrder') detailDevicePlatformSortOrder = this.value;
                        else if (varName === 'detailDeviceTypeSortOrder') detailDeviceTypeSortOrder = this.value;
                        renderFn();
                    });
                }
            });

            // 날짜 입력 이벤트
            const dateInputs = [
                { startId: 'detailAdsetStartDate', endId: 'detailAdsetEndDate', startVar: 'detailAdsetStartDate', endVar: 'detailAdsetEndDate', renderFn: renderDetailAdsetBarChart },
                { startId: 'detailGenderStartDate', endId: 'detailGenderEndDate', startVar: 'detailGenderStartDate', endVar: 'detailGenderEndDate', renderFn: renderDetailGenderBarChart },
                { startId: 'detailAgeStartDate', endId: 'detailAgeEndDate', startVar: 'detailAgeStartDate', endVar: 'detailAgeEndDate', renderFn: renderDetailAgeBarChart },
                { startId: 'detailPlatformStartDate', endId: 'detailPlatformEndDate', startVar: 'detailPlatformStartDate', endVar: 'detailPlatformEndDate', renderFn: renderDetailPlatformBarChart },
                { startId: 'detailDevicePlatformStartDate', endId: 'detailDevicePlatformEndDate', startVar: 'detailDevicePlatformStartDate', endVar: 'detailDevicePlatformEndDate', renderFn: renderDetailDevicePlatformBarChart },
                { startId: 'detailDeviceTypeStartDate', endId: 'detailDeviceTypeEndDate', startVar: 'detailDeviceTypeStartDate', endVar: 'detailDeviceTypeEndDate', renderFn: renderDetailDeviceTypeBarChart }
            ];

            dateInputs.forEach(({ startId, endId, startVar, endVar, renderFn }) => {
                const startInput = document.getElementById(startId);
                const endInput = document.getElementById(endId);
                if (startInput) {
                    startInput.addEventListener('change', function() {
                        if (startVar === 'detailAdsetStartDate') detailAdsetStartDate = this.value;
                        else if (startVar === 'detailGenderStartDate') detailGenderStartDate = this.value;
                        else if (startVar === 'detailAgeStartDate') detailAgeStartDate = this.value;
                        else if (startVar === 'detailPlatformStartDate') detailPlatformStartDate = this.value;
                        else if (startVar === 'detailDevicePlatformStartDate') detailDevicePlatformStartDate = this.value;
                        else if (startVar === 'detailDeviceTypeStartDate') detailDeviceTypeStartDate = this.value;
                        renderFn();
                    });
                }
                if (endInput) {
                    endInput.addEventListener('change', function() {
                        if (endVar === 'detailAdsetEndDate') detailAdsetEndDate = this.value;
                        else if (endVar === 'detailGenderEndDate') detailGenderEndDate = this.value;
                        else if (endVar === 'detailAgeEndDate') detailAgeEndDate = this.value;
                        else if (endVar === 'detailPlatformEndDate') detailPlatformEndDate = this.value;
                        else if (endVar === 'detailDevicePlatformEndDate') detailDevicePlatformEndDate = this.value;
                        else if (endVar === 'detailDeviceTypeEndDate') detailDeviceTypeEndDate = this.value;
                        renderFn();
                    });
                }
            });

            // 성과 비교 분석 - 기간 선택 프리셋 이벤트
            document.querySelectorAll('.detail-period-preset').forEach(preset => {
                preset.addEventListener('change', function() {
                    const tab = this.getAttribute('data-tab');
                    const days = parseInt(this.value);
                    if (!days) return;

                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - days + 1);

                    const formatDate = (d) => {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };

                    const startStr = formatDate(startDate);
                    const endStr = formatDate(endDate);

                    const startInput = document.querySelector(`.detail-start-date[data-tab="${tab}"]`);
                    const endInput = document.querySelector(`.detail-end-date[data-tab="${tab}"]`);

                    if (startInput) startInput.value = startStr;
                    if (endInput) endInput.value = endStr;

                    // 변수 업데이트 및 차트 렌더링
                    if (tab === 'adset') { detailAdsetStartDate = startStr; detailAdsetEndDate = endStr; renderDetailAdsetBarChart(); }
                    else if (tab === 'gender') { detailGenderStartDate = startStr; detailGenderEndDate = endStr; renderDetailGenderBarChart(); }
                    else if (tab === 'age') { detailAgeStartDate = startStr; detailAgeEndDate = endStr; renderDetailAgeBarChart(); }
                    else if (tab === 'platform') { detailPlatformStartDate = startStr; detailPlatformEndDate = endStr; renderDetailPlatformBarChart(); }
                    else if (tab === 'device-platform') { detailDevicePlatformStartDate = startStr; detailDevicePlatformEndDate = endStr; renderDetailDevicePlatformBarChart(); }
                    else if (tab === 'device-type') { detailDeviceTypeStartDate = startStr; detailDeviceTypeEndDate = endStr; renderDetailDeviceTypeBarChart(); }
                });
            });

            // 성과 비교 분석 - 비교 기간 프리셋 이벤트
            document.querySelectorAll('.detail-period-preset-comp').forEach(preset => {
                preset.addEventListener('change', function() {
                    const tab = this.getAttribute('data-tab');
                    const days = parseInt(this.value);
                    if (!days) return;

                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - days + 1);

                    const formatDate = (d) => {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };

                    const startStr = formatDate(startDate);
                    const endStr = formatDate(endDate);

                    const startInput = document.querySelector(`.detail-start-date-comp[data-tab="${tab}"]`);
                    const endInput = document.querySelector(`.detail-end-date-comp[data-tab="${tab}"]`);

                    if (startInput) startInput.value = startStr;
                    if (endInput) endInput.value = endStr;

                    // 상태 변수 업데이트
                    if (tab === 'adset') { detailAdsetStartDateComp = startStr; detailAdsetEndDateComp = endStr; }
                    else if (tab === 'gender') { detailGenderStartDateComp = startStr; detailGenderEndDateComp = endStr; }
                    else if (tab === 'age') { detailAgeStartDateComp = startStr; detailAgeEndDateComp = endStr; }
                    else if (tab === 'platform') { detailPlatformStartDateComp = startStr; detailPlatformEndDateComp = endStr; }
                    else if (tab === 'device-platform') { detailDevicePlatformStartDateComp = startStr; detailDevicePlatformEndDateComp = endStr; }
                    else if (tab === 'device-type') { detailDeviceTypeStartDateComp = startStr; detailDeviceTypeEndDateComp = endStr; }

                    // 차트 다시 렌더링
                    if (tab === 'adset') renderDetailAdsetBarChart();
                    else if (tab === 'gender') renderDetailGenderBarChart();
                    else if (tab === 'age') renderDetailAgeBarChart();
                    else if (tab === 'platform') renderDetailPlatformBarChart();
                    else if (tab === 'device-platform') renderDetailDevicePlatformBarChart();
                    else if (tab === 'device-type') renderDetailDeviceTypeBarChart();
                });
            });

            // 성과 비교 분석 - 날짜 수동 입력 시 프리셋 초기화
            document.querySelectorAll('.detail-start-date, .detail-end-date').forEach(input => {
                input.addEventListener('change', function() {
                    const tab = this.getAttribute('data-tab');
                    const preset = document.querySelector(`.detail-period-preset[data-tab="${tab}"]`);
                    if (preset) preset.value = '';
                });
            });

            document.querySelectorAll('.detail-start-date-comp, .detail-end-date-comp').forEach(input => {
                input.addEventListener('change', function() {
                    const tab = this.getAttribute('data-tab');
                    const preset = document.querySelector(`.detail-period-preset-comp[data-tab="${tab}"]`);
                    if (preset) preset.value = '';

                    // 상태 변수 업데이트
                    const isStartDate = this.classList.contains('detail-start-date-comp');
                    if (isStartDate) {
                        if (tab === 'adset') detailAdsetStartDateComp = this.value;
                        else if (tab === 'gender') detailGenderStartDateComp = this.value;
                        else if (tab === 'age') detailAgeStartDateComp = this.value;
                        else if (tab === 'platform') detailPlatformStartDateComp = this.value;
                        else if (tab === 'device-platform') detailDevicePlatformStartDateComp = this.value;
                        else if (tab === 'device-type') detailDeviceTypeStartDateComp = this.value;
                    } else {
                        if (tab === 'adset') detailAdsetEndDateComp = this.value;
                        else if (tab === 'gender') detailGenderEndDateComp = this.value;
                        else if (tab === 'age') detailAgeEndDateComp = this.value;
                        else if (tab === 'platform') detailPlatformEndDateComp = this.value;
                        else if (tab === 'device-platform') detailDevicePlatformEndDateComp = this.value;
                        else if (tab === 'device-type') detailDeviceTypeEndDateComp = this.value;
                    }

                    // 차트 다시 렌더링
                    if (tab === 'adset') renderDetailAdsetBarChart();
                    else if (tab === 'gender') renderDetailGenderBarChart();
                    else if (tab === 'age') renderDetailAgeBarChart();
                    else if (tab === 'platform') renderDetailPlatformBarChart();
                    else if (tab === 'device-platform') renderDetailDevicePlatformBarChart();
                    else if (tab === 'device-type') renderDetailDeviceTypeBarChart();
                });
            });

            // 성과 비교 분석 - 비교 버튼 이벤트
            document.querySelectorAll('.detail-compare-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    const compareRow = document.querySelector(`.detail-compare-row[data-tab="${tab}"]`);

                    // 상태 토글
                    let isActivating = false;
                    if (tab === 'adset') { detailAdsetCompareActive = !detailAdsetCompareActive; isActivating = detailAdsetCompareActive; }
                    else if (tab === 'gender') { detailGenderCompareActive = !detailGenderCompareActive; isActivating = detailGenderCompareActive; }
                    else if (tab === 'age') { detailAgeCompareActive = !detailAgeCompareActive; isActivating = detailAgeCompareActive; }
                    else if (tab === 'platform') { detailPlatformCompareActive = !detailPlatformCompareActive; isActivating = detailPlatformCompareActive; }
                    else if (tab === 'device-platform') { detailDevicePlatformCompareActive = !detailDevicePlatformCompareActive; isActivating = detailDevicePlatformCompareActive; }
                    else if (tab === 'device-type') { detailDeviceTypeCompareActive = !detailDeviceTypeCompareActive; isActivating = detailDeviceTypeCompareActive; }

                    if (compareRow) {
                        compareRow.style.display = isActivating ? 'flex' : 'none';

                        // 버튼 스타일 토글
                        if (isActivating) {
                            this.textContent = '취소';
                            this.style.background = '#d32f2f';
                            this.style.color = 'white';
                            this.style.borderColor = '#d32f2f';

                            // 비교 기간 자동 설정 (기준 기간의 이전 기간)
                            const startInput = document.querySelector(`.detail-start-date[data-tab="${tab}"]`);
                            const endInput = document.querySelector(`.detail-end-date[data-tab="${tab}"]`);

                            if (startInput && endInput && startInput.value && endInput.value) {
                                const startDate = new Date(startInput.value);
                                const endDate = new Date(endInput.value);
                                const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                                const compEndDate = new Date(startDate);
                                compEndDate.setDate(compEndDate.getDate() - 1);
                                const compStartDate = new Date(compEndDate);
                                compStartDate.setDate(compStartDate.getDate() - duration + 1);

                                const formatDate = (d) => {
                                    const year = d.getFullYear();
                                    const month = String(d.getMonth() + 1).padStart(2, '0');
                                    const day = String(d.getDate()).padStart(2, '0');
                                    return `${year}-${month}-${day}`;
                                };

                                const compStartStr = formatDate(compStartDate);
                                const compEndStr = formatDate(compEndDate);

                                const compStartInput = document.querySelector(`.detail-start-date-comp[data-tab="${tab}"]`);
                                const compEndInput = document.querySelector(`.detail-end-date-comp[data-tab="${tab}"]`);

                                if (compStartInput) compStartInput.value = compStartStr;
                                if (compEndInput) compEndInput.value = compEndStr;

                                // 상태 변수 업데이트
                                if (tab === 'adset') { detailAdsetStartDateComp = compStartStr; detailAdsetEndDateComp = compEndStr; }
                                else if (tab === 'gender') { detailGenderStartDateComp = compStartStr; detailGenderEndDateComp = compEndStr; }
                                else if (tab === 'age') { detailAgeStartDateComp = compStartStr; detailAgeEndDateComp = compEndStr; }
                                else if (tab === 'platform') { detailPlatformStartDateComp = compStartStr; detailPlatformEndDateComp = compEndStr; }
                                else if (tab === 'device-platform') { detailDevicePlatformStartDateComp = compStartStr; detailDevicePlatformEndDateComp = compEndStr; }
                                else if (tab === 'device-type') { detailDeviceTypeStartDateComp = compStartStr; detailDeviceTypeEndDateComp = compEndStr; }
                            }
                        } else {
                            this.textContent = '비교';
                            this.style.background = 'white';
                            this.style.color = '#673ab7';
                            this.style.borderColor = '#673ab7';

                            // 비교 기간 초기화
                            if (tab === 'adset') { detailAdsetStartDateComp = ''; detailAdsetEndDateComp = ''; }
                            else if (tab === 'gender') { detailGenderStartDateComp = ''; detailGenderEndDateComp = ''; }
                            else if (tab === 'age') { detailAgeStartDateComp = ''; detailAgeEndDateComp = ''; }
                            else if (tab === 'platform') { detailPlatformStartDateComp = ''; detailPlatformEndDateComp = ''; }
                            else if (tab === 'device-platform') { detailDevicePlatformStartDateComp = ''; detailDevicePlatformEndDateComp = ''; }
                            else if (tab === 'device-type') { detailDeviceTypeStartDateComp = ''; detailDeviceTypeEndDateComp = ''; }
                        }
                    }

                    // 차트 다시 렌더링
                    if (tab === 'adset') renderDetailAdsetBarChart();
                    else if (tab === 'gender') renderDetailGenderBarChart();
                    else if (tab === 'age') renderDetailAgeBarChart();
                    else if (tab === 'platform') renderDetailPlatformBarChart();
                    else if (tab === 'device-platform') renderDetailDevicePlatformBarChart();
                    else if (tab === 'device-type') renderDetailDeviceTypeBarChart();
                });
            });

            // 성과 비교 분석 - 더보기/접기 버튼 이벤트
            document.querySelectorAll('.detail-show-more-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');

                    // 상태 토글
                    if (tab === 'adset') {
                        detailAdsetShowAll = !detailAdsetShowAll;
                        renderDetailAdsetBarChart();
                    } else if (tab === 'gender') {
                        detailGenderShowAll = !detailGenderShowAll;
                        renderDetailGenderBarChart();
                    } else if (tab === 'age') {
                        detailAgeShowAll = !detailAgeShowAll;
                        renderDetailAgeBarChart();
                    } else if (tab === 'platform') {
                        detailPlatformShowAll = !detailPlatformShowAll;
                        renderDetailPlatformBarChart();
                    } else if (tab === 'devicePlatform') {
                        detailDevicePlatformShowAll = !detailDevicePlatformShowAll;
                        renderDetailDevicePlatformBarChart();
                    } else if (tab === 'deviceType') {
                        detailDeviceTypeShowAll = !detailDeviceTypeShowAll;
                        renderDetailDeviceTypeBarChart();
                    }
                });
            });
        }

        // 성과 비교 분석 초기화 함수
        function initDetailAnalysis() {
            initDetailAdsetDropdowns();
            initDetailGenderDropdowns();
            initDetailAgeDropdowns();
            initDetailPlatformDropdowns();
            initDetailDevicePlatformDropdowns();
            initDetailDeviceTypeDropdowns();
            setupDetailAnalysisTabEvents();

            // 기본 날짜 설정 (데이터에서 min/max 날짜 추출)
            setDetailAnalysisDefaultDates();

            // 초기 차트 렌더링
            renderDetailAdsetBarChart();
            renderDetailGenderBarChart();
            renderDetailAgeBarChart();
            renderDetailPlatformBarChart();
            renderDetailDevicePlatformBarChart();
            renderDetailDeviceTypeBarChart();
        }

        // 성과 비교 분석 기본 날짜 설정
        function setDetailAnalysisDefaultDates() {
            // 데이터에서 날짜 범위 추출 (adsetDimensionData 사용)
            const sourceData = adsetDimensionData || genderDimensionData || ageDimensionData || platformDimensionData || devicePlatformDimensionData || deviceTypeDimensionData;
            if (!sourceData || sourceData.length === 0) return;

            const dates = sourceData.map(row => new Date(row['일'])).filter(d => !isNaN(d));
            if (dates.length === 0) return;

            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));

            const formatDateForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const minDateStr = formatDateForInput(minDate);
            const maxDateStr = formatDateForInput(maxDate);

            // 각 탭의 날짜 입력 필드 설정
            const dateInputs = [
                { startId: 'detailAdsetStartDate', endId: 'detailAdsetEndDate', setStart: (v) => { detailAdsetStartDate = v; }, setEnd: (v) => { detailAdsetEndDate = v; } },
                { startId: 'detailGenderStartDate', endId: 'detailGenderEndDate', setStart: (v) => { detailGenderStartDate = v; }, setEnd: (v) => { detailGenderEndDate = v; } },
                { startId: 'detailAgeStartDate', endId: 'detailAgeEndDate', setStart: (v) => { detailAgeStartDate = v; }, setEnd: (v) => { detailAgeEndDate = v; } },
                { startId: 'detailPlatformStartDate', endId: 'detailPlatformEndDate', setStart: (v) => { detailPlatformStartDate = v; }, setEnd: (v) => { detailPlatformEndDate = v; } },
                { startId: 'detailDevicePlatformStartDate', endId: 'detailDevicePlatformEndDate', setStart: (v) => { detailDevicePlatformStartDate = v; }, setEnd: (v) => { detailDevicePlatformEndDate = v; } },
                { startId: 'detailDeviceTypeStartDate', endId: 'detailDeviceTypeEndDate', setStart: (v) => { detailDeviceTypeStartDate = v; }, setEnd: (v) => { detailDeviceTypeEndDate = v; } }
            ];

            dateInputs.forEach(({ startId, endId, setStart, setEnd }) => {
                const startInput = document.getElementById(startId);
                const endInput = document.getElementById(endId);
                if (startInput) {
                    startInput.value = minDateStr;
                    setStart(minDateStr);
                }
                if (endInput) {
                    endInput.value = maxDateStr;
                    setEnd(maxDateStr);
                }
            });
        }

        window.addEventListener('DOMContentLoaded', loadData);
    
    })();
    </script>

    <!-- ========== 퍼널 대시보드 스크립트 (funnel_dashboard.html) ========== -->
    <script>
    (function() {
        // funnel 페이지 스크립트
        
        // 전역 변수
        let dailyData = [];
        let weeklyData = [];
        let channelData = [];
        let newVsReturningData = [];
        let channelEngagementData = [];
        let newVsReturningConversionData = [];
        let insightsData = null;
        let currentPeriod = 'full';  // 데이터 기반 의사결정 도구 기간 필터
        let insightPeriod = 'full'; // 인사이트 & 채널 전략 기간 필터 (독립)
        let microSegmentPeriod = 'full'; // 유형별 조치 가이드 기간 필터 (독립)

        // 현재 선택된 기간의 데이터 반환 (데이터 기반 의사결정 도구용)
        function getPeriodData() {
            if (!insightsData || !insightsData.by_period) {
                return insightsData;  // 이전 구조 호환
            }
            return insightsData.by_period[currentPeriod] || insightsData.by_period['full'];
        }

        // 인사이트 & 채널 전략 섹션용 기간 데이터 반환
        function getInsightPeriodData() {
            if (!insightsData || !insightsData.by_period) {
                return insightsData;  // 이전 구조 호환
            }
            return insightsData.by_period[insightPeriod] || insightsData.by_period['full'];
        }

        // 유형별 조치 가이드 섹션용 기간 데이터 반환
        function getMicroSegmentPeriodData() {
            if (!insightsData || !insightsData.by_period) {
                return insightsData;  // 이전 구조 호환
            }
            return insightsData.by_period[microSegmentPeriod] || insightsData.by_period['full'];
        }

        // 이탈 분석 데이터 (전체 기간만 사용)
        function getChurnData() {
            if (!insightsData) return null;
            return insightsData.churn_analysis || {
                churn_predictions_7d: [],
                churn_predictions_30d: [],
                improvement_predictions_7d: [],
                improvement_predictions_30d: [],
                crm_actions: []
            };
        }
        let newVsReturningView = 'monthly';
        let currentKpiType = 'cvr';
        let currentChurnStage = 'avg';
        let currentChurnSort = 'desc';
        let currentChannelFunnel = 'purchase';

        // 테이블 정렬 상태
        let channelTableSort = {
            column: '유입',
            direction: 'desc'  // 'asc' 또는 'desc'
        };

        // Chart.js 인스턴스 (D3 퍼널은 재생성 방식 사용)
        let channelKpiChart = null;
        let channelChurnChart = null;
        let channelCompareChart = null;
        let campaignChart = null;
        let newVsReturningChart = null;
        let returnRateTrendChart = null;
        let customerTrendChart = null; // 통합 신규/재방문 추세 차트
        let newVsReturningConversionChart = null;
        let channelMatrixChart = null;
        let channelEngagementChart = null;

        // 숫자 포맷
        function formatNumber(num) {
            if (num === 0 || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString('ko-KR');
        }

        // 소수점 포맷
        function formatDecimal(num) {
            if (num === 0 || num === null || num === undefined || !isFinite(num)) return '0';
            return num.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }

        // CSV 파싱 (RFC 4180 호환)
        function parseCSV(text, filename = 'unknown') {
            console.log(`=== parseCSV 시작: ${filename} ===`);

            // BOM (Byte Order Mark) 제거
            const originalFirstChar = text.charCodeAt(0);
            text = text.replace(/^\uFEFF/, '');

            if (originalFirstChar === 0xFEFF) {
                console.log('BOM 문자 제거됨');
            }

            const lines = text.trim().split('\n');
            console.log(`총 라인 수: ${lines.length}`);

            // RFC 4180 호환 CSV 파싱
            function parseLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // 연속된 따옴표는 이스케이프된 따옴표
                            current += '"';
                            i++; // 다음 따옴표 건너뛰기
                        } else {
                            // 따옴표 시작/종료
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 따옴표 밖의 쉼표는 구분자
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                // 마지막 필드 추가
                result.push(current);
                return result;
            }

            const headers = parseLine(lines[0]);
            console.log('원본 헤더:', headers);

            const cleanHeaders = headers.map(h => h.replace(/^\uFEFF/, '').trim());
            console.log('정리된 헤더:', cleanHeaders);

            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseLine(lines[i]);
                if (values.length === cleanHeaders.length) {
                    const row = {};
                    cleanHeaders.forEach((header, index) => {
                        row[header] = values[index].trim();
                    });
                    data.push(row);
                }
            }

            console.log(`파싱된 데이터 행 수: ${data.length}`);
            if (data.length > 0) {
                console.log('첫 번째 행 데이터:', data[0]);

                const allKeys = Object.keys(data[0]);
                console.log('첫 번째 행의 모든 키 (' + allKeys.length + '개):', allKeys);

                // 각 키를 개별적으로 출력하여 정확한 필드명 확인
                console.log('=== 필드명 상세 분석 ===');
                allKeys.forEach((key, index) => {
                    console.log(`  [${index}] "${key}" (길이: ${key.length}, 값 샘플: "${data[0][key]}")`);
                });

                // 날짜 필드 확인
                const dateFields = ['Day', 'week', 'date', 'Date', '일자'];
                const foundDateField = dateFields.find(field => data[0][field] !== undefined);
                if (foundDateField) {
                    console.log(`✓ 날짜 필드 발견: "${foundDateField}" = "${data[0][foundDateField]}"`);
                } else {
                    console.warn('❌ 날짜 필드를 찾을 수 없습니다!');
                    console.warn('찾으려고 시도한 필드명:', dateFields);
                    console.warn('실제 존재하는 필드명:', allKeys);

                    // 유사한 필드명 찾기
                    const similarFields = allKeys.filter(key =>
                        key.toLowerCase().includes('day') ||
                        key.toLowerCase().includes('week') ||
                        key.toLowerCase().includes('date') ||
                        key.includes('일자')
                    );
                    if (similarFields.length > 0) {
                        console.log('⚠️ 유사한 필드명 발견:', similarFields);
                    }
                }

                console.log('마지막 행 데이터:', data[data.length - 1]);
            } else {
                console.warn('파싱된 데이터가 없습니다!');
            }

            console.log(`=== parseCSV 완료: ${filename} ===\n`);
            return data;
        }

        // 데이터 로드
        async function loadData() {
            console.log('========================================');
            console.log('=== 데이터 로드 시작 ===');
            console.log('========================================\n');

            try {
                // 채널별 일별 데이터 (singleFunnelView, compareFunnelView용)
                console.log('채널별 일별 데이터 로딩 중...');
                const dailyResponse = await fetch('funnel/channel_daily_funnel.csv');
                const dailyText = await dailyResponse.text();
                dailyData = parseCSV(dailyText, 'channel_daily_funnel.csv');
                console.log(`✓ 채널별 일별 데이터 로드 완료: ${dailyData.length}개 행\n`);

                // 주별 데이터
                console.log('주별 데이터 로딩 중...');
                const weeklyResponse = await fetch('funnel/weekly_funnel.csv');
                const weeklyText = await weeklyResponse.text();
                weeklyData = parseCSV(weeklyText, 'weekly_funnel.csv');
                console.log(`✓ 주별 데이터 로드 완료: ${weeklyData.length}개 행\n`);

                // 채널별 데이터
                const channelResponse = await fetch('funnel/channel_funnel.csv');
                const channelText = await channelResponse.text();
                channelData = parseCSV(channelText, 'channel_funnel.csv');

                // 신규 vs 재방문
                const newVsReturningResponse = await fetch('funnel/new_vs_returning.csv');
                const newVsReturningText = await newVsReturningResponse.text();
                newVsReturningData = parseCSV(newVsReturningText, 'new_vs_returning.csv');

                // 채널 참여도 데이터
                const channelEngagementResponse = await fetch('funnel/channel_engagement.csv');
                const channelEngagementText = await channelEngagementResponse.text();
                channelEngagementData = parseCSV(channelEngagementText, 'channel_engagement.csv');

                // 신규 vs 재방문 전환율 데이터
                const newVsReturningConversionResponse = await fetch('funnel/new_vs_returning_conversion.csv');
                const newVsReturningConversionText = await newVsReturningConversionResponse.text();
                newVsReturningConversionData = parseCSV(newVsReturningConversionText, 'new_vs_returning_conversion.csv');

                // 인사이트
                const insightsResponse = await fetch('funnel/insights.json');
                insightsData = await insightsResponse.json();

                console.log('========================================');
                console.log('=== 모든 데이터 로드 완료 ===');
                console.log(`일별 데이터: ${dailyData.length}개`);
                console.log(`주별 데이터: ${weeklyData.length}개`);
                console.log(`채널 참여도 데이터: ${channelEngagementData.length}개`);
                console.log(`신규 vs 재방문 전환율 데이터: ${newVsReturningConversionData.length}개`);
                console.log('========================================\n');

                updateDashboard();
            } catch (error) {
                console.error('❌ 데이터 로드 실패:', error);
            }
        }

        // 대시보드 업데이트
        function updateDashboard() {
            console.log('========================================');
            console.log('=== updateDashboard 호출 ===');
            console.log(`dailyData: ${dailyData.length}개, weeklyData: ${weeklyData.length}개`);
            console.log('========================================\n');

            updateAnalysisPeriod();
            updateSummaryCardBanner();
            updateKPISummary();
            updateFunnelChart();
            updateInsights();
            updateUrgentAlerts();
            updateMicroSegmentAlerts();
            setupTrendPeriodButtons();
            updateTrendPeriodIndicator('7d');
            renderPerformanceTrends('7d');
            updateAdvancedAnalysis();
            updateKpiChart('cvr');
            updateChurnChart();
            updateCompareChart();
            updateCampaignChart('purchase');
            updateCustomerTrendChart();
            updateNewVsReturningConversionChart();
            updateChannelMatrixChart();
            updateChannelEngagementChart();
            updateChannelTable();
            updatePeriodDateRange();
            updateInsightPeriodDateRange();
            updateMicroSegmentPeriodDateRange();
        }

        // 기간 전환 함수
        function switchPeriod(period) {
            currentPeriod = period;

            // 버튼 스타일 업데이트
            document.querySelectorAll('.period-filter-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                    btn.classList.remove('active');
                }
            });

            // 날짜 범위 표시 업데이트
            updatePeriodDateRange();

            // 기간 필터가 적용되는 모든 탭 다시 렌더링
            updateInsights();
            updateUrgentAlerts();
            updateAdvancedAnalysis();
        }

        // 인사이트 & 채널 전략 섹션 전용 기간 전환 함수
        function switchInsightPeriod(period) {
            insightPeriod = period;

            // 버튼 스타일 업데이트 (기간 필터 버튼과 동일한 디자인)
            document.querySelectorAll('.insight-period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                    btn.classList.remove('active');
                }
            });

            // 날짜 범위 표시 업데이트
            updateInsightPeriodDateRange();

            // 인사이트 & 채널 전략 섹션만 다시 렌더링
            updateInsights();
            updateUrgentAlerts();
        }

        // 인사이트 섹션 날짜 범위 표시
        function updateInsightPeriodDateRange() {
            const periodData = getInsightPeriodData();
            if (periodData && periodData.overall && periodData.overall.current_period) {
                const { start_date, end_date } = periodData.overall.current_period;
                const dateRangeEl = document.getElementById('insightPeriodDateRange');
                if (dateRangeEl) {
                    const start = new Date(start_date);
                    const end = new Date(end_date);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    dateRangeEl.textContent = `${start_date} ~ ${end_date} (${diffDays}일)`;
                }
            }
        }

        // 유형별 조치 가이드 섹션 전용 기간 전환 함수
        function switchMicroSegmentPeriod(period) {
            microSegmentPeriod = period;

            // 버튼 스타일 업데이트
            document.querySelectorAll('.micro-segment-period-btn').forEach(btn => {
                if (btn.dataset.period === period) {
                    btn.style.background = '#673ab7';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#673ab7';
                    btn.classList.add('active');
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                    btn.style.borderColor = '#dee2e6';
                    btn.classList.remove('active');
                }
            });

            // 날짜 범위 표시 업데이트
            updateMicroSegmentPeriodDateRange();

            // 유형별 조치 가이드 섹션만 다시 렌더링
            updateMicroSegmentAlerts();
        }

        // 유형별 조치 가이드 섹션 날짜 범위 표시
        function updateMicroSegmentPeriodDateRange() {
            const periodData = getMicroSegmentPeriodData();
            if (periodData && periodData.overall && periodData.overall.current_period) {
                const { start_date, end_date } = periodData.overall.current_period;
                const dateRangeEl = document.getElementById('microSegmentPeriodDateRange');
                if (dateRangeEl) {
                    const start = new Date(start_date);
                    const end = new Date(end_date);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    dateRangeEl.textContent = `${start_date} ~ ${end_date} (${diffDays}일)`;
                }
            }
        }

        // 선택된 기간의 날짜 범위 표시
        function updatePeriodDateRange() {
            const periodData = getPeriodData();
            if (periodData && periodData.overall && periodData.overall.current_period) {
                const { start_date, end_date } = periodData.overall.current_period;
                const dateRangeEl = document.getElementById('periodDateRange');
                if (dateRangeEl) {
                    // 일수 계산
                    const start = new Date(start_date);
                    const end = new Date(end_date);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    dateRangeEl.textContent = `${start_date} ~ ${end_date} (${diffDays}일)`;
                }
            }
        }

        // 분석 기간 업데이트
        function updateAnalysisPeriod() {
            const periodData = getPeriodData();
            if (!periodData || !periodData.overall) return;

            const { start_date, end_date } = periodData.overall.current_period;
            document.getElementById('analysisPeriod').textContent = `(${start_date} ~ ${end_date})`;
        }

        // summary_card 배너 업데이트
        function updateSummaryCardBanner() {
            const periodData = getPeriodData();
            if (!periodData || !periodData.summary_card) return;

            const banner = document.getElementById('summaryCardBanner');
            const card = periodData.summary_card;

            document.getElementById('summaryCardTitle').textContent = card.title || '이번 달 성과 요약';
            document.getElementById('summaryCardMessage').textContent = card.status_message || '';
            document.getElementById('summaryCardVisitors').textContent = card.visitors_text || '-';
            document.getElementById('summaryCardPurchasers').textContent = card.purchasers_text || '-';
            document.getElementById('summaryCardCVR').textContent = card.cvr_text || '-';

            banner.style.display = 'block';
        }

        // urgent_alerts 섹션 업데이트 (micro_segment_alerts 통합 버전)
        let urgentAlertsData = { high: [], medium: [] };
        let urgentAlertsExpanded = { high: false, medium: false };

        function updateUrgentAlerts() {
            const periodData = getPeriodData();

            // micro_segment_alerts에서 problem 유형만 필터링 (urgent_alerts 대체)
            const microAlerts = periodData?.micro_segment_alerts || [];
            const problemAlerts = microAlerts
                .filter(a => a.type === 'problem')
                .sort((a, b) => (b.urgency_score || 0) - (a.urgency_score || 0));  // 긴급도 순 정렬

            // 심각도별로 그룹화 (critical/high -> high, medium -> medium)
            urgentAlertsData.high = problemAlerts.filter(a => ['critical', 'high'].includes(a.severity));
            urgentAlertsData.medium = problemAlerts.filter(a => a.severity === 'medium');

            // 탭 카운트 업데이트
            const totalCount = problemAlerts.length;
            const urgentTotalEl = document.getElementById('urgentTotalCount');
            if (urgentTotalEl) {
                urgentTotalEl.textContent = totalCount > 0 ? `(${totalCount}건)` : '';
            }

            const highCountEl = document.getElementById('highAlertCount');
            const mediumCountEl = document.getElementById('mediumAlertCount');
            if (highCountEl) highCountEl.textContent = `(${urgentAlertsData.high.length}건)`;
            if (mediumCountEl) mediumCountEl.textContent = `(${urgentAlertsData.medium.length}건)`;

            // 카드 렌더링
            renderUrgentAlertCards('high');
            renderUrgentAlertCards('medium');

            // 서브탭 버튼 이벤트 등록
            document.querySelectorAll('.urgent-alert-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;

                    // 버튼 활성화 상태 변경
                    document.querySelectorAll('.urgent-alert-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // 탭 컨텐츠 표시/숨김
                    document.querySelectorAll('.urgent-alert-tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(targetTab + 'AlertsTab').style.display = 'block';
                });
            });
        }

        function renderUrgentAlertCards(type) {
            const alerts = urgentAlertsData[type];
            const cardsContainer = document.getElementById(type + 'AlertsCards');
            const toggleContainer = document.getElementById(type + 'AlertsToggleContainer');
            const toggleBtn = document.getElementById(type + 'AlertsToggleBtn');
            const isExpanded = urgentAlertsExpanded[type];
            const displayCount = isExpanded ? alerts.length : 3;

            // severity별 스타일
            const severityStyles = {
                critical: { bgColor: '#ffebee', borderColor: '#f44336', textColor: '#c62828' },
                high: { bgColor: '#fff3e0', borderColor: '#ff9800', textColor: '#e65100' },
                medium: { bgColor: '#fff8e1', borderColor: '#ffc107', textColor: '#f57f17' }
            };

            // 세그먼트 타입별 아이콘
            const subTypeIcons = {
                'traffic_leak': '🚿',
                'hidden_vip': '💎',
                'checkout_friction': '🛒',
                'growth_engine': '🚀',
                'activation_drop': '🚪',
                'engagement_gap': '📉',
                'silent_majority': '😶'
            };

            // 메트릭스 배지 생성 함수
            const renderMetricsBadges = (metrics) => {
                if (!metrics) return '';
                const colorMap = {
                    '유입→활동': { color: '#1565c0', border: '#90caf9' },
                    '활동→관심': { color: '#1565c0', border: '#90caf9' },
                    '관심→구매': { color: '#1565c0', border: '#90caf9' },
                    '전환율': { color: '#2e7d32', border: '#a5d6a7' },
                    'CVR': { color: '#2e7d32', border: '#a5d6a7' },
                    '유입': { color: '#5e35b1', border: '#b39ddb' },
                    '활동': { color: '#5e35b1', border: '#b39ddb' },
                    '관심': { color: '#5e35b1', border: '#b39ddb' },
                    'RPV': { color: '#e65100', border: '#ffcc80' }
                };
                const percentKeys1 = ['유입→활동', '활동→관심', '관심→구매'];
                const percentKeys2 = ['전환율', 'CVR'];
                return Object.entries(metrics).map(([k, v]) => {
                    let formatted;
                    if (percentKeys2.includes(k)) {
                        formatted = (typeof v === 'number' ? v.toFixed(2) : v) + '%';
                    } else if (percentKeys1.includes(k)) {
                        formatted = (typeof v === 'number' ? v.toFixed(1) : v) + '%';
                    } else {
                        formatted = typeof v === 'number' ? v.toLocaleString() : v;
                    }
                    const s = colorMap[k] || { color: '#616161', border: '#bdbdbd' };
                    return '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: ' + s.color + '; border: 1px solid ' + s.border + '; font-weight: 500;">' + k + ' ' + formatted + '</span>';
                }).join('');
            };

            if (alerts.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--grey-500);">
                        ${type === 'high' ? '즉시 조치가 필요한 항목이 없습니다.' : '개선 권장 항목이 없습니다.'}
                    </div>
                `;
                toggleContainer.style.display = 'none';
                return;
            }

            cardsContainer.innerHTML = alerts.slice(0, displayCount).map(alert => {
                const style = severityStyles[alert.severity] || severityStyles.medium;
                const icon = subTypeIcons[alert.sub_type] || '⚠️';
                const diagnosis = alert.diagnosis || alert.reason || '';
                const impact = alert.impact || {};
                const actionDetail = alert.action_detail || {};
                const urgencyScore = alert.urgency_score || 0;
                const urgencyLabel = urgencyScore >= 70 ? '긴급' : urgencyScore >= 40 ? '주의' : '참고';

                return `
                <div style="background: ${style.bgColor}; border: 2px solid ${style.borderColor}; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <!-- 헤더 -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 18px;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; font-weight: 700; color: ${style.textColor};">${alert.title}</div>
                            <div style="font-size: 10px; color: ${style.textColor}; opacity: 0.8;">${alert.category || '일반'} > ${alert.sub_type || '분석'}</div>
                        </div>
                        ${urgencyScore > 0 ? '<span style="background: ' + style.borderColor + '; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">' + urgencyLabel + ' ' + urgencyScore + '</span>' : ''}
                    </div>
                    <!-- 메트릭스 배지 -->
                    ${alert.metrics ? '<div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">' + renderMetricsBadges(alert.metrics) + '</div>' : ''}
                    <!-- 진단 (체크마크 스타일) -->
                    ${diagnosis ? `
                        <div style="font-size: 11px; color: #555; line-height: 1.6; margin-bottom: 10px;">
                            <div style="display: flex; align-items: flex-start; gap: 6px;">
                                <span style="color: ${style.borderColor};">✓</span>
                                <span>${diagnosis}</span>
                            </div>
                        </div>
                    ` : ''}
                    <!-- 추천 액션 -->
                    <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.borderColor};">
                        <div style="font-size: 10px; font-weight: 600; color: ${style.textColor}; margin-bottom: 4px;">💡 추천 액션</div>
                        <div style="font-size: 11px; color: #333; line-height: 1.4;">${actionDetail.primary || alert.action || '데이터 분석 후 대응 방안을 수립하세요.'}</div>
                        ${actionDetail.secondary ? '<div style="font-size: 10px; color: #5e35b1; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #d1c4e9; line-height: 1.4;">➕ ' + actionDetail.secondary + '</div>' : ''}
                        ${(impact.lost_users || impact.potential_revenue) ? '<div style="font-size: 10px; color: #c62828; margin-top: 6px;">📉 영향: ' + (impact.lost_users ? '이탈 ' + impact.lost_users + '명' : '') + (impact.potential_revenue ? ' · 잠재 손실 ₩' + impact.potential_revenue.toLocaleString() : '') + '</div>' : ''}
                    </div>
                </div>
            `}).join('');

            // 접기/펼치기 버튼 처리
            if (alerts.length > 3) {
                toggleContainer.style.display = 'block';
                const hiddenCount = alerts.length - 3;
                toggleBtn.textContent = isExpanded ? '접기' : `더 보기 (${hiddenCount}건)`;

                // 이벤트 리스너 재등록 (중복 방지를 위해 클론 후 교체)
                const newBtn = toggleBtn.cloneNode(true);
                toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);
                newBtn.addEventListener('click', function() {
                    urgentAlertsExpanded[type] = !urgentAlertsExpanded[type];
                    renderUrgentAlertCards(type);
                });
            } else {
                toggleContainer.style.display = 'none';
            }
        }

        // ========================================
        // 마이크로 세그먼트 분석 섹션
        // ========================================

        // 마이크로 세그먼트 상태 관리
        let microSegmentData = { problem: [], opportunity: [] };
        let microSegmentExpanded = { problem: false, opportunity: false };
        let currentMicroCategoryFilter = 'all';

        // 마이크로 세그먼트 이벤트 초기화 플래그
        let microSegmentEventsInitialized = false;

        // 마이크로 세그먼트 업데이트
        function updateMicroSegmentAlerts() {
            const periodData = getMicroSegmentPeriodData();
            const alerts = periodData?.micro_segment_alerts || [];
            const definitions = periodData?.micro_segment_definitions || {};
            const thresholds = periodData?.dynamic_thresholds || {};

            // 카테고리 필터 적용
            const filteredAlerts = currentMicroCategoryFilter === 'all'
                ? alerts
                : alerts.filter(a => a.category === currentMicroCategoryFilter || (a.category === '기타' && currentMicroCategoryFilter === 'etc'));

            // 유형별로 그룹화
            microSegmentData.problem = filteredAlerts.filter(a => a.type === 'problem');
            microSegmentData.opportunity = filteredAlerts.filter(a => a.type === 'opportunity');

            // 총 카운트 업데이트
            const totalCount = alerts.length;
            const microCountEl = document.getElementById('microSegmentCount');
            if (microCountEl) {
                microCountEl.textContent = totalCount > 0 ? `(${totalCount}건)` : '';
            }

            // 서브탭 카운트 업데이트
            const problemCountEl = document.getElementById('microProblemCount');
            const opportunityCountEl = document.getElementById('microOpportunityCount');
            if (problemCountEl) problemCountEl.textContent = `(${microSegmentData.problem.length}건)`;
            if (opportunityCountEl) opportunityCountEl.textContent = `(${microSegmentData.opportunity.length}건)`;

            // 카드 렌더링
            renderMicroSegmentCards('problem');
            renderMicroSegmentCards('opportunity');

            // 이벤트 리스너는 최초 1회만 등록
            if (!microSegmentEventsInitialized) {
                // 서브탭 이벤트 등록
                document.querySelectorAll('.micro-segment-tab-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const targetType = this.dataset.type;
                        document.querySelectorAll('.micro-segment-tab-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        document.querySelectorAll('.micro-segment-tab-content').forEach(content => {
                            content.style.display = 'none';
                        });
                        document.getElementById('micro' + targetType.charAt(0).toUpperCase() + targetType.slice(1) + 'Tab').style.display = 'block';
                    });
                });

                // 카테고리 필터 이벤트 등록
                document.querySelectorAll('.micro-category-filter').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.micro-category-filter').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentMicroCategoryFilter = this.dataset.category;

                        // 데이터 먼저 업데이트
                        const periodData = getMicroSegmentPeriodData();
                        const alerts = periodData?.micro_segment_alerts || [];
                        const filtered = currentMicroCategoryFilter === 'all'
                            ? alerts
                            : alerts.filter(a => a.category === currentMicroCategoryFilter || (a.category === '기타' && currentMicroCategoryFilter === 'etc'));
                        microSegmentData.problem = filtered.filter(a => a.type === 'problem');
                        microSegmentData.opportunity = filtered.filter(a => a.type === 'opportunity');

                        // 카운트 업데이트
                        document.getElementById('microProblemCount').textContent = `(${microSegmentData.problem.length}건)`;
                        document.getElementById('microOpportunityCount').textContent = `(${microSegmentData.opportunity.length}건)`;

                        // 카드 렌더링 (데이터 업데이트 후)
                        renderMicroSegmentCards('problem');
                        renderMicroSegmentCards('opportunity');
                    });
                });

                microSegmentEventsInitialized = true;
            }
        }

        // 마이크로 세그먼트 카드 렌더링
        function renderMicroSegmentCards(type) {
            const alerts = microSegmentData[type];
            const cardsContainer = document.getElementById('micro' + type.charAt(0).toUpperCase() + type.slice(1) + 'Cards');
            const toggleContainer = document.getElementById('micro' + type.charAt(0).toUpperCase() + type.slice(1) + 'ToggleContainer');
            const toggleBtn = document.getElementById('micro' + type.charAt(0).toUpperCase() + type.slice(1) + 'ToggleBtn');
            const isExpanded = microSegmentExpanded[type];
            const displayCount = isExpanded ? alerts.length : 5;

            const severityStyles = {
                critical: { bgColor: '#ffebee', borderColor: '#f44336', textColor: '#c62828', icon: '🚨' },
                high: { bgColor: '#fff3e0', borderColor: '#ff9800', textColor: '#e65100', icon: '⚠️' },
                medium: { bgColor: '#fff8e1', borderColor: '#ffc107', textColor: '#f57f17', icon: '📌' },
                opportunity: { bgColor: '#e8f5e9', borderColor: '#4caf50', textColor: '#2e7d32', icon: '🚀' }
            };

            const categoryColors = {
                'SA': '#1976d2',
                'DA': '#7b1fa2',
                'SNS': '#e91e63',
                'CRM': '#00897b',
                'PR': '#ff5722',
                'Organic': '#43a047',
                'etc': '#757575',
                '기타': '#757575'
            };

            if (alerts.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--grey-500);">
                        ${type === 'problem' ? '현재 문제점이 없습니다.' : '현재 기회 항목이 없습니다.'}
                    </div>
                `;
                toggleContainer.style.display = 'none';
                return;
            }

            cardsContainer.innerHTML = alerts.slice(0, displayCount).map(alert => {
                const style = severityStyles[alert.severity] || severityStyles.medium;
                const categoryColor = categoryColors[alert.category] || '#757575';

                // 세그먼트 타입별 아이콘
                const subTypeIcons = {
                    'traffic_leak': '🚿',
                    'hidden_vip': '💎',
                    'checkout_friction': '🛒',
                    'growth_engine': '🚀',
                    'activation_drop': '🚪',
                    'engagement_gap': '📉',
                    'silent_majority': '😶'
                };
                const icon = subTypeIcons[alert.sub_type] || (alert.type === 'opportunity' ? '✨' : '⚠️');

                // 긴급도 점수 표시
                const urgencyScore = alert.urgency_score || 0;
                const urgencyLabel = urgencyScore >= 70 ? '긴급' : urgencyScore >= 40 ? '주의' : '참고';

                // 메트릭스 배지 생성 함수
                const renderMetricsBadges = (metrics) => {
                    if (!metrics) return '';
                    const colorMap = {
                        '유입→활동': { color: '#1565c0', border: '#90caf9' },
                        '활동→관심': { color: '#1565c0', border: '#90caf9' },
                        '관심→구매': { color: '#1565c0', border: '#90caf9' },
                        '전환율': { color: '#2e7d32', border: '#a5d6a7' },
                        'CVR': { color: '#2e7d32', border: '#a5d6a7' },
                        '유입': { color: '#5e35b1', border: '#b39ddb' },
                        '활동': { color: '#5e35b1', border: '#b39ddb' },
                        '관심': { color: '#5e35b1', border: '#b39ddb' },
                        'RPV': { color: '#e65100', border: '#ffcc80' }
                    };
                    const percentKeys1 = ['유입→활동', '활동→관심', '관심→구매'];
                    const percentKeys2 = ['전환율', 'CVR'];
                    return Object.entries(metrics).map(([k, v]) => {
                        let formatted;
                        if (percentKeys2.includes(k)) {
                            formatted = (typeof v === 'number' ? v.toFixed(2) : v) + '%';
                        } else if (percentKeys1.includes(k)) {
                            formatted = (typeof v === 'number' ? v.toFixed(1) : v) + '%';
                        } else {
                            formatted = typeof v === 'number' ? v.toLocaleString() : v;
                        }
                        const s = colorMap[k] || { color: '#616161', border: '#bdbdbd' };
                        return '<span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: ' + s.color + '; border: 1px solid ' + s.border + '; font-weight: 500;">' + k + ' ' + formatted + '</span>';
                    }).join('');
                };

                return `
                    <div class="micro-segment-card" style="background: ${style.bgColor}; border: 2px solid ${style.borderColor}; border-radius: 10px; padding: 14px; cursor: pointer; transition: transform 0.2s;" data-prescription="${alert.action.replace(/"/g, '&quot;')}" data-title="${alert.title.replace(/"/g, '&quot;')}" data-subtype="${alert.sub_type || ''}" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <!-- 헤더 -->
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 700; color: ${style.textColor};">${alert.title}</div>
                                <div style="font-size: 10px; color: ${style.textColor}; opacity: 0.8;">${alert.category} > ${alert.sub_type || '일반'}</div>
                            </div>
                            ${urgencyScore > 0 ? '<span style="background: ' + style.borderColor + '; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">' + urgencyLabel + ' ' + urgencyScore + '</span>' : ''}
                        </div>
                        <!-- 메트릭스 배지 -->
                        ${alert.metrics ? '<div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">' + renderMetricsBadges(alert.metrics) + '</div>' : ''}
                        <!-- 진단 (이유 목록 스타일) -->
                        ${alert.diagnosis ? `
                            <div style="font-size: 11px; color: #555; line-height: 1.6; margin-bottom: 10px;">
                                <div style="display: flex; align-items: flex-start; gap: 6px;">
                                    <span style="color: ${style.borderColor};">✓</span>
                                    <span>${alert.diagnosis}</span>
                                </div>
                            </div>
                        ` : ''}
                        <!-- 추천 액션 -->
                        ${alert.action ? `
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${style.borderColor};">
                                <div style="font-size: 10px; font-weight: 600; color: ${style.textColor}; margin-bottom: 4px;">💡 추천 액션</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${alert.action}</div>
                                ${alert.impact && alert.impact.potential_revenue ? '<div style="font-size: 10px; color: #2e7d32; margin-top: 6px;">📈 예상 효과: ' + (alert.impact.potential_revenue > 0 ? alert.impact.potential_revenue.toLocaleString() + '원 매출 기회' : '이탈 방지') + '</div>' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // 접기/펼치기 버튼 처리
            if (alerts.length > 5) {
                toggleContainer.style.display = 'block';
                const hiddenCount = alerts.length - 5;
                toggleBtn.textContent = isExpanded ? '접기' : `더 보기 (${hiddenCount}건)`;

                const newBtn = toggleBtn.cloneNode(true);
                toggleBtn.parentNode.replaceChild(newBtn, toggleBtn);
                newBtn.addEventListener('click', function() {
                    microSegmentExpanded[type] = !microSegmentExpanded[type];
                    renderMicroSegmentCards(type);
                });
            } else {
                toggleContainer.style.display = 'none';
            }
        }

        // BCG Matrix 채널 전략 업데이트 (데이터 기반 의사결정 도구 기간 필터 사용)
        function updateBCGMatrix() {
            const content = document.getElementById('bcgMatrixContent');
            if (!content) return;

            const periodData = getPeriodData();
            if (!periodData || !periodData.channel_strategy || periodData.channel_strategy.status !== 'success') {
                content.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--grey-500);">채널 전략 데이터가 없습니다.</div>';
                return;
            }
            const strategy = periodData.channel_strategy;

            // 채널들을 BCG 유형별로 그룹화
            const quadrants = {
                cash_cow: { channels: [], color: '#4caf50', bgColor: '#e8f5e9', title: '👑 Cash Cow (효자 채널)', desc: '트래픽도 많고 전환율도 높음 - 투자 유지' },
                hidden_gem: { channels: [], color: '#2196f3', bgColor: '#e3f2fd', title: '💎 Hidden Gem (숨은 보석)', desc: '전환율은 높지만 트래픽이 적음 - 투자 확대' },
                money_pit: { channels: [], color: '#ff9800', bgColor: '#fff3e0', title: '💸 Money Pit (밑 빠진 독)', desc: '트래픽은 많지만 전환율이 낮음 - 최적화 필요' },
                dog: { channels: [], color: '#9e9e9e', bgColor: '#fafafa', title: '🤔 Dog (재검토 필요)', desc: '트래픽도 전환율도 낮음 - 전략 재고' }
            };

            // 채널 분류
            Object.entries(strategy.channels).forEach(([name, data]) => {
                const quadrant = data.bcg_matrix.quadrant;
                if (quadrants[quadrant]) {
                    quadrants[quadrant].channels.push({
                        name,
                        ...data.stats,
                        action: data.bcg_matrix.action
                    });
                }
            });

            // HTML 생성
            let html = '';
            Object.entries(quadrants).forEach(([key, q]) => {
                if (q.channels.length > 0) {
                    html += `
                        <div style="padding: 16px; background: ${q.bgColor}; border-radius: 12px; border-left: 4px solid ${q.color};">
                            <div style="font-size: 15px; font-weight: 700; color: var(--grey-900); margin-bottom: 4px;">
                                ${q.title}
                            </div>
                            <div style="font-size: 12px; color: var(--grey-600); margin-bottom: 12px;">
                                ${q.desc}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                                ${q.channels.map(ch => `
                                    <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border-radius: 6px; font-size: 13px; font-weight: 500; color: var(--grey-800);">
                                        ${ch.name}
                                        <span style="font-size: 11px; color: ${q.color};">(CVR ${ch.cvr}%)</span>
                                    </span>
                                `).join('')}
                            </div>
                            ${q.channels[0] ? `
                                <div style="font-size: 12px; color: var(--grey-700); padding: 10px; background: white; border-radius: 6px;">
                                    ${q.channels[0].action}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });

            content.innerHTML = html || '<div style="padding: 20px; text-align: center; color: var(--grey-500);">분류된 채널이 없습니다.</div>';
        }

        // 최근 변화 인사이트 - 기간 선택 변수
        let trendPeriod = '7d';

        // 최근 변화 인사이트 - 기간 버튼 설정
        function setupTrendPeriodButtons() {
            document.querySelectorAll('.trend-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.dataset.trendPeriod;
                    trendPeriod = period;

                    // 버튼 스타일 업데이트
                    document.querySelectorAll('.trend-period-btn').forEach(b => {
                        b.style.background = 'white';
                        b.style.color = '#495057';
                        b.style.border = '1px solid #dee2e6';
                        b.classList.remove('active');
                    });
                    this.style.background = '#673ab7';
                    this.style.color = 'white';
                    this.style.border = '1px solid #673ab7';
                    this.classList.add('active');

                    // 기간 표시 업데이트
                    updateTrendPeriodIndicator(period);

                    // 데이터 업데이트
                    renderPerformanceTrends(period);
                });
            });
        }

        // 기간 비교 표시 업데이트 (구체적인 날짜 범위 표시)
        function updateTrendPeriodIndicator(period) {
            const indicator = document.getElementById('trendPeriodText');
            if (!indicator) return;

            // 마지막 날짜 가져오기 (insightsData에서)
            let lastDate = new Date();
            if (insightsData && insightsData.overall && insightsData.overall.current_period) {
                const endDateStr = insightsData.overall.current_period.end_date;
                if (endDateStr) {
                    lastDate = new Date(endDateStr);
                }
            }

            const formatDate = (date) => {
                const m = date.getMonth() + 1;
                const d = date.getDate();
                return `${m}/${d}`;
            };

            let recentStart, recentEnd, previousStart, previousEnd;
            let days = 7;

            if (period === '7d') {
                days = 7;
            } else if (period === '14d') {
                days = 14;
            } else if (period === '30d') {
                days = 30;
            }

            // 최근 N일: lastDate - (N-1)일 ~ lastDate
            recentEnd = new Date(lastDate);
            recentStart = new Date(lastDate);
            recentStart.setDate(recentStart.getDate() - (days - 1));

            // 이전 N일: lastDate - (2N-1)일 ~ lastDate - N일
            previousEnd = new Date(lastDate);
            previousEnd.setDate(previousEnd.getDate() - days);
            previousStart = new Date(lastDate);
            previousStart.setDate(previousStart.getDate() - (days * 2 - 1));

            indicator.innerHTML = `
                <strong style="color: #1565c0;">최근 ${days}일</strong> (${formatDate(recentStart)}~${formatDate(recentEnd)}) vs
                <strong style="color: #7b1fa2;">이전 ${days}일</strong> (${formatDate(previousStart)}~${formatDate(previousEnd)})
            `;
        }

        // 성과 트렌드 렌더링 (개선 + 하락)
        function renderPerformanceTrends(period) {
            const fullData = insightsData;
            if (!fullData || !fullData.performance_trends) {
                renderNoTrendData();
                return;
            }

            const trends = fullData.performance_trends;
            updateImprovementTrends(period, trends);
            updateDeclineTrends(period, trends);
        }

        // 트렌드 데이터 없음 표시
        function renderNoTrendData() {
            const noDataHtml = `
                <div class="insight-card neutral">
                    <div class="insight-text" style="text-align: center; padding: 20px;">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; color: var(--grey-500);">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2v-2zm0-12h2v10h-2V5z"/>
                        </svg>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--grey-700);">데이터 없음</p>
                        <p style="font-size: 14px; color: var(--grey-600);">성과 트렌드 데이터가 아직 생성되지 않았습니다.</p>
                    </div>
                </div>
            `;
            const improvementContainer = document.getElementById('improvementTrendContent');
            const declineContainer = document.getElementById('declineTrendContent');
            if (improvementContainer) improvementContainer.innerHTML = noDataHtml;
            if (declineContainer) declineContainer.innerHTML = noDataHtml;
        }

        // 개선 항목 렌더링
        function updateImprovementTrends(period, trends) {
            const container = document.getElementById('improvementTrendContent');
            if (!container) return;

            const dataKeyMap = { '7d': 'improvements_7d', '14d': 'improvements_14d', '30d': 'improvements_30d' };
            const periodTextMap = { '7d': '최근 7일 vs 이전 7일', '14d': '최근 14일 vs 이전 14일', '30d': '최근 30일 vs 이전 30일' };
            const dataKey = dataKeyMap[period] || 'improvements_7d';
            const improvements = trends[dataKey] || [];
            const periodText = periodTextMap[period] || '최근 7일 vs 이전 7일';

            if (improvements.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; color: var(--grey-500);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v2h-2v-2zm0-12h2v10h-2V5z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--grey-700);">개선 사항 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">현재 기간에 유의미한 성과 개선이 감지되지 않았습니다.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${improvements.map(item => `
                        <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">📈</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: #2e7d32;">${item.metric}</div>
                                    <div style="font-size: 10px; color: #2e7d32; opacity: 0.8;">${periodText}</div>
                                </div>
                                <span style="background: #4caf50; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">+${item.change_pct}% ${item.improvement_level === 'high' ? '높음' : '중간'}</span>
                            </div>
                            <!-- 메트릭스 배지 -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">최근 ${formatNumber(item.recent_avg)}</span>
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">이전 ${formatNumber(item.previous_avg)}</span>
                            </div>
                            <!-- 추천 액션 -->
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid #4caf50;">
                                <div style="font-size: 10px; font-weight: 600; color: #2e7d32; margin-bottom: 4px;">💡 추천 액션</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${item.recommendation}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 하락 항목 렌더링
        function updateDeclineTrends(period, trends) {
            const container = document.getElementById('declineTrendContent');
            if (!container) return;

            const dataKeyMap = { '7d': 'declines_7d', '14d': 'declines_14d', '30d': 'declines_30d' };
            const periodTextMap = { '7d': '최근 7일 vs 이전 7일', '14d': '최근 14일 vs 이전 14일', '30d': '최근 30일 vs 이전 30일' };
            const dataKey = dataKeyMap[period] || 'declines_7d';
            const declines = trends[dataKey] || [];
            const periodText = periodTextMap[period] || '최근 7일 vs 이전 7일';

            if (declines.length === 0) {
                container.innerHTML = `
                    <div class="insight-card neutral">
                        <div class="insight-text" style="text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; color: var(--success-main);">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--success-main);">하락 없음</p>
                            <p style="font-size: 14px; color: var(--grey-600);">모든 지표가 안정적이거나 개선되고 있습니다.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${declines.map(item => {
                        const isHigh = item.risk_level === 'high';
                        const bgColor = isHigh ? '#ffebee' : '#fff3e0';
                        const borderColor = isHigh ? '#f44336' : '#ff9800';
                        const textColor = isHigh ? '#c62828' : '#e65100';
                        const badgeColor = isHigh ? '#f44336' : '#ff9800';
                        return `
                        <div style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 10px; padding: 14px; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 18px;">📉</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: ${textColor};">${item.metric}</div>
                                    <div style="font-size: 10px; color: ${textColor}; opacity: 0.8;">${periodText}</div>
                                </div>
                                <span style="background: ${badgeColor}; color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; font-weight: 600;">${item.change_pct}% ${isHigh ? '높음' : '중간'}</span>
                            </div>
                            <!-- 메트릭스 배지 -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #1565c0; border: 1px solid #90caf9; font-weight: 500;">최근 ${formatNumber(item.recent_avg)}</span>
                                <span style="background: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; color: #5e35b1; border: 1px solid #b39ddb; font-weight: 500;">이전 ${formatNumber(item.previous_avg)}</span>
                            </div>
                            <!-- 추천 액션 -->
                            <div style="background: #ffffff; border-radius: 6px; padding: 10px; border-left: 3px solid ${borderColor};">
                                <div style="font-size: 10px; font-weight: 600; color: ${textColor}; margin-bottom: 4px;">⚠️ 주의 필요</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.4;">${item.recommendation}</div>
                            </div>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
        }

        // KPI 요약 업데이트 (일별 데이터 사용)
        function updateKPISummary() {
            // 항상 daily 데이터 사용
            const data = dailyData;
            if (data.length === 0) return;

            // 각 퍼널 단계별 합계 계산
            const totalAcquisition = data.reduce((sum, row) => sum + (parseFloat(row['유입']) || 0), 0);
            const totalActivation = data.reduce((sum, row) => sum + (parseFloat(row['활동']) || 0), 0);
            const totalConsideration = data.reduce((sum, row) => sum + (parseFloat(row['관심']) || 0), 0);
            const totalConversion = data.reduce((sum, row) => sum + (parseFloat(row['결제진행']) || 0), 0);
            const totalPurchase = data.reduce((sum, row) => sum + (parseFloat(row['구매완료']) || 0), 0);

            const kpis = [
                { label: '유입', value: formatNumber(Math.round(totalAcquisition)), unit: '명', color: '#673ab7' },
                { label: '활동', value: formatNumber(Math.round(totalActivation)), unit: '명', color: '#2196f3' },
                { label: '관심', value: formatNumber(Math.round(totalConsideration)), unit: '명', color: '#ff9800' },
                { label: '결제 진행', value: formatNumber(Math.round(totalConversion)), unit: '명', color: '#4caf50' },
                { label: '구매 완료', value: formatNumber(Math.round(totalPurchase)), unit: '명', color: '#00c853' }
            ];

            document.getElementById('kpiSummaryGrid').innerHTML = kpis.map(kpi => `
                <div class="kpi-summary-card card">
                    <div class="kpi-summary-label">${kpi.label} (총 합계)</div>
                    <div class="kpi-summary-value">${kpi.value}</div>
                    <div class="kpi-summary-unit">${kpi.unit}</div>
                </div>
            `).join('');
        }

        // 인사이트 업데이트 (데이터 기반 의사결정 도구 기간 필터 사용)
        function updateInsights() {
            const periodData = getPeriodData();
            if (!periodData) return;

            // key_insights가 있으면 새로운 3카드 레이아웃 사용
            const keyInsights = periodData.key_insights;
            if (keyInsights && keyInsights.length > 0) {
                let html = '';  // wrapper 제거 - .insight-content가 이미 3열 그리드

                keyInsights.forEach(card => {
                    const hasAction = card.action && card.action.text;
                    const hasSubItems = card.sub_items && card.sub_items.length > 0 && card.sub_items[0];

                    html += `
                        <div style="background: ${card.bg_color}; border: 2px solid ${card.border_color}; border-radius: 10px; padding: 14px; transition: transform 0.2s; display: flex; flex-direction: column;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <!-- 헤더 -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                <div style="width: 32px; height: 32px; background: ${card.border_color}20; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <span style="font-size: 16px;">${card.icon}</span>
                                </div>
                                <span style="font-size: 11px; font-weight: 700; color: ${card.text_color}; text-transform: uppercase; letter-spacing: 0.5px;">${card.label}</span>
                                ${card.urgency_score ? `<span style="margin-left: auto; font-size: 10px; padding: 2px 6px; background: ${card.border_color}; color: white; border-radius: 8px;">긴급도 ${card.urgency_score}</span>` : ''}
                            </div>
                            <!-- 메시지 -->
                            <div style="font-size: 13px; font-weight: 500; color: var(--grey-900); line-height: 1.6; flex: 1; margin-bottom: ${hasAction || hasSubItems ? '10px' : '0'};">${card.message}</div>
                            <!-- 서브 아이템 -->
                            ${hasSubItems ? `
                                <div style="background: rgba(255,255,255,0.7); border-radius: 6px; padding: 10px; border-left: 3px solid ${card.border_color}; margin-bottom: ${hasAction ? '10px' : '0'};">
                                    <div style="font-size: 10px; font-weight: 600; color: ${card.text_color}; margin-bottom: 4px;">📌 상세 정보</div>
                                    ${card.sub_items.filter(item => item).map(item => `<div style="font-size: 11px; color: #333; line-height: 1.5;">→ ${item}</div>`).join('')}
                                </div>
                            ` : ''}
                            <!-- 추천 액션 -->
                            ${hasAction ? `
                                <div style="background: rgba(255,255,255,0.7); border-radius: 6px; padding: 10px; border-left: 3px solid #ab47bc;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                        <div style="font-size: 10px; font-weight: 600; color: #7b1fa2;">💡 추천 액션</div>
                                        ${card.action.type ? `<span style="font-size: 9px; padding: 2px 6px; background: ${card.action.type === 'scale_up' || card.action.type === 'opportunity' ? '#e8f5e9' : card.action.type === 'primary' ? '#fff3e0' : '#e3f2fd'}; color: ${card.action.type === 'scale_up' || card.action.type === 'opportunity' ? '#2e7d32' : card.action.type === 'primary' ? '#e65100' : '#1565c0'}; border-radius: 4px; font-weight: 600;">${card.action.type === 'scale_up' ? '증액' : card.action.type === 'opportunity' ? '기회' : card.action.type === 'primary' ? '개선' : '유지'}</span>` : ''}
                                    </div>
                                    <div style="font-size: 11px; color: #333; line-height: 1.4;">${card.action.text}</div>
                                    ${card.action.secondary ? `<div style="font-size: 10px; color: #5e35b1; margin-top: 6px; padding-top: 6px; border-top: 1px dashed #d1c4e9; line-height: 1.4;">➕ ${card.action.secondary}</div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                // wrapper 닫는 태그 제거 - .insight-content가 이미 3열 그리드
                document.getElementById('insightContent').innerHTML = html;
                return;
            }

            // Fallback: 기존 로직 (key_insights가 없는 경우)
            const insights = [];

            // 전체 CVR
            insights.push(`
                <div class="insight-card positive">
                    <div class="insight-title">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                        전체 전환율
                    </div>
                    <div class="insight-text">
                        전체 CVR: <strong>${formatDecimal(periodData.summary?.overall_cvr || 0)}%</strong><br>
                        총 매출: <strong>${formatNumber(periodData.summary?.total_revenue || 0)}원</strong>
                    </div>
                </div>
            `);

            // 상위 채널
            if (periodData.top_channels && periodData.top_channels.length > 0) {
                const topChannel = periodData.top_channels[0];
                insights.push(`
                    <div class="insight-card positive">
                        <div class="insight-title">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
                            최고 성과 채널
                        </div>
                        <div class="insight-text">
                            <strong>${topChannel.name}</strong><br>
                            구매: ${formatNumber(topChannel.purchases)}건<br>
                            매출: ${formatNumber(topChannel.revenue)}원
                        </div>
                    </div>
                `);
            }

            // 경고
            if (periodData.alerts && periodData.alerts.length > 0) {
                periodData.alerts.forEach(alert => {
                    const severityClass = alert.severity === 'high' ? 'negative' : 'neutral';
                    insights.push(`
                        <div class="insight-card ${severityClass}">
                            <div class="insight-title">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
                                ${alert.type === 'low_activation' ? '활성화율 경고' : '전환율 경고'}
                            </div>
                            <div class="insight-text">${alert.message}</div>
                        </div>
                    `);
                });
            }

            document.getElementById('insightContent').innerHTML = insights.join('');
        }

        // D3.js 인터랙티브 퍼널 차트
        function updateFunnelChart() {
            console.log('=== updateFunnelChart 시작 ===');

            // 채널 필터 적용된 데이터 사용
            const data = selectedFunnelChannel ? getFilteredDailyData(selectedFunnelChannel) : dailyData;
            console.log(`일별 데이터: ${data.length}개 행${selectedFunnelChannel ? ` (${selectedFunnelChannel} 필터)` : ''}`);

            if (data.length === 0) {
                console.warn('데이터가 없습니다.');
                // document.getElementById('singleFunnelDateRange').textContent = '데이터를 불러오는 중...';
                return;
            }

            // 날짜 범위 표시 (Date 객체 기반 정렬)
            const dateStrings = data
                .map(row => row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'])
                .filter(d => d);

            console.log(`추출된 날짜: ${dateStrings.length}개`);

            if (dateStrings.length > 0) {
                // Date 객체로 변환하여 정렬
                const sortedDates = dateStrings
                    .map(dateStr => new Date(dateStr))
                    .filter(date => !isNaN(date.getTime()))
                    .sort((a, b) => a - b)
                    .map(date => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    });

                const startDate = sortedDates[0];
                const endDate = sortedDates[sortedDates.length - 1];

                console.log(`날짜 범위: ${startDate} ~ ${endDate}`);
                // document.getElementById('singleFunnelDateRange').textContent = `${startDate} ~ ${endDate}`;
            } else {
                console.warn('날짜 필드를 찾을 수 없습니다.');
                // document.getElementById('singleFunnelDateRange').textContent = '';
            }

            // 각 퍼널 단계별 총합 계산
            const baseColor = '#535A8C'; // Deep purple color
            const funnelStages = [
                { name: '유입 (Acquisition)', key: '유입', color: baseColor, description: 'Acquisition' },
                { name: '활동 (Activation)', key: '활동', color: baseColor, description: 'Activation' },
                { name: '관심 (Consideration)', key: '관심', color: baseColor, description: 'Consideration' },
                { name: '결제진행 (Conversion)', key: '결제진행', color: baseColor, description: 'Conversion' },
                { name: '구매완료 (Purchase)', key: '구매완료', color: baseColor, description: 'Purchase' }
            ];

            const funnelData = funnelStages.map((stage, index) => {
                const total = data.reduce((sum, row) => sum + (parseFloat(row[stage.key]) || 0), 0);
                const prevTotal = index > 0 ? data.reduce((sum, row) => sum + (parseFloat(row[funnelStages[index - 1].key]) || 0), 0) : total;
                const conversionRate = prevTotal > 0 ? (total / prevTotal * 100) : 100;
                const dropOffRate = prevTotal > 0 ? ((prevTotal - total) / prevTotal * 100) : 0;

                return {
                    ...stage,
                    total: Math.round(total),
                    conversionRate: conversionRate.toFixed(1),
                    dropOffRate: dropOffRate.toFixed(1),
                    index: index
                };
            });

            // SVG 초기화
            const container = document.getElementById('d3FunnelChart');
            container.innerHTML = '';

            const margin = { top: 20, right: 40, bottom: 20, left: 40 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = 550 - margin.top - margin.bottom;

            const svg = d3.select('#d3FunnelChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // 툴팁 생성 (body에 직접 추가하여 overflow 문제 해결)
            let tooltip = d3.select('body').select('.funnel-tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body')
                    .append('div')
                    .attr('class', 'funnel-tooltip');
            }

            // 최대값 기준으로 스케일 계산
            const maxValue = d3.max(funnelData, d => d.total);
            const stageHeight = height / funnelData.length;
            const spacing = 10;

            // 각 단계 그리기
            funnelData.forEach((stage, i) => {
                // 각 단계마다 점진적으로 어두워지는 색상 계산
                const stageColor = d3.color(stage.color).darker(i * 0.25);

                const yPos = i * stageHeight;
                const topWidth = (stage.total / maxValue) * width;
                const bottomWidth = i < funnelData.length - 1
                    ? (funnelData[i + 1].total / maxValue) * width
                    : topWidth * 0.8;

                const xOffset = (width - topWidth) / 2;
                const xOffsetBottom = (width - bottomWidth) / 2;

                // 단계 사이 화살표 추가 (첫 단계 제외)
                if (i > 0) {
                    const prevBottomWidth = funnelData[i - 1].total > 0
                        ? (funnelData[i - 1].total / maxValue) * width
                        : topWidth;
                    const prevXOffsetBottom = (width - prevBottomWidth) / 2;

                    // 화살표 그룹
                    const arrowGroup = svg.append('g')
                        .attr('opacity', 0.4);

                    // 화살표 라인
                    arrowGroup.append('line')
                        .attr('x1', width / 2)
                        .attr('y1', yPos - spacing / 2 - 15)
                        .attr('x2', width / 2)
                        .attr('y2', yPos - spacing / 2)
                        .attr('stroke', stageColor)
                        .attr('stroke-width', 3)
                        .attr('stroke-dasharray', '5,5');

                    // 화살표 헤드
                    arrowGroup.append('polygon')
                        .attr('points', `
                            ${width / 2},${yPos - spacing / 2}
                            ${width / 2 - 6},${yPos - spacing / 2 - 8}
                            ${width / 2 + 6},${yPos - spacing / 2 - 8}
                        `)
                        .attr('fill', stageColor);
                }

                // 퍼널 단계 (트라페즈이드)
                const group = svg.append('g')
                    .attr('class', 'funnel-stage')
                    .style('cursor', 'pointer');

                // 그라데이션 정의 (하위 depth로 갈수록 어두운 색상)
                const gradientId = `gradient-${i}`;
                const gradient = svg.append('defs')
                    .append('linearGradient')
                    .attr('id', gradientId)
                    .attr('x1', '0%')
                    .attr('y1', '0%')
                    .attr('x2', '0%')
                    .attr('y2', '100%');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 1);

                gradient.append('stop')
                    .attr('offset', '50%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 0.9);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 0.75);

                // 트라페즈이드 경로
                const path = `
                    M ${xOffset} ${yPos}
                    L ${xOffset + topWidth} ${yPos}
                    L ${xOffsetBottom + bottomWidth} ${yPos + stageHeight - spacing}
                    L ${xOffsetBottom} ${yPos + stageHeight - spacing}
                    Z
                `;

                group.append('path')
                    .attr('d', path)
                    .attr('fill', `url(#${gradientId})`)
                    .attr('stroke', stageColor)
                    .attr('stroke-width', 2)
                    .attr('opacity', 0.85);

                // 텍스트 배경 (가독성 향상)
                const textBg = group.append('rect')
                    .attr('x', width / 2 - 120)
                    .attr('y', yPos + stageHeight / 2 - 35)
                    .attr('width', 240)
                    .attr('height', i > 0 ? 65 : 45)
                    .attr('fill', 'rgba(255, 255, 255, 0.95)')
                    .attr('rx', 8)
                    .attr('stroke', stageColor)
                    .attr('stroke-width', 2)
                    .attr('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))');

                // 레이블
                group.append('text')
                    .attr('class', 'funnel-stage-label')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 - 15)
                    .attr('text-anchor', 'middle')
                    .style('fill', stageColor)
                    .text(stage.name);

                // 값 표시
                group.append('text')
                    .attr('class', 'funnel-stage-value')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 + 5)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'var(--grey-900)')
                    .style('font-weight', '700')
                    .text(stage.total.toLocaleString() + ' users');

                // 전환율 및 이탈률 표시 (첫 단계 제외)
                if (i > 0) {
                    const conversionText = group.append('text')
                        .attr('class', 'funnel-stage-conversion')
                        .attr('x', width / 2)
                        .attr('y', yPos + stageHeight / 2 + 22)
                        .attr('text-anchor', 'middle');

                    // 전환율 (기본 색상)
                    conversionText.append('tspan')
                        .style('fill', stageColor)
                        .style('font-weight', '600')
                        .text(`전환율: ${stage.conversionRate}%`);

                    // 구분자
                    conversionText.append('tspan')
                        .style('fill', 'var(--grey-600)')
                        .text(' | ');

                    // 이탈률 (빨간색)
                    conversionText.append('tspan')
                        .style('fill', '#EF4444')
                        .style('font-weight', '600')
                        .text(`이탈: ${stage.dropOffRate}%`);
                }

                // 인사이트 및 추천사항 데이터
                const insights = getStageInsights(stage, i);

                // 마우스 이벤트
                group.on('mouseover', function(event) {
                    d3.select(this)
                        .style('opacity', 1)
                        .style('filter', 'brightness(1.1)');

                    tooltip.html(`
                        <div class="funnel-tooltip-title">${stage.name}</div>
                        <div class="funnel-tooltip-metric">
                            <span class="funnel-tooltip-metric-label">총 사용자</span>
                            <span class="funnel-tooltip-metric-value">${stage.total.toLocaleString()}명</span>
                        </div>
                        ${i > 0 ? `
                        <div class="funnel-tooltip-metric">
                            <span class="funnel-tooltip-metric-label">전환율</span>
                            <span class="funnel-tooltip-metric-value" style="color: ${stageColor}; font-weight: 600;">${stage.conversionRate}%</span>
                        </div>
                        <div class="funnel-tooltip-metric">
                            <span class="funnel-tooltip-metric-label">이탈률</span>
                            <span class="funnel-tooltip-metric-value" style="color: #EF4444; font-weight: 600;">${stage.dropOffRate}%</span>
                        </div>
                        ` : ''}
                        <div class="funnel-tooltip-insight">${insights.insight}</div>
                        <div class="funnel-tooltip-recommendation">${insights.recommendation}</div>
                    `)
                    .classed('visible', true);

                    // 툴팁 위치 조정 (rect 박스 옆에 표시)
                    requestAnimationFrame(() => {
                        const tooltipNode = tooltip.node();
                        const tooltipRect = tooltipNode.getBoundingClientRect();
                        const padding = 15;

                        // rect 박스의 위치 계산
                        const rectX = width / 2 - 120; // rect의 x 좌표
                        const rectY = yPos + stageHeight / 2 - 35; // rect의 y 좌표
                        const rectWidth = 240;

                        // 컨테이너의 화면상 위치
                        const containerRect = container.getBoundingClientRect();

                        // rect 오른쪽 옆에 배치 시도
                        let left = containerRect.left + margin.left + rectX + rectWidth + padding;
                        let top = containerRect.top + margin.top + rectY;

                        // 오른쪽 경계를 넘으면 왼쪽에 배치
                        if (left + tooltipRect.width + padding > window.innerWidth) {
                            left = containerRect.left + margin.left + rectX - tooltipRect.width - padding;
                        }

                        // 왼쪽 경계도 넘으면 화면 안쪽으로 조정
                        if (left < padding) {
                            left = padding;
                        }

                        // 하단 경계를 넘으면 위로 조정
                        if (top + tooltipRect.height + padding > window.innerHeight) {
                            top = window.innerHeight - tooltipRect.height - padding;
                        }

                        // 상단 경계를 넘으면 아래로 조정
                        if (top < padding) {
                            top = padding;
                        }

                        tooltip
                            .style('left', left + 'px')
                            .style('top', top + 'px');
                    });
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .style('opacity', 0.85)
                        .style('filter', 'none');
                    tooltip.classed('visible', false);
                });
            });

            console.log('=== updateFunnelChart 완료 ===\n');
        }

        // 단계별 인사이트 및 추천사항 생성
        function getStageInsights(stage, index) {
            const insights = {
                0: {
                    insight: '사용자 유입의 시작 단계입니다. 모든 마케팅 채널의 트래픽이 집계됩니다.',
                    recommendation: '유료 광고, SEO, 소셜 미디어 등 다양한 채널의 유입 품질을 개선하세요.'
                },
                1: {
                    insight: '첫 방문자가 활성화되는 단계입니다. 이탈률이 높다면 랜딩페이지에 문제가 있을 수 있습니다.',
                    recommendation: parseFloat(stage.dropOffRate) > 50
                        ? '이탈률이 매우 높습니다. 랜딩페이지 속도, 디자인, CTA를 즉시 개선하세요.'
                        : '랜딩페이지 A/B 테스트를 통해 전환율을 지속적으로 개선하세요.'
                },
                2: {
                    insight: '사용자가 제품/서비스에 관심을 보이는 단계입니다.',
                    recommendation: parseFloat(stage.dropOffRate) > 40
                        ? '제품 페이지의 정보 품질과 이미지를 개선하고, 리뷰를 강화하세요.'
                        : '추천 시스템과 개인화를 통해 관심을 구매로 전환하세요.'
                },
                3: {
                    insight: '결제를 시작한 단계입니다. 여기서의 이탈은 큰 기회 손실입니다.',
                    recommendation: parseFloat(stage.dropOffRate) > 30
                        ? '결제 프로세스를 단순화하고, 배송비/결제 수단을 명확히 표시하세요.'
                        : '원클릭 결제, 게스트 체크아웃 등으로 마찰을 최소화하세요.'
                },
                4: {
                    insight: '최종 구매 완료 단계입니다. 이 사용자들을 재구매 고객으로 전환하는 것이 중요합니다.',
                    recommendation: '이메일 마케팅, 리타겟팅 광고, 로열티 프로그램으로 재구매를 유도하세요.'
                }
            };

            return insights[index] || { insight: '', recommendation: '' };
        }

        // 고급 분석 결과 업데이트 (데이터 기반 의사결정 도구용)
        function updateAdvancedAnalysis() {
            const periodData = getPeriodData();
            if (!periodData) return;

            // 1. 예산 투자 가이드 (투자 대비 기대 성과 분석) - 기간 필터 적용
            const abTestContainer = document.getElementById('abTestResults');

            // 기간별 channel_strategy 데이터 사용
            const channelStrategy = periodData.channel_strategy;
            if (channelStrategy && channelStrategy.status === 'success' && channelStrategy.channels) {
                const channelEntries = Object.entries(channelStrategy.channels);

                // 각 채널의 투자 효율성 계산
                const channelInvestmentScores = channelEntries.map(([channelName, channelInfo]) => {
                    const stats = channelInfo.stats || {};
                    const acquisition = parseFloat(stats.users) || 0;
                    const cvr = parseFloat(stats.cvr) || 0;
                    const revenue = parseFloat(stats.revenue) || 0;
                    // purchase는 users * cvr / 100으로 계산
                    const purchase = Math.round(acquisition * cvr / 100);

                    // 신뢰도: 데이터 샘플 수 기반 (유입 수가 많을수록 높음)
                    let confidence = '낮음';
                    let confidenceScore = 0;
                    if (acquisition >= 100000) {
                        confidence = '매우 높음';
                        confidenceScore = 4;
                    } else if (acquisition >= 10000) {
                        confidence = '높음';
                        confidenceScore = 3;
                    } else if (acquisition >= 1000) {
                        confidence = '보통';
                        confidenceScore = 2;
                    } else if (acquisition >= 100) {
                        confidence = '낮음';
                        confidenceScore = 1;
                    }

                    // 평균 객단가 (ARPU)
                    const arpu = purchase > 0 ? revenue / purchase : 0;

                    // 채널 타입 분류 (광고 vs 오가닉)
                    const channelNameLower = channelName.toLowerCase();
                    let channelType = 'organic';
                    let estimatedCPA = 0; // 방문자 1명당 유입 비용

                    if (channelNameLower.includes('광고') || channelNameLower.includes('ad') || channelNameLower.includes('paid')) {
                        channelType = 'paid';
                        estimatedCPA = 1500; // 유료 광고 평균 CPA (원/방문자)
                    } else if (channelNameLower.includes('direct') || channelNameLower === 'direct') {
                        channelType = 'direct';
                        estimatedCPA = 0; // Direct는 자연 유입, 투자 불가
                    } else if (channelNameLower.includes('organic') || channelNameLower.includes('쇼핑') || channelNameLower.includes('블로그')) {
                        channelType = 'organic_optimizable';
                        estimatedCPA = 300; // 오가닉 최적화 비용 (SEO, 콘텐츠 등)
                    } else {
                        channelType = 'referral';
                        estimatedCPA = 500; // 레퍼럴/기타 채널
                    }

                    // 투자 효율성 점수 = CVR × ARPU × 신뢰도 가중치
                    const investmentScore = cvr * arpu * (1 + confidenceScore * 0.1);

                    // 100만원 투자 시 예상 성과 계산
                    let estimatedVisitors = 0;
                    let expectedPurchases = 0;
                    let expectedRevenue = 0;
                    let roi = -100;
                    let isInvestable = true;

                    if (channelType === 'direct') {
                        // Direct는 자연 유입이므로 광고 투자 불가
                        isInvestable = false;
                    } else if (estimatedCPA > 0) {
                        estimatedVisitors = 1000000 / estimatedCPA; // 100만원으로 확보 가능한 방문자 수
                        expectedPurchases = estimatedVisitors * (cvr / 100); // 예상 구매 건수
                        expectedRevenue = expectedPurchases * arpu; // 예상 매출액
                        roi = expectedRevenue > 0 ? ((expectedRevenue - 1000000) / 1000000 * 100) : -100;
                    }

                    return {
                        channel: channelName,
                        cvr: cvr,
                        revenue: revenue,
                        purchase: purchase,
                        acquisition: acquisition,
                        arpu: arpu,
                        confidence: confidence,
                        confidenceScore: confidenceScore,
                        investmentScore: investmentScore,
                        channelType: channelType,
                        estimatedCPA: estimatedCPA,
                        isInvestable: isInvestable,
                        estimatedVisitors: estimatedVisitors,
                        expectedPurchases: expectedPurchases,
                        expectedRevenue: expectedRevenue,
                        roi: roi
                    };
                }).filter(item => item.acquisition > 0 && item.cvr > 0)
                  .sort((a, b) => b.roi - a.roi)
                  .slice(0, 8);

                if (channelInvestmentScores.length > 0) {
                    abTestContainer.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <p style="font-size: 14px; color: var(--grey-700); margin-bottom: 8px;">
                                <strong>${channelInvestmentScores.length}개</strong> 채널의 투자 효율성 분석 완료
                            </p>
                            <p style="font-size: 12px; color: var(--grey-600);">
                                💡 전환율, 평균 객단가, 데이터 신뢰도를 종합하여 투자 시 기대 성과가 높은 순으로 정렬했습니다.
                            </p>
                        </div>
                        <div id="investmentItemsContainer" style="display: grid; gap: 12px;">
                            ${channelInvestmentScores.map((channel, index) => {
                                const rankEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}위`;
                                const confidenceColor = channel.confidenceScore >= 3 ? 'var(--success-main)' :
                                                       channel.confidenceScore === 2 ? 'var(--warning-main)' : 'var(--grey-400)';
                                const bgColor = channel.confidenceScore >= 3 ? 'linear-gradient(135deg, var(--success-light) 0%, #f0fff4 100%)' :
                                               channel.confidenceScore === 2 ? 'linear-gradient(135deg, var(--warning-light) 0%, #fff9e6 100%)' : 'var(--grey-50)';
                                const borderColor = channel.confidenceScore >= 3 ? 'var(--success-main)' :
                                                   channel.confidenceScore === 2 ? 'var(--warning-main)' : 'var(--grey-300)';
                                const hiddenClass = index >= 3 ? ' hidden-row' : '';

                                return `
                                <div class="investment-item${hiddenClass}" style="padding: 16px; background: ${bgColor}; border-radius: 8px; border-left: 4px solid ${borderColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 16px; font-weight: 700; color: var(--grey-900); margin-bottom: 8px;">
                                                ${rankEmoji} ${channel.channel}
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                                                <div style="padding: 8px; background: white; border-radius: 6px;">
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 2px;">전환율</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--primary-main);">
                                                        ${formatDecimal(channel.cvr)}%
                                                    </div>
                                                </div>
                                                <div style="padding: 8px; background: white; border-radius: 6px;">
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 2px;">평균 객단가</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--success-main);">
                                                        ${formatNumber(Math.round(channel.arpu))}원
                                                    </div>
                                                </div>
                                                <div style="padding: 8px; background: white; border-radius: 6px;">
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 2px;">데이터 신뢰도</div>
                                                    <div style="font-size: 13px; font-weight: 700; color: ${confidenceColor};">
                                                        ${channel.confidence}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    ${channel.confidenceScore >= 2 ? (
                                        channel.isInvestable ? `
                                        <div style="padding: 14px; background: white; border-radius: 8px; border-left: 3px solid var(--primary-main); margin-bottom: 8px;">
                                            <div style="font-size: 13px; color: var(--grey-900); font-weight: 700; margin-bottom: 10px;">
                                                💰 100만원 투자 시 예상 성과
                                                <span style="font-size: 11px; font-weight: 500; color: var(--grey-600); margin-left: 8px;">
                                                    (예상 CPA: ${formatNumber(channel.estimatedCPA)}원/방문자)
                                                </span>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                                                <div>
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 유입</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--secondary-main);">
                                                        약 ${formatNumber(Math.round(channel.estimatedVisitors))}명
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 구매</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--primary-main);">
                                                        약 ${formatNumber(Math.round(channel.expectedPurchases))}건
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 매출</div>
                                                    <div style="font-size: 16px; font-weight: 700; color: var(--success-main);">
                                                        약 ${formatNumber(Math.round(channel.expectedRevenue))}원
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="padding: 10px; background: ${channel.roi > 100 ? '#e8f5e9' : channel.roi > 0 ? '#fff3e0' : '#ffebee'}; border-radius: 6px;">
                                                <div style="font-size: 11px; color: var(--grey-600); margin-bottom: 4px;">예상 ROI (투자수익률)</div>
                                                <div style="font-size: 22px; font-weight: 700; color: ${channel.roi > 0 ? 'var(--success-main)' : 'var(--error-main)'};">
                                                    ${channel.roi > 0 ? '+' : ''}${formatDecimal(channel.roi)}%
                                                    <span style="font-size: 12px; font-weight: 500; margin-left: 8px;">
                                                        (순이익: ${channel.roi > 0 ? '+' : ''}${formatNumber(Math.round(channel.expectedRevenue - 1000000))}원)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div style="padding: 14px; background: linear-gradient(135deg, #e8eaf6 0%, #f3f4f9 100%); border-radius: 6px;">
                                            <div style="font-size: 12px; color: var(--grey-800); line-height: 1.7;">
                                                💡 <strong>투자 전략:</strong><br>
                                                ${channel.channelType === 'paid' ?
                                                    (channel.roi > 200 ?
                                                        `이 광고 채널은 <strong style="color: var(--success-main);">매우 높은 수익률(+${formatDecimal(channel.roi)}%)</strong>을 보입니다. 100만원 투자 시 약 <strong>${formatNumber(Math.round(channel.expectedRevenue))}원</strong>의 매출이 예상되며, <strong>추가 예산 투입</strong>을 적극 권장합니다.` :
                                                    channel.roi > 100 ?
                                                        `이 광고 채널은 <strong style="color: var(--success-main);">양호한 수익률(+${formatDecimal(channel.roi)}%)</strong>을 보입니다. 100만원 투자로 약 ${formatNumber(Math.round(channel.estimatedVisitors))}명 유입, ${formatNumber(Math.round(channel.expectedPurchases))}건 구매가 예상됩니다. <strong>예산 증액 고려</strong>를 추천합니다.` :
                                                    channel.roi > 0 ?
                                                        `이 광고 채널은 수익성이 있으나(+${formatDecimal(channel.roi)}%), 다른 채널 대비 효율이 낮습니다. 광고 소재와 타겟팅을 개선하면 더 나은 성과를 기대할 수 있습니다.` :
                                                        `현재 이 광고 채널은 손실(${formatDecimal(channel.roi)}%)이 예상됩니다. <strong>캠페인 최적화 또는 예산 재분배</strong>가 필요합니다.`) :
                                                channel.channelType === 'organic_optimizable' ?
                                                    (channel.roi > 200 ?
                                                        `SEO/콘텐츠 최적화에 <strong>100만원 투자 시 약 ${formatNumber(Math.round(channel.estimatedVisitors))}명의 추가 유입</strong>과 <strong>${formatNumber(Math.round(channel.expectedRevenue))}원의 매출</strong>이 예상됩니다. 전환율이 ${formatDecimal(channel.cvr)}%로 높아 <strong style="color: var(--success-main);">매우 효율적인 투자처</strong>입니다.` :
                                                    channel.roi > 0 ?
                                                        `이 채널은 오가닉 트래픽 최적화를 통해 수익을 창출할 수 있습니다. SEO, 블로그 콘텐츠, 쇼핑몰 최적화 등에 투자하면 지속 가능한 성장이 가능합니다.` :
                                                        `현재 전환율(${formatDecimal(channel.cvr)}%)과 객단가(${formatNumber(Math.round(channel.arpu))}원)를 고려할 때, 투자 전 콘텐츠 품질과 사용자 경험 개선이 우선입니다.`) :
                                                    `이 채널은 전환율 ${formatDecimal(channel.cvr)}%, 객단가 ${formatNumber(Math.round(channel.arpu))}원으로 투자 효율성이 확인되었습니다. 파트너십 강화나 제휴 확대를 고려해보세요.`
                                                }
                                            </div>
                                        </div>
                                        ` : `
                                        <div style="padding: 14px; background: linear-gradient(135deg, #fff3e0 0%, #fff9e6 100%); border-radius: 8px; border-left: 3px solid var(--warning-main);">
                                            <div style="font-size: 13px; color: var(--grey-900); font-weight: 700; margin-bottom: 8px;">
                                                ℹ️ Direct 자연 유입 채널
                                            </div>
                                            <div style="font-size: 12px; color: var(--grey-700); line-height: 1.6;">
                                                이 채널은 <strong>자연 유입(Direct Traffic)</strong>으로, 직접적인 광고 투자 대상이 아닙니다.<br><br>
                                                <strong>현재 성과:</strong><br>
                                                • 전환율: ${formatDecimal(channel.cvr)}%<br>
                                                • 평균 객단가: ${formatNumber(Math.round(channel.arpu))}원<br>
                                                • 총 매출: ${formatNumber(channel.revenue)}원<br><br>
                                                💡 <strong>개선 방안:</strong> 브랜드 인지도 향상, 이메일 마케팅, 리마케팅 등을 통해 Direct 유입을 늘릴 수 있습니다. 현재 높은 전환율(${formatDecimal(channel.cvr)}%)을 유지하면서 유입량을 증가시키는 것이 핵심입니다.
                                            </div>
                                        </div>
                                        `
                                    ) : `
                                        <div style="padding: 12px; background: white; border-radius: 6px; border-left: 3px solid var(--grey-300);">
                                            <div style="font-size: 12px; color: var(--grey-700);">
                                                ⚠️ 데이터가 충분하지 않아 정확한 투자 성과 예측이 어렵습니다. 더 많은 데이터를 수집한 후 재평가하세요. (현재 유입: ${formatNumber(channel.acquisition)}명)
                                            </div>
                                        </div>
                                    `}
                                </div>
                            `;
                            }).join('')}
                        </div>
                        ${channelInvestmentScores.length > 3 ? `
                        <div class="show-more-container" id="investmentShowMoreContainer" style="margin-top: 12px;">
                            <button class="show-more-btn" id="investmentShowMoreBtn">더 보기 (<span id="investmentHiddenCount">${channelInvestmentScores.length - 3}</span>개)</button>
                        </div>
                        <div class="show-more-container" id="investmentCollapseContainer" style="display: none; margin-top: 12px;">
                            <button class="show-more-btn" id="investmentCollapseBtn">접기</button>
                        </div>
                        ` : ''}
                    `;

                    // 더보기/접기 버튼 이벤트 리스너 등록
                    if (channelInvestmentScores.length > 3) {
                        const showMoreBtn = document.getElementById('investmentShowMoreBtn');
                        const collapseBtn = document.getElementById('investmentCollapseBtn');

                        if (showMoreBtn) {
                            showMoreBtn.addEventListener('click', function() {
                                const hiddenItems = document.querySelectorAll('.investment-item.hidden-row');
                                const showMoreContainer = document.getElementById('investmentShowMoreContainer');
                                const collapseContainer = document.getElementById('investmentCollapseContainer');

                                hiddenItems.forEach(item => {
                                    item.classList.remove('hidden-row');
                                });

                                showMoreContainer.style.display = 'none';
                                collapseContainer.style.display = 'block';
                            });
                        }

                        if (collapseBtn) {
                            collapseBtn.addEventListener('click', function() {
                                const allItems = document.querySelectorAll('.investment-item');
                                const showMoreContainer = document.getElementById('investmentShowMoreContainer');
                                const collapseContainer = document.getElementById('investmentCollapseContainer');

                                allItems.forEach((item, index) => {
                                    if (index >= 3) {
                                        item.classList.add('hidden-row');
                                    }
                                });

                                showMoreContainer.style.display = 'block';
                                collapseContainer.style.display = 'none';
                            });
                        }
                    }
                } else {
                    abTestContainer.innerHTML = '<p style="color: var(--grey-500);">선택한 기간에 분석 가능한 채널 데이터가 없습니다.</p>';
                }
            } else {
                abTestContainer.innerHTML = '<p style="color: var(--grey-500);">채널 전략 데이터가 없습니다.</p>';
            }

            // 2. BCG Matrix 채널 전략 업데이트 (기간 필터 적용)
            updateBCGMatrix();

            // 3. 채널 클러스터링 (기간 필터 적용)
            const clusterContainer = document.getElementById('channelClusters');
            if (periodData.channel_clusters && periodData.channel_clusters.clusters) {
                const clusters = periodData.channel_clusters.clusters;
                const descriptions = periodData.channel_clusters.description;

                clusterContainer.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 14px; color: var(--grey-700); margin-bottom: 12px;">
                            퍼널 건강도 기준 <strong>${periodData.channel_clusters.n_clusters}개</strong> 그룹으로 분류
                            <span style="font-size: 12px; color: var(--grey-500); margin-left: 8px;">(유입→활동→관심→결제 단계별 전환율 평균)</span>
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        ${Object.entries(clusters).map(([clusterName, channels], index) => {
                            const colors = ['var(--success-main)', 'var(--warning-main)', 'var(--error-main)'];
                            const bgColors = ['var(--success-light)', 'var(--warning-light)', 'var(--error-light)'];
                            return `
                                <div style="padding: 16px; background: ${bgColors[index % 3]}; border-radius: 8px; border-left: 4px solid ${colors[index % 3]};">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--grey-900); margin-bottom: 8px;">
                                        ${descriptions[clusterName] || clusterName}
                                    </div>
                                    <div style="font-size: 13px; color: var(--grey-700);">
                                        ${channels.map(ch => `<span style="display: inline-block; padding: 4px 8px; background: white; border-radius: 4px; margin: 2px;">${ch}</span>`).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                clusterContainer.innerHTML = '<p style="color: var(--grey-500);">클러스터링 결과가 없습니다.</p>';
            }

            // 2.5 A/B 테스트 통계 결과 (유의미한 채널 비교만 표시)
            const abStatsContainer = document.getElementById('abTestStatsContainer');
            if (periodData.ab_test_results && periodData.ab_test_results.length > 0) {
                const significantTests = periodData.ab_test_results.filter(t => t.significant === true);
                if (significantTests.length > 0) {
                    abStatsContainer.innerHTML = `
                        <div style="padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid var(--success-main);">
                            <div style="font-size: 14px; font-weight: 600; color: var(--success-main); margin-bottom: 12px;">
                                📊 통계적으로 유의미한 채널 비교 (${significantTests.length}건)
                            </div>
                            <div style="font-size: 12px; color: var(--grey-600); margin-bottom: 12px;">
                                p-value < 0.05로 통계적으로 유의미한 전환율 차이가 확인된 채널 조합입니다.
                            </div>
                            <div style="display: grid; gap: 8px;">
                                ${significantTests.map(test => `
                                    <div style="padding: 12px; background: white; border-radius: 6px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: var(--grey-800);">${test.group_a}</span>
                                            <span style="font-size: 12px; color: ${test.cvr_a < test.cvr_b ? 'var(--error-main)' : 'var(--success-main)'};">(${test.cvr_a}%)</span>
                                        </div>
                                        <span style="color: var(--grey-400);">vs</span>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-weight: 600; color: var(--grey-800);">${test.group_b}</span>
                                            <span style="font-size: 12px; color: ${test.cvr_b < test.cvr_a ? 'var(--error-main)' : 'var(--success-main)'};">(${test.cvr_b}%)</span>
                                        </div>
                                        <span style="font-size: 11px; color: var(--grey-500); margin-left: auto;">p=${test.p_value.toFixed(4)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 12px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 12px; color: var(--grey-700);">
                                💡 <strong>활용 방법:</strong> 전환율이 높은 채널의 전략을 전환율이 낮은 채널에 적용해보세요.
                            </div>
                        </div>
                    `;
                } else {
                    abStatsContainer.innerHTML = `
                        <div style="padding: 16px; background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%); border-radius: 8px; border-left: 4px solid var(--grey-400);">
                            <div style="font-size: 14px; font-weight: 600; color: var(--grey-600); margin-bottom: 8px;">
                                📊 통계적으로 유의미한 채널 비교
                            </div>
                            <div style="font-size: 13px; color: var(--grey-500);">
                                선택한 기간 내에서는 통계적으로 유의미한 전환율 차이(p-value < 0.05)를 보이는 채널 조합이 없습니다.
                            </div>
                            <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 6px; font-size: 12px; color: var(--grey-600);">
                                💡 <strong>참고:</strong> 분석 기간을 '전체 기간'으로 변경하면 더 많은 데이터를 기반으로 유의미한 결과를 확인할 수 있습니다.
                            </div>
                        </div>
                    `;
                }
            } else {
                abStatsContainer.innerHTML = `
                    <div style="padding: 16px; background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%); border-radius: 8px; border-left: 4px solid var(--grey-400);">
                        <div style="font-size: 14px; font-weight: 600; color: var(--grey-600); margin-bottom: 8px;">
                            📊 통계적으로 유의미한 채널 비교
                        </div>
                        <div style="font-size: 13px; color: var(--grey-500);">
                            채널 비교 분석 데이터가 없습니다.
                        </div>
                    </div>
                `;
            }

            // 4. CRM 액션 가이드 (기간 필터 적용)
            renderCrmActions();
        }

        // CRM 액션 가이드 렌더링 함수 (기간 필터 연동)
        function renderCrmActions() {
            const crmContainer = document.getElementById('crmActionsContainer');
            if (!crmContainer) return;

            // crm_actions_by_period 데이터에서 현재 기간의 CRM 액션 가져오기
            const crmActionsByPeriod = insightsData.crm_actions_by_period;
            if (!crmActionsByPeriod || !crmActionsByPeriod[currentPeriod]) {
                crmContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--grey-500);">
                        <p>선택한 기간의 CRM 액션 데이터가 없습니다.</p>
                    </div>
                `;
                return;
            }

            const periodCrmData = crmActionsByPeriod[currentPeriod];
            const crmActions = periodCrmData.crm_actions || [];
            const periodLabel = periodCrmData.period_label || currentPeriod;

            if (crmActions.length === 0) {
                crmContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--success-main);">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">이탈 위험 없음</p>
                        <p style="font-size: 14px; color: var(--grey-600);">${periodLabel} 동안 특별한 CRM 액션이 필요하지 않습니다.</p>
                    </div>
                `;
                return;
            }

            // CRM 액션 우선순위 색상
            const priorityColors = {
                'high': { border: '#ef5350', bg: '#ffebee', badge: '#c62828', label: '긴급' },
                'medium': { border: '#ffa726', bg: '#fff3e0', badge: '#ef6c00', label: '주의' },
                'low': { border: '#66bb6a', bg: '#e8f5e9', badge: '#2e7d32', label: '모니터링' }
            };

            crmContainer.innerHTML = `
                <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                    <div style="font-size: 13px; color: var(--grey-700);">
                        <strong>${periodLabel}</strong> 기간 분석 결과, <strong style="color: var(--primary-main);">${crmActions.length}건</strong>의 CRM 액션이 필요합니다.
                    </div>
                </div>
                <div style="display: grid; gap: 12px;">
                    ${crmActions.map((action, index) => {
                        const priority = action.priority || 'medium';
                        const colors = priorityColors[priority] || priorityColors['medium'];
                        return `
                            <div style="padding: 16px; background: ${colors.bg}; border-radius: 8px; border-left: 4px solid ${colors.border};">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--grey-900);">
                                        📍 ${action.stage || '알 수 없는 단계'}
                                    </div>
                                    <span style="font-size: 11px; padding: 3px 8px; background: ${colors.badge}; color: white; border-radius: 10px;">
                                        ${colors.label}
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: var(--grey-700); margin-bottom: 6px;">
                                    <strong>현황:</strong> ${action.trend || '데이터 없음'}
                                </div>
                                <div style="font-size: 13px; color: var(--grey-600); margin-bottom: 10px; font-style: italic;">
                                    <strong>진단:</strong> ${action.diagnosis || '진단 정보 없음'}
                                </div>
                                <div style="font-size: 13px; color: var(--grey-900); padding: 12px; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    💊 <strong>처방:</strong> ${action.prescription || '처방 정보 없음'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // 단계별 맞춤 이탈 대응 추천 생성
        function getChurnRecommendation(stage, changePercent, riskLevel) {
            const absChange = Math.abs(parseFloat(changePercent));
            const urgency = riskLevel === 'high' ? '즉시' : '빠르게';

            // 단계별 맞춤 추천
            const stageRecommendations = {
                '유입': [
                    `광고 캠페인의 타겟팅을 ${urgency} 재검토하세요. 잘못된 고객층에게 광고가 노출되고 있을 수 있습니다.`,
                    `광고 소재(이미지, 문구)를 점검하세요. 클릭은 많지만 이탈이 늘었다면 광고 내용과 실제 페이지가 다를 수 있습니다.`,
                    `경쟁사의 프로모션이나 시장 변화를 확인하세요. 외부 요인이 유입에 영향을 줄 수 있습니다.`
                ],
                '활동': [
                    `랜딩페이지 로딩 속도를 ${urgency} 개선하세요. 느린 페이지는 방문자를 즉시 떠나게 만듭니다.`,
                    `첫 화면의 메시지가 명확한지 확인하세요. 방문자가 5초 안에 "여기서 뭘 할 수 있는지" 이해해야 합니다.`,
                    `모바일 화면에서도 제대로 보이는지 테스트하세요. 많은 사용자가 모바일로 접속합니다.`
                ],
                '관심': [
                    `제품/서비스 설명을 더 구체적으로 작성하세요. 고객이 관심을 잃는 이유는 정보 부족일 수 있습니다.`,
                    `고객 후기와 리뷰를 더 눈에 띄게 배치하세요. 신뢰가 부족하면 관심이 떨어집니다.`,
                    `가격이나 혜택 정보를 더 일찍 보여주세요. 숨겨진 비용은 고객을 이탈시킵니다.`
                ],
                '결제진행': [
                    `결제 단계를 단순화하세요. 불필요한 정보 입력을 제거하고 필수 항목만 남기세요.`,
                    `배송비와 총 금액을 결제 전에 미리 보여주세요. 마지막에 예상보다 비싸면 이탈합니다.`,
                    `다양한 결제 수단을 제공하세요. 선호하는 결제 방법이 없으면 포기할 수 있습니다.`
                ],
                '구매완료': [
                    `결제 오류나 시스템 문제를 ${urgency} 점검하세요. 기술적 문제로 구매가 실패할 수 있습니다.`,
                    `마지막 단계의 보안 인증이 너무 복잡하지 않은지 확인하세요. 간편 결제 도입을 고려하세요.`,
                    `재고 부족 알림을 확인하세요. 품절로 인해 구매를 완료하지 못했을 수 있습니다.`
                ]
            };

            // 해당 단계의 추천 목록
            const recommendations = stageRecommendations[stage] || [
                `${stage} 단계의 고객 경험을 전반적으로 재검토하세요.`,
                `데이터를 분석하여 이탈의 근본 원인을 파악하세요.`,
                `A/B 테스트를 통해 다양한 개선안을 실험해보세요.`
            ];

            // 이탈률에 따라 추천 선택 (높을수록 더 긴급한 추천)
            const index = absChange > 15 ? 0 : absChange > 10 ? 1 : 2;
            return recommendations[index];
        }

        // ========================================
        // 인사이트 섹션용 이탈/성과 업데이트 함수
        // ========================================

        // 인사이트 섹션 - 이탈 위험 경고 업데이트
        function updateInsightChurnPredictions(period) {
            const churnData = getChurnData();
            if (!churnData) return;

            const dataKey = period === '7d' ? 'churn_predictions_7d' : 'churn_predictions_30d';
            const predictions = churnData[dataKey] || [];
            const periodText = period === '7d' ? '최근 7일 vs 이전 7일' : '최근 30일 vs 이전 30일';

            const churnContainer = document.getElementById('insightChurnPredictions');
            if (!churnContainer) return;

            if (predictions.length > 0) {
                churnContainer.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 14px; color: var(--error-main); font-weight: 600; margin-bottom: 12px;">
                            ⚠️ ${predictions.length}개 퍼널 단계에서 이탈 위험 감지
                        </p>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        ${predictions.map(pred => {
                            const customRecommendation = getChurnRecommendation(pred.stage, pred.change_pct, pred.risk_level);
                            return `
                            <div style="padding: 16px; background: ${pred.risk_level === 'high' ? 'var(--error-light)' : 'var(--warning-light)'}; border-radius: 8px; border-left: 4px solid ${pred.risk_level === 'high' ? 'var(--error-main)' : 'var(--warning-main)'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 16px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                            ${pred.stage} 단계
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700);">
                                            ${periodText}: <strong style="color: var(--error-main);">${pred.change_pct}%</strong> 감소
                                        </div>
                                    </div>
                                    <span style="font-size: 12px; padding: 4px 12px; background: ${pred.risk_level === 'high' ? 'var(--error-main)' : 'var(--warning-main)'}; color: white; border-radius: 12px; font-weight: 600;">
                                        ${pred.risk_level === 'high' ? '높음' : '중간'}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px; color: var(--grey-700); margin-bottom: 12px;">
                                    <span>최근 평균: <strong>${formatNumber(pred.recent_avg)}</strong>명</span>
                                    <span>이전 평균: <strong>${formatNumber(pred.previous_avg)}</strong>명</span>
                                </div>
                                <div style="font-size: 13px; color: var(--grey-900); padding: 12px; background: white; border-radius: 6px; line-height: 1.6;">
                                    💡 <strong>우선 조치:</strong> ${customRecommendation}
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } else {
                churnContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--success-main);">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">이탈 위험 없음</p>
                        <p style="font-size: 14px; color: var(--grey-600);">모든 퍼널 단계가 안정적입니다.</p>
                    </div>
                `;
            }
        }

        // 인사이트 섹션 - 성과 개선 분석 업데이트
        function updateInsightImprovementPredictions(period) {
            const churnData = getChurnData();
            if (!churnData) return;

            const dataKey = period === '7d' ? 'improvement_predictions_7d' : 'improvement_predictions_30d';
            const predictions = churnData[dataKey] || [];
            const periodText = period === '7d' ? '최근 7일 vs 이전 7일' : '최근 30일 vs 이전 30일';

            const improvementContainer = document.getElementById('insightImprovementPredictions');
            if (!improvementContainer) return;

            if (predictions.length > 0) {
                improvementContainer.innerHTML = `
                    <div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid var(--success-main);">
                        <p style="font-size: 15px; color: var(--success-main); font-weight: 600; margin-bottom: 6px;">
                            🎉 축하합니다! ${predictions.length}개 단계에서 성과가 좋아졌습니다
                        </p>
                        <p style="font-size: 13px; color: var(--grey-700);">
                            각 개선 사항마다 구체적인 실행 방법을 확인하여 이 성과를 계속 유지하세요.
                        </p>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        ${predictions.map(pred => {
                            const customRecommendation = getImprovementRecommendation(pred.stage, pred.change_pct, pred.improvement_level);
                            const improvementPercent = Math.abs(parseFloat(pred.change_pct));
                            const improvementLabel = improvementPercent > 15 ? '탁월한 개선!' : improvementPercent > 10 ? '좋은 개선!' : '긍정적 변화';

                            return `
                            <div style="padding: 16px; background: var(--success-light); border-radius: 8px; border-left: 4px solid var(--success-main);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 16px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                            ${pred.stage} 단계
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700);">
                                            ${periodText}: <strong style="color: var(--success-main);">+${pred.change_pct}%</strong> 증가
                                        </div>
                                    </div>
                                    <span style="font-size: 12px; padding: 4px 12px; background: var(--success-main); color: white; border-radius: 12px; font-weight: 600;">
                                        ${improvementLabel}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px; color: var(--grey-700); margin-bottom: 12px;">
                                    <span>최근 평균: <strong>${formatNumber(pred.recent_avg)}</strong>명</span>
                                    <span>이전 평균: <strong>${formatNumber(pred.previous_avg)}</strong>명</span>
                                </div>
                                <div style="font-size: 13px; color: var(--grey-900); padding: 12px; background: white; border-radius: 6px; line-height: 1.6;">
                                    🎯 <strong>성과 유지 방법:</strong> ${customRecommendation}
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } else {
                improvementContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--grey-500);">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                        </svg>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">성과 개선 데이터 없음</p>
                        <p style="font-size: 14px; color: var(--grey-600);">선택한 기간에 눈에 띄는 성과 개선이 감지되지 않았습니다.</p>
                    </div>
                `;
            }
        }

        // ========================================

        // 이탈 위험 경고 업데이트 (period: '7d' or '30d') - 기존 (데이터 기반 섹션용 - 사용 안함)
        // 이탈 분석은 항상 전체 기간 데이터만 사용
        function updateChurnPredictions(period) {
            const churnData = getChurnData();
            if (!churnData) return;

            const dataKey = period === '7d' ? 'churn_predictions_7d' : 'churn_predictions_30d';
            const predictions = churnData[dataKey] || [];
            const periodText = period === '7d' ? '최근 7일 vs 이전 7일' : '최근 30일 vs 이전 30일';

            const churnContainer = document.getElementById('churnPredictions');
            if (predictions.length > 0) {
                churnContainer.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 14px; color: var(--error-main); font-weight: 600; margin-bottom: 12px;">
                            ⚠️ ${predictions.length}개 퍼널 단계에서 이탈 위험 감지
                        </p>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        ${predictions.map(pred => {
                            const customRecommendation = getChurnRecommendation(pred.stage, pred.change_pct, pred.risk_level);
                            return `
                            <div style="padding: 16px; background: ${pred.risk_level === 'high' ? 'var(--error-light)' : 'var(--warning-light)'}; border-radius: 8px; border-left: 4px solid ${pred.risk_level === 'high' ? 'var(--error-main)' : 'var(--warning-main)'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 16px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                            ${pred.stage} 단계
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700);">
                                            ${periodText}: <strong style="color: var(--error-main);">${pred.change_pct}%</strong> 감소
                                        </div>
                                    </div>
                                    <span style="font-size: 12px; padding: 4px 12px; background: ${pred.risk_level === 'high' ? 'var(--error-main)' : 'var(--warning-main)'}; color: white; border-radius: 12px; font-weight: 600;">
                                        ${pred.risk_level === 'high' ? '높음' : '중간'}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px; color: var(--grey-700); margin-bottom: 12px;">
                                    <span>최근 평균: <strong>${formatNumber(pred.recent_avg)}</strong>명</span>
                                    <span>이전 평균: <strong>${formatNumber(pred.previous_avg)}</strong>명</span>
                                </div>
                                <div style="font-size: 13px; color: var(--grey-900); padding: 12px; background: white; border-radius: 6px; line-height: 1.6;">
                                    💡 <strong>우선 조치:</strong> ${customRecommendation}
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } else {
                churnContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--success-main);">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 48px; height: 48px; margin-bottom: 12px;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">이탈 위험 없음</p>
                        <p style="font-size: 14px; color: var(--grey-600);">모든 퍼널 단계가 안정적입니다.</p>
                    </div>
                `;
            }

        }

        // 단계별 맞춤 개선 유지 추천 생성
        function getImprovementRecommendation(stage, changePercent, improvementLevel) {
            const absChange = Math.abs(parseFloat(changePercent));

            // 단계별 맞춤 추천 - 구체적이고 즉시 실행 가능한 액션
            const stageRecommendations = {
                '유입': [
                    // 높은 증가율 (15% 이상)
                    `<strong>지금 바로:</strong> 1) 성과가 좋은 광고 캠페인의 예산을 20-30% 증액하세요 2) 광고 소재(이미지, 문구)를 스크린샷으로 저장하여 성공 템플릿을 만드세요 3) 같은 방식을 다른 채널에도 테스트하세요`,
                    // 중간 증가율 (10-15%)
                    `<strong>성공 요인 분석:</strong> 1) 최근 7일간 어떤 광고/채널에서 유입이 늘었는지 Google Analytics에서 확인하세요 2) 프로모션이나 할인 이벤트를 진행했다면 날짜와 효과를 엑셀에 기록하세요 3) 계절성 요인(명절, 휴가철 등)이 있는지 체크하세요`,
                    // 낮은 증가율 (10% 미만)
                    `<strong>현상 유지 + 추가 성장:</strong> 1) 현재 광고비 배분을 그대로 유지하세요 2) 신규 키워드나 타겟 오디언스를 1-2개 추가로 테스트하세요 (전체 예산의 10% 이내) 3) 주간 단위로 성과를 모니터링하세요`
                ],
                '활동': [
                    // 높은 증가율
                    `<strong>즉시 실행:</strong> 1) 최근 변경한 랜딩 페이지 디자인이나 문구가 있다면 절대 되돌리지 마세요 2) 페이지 로딩 속도를 PageSpeed Insights로 측정하여 3초 이내 유지하세요 3) 모바일 화면에서 첫 화면이 잘 보이는지 직접 확인하세요`,
                    // 중간 증가율
                    `<strong>효과 검증:</strong> 1) Google Analytics에서 '참여 세션' 지표를 확인하세요 (행동 > 사이트 콘텐츠) 2) 사용자가 가장 많이 클릭하는 버튼이나 링크를 Hotjar 같은 도구로 확인하세요 3) 스크롤 깊이를 측정하여 콘텐츠가 잘 읽히는지 체크하세요`,
                    // 낮은 증가율
                    `<strong>개선 유지:</strong> 1) 첫 화면에 표시되는 핵심 메시지를 변경하지 마세요 2) CTA 버튼(가입하기, 더 알아보기 등)의 색상과 위치를 고정하세요 3) 주 1회 이탈률을 체크하여 갑작스러운 변화가 없는지 확인하세요`
                ],
                '관심': [
                    // 높은 증가율
                    `<strong>지금 당장:</strong> 1) 상품 상세 페이지에 추가한 이미지나 설명이 있다면 다른 상품에도 동일하게 적용하세요 2) 고객 후기를 최소 10개 이상 노출하세요 (없으면 구매 고객에게 리뷰 작성 요청 이메일 발송) 3) FAQ 섹션을 추가하여 자주 묻는 질문 5가지를 답변하세요`,
                    // 중간 증가율
                    `<strong>관심 강화:</strong> 1) 제품 사진을 다양한 각도에서 최소 5장 이상 제공하세요 2) 사용 전/후 비교 이미지나 영상을 추가하세요 3) "이 상품을 본 고객이 함께 본 상품" 추천 섹션을 만드세요`,
                    // 낮은 증가율
                    `<strong>트렌드 유지:</strong> 1) 상품명과 설명의 키워드를 변경하지 마세요 2) 가격 정책을 안정적으로 유지하세요 (잦은 가격 변동은 신뢰 저하) 3) 재고 부족 메시지가 뜨는 상품이 있는지 확인하고 보충하세요`
                ],
                '결제진행': [
                    // 높은 증가율
                    `<strong>핵심 유지 + 확장:</strong> 1) 최근 추가한 간편결제(카카오페이, 네이버페이 등)를 더 눈에 띄게 강조하세요 2) 결제 페이지를 절대 변경하지 마세요 3) 배송비 무료 기준이나 할인 정책을 그대로 유지하세요`,
                    // 중간 증가율
                    `<strong>신뢰 강화:</strong> 1) SSL 인증서(자물쇠 아이콘)가 브라우저에 제대로 표시되는지 확인하세요 2) 결제 페이지에 "안전한 결제" 문구와 보안 마크를 추가하세요 3) 개인정보 처리방침 링크가 명확히 보이게 하세요`,
                    // 낮은 증가율
                    `<strong>안정성 유지:</strong> 1) 결제 프로세스의 단계 수를 유지하세요 (현재 3-4단계 권장) 2) 필수 입력 항목을 줄이지도 늘리지도 마세요 3) 모바일에서 결제가 잘 되는지 직접 테스트하세요`
                ],
                '구매완료': [
                    // 높은 증가율
                    `<strong>매출 극대화:</strong> 1) 구매 확인 페이지에서 관련 상품 3개를 추천하세요 ("이 상품도 함께 구매하세요") 2) 구매 고객에게 "첫 리뷰 작성 시 500원 할인" 같은 인센티브를 제공하세요 3) 구매 후 3일 뒤 만족도 조사 이메일을 자동 발송하세요`,
                    // 중간 증가율
                    `<strong>재구매 유도:</strong> 1) 구매 완료 후 10일 뒤 "재구매 시 10% 할인 쿠폰" 이메일을 자동 발송하세요 2) 카카오톡 채널 추가 시 추가 혜택을 제공하세요 3) 배송 알림 문자에 다음 구매를 유도하는 링크를 넣으세요`,
                    // 낮은 증가율
                    `<strong>고객 관계 유지:</strong> 1) 구매 감사 이메일을 발송하세요 (개인화된 메시지 권장) 2) 배송 조회 링크를 명확히 제공하세요 3) 고객 센터 연락처를 구매 확인 페이지에 눈에 띄게 표시하세요`
                ]
            };

            // 해당 단계의 추천 목록
            const recommendations = stageRecommendations[stage] || [
                `${stage} 단계의 성과가 좋아지고 있습니다. 현재 전략을 유지하면서 추가 개선 기회를 찾아보세요.`,
                `최근 변경 사항을 문서화하고, 성공 요인을 다른 채널이나 상품에도 적용하세요.`,
                `A/B 테스트를 통해 추가 최적화 여지를 확인하고, 데이터 기반으로 의사결정하세요.`
            ];

            // 개선율에 따라 추천 선택 (높을수록 더 적극적인 추천)
            const index = absChange > 15 ? 0 : absChange > 10 ? 1 : 2;
            return recommendations[index];
        }

        // 성과 개선 분석 업데이트 (period: '7d' or '30d')
        // 이탈/개선 분석은 항상 전체 기간 데이터만 사용
        function updateImprovementPredictions(period) {
            const churnData = getChurnData();
            if (!churnData) return;

            const dataKey = period === '7d' ? 'improvement_predictions_7d' : 'improvement_predictions_30d';
            const predictions = churnData[dataKey] || [];
            const periodText = period === '7d' ? '최근 7일 vs 이전 7일' : '최근 30일 vs 이전 30일';

            const improvementContainer = document.getElementById('improvementPredictions');
            if (predictions.length > 0) {
                improvementContainer.innerHTML = `
                    <div style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 8px; border-left: 4px solid var(--success-main);">
                        <p style="font-size: 15px; color: var(--success-main); font-weight: 600; margin-bottom: 6px;">
                            🎉 축하합니다! ${predictions.length}개 단계에서 성과가 좋아졌습니다
                        </p>
                        <p style="font-size: 13px; color: var(--grey-700);">
                            각 개선 사항마다 구체적인 실행 방법을 확인하여 이 성과를 계속 유지하세요.
                        </p>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        ${predictions.map(pred => {
                            const customRecommendation = getImprovementRecommendation(pred.stage, pred.change_pct, pred.improvement_level);
                            const improvementPercent = Math.abs(parseFloat(pred.change_pct));
                            const improvementLabel = improvementPercent > 15 ? '탁월한 개선!' : improvementPercent > 10 ? '좋은 개선!' : '긍정적 변화';

                            return `
                            <div style="padding: 16px; background: ${pred.improvement_level === 'high' ? 'var(--success-light)' : '#e8f5e9'}; border-radius: 8px; border-left: 4px solid ${pred.improvement_level === 'high' ? 'var(--success-main)' : '#66bb6a'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 16px; font-weight: 600; color: var(--grey-900); margin-bottom: 4px;">
                                            📈 ${pred.stage} 단계 고객 수 증가
                                        </div>
                                        <div style="font-size: 13px; color: var(--grey-700);">
                                            ${periodText} 비교: <strong style="color: var(--success-main);">+${pred.change_pct}%</strong> 증가 (${formatNumber(pred.previous_avg)}명 → ${formatNumber(pred.recent_avg)}명)
                                        </div>
                                    </div>
                                    <span style="font-size: 11px; padding: 6px 12px; background: ${pred.improvement_level === 'high' ? 'var(--success-main)' : '#66bb6a'}; color: white; border-radius: 12px; font-weight: 600; white-space: nowrap;">
                                        ${improvementLabel}
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: var(--grey-900); padding: 14px; background: white; border-radius: 6px; line-height: 1.8; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div style="font-weight: 600; color: var(--success-main); margin-bottom: 8px;">
                                        ✅ 이 성과를 유지하려면 지금 바로 실행하세요:
                                    </div>
                                    <div style="color: var(--grey-800);">
                                        ${customRecommendation}
                                    </div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } else {
                improvementContainer.innerHTML = `
                    <div style="padding: 30px 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--grey-800);">현재 기간에는 개선된 단계가 없습니다</p>
                        <p style="font-size: 14px; color: var(--grey-600); margin-bottom: 20px; line-height: 1.6;">
                            이전 기간과 비교하여 유의미한 성과 향상이 감지되지 않았습니다.<br>
                            이는 성과가 나쁘다는 뜻이 아니라, <strong>비슷한 수준을 유지</strong>하고 있다는 의미입니다.
                        </p>
                        <div style="background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%); padding: 16px; border-radius: 8px; text-align: left; max-width: 500px; margin: 0 auto;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-800); margin-bottom: 8px;">
                                💡 이럴 때 확인할 점:
                            </div>
                            <div style="font-size: 13px; color: var(--grey-700); line-height: 1.7;">
                                1. <strong>"경고: 이탈 위험 증가"</strong> 섹션을 확인하여 악화된 부분이 있는지 체크하세요<br>
                                2. 위 버튼에서 <strong>"최근 30일"</strong>로 기간을 변경하여 장기 트렌드를 확인하세요<br>
                                3. 성과를 더 높이려면 새로운 마케팅 전략이나 A/B 테스트를 시도하세요
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 이탈률 계산 함수
        function calculateChurnRates(row) {
            const acquisition = parseFloat(row['유입']) || 0;
            const activation = parseFloat(row['활동']) || 0;
            const consideration = parseFloat(row['관심']) || 0;
            const conversion = parseFloat(row['결제진행']) || 0;
            const purchase = parseFloat(row['구매완료']) || 0;

            // 전체 이탈률 = (유입 - 구매완료) / 유입 × 100
            const totalChurn = acquisition > 0 ? ((acquisition - purchase) / acquisition * 100) : 0;

            // 단계별 이탈률
            const activationChurn = acquisition > 0 ? ((acquisition - activation) / acquisition * 100) : 0;
            const considerationChurn = activation > 0 ? ((activation - consideration) / activation * 100) : 0;
            const conversionChurn = consideration > 0 ? ((consideration - conversion) / consideration * 100) : 0;
            const purchaseChurn = conversion > 0 ? ((conversion - purchase) / conversion * 100) : 0;

            // 단계별 최대 이탈률
            const maxChurn = Math.max(activationChurn, considerationChurn, conversionChurn, purchaseChurn);

            // 평균 이탈률
            const avgChurn = (activationChurn + considerationChurn + conversionChurn + purchaseChurn) / 4;

            return {
                total: totalChurn,
                max: maxChurn,
                avg: avgChurn,
                activation: activationChurn,
                consideration: considerationChurn,
                conversion: conversionChurn,
                purchase: purchaseChurn
            };
        }

        // KPI 차트 자동 분석 함수
        function analyzeKpiChartData(data, kpiType) {
            if (data.length === 0) return;

            const kpiNames = {
                cvr: '전환율',
                acquisition: '방문자 수',
                activation: '활성 사용자',
                consideration: '관심 고객',
                conversion: '결제 시도',
                purchase: '구매 건수',
                revenue: '매출'
            };

            const kpiKeys = {
                cvr: 'CVR',
                acquisition: '유입',
                activation: '활동',
                consideration: '관심',
                conversion: '결제진행',
                purchase: '구매완료',
                revenue: 'Revenue'
            };

            const currentKpiName = kpiNames[kpiType];
            const currentKpiKey = kpiKeys[kpiType];

            // 데이터 추출 및 정렬
            const sortedData = [...data].map(row => ({
                channel: row['channel'],
                value: kpiType === 'cvr' ? parseFloat(row[currentKpiKey]) || 0 : parseFloat(row[currentKpiKey]) || 0
            })).sort((a, b) => b.value - a.value);

            const top1 = sortedData[0];
            const top2 = sortedData[1];
            const top3 = sortedData[2];
            const bottom = sortedData[sortedData.length - 1];

            // 평균 계산
            const avgValue = sortedData.reduce((sum, item) => sum + item.value, 0) / sortedData.length;

            // 표준편차 계산 (데이터 편차 파악)
            const variance = sortedData.reduce((sum, item) => sum + Math.pow(item.value - avgValue, 2), 0) / sortedData.length;
            const stdDev = Math.sqrt(variance);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 1. 1등 채널 정보
            insightHTML += `<strong style="color: #2196f3;">🥇 1위 채널:</strong> `;
            insightHTML += `<strong>${top1.channel}</strong>이 ${currentKpiName}에서 1등입니다 `;
            if (kpiType === 'cvr') {
                insightHTML += `(${top1.value.toFixed(2)}%). `;
                if (top1.value > 3) {
                    insightHTML += `매우 우수한 전환율이므로 광고 예산을 더 투자하세요! `;
                } else if (top1.value > 1.5) {
                    insightHTML += `양호한 전환율입니다. `;
                } else {
                    insightHTML += `전환율이 낮은 편입니다. 전반적인 개선이 필요합니다. `;
                }
            } else if (kpiType === 'revenue') {
                insightHTML += `(₩${formatNumber(top1.value)}). `;
                insightHTML += `이 채널의 성공 요인을 분석하여 다른 채널에 적용하세요. `;
            } else {
                insightHTML += `(${formatNumber(top1.value)}명). `;
            }

            // 2. 1등과 2등의 격차
            const gap = top1.value - top2.value;
            const gapPercent = (gap / top1.value * 100);
            if (gapPercent > 30) {
                insightHTML += `<br><br><strong style="color: #ff9800;">⚠️ 주의:</strong> `;
                insightHTML += `1위와 2위의 격차가 ${gapPercent.toFixed(0)}%로 매우 큽니다. `;
                insightHTML += `<strong>${top1.channel}</strong>에 과도하게 의존하고 있으므로, 다른 채널도 육성하여 리스크를 분산하세요. `;
            } else {
                insightHTML += `2위는 <strong>${top2.channel}</strong>이며, 1위와의 격차는 ${gapPercent.toFixed(0)}%입니다. `;
            }

            // 3. 상위 vs 하위 비교
            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 전체 분석:</strong> `;
            const topBottomRatio = top1.value / (bottom.value || 1);
            if (topBottomRatio > 10) {
                insightHTML += `최고와 최저의 차이가 ${topBottomRatio.toFixed(1)}배로 매우 큽니다. `;
                insightHTML += `<strong>${bottom.channel}</strong> 같은 저성과 채널은 일시 중단을 검토하고, `;
                insightHTML += `예산을 상위 채널로 재배분하세요. `;
            } else if (topBottomRatio > 3) {
                insightHTML += `채널 간 성과 차이가 ${topBottomRatio.toFixed(1)}배로 존재합니다. `;
                insightHTML += `저성과 채널의 원인을 분석하고 개선하세요. `;
            } else {
                insightHTML += `채널 간 성과가 비교적 고르게 분포되어 있습니다. `;
            }

            // 4. 지표별 맞춤 추천
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 ${currentKpiName} 개선 전략:</strong> `;
            switch(kpiType) {
                case 'cvr':
                    if (avgValue < 1.5) {
                        insightHTML += `전체 평균 CVR이 ${avgValue.toFixed(2)}%로 낮습니다. 랜딩 페이지 개선과 타겟팅 정밀화가 시급합니다. `;
                    } else if (avgValue > 3) {
                        insightHTML += `전체 평균 CVR이 ${avgValue.toFixed(2)}%로 우수합니다! 현재 전략을 유지하세요. `;
                    } else {
                        insightHTML += `전체 평균 CVR은 ${avgValue.toFixed(2)}%입니다. A/B 테스트로 추가 개선을 시도하세요. `;
                    }
                    break;
                case 'revenue':
                    insightHTML += `<strong>${top1.channel}</strong>이 전체 매출의 핵심입니다. `;
                    insightHTML += `이 채널의 광고 소재, 타겟팅, 랜딩 페이지를 분석하여 다른 채널에 적용하세요. `;
                    break;
                case 'acquisition':
                    insightHTML += `방문자가 많다고 좋은 것은 아닙니다. `;
                    insightHTML += `CVR과 함께 비교하여 효율적인 채널에 집중 투자하세요. `;
                    break;
                default:
                    insightHTML += `상위 3개 채널(<strong>${top1.channel}, ${top2.channel}, ${top3.channel}</strong>)에 집중하여 최적화하세요. `;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('kpiChartInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // KPI 차트 업데이트 (CVR, 유입, 활동, 관심, 결제진행, 구매완료, 매출)
        function updateKpiChart(kpiType = 'cvr') {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('channelKpiChart');
            if (!ctx) return;

            if (channelKpiChart) {
                channelKpiChart.destroy();
            }

            // 현재 KPI 타입 저장
            currentKpiType = kpiType;

            // KPI별 설정
            const kpiConfig = {
                cvr: {
                    label: 'CVR (%)',
                    key: 'CVR',
                    color: '#673ab7',
                    format: (val) => formatDecimal(val) + '%',
                    getValue: (row) => parseFloat(row['CVR']) || 0
                },
                acquisition: {
                    label: '유입 (명)',
                    key: '유입',
                    color: '#2196f3',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['유입']) || 0
                },
                activation: {
                    label: '활동 (명)',
                    key: '활동',
                    color: '#00bcd4',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['활동']) || 0
                },
                consideration: {
                    label: '관심 (명)',
                    key: '관심',
                    color: '#ff9800',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['관심']) || 0
                },
                conversion: {
                    label: '결제진행 (명)',
                    key: '결제진행',
                    color: '#4caf50',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['결제진행']) || 0
                },
                purchase: {
                    label: '구매완료 (명)',
                    key: '구매완료',
                    color: '#00c853',
                    format: (val) => formatNumber(val) + '명',
                    getValue: (row) => parseFloat(row['구매완료']) || 0
                },
                revenue: {
                    label: '매출 (원)',
                    key: 'Revenue',
                    color: '#f44336',
                    format: (val) => formatNumber(val) + '원',
                    getValue: (row) => parseFloat(row['Revenue']) || 0
                }
            };

            const config = kpiConfig[kpiType];
            if (!config) return;

            // 선택된 KPI 기준으로 정렬 (DESC)
            const sortedData = [...channelData].sort((a, b) => {
                const aVal = config.getValue(a);
                const bVal = config.getValue(b);
                return bVal - aVal;
            }).slice(0, 10);

            const labels = sortedData.map(row => row['channel']);
            const values = sortedData.map(row => config.getValue(row));

            channelKpiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: config.label,
                        data: values,
                        backgroundColor: config.color.replace(')', ', 0.8)').replace('rgb', 'rgba'),
                        borderColor: config.color,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return config.label + ': ' + config.format(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: config.label
                            }
                        }
                    }
                }
            });

            // KPI 데이터 분석 및 인사이트 생성
            analyzeKpiChartData(channelData, kpiType);

            // 툴팁 이벤트 설정
            setupKpiChartTooltip();
        }

        // KPI 차트 툴팁 설정
        function setupKpiChartTooltip() {
            const canvas = document.getElementById('channelKpiChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            // Remove existing listeners by cloning container
            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateKpiInsight(currentKpiType);
                    showChartInsightTooltip('kpiChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('kpiChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('kpiChartTooltip');
                });
            }
        }

        // 이탈률 자동 분석 함수
        function analyzeChurnRates(allData, currentStage) {
            if (allData.length === 0) return;

            // 각 단계별 평균 이탈률 계산
            let totalActivation = 0, totalConsideration = 0, totalConversion = 0, totalPurchase = 0;

            allData.forEach(row => {
                const churnRates = calculateChurnRates(row);
                totalActivation += churnRates.activation;
                totalConsideration += churnRates.consideration;
                totalConversion += churnRates.conversion;
                totalPurchase += churnRates.purchase;
            });

            const avgActivation = totalActivation / allData.length;
            const avgConsideration = totalConsideration / allData.length;
            const avgConversion = totalConversion / allData.length;
            const avgPurchase = totalPurchase / allData.length;

            // 산업 평균 벤치마크 (일반적인 범위의 중간값)
            const benchmarks = {
                activation: { min: 40, max: 60, avg: 50, label: '유입→활동' },
                consideration: { min: 50, max: 70, avg: 60, label: '활동→관심' },
                conversion: { min: 60, max: 80, avg: 70, label: '관심→결제진행' },
                purchase: { min: 20, max: 30, avg: 25, label: '결제진행→구매완료' }
            };

            // 가장 높은 이탈률을 보이는 단계 찾기
            const stageAverages = [
                { stage: 'activation', avg: avgActivation, label: '유입→활동' },
                { stage: 'consideration', avg: avgConsideration, label: '활동→관심' },
                { stage: 'conversion', avg: avgConversion, label: '관심→결제진행' },
                { stage: 'purchase', avg: avgPurchase, label: '결제진행→구매완료' }
            ];

            const highestChurnStage = stageAverages.reduce((max, item) =>
                item.avg > max.avg ? item : max, stageAverages[0]
            );

            // 해당 단계에서 이탈률이 가장 높은 채널들 찾기
            const channelsWithHighChurn = allData.map(row => {
                const churnRates = calculateChurnRates(row);
                return {
                    channel: row['channel'],
                    churnRate: churnRates[highestChurnStage.stage]
                };
            }).sort((a, b) => b.churnRate - a.churnRate).slice(0, 3);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 전체 상황 요약
            insightHTML += `가장 많은 고객이 이탈하는 구간은 <strong style="color: #ff5722;">${highestChurnStage.label}</strong> 단계로, `;
            insightHTML += `평균 <strong style="color: #ff5722;">${highestChurnStage.avg.toFixed(1)}%</strong>의 고객이 이 단계에서 떠납니다. `;

            // 산업 평균과 비교
            const benchmark = benchmarks[highestChurnStage.stage];
            if (highestChurnStage.avg > benchmark.max) {
                insightHTML += `<strong style="color: var(--error-main);">⚠️ 산업 평균(${benchmark.min}-${benchmark.max}%)보다 높아 즉시 개선이 필요합니다!</strong> `;
            } else if (highestChurnStage.avg < benchmark.min) {
                insightHTML += `<strong style="color: var(--success-main);">✅ 산업 평균(${benchmark.min}-${benchmark.max}%)보다 낮아 양호합니다!</strong> `;
            } else {
                insightHTML += `산업 평균(${benchmark.min}-${benchmark.max}%) 범위 내입니다. `;
            }

            // 문제 채널 강조
            insightHTML += `<br><br><strong style="color: var(--primary-main);">🎯 집중 개선 대상 채널:</strong><br>`;
            channelsWithHighChurn.forEach((item, index) => {
                insightHTML += `${index + 1}. <strong>${item.channel}</strong>: ${item.churnRate.toFixed(1)}% 이탈`;
                if (index < channelsWithHighChurn.length - 1) insightHTML += '<br>';
            });

            // 단계별 구체적인 추천사항
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 ${highestChurnStage.label} 이탈률 개선 방법:</strong><br>`;

            switch(highestChurnStage.stage) {
                case 'activation':
                    if (highestChurnStage.avg > 60) {
                        insightHTML += `• <strong>랜딩 페이지 로딩 속도</strong>를 3초 이내로 최적화하세요 (현재 이탈률이 매우 높음)<br>`;
                        insightHTML += `• 광고 문구와 랜딩 페이지의 <strong>메시지가 일치</strong>하는지 즉시 확인하세요<br>`;
                        insightHTML += `• 모바일 사용자 경험을 우선적으로 개선하세요`;
                    } else {
                        insightHTML += `• 첫 화면에 너무 많은 정보가 있는지 확인하고 <strong>핵심 메시지만 강조</strong>하세요<br>`;
                        insightHTML += `• 랜딩 페이지 디자인이 신뢰감을 주는지 점검하세요<br>`;
                        insightHTML += `• CTA(행동 유도) 버튼이 눈에 잘 띄는지 확인하세요`;
                    }
                    break;
                case 'consideration':
                    if (highestChurnStage.avg > 70) {
                        insightHTML += `• <strong>상세 페이지에 정보가 부족</strong>합니다. 제품 설명, 사양, 사용법을 보강하세요<br>`;
                        insightHTML += `• <strong>고객 리뷰와 평점</strong>을 눈에 띄게 배치하세요 (신뢰도 향상)<br>`;
                        insightHTML += `• 경쟁사 대비 차별화 포인트를 명확히 전달하세요`;
                    } else {
                        insightHTML += `• 제품 이미지의 품질을 높이고 다양한 각도로 제공하세요<br>`;
                        insightHTML += `• FAQ나 챗봇을 추가하여 즉시 궁금증을 해결하세요<br>`;
                        insightHTML += `• 사용 사례나 후기 영상을 추가하세요`;
                    }
                    break;
                case 'conversion':
                    if (highestChurnStage.avg > 75) {
                        insightHTML += `• <strong>가격이 너무 높거나</strong> 할인/프로모션이 부족합니다. 첫 구매 할인을 제공하세요<br>`;
                        insightHTML += `• <strong>회원가입 없이</strong> 게스트로 결제할 수 있게 하세요 (이탈률 크게 감소)<br>`;
                        insightHTML += `• 배송비가 높거나 배송 기간이 길면 명확히 안내하세요`;
                    } else {
                        insightHTML += `• "장바구니 담기" 버튼을 더 눈에 띄게 만드세요<br>`;
                        insightHTML += `• 재고 부족 시 알림 받기 기능을 제공하세요<br>`;
                        insightHTML += `• 위시리스트 기능으로 나중에 구매를 유도하세요`;
                    }
                    break;
                case 'purchase':
                    if (highestChurnStage.avg > 30) {
                        insightHTML += `• <strong>결제 과정이 너무 복잡</strong>합니다. 단계를 3단계 이하로 줄이세요<br>`;
                        insightHTML += `• <strong>카카오페이, 네이버페이</strong> 등 간편결제 옵션을 추가하세요 (이탈률 급감)<br>`;
                        insightHTML += `• 보안 인증서 표시로 결제 안전성을 강조하세요`;
                    } else {
                        insightHTML += `• 결제 단계마다 진행 상황 표시줄을 보여주세요<br>`;
                        insightHTML += `• 예상치 못한 추가 비용(배송비, 수수료)이 없는지 확인하세요<br>`;
                        insightHTML += `• 결제 실패 시 명확한 오류 메시지와 해결 방법을 제공하세요`;
                    }
                    break;
            }

            // 전체적인 이탈률 패턴 분석
            const allChurns = [avgActivation, avgConsideration, avgConversion, avgPurchase];
            const overallAvg = allChurns.reduce((sum, val) => sum + val, 0) / 4;

            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 전체 퍼널 상태:</strong> `;
            if (overallAvg > 60) {
                insightHTML += `전반적으로 이탈률이 높습니다. <strong>전체 고객 여정을 재검토</strong>하고, 각 단계마다 A/B 테스트를 진행하세요.`;
            } else if (overallAvg < 40) {
                insightHTML += `전반적으로 우수한 상태입니다! 현재 전략을 유지하면서 세부적인 최적화에 집중하세요.`;
            } else {
                insightHTML += `평균적인 수준입니다. 위의 개선 방법을 우선순위에 따라 하나씩 적용해보세요.`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('churnInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 이탈률 차트 업데이트 (퍼널 단계별 이탈률)
        function updateChurnChart(stage = null, sort = null) {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('channelChurnChart');
            if (!ctx) return;

            if (channelChurnChart) {
                channelChurnChart.destroy();
            }

            // 파라미터가 제공되면 전역 변수 업데이트
            if (stage !== null) currentChurnStage = stage;
            if (sort !== null) currentChurnSort = sort;

            // 퍼널 단계별 설정
            const stageConfig = {
                activation: {
                    label: '유입→활동 이탈률 (%)',
                    color: '#673ab7',
                    getValue: (row) => calculateChurnRates(row).activation,
                    tooltip: '(유입 - 활동) / 유입 × 100'
                },
                consideration: {
                    label: '활동→관심 이탈률 (%)',
                    color: '#2196f3',
                    getValue: (row) => calculateChurnRates(row).consideration,
                    tooltip: '(활동 - 관심) / 활동 × 100'
                },
                conversion: {
                    label: '관심→결제진행 이탈률 (%)',
                    color: '#ff9800',
                    getValue: (row) => calculateChurnRates(row).conversion,
                    tooltip: '(관심 - 결제진행) / 관심 × 100'
                },
                purchase: {
                    label: '결제진행→구매완료 이탈률 (%)',
                    color: '#4caf50',
                    getValue: (row) => calculateChurnRates(row).purchase,
                    tooltip: '(결제진행 - 구매완료) / 결제진행 × 100'
                },
                avg: {
                    label: '평균 이탈률 (%)',
                    color: '#e91e63',
                    getValue: (row) => calculateChurnRates(row).avg,
                    tooltip: '모든 단계 이탈률의 평균'
                }
            };

            const config = stageConfig[currentChurnStage];
            if (!config) return;

            // 데이터 정렬
            const sortedData = [...channelData].sort((a, b) => {
                const aVal = config.getValue(a);
                const bVal = config.getValue(b);
                return currentChurnSort === 'desc' ? (bVal - aVal) : (aVal - bVal);
            }).slice(0, 10);

            const labels = sortedData.map(row => row['channel']);
            const values = sortedData.map(row => config.getValue(row));

            channelChurnChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: config.label,
                        data: values,
                        backgroundColor: config.color.replace(')', ', 0.8)').replace('rgb', 'rgba'),
                        borderColor: config.color,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return config.label + ': ' + formatDecimal(context.parsed.x) + '%';
                                },
                                afterLabel: function(context) {
                                    return '계산식: ' + config.tooltip;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: config.label
                            }
                        }
                    }
                }
            });

            // 이탈률 자동 분석 실행
            analyzeChurnRates(channelData, currentChurnStage);

            // 툴팁 이벤트 설정
            setupChurnChartTooltip();
        }

        // 이탈률 차트 툴팁 설정
        function setupChurnChartTooltip() {
            const canvas = document.getElementById('channelChurnChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateChurnInsight();
                    showChartInsightTooltip('churnChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('churnChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('churnChartTooltip');
                });
            }
        }

        // 비교 차트 자동 분석 함수
        function analyzeCompareChartData(data) {
            if (data.length === 0) return;

            // 데이터 파싱 (상위 8개만, 차트와 동일)
            const sortedData = [...data].sort((a, b) =>
                (parseFloat(b['CVR']) || 0) - (parseFloat(a['CVR']) || 0)
            ).slice(0, 8).map(row => ({
                channel: row['channel'],
                cvr: parseFloat(row['CVR']) || 0,
                acquisition: parseFloat(row['유입']) || 0,
                purchase: parseFloat(row['구매완료']) || 0,
                revenue: parseFloat(row['Revenue']) || 0
            }));

            // 정규화 (100점 만점으로 환산)
            const maxCVR = Math.max(...sortedData.map(ch => ch.cvr));
            const maxAcquisition = Math.max(...sortedData.map(ch => ch.acquisition));
            const maxPurchase = Math.max(...sortedData.map(ch => ch.purchase));
            const maxRevenue = Math.max(...sortedData.map(ch => ch.revenue));

            const normalizedData = sortedData.map(ch => {
                const normCVR = maxCVR > 0 ? (ch.cvr / maxCVR * 100) : 0;
                const normAcquisition = maxAcquisition > 0 ? (ch.acquisition / maxAcquisition * 100) : 0;
                const normPurchase = maxPurchase > 0 ? (ch.purchase / maxPurchase * 100) : 0;
                const normRevenue = maxRevenue > 0 ? (ch.revenue / maxRevenue * 100) : 0;

                // 균형도 계산 (표준편차 기반)
                const values = [normCVR, normAcquisition, normPurchase, normRevenue];
                const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / values.length;
                const balance = 100 - Math.sqrt(variance); // 높을수록 균형잡힘

                return {
                    ...ch,
                    normCVR,
                    normAcquisition,
                    normPurchase,
                    normRevenue,
                    avg,
                    balance
                };
            });

            // 채널 유형 분류
            const perfectChannels = normalizedData.filter(ch => ch.avg >= 60 && ch.balance >= 50); // 모든 지표 고르게 높음
            const efficientSmallChannels = normalizedData.filter(ch => ch.normCVR >= 70 && ch.normAcquisition < 50); // CVR 높지만 규모 작음
            const inefficientLargeChannels = normalizedData.filter(ch => ch.normAcquisition >= 70 && ch.normCVR < 50); // 규모 크지만 효율 낮음
            const lowPerformers = normalizedData.filter(ch => ch.avg < 40); // 모든 지표 낮음

            // 최고 균형 채널
            const mostBalanced = normalizedData.reduce((max, ch) => ch.balance > max.balance ? ch : max, normalizedData[0]);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 1. 최고 균형 채널
            if (perfectChannels.length > 0) {
                insightHTML += `<strong style="color: #4caf50;">🌟 완벽한 채널:</strong> `;
                insightHTML += `<strong>${perfectChannels[0].channel}</strong>이 효율과 규모를 모두 갖춘 최고의 채널입니다. `;
                insightHTML += `모든 지표(CVR, 방문자, 구매, 매출)가 균형있게 높습니다. 최우선 투자 대상입니다! `;
            } else {
                insightHTML += `<strong style="color: #9c27b0;">💎 가장 균형잡힌 채널:</strong> `;
                insightHTML += `<strong>${mostBalanced.channel}</strong>이 상대적으로 가장 균형잡혀 있습니다 (균형도: ${mostBalanced.balance.toFixed(0)}점). `;
            }

            // 2. 숨겨진 보석 (효율은 좋은데 규모가 작음)
            if (efficientSmallChannels.length > 0) {
                insightHTML += `<br><br><strong style="color: #2196f3;">💎 숨겨진 보석:</strong> `;
                const gems = efficientSmallChannels.slice(0, 2).map(ch => ch.channel).join(', ');
                insightHTML += `<strong>${gems}</strong>은 전환율이 우수하지만 방문자가 적습니다. `;
                insightHTML += `<strong>광고 예산을 늘려 규모를 키우면 큰 효과</strong>를 볼 수 있습니다! `;
            }

            // 3. 개선 필요 채널 (규모는 큰데 효율 낮음)
            if (inefficientLargeChannels.length > 0) {
                insightHTML += `<br><br><strong style="color: #ff9800;">⚠️ 개선 기회:</strong> `;
                insightHTML += `<strong>${inefficientLargeChannels[0].channel}</strong>은 방문자는 많지만 (${formatNumber(inefficientLargeChannels[0].acquisition)}명) `;
                insightHTML += `전환율이 ${inefficientLargeChannels[0].cvr.toFixed(2)}%로 낮습니다. `;
                insightHTML += `<strong>랜딩 페이지와 타겟팅을 개선하면 매출이 크게 증가</strong>할 수 있습니다! `;
            }

            // 4. 저성과 채널
            if (lowPerformers.length > 0) {
                insightHTML += `<br><br><strong style="color: #f44336;">❌ 저성과 채널:</strong> `;
                const lowChannels = lowPerformers.map(ch => ch.channel).join(', ');
                insightHTML += `<strong>${lowChannels}</strong>은 모든 지표가 낮습니다. `;
                insightHTML += `일시 중단을 검토하고 예산을 상위 채널로 재배분하세요. `;
            }

            // 5. 전체적인 포트폴리오 평가
            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 채널 포트폴리오:</strong> `;
            insightHTML += `상위 8개 채널 중 `;
            if (perfectChannels.length > 0) {
                insightHTML += `<strong>${perfectChannels.length}개가 완벽</strong>, `;
            }
            if (efficientSmallChannels.length > 0) {
                insightHTML += `<strong>${efficientSmallChannels.length}개가 확장 가능</strong>, `;
            }
            if (inefficientLargeChannels.length > 0) {
                insightHTML += `<strong>${inefficientLargeChannels.length}개가 개선 필요</strong>, `;
            }
            if (lowPerformers.length > 0) {
                insightHTML += `<strong>${lowPerformers.length}개가 저성과</strong> `;
            }
            insightHTML += `상태입니다.`;

            // 6. 실행 가능한 추천
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 우선순위 액션:</strong> `;
            if (perfectChannels.length > 0) {
                insightHTML += `1) <strong>${perfectChannels[0].channel}</strong> 예산 30-50% 증액, `;
            }
            if (efficientSmallChannels.length > 0) {
                insightHTML += `2) <strong>${efficientSmallChannels[0].channel}</strong> 타겟 확대로 방문자 늘리기, `;
            }
            if (inefficientLargeChannels.length > 0) {
                insightHTML += `3) <strong>${inefficientLargeChannels[0].channel}</strong> 랜딩 페이지 A/B 테스트 시작`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('compareChartInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 비교 차트 업데이트 (채널별 종합 성과)
        function updateCompareChart() {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('channelCompareChart');
            if (!ctx) return;

            if (channelCompareChart) {
                channelCompareChart.destroy();
            }

            // 그룹화된 차트 표시
            updateGroupedChart(ctx);

            // 비교 차트 데이터 분석 및 인사이트 생성
            analyzeCompareChartData(channelData);

            // 툴팁 이벤트 설정
            setupCompareChartTooltip();
        }

        // 비교 차트 툴팁 설정
        function setupCompareChartTooltip() {
            const canvas = document.getElementById('channelCompareChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateCompareInsight();
                    showChartInsightTooltip('compareChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('compareChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('compareChartTooltip');
                });
            }
        }


        // 그룹화된 막대 차트
        function updateGroupedChart(ctx) {
            // CVR 기준으로 정렬
            const sortedData = [...channelData].sort((a, b) =>
                (parseFloat(b['CVR']) || 0) - (parseFloat(a['CVR']) || 0)
            ).slice(0, 8);

            const labels = sortedData.map(row => row['channel']);

            // 정규화를 위한 최대값 계산
            const maxAcquisition = Math.max(...sortedData.map(row => parseFloat(row['유입']) || 0));
            const maxPurchase = Math.max(...sortedData.map(row => parseFloat(row['구매완료']) || 0));
            const maxRevenue = Math.max(...sortedData.map(row => parseFloat(row['Revenue']) || 0));

            // 원본 데이터 저장
            const originalData = sortedData.map(row => ({
                cvr: parseFloat(row['CVR']) || 0,
                acquisition: parseFloat(row['유입']) || 0,
                purchase: parseFloat(row['구매완료']) || 0,
                revenue: parseFloat(row['Revenue']) || 0
            }));

            // 호버 상태 추적
            let hoveredIndex = null;

            channelCompareChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'CVR (%)',
                            data: sortedData.map(row => parseFloat(row['CVR']) || 0),
                            backgroundColor: 'rgba(103, 58, 183, 0.8)',
                            borderColor: '#673ab7',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.cvr)
                        },
                        {
                            label: '유입 (정규화)',
                            data: sortedData.map(row => ((parseFloat(row['유입']) || 0) / maxAcquisition * 100)),
                            backgroundColor: 'rgba(33, 150, 243, 0.8)',
                            borderColor: '#2196f3',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.acquisition)
                        },
                        {
                            label: '구매완료 (정규화)',
                            data: sortedData.map(row => ((parseFloat(row['구매완료']) || 0) / maxPurchase * 100)),
                            backgroundColor: 'rgba(0, 200, 83, 0.8)',
                            borderColor: '#00c853',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.purchase)
                        },
                        {
                            label: '매출 (정규화)',
                            data: sortedData.map(row => ((parseFloat(row['Revenue']) || 0) / maxRevenue * 100)),
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: '#f44336',
                            borderWidth: 1,
                            originalData: originalData.map(d => d.revenue)
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'y',
                        intersect: false
                    },
                    onHover: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            hoveredIndex = activeElements[0].index;
                        } else {
                            hoveredIndex = null;
                        }
                        this.update('none');
                    },
                    layout: {
                        padding: {
                            right: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const dataIndex = context.dataIndex;
                                    const originalValue = context.dataset.originalData[dataIndex];
                                    let label = context.dataset.label || '';

                                    if (label.includes('CVR')) {
                                        return label + ': ' + formatDecimal(originalValue) + '%';
                                    } else if (label.includes('유입')) {
                                        return '유입: ' + formatNumber(originalValue) + '명';
                                    } else if (label.includes('구매완료')) {
                                        return '구매완료: ' + formatNumber(originalValue) + '명';
                                    } else if (label.includes('매출')) {
                                        return '매출: ' + formatNumber(originalValue) + '원';
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                // 호버된 채널(index)인 경우에만 표시
                                return context.dataIndex === hoveredIndex;
                            },
                            anchor: function(context) {
                                const dataIndex = context.dataIndex;
                                // 해당 채널의 모든 데이터셋 값 가져오기
                                const values = context.chart.data.datasets.map(ds => ds.data[dataIndex]);
                                const maxValue = Math.max(...values);
                                const currentValue = context.dataset.data[dataIndex];

                                // 최댓값인 경우에만 'end', 아니면 표시하지 않음
                                return currentValue === maxValue ? 'end' : 'center';
                            },
                            align: 'end',
                            offset: 4,
                            clamp: true,
                            formatter: function(value, context) {
                                const dataIndex = context.dataIndex;
                                const datasetIndex = context.datasetIndex;

                                // 해당 채널의 모든 데이터셋 값 가져오기
                                const values = context.chart.data.datasets.map(ds => ds.data[dataIndex]);
                                const maxValue = Math.max(...values);
                                const currentValue = context.dataset.data[dataIndex];

                                // 최댓값인 데이터셋만 레이블 표시
                                if (currentValue !== maxValue) {
                                    return null;
                                }

                                const originalValue = context.dataset.originalData[dataIndex];
                                const label = context.dataset.label || '';

                                if (label.includes('CVR')) {
                                    return formatDecimal(originalValue) + '%';
                                } else if (label.includes('유입')) {
                                    return formatNumber(originalValue) + '명';
                                } else if (label.includes('구매완료')) {
                                    return formatNumber(originalValue) + '명';
                                } else if (label.includes('매출')) {
                                    return formatNumber(originalValue) + '원';
                                }
                                return '';
                            },
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            color: function(context) {
                                return context.dataset.borderColor;
                            },
                            backgroundColor: function(context) {
                                return 'rgba(255, 255, 255, 0.9)';
                            },
                            borderColor: function(context) {
                                return context.dataset.borderColor;
                            },
                            borderWidth: 1,
                            borderRadius: 4,
                            padding: 4
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: '정규화된 값 (0-100)'
                            }
                        }
                    }
                }
            });
        }

        // 캠페인 차트 업데이트
        function updateCampaignChart(funnelType = 'purchase') {
            if (channelData.length === 0) return;

            const ctx = document.getElementById('campaignChart');
            if (!ctx) return;

            // 현재 퍼널 타입 저장
            currentChannelFunnel = funnelType;

            // 퍼널별 키 매핑
            const funnelKeyMap = {
                'activation': '활동',
                'consideration': '관심',
                'conversion': '결제진행',
                'purchase': '구매완료'
            };

            const funnelKey = funnelKeyMap[funnelType];

            // 각 채널의 전환율 계산 (유입 대비 해당 단계)
            const channelConversionData = channelData.map(row => {
                const acquisition = parseFloat(row['유입']) || 0;
                const funnelValue = parseFloat(row[funnelKey]) || 0;
                const conversionRate = acquisition > 0 ? (funnelValue / acquisition * 100) : 0;

                return {
                    channel: row['channel'],
                    conversionRate: conversionRate
                };
            });

            // 전환율 기준 상위 10개 정렬
            const sortedData = channelConversionData
                .sort((a, b) => b.conversionRate - a.conversionRate)
                .slice(0, 10);

            const labels = sortedData.map(row => {
                const name = row.channel;
                return name.length > 20 ? name.substring(0, 20) + '...' : name;
            });
            const conversionData = sortedData.map(row => row.conversionRate);

            if (campaignChart) {
                campaignChart.destroy();
            }

            // 퍼널별 색상 설정
            const colorMap = {
                'activation': { bg: 'rgba(33, 150, 243, 0.8)', border: '#2196f3' },
                'consideration': { bg: 'rgba(255, 152, 0, 0.8)', border: '#ff9800' },
                'conversion': { bg: 'rgba(76, 175, 80, 0.8)', border: '#4caf50' },
                'purchase': { bg: 'rgba(0, 200, 83, 0.8)', border: '#00c853' }
            };

            const colors = colorMap[funnelType];

            // 퍼널별 레이블
            const labelMap = {
                'activation': '활동 전환율 (%)',
                'consideration': '관심 전환율 (%)',
                'conversion': '결제진행 전환율 (%)',
                'purchase': '구매완료 전환율 (%)'
            };

            campaignChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: labelMap[funnelType],
                        data: conversionData,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return labelMap[funnelType] + ': ' + formatDecimal(context.parsed.x) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '전환율 (%)'
                            }
                        }
                    }
                }
            });
        }

        // 채널 테이블 업데이트
        // 채널 테이블 데이터 자동 분석 함수
        function analyzeChannelTableData(data) {
            if (data.length === 0) return;

            // 데이터 파싱 및 계산
            const channelStats = data.map(row => {
                const acquisition = parseFloat(row['유입']) || 0;
                const activation = parseFloat(row['활동']) || 0;
                const consideration = parseFloat(row['관심']) || 0;
                const conversion = parseFloat(row['결제진행']) || 0;
                const purchase = parseFloat(row['구매완료']) || 0;
                const revenue = parseFloat(row['Revenue']) || 0;
                const cvr = parseFloat(row['CVR']) || 0;

                // 단계별 이탈률 계산
                const activationChurn = acquisition > 0 ? ((acquisition - activation) / acquisition * 100) : 0;
                const considerationChurn = activation > 0 ? ((activation - consideration) / activation * 100) : 0;
                const conversionChurn = consideration > 0 ? ((consideration - conversion) / consideration * 100) : 0;
                const purchaseChurn = conversion > 0 ? ((conversion - purchase) / conversion * 100) : 0;

                return {
                    channel: row['channel'],
                    acquisition,
                    activation,
                    consideration,
                    conversion,
                    purchase,
                    revenue,
                    cvr,
                    activationChurn,
                    considerationChurn,
                    conversionChurn,
                    purchaseChurn
                };
            });

            // CVR 상위 3개 채널
            const topCVRChannels = [...channelStats]
                .sort((a, b) => b.cvr - a.cvr)
                .slice(0, 3);

            // 매출 상위 채널
            const topRevenueChannels = [...channelStats]
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 3);

            // CVR 평균
            const avgCVR = channelStats.reduce((sum, ch) => sum + ch.cvr, 0) / channelStats.length;

            // 매출 높지만 CVR 낮은 채널 찾기 (매출 상위 50%, CVR 평균 이하)
            const revenueMedian = channelStats.sort((a, b) => b.revenue - a.revenue)[Math.floor(channelStats.length / 2)].revenue;
            const highRevenueLowCVR = channelStats.filter(ch => ch.revenue >= revenueMedian && ch.cvr < avgCVR);

            // 유입→활동 이탈률이 높은 채널 (50% 이상)
            const highEarlyChurn = channelStats.filter(ch => ch.activationChurn >= 50);

            // 전체 평균 이탈률
            const avgActivationChurn = channelStats.reduce((sum, ch) => sum + ch.activationChurn, 0) / channelStats.length;
            const avgConsiderationChurn = channelStats.reduce((sum, ch) => sum + ch.considerationChurn, 0) / channelStats.length;
            const avgConversionChurn = channelStats.reduce((sum, ch) => sum + ch.conversionChurn, 0) / channelStats.length;
            const avgPurchaseChurn = channelStats.reduce((sum, ch) => sum + ch.purchaseChurn, 0) / channelStats.length;

            // 가장 이탈률이 높은 단계 찾기
            const churnStages = [
                { stage: '유입→활동', avg: avgActivationChurn },
                { stage: '활동→관심', avg: avgConsiderationChurn },
                { stage: '관심→결제진행', avg: avgConversionChurn },
                { stage: '결제진행→구매완료', avg: avgPurchaseChurn }
            ];
            const highestChurnStage = churnStages.reduce((max, item) => item.avg > max.avg ? item : max, churnStages[0]);

            // 인사이트 HTML 생성
            let insightHTML = '';

            // 1. 최고 성과 채널
            insightHTML += `<strong style="color: #4caf50;">🏆 최고 성과 채널:</strong> `;
            insightHTML += `<strong>${topCVRChannels[0].channel}</strong> (CVR ${topCVRChannels[0].cvr.toFixed(2)}%)이 가장 효율적입니다. `;
            if (topCVRChannels[0].cvr > 3) {
                insightHTML += `매우 우수한 전환율입니다! 이 채널의 광고 예산을 늘리세요. `;
            } else if (topCVRChannels[0].cvr > 1.5) {
                insightHTML += `양호한 전환율입니다. 추가 투자를 고려하세요. `;
            }

            // 2. 매출 vs CVR 불균형
            if (highRevenueLowCVR.length > 0) {
                insightHTML += `<br><br><strong style="color: #ff9800;">⚠️ 개선 기회:</strong> `;
                insightHTML += `<strong>${highRevenueLowCVR[0].channel}</strong>은 매출은 높지만 (₩${formatNumber(highRevenueLowCVR[0].revenue)}) `;
                insightHTML += `CVR이 ${highRevenueLowCVR[0].cvr.toFixed(2)}%로 평균(${avgCVR.toFixed(2)}%)보다 낮습니다. `;
                insightHTML += `<strong>랜딩 페이지를 개선하면 매출을 크게 늘릴 수 있습니다!</strong> `;
            }

            // 3. 초기 이탈 문제
            if (highEarlyChurn.length > 0) {
                insightHTML += `<br><br><strong style="color: #f44336;">🚨 긴급 조치 필요:</strong> `;
                const worstChannel = highEarlyChurn.sort((a, b) => b.activationChurn - a.activationChurn)[0];
                insightHTML += `<strong>${worstChannel.channel}</strong>은 첫 단계(유입→활동)에서 ${worstChannel.activationChurn.toFixed(1)}%가 이탈합니다. `;
                insightHTML += `광고 메시지와 랜딩 페이지의 일치 여부, 로딩 속도를 즉시 점검하세요. `;
            } else {
                // 가장 이탈률 높은 단계 안내
                insightHTML += `<br><br><strong style="color: #2196f3;">📊 전체 분석:</strong> `;
                insightHTML += `전체 채널에서 <strong>${highestChurnStage.stage}</strong> 단계의 평균 이탈률이 ${highestChurnStage.avg.toFixed(1)}%로 가장 높습니다. `;
                insightHTML += `이 구간에 집중적으로 개선 노력을 기울이세요. `;
            }

            // 4. 실행 가능한 추천
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 오늘 바로 실행:</strong> `;
            if (topCVRChannels[0].cvr > avgCVR * 1.5) {
                insightHTML += `1) <strong>${topCVRChannels[0].channel}</strong> 광고비를 20-30% 증액하고, `;
            }
            if (highRevenueLowCVR.length > 0) {
                insightHTML += `2) <strong>${highRevenueLowCVR[0].channel}</strong>의 랜딩 페이지 A/B 테스트를 시작하고, `;
            }
            insightHTML += `3) CVR ${(avgCVR * 0.5).toFixed(2)}% 이하 채널은 일시 중단을 검토하세요.`;

            // 인사이트 표시
            const insightElement = document.getElementById('channelTableInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        function updateChannelTable() {
            if (channelData.length === 0) return;

            const tbody = document.getElementById('channelTableBody');
            if (!tbody) return;

            // 현재 정렬 기준으로 데이터 정렬
            const sortedData = [...channelData].sort((a, b) => {
                const aVal = parseFloat(a[channelTableSort.column]) || 0;
                const bVal = parseFloat(b[channelTableSort.column]) || 0;

                if (channelTableSort.direction === 'desc') {
                    return bVal - aVal;
                } else {
                    return aVal - bVal;
                }
            });

            // 각 열의 최대값 계산 (색상 스케일용)
            const maxValues = {
                '유입': Math.max(...channelData.map(r => parseFloat(r['유입']) || 0)),
                '활동': Math.max(...channelData.map(r => parseFloat(r['활동']) || 0)),
                '관심': Math.max(...channelData.map(r => parseFloat(r['관심']) || 0)),
                '결제진행': Math.max(...channelData.map(r => parseFloat(r['결제진행']) || 0)),
                '구매완료': Math.max(...channelData.map(r => parseFloat(r['구매완료']) || 0)),
                'Revenue': Math.max(...channelData.map(r => parseFloat(r['Revenue']) || 0)),
                'CVR': Math.max(...channelData.map(r => parseFloat(r['CVR']) || 0))
            };

            // 색상 스케일 계산 함수
            function getScaleWidth(value, maxValue) {
                if (maxValue === 0) return 0;
                return (value / maxValue) * 100;
            }

            tbody.innerHTML = sortedData.map(row => {
                const acqVal = parseFloat(row['유입']) || 0;
                const actVal = parseFloat(row['활동']) || 0;
                const conVal = parseFloat(row['관심']) || 0;
                const convVal = parseFloat(row['결제진행']) || 0;
                const purVal = parseFloat(row['구매완료']) || 0;
                const revVal = parseFloat(row['Revenue']) || 0;
                const cvrVal = parseFloat(row['CVR']) || 0;

                return `
                <tr>
                    <td>${row['channel']}</td>
                    <td class="has-bg">
                        <div class="cell-bg scale-acquisition" style="width: ${getScaleWidth(acqVal, maxValues['유입'])}%"></div>
                        <span>${formatNumber(acqVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-activation" style="width: ${getScaleWidth(actVal, maxValues['활동'])}%"></div>
                        <span>${formatNumber(actVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-consideration" style="width: ${getScaleWidth(conVal, maxValues['관심'])}%"></div>
                        <span>${formatNumber(conVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-conversion" style="width: ${getScaleWidth(convVal, maxValues['결제진행'])}%"></div>
                        <span>${formatNumber(convVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-purchase" style="width: ${getScaleWidth(purVal, maxValues['구매완료'])}%"></div>
                        <span>${formatNumber(purVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-revenue" style="width: ${getScaleWidth(revVal, maxValues['Revenue'])}%"></div>
                        <span>${formatNumber(revVal)}</span>
                    </td>
                    <td class="has-bg">
                        <div class="cell-bg scale-cvr" style="width: ${getScaleWidth(cvrVal, maxValues['CVR'])}%"></div>
                        <span>${formatDecimal(cvrVal)}%</span>
                    </td>
                </tr>
                `;
            }).join('');

            // 데이터 분석 및 인사이트 생성
            analyzeChannelTableData(channelData);

            // 정렬 아이콘 업데이트
            updateSortIcons();
        }

        // 정렬 아이콘 상태 업데이트
        function updateSortIcons() {
            const headers = document.querySelectorAll('#channelTable .sortable-header');
            headers.forEach(th => {
                const column = th.getAttribute('data-column');
                const sortIcon = th.querySelector('.sort-icon');
                const upArrow = th.querySelector('.sort-arrow.up');
                const downArrow = th.querySelector('.sort-arrow.down');

                if (!sortIcon || !upArrow || !downArrow) return;

                if (column === channelTableSort.column) {
                    sortIcon.classList.add('active');
                    if (channelTableSort.direction === 'asc') {
                        upArrow.classList.add('active');
                        downArrow.classList.remove('active');
                    } else {
                        upArrow.classList.remove('active');
                        downArrow.classList.add('active');
                    }
                } else {
                    sortIcon.classList.remove('active');
                    upArrow.classList.remove('active');
                    downArrow.classList.remove('active');
                }
            });
        }

        // 테이블 정렬 이벤트 초기화
        function setupTableSorting() {
            const headers = document.querySelectorAll('#channelTable .sortable-header');

            headers.forEach(th => {
                // 기존 이벤트 리스너 제거 (중복 방지)
                const newTh = th.cloneNode(true);
                th.parentNode.replaceChild(newTh, th);
            });

            // 새로운 이벤트 리스너 추가
            document.querySelectorAll('#channelTable .sortable-header').forEach(th => {
                // 클릭 이벤트 (정렬)
                th.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const column = this.getAttribute('data-column');

                    // 같은 열을 클릭하면 방향 토글, 다른 열이면 desc로 시작
                    if (channelTableSort.column === column) {
                        channelTableSort.direction = channelTableSort.direction === 'desc' ? 'asc' : 'desc';
                    } else {
                        channelTableSort.column = column;
                        channelTableSort.direction = 'desc';
                    }

                    updateChannelTable();
                });

                // 마우스 호버 이벤트 (툴팁 위치 계산)
                const tooltip = th.querySelector('.sort-tooltip');
                if (tooltip) {
                    th.addEventListener('mouseenter', function() {
                        const rect = this.getBoundingClientRect();
                        tooltip.style.left = rect.left + (rect.width / 2) + 'px';
                        tooltip.style.top = (rect.top - 8) + 'px';
                    });
                }
            });
        }

        // 차트 인사이트 툴팁 표시 함수
        function showChartInsightTooltip(tooltipId, insight, recommendation, event) {
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;

            tooltip.innerHTML = `
                <div class="tooltip-insight-section">
                    <div class="tooltip-insight-header">
                        💡 인사이트
                    </div>
                    <p class="tooltip-insight-text">${insight}</p>
                </div>
                <div class="tooltip-recommendation-section">
                    <div class="tooltip-recommendation-header">
                        🎯 추천 사항
                    </div>
                    <p class="tooltip-recommendation-text">${recommendation}</p>
                </div>
            `;

            // position: fixed 사용 - 화면 기준 절대 좌표
            tooltip.style.left = (event.clientX + 15) + 'px';
            tooltip.style.top = (event.clientY + 15) + 'px';
            tooltip.classList.add('show');
        }

        function hideChartInsightTooltip(tooltipId) {
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;
            tooltip.classList.remove('show');
        }

        // KPI 차트 인사이트 생성
        function generateKpiInsight(kpiType, data) {
            const insights = {
                cvr: {
                    insight: '전환율(CVR)이 높은 채널은 방문자를 실제 고객으로 만드는 능력이 뛰어난 채널입니다. 예를 들어 100명이 방문해서 5명이 구매하면 5%입니다.',
                    recommendation: '전환율이 높은 채널에 광고비를 더 투자하세요. 반대로 전환율이 낮은 채널은 웹사이트 첫 화면을 고객 입장에서 개선해보세요. (예: 구매 버튼을 더 눈에 띄게 만들기)'
                },
                acquisition: {
                    insight: '방문자가 많은 채널은 많은 사람들이 우리 웹사이트를 찾아오는 경로입니다. 하지만 많다고 무조건 좋은 것은 아닙니다.',
                    recommendation: '방문자가 많은 채널의 전환율도 함께 확인하세요. 방문자는 많은데 구매는 적다면, 엉뚱한 사람들이 들어오고 있다는 뜻일 수 있습니다. 그럴 땐 광고 타겟을 더 정확하게 설정하세요.'
                },
                activation: {
                    insight: '활성 사용자가 많은 채널은 단순 방문이 아니라 실제로 우리 사이트를 이용하는 사람들을 많이 보내고 있습니다.',
                    recommendation: '활성 사용자가 많은 채널이 어떤 특징이 있는지 살펴보세요. 예를 들어 특정 연령대나 관심사를 가진 사람들이라면, 다른 채널에서도 그런 사람들을 타겟팅하세요.'
                },
                consideration: {
                    insight: '관심 고객이 많은 채널은 구매 의향이 높은 좋은 품질의 방문자를 보내고 있습니다.',
                    recommendation: '관심은 보였지만 구매하지 않은 사람들에게 재방문 광고를 하면 효과적입니다. 또한 제품 사진과 설명을 더 자세하게 개선하세요.'
                },
                conversion: {
                    insight: '결제를 시도한 사람이 많다는 것은 거의 구매 직전까지 갔다는 의미입니다. 이들을 놓치는 것은 큰 손실입니다.',
                    recommendation: '결제 과정을 최대한 간단하게 만드세요. (예: 회원가입 없이 구매 가능, 배송비 조기 안내) 장바구니에 물건을 담고 떠난 사람에게 "아직 장바구니에 물건이 남아있어요" 같은 알림을 보내세요.'
                },
                purchase: {
                    insight: '실제 구매 건수가 많은 채널이 진짜 돈을 벌어다 주는 채널입니다. 이 채널들이 가장 중요합니다.',
                    recommendation: '구매가 많은 채널에 광고비를 우선적으로 투자하세요. 또한 이 채널을 통해 구매한 고객들이 재구매를 얼마나 하는지도 추적하면 더 좋습니다.'
                },
                revenue: {
                    insight: '매출이 높은 채널은 투자 대비 수익이 가장 좋은 채널입니다. 여기서 번 돈으로 다른 채널 실험도 할 수 있습니다.',
                    recommendation: '이 채널이 왜 성공했는지 분석하세요. (어떤 상품? 어떤 광고 문구? 어떤 고객층?) 그리고 비슷한 방식으로 새로운 채널을 시도해보세요.'
                }
            };

            return insights[kpiType] || { insight: '데이터 분석 중입니다.', recommendation: '지속적으로 성과를 모니터링하세요.' };
        }

        // 이탈률 차트 인사이트 생성
        function generateChurnInsight() {
            return {
                insight: '채널 이탈률을 개선하면 전환율이 높아지고 매출이 증가합니다.',
                recommendation: '이탈률이 높은 채널일수록 개선 여지가 크다는 뜻입니다. 그 단계를 집중적으로 개선하면 효과가 큽니다.'
            };
        }

        // 비교 차트 인사이트 생성
        function generateCompareInsight() {
            return {
                insight: '각 채널의 전환율(CVR), 고객 유입, 구매 건수, 매출을 100점 만점으로 환산하여 비교합니다. 모든 지표가 골고루 높은 채널이 가장 균형있는 성과를 내고 있습니다.',
                recommendation: '한 가지 지표만 좋은 채널은 개선 여지가 있습니다. 예를 들어, 유입은 많은데 전환율이 낮다면 고객 타게팅을 개선해야 합니다. 전환율은 높은데 매출이 낮다면 고가 상품 판매를 늘려야 합니다.'
            };
        }

        // 차트에 호버 이벤트 추가
        function addChartHoverTooltip(canvasId, tooltipId, insightGenerator) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            canvas.addEventListener('mousemove', function(event) {
                const insight = insightGenerator();
                showChartInsightTooltip(tooltipId, insight.insight, insight.recommendation, event);
            });

            canvas.addEventListener('mouseleave', function() {
                hideChartInsightTooltip(tooltipId);
            });
        }

        // 퍼널 뷰 타입 전환 - 제거됨 (항상 daily 데이터 사용)

        // 신규 vs 재방문 차트 뷰 타입 전환 (독립적)
        document.querySelectorAll('.new-vs-returning-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.dataset.view;
                console.log(`[신규 vs 재방문] 뷰 전환: ${newVsReturningView} → ${view}`);

                // 같은 그룹 내 버튼만 active 제거
                document.querySelectorAll('.new-vs-returning-view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                newVsReturningView = view;

                // 신규 vs 재방문 관련 차트들 업데이트 (다른 섹션에 영향 없음)
                updateCustomerTrendChart();
            });
        });

        // 이탈 위험 기간 전환 (7일/30일) - 독립적
        document.querySelectorAll('.churn-period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const period = this.dataset.period;
                console.log(`[이탈 위험] 기간 전환: ${period}`);

                document.querySelectorAll('.churn-period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateChurnPredictions(period);
            });
        });

        // 성과 개선 기간 전환 (7일/30일) - 독립적
        document.querySelectorAll('.improvement-period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const period = this.dataset.period;
                console.log(`[성과 개선] 기간 전환: ${period}`);

                document.querySelectorAll('.improvement-period-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateImprovementPredictions(period);
            });
        });

        // KPI 차트 버튼 전환 - 독립적
        document.querySelectorAll('.channel-kpi-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const kpiType = this.dataset.kpi;
                console.log(`[KPI 차트] 타입 전환: ${kpiType}`);

                document.querySelectorAll('.channel-kpi-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateKpiChart(kpiType);
            });
        });

        // 이탈률 차트 퍼널 단계 버튼 전환
        document.querySelectorAll('.channel-churn-stage-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const stage = this.dataset.stage;
                console.log(`[이탈률 차트] 퍼널 단계 전환: ${stage}`);

                document.querySelectorAll('.channel-churn-stage-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateChurnChart(stage, null);
            });
        });

        // 이탈률 차트 정렬 순서 버튼 전환
        document.querySelectorAll('.channel-churn-sort-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const sort = this.dataset.sort;
                console.log(`[이탈률 차트] 정렬 순서 전환: ${sort}`);

                document.querySelectorAll('.channel-churn-sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateChurnChart(null, sort);
            });
        });

        // 채널 퍼널 차트 버튼 전환 - 독립적
        document.querySelectorAll('.channel-funnel-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const funnelType = this.dataset.funnel;
                console.log(`[채널 퍼널] 타입 전환: ${funnelType}`);

                document.querySelectorAll('.channel-funnel-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateCampaignChart(funnelType);
            });
        });

        // 퍼널 비교 기능
        let isCompareMode = false;
        let leftFunnelData = null;
        let rightFunnelData = null;

        // 날짜 범위 가져오기
        function getDateRange(data) {
            console.log('=== getDateRange 시작 ===');

            if (data.length === 0) {
                console.warn('데이터가 비어있습니다.');
                return { start: '', end: '' };
            }

            console.log(`전체 데이터 행 수: ${data.length}`);

            // 날짜 필드 추출
            const dateStrings = data
                .map(row => row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'])
                .filter(d => d);

            console.log(`추출된 날짜 문자열: ${dateStrings.length}개`);

            if (dateStrings.length === 0) {
                console.warn('날짜 필드를 찾을 수 없습니다.');
                return { start: '', end: '' };
            }

            // Date 객체로 변환 후 정렬
            const sortedDates = dateStrings
                .map(dateStr => new Date(dateStr))
                .filter(date => !isNaN(date.getTime()))
                .sort((a, b) => a - b)
                .map(date => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                });

            console.log(`정렬된 날짜: ${sortedDates.length}개`);
            console.log(`시작 날짜: ${sortedDates[0]}`);
            console.log(`종료 날짜: ${sortedDates[sortedDates.length - 1]}`);
            console.log('=== getDateRange 완료 ===\n');

            return {
                start: sortedDates[0],
                end: sortedDates[sortedDates.length - 1]
            };
        }

        // 날짜 범위로 데이터 필터링 (Date 객체 기반 비교)
        function filterDataByDateRange(data, startDate, endDate) {
            if (!startDate || !endDate) {
                console.warn('filterDataByDateRange: 시작일 또는 종료일이 없습니다', { startDate, endDate });
                return [];
            }

            // 날짜 문자열을 Date 객체로 변환
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.error('filterDataByDateRange: 유효하지 않은 날짜 형식', { startDate, endDate });
                return [];
            }

            const filtered = data.filter(row => {
                const dateStr = row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'];
                if (!dateStr) return false;

                // 날짜 문자열을 Date 객체로 변환
                const rowDate = new Date(dateStr);

                if (isNaN(rowDate.getTime())) {
                    console.warn('filterDataByDateRange: 유효하지 않은 행 날짜', dateStr);
                    return false;
                }

                // Date 객체 기반 비교
                return rowDate >= start && rowDate <= end;
            });

            console.log(`filterDataByDateRange: ${startDate} ~ ${endDate} 필터링 결과: ${filtered.length}개 (전체: ${data.length}개)`);

            return filtered;
        }

        // 퍼널 데이터 계산
        function calculateFunnelData(data) {
            if (data.length === 0) return [];

            const baseColor = '#535A8C';
            const funnelStages = [
                { name: '유입', key: '유입', color: baseColor },
                { name: '활동', key: '활동', color: baseColor },
                { name: '관심', key: '관심', color: baseColor },
                { name: '결제진행', key: '결제진행', color: baseColor },
                { name: '구매완료', key: '구매완료', color: baseColor }
            ];

            return funnelStages.map((stage, index) => {
                const total = data.reduce((sum, row) => sum + (parseFloat(row[stage.key]) || 0), 0);
                const prevTotal = index > 0 ? data.reduce((sum, row) => sum + (parseFloat(row[funnelStages[index - 1].key]) || 0), 0) : total;
                const conversionRate = prevTotal > 0 ? (total / prevTotal * 100) : 100;
                const dropOffRate = prevTotal > 0 ? ((prevTotal - total) / prevTotal * 100) : 0;

                return {
                    ...stage,
                    total: Math.round(total),
                    conversionRate: conversionRate.toFixed(1),
                    dropOffRate: dropOffRate.toFixed(1),
                    index: index
                };
            });
        }

        // 작은 퍼널 렌더링 (비교용)
        function renderSmallFunnel(containerId, funnelData) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // 기존 SVG 완전 제거 (잔상 방지)
            container.innerHTML = '';

            // 데이터 유효성 검증
            if (!funnelData || funnelData.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">선택한 기간의 데이터가 없습니다</div>';
                return;
            }

            // 데이터가 너무 적은지 확인
            const totalUsers = funnelData[0]?.total || 0;
            if (totalUsers === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">선택한 기간에 유입 데이터가 없습니다</div>';
                return;
            }

            const margin = { top: 10, right: 20, bottom: 10, left: 20 };
            const width = 400;
            const height = 450 - margin.top - margin.bottom;

            const svg = d3.select(`#${containerId}`)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const maxValue = d3.max(funnelData, d => d.total);
            if (!maxValue || maxValue === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">데이터 값이 유효하지 않습니다</div>';
                return;
            }

            const stageHeight = height / funnelData.length;
            const spacing = 8;

            funnelData.forEach((stage, i) => {
                const stageColor = d3.color(stage.color).darker(i * 0.25);
                const yPos = i * stageHeight;
                const topWidth = (stage.total / maxValue) * width;
                const bottomWidth = i < funnelData.length - 1
                    ? (funnelData[i + 1].total / maxValue) * width
                    : topWidth * 0.8;

                const xOffset = (width - topWidth) / 2;
                const xOffsetBottom = (width - bottomWidth) / 2;

                const group = svg.append('g')
                    .attr('class', 'funnel-stage-small');

                // 그라데이션
                const gradientId = `gradient-small-${containerId}-${i}`;
                const gradient = svg.append('defs')
                    .append('linearGradient')
                    .attr('id', gradientId)
                    .attr('x1', '0%')
                    .attr('y1', '0%')
                    .attr('x2', '0%')
                    .attr('y2', '100%');

                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 1);

                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', stageColor)
                    .attr('stop-opacity', 0.75);

                // 트라페즈이드
                const path = `
                    M ${xOffset} ${yPos}
                    L ${xOffset + topWidth} ${yPos}
                    L ${xOffsetBottom + bottomWidth} ${yPos + stageHeight - spacing}
                    L ${xOffsetBottom} ${yPos + stageHeight - spacing}
                    Z
                `;

                group.append('path')
                    .attr('d', path)
                    .attr('fill', `url(#${gradientId})`)
                    .attr('stroke', stageColor)
                    .attr('stroke-width', 1.5)
                    .attr('opacity', 0.85);

                // 텍스트
                group.append('text')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 - 5)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'white')
                    .style('font-size', '11px')
                    .style('font-weight', '600')
                    .text(stage.name);

                group.append('text')
                    .attr('x', width / 2)
                    .attr('y', yPos + stageHeight / 2 + 10)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'white')
                    .style('font-size', '10px')
                    .style('font-weight', '600')
                    .text(stage.total.toLocaleString() + ' users');

                // 전환율/이탈률
                if (i > 0) {
                    const metricsGroup = group.append('text')
                        .attr('x', width / 2)
                        .attr('y', yPos + stageHeight / 2 + 24)
                        .attr('text-anchor', 'middle')
                        .style('font-size', '9px');

                    metricsGroup.append('tspan')
                        .style('fill', '#4ade80')
                        .style('font-weight', '600')
                        .text(`전환 ${stage.conversionRate}%`);

                    metricsGroup.append('tspan')
                        .style('fill', 'white')
                        .text(' | ');

                    metricsGroup.append('tspan')
                        .style('fill', '#f87171')
                        .style('font-weight', '600')
                        .text(`이탈 ${stage.dropOffRate}%`);
                }
            });
        }

        // 비교 인사이트 계산 및 표시 (5단계 모두 비교)
        function updateComparisonInsights() {
            console.log('=== updateComparisonInsights 시작 ===');

            if (!leftFunnelData || !rightFunnelData) {
                console.warn('퍼널 데이터가 없습니다.');
                return;
            }

            if (leftFunnelData.length === 0 || rightFunnelData.length === 0) {
                console.warn('퍼널 데이터가 비어있습니다.');
                return;
            }

            // 단계별 아이콘 매핑
            const stageIcons = {
                '유입': '👥',
                '활동': '🔥',
                '관심': '❤️',
                '결제진행': '🛒',
                '구매완료': '✅'
            };

            const insights = [];

            // 5단계 모두 비교
            console.log('5단계 비교 시작...');
            for (let i = 0; i < leftFunnelData.length; i++) {
                const leftValue = leftFunnelData[i].total;
                const rightValue = rightFunnelData[i].total;
                const changePercent = ((rightValue - leftValue) / leftValue * 100).toFixed(1);
                const changeNum = parseFloat(changePercent);
                const changeColor = changeNum > 0 ? '#10b981' : (changeNum < 0 ? '#ef4444' : '#6b7280');
                const changeIcon = changeNum > 0 ? '▲' : (changeNum < 0 ? '▼' : '━');

                // 단계명에서 영문 제거 (예: '유입 (Acquisition)' -> '유입')
                const stageName = leftFunnelData[i].name.split(' (')[0];
                const stageIcon = stageIcons[stageName] || '📊';

                console.log(`  [${i}] ${stageName}: ${leftValue} → ${rightValue} (${changePercent}%)`);

                insights.push(`
                    <div style="padding: 10px; background: white; border-radius: 6px; border-left: 3px solid ${changeColor};">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--grey-800);">
                                ${stageIcon} ${stageName}
                            </div>
                            <div style="font-size: 12px; font-weight: 700; color: ${changeColor};">
                                ${changeIcon} ${changeNum > 0 ? '+' : ''}${changePercent}%
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--grey-500); line-height: 1.4;">
                            ${leftValue.toLocaleString()} → ${rightValue.toLocaleString()}
                        </div>
                    </div>
                `);
            }

            console.log(`인사이트 ${insights.length}개 생성 완료`);

            // 그리드 레이아웃으로 표시 (2열, 모바일에선 1열)
            document.getElementById('comparisonContent').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                    ${insights.join('')}
                </div>
            `;

            console.log('=== updateComparisonInsights 완료 ===\n');
        }

        // ========================================
        // 퍼널 채널 필터 기능 (channel_daily_funnel.csv 기반)
        // ========================================
        let funnelFilterActive = false;
        let selectedFunnelChannel = '';

        // 채널 목록 동적 생성 (dailyData = channel_daily_funnel.csv)
        function populateFunnelChannelFilter() {
            const select = document.getElementById('funnelChannelFilter');
            if (!select) return;

            // channel_daily_funnel.csv (dailyData)에서 채널 목록 추출
            const channels = new Set();
            if (dailyData && dailyData.length > 0) {
                dailyData.forEach(row => {
                    const channel = row['channel'] || row['Channel'];
                    if (channel) channels.add(channel);
                });
            }

            // 드롭다운 옵션 생성
            select.innerHTML = '<option value="">전체 채널</option>';
            Array.from(channels).sort().forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                select.appendChild(option);
            });
        }

        // 필터링된 일별 데이터 반환 (channel_daily_funnel.csv 기반)
        function getFilteredDailyData(channel) {
            if (!channel || !dailyData || dailyData.length === 0) {
                return dailyData; // 전체 데이터 반환
            }

            // 해당 채널의 일별 데이터만 필터링
            return dailyData.filter(row =>
                (row['channel'] || row['Channel']) === channel
            );
        }

        // 필터 버튼 클릭 이벤트
        document.getElementById('funnelFilterBtn').addEventListener('click', function() {
            const btn = this;
            const select = document.getElementById('funnelChannelFilter');

            if (funnelFilterActive) {
                // 필터 해제
                funnelFilterActive = false;
                selectedFunnelChannel = '';
                btn.textContent = '필터';
                btn.style.background = '';
                btn.style.color = '';
                select.style.display = 'none';
                select.value = '';

                // 현재 모드에 따라 차트 업데이트
                if (isCompareMode) {
                    updateCompareFunnels();
                } else {
                    updateFunnelChart();
                }
            } else {
                // 필터 활성화
                funnelFilterActive = true;
                btn.textContent = '해제';
                btn.style.background = '#673ab7';
                btn.style.color = 'white';
                populateFunnelChannelFilter();
                select.style.display = 'block';
            }
        });

        // 드롭다운 변경 이벤트
        document.getElementById('funnelChannelFilter').addEventListener('change', function() {
            selectedFunnelChannel = this.value;

            // 현재 모드에 따라 차트 업데이트
            if (isCompareMode) {
                updateCompareFunnels();
            } else {
                updateFunnelChart();
            }
        });

        // ========================================

        // 비교 모드 전환 (토글 방식)
        document.getElementById('funnelCompareBtn').addEventListener('click', function() {
            const btn = this;

            // 이미 비교 모드인 경우: 단일 뷰로 돌아가기
            if (isCompareMode) {
                console.log('=== 단일 뷰로 돌아가기 ===');
                isCompareMode = false;
                document.getElementById('singleFunnelView').style.display = 'block';
                document.getElementById('compareFunnelView').style.display = 'none';
                btn.textContent = '비교';
                updateFunnelChart();
                return;
            }

            // 비교 모드 진입
            console.log('=== 비교 모드 시작 ===');

            // 항상 daily 데이터 사용
            const data = dailyData;
            console.log(`일별 데이터: ${data.length}개`);

            if (data.length === 0) {
                alert('데이터를 불러오는 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            isCompareMode = true;
            document.getElementById('singleFunnelView').style.display = 'none';
            document.getElementById('compareFunnelView').style.display = 'block';
            btn.textContent = '돌아가기';

            // 모든 날짜 추출 및 정렬 (Date 객체 기반)
            const allDateStrings = data
                .map(row => row['Day'] || row['week'] || row['date'] || row['Date'] || row['일자'])
                .filter(d => d);

            if (allDateStrings.length === 0) {
                alert('날짜 정보를 찾을 수 없습니다.');
                isCompareMode = false;
                document.getElementById('singleFunnelView').style.display = 'block';
                document.getElementById('compareFunnelView').style.display = 'none';
                return;
            }

            // 날짜 문자열을 Date 객체로 변환하여 정렬
            const sortedDates = allDateStrings
                .map(dateStr => new Date(dateStr))
                .filter(date => !isNaN(date.getTime()))
                .sort((a, b) => a - b)
                .map(date => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                });

            console.log('정렬된 날짜:', sortedDates.length, '개');
            console.log('첫 번째 날짜:', sortedDates[0]);
            console.log('마지막 날짜:', sortedDates[sortedDates.length - 1]);

            const midPoint = Math.floor(sortedDates.length / 2);

            // 기본값: 전반부 vs 후반부
            const leftStart = sortedDates[0];
            const leftEnd = sortedDates[midPoint - 1] || sortedDates[0];
            const rightStart = sortedDates[midPoint] || sortedDates[0];
            const rightEnd = sortedDates[sortedDates.length - 1];

            console.log('설정할 날짜 범위:');
            console.log('왼쪽:', leftStart, '~', leftEnd);
            console.log('오른쪽:', rightStart, '~', rightEnd);

            document.getElementById('leftStartDate').value = leftStart;
            document.getElementById('leftEndDate').value = leftEnd;
            document.getElementById('rightStartDate').value = rightStart;
            document.getElementById('rightEndDate').value = rightEnd;

            console.log('비교 퍼널 업데이트 호출...');
            updateCompareFunnels();
        });

        // 날짜 변경 시 업데이트 (디바운싱 적용)
        let updateTimeout = null;
        ['leftStartDate', 'leftEndDate', 'rightStartDate', 'rightEndDate'].forEach(id => {
            const element = document.getElementById(id);

            // change 이벤트 (날짜 선택 완료 시)
            element.addEventListener('change', function() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateCompareFunnels();
                }, 300); // 300ms 디바운스
            });

            // input 이벤트 (실시간 입력 중)
            element.addEventListener('input', function() {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    updateCompareFunnels();
                }, 500); // 500ms 디바운스
            });
        });

        // 비교 퍼널 업데이트
        function updateCompareFunnels() {
            console.log('=== updateCompareFunnels 시작 ===');

            // 채널 필터 적용된 데이터 사용
            const data = selectedFunnelChannel ? getFilteredDailyData(selectedFunnelChannel) : dailyData;
            console.log(`일별 데이터: ${data.length}개${selectedFunnelChannel ? ` (${selectedFunnelChannel} 필터 적용)` : ''}`);

            // 데이터가 없으면 화면 초기화
            if (data.length === 0) {
                console.warn('데이터가 없습니다.');
                document.getElementById('d3FunnelChartLeft').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">데이터를 불러오는 중...</div>';
                document.getElementById('d3FunnelChartRight').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">데이터를 불러오는 중...</div>';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }

            const leftStart = document.getElementById('leftStartDate').value;
            const leftEnd = document.getElementById('leftEndDate').value;
            const rightStart = document.getElementById('rightStartDate').value;
            const rightEnd = document.getElementById('rightEndDate').value;

            console.log('선택된 날짜:', {
                '왼쪽 시작': leftStart,
                '왼쪽 종료': leftEnd,
                '오른쪽 시작': rightStart,
                '오른쪽 종료': rightEnd
            });

            // 날짜가 설정되지 않았으면 화면 초기화
            if (!leftStart || !leftEnd || !rightStart || !rightEnd) {
                console.warn('날짜 값이 설정되지 않았습니다.');
                document.getElementById('d3FunnelChartLeft').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">날짜를 선택해주세요</div>';
                document.getElementById('d3FunnelChartRight').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--grey-500); font-size: 13px;">날짜를 선택해주세요</div>';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }

            // 날짜 유효성 검사 (양쪽 모두 초기화)
            if (leftStart > leftEnd) {
                console.error('왼쪽 날짜 오류: 시작일이 종료일보다 늦습니다');
                document.getElementById('d3FunnelChartLeft').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--error-main); font-size: 13px;">시작일이 종료일보다 늦습니다</div>';
                document.getElementById('d3FunnelChartRight').innerHTML = '';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }
            if (rightStart > rightEnd) {
                console.error('오른쪽 날짜 오류: 시작일이 종료일보다 늦습니다');
                document.getElementById('d3FunnelChartLeft').innerHTML = '';
                document.getElementById('d3FunnelChartRight').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 450px; color: var(--error-main); font-size: 13px;">시작일이 종료일보다 늦습니다</div>';
                document.getElementById('comparisonContent').innerHTML = '';
                return;
            }

            console.log('날짜 필터링 시작...');
            const leftData = filterDataByDateRange(data, leftStart, leftEnd);
            const rightData = filterDataByDateRange(data, rightStart, rightEnd);

            console.log('퍼널 데이터 계산 시작...');
            leftFunnelData = calculateFunnelData(leftData);
            rightFunnelData = calculateFunnelData(rightData);

            console.log('왼쪽 퍼널 데이터:', leftFunnelData.length > 0 ? leftFunnelData[0] : '없음');
            console.log('오른쪽 퍼널 데이터:', rightFunnelData.length > 0 ? rightFunnelData[0] : '없음');

            // 항상 렌더링 시도 (renderSmallFunnel 내부에서 데이터 검증)
            console.log('렌더링 시작...');
            renderSmallFunnel('d3FunnelChartLeft', leftFunnelData);
            renderSmallFunnel('d3FunnelChartRight', rightFunnelData);

            // 양쪽 데이터가 모두 유효할 때만 비교 인사이트 표시
            if (leftFunnelData.length > 0 && rightFunnelData.length > 0 &&
                leftFunnelData[0]?.total > 0 && rightFunnelData[0]?.total > 0) {
                console.log('비교 인사이트 표시');
                updateComparisonInsights();
            } else {
                console.warn('비교할 데이터가 충분하지 않음');
                document.getElementById('comparisonContent').innerHTML = '<div style="text-align: center; color: var(--grey-500); padding: 20px;">비교할 데이터가 충분하지 않습니다</div>';
            }

            console.log('=== updateCompareFunnels 완료 ===\n');
        }

        // 접기/펼치기 기능
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const icon = this.querySelector('.collapsible-toggle-icon');
                const toggleText = this.querySelector('.collapsible-toggle span:first-child');

                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.classList.add('collapsed');
                    toggleText.textContent = '펼치기';
                } else {
                    content.classList.add('expanded');
                    icon.classList.remove('collapsed');
                    toggleText.textContent = '접기';
                }
            });
        });

        // iframe에서 로드되었는지 확인하고 사이드바 숨기기
        function checkIframeAndHideSidebar() {
            if (window.self !== window.top) {
                // iframe 내부에서 실행 중
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');

                if (sidebar) {
                    sidebar.style.display = 'none';
                }

                if (mainContent) {
                    mainContent.style.marginLeft = '0';
                }
            }
        }

        // 페이지 로드시 실행
        // 버튼 상태 확인 함수 (디버깅용)
        function checkButtonStates() {
            console.log('========================================');
            console.log('=== 버튼 상태 확인 ===');
            console.log('========================================');

            const buttonGroups = [
                { name: '신규 vs 재방문 버튼', selector: '.new-vs-returning-view-btn' },
                { name: '이탈 위험 버튼', selector: '.churn-period-btn' },
                { name: '성과 개선 버튼', selector: '.improvement-period-btn' },
                { name: 'KPI 차트 버튼', selector: '.channel-kpi-btn' },
                { name: '이탈률 퍼널 단계 버튼', selector: '.channel-churn-stage-btn' },
                { name: '이탈률 정렬 버튼', selector: '.channel-churn-sort-btn' },
                { name: '채널 퍼널 버튼', selector: '.channel-funnel-btn' }
            ];

            buttonGroups.forEach(group => {
                const buttons = document.querySelectorAll(group.selector);
                const activeButtons = Array.from(buttons).filter(b => b.classList.contains('active'));

                console.log(`\n[${group.name}]`);
                console.log(`  총 버튼 수: ${buttons.length}`);
                console.log(`  활성화된 버튼: ${activeButtons.length}`);

                if (activeButtons.length > 0) {
                    activeButtons.forEach(btn => {
                        const view = btn.dataset.view || btn.dataset.kpi || btn.dataset.funnel || btn.dataset.period;
                        console.log(`  - "${btn.textContent.trim()}" (${view})`);
                    });
                }
            });

            console.log('\n========================================\n');
        }

        // ========================================
        // 새로운 차트 렌더링 함수들
        // ========================================

        // 통합 신규/재방문 추세 차트
        function updateCustomerTrendChart() {
            if (newVsReturningData.length === 0) return;

            const canvas = document.getElementById('customerTrendChart');
            if (!canvas) return;

            // 유입 단계만 필터링
            const acquisitionData = newVsReturningData.filter(row => row['funnel'] === '유입');

            // 날짜별로 정렬
            const sortedData = acquisitionData.sort((a, b) => {
                const dateA = new Date(a['Day']);
                const dateB = new Date(b['Day']);
                return dateA - dateB;
            });

            // 현재 선택된 뷰에 따라 데이터 집계
            let aggregatedData = [];

            if (newVsReturningView === 'monthly') {
                // 월별 집계
                const monthlyMap = {};
                sortedData.forEach(row => {
                    const date = new Date(row['Day']);
                    const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthlyMap[month]) {
                        monthlyMap[month] = {
                            totalUsers: 0,
                            newUsers: 0,
                            returningUsers: 0
                        };
                    }

                    monthlyMap[month].totalUsers += parseFloat(row['Total users']) || 0;
                    monthlyMap[month].newUsers += parseFloat(row['New users']) || 0;
                    monthlyMap[month].returningUsers += parseFloat(row['Returning users']) || 0;
                });

                aggregatedData = Object.entries(monthlyMap).map(([month, data]) => ({
                    label: month,
                    newUserPct: ((data.newUsers / data.totalUsers) * 100).toFixed(2),
                    returnRate: ((data.returningUsers / data.totalUsers) * 100).toFixed(2)
                }));
            } else if (newVsReturningView === 'weekly') {
                // 주별 집계
                const weeklyMap = new Map();

                sortedData.forEach(row => {
                    const date = new Date(row['Day']);
                    const dayOfWeek = date.getDay();
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - dayOfWeek);
                    const weekKey = weekStart.toISOString().split('T')[0];

                    if (!weeklyMap.has(weekKey)) {
                        weeklyMap.set(weekKey, {
                            totalUsers: 0,
                            newUsers: 0,
                            returningUsers: 0
                        });
                    }

                    const weekData = weeklyMap.get(weekKey);
                    weekData.totalUsers += parseFloat(row['Total users']) || 0;
                    weekData.newUsers += parseFloat(row['New users']) || 0;
                    weekData.returningUsers += parseFloat(row['Returning users']) || 0;
                });

                aggregatedData = Array.from(weeklyMap.entries())
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([week, data]) => ({
                        label: week,
                        newUserPct: data.totalUsers > 0 ? ((data.newUsers / data.totalUsers) * 100).toFixed(2) : 0,
                        returnRate: data.totalUsers > 0 ? ((data.returningUsers / data.totalUsers) * 100).toFixed(2) : 0
                    }));
            } else {
                // 일별 (기본)
                aggregatedData = sortedData.map(row => ({
                    label: row['Day'],
                    newUserPct: parseFloat(row['New user %']).toFixed(2),
                    returnRate: (100 - parseFloat(row['New user %'])).toFixed(2)
                }));
            }

            if (customerTrendChart) {
                customerTrendChart.destroy();
            }

            customerTrendChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: aggregatedData.map(d => d.label),
                    datasets: [
                        {
                            label: '신규 고객 비율 (%)',
                            data: aggregatedData.map(d => d.newUserPct),
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: '재방문율 (%)',
                            data: aggregatedData.map(d => d.returnRate),
                            borderColor: '#673ab7',
                            backgroundColor: 'rgba(103, 58, 183, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: '비율 (%)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // 툴팁 설정
            setupCustomerTrendTooltip();
        }

        // 통합 고객 추세 차트 인사이트 생성
        function generateCustomerTrendInsight() {
            return {
                insight: '신규 고객 비율과 재방문율의 균형을 확인하세요. 신규 비율이 높으면 성장 중이며, 재방문율이 높으면 충성도가 높습니다.',
                recommendation: '이상적으로는 꾸준한 신규 유입(30-40%)과 높은 재방문율(60-70%)을 유지하는 것이 좋습니다. 두 지표가 함께 성장하는 것이 건강한 비즈니스의 신호입니다.'
            };
        }

        // 통합 고객 추세 차트 툴팁 설정
        function setupCustomerTrendTooltip() {
            const canvas = document.getElementById('customerTrendChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateCustomerTrendInsight();
                    showChartInsightTooltip('customerTrendTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('customerTrendTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('customerTrendTooltip');
                });
            }
        }

        // 2. 신규 vs 재방문 고객 전환율 비교 차트
        function updateNewVsReturningConversionChart() {
            if (newVsReturningConversionData.length === 0) return;

            const canvas = document.getElementById('newVsReturningConversionChart');
            if (!canvas) return;

            const labels = newVsReturningConversionData.map(row => row['funnel_stage']);
            const newUserCVR = newVsReturningConversionData.map(row => parseFloat(row['New user CVR']) || 0);
            const returningUserCVR = newVsReturningConversionData.map(row => parseFloat(row['Returning user CVR']) || 0);

            // 인사이트 분석 및 표시
            analyzeConversionGap(labels, newUserCVR, returningUserCVR);

            if (newVsReturningConversionChart) {
                newVsReturningConversionChart.destroy();
            }

            newVsReturningConversionChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '신규 고객 전환율 (%)',
                            data: newUserCVR,
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                            borderColor: '#ff9800',
                            borderWidth: 2,
                            borderRadius: 6,
                            barThickness: 'flex',
                            maxBarThickness: 60
                        },
                        {
                            label: '재방문 고객 전환율 (%)',
                            data: returningUserCVR,
                            backgroundColor: 'rgba(103, 58, 183, 0.7)',
                            borderColor: '#673ab7',
                            borderWidth: 2,
                            borderRadius: 6,
                            barThickness: 'flex',
                            maxBarThickness: 60
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 13,
                                    weight: '600'
                                },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label + ' 단계';
                                },
                                label: function(context) {
                                    const value = context.parsed.y.toFixed(2);
                                    return `${context.dataset.label}: ${value}%`;
                                },
                                afterBody: function(context) {
                                    if (context.length === 2) {
                                        const newValue = context[0].parsed.y;
                                        const returningValue = context[1].parsed.y;
                                        const gap = Math.abs(returningValue - newValue);
                                        const higherGroup = returningValue > newValue ? '재방문 고객' : '신규 고객';
                                        return [
                                            '',
                                            `📊 전환율 차이: ${gap.toFixed(2)}%p`,
                                            `${higherGroup}이 더 높음`
                                        ];
                                    }
                                    return '';
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            formatter: function(value, context) {
                                return value.toFixed(1) + '%';
                            },
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            color: function(context) {
                                return context.datasetIndex === 0 ? '#f57c00' : '#673ab7';
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 12
                                }
                            },
                            title: {
                                display: true,
                                text: '전환율 (%)',
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // 인사이트 툴팁 설정
            setupConversionChartTooltip();
        }

        // 전환율 차이 분석 함수
        function analyzeConversionGap(labels, newUserCVR, returningUserCVR) {
            if (labels.length === 0 || newUserCVR.length === 0 || returningUserCVR.length === 0) {
                return;
            }

            // 각 단계별 차이 계산
            const gaps = labels.map((label, i) => ({
                stage: label,
                newCVR: newUserCVR[i],
                returningCVR: returningUserCVR[i],
                gap: returningUserCVR[i] - newUserCVR[i],
                gapPercent: ((returningUserCVR[i] - newUserCVR[i]) / newUserCVR[i] * 100)
            }));

            // 가장 차이가 큰 단계 찾기
            const maxGap = gaps.reduce((max, item) => item.gap > max.gap ? item : max, gaps[0]);
            const minGap = gaps.reduce((min, item) => item.gap < min.gap ? item : min, gaps[0]);

            // 평균 신규/재방문 전환율
            const avgNew = newUserCVR.reduce((sum, val) => sum + val, 0) / newUserCVR.length;
            const avgReturning = returningUserCVR.reduce((sum, val) => sum + val, 0) / returningUserCVR.length;
            const avgGap = avgReturning - avgNew;

            // 인사이트 텍스트 생성
            let insightHTML = '';

            if (avgReturning > avgNew) {
                const ratio = (avgReturning / avgNew).toFixed(1);
                insightHTML += `재방문 고객의 평균 전환율은 <strong style="color: #673ab7;">${avgReturning.toFixed(1)}%</strong>로, `;
                insightHTML += `신규 고객(<strong style="color: #ff9800;">${avgNew.toFixed(1)}%</strong>)보다 <strong style="color: var(--success-main);">${ratio}배 높습니다</strong>. `;
            } else {
                insightHTML += `신규 고객과 재방문 고객의 전환율이 비슷합니다. `;
            }

            if (maxGap.gap > 5) {
                insightHTML += `<br><strong>특히 "${maxGap.stage}" 단계</strong>에서 재방문 고객이 ${maxGap.gap.toFixed(1)}%p 더 높습니다. `;

                // 단계별 맞춤 추천
                if (maxGap.stage.includes('유입') || maxGap.stage.includes('활동')) {
                    insightHTML += `신규 고객이 이 단계에서 이탈하지 않도록 <strong>첫 화면을 간결하게</strong> 만들고 <strong>로딩 속도를 개선</strong>하세요.`;
                } else if (maxGap.stage.includes('관심')) {
                    insightHTML += `신규 고객에게 <strong>제품 리뷰와 고객 후기</strong>를 강조하여 신뢰를 구축하세요.`;
                } else if (maxGap.stage.includes('결제') || maxGap.stage.includes('구매')) {
                    insightHTML += `신규 고객도 쉽게 구매할 수 있도록 <strong>게스트 체크아웃</strong>과 <strong>간편 결제</strong>를 도입하세요.`;
                }
            } else {
                insightHTML += `모든 단계에서 비슷한 패턴을 보입니다. 신규 고객과 재방문 고객 모두에게 효과적인 전략을 유지하세요.`;
            }

            // 핵심 추천사항
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 핵심 전략:</strong> `;
            if (avgGap > 10) {
                insightHTML += `재방문율을 높이는 것이 가장 효과적입니다. 이메일 마케팅, 리타겟팅 광고, 쿠폰 제공으로 재방문을 유도하세요.`;
            } else if (avgNew < 3) {
                insightHTML += `신규 고객 전환율이 낮습니다. 랜딩페이지 개선과 첫 구매 할인 혜택 제공을 고려하세요.`;
            } else {
                insightHTML += `균형잡힌 성과를 보이고 있습니다. 지속적인 A/B 테스트로 두 그룹 모두의 전환율을 개선하세요.`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('conversionInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 전환율 비교 차트 인사이트 생성
        function generateConversionInsight() {
            return {
                insight: '신규 고객과 재방문 고객의 전환율 차이는 고객 경험의 질을 보여주는 중요한 지표입니다. 재방문 고객이 높다면 브랜드 충성도가 좋다는 뜻이고, 신규 고객이 낮다면 첫인상 개선이 필요합니다.',
                recommendation: '차이가 큰 단계를 집중 개선하세요. 예를 들어, 재방문 고객만 구매율이 높다면 신규 고객을 위한 "첫 구매 10% 할인" 같은 인센티브를 제공하거나, 재방문 고객에게는 VIP 혜택을 제공하여 충성도를 더 높이세요.'
            };
        }

        // 전환율 비교 차트 툴팁 설정
        function setupConversionChartTooltip() {
            const canvas = document.getElementById('newVsReturningConversionChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateConversionInsight();
                    showChartInsightTooltip('customerTrendTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('customerTrendTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('customerTrendTooltip');
                });
            }
        }

        // 3. 채널 품질 매트릭스 차트 (Scatter)
        function updateChannelMatrixChart() {
            if (channelEngagementData.length === 0) return;

            const canvas = document.getElementById('channelMatrixChart');
            if (!canvas) return;

            // 데이터 준비
            const data = channelEngagementData.map(row => ({
                x: parseFloat(row['Bounce rate']) || 0,
                y: parseFloat(row['Return rate']) || 0,
                channel: row['channel']
            }));

            // 평균값 계산 (기준선용)
            const avgBounceRate = data.reduce((sum, d) => sum + d.x, 0) / data.length;
            const avgReturnRate = data.reduce((sum, d) => sum + d.y, 0) / data.length;

            // 사분면별로 데이터 분리
            const starChannels = [];
            const growthChannels = [];
            const stableChannels = [];
            const problemChannels = [];

            data.forEach(d => {
                if (d.x < avgBounceRate && d.y > avgReturnRate) {
                    starChannels.push(d);
                } else if (d.x >= avgBounceRate && d.y > avgReturnRate) {
                    growthChannels.push(d);
                } else if (d.x < avgBounceRate && d.y <= avgReturnRate) {
                    stableChannels.push(d);
                } else {
                    problemChannels.push(d);
                }
            });

            if (channelMatrixChart) {
                channelMatrixChart.destroy();
            }

            channelMatrixChart = new Chart(canvas, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '⭐ 스타 채널',
                            data: starChannels,
                            backgroundColor: '#00c853',
                            borderColor: '#00a344',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        },
                        {
                            label: '📈 성장 채널',
                            data: growthChannels,
                            backgroundColor: '#2196f3',
                            borderColor: '#1976d2',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        },
                        {
                            label: '🔒 안정 채널',
                            data: stableChannels,
                            backgroundColor: '#9e9e9e',
                            borderColor: '#757575',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        },
                        {
                            label: '⚠️ 문제 채널',
                            data: problemChannels,
                            backgroundColor: '#ff5722',
                            borderColor: '#e64a19',
                            borderWidth: 2,
                            pointRadius: 10,
                            pointHoverRadius: 14
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    return item.raw.channel;
                                },
                                label: function(context) {
                                    return [
                                        `이탈률: ${context.raw.x.toFixed(2)}%`,
                                        `재방문율: ${context.raw.y.toFixed(2)}%`,
                                        `분류: ${context.dataset.label}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                // 평균 기준선
                                vline: {
                                    type: 'line',
                                    xMin: avgBounceRate,
                                    xMax: avgBounceRate,
                                    borderColor: 'rgba(0, 0, 0, 0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: '평균 이탈률',
                                        enabled: true,
                                        position: 'start'
                                    }
                                },
                                hline: {
                                    type: 'line',
                                    yMin: avgReturnRate,
                                    yMax: avgReturnRate,
                                    borderColor: 'rgba(0, 0, 0, 0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: '평균 재방문율',
                                        enabled: true,
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '이탈률 (%) →',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '← 재방문율 (%)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 참여도 분석 함수
        function analyzeEngagementRates(allData, top10Data, top10Rates) {
            if (allData.length === 0) return;

            // 전체 평균 참여도
            const avgEngagement = allData.reduce((sum, row) => sum + (parseFloat(row['Engagement rate']) || 0), 0) / allData.length;

            // 최고/최저 참여도 채널
            const highest = allData[0];
            const lowest = allData[allData.length - 1];

            // 참여도 범위 분류
            const highEngagement = allData.filter(row => parseFloat(row['Engagement rate']) >= 60);
            const mediumEngagement = allData.filter(row => {
                const rate = parseFloat(row['Engagement rate']);
                return rate >= 40 && rate < 60;
            });
            const lowEngagement = allData.filter(row => parseFloat(row['Engagement rate']) < 40);

            // TOP 10의 평균 참여도
            const top10Avg = top10Rates.reduce((sum, rate) => sum + rate, 0) / top10Rates.length;

            // 인사이트 텍스트 생성
            let insightHTML = '';

            // 전체 상황 요약
            insightHTML += `전체 채널의 평균 참여도는 <strong style="color: #9c27b0;">${avgEngagement.toFixed(1)}%</strong>입니다. `;

            if (avgEngagement >= 60) {
                insightHTML += `<strong style="color: var(--success-main);">매우 우수한</strong> 수준입니다! `;
            } else if (avgEngagement >= 40) {
                insightHTML += `평균적인 수준이며 개선 여지가 있습니다. `;
            } else {
                insightHTML += `<strong style="color: var(--error-main);">주의가 필요한</strong> 수준입니다. `;
            }

            // 최고/최저 채널 정보
            insightHTML += `<br>가장 높은 참여도는 <strong>${highest['channel']}</strong> (${parseFloat(highest['Engagement rate']).toFixed(1)}%)이고, `;
            insightHTML += `가장 낮은 참여도는 <strong>${lowest['channel']}</strong> (${parseFloat(lowest['Engagement rate']).toFixed(1)}%)입니다. `;

            // 범위별 분포
            insightHTML += `<br><br><strong style="color: var(--primary-main);">📊 채널 분포:</strong> `;
            if (highEngagement.length > 0) {
                insightHTML += `<strong style="color: var(--success-main);">${highEngagement.length}개 채널</strong>이 우수(60% 이상), `;
            }
            if (mediumEngagement.length > 0) {
                insightHTML += `<strong style="color: #ff9800;">${mediumEngagement.length}개 채널</strong>이 보통(40-60%), `;
            }
            if (lowEngagement.length > 0) {
                insightHTML += `<strong style="color: var(--error-main);">${lowEngagement.length}개 채널</strong>이 저조(40% 미만)입니다. `;
            }

            // 핵심 추천사항
            insightHTML += `<br><br><strong style="color: var(--primary-main);">💡 핵심 전략:</strong> `;

            if (highEngagement.length >= allData.length * 0.3) {
                // 30% 이상이 고참여도
                insightHTML += `우수한 채널이 많습니다! 이들 채널의 공통점을 분석하여 다른 채널에도 적용하세요. `;
                insightHTML += `특히 <strong>${highest['channel']}</strong>의 성공 요인을 자세히 연구하세요.`;
            } else if (lowEngagement.length >= allData.length * 0.3) {
                // 30% 이상이 저참여도
                insightHTML += `참여도가 낮은 채널이 많습니다. <strong>즉시 광고 타겟팅과 랜딩 페이지를 재검토</strong>하세요. `;
                insightHTML += `저참여도 채널의 예산을 고참여도 채널로 재배분하는 것을 고려하세요.`;
            } else {
                // 중간 수준 많음
                insightHTML += `대부분 채널이 개선 가능한 상태입니다. `;
                insightHTML += `<strong>A/B 테스트를 통해 랜딩 페이지를 최적화</strong>하고, 타겟 오디언스를 세분화하여 참여도를 높이세요.`;
            }

            // 구체적 예시
            if (top10Avg - avgEngagement > 10) {
                insightHTML += `<br><br><strong>⚠️ 주의:</strong> 상위 10개 채널의 평균 참여도(${top10Avg.toFixed(1)}%)가 전체 평균보다 ${(top10Avg - avgEngagement).toFixed(1)}%p 높습니다. `;
                insightHTML += `나머지 채널들의 품질이 낮으므로, 저성과 채널을 정리하거나 개선하는 것이 시급합니다.`;
            }

            // 인사이트 표시
            const insightElement = document.getElementById('engagementInsightText');
            if (insightElement) {
                insightElement.innerHTML = insightHTML;
            }
        }

        // 4. 채널별 참여도 분석 차트
        function updateChannelEngagementChart() {
            if (channelEngagementData.length === 0) return;

            const canvas = document.getElementById('channelEngagementChart');
            if (!canvas) return;

            // 참여율 기준으로 정렬
            const sortedData = [...channelEngagementData].sort((a, b) => {
                return parseFloat(b['Engagement rate']) - parseFloat(a['Engagement rate']);
            });

            // 상위 10개 채널만 표시
            const top10 = sortedData.slice(0, 10);

            const labels = top10.map(row => row['channel']);
            const engagementRates = top10.map(row => parseFloat(row['Engagement rate']) || 0);

            // 참여도 인사이트 분석 및 표시
            analyzeEngagementRates(sortedData, top10, engagementRates);

            // 색상 그라데이션 (높을수록 진한 색)
            const colors = engagementRates.map(rate => {
                const intensity = Math.min(rate / 100, 1);
                return `rgba(103, 58, 183, ${0.3 + intensity * 0.5})`;
            });

            if (channelEngagementChart) {
                channelEngagementChart.destroy();
            }

            channelEngagementChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '참여율 (%)',
                        data: engagementRates,
                        backgroundColor: colors,
                        borderColor: '#673ab7',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `참여율: ${context.parsed.x.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });

            // 참여도 차트 인사이트 툴팁 설정
            setupEngagementChartTooltip();
        }

        // 참여도 차트 인사이트 생성
        function generateEngagementInsight() {
            return {
                insight: '참여도는 채널의 품질을 평가하는 가장 중요한 지표입니다. 높은 참여도는 타겟팅이 정확하고 랜딩 페이지가 매력적이라는 뜻이며, 전환율 향상으로 이어집니다.',
                recommendation: '참여도 상위 채널에 예산을 집중하세요. 참여도 60% 이상은 우수, 40-60%는 보통, 40% 미만은 개선 필요입니다. 참여도가 낮은 채널은 광고 타겟팅과 랜딩 페이지를 즉시 재검토하거나 예산을 줄이는 것을 고려하세요.'
            };
        }

        // 참여도 차트 툴팁 설정
        function setupEngagementChartTooltip() {
            const canvas = document.getElementById('channelEngagementChart');
            const container = canvas ? canvas.parentElement : null;
            if (!container) return;

            if (!container.dataset.tooltipSetup) {
                container.dataset.tooltipSetup = 'true';

                container.addEventListener('mouseenter', function(event) {
                    const insight = generateEngagementInsight();
                    showChartInsightTooltip('churnChartTooltip', insight.insight, insight.recommendation, event);
                });

                container.addEventListener('mousemove', function(event) {
                    const tooltip = document.getElementById('churnChartTooltip');
                    if (tooltip && tooltip.classList.contains('show')) {
                        tooltip.style.left = (event.clientX + 15) + 'px';
                        tooltip.style.top = (event.clientY + 15) + 'px';
                    }
                });

                container.addEventListener('mouseleave', function() {
                    hideChartInsightTooltip('churnChartTooltip');
                });
            }
        }

        // ========================================
        // 탭 전환 기능
        // ========================================

        function initTabSwitching() {
            // 1. 데이터 기반 의사결정 도구 탭
            document.querySelectorAll('.decision-tool-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.decision-tool-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.decision-tool-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    let selectedTab = null;
                    if (targetTab === 'summary') selectedTab = document.getElementById('summaryTab');
                    else if (targetTab === 'urgent') selectedTab = document.getElementById('urgentTab');
                    else if (targetTab === 'clustering') selectedTab = document.getElementById('clusteringTab');
                    else if (targetTab === 'budget') selectedTab = document.getElementById('budgetTab');
                    else if (targetTab === 'crm_guide') selectedTab = document.getElementById('crmGuideTab');

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });

            // 2. 채널별 분석 탭
            document.querySelectorAll('.channel-analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.channel-analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.channel-analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    let selectedTab = null;
                    if (targetTab === 'table') selectedTab = document.getElementById('tableTab');
                    else if (targetTab === 'kpi') selectedTab = document.getElementById('kpiTab');
                    else if (targetTab === 'balance') selectedTab = document.getElementById('balanceTab');
                    else if (targetTab === 'top10') selectedTab = document.getElementById('top10Tab');

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });

            // 3. 고객 재방문 및 이탈 분석 탭
            document.querySelectorAll('.customer-analysis-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.customer-analysis-tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const targetTab = this.dataset.tab;
                    document.querySelectorAll('.customer-analysis-tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    let selectedTab = null;
                    if (targetTab === 'trend') selectedTab = document.getElementById('trendTab');
                    else if (targetTab === 'conversion') selectedTab = document.getElementById('conversionTab');
                    else if (targetTab === 'churn') selectedTab = document.getElementById('churnTab');
                    else if (targetTab === 'matrix') selectedTab = document.getElementById('matrixTab');
                    else if (targetTab === 'engagement') selectedTab = document.getElementById('engagementTab');

                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                        selectedTab.classList.add('active');
                    }
                });
            });
        }

        // ========================================
        // 이벤트 리스너 및 초기화
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            checkIframeAndHideSidebar();

            // 테이블 정렬 기능 초기화
            setupTableSorting();

            // 탭 전환 기능 초기화
            initTabSwitching();

            // 페이지 로드 후 2초 뒤 버튼 상태 확인
            setTimeout(() => {
                checkButtonStates();
            }, 2000);
        });

        // 초기 데이터 로드
        loadData();

        // iframe 체크 (DOMContentLoaded 이전에도 실행)
        checkIframeAndHideSidebar();
    
    })();
    </script>

    <!-- ========== FAQ&문의하기 스크립트 (Qna.html) ========== -->
    <script>
    (function() {
        // qna 페이지 스크립트
        
        // FAQ 토글
        function toggleFaq(button) {
            const faqItem = button.closest('.faq-item');
            const isOpen = faqItem.classList.contains('open');

            // 모든 FAQ 닫기 (선택사항 - 아코디언 스타일)
            // document.querySelectorAll('.faq-item').forEach(item => item.classList.remove('open'));

            // 현재 항목 토글
            if (isOpen) {
                faqItem.classList.remove('open');
            } else {
                faqItem.classList.add('open');
            }
        }

        // 탭 전환
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // 모든 탭 버튼 비활성화
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                // 모든 탭 콘텐츠 숨기기
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // 클릭한 탭 활성화
                btn.classList.add('active');
                const tabId = btn.dataset.tab;
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // FAQ 검색
        document.getElementById('faqSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const faqItems = document.querySelectorAll('.faq-item');

            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question span').textContent.toLowerCase();
                const answer = item.querySelector('.faq-answer-content').textContent.toLowerCase();

                if (question.includes(searchTerm) || answer.includes(searchTerm)) {
                    item.style.display = 'block';
                    // 검색 중일 때 해당 항목 열기
                    if (searchTerm.length > 0) {
                        item.classList.add('open');
                    }
                } else {
                    item.style.display = 'none';
                }
            });

            // 검색어가 비어있으면 모두 표시하고 닫기
            if (searchTerm.length === 0) {
                faqItems.forEach(item => {
                    item.style.display = 'block';
                    item.classList.remove('open');
                });
            }
        });

        // 문의 폼 제출 - Gmail mailto 사용
        function submitForm(event) {
            event.preventDefault();

            const companyName = document.getElementById('companyName').value;
            const contactName = document.getElementById('contactName').value;
            const contactEmail = document.getElementById('contactEmail').value;
            const inquiryType = document.getElementById('inquiryType').value;
            const inquiryContent = document.getElementById('inquiryContent').value;

            // 메일 본문 구성
            const subject = encodeURIComponent(`[${inquiryType}] ${companyName} 문의`);
            const body = encodeURIComponent(
`안녕하세요, 대시보드 관련 문의드립니다.

━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 문의 정보
━━━━━━━━━━━━━━━━━━━━━━━━━━

회사명: ${companyName}
담당자: ${contactName || '미입력'}
이메일: ${contactEmail || '미입력'}
문의 유형: ${inquiryType}

━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 문의 내용
━━━━━━━━━━━━━━━━━━━━━━━━━━

${inquiryContent}

━━━━━━━━━━━━━━━━━━━━━━━━━━
`
            );

            // Gmail mailto 링크 생성
            const mailtoLink = `mailto:support@growthmaker.kr?subject=${subject}&body=${body}`;

            // 메일 앱 열기
            window.location.href = mailtoLink;

            // 성공 메시지 표시
            document.getElementById('successMessage').classList.add('show');

            // 폼 초기화
            document.getElementById('contactForm').reset();

            // 3초 후 성공 메시지 숨기기
            setTimeout(() => {
                document.getElementById('successMessage').classList.remove('show');
            }, 5000);
        }
    
    })();
    </script>

</body>
</html>
